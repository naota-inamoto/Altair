$END_LIB
TEXT
AlObject
class AltairServer
class LogObj
end_class
class WaitObj
end_class
class WebServer
class HttpServerConnectionMgr
end_class
class HttpServerConnection
end_class
class HttpClientConnection
end_class
class HttpServlet
class WebUIServlet
class WebUIbizsoftServlet
class WebUIbizsoftCustomerServlet
end_class
class WebUIbizsoftSalesServlet
end_class
class WebUIbizsoftAccountServlet
end_class
end_class
class WebUIrosettaServlet
class WebUIrosettaSampleBuyerServlet
end_class
class WebUIrosettaSampleSupplierServlet
end_class
end_class
end_class
class TransportServlet
class RNIF20Servlet
end_class
end_class
class ProxyPolleeServlet
end_class
class TestServlet1
end_class
class TestServlet2
end_class
end_class
class HttpRequest
end_class
class HttpResponse
end_class
class HttpSession
end_class
class TransportTransmitter
class RNIF20Transmitter
end_class
end_class
end_class
class ProxyServer
class ProxyServerConnectionMgr
end_class
class ProxyServerConnection
end_class
class ProxyClientConnection
end_class
end_class
class InetClient
class SmtpClient
end_class
class PopClient
class RNIF20PopClient
end_class
end_class
end_class
class Poller
class RNIF20ProxyPoller
end_class
class RNIF20PopPoller
end_class
end_class
class MultipartSecureMessage
end_class
class XmlUtility
class XmlSchemaLoader
end_class
class DtdLoader
class ExtendedDtdLoader
end_class
end_class
class DtdItr
end_class
class DtdHandler
class XmlComposerHandler
end_class
end_class
class XmlItr
end_class
class XmlValidator
class SimpleXml2Db
end_class
end_class
class XmlComposer
class SimpleDb2Xml
end_class
end_class
class XmlDataRetriver
end_class
class XmlDbAccessor
class XmlDbTableAccessor
end_class
end_class
class XmlDbObject
class XmlDbTableObject
end_class
end_class
class Csv1Data
class Csv1DataItr
end_class
end_class
end_class
class ProcessEngine
class ProcMgr
end_class
class ProcSched
end_class
class Process
class RNIF20SendProcess
end_class
class RNIF20ReceiveProcess
end_class
class PoSendProcess
end_class
class PoReceiveProcess
end_class
class PoCompleteProcess
end_class
class TestProcess1
end_class
class TestProcess2
end_class
end_class
class PeService
class ServiceClass
end_class
class PoSyncAcceptService
end_class
class TestPeService1
end_class
class TestPeService2
end_class
end_class
class ServiceHandler
class RNIF20ServiceHandler
end_class
class SampleBuyerServiceHandler
end_class
class SampleSupplierServiceHandler
end_class
end_class
end_class
class DbUtility
class DbConnection
class DbPoolConnection
end_class
end_class
class DbConnectionPool
end_class
class DbManager
end_class
end_class
class FileUtility
class FileItr
end_class
class RevFileItr
end_class
end_class
class Context
class RNContext
end_class
end_class
class DataMgr
class RNDataMgr
end_class
end_class
class InitWebServiceDB
end_class
class InitBizsoftDB
end_class
class Test_HttpClientConnection
class Sample_URL_Iterator
end_class
end_class
class Test_XmlUtility
end_class
class Test_ProcessEngine
end_class
class Test_MultipartSecureMessage
end_class
class Test_Csv
end_class
class Test_Misc
end_class
class Test_Rosetta
end_class
class Test_FileUtility
end_class
class Test_ProxyServer
end_class
class Test_InetClient
end_class
class Test_SoapEbxml
end_class
end_class
$END_CLASS
TEXT
AlObject
class AltairServer
member
public: static void start();
member
public: static void shutdown();
member
public: static void restart();
member
public: static void start_trace();
member
public: static void stop_trace();
member
public: static void remote_shutdown();
member
public: static void remote_restart();
member
public: static AltairServer appServer;
member
public: list startServer();
member
public: void shutdownServer();
member
public: list load_config();
member
public: list config;
member
public: list web_servers;
member
public: list proxy_servers;
member
public: string pool_name;
member
public: ProcessEngine pe;
member
public: void log(string filepath, string str);
member
public: void system_log(string level, string str);
member
public: string system_log_filepath;
member
public: string system_log_db;
member
public: LogObj logObj;
member
public: static integer getTime(string time);
member
public: void timeoutCheck();
member
public: integer timer_id;
member
public: integer gc_interval;
member
public: integer _gc_time;
member
public: void printStackTrace();
member
public: void connection_debug();
member
public: void xml_debug();
member
public: list debug;
member
public: list debug2;
member
public: list debug3;
member
public: string debug_log_file;
member
public: static void dump_graph(string msg, integer i, list n);
member
public: static void dump_graph(integer indent, integer i, list n);
class LogObj
member
public: void init();
member
public: void finalize();
member
public: void log(string filepath, string str);
member
public: list log_files;
member
public: static integer max_size;
end_class
class WaitObj
member
public: void wait();
member
public: void notify();
member
public: list notified;
member
public: list wait_obj;
member
public: list value;
member
public: list value2;
end_class
class WebServer
member
public: AltairServer ap_server;
member
public: string name;
member
public: integer port;
member
public: string documentRoot;
member
public: list content_types;
member
public: list servlet_list;
member
public: list upload_servlet_list;
member
public: list servlet_param_list;
member
public: list start();
member
public: void stop();
member
public: HttpServerConnectionMgr conn_mgr;
member
public: integer connectionTimeout;
member
public: string GetAbsPath(string path);
member
public: list sessions;
member
public: integer sessionTimeout;
member
public: integer maxMsgSize;
member
public: void access_log(string fromIP, string path, string code, string size);
member
public: string access_log_filepath;
member
public: string access_log_db;
member
public: void error_log(string str);
member
public: void timeoutCheck();
member
public: list ssl;
member
public: string ca_cert;
member
public: string cert;
member
public: string key;
member
public: integer clientAuth;
member
public: string dhparam;
member
public: string cipher;
class HttpServerConnectionMgr
member
public: void create(WebServer server);
member
public: void close();
member
public: WebServer server;
member
public: list connections;
member
public: list start();
member
public: integer server_socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: void accepted();
end_class
class HttpServerConnection
member
public: void create(WebServer server, integer socket_id);
member
public: void close();
member
public: WebServer server;
member
public: integer socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer _time;
member
public: void startReceiveCommand();
member
public: void startReceiveHeaders();
member
public: void startReceiveBlockSize();
member
public: void startReceiveContents();
member
public: void startReceiveContents2();
member
public: void startReceiveCRLF();
member
public: void commandReceived();
member
public: void headersReceived();
member
public: void blockSizeReceived();
member
public: void contentsReceived();
member
public: void contentsReceived2();
member
public: void CRLFReceived();
member
public: list chunked;
member
public: integer buffer_size;
member
public: list buffer;
member
public: string command_line;
member
public: string command;
member
public: string http_ver;
member
public: integer content_block_size;
member
public: list bin_raw_http_header;
member
public: list headers;
member
public: integer content_length;
member
public: string refer;
member
public: list contents;
member
public: void process();
member
public: string order;
member
public: string path;
member
public: string path2;
member
public: list params;
member
public: list send(string str);
member
public: list send(list binary);
member
public: list send(list binary, integer index, integer size);
member
public: void sendCompleted();
member
public: string send_status;
member
public: file in;
member
public: integer total_read_bytes;
member
public: string fromIP;
member
public: list cert_info;
member
public: HttpServlet servlet;
member
public: HttpRequest req;
member
public: HttpResponse res;
member
public: list binary;
member
public: string boundary;
member
public: string upload_filename;
member
public: file upload;
end_class
class HttpClientConnection
member
public: list create(string url);
member
public: list doGet();
member
public: list doPost();
member
public: list doGet_noWait();
member
public: list doPost_noWait();
member
public: list isCompleted();
member
public: string request_method;
member
public: list connect();
member
public: list startReceiveProxyHeaders();
member
public: void proxyHeadersReceived();
member
public: void close();
member
public: string url;
member
public: list ssl;
member
public: string cert;
member
public: string key;
member
public: string ca_cert;
member
public: integer server_auth;
member
public: string host;
member
public: integer port;
member
public: string proxy_server;
member
public: integer proxy_port;
member
public: string path;
member
public: integer socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer _time;
member
public: void setTimeout(integer sec);
member
public: integer timeout;
member
public: list headers;
member
public: list out(string s);
member
public: list out(list binary);
member
public: list out(list binary, integer index, integer size);
member
public: list output;
member
public: integer max_size;
member
public: integer content_length;
member
public: WaitObj wait_obj;
member
public: list send(string str);
member
public: list send(list binary);
member
public: list send(list binary, integer index, integer size);
member
public: list send2();
member
public: void sendCompleted();
member
public: integer send_index;
member
public: integer send_block_size;
member
public: integer send_total_size;
member
public: list startReceiveCommand();
member
public: list startReceiveHeaders();
member
public: list startReceiveBlockSize();
member
public: list startReceiveContents();
member
public: list startReceiveCRLF();
member
public: void commandReceived();
member
public: void headersReceived();
member
public: void blockSizeReceived();
member
public: void contentsReceived();
member
public: void CRLFReceived();
member
public: list chunked;
member
public: list error;
member
public: integer buffer_size;
member
public: list buffer;
member
public: string command;
member
public: integer content_block_size;
member
public: list contents;
member
public: integer response_code;
member
public: list cert_info;
member
public: static list connections;
member
public: static list hostaddr_cache;
member
public: static integer connect_timeout;
end_class
class HttpServlet
member
public: void doGet(HttpRequest req, HttpResponse res);
member
public: void doPost(HttpRequest req, HttpResponse res);
member
public: static list servlet_params;
member
public: string toUTF8(string str);
member
public: string toUTF8_direct(string str);
member
public: string fromUTF8(string str);
member
public: string fromUTF8(list str);
class WebUIServlet
member
public: void doGet(HttpRequest req, HttpResponse res);
member
public: void doPost(HttpRequest req, HttpResponse res);
member
public: void doAction(list params);
member
public: list get_arg_dcl(list params, DbConnection conn);
member
public: list invokeLogin(list params, DbConnection conn);
member
public: list invokeLogout(list params, DbConnection conn);
member
public: list authorize(list params, DbConnection conn);
member
public: list authorize2(list params, DbConnection conn);
member
public: list checkUserRole(string role_name);
member
public: list checkUserRole(DbConnection conn);
member
public: string action;
member
public: string target;
member
public: string admin_target;
member
public: string user_name;
member
public: list user_roles;
member
public: void error(string msg);
member
public: void error(string msg, AlException e);
member
public: HttpRequest req;
member
public: HttpResponse res;
member
public: HttpSession session;
member
public: static string pool_name;
member
public: list invokeWebUiAdminHome(list params, DbConnection conn);
member
public: list invokeWebUiAdminMenuEdit(list params, DbConnection conn);
member
public: list invokeWebUiAdminViewHome(list params, DbConnection conn);
member
public: list invokeWebUiAdminViewEdit(list params, DbConnection conn);
member
public: list invokeWebUiAdminSelectableHome(list params, DbConnection conn);
member
public: list invokeWebUiAdminSelectableEdit(list params, DbConnection conn);
member
public: XmlDbObject findItem(list itr, integer line_number);
member
public: XmlDbObject findItem(list itr, string path, string value);
member
public: integer max_line_number;
member
public: void incLineNumber(list itr);
member
public: void decLineNumber(list itr);
member
public: list invokeAdminHome(list params, DbConnection conn);
member
public: list invokeAdminMenu(list params, DbConnection conn);
member
public: list menu(list params, DbConnection conn);
member
public: string adminMenuTarget(string target, string user_name);
member
public: list invokeView(list params, DbConnection conn);
member
public: string getValue(string name);
member
public: XmlDbObject getSingle(XmlDbAccessor acc, list cond);
member
public: XmlDbObject getSingle(XmlDbObject obj, string path, list cond);
member
public: list getMultiple(XmlDbAccessor acc, list cond);
member
public: list getMultiple(XmlDbObject obj, string path, list cond);
member
public: list getMultiple(XmlDbAccessor acc, list cond, string range_path, string range_type, string from, string to, string order_path, string order_type, list desc);
member
public: list getMultiple(XmlDbObject obj, string path, list cond, string range_path, string range_type, string from, string to, string order_path, string order_type, list desc);
member
public: list checkPath(string msgType, string msgVersion, string dtd_filename, string path, DbConnection conn);
member
public: list checkFromTo(string from, string to);
member
public: list invokeProcessDefinition(list params, DbConnection conn);
member
public: list invokeProcessInstance(list params, DbConnection conn);
member
public: list invokeTickerCheck(list params, DbConnection conn);
member
public: list invokeSystemLog(list params, DbConnection conn);
member
public: list invokeCommLog(list params, DbConnection conn);
member
public: list invokeAccessLog(list params, DbConnection conn);
member
public: list invokeProxyLog(list params, DbConnection conn);
member
public: list invokeProcessLog(list params, DbConnection conn);
member
public: list invokeBackupLog(list params, DbConnection conn);
member
public: list invokeUser(list params, DbConnection conn);
member
public: list invokeMyInfo(list params, DbConnection conn);
member
public: list invokePartnerInfo(list params, DbConnection conn);
member
public: XmlDbObject getUser(XmlDbAccessor acc, string user, DbConnection conn);
member
public: XmlDbObject getMyInfo(XmlDbAccessor acc, string my_id, DbConnection conn);
member
public: XmlDbObject getPartnerInfo(XmlDbAccessor acc, string partner_id, DbConnection conn);
member
public: list invokeBackupSetting(list params, DbConnection conn);
member
public: list invokeRestart(list params, DbConnection conn);
member
public: list invokeShutdown(list params, DbConnection conn);
member
public: list invokeCacheClear(list params, DbConnection conn);
member
public: list invokeGC(list params, DbConnection conn);
member
public: list invokeShell(list params, DbConnection conn);
member
public: void genPageBegin(string title);
member
public: void genRefreshPageBegin(string title, integer interval);
member
public: void genPageEnd();
member
public: void genFormBegin(string action, list upload);
member
public: void genFormEnd();
member
public: void genTitle(string text);
member
public: void genText(string text);
member
public: void genLink(string path, string text);
member
public: void genBR();
member
public: void genHR();
member
public: void genButton(string name, string value);
member
public: void genTextField(string name, integer size, string value);
member
public: void genPassword(string name, integer size, string value);
member
public: void genTextArea(string name, integer rows, integer cols, string value);
member
public: void genCheck(string name, string text, list checked);
member
public: void genRadio(string name, string value, string text, list checked);
member
public: void genHidden(string name, string value);
member
public: void genUpload(string name);
member
public: void genSelect(string name, list values);
member
public: void genTable1(XmlDbObject obj, list visibles, list editables, list passwords, list io_map);
member
public: void genTable2(list objs, list visibles, list checks, list radio, integer count_from, integer count_max, list io_map);
member
public: string toUTF8(string str);
member
public: string fromUTF8(string str);
member
public: string fromUTF8(list str);
member
public: void invokeTest(list params, DbConnection conn);
member
public: void dumpProps(list params);
member
public: void invokeTestWebUiParts(list params, DbConnection conn);
member
public: void invokeNextAction(list params, DbConnection conn);
member
public: string date_str(list datetime);
member
public: string date_str_2(list datetime);
member
public: list date_xml(list datetime);
member
public: string from_date_html(list xml);
member
public: string to_date_html(list xml);
member
public: integer date_int(string date_str);
class WebUIbizsoftServlet
class WebUIbizsoftCustomerServlet
member
public: void doGet(HttpRequest req, HttpResponse res);
member
public: void doPost(HttpRequest req, HttpResponse res);
member
public: list invokeProductList(list params, DbConnection conn);
member
public: list invokeCart(list params, DbConnection conn);
member
public: list invokeRegist(list params, DbConnection conn);
member
public: list invokeLogin(list params, DbConnection conn);
member
public: list invokeCustomerHome(list params, DbConnection conn);
member
public: list invokeCustomerMenu(list params, DbConnection conn);
member
public: list invokeMyAccount(list params, DbConnection conn);
member
public: list invokeBuy(list params, DbConnection conn);
member
public: static integer consumer_tax_rate;
end_class
class WebUIbizsoftSalesServlet
member
public: list invokeLogin(list params, DbConnection conn);
member
public: list invokeSalesHome(list params, DbConnection conn);
member
public: list invokeSalesMenu(list params, DbConnection conn);
member
public: list invokePurchaseOrder(list params, DbConnection conn);
member
public: list invokeInventory(list params, DbConnection conn);
member
public: list invokeProductArrival(list params, DbConnection conn);
member
public: list invokeShipment(list params, DbConnection conn);
member
public: static integer consumer_tax_rate;
end_class
class WebUIbizsoftAccountServlet
member
public: list invokeLogin(list params, DbConnection conn);
member
public: list invokeAccountHome(list params, DbConnection conn);
member
public: list invokeAccountMenu(list params, DbConnection conn);
member
public: list invokeCheckList(list params, DbConnection conn);
member
public: list invokeCheckInput(list params, DbConnection conn);
member
public: list invokeCheckCheck(list params, DbConnection conn);
member
public: list invokeLedger(list params, DbConnection conn);
member
public: list invokeBalanceSheet(list params, DbConnection conn);
member
public: list invokeEarningStatement(list params, DbConnection conn);
member
public: list invokeTrialBalanceSheet(list params, DbConnection conn);
member
public: list invokeAccountHeadings(list params, DbConnection conn);
member
public: void getAccountHeadingsData(DbConnection conn);
member
public: list getStockFlowItems(DbConnection conn);
member
public: static list ah_xml;
member
public: static list ah_tree;
member
public: static string consumer_tax_rate;
member
public: string debtor_ah_list(string submit, DbConnection conn);
member
public: string credit_side_ah_list(string submit, DbConnection conn);
member
public: string as_list(string selected_ah, string side, list props, DbConnection conn);
member
public: static void test();
end_class
end_class
class WebUIrosettaServlet
member
public: list invokePipInfo(list params, DbConnection conn);
member
public: XmlDbObject getPipInfo(XmlDbObject obj, string msg_type, string msg_version, DbConnection conn);
member
public: list invokeCommLog(list params, DbConnection conn);
member
public: list invokeShowMessage(list params, DbConnection conn);
class WebUIrosettaSampleBuyerServlet
member
public: list invokeLogin(list params, DbConnection conn);
member
public: list invokeBuyerHome(list params, DbConnection conn);
member
public: list invokeBuyerMenu(list params, DbConnection conn);
member
public: list invokeCatalog(list params, DbConnection conn);
member
public: list invokeApproval(list params, DbConnection conn);
member
public: list invokeTransmit(list params, DbConnection conn);
end_class
class WebUIrosettaSampleSupplierServlet
member
public: list invokeLogin(list params, DbConnection conn);
member
public: list invokeSupplierHome(list params, DbConnection conn);
member
public: list invokeSupplierMenu(list params, DbConnection conn);
member
public: list invokeReceipt(list params, DbConnection conn);
member
public: list invokeInventory(list params, DbConnection conn);
member
public: list invokeFulfill(list params, DbConnection conn);
member
public: list invokeInvoice(list params, DbConnection conn);
end_class
end_class
end_class
class TransportServlet
member
public: static string pool_name;
class RNIF20Servlet
member
public: void doPost(HttpRequest req, HttpResponse res);
member
public: void log(string log_level, string fromIP, string msg, string msgId, DbConnection conn);
end_class
end_class
class ProxyPolleeServlet
member
public: void doGet(HttpRequest req, HttpResponse res);
member
public: static string add(string fromIP, string cert_info, string dir, list headers, list message);
member
public: static string get(string dir, string id);
member
public: static void remove(string dir, string id);
member
public: static void listup(string dir);
member
public: static list ids;
member
public: void doPost(HttpRequest req, HttpResponse res);
end_class
class TestServlet1
member
public: void doGet(HttpRequest req, HttpResponse res);
end_class
class TestServlet2
member
public: void doGet(HttpRequest req, HttpResponse res);
member
public: void doPost(HttpRequest req, HttpResponse res);
end_class
end_class
class HttpRequest
member
public: WebServer _server;
member
public: HttpResponse _response;
member
public: string _command;
member
public: string _path;
member
public: string _params;
member
public: list bin_raw_http_header;
member
public: list headers;
member
public: string fromIP;
member
public: list cert_info;
member
public: list input;
member
public: string input_file;
member
public: list getParameters();
member
public: string getParameter(string name);
member
public: list parameters;
member
public: HttpSession createSession();
member
public: HttpSession getSession();
member
public: list getCookies();
member
public: string getCookie(string name);
member
public: list cookies;
member
public: string getBasePath();
member
public: static list splitNameValue(string name_value);
end_class
class HttpResponse
member
public: void _create();
member
public: HttpRequest _request;
member
public: integer response_code;
member
public: list headers;
member
public: list output;
member
public: integer max_size;
member
public: integer content_length;
member
public: void out(string s);
member
public: void out(list binary);
member
public: void out(list binary, integer index, integer size);
member
public: void redirect(string url);
member
public: void redirectWithSession(string url);
member
public: WebServer _server;
member
public: string http_ver;
member
public: string system_command;
member
public: string response_filepath;
member
public: string response_content_disposition;
end_class
class HttpSession
member
public: void _create(WebServer server);
member
public: WebServer _server;
member
public: string _sessionId;
member
public: integer _time;
member
public: void invalidate();
member
public: list getAttributes();
member
public: list getAttribute(string name);
member
public: void setAttribute(string name, list attr);
member
public: void setAttribute(string name, integer attr);
member
public: void setAttribute(string name, string attr);
member
public: void setAttribute(string name, AlObject attr);
member
public: list attrs;
end_class
class TransportTransmitter
member
public: string send(string msgId, string partner_id, string partner_role, string my_id, string my_role, DbConnection conn);
member
public: void set_org_msg_info(string msgId);
member
public: void set_app_pid(string pid);
member
public: string send_process_name;
member
public: string org_msgId;
member
public: string org_msg_type;
member
public: string org_msg_version;
member
public: string org_dtd_filename;
member
public: string app_pid;
member
public: string sync_type;
class RNIF20Transmitter
member
public: string send(string msgId, string partner_id);
member
public: string send(string msgId, string partner_id, DbConnection conn);
member
public: string send(string msgId, string partner_id, string partner_role, string my_id, string my_role);
member
public: string send(string msgId, string partner_id, string partner_role, string my_id, string my_role, DbConnection conn);
end_class
end_class
end_class
class ProxyServer
member
public: string name;
member
public: integer port;
member
public: integer connect_timeout;
member
public: list start();
member
public: void stop();
member
public: ProxyServerConnectionMgr conn_mgr;
member
public: void timeoutCheck();
member
public: integer connectionTimeout;
member
public: AltairServer ap_server;
member
public: integer maxMsgSize;
member
public: void proxy_log(string fromIP, string path, string reason);
member
public: string proxy_log_filepath;
member
public: string proxy_log_db;
member
public: void error_log(string str);
class ProxyServerConnectionMgr
member
public: void create(ProxyServer server);
member
public: void close();
member
public: ProxyServer server;
member
public: list connections;
member
public: list start();
member
public: integer server_socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: void accepted();
end_class
class ProxyServerConnection
member
public: void create(ProxyServer server, integer socket_id);
member
public: void close();
member
public: ProxyServer server;
member
public: integer socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer msg2;
member
public: integer _time;
member
public: void startReceiveCommand();
member
public: void startReceiveHeaders();
member
public: void startReceive();
member
public: void commandReceived();
member
public: void headersReceived();
member
public: void received();
member
public: integer buffer_size;
member
public: list buffer;
member
public: string command_line;
member
public: string command;
member
public: string request_url;
member
public: string path;
member
public: string http_ver;
member
public: list headers;
member
public: list send(string str);
member
public: list send(list binary);
member
public: list send(list binary, integer index, integer size);
member
public: void sendCompleted();
member
public: string send_status;
member
public: list exiting;
member
public: file in;
member
public: string fromIP;
member
public: ProxyClientConnection conn;
member
public: list sending;
end_class
class ProxyClientConnection
member
public: list create(ProxyServer server, string url);
member
public: ProxyServer server;
member
public: list connect();
member
public: void close();
member
public: string url;
member
public: list ssl;
member
public: string host;
member
public: integer port;
member
public: string path;
member
public: integer socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer msg2;
member
public: integer _time;
member
public: void setTimeout(integer sec);
member
public: integer timeout;
member
public: list send(string str);
member
public: list send(list binary);
member
public: list send(list binary, integer index, integer size);
member
public: void sendCompleted();
member
public: list startReceiveCommand();
member
public: list startReceiveHeaders();
member
public: list startReceive();
member
public: void commandReceived();
member
public: void headersReceived();
member
public: void received();
member
public: list error;
member
public: integer buffer_size;
member
public: list buffer;
member
public: string command_line;
member
public: list headers;
member
public: integer content_length;
member
public: integer total_read_bytes;
member
public: static list connections;
member
public: ProxyServerConnection conn;
member
public: static list hostaddr_cache;
end_class
end_class
class InetClient
member
public: void create(string host, integer port);
member
public: void close();
member
public: string host;
member
public: integer port;
member
public: WaitObj wait_obj;
member
public: string state;
member
public: string msg_prefix;
member
public: list start();
member
public: integer s_id;
member
public: string error;
member
public: integer buffer_size;
member
public: list buffer;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer msg2;
member
public: list startReceive();
member
public: void received();
member
public: integer read_bytes;
member
public: list send(string msg);
member
public: void sendCompleted();
member
public: integer timeout;
member
public: integer _time;
member
public: static void timeoutCheck();
member
public: static list connections;
class SmtpClient
member
public: void create(string host, integer port);
member
public: void create(string host);
member
public: void received();
member
public: list checkResponse();
member
public: list headers;
member
public: string from;
member
public: list rcpts;
member
public: list rcpts_itr;
member
public: list to;
member
public: list cc;
member
public: string subject;
member
public: string text;
member
public: string date;
member
public: string messageid;
member
public: string in_reply_to;
member
public: string references;
member
public: string content_type;
member
public: integer content_length;
member
public: string domain;
member
public: string getDate();
member
public: integer timestamp;
member
public: static integer seq;
member
public: string getMessageID();
end_class
class PopClient
member
public: void create(string host, integer port);
member
public: void create(string host);
member
public: void received();
member
public: list checkResponse();
member
public: list process(string text);
member
public: integer num;
member
public: list readLine();
member
public: string userid;
member
public: string password;
member
public: integer num_msg;
member
public: integer msg_idx;
member
public: string text;
member
public: list texts;
class RNIF20PopClient
member
public: list process(string text);
member
public: DbConnection conn;
end_class
end_class
end_class
class Poller
member
public: void poll();
member
public: void process();
member
public: list processing;
member
public: integer _time;
member
public: integer interval;
member
public: string host;
member
public: string userid;
member
public: string password;
member
public: AltairServer ap_server;
member
public: static void timeoutCheck();
member
public: static void addPoller(Poller poller);
member
public: static void closeAllPollers();
member
public: static list pollers;
class RNIF20ProxyPoller
member
public: void process();
member
public: list process(string fromIP, string cert_info, string id, string message, DbConnection conn);
end_class
class RNIF20PopPoller
member
public: void process();
end_class
end_class
class MultipartSecureMessage
member
public: void setHeader(string name, string value);
member
public: void addHeaderSubType(string name, string subtype, string value);
member
public: void setBodyHeader(string name, string value);
member
public: void addBodyHeaderSubType(string name, string subtype, string value);
member
public: void addBodyText(string text);
member
public: void addBodyFile(string filename);
member
public: void addBodyBinary(list content_bin, integer from, integer content_len);
member
public: void addMultipartSecureMessage(MultipartSecureMessage msm);
member
public: string _genContentType();
member
public: void writeHeader(file out);
member
public: void writeMultipart(file out);
member
public: void writeMultipartMessage(file out);
member
public: list header;
member
public: list body_header;
member
public: list body_header_bin;
member
public: integer body_index;
member
public: list body_content;
member
public: void readMultipartMessage(string filename);
member
public: void readMultipartMessage(list bin, integer size);
member
public: void readMultipartMessage2(list bin, integer size);
member
public: string getHeader(string name);
member
public: string getHeaderSubType(string name, string subtype);
member
public: integer getCount();
member
public: string getBodyHeader(integer index, string name);
member
public: string getBodyHeaderSubType(integer index, string name, string subtype);
member
public: string getBodyText(integer index);
member
public: list getBodyBinary(integer index);
member
public: void getBody(integer index);
member
public: list multipart;
member
public: void encrypt(string cipher, string cert);
member
public: void sign(string cert, string key);
member
public: list isEncrypted(integer index);
member
public: void decrypt(integer index, string cert, string key);
member
public: list isSigned();
member
public: list verify(string cert, string ca_cert);
member
public: void multipartToOneBody();
member
public: void oneBodyToMultipart(integer index);
member
public: static void getBody(string in_file, string name, string out_file);
end_class
class XmlUtility
member
public: static void Initialize();
member
public: static list init;
member
public: static string ctrl_a;
member
public: static list parseXML(string xml, list debug);
member
public: static list parseXML(file in, list debug);
member
public: static list parseXML(string filename);
member
public: static string xslTransform(string xsl_filename, list xml);
member
public: static string getDocType(list parse_tree);
member
public: static string getDTDfile(list parse_tree);
member
public: static list loadDTD(string filename);
member
public: static list loadXmlSchema(string filename);
member
public: static list loadXSL(string filename);
member
public: static void validateXML(list dtd, list parse_tree);
member
public: static string dtd_base;
member
public: static string xsl_base;
member
public: static string content_validation_base;
member
public: static list dtd_cache;
member
public: static list xsl_cache;
member
public: static XmlDbObject createMsgData(string msgId, string msgType, string msgVersion, string dtdFilename, DbConnection conn);
member
public: static XmlDbObject getMsgData(string msgId, string msgType, string msgVersion, string dtdFilename, DbConnection conn);
member
public: list isLike(string value);
member
public: void skip_optional();
member
public: void skip_choice();
member
public: void skip_case();
member
public: void skip_all_opt();
member
public: DtdItr dtd_itr;
member
public: list content_validate;
member
public: string validation_errors;
member
public: static list content_validation_report;
class XmlSchemaLoader
end_class
class DtdLoader
member
public: list read_entities(file in);
member
public: list apply_entities(file in, file out);
member
public: list entities;
member
public: list read_element(file in);
member
public: list elems;
member
public: list root_elem;
member
public: list elem_attr(file in);
member
public: list load_elem(file in);
member
public: list load_elem1(file in);
member
public: list load_elem2(file in);
member
public: list load_elem_tag(file in);
member
public: list load_elem_empty_any(file in);
member
public: list load_elem_data(file in);
member
public: list add_attr(list elem, file in);
member
public: list attr;
member
public: list load_attr_choice(file in);
member
public: void normalize();
member
public: list check_recursive(list elem, list tags);
member
public: list check_recursive(list ret, string tag);
member
public: list data_duplicate;
member
public: void error_log(string s);
member
public: void warning_log(string s);
member
public: void info_log(string s);
member
public: list log_level;
member
public: static void attach_content_validation_data(list dtd, string csv_filename);
member
public: static void get_node(list ret, list elem, string xpath);
class ExtendedDtdLoader
member
public: list read_element(file in);
member
public: list elem_attr(file in);
member
public: list add_attr(list elem, file in);
end_class
end_class
class DtdItr
member
public: void Reset(list node0);
member
public: list Next(list skip_flag);
member
public: list pop();
member
public: list stack;
member
public: list type;
member
public: list node;
member
public: list opt;
member
public: void ContinueRepetition();
member
public: void BreakRepetition();
member
public: list repetition_stack;
member
public: string abs_xpath;
member
public: string rel_xpath;
member
public: string attr;
member
public: string tag;
member
public: list xpath_stack;
member
public: void expand_recursive();
member
public: void mark(list elem);
member
public: void unmark(list elem);
member
public: list recursive_expanded;
member
public: string repetition_tag;
member
public: DtdHandler handler;
member
public: DtdItr Copy();
member
public: list stack_copy(list stack);
member
public: list repetition_stack_copy(list repetition_stack);
member
public: list getFieldList();
member
public: list getChildList();
member
public: DtdItr getChild(string xpath);
member
public: list getFieldList2();
member
public: list getChild2(string xpath);
member
public: list tag2;
member
public: list ns_stack;
member
public: list all_tag;
end_class
class DtdHandler
member
public: void startElement(string tag);
member
public: void endElement(string tag);
member
public: void setNamespace(string name);
class XmlComposerHandler
member
public: void startElement(string tag);
member
public: void endElement(string tag);
member
public: void setNamespace(string name);
member
public: XmlComposer composer;
member
public: void out_current_tag();
member
public: string current_tag;
member
public: list current_attrs;
member
public: string current_value;
member
public: string raw_current_value;
member
public: void out_str(string val);
member
public: string ns_name;
member
public: list ns_names;
end_class
end_class
class XmlItr
member
public: void Reset(list parse_tree);
member
public: list Next();
member
public: list Next2();
member
public: list Next3();
member
public: list Next3(string prev_rept_xpath);
member
public: list stack;
member
public: list xpath;
member
public: string value;
member
public: list getNext(string xpath, string attr);
member
public: list getNext(string prev_rept_xpath, string xpath, string attr);
member
public: list getAttribute(list tag, string attr);
member
public: list getNodeAsText(string xpath);
member
public: XmlItr Copy();
member
public: void Copy(XmlItr xml_itr);
end_class
class XmlValidator
member
public: list validate(list dtd, list xml);
member
public: list validate1(XmlItr xml_itr);
member
public: void save;
member
public: void Begin();
member
public: void End();
member
public: void BeginRepetition(string abs_xpath, string xpath);
member
public: void ContinueRepetition();
member
public: void BreakRepetition();
member
public: string getMsgId();
member
public: string msgType;
member
public: string msgVersion;
member
public: string putValue(string kind, string xpath, string value);
member
public: void Flush();
member
public: string XPath2TagId(string xpath);
member
public: string dataId;
member
public: string msgId;
member
public: string parentId;
member
public: string tagId;
member
public: integer child_seq;
member
public: integer field_seq;
member
public: string last_repetition_xpath;
member
public: list values;
member
public: list stack;
member
public: integer read_tag_count;
member
public: integer read_elem_count;
member
public: integer read_recursive_tag_count;
class SimpleXml2Db
member
public: void Begin();
member
public: void End();
member
public: void BeginRepetition(string abs_xpath, string xpath);
member
public: void ContinueRepetition();
member
public: void BreakRepetition();
member
public: string getMsgId();
member
public: string putValue(string kind, string xpath, string value);
member
public: void Flush();
member
public: string getTagId();
member
public: string XPath2TagId(string xpath);
member
public: void createXPathTagIdMap();
member
public: list map;
member
public: DbConnection conn;
member
public: string db_type;
member
public: XmlDbAccessor acc;
end_class
end_class
class XmlComposer
member
public: list compose(list dtd);
member
public: list compose1();
member
public: void clear();
member
public: string recursive_check_xpath(string xpath);
member
public: string doctype;
member
public: string dtd_filename;
member
public: string xml;
member
public: void out_str(string val);
member
public: list Begin();
member
public: list GetFields();
member
public: list GetChildren(string path);
member
public: list nextChild();
member
public: void BreakRepetition();
member
public: string getValue(string path);
member
public: string msgType;
member
public: string msgVersion;
member
public: string value;
member
public: XmlComposerHandler handler;
member
public: integer read_tag_count;
member
public: list recursive_expand_tag_count;
class SimpleDb2Xml
member
public: list Begin();
member
public: list GetFields();
member
public: list GetChildren(string path);
member
public: list nextChild();
member
public: void BreakRepetition();
member
public: string getValue(string path);
member
public: void createTagIdPathMap();
member
public: string dataId;
member
public: string msgId;
member
public: string parentId;
member
public: string tagId;
member
public: list values;
member
public: list children;
member
public: list stack;
member
public: list map;
member
public: list map2;
member
public: DbConnection conn;
member
public: string db_type;
member
public: XmlDbAccessor acc;
end_class
end_class
class XmlDataRetriver
member
public: void create(list tree);
member
public: list tag_tree;
member
public: list body_tree;
member
public: list itr;
member
public: string tag;
member
public: XmlDataRetriver getItr(string xpath);
member
public: XmlDataRetriver getNext();
member
public: string getValue(string xpath);
end_class
class XmlDbAccessor
member
public: void create(string msgType, string msgVersion, DbConnection conn);
member
public: void setDTD(list dtd);
member
public: void setDTDbase(string dtd_base);
member
public: void setDTDfilename(string dtd_filename);
member
public: void setContentValidationBase(string content_validation_base);
member
public: void setContentValidation(list flag);
member
public: void setDocType(string doc_type);
member
public: string putXML(string xml);
member
public: string putXML(string xml, string msgId);
member
public: string putXML(list parse_tree, string msgId);
member
public: string getXML(string msgId);
member
public: XmlDbObject create();
member
public: XmlDbObject create(string msgId);
member
public: XmlDbObject getMetaInfo();
member
public: XmlDbObject get(string msgId);
member
public: XmlDbObject getWithMsgTypeAndMsgVersion(string msgId);
member
public: list getAll();
member
public: list get(string path, string value);
member
public: list get(string path1, string value1, string path2, string value2);
member
public: list get(string path1, string value1, string path2, string value2, string path3, string value3);
member
public: list get(list cond);
member
public: list get(list cond, string range_path, string range_type, string from, string to, string orderby_path, string orderby_type, list desc);
member
public: string msgType;
member
public: string msgVersion;
member
public: DbConnection conn;
member
public: string db_type;
member
public: list _dtd;
member
public: string _dtd_base;
member
public: string _content_validation_base;
member
public: string _dtd_filename;
member
public: string _doc_type;
member
public: void createTagPathMap();
member
public: string getTagId();
member
public: string XPath2TagId(string xpath);
member
public: list map;
member
public: list map2;
member
public: string getMsgId();
member
public: static string digit5(integer val);
member
public: void createFieldList();
member
public: list xpath_list;
member
public: DtdItr dtd_itr;
member
public: integer count_max;
class XmlDbTableAccessor
member
public: string putXML(list parse_tree, string msgId);
member
public: string getXML(string msgId);
member
public: XmlDbObject create();
member
public: XmlDbObject create(string msgId);
member
public: XmlDbObject get(string msgId);
member
public: list get(list cond);
member
public: list get(list cond, string range_path, string range_type, string from, string to, string orderby_path, string orderby_type, list desc);
member
public: void createFieldList2();
member
public: string table_name;
member
public: string pkey_names;
member
public: list rev_xpath_list;
end_class
end_class
class XmlDbObject
member
public: static integer MAX_VALUE_SIZE;
member
public: string msgType;
member
public: string msgVersion;
member
public: DbConnection conn;
member
public: string db_type;
member
public: XmlDbAccessor acc;
member
public: string dataId;
member
public: string msgId;
member
public: string parentId;
member
public: string tagId;
member
public: integer field_seq;
member
public: integer child_seq;
member
public: void putField(string path, string value);
member
public: void removeField(string path);
member
public: XmlDbObject createChild(string path);
member
public: XmlDbObject getMetaInfo(string path);
member
public: string getField(string path);
member
public: list getChildren(string path);
member
public: list getChildren(string path, string path1, string value1);
member
public: list getChildren(string path, string path1, string value1, string path2, string value2);
member
public: list getChildren(string path, list cond);
member
public: list getChildren(string path, list cond, string range_path, string range_type, string from, string to, string orderby_path, string orderby_type, list desc);
member
public: void fetch();
member
public: list values;
member
public: void delete();
member
public: list fetched;
member
public: DtdItr dtd_itr;
member
public: list xpath_list;
member
public: integer count_max;
class XmlDbTableObject
member
public: void putField(string path, string value);
member
public: void removeField(string path);
member
public: XmlDbObject createChild(string path);
member
public: void delete();
member
public: string getField(string path);
member
public: list getChildren(string path, list cond);
member
public: list getChildren(string path, list cond, string range_path, string range_type, string from, string to, string orderby_path, string orderby_type, list desc);
member
public: void fetch();
member
public: list table_name;
member
public: list pkey_values;
member
public: list rev_xpath_list;
end_class
end_class
class Csv1Data
member
public: void loadCSV(string filename);
member
public: list root_csv_data;
class Csv1DataItr
member
public: void Reset(list csv_data);
member
public: void Reset();
member
public: list base_csv_data;
member
public: list csv_data_itr;
member
public: list nextRow();
member
public: string parent_id;
member
public: string child_id;
member
public: string dst_path;
member
public: string src_path;
member
public: string value;
member
public: Csv1Data nextChild();
member
public: Csv1Data nextChild(string name);
member
public: string base_parent_name;
member
public: string base_parent_id;
member
public: string base_child_id;
member
public: string base_dst_path;
member
public: string base_src_path;
member
public: string base_value;
end_class
end_class
end_class
class ProcessEngine
member
public: list start();
member
public: void stop();
member
public: integer timer_id;
member
public: integer ticker_interval;
member
public: string cleanup_time;
member
public: string process_log_filepath;
member
public: list process_log_db;
member
public: AltairServer ap_server;
member
public: ProcSched sched;
member
public: integer max_property_cache;
member
public: static string pool_name;
member
public: list debug_mode;
member
public: list exception_detail;
class ProcMgr
member
public: static void Initialize();
member
public: void register(string processDefName, list def);
member
public: void register(string processDefName, list def, DbConnection conn);
member
public: void unregister(string processDefName);
member
public: void unregister(string processDefName, DbConnection conn);
member
public: string create(string processDefName);
member
public: string create(string processDefName, DbConnection conn);
member
public: string start(string processId);
member
public: string start(string processId, DbConnection conn);
member
public: void putProperties(string processId, list props);
member
public: void putProperties(string processId, list props, DbConnection conn);
member
public: list getProperties(string processId);
member
public: list getProperties(string processId, DbConnection conn);
member
public: string getWorkItem(string processId, string activityName);
member
public: string getWorkItem(string processId, string activityName, DbConnection conn);
member
public: list getWorkItems(string processId);
member
public: list getWorkItems(string processId, DbConnection conn);
member
public: list getWorkItems();
member
public: list getWorkItems(DbConnection conn);
member
public: list getProcList();
member
public: list getProcList(DbConnection conn);
member
public: list getProcList(string status);
member
public: list getProcList(string status, DbConnection conn);
member
public: list complete(string processId, string workItem);
member
public: list complete(string processId, string workItem, DbConnection conn);
member
public: void completeByName(string processId, string activityName);
member
public: void completeByName(string processId, string activityName, DbConnection conn);
member
public: void suspend(string processId);
member
public: void suspend(string processId, DbConnection conn);
member
public: void resume(string processId);
member
public: void resume(string processId, DbConnection conn);
member
public: void abort(string processId);
member
public: void abort(string processId, DbConnection conn);
member
public: void delete(string processId);
member
public: void delete(string processId, DbConnection conn);
member
public: void deleteCleanup();
member
public: void deleteCleanup(DbConnection conn);
member
public: void deleteAll();
member
public: void deleteAll(DbConnection conn);
member
public: string getCmdQueueId(DbConnection conn);
member
public: static string Begin;
member
public: static string End;
member
public: static string OrSplit;
member
public: static string OrJoin;
member
public: static string AndSplit;
member
public: static string AndJoin;
member
public: static string Auto;
member
public: static string Manual;
member
public: static string Wait;
end_class
class ProcSched
member
public: void execute();
member
public: void _execute();
member
public: list running;
member
public: string ticker_last_timestamp;
member
public: list process();
member
public: string processDefName;
member
public: string processId;
member
public: string activityId;
member
public: string activityKind;
member
public: string activityName;
member
public: string propertyName;
member
public: string status;
member
public: integer exec_count;
member
public: list suspend;
member
public: void invokeNext(string processId, string activityId);
member
public: void invokeEnd(string processId);
member
public: void invokeOrSplit(string processId, string activityId, string propertyName);
member
public: void invokeAndSplit(string processId, string activityId);
member
public: void invokeAndJoin(string processId, string activityId);
member
public: void invokeAuto(string processId, string activityId);
member
public: void invokeManual(string processId, string activityId);
member
public: void invokeWait(string processId, string activityId);
member
public: void invokeComplete(string processId, string activityId);
member
public: void deleteProcess(string processId);
member
public: list getNextActivities(string processId, string activityId);
member
public: list getProperties(string processId);
member
public: void putProperties(string processId, list props, list ret_props);
member
public: list property_cache;
member
public: void activateActivity(string processId, string nextActivityId);
member
public: void deactivateActivity(string processId, string activityId);
member
public: void enqueueExecQueueItem(string processId, string nextActivityId, string nextActivityKind, string nextActivityName, string nextPropertyName);
member
public: void enqueueWorkItem(string processId, string nextActivityId, string nextActivityKind, string nextActivityName, string nextPropertyName);
member
public: void makeExecQueueItem(string processId, string activityId);
member
public: void makeWaitQueueItem(string processId, string activityId, string time);
member
public: void makeSuspendQueueItem(string processId, string activityId);
member
public: void makeCleanupQueueItem(string processId);
member
public: void dequeueQueueItem(string processId, string activityId);
member
public: void handleError(string reason, AlException ex);
member
public: void process_log(string action, string msg);
member
public: DbConnection conn;
member
public: string db_type;
member
public: ProcessEngine pe;
member
public: static ProcSched instance;
member
public: void invokePutProperty(string cmd_id, string processId, string name, string value);
member
public: list invokeSuspend(string cmd_id, string processId);
member
public: list invokeResume(string cmd_id, string processId);
member
public: list invokeAbort(string cmd_id, string processId);
member
public: list invokeDelete(string cmd_id, string processId);
member
public: list invokeCompleteByActivityName(string cmd_id, string processId, string activityName);
member
public: void dequeueCmdQueueItem(string cmd_id);
end_class
class Process
member
public: list getDefinition();
member
public: void initActivities();
member
public: void beginActivity(string activityName, string activityKind);
member
public: void andJoinCount(string andJoinCount);
member
public: void waitTime(string waitTime);
member
public: void serviceClass(string className);
member
public: void propertyValue(string propertyValue);
member
public: void next(string nextActivityName);
member
public: void nextPropertyName(string nextPropertyName);
member
public: void end();
member
public: list in_begin_end;
member
public: void validate();
member
public: void activity;
member
public: integer activity_seq;
member
public: string prevActivityName;
member
public: list activities;
member
public: void initProperties();
member
public: void putProperty(string name, string value);
member
public: list properties;
member
public: list def;
class RNIF20SendProcess
member
public: void initActivities();
member
public: void initProperties();
end_class
class RNIF20ReceiveProcess
member
public: void initActivities();
member
public: void initProperties();
end_class
class PoSendProcess
member
public: void initActivities();
member
public: void initProperties();
end_class
class PoReceiveProcess
member
public: void initActivities();
member
public: void initProperties();
end_class
class PoCompleteProcess
member
public: void initActivities();
member
public: void initProperties();
end_class
class TestProcess1
member
public: void initActivities();
member
public: void initProperties();
end_class
class TestProcess2
member
public: void initActivities();
member
public: void initProperties();
end_class
end_class
class PeService
member
public: list invoke(list props);
member
public: DbConnection conn;
member
public: string db_type;
member
public: list debug_mode;
member
public: list exception_detail;
class ServiceClass
member
public: list invoke(list props);
member
public: list get_arg_dcl(list props);
end_class
class PoSyncAcceptService
member
public: list invoke(list props);
end_class
class TestPeService1
member
public: list invoke(list props);
end_class
class TestPeService2
member
public: list invoke(list props);
end_class
end_class
class ServiceHandler
member
public: DbConnection conn;
member
public: string db_type;
member
public: string fromUTF8(string str);
member
public: string toUTF8(string str);
member
public: string errorMsg(string msg, AlException e);
member
public: list debug_mode;
member
public: list exception_detail;
member
public: void dumpProps(list props);
class RNIF20ServiceHandler
member
public: list invokeCreateHeader(list props);
member
public: void createPreamble();
member
public: void createDeliveryHeader();
member
public: void createRequestServiceHeader();
member
public: void createResponseServiceHeader();
member
public: void createSignalServiceHeader();
member
public: string msgId;
member
public: string attach_dir;
member
public: string my_id;
member
public: string partner_id;
member
public: string process_code;
member
public: string indicator;
member
public: string process_id;
member
public: string process_version;
member
public: string reply_code;
member
public: string reply_id;
member
public: string msg_code;
member
public: string msg_ver;
member
public: string from_role_class;
member
public: string from_service;
member
public: string to_role_class;
member
public: string to_service;
member
public: string usage_code;
member
public: string initiator;
member
public: string req_doc_id;
member
public: string message_id;
member
public: list invokePackMessage(list props);
member
public: list invokeUnpackMessage(list props);
member
public: list checkServiceHeaderInfo(XmlDataRetriver retriver, list ret);
member
public: list invokeSaveToDB(list props);
member
public: list invokePreValidationCheck(list props);
member
public: list invokeCreateReceiptAck(list props);
member
public: list invokeCreateReceiptException(list props);
member
public: list invokeCreateNOF(list props);
member
public: list invokeSend(list props);
member
public: list invokeSimpleSend(list props);
member
public: list invokeResponseCheck(list props);
member
public: void notify(string msgId, list ret);
member
public: void inc_error_retry(list ret);
member
public: void inc_retry(list ret);
member
public: integer error_retry_count;
member
public: integer retry_count;
member
public: string sync_type;
member
public: list invokeRetryOverLogInfo(list props);
member
public: list invokeCheckReceipt(list props);
member
public: list invokeCheckReply(list props);
member
public: list invokeReceiveProcess(list props);
member
public: list invokeComplete(list props);
member
public: list invokeWriteLog(list props);
member
public: list invokeCleanup(list props);
member
public: list isTimeout(list props);
end_class
class SampleBuyerServiceHandler
member
public: list invokeCreatePoRequest(list props);
member
public: list invokeSendPoRequest(list props);
member
public: list invokeComplete(list props);
end_class
class SampleSupplierServiceHandler
member
public: list invokeCreatePoAcceptance(list props);
member
public: list invokeSendPoAcceptance(list props);
member
public: list invokeCreateAdvanceShipmentNotification(list props);
member
public: list invokeSendAdvanceShipmentNotification(list props);
member
public: list invokeCreateInvoiceNotification(list props);
member
public: list invokeSendInvoiceNotification(list props);
member
public: list sendReply(list props);
end_class
end_class
end_class
class DbUtility
member
public: string convChar(string str);
class DbConnection
member
public: void prepare(string sql);
member
public: list executeQuery(integer num_cols, list values);
member
public: void executeUpdate(list values);
member
public: list executeQuery(integer num_cols, string sql);
member
public: void executeUpdate(string sql);
member
public: list nextResultSet();
member
public: void setMaxResultSet(integer count);
member
public: void clearMaxResultSet();
member
public: string getNextSeq(string sequenceName);
member
public: void commit();
member
public: void rollback();
member
public: void close();
member
public: list connection;
member
public: list statement;
member
public: list types;
member
public: integer max_result_set;
member
public: string db_type;
member
public: DbConnectionPool pool;
member
public: list in_transaction;
class DbPoolConnection
member
public: void close();
end_class
end_class
class DbConnectionPool
member
public: AltairServer ap_server;
member
public: void start();
member
public: void stop();
member
public: string pool_name;
member
public: DbConnection getConnection();
member
public: string db_type;
member
public: string host;
member
public: string port;
member
public: string db_name;
member
public: string user;
member
public: string pass;
member
public: list free_connections;
member
public: list used_connections;
member
public: integer initial_connections;
member
public: integer max_connections;
member
public: integer num_connections;
member
public: void sql_trace_log(string str);
member
public: string sql_trace_log_filepath;
end_class
class DbManager
member
public: static list createPool(DbConnectionPool pool, string pool_name);
member
public: static void closeAllPools();
member
public: static string getDbType(string pool_name);
member
public: static DbConnection getConnection(string pool_name);
member
public: static list pools;
member
public: static DbConnection getConnection(string db_type, string host, string port, string db_name, string user, string pass);
end_class
end_class
class FileUtility
member
public: static string tempFile();
member
public: static list readBinary(string filename);
member
public: static string readString(string filename);
member
public: static void writeBinary(string filename, list bin);
member
public: static void writeBinary(string filename, list bin, integer from, integer size);
member
public: static void writeBinary(string filename, string str);
member
public: static void appendBinary(string filename, list bin);
member
public: static void appendBinary(string filename, list bin, integer from, integer size);
member
public: static void appendBinary(string filename, string str);
member
public: static void writeString(string filename, string str);
member
public: static void appendString(string filename, string str);
member
public: static list readGraphData(string filename);
member
public: static void writeGraphData(string filename, list data);
member
public: static void remove(string dir);
member
public: static void makeReadOnly(string dir);
member
public: static void makeWritable(string dir);
member
public: static void makeWritable();
class FileItr
member
public: void Reset(string root);
member
public: list Next();
member
public: list stack;
member
public: string root;
member
public: string path;
member
public: string name;
member
public: string abs_path;
member
public: list is_dir;
end_class
class RevFileItr
member
public: void Reset(string root);
member
public: list Next();
member
public: list stack;
member
public: string root;
member
public: string path;
member
public: string name;
member
public: string abs_path;
member
public: list is_dir;
end_class
end_class
class Context
member
public: string getPartnerRole(string target, string partner_id, string msg_type, DbConnection conn);
member
public: string getPartnerProperty(string target, string partner_id, string partner_role, string name, DbConnection conn);
member
public: list getPartnerProperties(string target, string partner_id, string partner_role, DbConnection conn);
member
public: void putPartnerProperty(string target, string partner_id, string partner_role, string name, string value, DbConnection conn);
member
public: void putPartnerProperties(string target, string partner_id, string partner_role, list props, DbConnection conn);
member
public: string getMyRole(string target, string partner_id, string msg_type, DbConnection conn);
member
public: string getMyProperty(string target, string my_role, string name, DbConnection conn);
member
public: list getMyProperties(string target, string my_role, DbConnection conn);
member
public: void putMyProperty(string target, string my_role, string name, string value, DbConnection conn);
member
public: void putMyProperties(string target, string my_role, list props, DbConnection conn);
member
public: void getPartnerInfo(string target, string partner_id, string msg_type, DbConnection conn);
member
public: void getPartnerInfoFromRole(string target, string partner_id, string partner_role, DbConnection conn);
member
public: void getMyInfoFromRole(string target, string my_role, DbConnection conn);
member
public: list getMyPropertiesFromId(string target, string my_id, DbConnection conn);
member
public: void getMyInfoFromId(string target, string my_id, DbConnection conn);
member
public: XmlDbAccessor pi_acc;
member
public: XmlDbObject pi_obj;
member
public: XmlDbObject pi_d_obj;
member
public: string pi_role;
member
public: string mi_role;
member
public: XmlDbAccessor mi_acc;
member
public: XmlDbObject mi_obj;
member
public: XmlDbObject mi_d_obj;
member
public: string my_id;
member
public: static string genTimeStamp();
member
public: static string genTimeStamp(integer diff);
member
public: static string genTimeStamp2();
member
public: static string genMsgId();
member
public: static integer msg_seq;
member
public: XmlDbObject getPartnerInfoXmlDbObject(string target, string partner_id, string partner_role, DbConnection conn);
member
public: XmlDbObject getMyInfoXmlDbObject(string target, string my_role, DbConnection conn);
class RNContext
member
public: string getPartnerRole(string partner_id, string msg_type, DbConnection conn);
member
public: string getMyRole(string partner_id, string msg_type, DbConnection conn);
member
public: string getPartnerProperty(string partner_id, string partner_role, string name, DbConnection conn);
member
public: list getPartnerProperties(string partner_id, string partner_role, DbConnection conn);
member
public: void putPartnerProperty(string partner_id, string partner_role, string name, string value, DbConnection conn);
member
public: void putPartnerProperties(string partner_id, string partner_role, list props, DbConnection conn);
member
public: string getMyProperty(string my_role, string name, DbConnection conn);
member
public: list getMyProperties(string my_role, DbConnection conn);
member
public: void putMyProperty(string my_role, string name, string value, DbConnection conn);
member
public: void putMyProperties(string my_role, list props, DbConnection conn);
member
public: list getPipPropertiesFromMessageCode(string msg_code, string msg_version, DbConnection conn);
member
public: list getPipProperties(string msg_type, string msg_version, DbConnection conn);
member
public: list getMyPropertiesFromId(string my_id, DbConnection conn);
member
public: void getMyInfoFromId(string my_id, DbConnection conn);
member
public: static string currentDateTime();
member
public: static string currentDateStamp();
member
public: static string genDocId();
member
public: static integer doc_id_seq;
member
public: static string genTrackingId();
member
public: static integer tracking_id_seq;
member
public: static string genProcessId();
member
public: static integer process_id_seq;
member
public: XmlDbObject getPartnerInfoXmlDbObject(string partner_id, string partner_role, DbConnection conn);
member
public: XmlDbObject getMyInfoXmlDbObject(string my_role, DbConnection conn);
end_class
end_class
class DataMgr
member
public: static void addAttachment(string attach_dir, string msgId, list attachment, integer size, list props);
member
public: static list getAttachmentInfos(string attach_dir, string msgId);
member
public: static void updateAttachmentInfos(string attach_dir, string msgId, list attach_info);
member
public: list start_backup_job(string target, string user, string op, string from, string to, list targets, string wwwroot, string restoreFile);
member
public: void erace_backup_jobs();
member
public: list refresh_backup_jobs();
member
public: static list jobs;
member
public: static string pool_name;
member
public: static void start();
member
public: void start(list job);
member
public: list startDbConnectionPool();
member
public: void endDbConnectionPool();
member
public: string toTimeStamp(string value);
member
public: void backup();
member
public: void delete();
member
public: list get_dir_name(string filename);
member
public: void restore();
member
public: string op;
member
public: string from;
member
public: string to;
member
public: string from_timestamp;
member
public: string to_timestamp;
member
public: list targets;
member
public: string wwwroot;
member
public: string restoreFile;
member
public: list my_props;
member
public: string send_dir;
member
public: string recv_dir;
member
public: string attach_dir;
member
public: string tmp_dir;
member
public: DbConnection conn;
member
public: static list getProperty(string name);
member
public: static void putProperty(string name, list obj);
member
public: static void removeProperty(string name);
member
public: static list static_props;
class RNDataMgr
member
public: static void addAttachment(string msgId, string filename, string mime_type, string content_id, string description);
member
public: static list getAttachmentInfos(string msgId);
member
public: static string getAttachDir();
end_class
end_class
class InitWebServiceDB
member
public: static void init_all();
member
public: void init();
member
public: void init_system();
member
public: void init_system_user();
member
public: void init_system_webuidata();
member
public: void init_rosetta();
member
public: void init_rosetta_user();
member
public: void init_rosetta_webuidata();
member
public: void init_rosetta_my_and_partner_info_default();
member
public: void init_rosetta_pip_default();
member
public: void init_rosetta_transport_process();
member
public: void init_rosetta_sample();
member
public: void init_rosetta_sample_user();
member
public: void init_rosetta_sample_my_info();
member
public: void init_rosetta_sample_partner_info();
member
public: void init_rosetta_sample_application_process();
member
public: void init_rosetta_sample_buyer_webuidata();
member
public: void init_rosetta_sample_supplier_webuidata();
member
public: void init_rosetta_sample_catalog();
member
public: DbConnection conn;
member
public: static void upate();
member
public: void _update();
end_class
class InitBizsoftDB
member
public: static void init_all();
member
public: void init();
member
public: void init_bizsoft();
member
public: void init_bizsoft_user();
member
public: void init_bizsoft_webuidata();
member
public: void init_customer();
member
public: void init_customer_user();
member
public: void init_customer_webuidata();
member
public: void init_sales();
member
public: void init_sales_user();
member
public: void init_sales_webuidata();
member
public: void init_sales_products();
member
public: void init_finance();
member
public: void init_finance_user();
member
public: void init_finance_webuidata();
member
public: void init_finance_acount_headings();
member
public: void init_finance_tax_rate();
member
public: void init_finance_sample_check_data();
member
public: void init_finance_sample_stock_data();
member
public: DbConnection conn;
member
public: static void update();
member
public: void _update();
end_class
class Test_HttpClientConnection
member
public: static void test_parseURL();
member
public: static void test_client_doGet1();
member
public: static void test_client_doGet2();
member
public: static void test_client_doGet3();
member
public: static void test_client_doGet4();
member
public: static void test_client_doPost1();
member
public: static void test_client_ssl_doPost1();
member
public: static void test_client_doPost2();
member
public: static void test_client_doPost3();
member
public: static void test_client_doPost_tmp();
member
public: static void test_client_ssl_doGet();
member
public: static void test_client_proxy_doGet();
member
public: static void test_client_proxy_ssl_doGet();
member
public: static void test_client_doGet_dump();
member
public: static void test_client_doPost_dump();
member
public: static void test_client_doGet2_dump();
member
public: static void test_timeout();
member
public: static void test_download();
class Sample_URL_Iterator
member
public: string Next();
member
public: string url;
member
public: string filename;
member
public: list phase;
end_class
end_class
class Test_XmlUtility
member
public: static void test_load_dtd_1();
member
public: static void test_load_dtd_2();
member
public: static void test_load_dtd_all();
member
public: static void test_load_dtd_all_sub(string filename);
member
public: static void test_dtd_itr0();
member
public: static void test_dtd_itr1();
member
public: static void test_dtd_itr2();
member
public: static void test_dtd_itr3();
member
public: static void test_dtd_itr10();
member
public: static void test_dtd_itr_all_tag();
member
public: static void test_attach_content_validation_data();
member
public: static void test_xml_itr_1();
member
public: static void test_xml_itr_2();
member
public: static void test_validate();
member
public: static void test_validate_all();
member
public: static void test_validate_all_sub(string filename);
member
public: static void prof_validate();
member
public: static void prof_validate_all();
member
public: static void test_xml_to_csv();
member
public: static void test_csv_to_csv();
member
public: static void test_xml_to_db();
member
public: static void test_db_to_xml();
member
public: static void perform_save_load_20();
member
public: static void prof_save_load();
member
public: static void prof_xml_to_db();
member
public: static void prof_db_to_xml();
member
public: static void test_db_save_load_all();
member
public: static void test_db_save_load_all_sub(string dtd_base, string filename, file out);
member
public: static void test_file_save_load_all();
member
public: static void test_file_save_load_all_sub(string dtd_base, string filename, file out);
member
public: static void test_db_access_get();
member
public: static void test_acc_input_range_orderby_xmls();
member
public: static void test_acc_select_range_orderby_xmls();
member
public: static void test_obj_select_range_orderby_xmls();
member
public: static void clear_dtd_cache();
member
public: static void type_check1();
member
public: static void type_check2();
member
public: static void type_check3();
member
public: static void type_check4();
member
public: static void type_check5();
member
public: static void type_check6();
member
public: static void dic_check();
end_class
class Test_ProcessEngine
member
public: static void test1();
member
public: static void test2();
member
public: static void test3();
member
public: static void test_large_loop();
end_class
class Test_MultipartSecureMessage
member
public: static void init();
member
public: static string tmp_dir;
member
public: static void dump_header(list header);
member
public: static void test_multipart();
member
public: static void test_multipart_base64();
member
public: static void test_encrypt_and_decrypt();
member
public: static void test_sign_and_verify();
member
public: static void test_nest_multipart();
member
public: static void test_nest_multipart2();
member
public: static void test_read_multipart_file();
end_class
class Test_Csv
member
public: static void test_load_csv();
member
public: static void test_load_csv_sub(list csv_data);
member
public: static void test_load_po_request_csv();
end_class
class Test_Misc
member
public: static void set_output();
member
public: static void unset_output();
member
public: static void set_trace();
member
public: static void unset_trace();
member
public: static void set_prof();
member
public: static void unset_prof();
member
public: static void dump_db_object(XmlDbObject obj);
member
public: static void test_get_rn_props();
member
public: static void test_get_pip_props_from_msg_code();
member
public: static void test_get_pip_props_from_msg_type();
member
public: static void test_gen_msg_id();
member
public: static void test_gen_datetime();
member
public: static void test_gen_doc_id();
member
public: static void test_read_binary_file();
member
public: static void clear_backup_jobs();
member
public: static void test_char();
member
public: static void make_writable();
end_class
class Test_Rosetta
member
public: static void perform_test_pru_1();
member
public: static void perform_test_pru_100();
member
public: static void perform_test_pru_500();
member
public: static void perform_test_pru_1000();
member
public: string create_2A1ProductResourceUpdate(integer count);
member
public: static void long_run_test_pin();
member
public: string create_2A1ProductInfoNotify();
member
public: void send_2A1ProductInfoNotify();
member
public: list processing;
member
public: integer timer_id;
member
public: integer period;
member
public: integer count;
member
public: integer count_max;
member
public: static void retry_over();
member
public: static void retry_ok();
member
public: static void ack_retry_over();
member
public: static void ack_retry_ok();
member
public: void change_to_correct_url();
member
public: void change_url(string partner_id, string partner_role, string url);
member
public: void change_error_retry_time(string partner_id, string partner_role, string time);
member
public: void change_receipt_wait_time(string partner_id, string partner_role, string time);
member
public: static void test_send_with_attach();
member
public: static void test_send_with_attach_10();
member
public: static void test_get_attach_info();
end_class
class Test_FileUtility
member
public: static void test_listup();
member
public: static void test_rev_listup();
end_class
class Test_ProxyServer
member
public: static void test_start_proxy_server();
member
public: static void test_stop_proxy_server();
member
public: static ProxyServer proxy_server;
end_class
class Test_InetClient
member
public: static void test_smtp();
member
public: static void test_pop();
end_class
class Test_SoapEbxml
member
public: static void test_sample_envelope_validate();
member
public: static void test_sample_envelope_save_load();
end_class
end_class
$END_MEMBER
TEXT
AlObject
class AltairServer
member
public: static void start();
body
{
	if (appServer) {
		al_print("[Error] Server already started.\n");
		return;
	} else {
	}
	appServer = new AltairServer;
	var string err;
	if (err = appServer.startServer()) {
		al_print("[Error] fail to start server.(" + err + ")\n");
		appServer.shutdownServer();
		appServer = null;
	} else {
	}
}
end_body
member
public: static void shutdown();
body
{
	if (appServer == null) {
		al_print("[Error] Server not started.\n");
		return;
	} else {
	}
	appServer.shutdownServer();
	appServer = null;
	al_gc(null);
	al_gp("vtbl", null, null, null, null);
}
end_body
member
public: static void restart();
body
{
	shutdown();
	start();
}
end_body
member
public: static void start_trace();
body
{
	var list prof, cls;
	cls = al_cons(null, null);
	al_create_arc(cls, "DbManager", null);
	al_create_arc(cls, "DbConnection", null);
	al_create_arc(cls, "DbPoolConnection", null);
	al_create_arc(cls, "DbConnectionPool", null);
	al_create_arc(cls, "ProcMgr", null);
	al_create_arc(cls, "ProcSched", null);
	al_create_arc(cls, "ServiceHandler", null);
	al_create_arc(cls, "RNIF20ServiceHandler", null);
	if (al_misc("platform", null, null) == "windows") {
		prof = al_list2(2, "C:/altair/sample/server/log/log.txt");
	} else {
	}
	if (al_misc("platform", null, null) == "linux" || al_misc("platform", null, null) == "mac") {
		prof = al_list2(2, "/proj/altair/data/server/log/log.txt");
	} else {
	}
	al_prof("set", "prof", cls);
	al_prof("start", "prof", prof);
}
end_body
member
public: static void stop_trace();
body
{
	al_prof("stop", "prof", null);
	al_prof("clear", "prof", null);
}
end_body
member
public: static void remote_shutdown();
body
{
	shutdown();
	al_misc("exit", 0, null);
}
end_body
member
public: static void remote_restart();
body
{
	restart();
}
end_body
member
public: static AltairServer appServer;
member
public: list startServer();
body
{
	var string err;
	var XmlDataRetriver root, itr, web_server_info, itr2, ssl_info, servlet_info;
	var XmlDataRetriver proxy_server_info, itr3, servlet_param_info, client_info;
	var XmlDataRetriver db_pool_info, pe_info, xml_info;
	// ---- load configuration
	if (err = load_config()) {
		return err;
	} else {
	}
	root = new XmlDataRetriver;
	root.create(config);
	// ---- initialize log file
	logObj = new LogObj;
	logObj.init();
	var integer size;
	size = (integer)root.getValue("AltairServer/MaxLogSize") * 1024;
	if (al_is_type(size, "integer") == null || size < 1) {
		size = 1000;
	} else {
	}
	LogObj::max_size = size;
	system_log_filepath = root.getValue("AltairServer/SystemLog");
	system_log_db = (root.getValue("AltairServer/SystemLogDb") == "true");
	// ---- GC
	gc_interval = (integer)root.getValue("AltairServer/GcInterval");
	_gc_time = 0;
	// ---- create DB connection pool
	var list startup_started_log;
	itr = root.getItr("AltairServer/DbConnectionPool");
	loop {
		if (db_pool_info = itr.getNext()) {
		} else {
			break;
		}
		var DbConnectionPool pool;
		pool = new DbConnectionPool;
		pool.ap_server = this;
		pool.pool_name = db_pool_info.getValue("@name");
		if (pool_name) {
		} else {
			pool_name = pool.pool_name;
			WebUIServlet::pool_name = pool.pool_name;
			TransportServlet::pool_name = pool.pool_name;
			ProcessEngine::pool_name = pool.pool_name;
		}
		pool.sql_trace_log_filepath = db_pool_info.getValue("SqlTraceLog");
		pool.db_type = db_pool_info.getValue("DbType");
		pool.host = db_pool_info.getValue("Host");
		pool.port = (integer)db_pool_info.getValue("Port");
		pool.db_name = db_pool_info.getValue("DbName");
		pool.user = db_pool_info.getValue("DbUser");
		pool.pass = db_pool_info.getValue("DbPassword");
		pool.initial_connections = (integer)db_pool_info.getValue("InitialCapacity");
		pool.max_connections = (integer)db_pool_info.getValue("MaxCapacity");
		err = DbManager::createPool(pool, pool.pool_name);
		if (err) {
			system_log("error", "DB Connection Pool Creation falied: pool_name = " + (string)pool.pool_name + ": " + err);
			return err;
		} else {
		}
		if (startup_started_log) {
		} else {
			startup_started_log = 1;
			system_log("info", ">>>>>>>>> system startup started.");
		}
		system_log("info", "DB Connection pool created: pool_name = " + (string)pool.pool_name);
	}
	// ---- initialize XmlUtility
	XmlUtility::Initialize();
	itr = root.getItr("AltairServer/XmlUtility");
	loop {
		if (xml_info = itr.getNext()) {
		} else {
			break;
		}
		XmlUtility::dtd_base = xml_info.getValue("DtdBase");
		XmlUtility::xsl_base = xml_info.getValue("XslBase");
		XmlDbObject::MAX_VALUE_SIZE = (integer)xml_info.getValue("DbObjectMaxValueLength");
		XmlUtility::content_validation_base = xml_info.getValue("ContentValidationBase");
	}
	// ---- start proxy servers
	proxy_servers = al_cons(null, null);
	itr = root.getItr("AltairServer/ProxyServer");
	loop {
		if (proxy_server_info = itr.getNext()) {
		} else {
			break;
		}
		var ProxyServer proxy_server;
		proxy_server = new ProxyServer;
		proxy_server.ap_server = this;
		proxy_server.name = proxy_server_info.getValue("@name");
		proxy_server.port = (integer)proxy_server_info.getValue("Port");
		proxy_server.proxy_log_filepath = proxy_server_info.getValue("ProxyLog");
		proxy_server.proxy_log_db = (proxy_server_info.getValue("ProxyLogDb") == "true");
		proxy_server.connectionTimeout = (integer)proxy_server_info.getValue("ConnectionTimeout");
		if (proxy_server_info.getValue("ConnectTimeout")) {
			proxy_server.connect_timeout = (integer)proxy_server_info.getValue("ConnectTimeout");
		} else {
		}
		al_create_arc(proxy_servers, proxy_server, null);
		if (err = proxy_server.start()) {
			system_log("error", "Proxy Server Startup failed: " + err);
			return err;
		} else {
		}
		system_log("info", "Proxy Server started: port = " + (string)proxy_server.port);
	}
	// ---- start process engine
	itr = root.getItr("AltairServer/ProcessEngine");
	loop {
		if (pe_info = itr.getNext()) {
		} else {
			break;
		}
		pe = new ProcessEngine;
		pe.ap_server = this;
		pe.process_log_filepath = pe_info.getValue("ProcessLog");
		pe.process_log_db = (pe_info.getValue("ProcessLogDb") == "true");
		pe.ticker_interval = (integer)pe_info.getValue("TickerInterval");
		pe.cleanup_time = pe_info.getValue("CleanupTime");
		if (al_is_type(pe.ticker_interval, "integer") == null || pe.ticker_interval < 1000) {
			pe.ticker_interval = 1000;
		} else {
		}
		pe.max_property_cache = (integer)pe_info.getValue("MaxPropertyCache");
		pe.debug_mode = (pe_info.getValue("DebugMode") == "true");
		pe.exception_detail = (pe_info.getValue("ExceptionDetail") == "true");
		err = pe.start();
		if (err) {
			system_log("error", "fail to start ProcessEngine: " + err);
			return err;
		} else {
		}
		system_log("info", "ProcessEngine started.");
	}
	// ---- Http Client
	itr = root.getItr("AltairServer/HttpClient");
	loop {
		if (client_info = itr.getNext()) {
		} else {
			break;
		}
		if (client_info.getValue("ConnectTimeout")) {
			HttpClientConnection::connect_timeout = (integer)client_info.getValue("ConnectTimeout");
		} else {
		}
	}
	// ---- start web servers
	web_servers = al_cons(null, null);
	itr = root.getItr("AltairServer/WebServer");
	loop {
		if (web_server_info = itr.getNext()) {
		} else {
			break;
		}
		var WebServer web_server;
		web_server = new WebServer;
		web_server.ap_server = this;
		web_server.name = web_server_info.getValue("@name");
		web_server.port = (integer)web_server_info.getValue("Port");
		web_server.documentRoot = web_server_info.getValue("DocumentRoot");
		web_server.access_log_filepath = web_server_info.getValue("AccessLog");
		web_server.access_log_db = (web_server_info.getValue("AccessLogDb") == "true");
		itr2 = web_server_info.getItr("SSL");
		if (ssl_info = itr2.getNext()) {
			web_server.ssl = 1;
			web_server.ca_cert = ssl_info.getValue("caCert");
			web_server.cert = ssl_info.getValue("serverCert");
			web_server.key = ssl_info.getValue("serverKey");
			web_server.clientAuth = (ssl_info.getValue("clientAuth") == "true" ? 1 : 0);
			web_server.dhparam = ssl_info.getValue("dhParam");
			web_server.cipher = ssl_info.getValue("cipher");
		} else {
		}
		web_server.connectionTimeout = (integer)web_server_info.getValue("ConnectionTimeout");
		web_server.sessionTimeout = (integer)web_server_info.getValue("SessionTimeout");
		web_server.maxMsgSize = (integer)web_server_info.getValue("MaxMessageSize");
		web_server.servlet_list = al_cons(null, null);
		itr2 = web_server_info.getItr("Servlet");
		web_server.servlet_param_list = al_cons(null, null);
		loop {
			if (servlet_info = itr2.getNext()) {
			} else {
				break;
			}
			var string path, class_name;
			path = servlet_info.getValue("Path");
			class_name = servlet_info.getValue("Class");
			al_create_arc(web_server.servlet_list, class_name, path);
			var list nvls;
			al_create_arc(web_server.servlet_param_list, nvls = al_cons(null, null), class_name);
			itr3 = servlet_info.getItr("Param");
			loop {
				if (servlet_param_info = itr3.getNext()) {
				} else {
					break;
				}
				var string name, value;
				name = servlet_param_info.getValue("Name");
				value = servlet_param_info.getValue("Value");
				if (name && value) {
					al_set_dst_node(nvls, name, value);
				} else {
				}
			}
		}
		web_server.upload_servlet_list = al_cons(null, null);
		itr2 = web_server_info.getItr("UploadServlet");
		loop {
			if (servlet_info = itr2.getNext()) {
			} else {
				break;
			}
			var string path, class_name;
			path = servlet_info.getValue("Path");
			class_name = servlet_info.getValue("Class");
			al_create_arc(web_server.upload_servlet_list, class_name, path);
		}
		al_create_arc(web_servers, web_server, null);
		if (err = web_server.start()) {
			system_log("error", "Web Server Startup failed: " + err);
			return err;
		} else {
		}
		system_log("info", "WebServer started: port = " + (string)web_server.port + ", SSL = " + (string)(web_server.ssl ? "true" : "false"));
	}
	// ---- start poller (assume ProcessEngine::pool initialized)
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var RNContext ctx;
		var list my_props;
		var string host, userid, password;
		var integer interval;
		var Poller poller;
		ctx = new RNContext;
		my_props = ctx.getMyProperties("-- default setting --", conn);
		host = al_dst_node(my_props, "proxy.poll.url");
		interval = (integer)al_dst_node(my_props, "proxy.poll.interval");
		if (host && host != "" && interval > 0) {
			poller = new RNIF20ProxyPoller;
			poller.host = host;
			poller.interval = interval;
			poller._time = 0;
			poller.ap_server = this;
			Poller::addPoller(poller);
			system_log("info", "Proxy Poller started.");
		} else {
		}
		host = al_dst_node(my_props, "pop.server");
		interval = (integer)al_dst_node(my_props, "pop.poll.interval");
		userid = al_dst_node(my_props, "pop.userid");
		password = al_dst_node(my_props, "pop.password");
		if (host && host != "" && interval > 0) {
			poller = new RNIF20PopPoller;
			poller.host = host;
			poller.interval = interval;
			poller._time = 0;
			poller.userid = userid;
			poller.password = password;
			poller.ap_server = this;
			Poller::addPoller(poller);
			system_log("info", "Pop Poller started.");
		} else {
		}
		conn.close();
	} catch (AlException e) {
		try {
			if (conn) {
				conn.close();
			} else {
			}
		} catch (AlException e) {
		}
	}
	// ---- start timer
	var list cb;
	timer_id = al_get_id();
	cb = al_list3(al_root_class(), this, AltairServer::timeoutCheck);
	al_gui_misc("timer", al_list2(timer_id, 1000), cb);
	// ---- write startup log
	system_log("info", "<<<<<<<<< system startup completed.");
	return null;
}
end_body
member
public: void shutdownServer();
body
{
	system_log("info", ">>>>>>>>> shutdown system immediately.");
	if (timer_id) {
		al_gui_misc("timer", al_list2(timer_id, 1000), null);
		al_release_id(timer_id);
		timer_id = null;
	} else {
	}
	Poller::closeAllPollers();
	var list itr;
	var WebServer web_server;
	var ProxyServer proxy_server;
	itr = al_dst_itr(web_servers);
	loop {
		if (web_server = al_next(itr)) {
		} else {
			break;
		}
		web_server.stop();
		web_server.ap_server = null;
	}
	web_servers = null;
	itr = al_dst_itr(proxy_servers);
	loop {
		if (proxy_server = al_next(itr)) {
		} else {
			break;
		}
		proxy_server.stop();
		proxy_server.ap_server = null;
	}
	proxy_servers = null;
	var HttpClientConnection conn;
	if (HttpClientConnection::connections) {
		itr = al_dst_itr(HttpClientConnection::connections);
		loop {
			if (conn = al_next(itr)) {
			} else {
				break;
			}
			al_prev(itr);
			conn.close();
		}
	} else {
	}
	if (pe) {
		pe.stop();
		pe = null;
	} else {
	}
	DbManager::closeAllPools();
	XmlUtility::dtd_cache = null;
	if (logObj) {
		logObj.finalize();
		logObj = null;
	} else {
	}
}
end_body
member
public: list load_config();
body
{
	var file f;
	if (f = al_file_open("config.xml", "r")) {
	} else {
		return "config.xml nof found.";
	}
	var list tree_err;
	tree_err = al_xml("parse", f, null, null);
	if (tree_err.tail.head) {
		return "fail to parse config.xml.";
	} else {
	}
	config = tree_err.head;
	return null;
}
end_body
member
public: list config;
member
public: list web_servers;
member
public: list proxy_servers;
member
public: string pool_name;
member
public: ProcessEngine pe;
member
public: void log(string filepath, string str);
body
{
	if (logObj) {
		logObj.log(filepath, str);
	} else {
	}
}
end_body
member
public: void system_log(string level, string str);
body
{
	if (system_log_filepath) {
		log(system_log_filepath, level + ": " + str);
	} else {
	}
	if (system_log_db) {
		var DbConnection conn;
		var string db_type;
		try {
			conn = DbManager::getConnection(pool_name);
			db_type = DbManager::getDbType(pool_name);
			var string sql, time;
			time = al_misc("get_time", null, null);
			time = al_misc("get_localtime", time, null);
			time = al_misc("format_time", time, "yyyy'/'MM'/'dd'-'HH':'mm':'ss");
			sql = al_copy("insert into SystemLog (SystemLogId, Time, LogLevel, Message) values ('");
			al_append_str(sql, conn.getNextSeq("SystemLogId_seq"));
			al_append_str(sql, "','");
			al_append_str(sql, time);
			al_append_str(sql, "','");
			al_append_str(sql, (string)level);
			al_append_str(sql, "','");
			al_append_str(sql, DbUtility::convChar((string)str));
			al_append_str(sql, "')");
			conn.executeUpdate(sql);
			conn.commit();
			conn.close();
		} catch (AlException e) {
			if (conn) {
				try {
					conn.rollback();
				} catch (AlException e) {
				}
				try {
					conn.close();
				} catch (AlException e) {
				}
			} else {
			}
		}
	} else {
	}
}
end_body
member
public: string system_log_filepath;
member
public: string system_log_db;
member
public: LogObj logObj;
member
public: static integer getTime(string time);
body
{
	var integer val, ch;
	val = (integer)time;
	if (al_is_type(time, "string") && al_strlen(time) > 1) {
		ch = al_get_char(time, al_strlen(time) - 1);
	} else {
	}
	if (ch == 's' || ch == 'S') {
		val = val;
	} else {
	}
	if (ch == 'm' || ch == 'M') {
		val = val * 60;
	} else {
	}
	if (ch == 'h' || ch == 'H') {
		val = val * 60 * 60;
	} else {
	}
	if (ch == 'd' || ch == 'D') {
		val = val * 24 * 60 * 60;
	} else {
	}
	return val;
}
end_body
member
public: void timeoutCheck();
body
{
	var list itr;
	// ---- HttpServerConnection
	var WebServer web_server;
	itr = al_dst_itr(web_servers);
	loop {
		if (web_server = al_next(itr)) {
		} else {
			break;
		}
		web_server.timeoutCheck();
	}
	// ---- HttpClientConnection
	var HttpClientConnection conn;
	if (HttpClientConnection::connections) {
		itr = al_dst_itr(HttpClientConnection::connections);
		loop {
			if (conn = al_next(itr)) {
			} else {
				break;
			}
			conn._time = conn._time + 1;
			if (conn._time >= conn.timeout) {
				al_prev(itr);
				conn.error = "timeout";
				conn.wait_obj.notify();
				conn.close();
			} else {
			}
		}
	} else {
	}
	// ---- ProxyServerConnection
	var ProxyServer proxy_server;
	itr = al_dst_itr(proxy_servers);
	loop {
		if (proxy_server = al_next(itr)) {
		} else {
			break;
		}
		proxy_server.timeoutCheck();
	}
	// ---- SmtpClient, PopClient
	InetClient::timeoutCheck();
	// ---- check Poller interval
	Poller::timeoutCheck();
	// ---- garbage collection
	_gc_time = _gc_time + 1;
	if (_gc_time >= gc_interval) {
		var list ls;
		var integer used, recycled, free;
		ls = al_gc(null);
		recycled = ls.head;
		free = ls.tail.head;
		used = ls.tail.tail.head;
		system_log("info", "garbage collection: recycled = " + (string)recycled + ", used = " + (string)used + ", total = " + (string)(recycled + free + used));
		_gc_time = 0;
	} else {
	}
}
end_body
member
public: integer timer_id;
member
public: integer gc_interval;
member
public: integer _gc_time;
member
public: void printStackTrace();
body
{
	try {
		var AlException ex;
		ex = new AlException;
		ex.msg = "stack dump";
		throw ex;
	} catch (AlException e) {
		var list frame, loc_base, loc_base2;
		var integer pos;
		frame = e.stack_frame;
		pos = e.pos;
		loop {
			pos = frame.head.tail.head;
			loc_base = frame.head.tail.tail.tail.head;
			frame = frame.tail;
			if (frame) {
			} else {
				break;
			}
			al_print("===========================\n");
			al_misc("stack_trace", frame, null);
			al_misc("error_source", al_list2(frame, pos), null);
			loop {
				if (loc_base) {
				} else {
					break;
				}
				loc_base2 = loc_base.head;
				loop {
					if (loc_base2) {
					} else {
						break;
					}
					al_print(loc_base2.head.head);
					al_print(" = ");
					al_print(loc_base2.head.tail.head);
					al_print("\n");
					loc_base2 = loc_base2.tail;
				}
				loc_base = loc_base.tail;
			}
		}
	}
}
end_body
member
public: void connection_debug();
body
{
	// ---- dump connection create/close and send/receive
	// debug = 1;
	// ---- dump request/response header to proxy
	// debug2 = 1;
	// ---- dump send proxy message to server/browser
	// debug3 = 1;
	// ---- connection debug log filepath
	// debug_log_file = "./debug.log";
}
end_body
member
public: void xml_debug();
body
{
	// debug = 1;
	// debug2 = 1;
}
end_body
member
public: list debug;
member
public: list debug2;
member
public: list debug3;
member
public: string debug_log_file;
member
public: static void dump_graph(string msg, integer i, list n);
body
{
	al_print(msg + ": node = " + (string)n + "\n");
	dump_graph(0, i, n);
}
end_body
member
public: static void dump_graph(integer indent, integer i, list n);
body
{
	if (i <= 0) {
		return;
	} else {
	}
	var list itr, n2, a2;
	itr = al_dst_itr(n);
	loop {
		if (n2 = al_next(itr)) {
		} else {
			break;
		}
		a2 = al_arc_a(itr);
		var integer k;
		k = 0;
		loop {
			if (k < indent) {
			} else {
				break;
			}
			al_print("    ");
			k = k + 1;
		}
		al_print("-/" + (string)a2 + "/->" + (string)n2 + "\n");
		dump_graph(indent + 1, i - 1, n2);
	}
}
end_body
class LogObj
member
public: void init();
body
{
	log_files = al_cons(null, null);
}
end_body
member
public: void finalize();
body
{
	log_files = null;
}
end_body
member
public: void log(string filepath, string str);
body
{
	if (filepath) {
	} else {
		return;
	}
	var file f;
	if (f = al_dst_node(log_files, filepath)) {
	} else {
		if (f = al_file_open(filepath, "a")) {
		} else {
			al_print("can't create logfile: filepath = " + filepath + "\n");
			al_print("message = \"" + str + "\"\n");
			return;
		}
		al_create_arc(log_files, f, filepath);
	}
	var list date;
	var list date_str;
	date = al_file_manip("current_datetime", null, null);
	date_str = al_misc("format_time", date, "yyyy'/'MM'/'dd' 'HH':'mm':'ss");
	al_file_write(f, "string", date_str + " " + str + "\n");
	al_file_manip("flush", f, null);
	if (al_file_manip("get_size", filepath, null) > max_size) {
		f = null;
		al_set_dst_node(log_files, filepath, null);
		var string filepath2;
		filepath2 = filepath + "." + Context::genTimeStamp();
		al_file_manip("rename", filepath, filepath2);
	} else {
	}
}
end_body
member
public: list log_files;
member
public: static integer max_size;
end_class
class WaitObj
member
public: void wait();
body
{
	if (notified) {
	} else {
		wait_obj = al_wait(null);
		al_wait(wait_obj);
	}
}
end_body
member
public: void notify();
body
{
	if (notified) {
	} else {
		notified = 1;
		if (wait_obj) {
			al_notify(wait_obj);
		} else {
		}
	}
}
end_body
member
public: list notified;
member
public: list wait_obj;
member
public: list value;
member
public: list value2;
end_class
class WebServer
member
public: AltairServer ap_server;
member
public: string name;
member
public: integer port;
member
public: string documentRoot;
member
public: list content_types;
member
public: list servlet_list;
member
public: list upload_servlet_list;
member
public: list servlet_param_list;
member
public: list start();
body
{
	content_types = al_cons(null, null);
	al_create_arc(content_types, "text/html", ".html");
	al_create_arc(content_types, "text/html", ".htm");
	al_create_arc(content_types, "text/plain", ".txt");
	al_create_arc(content_types, "image/jpeg", ".jpeg");
	al_create_arc(content_types, "image/jpeg", ".jpg");
	al_create_arc(content_types, "image/gif", ".gif");
	al_create_arc(content_types, "application/zip", ".zip");
	al_create_arc(content_types, "x-gzip", ".gz");
	var string err;
	conn_mgr = new HttpServerConnectionMgr;
	conn_mgr.create(this);
	if (err = conn_mgr.start()) {
		return err;
	} else {
	}
}
end_body
member
public: void stop();
body
{
	if (conn_mgr) {
		conn_mgr.close();
		conn_mgr = null;
	} else {
	}
	ap_server = null;
}
end_body
member
public: HttpServerConnectionMgr conn_mgr;
member
public: integer connectionTimeout;
member
public: string GetAbsPath(string path);
body
{
	var integer idx;
	idx = al_search_str(path, 0, "..");
	if (idx >= 0) {
		return null;
	} else {
	}
	var string abs_path;
	abs_path = documentRoot + path;
	if (al_file_manip("does_exist", abs_path, null)) {
		if (al_file_manip("is_dir", abs_path, null)) {
			abs_path = abs_path + "/index.html";
			if (al_file_manip("does_exist", abs_path, null)) {
				return abs_path;
			} else {
			}
		} else {
			return abs_path;
		}
	} else {
		return null;
	}
}
end_body
member
public: list sessions;
member
public: integer sessionTimeout;
member
public: integer maxMsgSize;
member
public: void access_log(string fromIP, string path, string code, string size);
body
{
	if (ap_server) {
		if (access_log_filepath) {
			var string s;
			s = fromIP + " \"" + path + "\" " + code + " " + size;
			ap_server.log(access_log_filepath, s);
		} else {
		}
		if (al_search_str(path, 0, "cmd.exe") >= 0 || al_search_str(path, 0, "root.exe") >= 0 || al_search_str(path, 0, "default.ida") >= 0) {
			// not write access log of IIS virus
			// skip if path includes 'cmd.exe', 'root.exe' or 'default.ida'
			return;
		} else {
		}
		if (null && al_search_str(path, 0, "/admin/ebiz?") >= 0 && al_search_str(path, 0, "/admin/ebiz?action=Login") < 0) {
			// not write access log of admin ui operation
			// skip if URI includes '/admin/ebiz?' and is not '/admin/ebiz?action=Login'
			return;
		} else {
		}
		if (access_log_db) {
			var DbConnection conn;
			var string db_type;
			try {
				conn = DbManager::getConnection(WebUIServlet::pool_name);
				db_type = DbManager::getDbType(WebUIServlet::pool_name);
				var string sql, time;
				time = al_misc("get_time", null, null);
				time = al_misc("get_localtime", time, null);
				time = al_misc("format_time", time, "yyyy'/'MM'/'dd'-'HH':'mm':'ss");
				sql = al_copy("insert into AccessLog (AccessLogId, Time, FromIP, Path, ResponseCode, ResponseSize) values ('");
				al_append_str(sql, conn.getNextSeq("AccessLogId_seq"));
				al_append_str(sql, "','");
				al_append_str(sql, time);
				al_append_str(sql, "','");
				al_append_str(sql, (string)fromIP);
				al_append_str(sql, "','");
				al_append_str(sql, DbUtility::convChar((string)path));
				al_append_str(sql, "','");
				al_append_str(sql, (string)code);
				al_append_str(sql, "','");
				al_append_str(sql, (string)size);
				al_append_str(sql, "')");
				conn.executeUpdate(sql);
				conn.commit();
				conn.close();
			} catch (AlException e) {
				if (conn) {
					try {
						conn.rollback();
					} catch (AlException e) {
					}
					try {
						conn.close();
					} catch (AlException e) {
					}
				} else {
				}
			}
		} else {
		}
	} else {
	}
}
end_body
member
public: string access_log_filepath;
member
public: string access_log_db;
member
public: void error_log(string str);
body
{
	ap_server.system_log("error", "WebServer: " + str);
}
end_body
member
public: void timeoutCheck();
body
{
	var list itr;
	if (sessions) {
		var HttpSession session;
		itr = al_dst_itr(sessions);
		loop {
			if (session = al_next(itr)) {
			} else {
				break;
			}
			session._time = session._time + 1;
			if (session._time >= sessionTimeout) {
				al_remove(itr);
			} else {
			}
		}
	} else {
	}
	if (conn_mgr && conn_mgr.connections) {
		var HttpServerConnection conn;
		itr = al_dst_itr(conn_mgr.connections);
		loop {
			if (conn = al_next(itr)) {
			} else {
				break;
			}
			conn._time = conn._time + 1;
			if (conn._time >= connectionTimeout) {
				al_prev(itr);
				conn.close();
			} else {
			}
		}
	} else {
	}
}
end_body
member
public: list ssl;
member
public: string ca_cert;
member
public: string cert;
member
public: string key;
member
public: integer clientAuth;
member
public: string dhparam;
member
public: string cipher;
class HttpServerConnectionMgr
member
public: void create(WebServer server);
body
{
	this.server = server;
	connections = al_cons(null, null);
}
end_body
member
public: void close();
body
{
	if (server_socket_id) {
		al_socket("close", server_socket_id, null, null);
		server_socket_id = null;
	} else {
	}
	if (hwnd && msg) {
		al_wnd_message(null, "msg_callback", msg, null);
		al_wnd_message(null, "unregister_msg", msg, null);
		hwnd = msg = null;
	} else {
	}
	var list itr;
	var HttpServerConnection conn;
	loop {
		itr = al_dst_itr(connections);
		if (conn = al_next(itr)) {
		} else {
			break;
		}
		conn.close();
	}
	server = null;
}
end_body
member
public: WebServer server;
member
public: list connections;
member
public: list start();
body
{
	var string err;
	if (server.ssl == null) {
		if (server_socket_id = al_socket("socket", null, null, null)) {
		} else {
			return "fail to create server socket.";
		}
	} else {
		var list files;
		files = al_list5(server.cert, server.key, server.ca_cert, server.clientAuth, server.dhparam);
		if (server_socket_id = al_socket("socket", "SSL", files, server.cipher)) {
		} else {
			return "fail to create SSL server socket.";
		}
	}
	if (al_socket("bind", server_socket_id, al_list2(0, server.port), null)) {
		err = (string)al_socket("get_last_error", server_socket_id, null, null);
		err = "fail to bind socket with port = " + (string)server.port + ". (" + err + ")";
		close();
		return err;
	} else {
	}
	if (al_socket("listen", server_socket_id, null, null)) {
		err = (string)al_socket("get_last_error", server_socket_id, null, null);
		close();
		return "fail to listen socket. (" + err + ")";
	} else {
	}
	var list cb;
	hwnd = al_wnd_message(null, "hwnd", null, null);
	msg = al_wnd_message(null, "register_msg", "ACCEPT" + (string)server_socket_id, null);
	cb = al_list3(al_root_class(), this, HttpServerConnectionMgr::accepted);
	al_wnd_message(null, "msg_callback", msg, cb);
	if (al_socket("accept_que", server_socket_id, al_list2(hwnd, msg), null)) {
		err = (string)al_socket("get_last_error", server_socket_id, null, null);
		close();
		return "fail to start accept_queue. (" + err + ")";
	} else {
	}
	return null;
}
end_body
member
public: integer server_socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: void accepted();
body
{
	var integer socket_id;
	server_socket_id = al_wnd_message(null, "wParam", null, null);
	if (socket_id = al_socket("get_socket", server_socket_id, null, null)) {
	} else {
		server.error_log("fail to get_socket: port = " + (string)server.port);
		return;
	}
	if (socket_id < 0) {
		server.error_log("fail to accept socket: port = " + (string)server.port);
		return;
	} else {
	}
	var HttpServerConnection conn;
	conn = new HttpServerConnection;
	conn.create(server, socket_id);
	conn._time = 0;
	var list ip_addr;
	ip_addr = al_socket("getpeername", socket_id, null, null);
	if (ip_addr) {
		ip_addr = ip_addr.head;
		conn.fromIP = al_socket("address_string", ip_addr, null, null);
	} else {
		conn.fromIP = "";
	}
	conn.cert_info = al_socket("cert_info", socket_id, null, null);
	al_create_arc(connections, conn, socket_id);
	conn.startReceiveCommand();
}
end_body
end_class
class HttpServerConnection
member
public: void create(WebServer server, integer socket_id);
body
{
	connection_debug();
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::create: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpServerConnection::create: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	this.server = server;
	this.socket_id = socket_id;
	hwnd = al_wnd_message(null, "hwnd", null, null);
	msg = al_wnd_message(null, "register_msg", "HttpSvrConn-" + (string)socket_id, null);
	buffer_size = 4096;
}
end_body
member
public: void close();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::close: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpServerConnection::close: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	if (hwnd && msg) {
		al_wnd_message(null, "msg_callback", msg, null);
		al_wnd_message(null, "unregister_msg", msg, null);
		hwnd = msg = null;
	} else {
	}
	var integer id;
	id = socket_id;
	if (socket_id) {
		al_socket("close", socket_id, null, null);
		socket_id = null;
	} else {
	}
	var list connections;
	if (connections = al_src_node(this, id)) {
		al_set_dst_node(connections, id, null);
	} else {
	}
	if (upload_filename) {
		upload = null;
		if (al_file_manip("does_exist", upload_filename, null)) {
			al_file_manip("remove", upload_filename, null);
		} else {
		}
	} else {
	}
	if (res.system_command == "restart") {
		para remote_restart();
	} else {
	}
	if (res.system_command == "shutdown") {
		para remote_shutdown();
	} else {
	}
}
end_body
member
public: WebServer server;
member
public: integer socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer _time;
member
public: void startReceiveCommand();
body
{
	if (msg) {
	} else {
		return;
	}
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::startReceiveCommand: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpServerConnection::startReceiveCommand: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, HttpServerConnection::commandReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buffer = al_misc("binary", buffer_size, null);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 1))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error.(" + err + ")");
		close();
		return;
	} else {
	}
}
end_body
member
public: void startReceiveHeaders();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::startReceiveHeaders: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpServerConnection::startReceiveHeaders: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, HttpServerConnection::headersReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 2))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error.(" + err + ")");
		close();
		return;
	} else {
	}
}
end_body
member
public: void startReceiveBlockSize();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::startReceiveBlockSize: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpServerConnection::startReceiveBlockSize: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, HttpServerConnection::blockSizeReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 1))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error.(" + err + ")");
		close();
		return;
	} else {
	}
}
end_body
member
public: void startReceiveContents();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::startReceiveContents: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpServerConnection::startReceiveContents: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, HttpServerConnection::contentsReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (content_length) {
		if (al_socket("recv", socket_id, buf, al_list4(hwnd, msg, 3, content_length))) {
			err = (string)al_socket("get_last_error", socket_id, null, null);
			// *** server.error_log("recv error.(" + err + ")");
			return;
		} else {
		}
	} else {
		if (content_block_size) {
			if (al_socket("recv", socket_id, buf, al_list4(hwnd, msg, 3, content_block_size))) {
				err = (string)al_socket("get_last_error", socket_id, null, null);
				// *** server.error_log("recv error.(" + err + ")");
				return;
			} else {
			}
		} else {
			if (al_socket("recv", socket_id, buf, al_list2(hwnd, msg))) {
				err = (string)al_socket("get_last_error", socket_id, null, null);
				// *** server.error_log("recv error.(" + err + ")");
				return;
			} else {
			}
		}
	}
}
end_body
member
public: void startReceiveContents2();
body
{
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, HttpServerConnection::contentsReceived2);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list2(hwnd, msg))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error.(" + err + ")");
		return;
	} else {
	}
}
end_body
member
public: void startReceiveCRLF();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::startReceiveCRLF: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpServerConnection::startReceiveCRLF: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, HttpServerConnection::CRLFReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 1))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error.(" + err + ")");
		close();
		return;
	} else {
	}
}
end_body
member
public: void commandReceived();
body
{
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::commandReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! HttpServerConnection::commandReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error. (" + err + ")");
		close();
		return;
	} else {
	}
	command_line = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes - 1), null);
	var string cmd;
	in = al_file_open(command_line, "sr");
	if (cmd = al_file_read(in, "string")) {
	} else {
		// *** server.error_log("request Method not found.");
		close();
		return;
	}
	cmd = al_str_misc("to_upper", cmd, null);
	if (path = al_file_read(in, "string")) {
	} else {
		// *** server.error_log("request URI not found.");
		close();
		return;
	}
	path = al_str_misc("param_to_string", path, null);
	if (http_ver = al_file_read(in, "string")) {
	} else {
		// *** server.error_log("HTTP version not found.");
		close();
		return;
	}
	command = cmd;
	var integer idx;
	idx = al_search_str(path, 0, "?");
	if (idx > 0) {
		params = al_substr(path, idx + 1, al_strlen(path));
		path = al_substr(path, 0, idx);
	} else {
		params = "";
	}
	var integer len;
	len = al_strlen(path);
	if (al_get_char(path, len - 1) == '/') {
		path = al_substr(path, 0, len - 1);
	} else {
	}
	_time = 0;
	startReceiveHeaders();
}
end_body
member
public: void headersReceived();
body
{
	var string err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::headersReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! HttpServerConnection::headersReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error. (" + err + ")");
		close();
		return;
	} else {
	}
	bin_raw_http_header = al_misc("binary", read_bytes, null);
	al_misc("binary_copy", al_list2(bin_raw_http_header, 0), al_list3(buffer, 0, read_bytes));
	if (debug3) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "---- received Http Request Header\n" + (string)al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null));
		} else {
			al_print("---- received Http Request Header\n" + (string)al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null));
		}
	} else {
	}
	if (headers = al_crypt("mime_headers_read", al_list3(buffer, 0, read_bytes), null, null)) {
	} else {
		server.error_log("mime header parse error.");
		close();
		return;
	}
	headers = headers.head;
	refer = al_dst_node_i(headers, "Referer");
	if (content_length = al_dst_node_i(headers, "Content-Length")) {
		content_length = (integer)content_length;
		_time = 0;
		var string content_type, content_type_i;
		if (content_type = al_dst_node_i(headers, "Content-Type")) {
			content_type_i = al_str_misc("to_lower", content_type, null);
			if (content_type_i == "multipart/form-data") {
				boundary = al_dst_node_i(content_type, "boundary");
			} else {
			}
		} else {
		}
		if (boundary && al_dst_node(server.upload_servlet_list, path)) {
			startReceiveContents2();
		} else {
			if (content_length > server.maxMsgSize * 1000) {
				server.error_log("request message too large: Content-Length = " + (string)content_length + ", fromIP = " + (string)fromIP + ", Request = " + (string)command_line);
				send_status = "413_request_entity_too_large";
				if (err = send(http_ver + " 413\n")) {
					// *** server.error_log(err);
					close();
					return;
				} else {
				}
				return;
			} else {
			}
			startReceiveContents();
		}
	} else {
		if (command == "GET") {
			_time = 0;
			para this.process();
		} else {
			_time = 0;
			var string encoding;
			encoding = al_dst_node_i(headers, "Transfer-Encoding");
			if (encoding && al_misc("strcmpi", encoding, "chunked") == 0) {
				chunked = 1;
				startReceiveBlockSize();
			} else {
				startReceiveContents();
			}
		}
	}
}
end_body
member
public: void blockSizeReceived();
body
{
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::blockSizeReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! HttpServerConnection::blockSizeReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error. (" + err + ")");
		close();
		return;
	} else {
	}
	var string hex_str;
	var file f;
	var integer size;
	hex_str = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null);
	f = al_file_open(hex_str, "sr");
	content_block_size = al_file_read(f, "hex");
	if (content_block_size > 0) {
		if (contents) {
			size = al_misc("binary_size", contents, null) + content_block_size;
		} else {
			size = content_block_size;
		}
		if (size > server.maxMsgSize * 1000) {
			server.error_log("request message too large: size >= " + (string)size + ", fromIP = " + (string)fromIP + ", Request = " + (string)command_line);
			send_status = "413_request_entity_too_large";
			if (err = send(http_ver + " 413\n")) {
				// *** server.error_log(err);
				close();
				return;
			} else {
			}
			return;
		} else {
		}
		_time = 0;
		startReceiveContents();
		return;
	} else {
		_time = 0;
		para this.process();
		return;
	}
}
end_body
member
public: void contentsReceived();
body
{
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::contentsReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! HttpServerConnection::contentsReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		if (content_length) {
			err = (string)al_socket("get_last_error", socket_id, null, null);
			// *** server.error_log("recv error. (" + err + ")");
			close();
			return;
		} else {
			close();
			return;
		}
	} else {
	}
	if (content_length) {
		contents = al_misc("binary", read_bytes, null);
		al_misc("binary_copy", al_list2(contents, 0), al_list3(buffer, 0, read_bytes));
		_time = 0;
		para this.process();
		return;
	} else {
	}
	if (contents) {
		var integer idx;
		idx = al_misc("binary_size", contents, null);
		al_misc("extend_binary", contents, read_bytes);
		al_misc("binary_copy", al_list2(contents, idx), al_list3(buffer, 0, read_bytes));
	} else {
		contents = al_misc("binary", read_bytes, null);
		al_misc("binary_copy", al_list2(contents, 0), al_list3(buffer, 0, read_bytes));
	}
	var integer size;
	size = al_misc("binary_size", contents, null);
	if (size > server.maxMsgSize * 1000) {
		server.error_log("request message too large: size >= " + (string)size + ", fromIP = " + (string)fromIP + ", Request = " + (string)command_line);
		send_status = "413_request_entity_too_large";
		if (err = send(http_ver + " 413\n")) {
			// *** server.error_log(err);
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	_time = 0;
	if (chunked) {
		startReceiveCRLF();
	} else {
		startReceiveContents();
	}
}
end_body
member
public: void contentsReceived2();
body
{
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::contentsReceived2: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! HttpServerConnection::contentsReceived2: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error. (" + err + ")");
		close();
		return;
	} else {
	}
	_time = 0;
	var list block;
	block = al_list3(buffer, 0, read_bytes);
	if (upload == null) {
		if (upload_filename = FileUtility::tempFile()) {
		} else {
			// *** server.error_log("can't get upload temp file name");
			close();
			return;
		}
		if (upload = al_file_open(upload_filename, "wb")) {
		} else {
			// *** server.error_log("can't open upload temp file");
			close();
			return;
		}
		if (al_file_write(upload, al_list3(bin_raw_http_header, 0, al_misc("binary_size", bin_raw_http_header, null)), null)) {
			upload = null;
			al_file_manip("remove", upload_filename, null);
			// *** server.error_log("write error to upload temp file");
			close();
			return;
		} else {
		}
		total_read_bytes = 0;
	} else {
	}
	if (al_file_write(upload, block, null)) {
		upload = null;
		al_file_manip("remove", upload_filename, null);
		// *** server.error_log("write error to upload temp file");
		close();
		return;
	} else {
	}
	total_read_bytes = total_read_bytes + read_bytes;
	if (total_read_bytes >= content_length) {
		upload = null;
		para this.process();
	} else {
		startReceiveContents2();
	}
}
end_body
member
public: void CRLFReceived();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::CRLFReceived: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpServerConnection::CRLFReceived: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	_time = 0;
	startReceiveBlockSize();
}
end_body
member
public: list chunked;
member
public: integer buffer_size;
member
public: list buffer;
member
public: string command_line;
member
public: string command;
member
public: string http_ver;
member
public: integer content_block_size;
member
public: list bin_raw_http_header;
member
public: list headers;
member
public: integer content_length;
member
public: string refer;
member
public: list contents;
member
public: void process();
body
{
	var string err, class_name;
	var list upload;
	var string class_name;
	var string abs_path;
	var string content_disposition;
	if (class_name = al_dst_node(server.servlet_list, path)) {
	} else {
		if (class_name = al_dst_node(server.upload_servlet_list, path)) {
			upload = 1;
		} else {
		}
	}
	if (class_name) {
		if (servlet = al_gp("new", class_name, null, null, null)) {
		} else {
			server.access_log(fromIP, command_line, "404", "0");
			send_status = "404_not_found";
			if (err = send(http_ver + " 404\n")) {
				// *** server.error_log(err);
				close();
				return;
			} else {
			}
			return;
		}
		req = new HttpRequest;
		req._command = command;
		req._path = path;
		req._server = server;
		req.bin_raw_http_header = bin_raw_http_header;
		req.fromIP = fromIP;
		req.cert_info = cert_info;
		res = new HttpResponse;
		res._create();
		req._response = res;
		res._request = req;
		res._server = server;
		res.http_ver = http_ver;
		try {
			if (command == "GET") {
				req.headers = headers;
				req._params = params;
				servlet.doGet(req, res);
			} else {
			}
			if (command == "POST") {
				req.headers = headers;
				req._params = params;
				if (upload) {
					req.input_file = upload_filename;
					upload_filename = null;
				} else {
					req.input = contents;
				}
				servlet.doPost(req, res);
			} else {
			}
		} catch (AlException e) {
			var WebUIServlet svlt;
			svlt = new WebUIServlet;
			svlt.res = res;
			svlt.error("Internal Error", e);
		}
		req._response = null;
		req._server = null;
		res._request = null;
		res._server = null;
		server.access_log(fromIP, command_line, (string)res.response_code, (string)res.content_length);
		if (abs_path = res.response_filepath) {
			content_disposition = res.response_content_disposition;
		} else {
			send_status = "servlet_response_code";
			if (err = send(http_ver + " " + (string)res.response_code + "\n")) {
				// *** server.error_log(err);
				close();
				return;
			} else {
			}
			return;
		}
	} else {
	}
	if ((abs_path || abs_path = server.GetAbsPath(path)) && in = al_file_open(abs_path, "rb")) {
	} else {
		server.access_log(fromIP, command_line, "404", "0");
		send_status = "404_not_found";
		if (err = send(http_ver + " 404\n")) {
			// *** server.error_log(err);
			close();
			return;
		} else {
		}
		return;
	}
	content_length = al_file_manip("get_size", abs_path, null);
	headers = al_cons(null, null);
	var string file_ext, content_type;
	file_ext = al_str_misc("file_ext", abs_path, null);
	if (content_type = al_dst_node(server.content_types, file_ext)) {
	} else {
		content_type = "text/plain";
	}
	al_set_dst_node(headers, "Content-Type", content_type);
	al_set_dst_node(headers, "Content-Length", (string)content_length);
	if (content_disposition) {
		al_set_dst_node(headers, "Content-Disposition", content_disposition);
	} else {
	}
	al_set_dst_node(headers, "Server", "AltairServer" + al_misc("version", null, null));
	if (http_ver == "HTTP/1.1") {
		al_set_dst_node(headers, "Connection", "Close");
	} else {
	}
	buffer = al_crypt("mime_headers_write", headers, null, null);
	server.access_log(fromIP, command_line, "200", (string)content_length);
	send_status = "200_ok";
	if (err = send(http_ver + " 200\n")) {
		// *** server.error_log(err);
		close();
		return;
	} else {
	}
	return;
}
end_body
member
public: string order;
member
public: string path;
member
public: string path2;
member
public: list params;
member
public: list send(string str);
body
{
	var integer size;
	var list binary;
	size = al_strlen(str);
	binary = al_misc("binary", size, null);
	al_misc("binary_copy", al_list2(binary, 0), str);
	return send(binary, 0, size);
}
end_body
member
public: list send(list binary);
body
{
	var integer size;
	size = al_misc("binary_size", binary, null);
	return send(binary, 0, size);
}
end_body
member
public: list send(list binary, integer index, integer size);
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::send: socket_id = " + (string)socket_id + ", size = " + (string)size);
		} else {
			al_print("!!! HttpServerConnection::send: socket_id = " + (string)socket_id + ", size = " + (string)size + "\n");
		}
	} else {
	}
	if (msg) {
		var list cb, block;
		cb = al_list3(al_root_class(), this, HttpServerConnection::sendCompleted);
		al_wnd_message(null, "msg_callback", msg, cb);
		block = al_list3(binary, index, size);
		if (al_socket("send", socket_id, block, al_list2(hwnd, msg))) {
			return "send error. (" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
		} else {
		}
	} else {
	}
	return null;
}
end_body
member
public: void sendCompleted();
body
{
	var string err;
	var integer send_bytes;
	send_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpServerConnection::sendCompleted: socket_id = " + (string)socket_id + ", send_bytes = " + (string)send_bytes);
		} else {
			al_print("!!! HttpServerConnection::sendCompleted: socket_id = " + (string)socket_id + ", send_bytes = " + (string)send_bytes + "\n");
		}
	} else {
	}
	if (send_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("send error. (" + err + ")");
		close();
		return;
	} else {
	}
	if (send_status == "servlet_response_code") {
		if (al_dst_node_i(res.headers, "Content-Type")) {
		} else {
			al_set_dst_node(res.headers, "Content-Type", "text/html");
		}
		al_set_dst_node(res.headers, "Content-Length", (string)res.content_length);
		al_set_dst_node(res.headers, "Server", "AltairServer" + al_misc("version", null, null));
		if (http_ver == "HTTP/1.1") {
			al_set_dst_node(headers, "Connection", "Close");
		} else {
		}
		var list buffer;
		buffer = al_crypt("mime_headers_write", res.headers, null, null);
		send_status = "servlet_response_headers";
		if (err = send(buffer)) {
			// *** server.error_log(err);
			close();
			return;
		} else {
		}
		_time = 0;
		return;
	} else {
	}
	if (send_status == "servlet_response_headers") {
		send_status = "servlet_response_contents";
		if (err = send(res.output, 0, res.content_length)) {
			// *** server.error_log(err);
			close();
			return;
		} else {
		}
		_time = 0;
		return;
	} else {
	}
	if (send_status == "servlet_response_contents") {
		close();
		return;
	} else {
	}
	if (send_status == "404_not_found") {
		close();
		return;
	} else {
	}
	if (send_status == "413_request_entity_too_large") {
		close();
		return;
	} else {
	}
	if (send_status == "200_ok") {
		send_status = "headers";
		if (err = send(buffer)) {
			// *** server.error_log(err);
			close();
			return;
		} else {
		}
		_time = 0;
		return;
	} else {
	}
	if (send_status == "headers") {
		buffer = al_misc("binary", buffer_size, null);
		var integer read_bytes;
		var list block;
		total_read_bytes = 0;
		block = al_list3(buffer, 0, buffer_size);
		if (read_bytes = al_file_read(in, block)) {
			if (read_bytes < 0) {
				// cannot read page
				close();
				return;
			} else {
			}
		} else {
			read_bytes = buffer_size;
		}
		send_status = "contents_block";
		total_read_bytes = total_read_bytes + read_bytes;
		if (err = send(buffer, 0, read_bytes)) {
			// *** server.error_log(err);
			close();
			return;
		} else {
		}
		_time = 0;
		return;
	} else {
	}
	if (send_status == "contents_block") {
		if (total_read_bytes >= content_length) {
			close();
			return;
		} else {
		}
		var integer read_bytes;
		var list block;
		block = al_list3(buffer, 0, buffer_size);
		if (read_bytes = al_file_read(in, block)) {
			if (read_bytes < 0) {
				// cannot read page
				close();
				return;
			} else {
			}
		} else {
			read_bytes = buffer_size;
		}
		send_status = "contents_block";
		total_read_bytes = total_read_bytes + read_bytes;
		if (err = send(buffer, 0, read_bytes)) {
			// *** server.error_log(err);
			close();
			return;
		} else {
		}
		_time = 0;
		return;
	} else {
	}
	close();
	return;
}
end_body
member
public: string send_status;
member
public: file in;
member
public: integer total_read_bytes;
member
public: string fromIP;
member
public: list cert_info;
member
public: HttpServlet servlet;
member
public: HttpRequest req;
member
public: HttpResponse res;
member
public: list binary;
member
public: string boundary;
member
public: string upload_filename;
member
public: file upload;
end_class
class HttpClientConnection
member
public: list create(string url);
body
{
	connection_debug();
	if (url == null) {
		return "url is null.";
	} else {
	}
	this.url = url;
	var integer i;
	var string head, tail;
	i = al_search_str(url, 0, "//");
	if (i < 0) {
		return "http:// or https:// required: url = " + (string)url;
	} else {
	}
	head = al_substr(url, 0, i);
	if (head == "http:") {
		ssl = null;
	} else {
		if (head == "https:") {
			ssl = 1;
		} else {
			return "http:// or https:// required: url = " + (string)url;
		}
	}
	tail = al_tail_str(url, i + 2);
	i = al_search_str(tail, 0, "/");
	if (i > 0) {
		path = al_tail_str(tail, i);
		tail = al_substr(tail, 0, i);
	} else {
		path = "/";
	}
	i = al_search_str(tail, 0, ":");
	if (i >= 0) {
		host = al_substr(tail, 0, i);
		port = (integer)al_tail_str(tail, i + 1);
	} else {
		host = tail;
		if (ssl) {
			port = 443;
		} else {
			port = 80;
		}
	}
	headers = al_cons(null, null);
	max_size = 4096;
	output = al_misc("binary", max_size, null);
	content_length = 0;
	buffer_size = 4096;
	buffer = al_misc("binary", buffer_size, null);
	contents = null;
	send_block_size = 4096;
	// default timeout is 60 sec (1 minutes)
	_time = 0;
	timeout = 60;
	wait_obj = new WaitObj;
	server_auth = 0;
	return null;
}
end_body
member
public: list doGet();
body
{
	if (doGet_noWait()) {
		return error;
	} else {
	}
	wait_obj.wait();
	close();
	return error;
}
end_body
member
public: list doPost();
body
{
	if (doPost_noWait()) {
		return error;
	} else {
	}
	wait_obj.wait();
	close();
	return error;
}
end_body
member
public: list doGet_noWait();
body
{
	request_method = "GET";
	if (proxy_server && proxy_server != "" && al_is_type(proxy_port, "integer")) {
		al_set_dst_node(headers, "User-Agent", "Altair" + al_misc("version", null, null));
		al_set_dst_node(headers, "Host", proxy_server + ":" + (string)proxy_port);
		al_set_dst_node(headers, "Accept", "*/*");
		if (error = connect()) {
			close();
			return error;
		} else {
		}
		if (ssl) {
			if (error = send("CONNECT " + host + ":" + (string)port + " HTTP/1.0\r\n")) {
				close();
				return error;
			} else {
			}
			var list buf;
			buf = al_crypt("mime_headers_write", headers, null, null);
			if (error = send(buf)) {
				close();
				return error;
			} else {
			}
			if (error = startReceiveProxyHeaders()) {
				close();
				return error;
			} else {
			}
			wait_obj.wait();
			close();
			return error;
		} else {
			if (error = send("GET " + url + " HTTP/1.0\r\n")) {
				close();
				return error;
			} else {
			}
		}
	} else {
		al_set_dst_node(headers, "User-Agent", "Altair" + al_misc("version", null, null));
		al_set_dst_node(headers, "Host", host + ":" + (string)port);
		al_set_dst_node(headers, "Accept", "*/*");
		if (error = connect()) {
			close();
			return error;
		} else {
		}
		if (ssl && al_socket("SSL_connect", socket_id, null, null)) {
			error = "fail to SSL_connect.(" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
			close();
			return error;
		} else {
		}
		if (ssl) {
			cert_info = al_socket("cert_info", socket_id, null, null);
		} else {
		}
		if (error = send("GET " + path + " HTTP/1.0\r\n")) {
			close();
			return error;
		} else {
		}
	}
	var list buf;
	buf = al_crypt("mime_headers_write", headers, null, null);
	if (error = send(buf)) {
		close();
		return error;
	} else {
	}
	if (error = startReceiveCommand()) {
		close();
		return error;
	} else {
	}
	return null;
}
end_body
member
public: list doPost_noWait();
body
{
	request_method = "POST";
	if (proxy_server && proxy_server != "" && al_is_type(proxy_port, "integer")) {
		if (al_dst_node_i(headers, "Content-Type")) {
		} else {
			al_set_dst_node(headers, "Content-Type", "application/x-www-form-urlencoded");
		}
		al_set_dst_node(headers, "User-Agent", "Altair" + al_misc("version", null, null));
		al_set_dst_node(headers, "Host", proxy_server + ":" + (string)proxy_port);
		al_set_dst_node(headers, "Accept", "*/*");
		al_set_dst_node(headers, "Content-Length", (string)content_length);
		if (error = connect()) {
			close();
			return error;
		} else {
		}
		if (ssl) {
			if (error = send("CONNECT " + host + ":" + (string)port + " HTTP/1.0\r\n")) {
				close();
				return error;
			} else {
			}
			var list buf;
			buf = al_crypt("mime_headers_write", headers, null, null);
			if (error = send(buf)) {
				close();
				return error;
			} else {
			}
			if (error = startReceiveProxyHeaders()) {
				close();
				return error;
			} else {
			}
			wait_obj.wait();
			close();
			return error;
		} else {
			if (error = send("POST " + url + " HTTP/1.0\r\n")) {
				close();
				return error;
			} else {
			}
		}
	} else {
		if (al_dst_node_i(headers, "Content-Type")) {
		} else {
			al_set_dst_node(headers, "Content-Type", "application/x-www-form-urlencoded");
		}
		al_set_dst_node(headers, "User-Agent", "Altair" + al_misc("version", null, null));
		al_set_dst_node(headers, "Host", host + ":" + (string)port);
		al_set_dst_node(headers, "Accept", "*/*");
		al_set_dst_node(headers, "Content-Length", (string)content_length);
		if (error = connect()) {
			close();
			return error;
		} else {
		}
		if (ssl && al_socket("SSL_connect", socket_id, null, null)) {
			error = "fail to SSL_connect.(" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
			close();
			return error;
		} else {
		}
		if (ssl) {
			cert_info = al_socket("cert_info", socket_id, null, null);
		} else {
		}
		if (error = send("POST " + path + " HTTP/1.0\r\n")) {
			close();
			return error;
		} else {
		}
	}
	var list buf;
	buf = al_crypt("mime_headers_write", headers, null, null);
	if (error = send(buf)) {
		close();
		return error;
	} else {
	}
	send_index = 0;
	send_total_size = content_length;
	if (send_block_size > send_total_size) {
		send_block_size = send_total_size;
	} else {
	}
	if (error = send2()) {
		close();
		return error;
	} else {
	}
	return null;
}
end_body
member
public: list isCompleted();
body
{
	return wait_obj && wait_obj.notified;
}
end_body
member
public: string request_method;
member
public: list connect();
body
{
	var integer hostaddr;
	if (ssl) {
		var list files;
		files = al_list4(cert, key, ca_cert, server_auth);
		if (socket_id = al_socket("socket", "SSL", files, "MEDIUM")) {
		} else {
			return "fail to create socket";
		}
	} else {
		if (socket_id = al_socket("socket", null, null, null)) {
		} else {
			return "fail to create socket";
		}
	}
	if (proxy_server && proxy_server != "" && al_is_type(proxy_port, "integer")) {
		if (hostaddr_cache) {
		} else {
			hostaddr_cache = al_cons(null, null);
		}
		if (hostaddr = al_dst_node(hostaddr_cache, host)) {
		} else {
			if (hostaddr = al_socket("gethostbyname", host, null, null)) {
			} else {
				return "fail to get hostaddr: host = " + (string)host;
			}
			al_create_arc(hostaddr_cache, hostaddr, host);
		}
		if (al_socket("connect", socket_id, al_list2(hostaddr, proxy_port), connect_timeout)) {
			return "fail to connect socket.(" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
		} else {
		}
	} else {
		if (hostaddr_cache) {
		} else {
			hostaddr_cache = al_cons(null, null);
		}
		if (hostaddr = al_dst_node(hostaddr_cache, host)) {
		} else {
			if (hostaddr = al_socket("gethostbyname", host, null, null)) {
			} else {
				return "fail to get hostaddr: host = " + (string)host;
			}
			al_create_arc(hostaddr_cache, hostaddr, host);
		}
		if (al_socket("connect", socket_id, al_list2(hostaddr, port), connect_timeout)) {
			return "fail to connect socket.(" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
		} else {
		}
	}
	hwnd = al_wnd_message(null, "hwnd", null, null);
	msg = al_wnd_message(null, "register_msg", "HttpClntConn-" + (string)socket_id, null);
	if (connections) {
	} else {
		connections = al_cons(null, null);
	}
	al_create_arc(connections, this, socket_id);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::create: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::create: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	return null;
}
end_body
member
public: list startReceiveProxyHeaders();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::startReceiveProxyResponse: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::startReceiveProxyResponse: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf;
	cb = al_list3(al_root_class(), this, HttpClientConnection::proxyHeadersReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 2))) {
		return "proxy header recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
	} else {
	}
	return null;
}
end_body
member
public: void proxyHeadersReceived();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::proxyHeadersReceived: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::proxyHeadersReceived: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	if (request_method == "GET") {
		al_set_dst_node(headers, "User-Agent", "Altair" + al_misc("version", null, null));
		al_set_dst_node(headers, "Host", host + ":" + (string)port);
		al_set_dst_node(headers, "Accept", "*/*");
	} else {
		if (al_dst_node_i(headers, "Content-Type")) {
		} else {
			al_set_dst_node(headers, "Content-Type", "application/x-www-form-urlencoded");
		}
		al_set_dst_node(headers, "User-Agent", "Altair" + al_misc("version", null, null));
		al_set_dst_node(headers, "Host", host + ":" + (string)port);
		al_set_dst_node(headers, "Accept", "*/*");
		al_set_dst_node(headers, "Content-Length", (string)content_length);
	}
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::proxyHeadesReceived: ENTER SSL_connect: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::proxyHeadesReceived: ENTER SSL_connect: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	if (al_socket("SSL_connect", socket_id, null, null)) {
		if (debug) {
			if (debug_log_file && appServer) {
				appServer.log(debug_log_file, "!!! HttpClientConnection::proxyHeadesReceived: LEAVE(error) SSL_connect: socket_id = " + (string)socket_id);
			} else {
				al_print("!!! HttpClientConnection::proxyHeadesReceived: LEAVE(error) SSL_connect: socket_id = " + (string)socket_id + "\n");
			}
		} else {
		}
		error = "fail to SSL_connect.(" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
		wait_obj.notify();
		return;
	} else {
		if (debug) {
			if (debug_log_file && appServer) {
				appServer.log(debug_log_file, "!!! HttpClientConnection::proxyHeadesReceived: LEAVE SSL_connect: socket_id = " + (string)socket_id);
			} else {
				al_print("!!! HttpClientConnection::proxyHeadesReceived: LEAVE SSL_connect: socket_id = " + (string)socket_id + "\n");
			}
		} else {
		}
		cert_info = al_socket("cert_info", socket_id, null, null);
	}
	if (error = send(request_method + " " + path + " HTTP/1.0\r\n")) {
		wait_obj.notify();
		return;
	} else {
	}
	var list buf;
	buf = al_crypt("mime_headers_write", headers, null, null);
	if (error = send(buf)) {
		wait_obj.notify();
		return;
	} else {
	}
	if (ssl) {
		if (request_method == "GET") {
			if (error = startReceiveCommand()) {
				wait_obj.wait();
				return;
			} else {
			}
		} else {
			send_index = 0;
			send_total_size = content_length;
			if (send_block_size > send_total_size) {
				send_block_size = send_total_size;
			} else {
			}
			if (error = send2()) {
				wait_obj.wait();
				return;
			} else {
			}
		}
	} else {
		if (error = startReceiveHeaders()) {
			wait_obj.notify();
			return;
		} else {
		}
	}
}
end_body
member
public: void close();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::close: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::close: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var integer id;
	id = socket_id;
	if (socket_id) {
		al_socket("close", socket_id, null, null);
		socket_id = null;
	} else {
	}
	if (hwnd && msg) {
		al_wnd_message(null, "msg_callback", msg, null);
		al_wnd_message(null, "unregister_msg", msg, null);
		hwnd = msg = null;
	} else {
	}
	var list conns;
	if (conns = al_src_node(this, id)) {
		al_set_dst_node(conns, id, null);
	} else {
	}
}
end_body
member
public: string url;
member
public: list ssl;
member
public: string cert;
member
public: string key;
member
public: string ca_cert;
member
public: integer server_auth;
member
public: string host;
member
public: integer port;
member
public: string proxy_server;
member
public: integer proxy_port;
member
public: string path;
member
public: integer socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer _time;
member
public: void setTimeout(integer sec);
body
{
	timeout = sec;
}
end_body
member
public: integer timeout;
member
public: list headers;
member
public: list out(string s);
body
{
	var integer len;
	len = al_strlen(s);
	if (content_length + len > max_size) {
		al_misc("extend_binary", output, len);
		max_size = max_size + len;
	} else {
	}
	al_misc("binary_copy", al_list2(output, content_length), s);
	content_length = content_length + len;
}
end_body
member
public: list out(list binary);
body
{
	var integer size;
	size = al_misc("binary_size", binary, null);
	out(binary, 0, size);
}
end_body
member
public: list out(list binary, integer index, integer size);
body
{
	if (content_length + size > max_size) {
		al_misc("extend_binary", output, size);
		max_size = max_size + size;
	} else {
	}
	al_misc("binary_copy", al_list2(output, content_length), al_list3(binary, index, size));
	content_length = content_length + size;
}
end_body
member
public: list output;
member
public: integer max_size;
member
public: integer content_length;
member
public: WaitObj wait_obj;
member
public: list send(string str);
body
{
	var integer size;
	var list binary;
	size = al_strlen(str);
	binary = al_misc("binary", size, null);
	al_misc("binary_copy", al_list2(binary, 0), str);
	return send(binary, 0, size);
}
end_body
member
public: list send(list binary);
body
{
	var integer size;
	size = al_misc("binary_size", binary, null);
	return send(binary, 0, size);
}
end_body
member
public: list send(list binary, integer index, integer size);
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::send: socket_id = " + (string)socket_id + ", size = " + (string)size);
		} else {
			al_print("!!! HttpClientConnection::send: socket_id = " + (string)socket_id + ", size = " + (string)size + "\n");
		}
	} else {
	}
	var list block;
	block = al_list3(binary, index, size);
	if (al_socket("send", socket_id, block, null)) {
		return "send error. (" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
	} else {
	}
	return null;
}
end_body
member
public: list send2();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::send2: socket_id = " + (string)socket_id + ", send_index = " + (string)send_index + ", send_block_size =" + (string)send_block_size);
		} else {
			al_print("!!! HttpClientConnection::send2: socket_id = " + (string)socket_id + ", send_index = " + (string)send_index + ", send_block_size =" + (string)send_block_size + "\n");
		}
	} else {
	}
	var list cb, block;
	cb = al_list3(al_root_class(), this, HttpClientConnection::sendCompleted);
	al_wnd_message(null, "msg_callback", msg, cb);
	block = al_list3(output, send_index, send_block_size);
	if (al_socket("send", socket_id, block, al_list2(hwnd, msg))) {
		return "send error. (" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
	} else {
	}
	return null;
}
end_body
member
public: void sendCompleted();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::sendCompleted: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::sendCompleted: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	if (send_index >= send_total_size) {
		if (error = startReceiveCommand()) {
			wait_obj.notify();
			return;
		} else {
		}
		return;
	} else {
	}
	send_index = send_index + send_block_size;
	if (send_index + send_block_size > send_total_size) {
		send_block_size = send_total_size - send_index;
	} else {
	}
	if (error = send2()) {
		wait_obj.notify();
		return;
	} else {
	}
}
end_body
member
public: integer send_index;
member
public: integer send_block_size;
member
public: integer send_total_size;
member
public: list startReceiveCommand();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::startReceiveCommand: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::startReceiveCommand: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf;
	cb = al_list3(al_root_class(), this, HttpClientConnection::commandReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 1))) {
		return "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
	} else {
	}
	return null;
}
end_body
member
public: list startReceiveHeaders();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::startReceiveHeaders: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::startReceiveHeaders: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf;
	cb = al_list3(al_root_class(), this, HttpClientConnection::headersReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 2))) {
		return "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
	} else {
	}
	return null;
}
end_body
member
public: list startReceiveBlockSize();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::startReceiveBlockSize: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::startReceiveBlockSize: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf;
	cb = al_list3(al_root_class(), this, HttpClientConnection::blockSizeReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 1))) {
		return "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
	} else {
	}
	return null;
}
end_body
member
public: list startReceiveContents();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::startReceiveContents: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::startReceiveContents: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf;
	cb = al_list3(al_root_class(), this, HttpClientConnection::contentsReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (content_length) {
		if (al_socket("recv", socket_id, buf, al_list4(hwnd, msg, 3, content_length))) {
			return "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
		} else {
		}
	} else {
		if (content_block_size) {
			if (al_socket("recv", socket_id, buf, al_list4(hwnd, msg, 3, content_block_size))) {
				return "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
			} else {
			}
		} else {
			if (al_socket("recv", socket_id, buf, al_list2(hwnd, msg))) {
				return "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
			} else {
			}
		}
	}
	return null;
}
end_body
member
public: list startReceiveCRLF();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::startReceiveCRLF: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::startReceiveCRLF: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf;
	cb = al_list3(al_root_class(), this, HttpClientConnection::CRLFReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 1))) {
		return "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
	} else {
	}
	return null;
}
end_body
member
public: void commandReceived();
body
{
	if (socket_id) {
	} else {
		return;
	}
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::commandReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! HttpClientConnection::commandReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		error = "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
		wait_obj.notify();
		return;
	} else {
	}
	command = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null);
	var file f;
	f = al_file_open(command, "sr");
	al_file_read(f, "string");
	response_code = al_file_read(f, "integer");
	_time = 0;
	if (error = startReceiveHeaders()) {
		wait_obj.notify();
		return;
	} else {
	}
}
end_body
member
public: void headersReceived();
body
{
	if (socket_id) {
	} else {
		return;
	}
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::headersReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! HttpClientConnection::headersReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		error = "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
		wait_obj.notify();
		return;
	} else {
	}
	if (headers = al_crypt("mime_headers_read", al_list3(buffer, 0, read_bytes), null, null)) {
		headers = headers.head;
	} else {
		headers = al_cons(null, null);
	}
	if (debug3) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "---- received Http Response Header\n" + (string)al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null));
		} else {
			al_print("---- received Http Response Header\n" + (string)al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null));
		}
	} else {
	}
	if (content_length = al_dst_node_i(headers, "Content-Length")) {
		content_length = (integer)content_length;
		if (content_length <= 0) {
			contents = al_misc("binary", 0, null);
			wait_obj.notify();
			return;
		} else {
		}
		_time = 0;
		if (error = startReceiveContents()) {
			wait_obj.notify();
			return;
		} else {
		}
	} else {
		var string encoding;
		encoding = al_dst_node_i(headers, "Transfer-Encoding");
		if (encoding && al_str_misc("strcmpi", encoding, "chunked") == 0) {
			chunked = 1;
			_time = 0;
			if (error = startReceiveBlockSize()) {
				wait_obj.notify();
				return;
			} else {
			}
		} else {
			_time = 0;
			if (error = startReceiveContents()) {
				wait_obj.notify();
				return;
			} else {
			}
		}
	}
}
end_body
member
public: void blockSizeReceived();
body
{
	if (socket_id) {
	} else {
		return;
	}
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::blockSizeReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! HttpClientConnection::blockSizeReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		error = "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
		wait_obj.notify();
		return;
	} else {
	}
	var string hex_str;
	var file f;
	hex_str = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null);
	f = al_file_open(hex_str, "sr");
	content_block_size = al_file_read(f, "hex");
	if (content_block_size > 0) {
		_time = 0;
		if (error = startReceiveContents()) {
			wait_obj.notify();
			return;
		} else {
		}
	} else {
		wait_obj.notify();
		return;
	}
}
end_body
member
public: void contentsReceived();
body
{
	if (socket_id) {
	} else {
		return;
	}
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::contentsReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! HttpClientConnection::contentsReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		if (content_length) {
			error = "recv error: " + (string)al_socket("get_last_error", socket_id, null, null);
			wait_obj.notify();
			return;
		} else {
			wait_obj.notify();
			return;
		}
	} else {
	}
	if (content_length) {
		contents = al_misc("binary", read_bytes, null);
		al_misc("binary_copy", al_list2(contents, 0), al_list3(buffer, 0, read_bytes));
		wait_obj.notify();
		return;
	} else {
	}
	if (contents) {
		var integer idx;
		idx = al_misc("binary_size", contents, null);
		al_misc("extend_binary", contents, read_bytes);
		al_misc("binary_copy", al_list2(contents, idx), al_list3(buffer, 0, read_bytes));
	} else {
		contents = al_misc("binary", read_bytes, null);
		al_misc("binary_copy", al_list2(contents, 0), al_list3(buffer, 0, read_bytes));
	}
	if (chunked) {
		_time = 0;
		if (error = startReceiveCRLF()) {
			wait_obj.notify();
			return;
		} else {
		}
	} else {
		_time = 0;
		if (error = startReceiveContents()) {
			wait_obj.notify();
			return;
		} else {
		}
	}
}
end_body
member
public: void CRLFReceived();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! HttpClientConnection::CRLFReceived: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! HttpClientConnection::CRLFReceived: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	_time = 0;
	if (error = startReceiveBlockSize()) {
		wait_obj.notify();
		return;
	} else {
	}
}
end_body
member
public: list chunked;
member
public: list error;
member
public: integer buffer_size;
member
public: list buffer;
member
public: string command;
member
public: integer content_block_size;
member
public: list contents;
member
public: integer response_code;
member
public: list cert_info;
member
public: static list connections;
member
public: static list hostaddr_cache;
member
public: static integer connect_timeout;
end_class
class HttpServlet
member
public: void doGet(HttpRequest req, HttpResponse res);
body
{
	res.response_code = 404;
}
end_body
member
public: void doPost(HttpRequest req, HttpResponse res);
body
{
	res.response_code = 404;
}
end_body
member
public: static list servlet_params;
member
public: string toUTF8(string str);
body
{
	if (str) {
		str = al_str_misc("xml_encode", str, 0x0000000000000003);
	} else {
	}
	str = toUTF8_direct(str);
	return str;
}
end_body
member
public: string toUTF8_direct(string str);
body
{
	if (str) {
	} else {
		return "";
	}
	var string platform, s;
	platform = al_misc("platform", null, null);
	if (platform == "windows") {
		if (s = al_str_misc("sjis_to_utf8", str, null)) {
			str = s;
		} else {
		}
	} else {
	}
	return str;
}
end_body
member
public: string fromUTF8(string str);
body
{
	if (str) {
	} else {
		return null;
	}
	var string platform, s;
	platform = al_misc("platform", null, null);
	if (platform == "windows") {
		if (s = al_str_misc("utf8_to_sjis", str, null)) {
			str = s;
		} else {
		}
	} else {
	}
	return str;
}
end_body
member
public: string fromUTF8(list str);
body
{
	var string s;
	s = str;
	return fromUTF8(s);
}
end_body
class WebUIServlet
member
public: void doGet(HttpRequest req, HttpResponse res);
body
{
	this.req = req;
	this.res = res;
	var list params;
	params = req.getParameters();
	action = (string)al_dst_node(params, "action");
	if (session = req.getSession()) {
		target = session.getAttribute("target");
		user_name = session.getAttribute("user_name");
		user_roles = session.getAttribute("user_roles");
		admin_target = adminMenuTarget(target, user_name);
	} else {
		error("no session");
		return;
	}
	if (target == "system") {
		doAction(params);
		return;
	} else {
	}
	var string class_name;
	var WebUIServlet servlet;
	class_name = "WebUI" + (string)target + "Servlet";
	if (servlet = al_gp("new", class_name, null, null, null)) {
	} else {
		error("servlet for target '" + (string)target + "' not found");
		return;
	}
	servlet.action = action;
	servlet.target = target;
	servlet.admin_target = adminMenuTarget(target, user_name);
	servlet.user_name = user_name;
	servlet.user_roles = user_roles;
	servlet.req = req;
	servlet.res = res;
	servlet.session = session;
	servlet.doAction(params);
}
end_body
member
public: void doPost(HttpRequest req, HttpResponse res);
body
{
	this.req = req;
	this.res = res;
	var list params;
	params = req.getParameters();
	action = (string)al_dst_node(params, "action");
	if (session = req.getSession()) {
		target = session.getAttribute("target");
		user_name = session.getAttribute("user_name");
		user_roles = session.getAttribute("user_roles");
		admin_target = adminMenuTarget(target, user_name);
	} else {
		if (al_search_str(action, 0, "Login") < 0 && session == null) {
			error("no session");
			return;
		} else {
			target = fromUTF8((list)al_dst_node(params, "target"));
			if (target == null || target == "") {
				target = "system";
			} else {
			}
			user_name = target + ":" + (string)fromUTF8((list)al_dst_node(params, "user"));
		}
	}
	if (target == "system") {
		doAction(params);
		return;
	} else {
	}
	var string class_name;
	var WebUIServlet servlet;
	class_name = "WebUI" + (string)target + "Servlet";
	if (servlet = al_gp("new", class_name, null, null, null)) {
	} else {
		error("servlet for target '" + (string)target + "' not found");
		return;
	}
	servlet.action = action;
	servlet.target = target;
	servlet.admin_target = adminMenuTarget(target, user_name);
	servlet.user_name = user_name;
	servlet.user_roles = user_roles;
	servlet.req = req;
	servlet.res = res;
	servlet.session = session;
	servlet.doAction(params);
}
end_body
member
public: void doAction(list params);
body
{
	var DbConnection conn;
	var list arg_dcl, arg1, arg2, method_name, args;
	try {
		conn = DbManager::getConnection(pool_name);
		method_name = "invoke" + action;
		arg_dcl = get_arg_dcl(null, (DbConnection)null);
		arg1 = al_list3(arg_dcl.head, params, null);
		arg2 = al_list3(arg_dcl.tail.tail.head, conn, null);
		args = al_list2(arg1, arg2);
		if (al_gp("run2", this, arg_dcl, method_name, args) == 0x0000000080000000) {
			error("specified action '" + action + "' not found.");
			conn.rollback();
			conn.close();
			return;
		} else {
		}
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		error("", e);
	}
}
end_body
member
public: list get_arg_dcl(list params, DbConnection conn);
body
{
	return al_gp("arg_dcl", null, null, null, null);
}
end_body
member
public: list invokeLogin(list params, DbConnection conn);
body
{
	if (authorize(params, conn)) {
	} else {
		return null;
	}
	if (al_dst_node(user_roles, "webuiadmin")) {
		res.redirect("ebiz?action=WebUiAdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "admin")) {
		res.redirect("ebiz?action=AdminHome");
		return null;
	} else {
	}
	error("User '" + user_name + "' does not have required user role");
	return null;
}
end_body
member
public: list invokeLogout(list params, DbConnection conn);
body
{
	session.invalidate();
	res.redirect("index.html");
	return null;
}
end_body
member
public: list authorize(list params, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var string pass, pass2, role_name;
	var list ls, itr;
	if (session) {
		session.invalidate();
	} else {
	}
	pass = al_dst_node(params, "pass");
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	ls = acc.get("User/Id", user_name);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("User '" + user_name + "' not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of user '" + user_name + "' records is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	pass2 = obj.getField("User/Password");
	if (pass2 != pass) {
		error("Password not match.");
		return null;
	} else {
	}
	req._server.ap_server.system_log("info", "user '" + user_name + "' login.");
	session = req.createSession();
	ls = obj.getChildren("User/RoleName");
	itr = al_dst_itr(ls);
	user_roles = al_cons(null, null);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		role_name = obj.getField("");
		al_create_arc(user_roles, al_cons(null, null), role_name);
	}
	session.setAttribute("target", target);
	session.setAttribute("user_name", user_name);
	session.setAttribute("user_roles", user_roles);
	return 1;
}
end_body
member
public: list authorize2(list params, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var string pass, pass2, role_name;
	var list ls, itr;
	pass = al_dst_node(params, "pass");
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	ls = acc.get("User/Id", user_name);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("User '" + user_name + "' not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of user '" + user_name + "' records is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	pass2 = obj.getField("User/Password");
	if (pass2 != pass) {
		error("Password not match.");
		return null;
	} else {
	}
	if (session) {
	} else {
		req._server.ap_server.system_log("info", "user '" + user_name + "' login.");
		session = req.createSession();
	}
	ls = obj.getChildren("User/RoleName");
	itr = al_dst_itr(ls);
	user_roles = al_cons(null, null);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		role_name = obj.getField("");
		al_create_arc(user_roles, al_cons(null, null), role_name);
	}
	session.setAttribute("target", target);
	session.setAttribute("user_name", user_name);
	session.setAttribute("user_roles", user_roles);
	return 1;
}
end_body
member
public: list checkUserRole(string role_name);
body
{
	if (user_roles && al_dst_node(user_roles, role_name)) {
		return 1;
	} else {
	}
	error("user_role '" + (string)role_name + "' required");
	return null;
}
end_body
member
public: list checkUserRole(DbConnection conn);
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string view_name, role_name;
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	ls = acc.get("WebUiData/Target", adminMenuTarget(target, user_name));
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
	} else {
		error("WebUiData information of target '" + (string)user_name + "' not found.");
		return null;
	}
	ls = obj.getChildren("WebUiData/MenuItem", "Name", action);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
	} else {
		error("required roles of view '" + action + "' not found.");
		return null;
	}
	ls = obj.getChildren("View/RoleName");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		role_name = obj.getField("");
		if (al_dst_node(user_roles, role_name)) {
		} else {
			error("user_role '" + (string)role_name + "' required");
			return null;
		}
	}
	return 1;
}
end_body
member
public: string action;
member
public: string target;
member
public: string admin_target;
member
public: string user_name;
member
public: list user_roles;
member
public: void error(string msg);
body
{
	res._create();
	res.out("<HTML><HEAD><TITLE>Error</TITLE></HEAD><BODY>\n");
	res.out(msg);
	res.out("</BODY></HEML>\n");
}
end_body
member
public: void error(string msg, AlException e);
body
{
	var string s, s2, line;
	var file f, f2;
	s = al_copy("");
	f = al_file_open(s, "sw");
	al_file_write(f, "string", "StackTrace\n");
	al_misc("stack_trace", e.stack_frame, f);
	al_file_write(f, "string", "Source\n");
	al_misc("error_source", al_list2(e.stack_frame, e.pos), f);
	f = al_file_open(s, "sr");
	s2 = al_copy("");
	f2 = al_file_open(s2, "sw");
	loop {
		if (line = al_file_read(f, "line")) {
		} else {
			break;
		}
		line = al_str_misc("xml_encode", line, 3);
		if (line == "StackTrace" || line == "Source") {
			al_file_write(f2, "string", "<H4>");
		} else {
		}
		al_file_write(f2, "string", line);
		if (line == "StackTrace" || line == "Source") {
			al_file_write(f2, "string", "</H4>");
		} else {
			al_file_write(f2, "string", "<BR/>");
		}
	}
	error(msg + "<BR/><BR/>" + "Exception: e.msg = " + e.msg + "<BR/><BR/>" + s2);
}
end_body
member
public: HttpRequest req;
member
public: HttpResponse res;
member
public: HttpSession session;
member
public: static string pool_name;
member
public: list invokeWebUiAdminHome(list params, DbConnection conn);
body
{
	if (checkUserRole("webuiadmin")) {
	} else {
		return null;
	}
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr, sel_values;
	var string line_number, name, kind, text;
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	ls = acc.get("WebUiData/Target", target);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("WebUiData not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of WebUiData records is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	genPageBegin("MenuEdit");
	genFormBegin("WebUiAdminMenuEdit", null);
	genTitle("Menu Edit");
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD>Kind</TD><TD>Name</TD><TD>Text</TD></TR>\n");
	ls = obj.getChildren("WebUiData/MenuItem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		line_number = obj.getField("LineNumber");
		name = obj.getField("Name");
		kind = obj.getField("Kind");
		text = obj.getField("Text");
		res.out("<TR><TD>");
		genRadio("radio", name, kind, null);
		res.out("</TD><TD>");
		genText(name);
		res.out("</TD><TD>");
		genTextField(name + "-Text", 20, text);
		res.out("</TD></TR>\n");
		genHidden(name + "-Hidden", line_number);
	}
	res.out("</TABLE>\n");
	sel_values = al_cons(null, null);
	al_create_arc(sel_values, "Title", null);
	al_create_arc(sel_values, "View", (list)1);
	al_create_arc(sel_values, "RefreshView", null);
	genText("Kind");
	genSelect("Create-Select", sel_values);
	genBR();
	genText("Name");
	genTextField("Create-Name", 20, "");
	genBR();
	genText("Text");
	genTextField("Create-Text", 20, "");
	genBR();
	genButton("submit", "create");
	genBR();
	genButton("submit", "update");
	genButton("submit", "delete");
	genButton("submit", "up");
	genButton("submit", "down");
	genBR();
	genButton("submit", "edit view");
	genHR();
	genButton("submit", "logout");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeWebUiAdminMenuEdit(list params, DbConnection conn);
body
{
	if (checkUserRole("webuiadmin")) {
	} else {
		return null;
	}
	var string submit;
	var string item, item_text;
	var string create_select, create_name, create_text;
	var integer item_number, i, i2;
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	var list ls, itr;
	var string name, kind, text;
	submit = al_dst_node(params, "submit");
	item = al_dst_node(params, "radio");
	if (item && item != "") {
		item_number = (integer)al_dst_node(params, item + "-Hidden");
		item_text = fromUTF8((string)al_dst_node(params, item + "-Text"));
	} else {
		item_number = 0;
	}
	create_select = al_dst_node(params, "Create-Select");
	create_name = al_dst_node(params, "Create-Name");
	create_text = fromUTF8((string)al_dst_node(params, "Create-Text"));
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	ls = acc.get("WebUiData/Target", target);
	itr = al_dst_itr(ls);
	obj = al_next(itr);
	ls = obj.getChildren("WebUiData/MenuItem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	itr = al_dst_itr(ls);
	if (submit == "create") {
		if (create_name && create_name != "" && create_text && create_text != "") {
			if (obj2 = findItem(itr, item_number)) {
				i = (integer)obj2.getField("LineNumber");
				al_prev(itr);
				incLineNumber(itr);
			} else {
				i = max_line_number + 1;
			}
			obj = obj.createChild("WebUiData/MenuItem");
			obj.putField("LineNumber", (string)i);
			obj.putField("Name", create_name);
			obj.putField("Kind", create_select);
			obj.putField("Text", create_text);
		} else {
			error("Name or Text is null.");
			return null;
		}
		return invokeWebUiAdminHome(params, conn);
	} else {
	}
	if (submit == "delete") {
		if (obj = findItem(itr, item_number)) {
			obj.delete();
			decLineNumber(itr);
		} else {
			error("radio button not checked.");
			return null;
		}
		return invokeWebUiAdminHome(params, conn);
	} else {
	}
	if (submit == "up") {
		if (obj = findItem(itr, item_number) && obj2 = al_prev(itr)) {
			i = (integer)obj.getField("LineNumber");
			i2 = (integer)obj2.getField("LineNumber");
			obj.putField("LineNumber", (string)i2);
			obj2.putField("LineNumber", (string)i);
		} else {
			error("radio button not checked or top item checked.");
			return null;
		}
		return invokeWebUiAdminHome(params, conn);
	} else {
	}
	if (submit == "down") {
		if (obj = findItem(itr, item_number) && obj2 = al_next(itr)) {
			i = (integer)obj.getField("LineNumber");
			i2 = (integer)obj2.getField("LineNumber");
			obj.putField("LineNumber", (string)i2);
			obj2.putField("LineNumber", (string)i);
		} else {
			error("radio button not checked or bottom item checked.");
			return null;
		}
		return invokeWebUiAdminHome(params, conn);
	} else {
	}
	if (submit == "update") {
		if (item_text && item_text != "") {
			if (obj = findItem(itr, item_number)) {
				obj.putField("Text", item_text);
			} else {
				error("Text is null.");
				return null;
			}
		} else {
			error("radio button not checked.");
			return null;
		}
		return invokeWebUiAdminHome(params, conn);
	} else {
	}
	if (submit == "edit view") {
		if (item && item != "") {
			session.setAttribute("view_name", item);
		} else {
			error("radio button not checked.");
			return null;
		}
		return invokeWebUiAdminViewHome(params, conn);
	} else {
	}
	if (submit == "logout") {
		return invokeLogout(params, conn);
	} else {
	}
	return invokeWebUiAdminViewHome(params, conn);
}
end_body
member
public: list invokeWebUiAdminViewHome(list params, DbConnection conn);
body
{
	if (checkUserRole("webuiadmin")) {
	} else {
		return null;
	}
	var string view_name;
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	var list ls, itr, sel_values;
	var string line_number, name, kind, text;
	if (view_name = session.getAttribute("view_name")) {
	} else {
		error("view name is not setted.");
		return null;
	}
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	ls = acc.get("WebUiData/Target", target);
	itr = al_dst_itr(ls);
	obj = al_next(itr);
	ls = obj.getChildren("WebUiData/MenuItem", "Name", view_name);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("view '" + (string)view_name + "' not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of view '" + (string)view_name + "' is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	genPageBegin("ViewEdit");
	genFormBegin("WebUiAdminViewEdit", null);
	genTitle("View Edit (view name = " + (string)view_name + ")");
	ls = obj.getChildren("View/RoleName");
	itr = al_dst_itr(ls);
	genText("* Requried Roles");
	genBR();
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD>Required Role</TD></TR>\n");
	sel_values = al_cons(null, null);
	loop {
		if (obj2 = al_next(itr)) {
		} else {
			break;
		}
		var string role_name;
		role_name = obj2.getField("");
		al_create_arc(sel_values, role_name, null);
		res.out("<TR><TD>");
		res.out(toUTF8(role_name));
		res.out("</TD><TR>\n");
	}
	res.out("</TABLE>\n");
	genTextField("addRole-Text", 20, "");
	genButton("submit", "addRole");
	genSelect("removeRole-Text", sel_values);
	genButton("submit", "removeRole");
	res.out("</TABLE>\n");
	genHR();
	genText("* UI parts");
	genBR();
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD>Kind</TD><TD>Name</TD><TD>Text</TD></TR>\n");
	ls = obj.getChildren("View/UiElem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		line_number = obj.getField("LineNumber");
		name = obj.getField("Name");
		kind = obj.getField("Kind");
		text = obj.getField("Text");
		res.out("<TR><TD>");
		genRadio("radio", name, kind, null);
		res.out("</TD><TD>");
		if (kind != "BR" && kind != "Text") {
			genText(name);
		} else {
		}
		res.out("</TD><TD>");
		if (kind == "Text" || kind == "Link" || kind == "Button" || kind == "TextField" || kind == "TextArea" || kind == "Radio" || kind == "Table1" || kind == "Table2") {
			genTextField(name + "-Text", 20, text);
		} else {
		}
		res.out("</TD></TR>\n");
		genHidden(name + "-Hidden", line_number);
	}
	res.out("</TABLE>\n");
	sel_values = al_cons(null, null);
	al_create_arc(sel_values, "Title", null);
	al_create_arc(sel_values, "Text", null);
	al_create_arc(sel_values, "Link", null);
	al_create_arc(sel_values, "BR", null);
	al_create_arc(sel_values, "Button", (list)1);
	al_create_arc(sel_values, "Check", null);
	al_create_arc(sel_values, "Radio", null);
	al_create_arc(sel_values, "TextField", null);
	al_create_arc(sel_values, "Password", null);
	al_create_arc(sel_values, "TextArea", null);
	al_create_arc(sel_values, "Upload", null);
	al_create_arc(sel_values, "Select", null);
	al_create_arc(sel_values, "Table1", null);
	al_create_arc(sel_values, "Table2", null);
	genText("Kind");
	genSelect("Create-Select", sel_values);
	genText("Name");
	genTextField("Create-Name", 20, "");
	genText("Text");
	genTextField("Create-Text", 20, "");
	genBR();
	genButton("submit", "create");
	genBR();
	genButton("submit", "update");
	genButton("submit", "delete");
	genButton("submit", "up");
	genButton("submit", "down");
	genBR();
	genButton("submit", "edit select/table");
	genHR();
	genButton("submit", "return");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeWebUiAdminViewEdit(list params, DbConnection conn);
body
{
	if (checkUserRole("webuiadmin")) {
	} else {
		return null;
	}
	var string submit;
	var string item, item_text, submit_text;
	var string create_select, create_name, create_text;
	var integer item_number, i, i2;
	var string view_name;
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	var list ls, itr;
	var string name, kind, text;
	submit = al_dst_node(params, "submit");
	submit_text = fromUTF8((string)al_dst_node(params, submit + "-Text"));
	item = al_dst_node(params, "radio");
	if (item && item != "") {
		item_number = (integer)al_dst_node(params, item + "-Hidden");
		item_text = fromUTF8((string)al_dst_node(params, item + "-Text"));
	} else {
		item_number = 0;
	}
	create_select = al_dst_node(params, "Create-Select");
	create_name = al_dst_node(params, "Create-Name");
	create_text = fromUTF8((string)al_dst_node(params, "Create-Text"));
	if (view_name = session.getAttribute("view_name")) {
	} else {
		error("view name is not setted.");
		return null;
	}
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	ls = acc.get("WebUiData/Target", target);
	itr = al_dst_itr(ls);
	obj = al_next(itr);
	ls = obj.getChildren("WebUiData/MenuItem", "Name", view_name);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("view '" + (string)view_name + "' not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of view '" + (string)view_name + "' is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	ls = obj.getChildren("View/UiElem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	itr = al_dst_itr(ls);
	if (submit == "addRole") {
		if (submit_text && submit_text != "") {
			obj = obj.createChild("View/RoleName");
			obj.putField("", submit_text);
			invokeWebUiAdminViewHome(params, conn);
		} else {
			error("role to be added is null.");
			return null;
		}
		return invokeWebUiAdminViewHome(params, conn);
	} else {
	}
	if (submit == "removeRole") {
		ls = obj.getChildren("View/RoleName", "", submit_text);
		itr = al_dst_itr(ls);
		if (obj = al_next(itr)) {
			obj.delete();
		} else {
			error("role to be deleted not found.");
			return null;
		}
		return invokeWebUiAdminViewHome(params, conn);
	} else {
	}
	if (submit == "create") {
		if (create_name && create_name != "" && create_text) {
			if (obj2 = findItem(itr, item_number)) {
				i = (integer)obj2.getField("LineNumber");
				al_prev(itr);
				incLineNumber(itr);
			} else {
				i = max_line_number + 1;
			}
			obj = obj.createChild("View/UiElem");
			obj.putField("LineNumber", (string)i);
			obj.putField("Name", create_name);
			obj.putField("Kind", create_select);
			obj.putField("Text", create_text);
		} else {
			error("Name or Text is null.");
			return null;
		}
		return invokeWebUiAdminViewHome(params, conn);
	} else {
	}
	if (submit == "delete") {
		if (obj = findItem(itr, item_number)) {
			obj.delete();
			decLineNumber(itr);
		} else {
			error("radio button not checked.");
			return null;
		}
		return invokeWebUiAdminViewHome(params, conn);
	} else {
	}
	if (submit == "up") {
		if (obj = findItem(itr, item_number) && obj2 = al_prev(itr)) {
			i = (integer)obj.getField("LineNumber");
			i2 = (integer)obj2.getField("LineNumber");
			obj.putField("LineNumber", (string)i2);
			obj2.putField("LineNumber", (string)i);
		} else {
			error("radio button not checked or top item checked.");
			return null;
		}
		return invokeWebUiAdminViewHome(params, conn);
	} else {
	}
	if (submit == "down") {
		if (obj = findItem(itr, item_number) && obj2 = al_next(itr)) {
			i = (integer)obj.getField("LineNumber");
			i2 = (integer)obj2.getField("LineNumber");
			obj.putField("LineNumber", (string)i2);
			obj2.putField("LineNumber", (string)i);
		} else {
			error("radio button not checked or bottom item checked.");
			return null;
		}
		return invokeWebUiAdminViewHome(params, conn);
	} else {
	}
	if (submit == "update") {
		if (item_text) {
			if (obj = findItem(itr, item_number)) {
				obj.putField("Text", item_text);
			} else {
				error("Text is null.");
				return null;
			}
		} else {
			error("radio button not checked.");
			return null;
		}
		return invokeWebUiAdminViewHome(params, conn);
	} else {
	}
	if (submit == "edit select/table") {
		if (item && item != "") {
			session.setAttribute("db_parts_name", item);
			return invokeWebUiAdminSelectableHome(params, conn);
		} else {
			error("radio button not checked.");
			return null;
		}
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "return") {
		session.setAttribute("view_name", null);
		return invokeWebUiAdminHome(params, conn);
	} else {
	}
}
end_body
member
public: list invokeWebUiAdminSelectableHome(list params, DbConnection conn);
body
{
	if (checkUserRole("webuiadmin")) {
	} else {
		return null;
	}
	var string view_name, db_parts_name;
	var XmlDbAccessor acc, meta_acc;
	var XmlDbObject obj, obj2, obj3, meta_obj;
	var list ls, itr, itr2;
	var string name, kind;
	var string msgType, msgVersion, dtd_filename, child_path, type, default;
	var string line_number, path, value, line_number2;
	var string range_path, range_type, from, to;
	var string orderby_path, orderby_type, desc, count_from, count_max;
	var string column_name, column_value;
	var string column_name2, column_value2;
	var string editable, password;
	if (view_name = session.getAttribute("view_name")) {
	} else {
		error("view name is not setted.");
		return null;
	}
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	ls = acc.get("WebUiData/Target", target);
	itr = al_dst_itr(ls);
	obj = al_next(itr);
	ls = obj.getChildren("WebUiData/MenuItem", "Name", view_name);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("view '" + (string)view_name + "' not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of view '" + (string)view_name + "' is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	if (db_parts_name = session.getAttribute("db_parts_name")) {
	} else {
		error("db parts name is not setted.");
		return null;
	}
	ls = obj.getChildren("View/UiElem", "Name", db_parts_name);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("db parts '" + (string)db_parts_name + "' not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of db_parts '" + (string)db_parts_name + "' is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	name = obj.getField("Name");
	kind = obj.getField("Kind");
	genPageBegin("SelectableEdit");
	genFormBegin("WebUiAdminSelectableEdit", null);
	genTitle("Selectable Edit (name = " + (string)name + ", kind =" + (string)kind + ")");
	ls = obj.getChildren("Selectable/Children", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	itr = al_dst_itr(ls);
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD></TD><TD>MsgType,ChildPath</TD><TD>Condition</TD><TD>Type</TD><TD>Default</TD></TR>\n");
	loop {
		if (obj2 = al_next(itr)) {
		} else {
			break;
		}
		res.out("<TR>");
		line_number = obj2.getField("LineNumber");
		res.out("<TD>");
		genRadio("radio", "Children-" + line_number, "", null);
		res.out("</TD><TD>");
		genHidden("Children-Hidden", line_number);
		if (msgType = obj2.getField("MsgType")) {
			msgVersion = obj2.getField("MsgVersion");
			dtd_filename = obj2.getField("DTDfilename");
			genText("msgType");
			genTextField("msgType", 20, msgType);
			genBR();
			genText("msgVersion");
			genTextField("msgVersion", 20, msgVersion);
			genBR();
			genText("DTDfilename");
			genTextField("DTDfilename", 20, dtd_filename);
			meta_acc = new XmlDbAccessor;
			meta_acc.create(msgType, getValue(msgVersion), conn);
			meta_acc.setDTDfilename(dtd_filename);
			meta_obj = meta_acc.getMetaInfo();
		} else {
			child_path = obj2.getField("ChildPath");
			genText("ChildPath");
			genTextField("ChildPath-" + line_number, 20, child_path);
			meta_obj = meta_obj.getMetaInfo(child_path);
		}
		res.out("</TD><TD></TD><TD>");
		type = obj2.getField("Type");
		genTextField("Type-" + line_number, 7, type);
		res.out("</TD><TD>");
		default = obj2.getField("Default");
		genTextField("Default-" + line_number, 15, default);
		res.out("</TD></TR>");
		ls = obj2.getChildren("Condition", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
		itr2 = al_dst_itr(ls);
		loop {
			if (obj3 = al_next(itr2)) {
			} else {
				break;
			}
			line_number2 = obj3.getField("LineNumber");
			path = obj3.getField("Path");
			value = obj3.getField("Value");
			res.out("<TR><TD>");
			genRadio("radio", "Cond-" + line_number + ":" + line_number2, "", null);
			res.out("</TD><TD></TD><TD>");
			genText("Path");
			genTextField("Cond-Path-" + line_number + ":" + line_number2, 20, path);
			genBR();
			genText("Value");
			genTextField("Cond-Value-" + line_number + ":" + line_number2, 20, value);
			res.out("</TD><TD></TD></TR>");
		}
	}
	res.out("</TABLE>\n");
	genText("Path");
	genTextField("Create-Path", 20, "");
	genText("Type/Value");
	genTextField("Create-Value", 20, "");
	genBR();
	genButton("submit", "create");
	genButton("submit", "condition create");
	genBR();
	genButton("submit", "update");
	genButton("submit", "delete");
	genButton("submit", "up");
	genButton("submit", "down");
	genHR();
	if (kind == "Table2") {
		range_path = obj.getField("Selectable/Condition2/RangePath");
		range_type = obj.getField("Selectable/Condition2/RangeType");
		from = obj.getField("Selectable/Condition2/From");
		to = obj.getField("Selectable/Condition2/To");
		orderby_path = obj.getField("Selectable/Condition2/OrderByPath");
		orderby_type = obj.getField("Selectable/Condition2/OrderByType");
		desc = obj.getField("Selectable/Condition2/Desc");
		count_from = obj.getField("Selectable/Condition2/CountFrom");
		count_max = obj.getField("Selectable/Condition2/CountMax");
		column_name = obj.getField("Selectable/Condition2/ColumnName");
		column_value = obj.getField("Selectable/Condition2/ColumnValue");
		column_name2 = obj.getField("Selectable/Condition2/ColumnName2");
		column_value2 = obj.getField("Selectable/Condition2/ColumnValue2");
		genText("RagnePath");
		genTextField("RangePath", 30, range_path);
		genText("RagneType");
		genTextField("RangeType", 30, range_type);
		genBR();
		genText("From");
		genTextField("From", 30, from);
		genText("To");
		genTextField("To", 30, to);
		genBR();
		genText("OrderByPath");
		genTextField("OrderByPath", 30, orderby_path);
		genText("OrderByType");
		genTextField("OrderByType", 30, orderby_type);
		genBR();
		genText("Desc");
		genTextField("Desc", 10, desc);
		genBR();
		genText("CountFrom");
		genTextField("CountFrom", 30, count_from);
		genText("CountMax");
		genTextField("CountMax", 30, count_max);
		genBR();
		genText("ColumnName");
		genTextField("ColumnName", 30, column_name);
		genText("ColumnValue");
		genTextField("ColumnValue", 30, column_value);
		genBR();
		genText("ColumnName2");
		genTextField("ColumnName2", 30, column_name2);
		genText("ColumnValue2");
		genTextField("ColumnValue2", 30, column_value2);
		genBR();
		genButton("submit", "condition update");
		genButton("submit", "condition delete");
		genHR();
	} else {
	}
	itr = al_dst_itr(meta_obj.xpath_list);
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD></TD><TD>Path</TD><TD>LineNumber</TD><TD>Visible</TD><TD>Editable</TD><TD>Password</TD></TR>\n");
	loop {
		if (path = al_next(itr)) {
		} else {
			break;
		}
		res.out("<TR><TD>");
		genRadio("radio", "Item-" + path, "", null);
		res.out("</TD><TD>");
		genText(path);
		genHidden("Item-" + path + "-Path", path);
		res.out("</TD><TD>");
		ls = obj.getChildren("Selectable/TableItem", "Path", path);
		itr2 = al_dst_itr(ls);
		if (obj2 = al_next(itr2)) {
			genHidden("Item-" + path, path);
			line_number = obj2.getField("LineNumber");
			editable = obj2.getField("Editable");
			password = obj2.getField("Password");
			genTextField("Item-" + path + "-LineNumber", 5, line_number);
			res.out("</TD><TD>");
			genTextField("Item-" + path + "-Visible", 10, "true");
			res.out("</TD><TD>");
			genTextField("Item-" + path + "-Editable", 10, editable);
			res.out("</TD><TD>");
			genTextField("Item-" + path + "-Password", 10, password == "true" ? "true" : "");
			res.out("</TD></TR>");
		} else {
			genTextField("Item-" + path + "-LineNumber", 5, "0");
			res.out("</TD><TD>");
			genTextField("Item-" + path + "-Visible", 10, "false");
			res.out("</TD><TD>");
			genTextField("Item-" + path + "-Editable", 10, "");
			res.out("</TD><TD>");
			genTextField("Item-" + path + "-Password", 10, "");
			res.out("</TD></TR>");
		}
	}
	res.out("</TABLE>\n");
	genButton("submit", "table item update");
	genHR();
	genButton("submit", "return");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeWebUiAdminSelectableEdit(list params, DbConnection conn);
body
{
	if (checkUserRole("webuiadmin")) {
	} else {
		return null;
	}
	var string submit, item;
	var string create_path, create_value;
	var integer idx, idx2, item_number, i, item_number2, i2;
	var string view_name, db_parts_name;
	var XmlDbAccessor acc, meta_acc;
	var XmlDbObject obj, obj2, obj3;
	var list ls, itr, itr2;
	var string msgType, msgVersion, dtd_filename, child_path, type, default;
	var string path, value, line_number;
	var string range_path, range_type, from, to;
	var string orderby_path, orderby_type, desc, count_from, count_max;
	var string column_name, column_value;
	var string column_name2, column_value2;
	var string visible, editable, password;
	if (view_name = session.getAttribute("view_name")) {
	} else {
		error("view name is not setted.");
		return null;
	}
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	ls = acc.get("WebUiData/Target", target);
	itr = al_dst_itr(ls);
	obj = al_next(itr);
	ls = obj.getChildren("WebUiData/MenuItem", "Name", view_name);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("view '" + (string)view_name + "' not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of view '" + (string)view_name + "' is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	if (db_parts_name = session.getAttribute("db_parts_name")) {
	} else {
		error("db parts name is not setted.");
		return null;
	}
	ls = obj.getChildren("View/UiElem", "Name", db_parts_name);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("db parts '" + (string)db_parts_name + "' not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of db_parts '" + (string)db_parts_name + "' is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	ls = obj.getChildren("Selectable/Children", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	itr = al_dst_itr(ls);
	submit = al_dst_node(params, "submit");
	item = al_dst_node(params, "radio");
	if (item = al_dst_node(params, "radio")) {
		idx = al_search_str(item, 0, "-");
		idx2 = al_search_str(item, 0, ":");
	} else {
		idx = idx2 =  - 1;
	}
	if (idx >= 0) {
		item_number = (integer)al_tail_str(item, idx + 1);
	} else {
		item_number = 0;
	}
	if (idx2 >= 0) {
		item_number2 = (integer)al_tail_str(item, idx2 + 1);
	} else {
		item_number2 = 0;
	}
	create_path = al_dst_node(params, "Create-Path");
	create_value = al_dst_node(params, "Create-Value");
	if (submit == "create") {
		if (create_path && create_path != "" && create_value && create_value != "") {
			if (obj2 = findItem(itr, item_number)) {
				i = (integer)obj2.getField("LineNumber") + 1;
				if (al_next(itr)) {
					incLineNumber(itr);
				} else {
				}
			} else {
				error("appropriate radio not checked.");
				return null;
			}
			obj = obj.createChild("Selectable/Children");
			obj.putField("LineNumber", (string)i);
			obj.putField("ChildPath", create_path);
			obj.putField("Type", create_value);
		} else {
			error("Path or Type is null.");
			return null;
		}
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "condition create") {
		if (create_path && create_path != "" && create_value && create_value != "") {
			if (obj2 = findItem(itr, item_number)) {
				ls = obj2.getChildren("Condition");
				itr2 = al_dst_itr(ls);
				if (obj3 = findItem(itr2, item_number2)) {
					i = (integer)obj3.getField("LineNumber") + 1;
					if (al_next(itr2)) {
						incLineNumber(itr2);
					} else {
					}
				} else {
					ls = obj2.getChildren("Condition");
					itr2 = al_dst_itr(ls);
					i = 1;
					incLineNumber(itr2);
				}
			} else {
				error("appropriate radio not checked.");
				return null;
			}
			obj = obj2.createChild("Condition");
			obj.putField("LineNumber", (string)i);
			obj.putField("Path", create_path);
			obj.putField("Value", create_value);
		} else {
			error("Path or Type is null.");
			return null;
		}
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "update") {
		if (item == "Children-1") {
			msgType = al_dst_node(params, "msgType");
			msgVersion = al_dst_node(params, "msgVersion");
			dtd_filename = al_dst_node(params, "DTDfilename");
			type = al_dst_node(params, "Type-1");
			default = al_dst_node(params, "Default-1");
			if (obj2 = findItem(itr, item_number)) {
			} else {
				error("appropriate radio not checked.");
				return null;
			}
			obj2.putField("MsgType", msgType);
			obj2.putField("MsgVersion", msgVersion);
			obj2.putField("DTDfilename", dtd_filename);
			obj2.putField("Type", type);
			obj2.putField("Default", default);
		} else {
			if (obj2 = findItem(itr, item_number)) {
				ls = obj2.getChildren("Condition");
				itr2 = al_dst_itr(ls);
				if (obj3 = findItem(itr2, item_number2)) {
					path = al_dst_node(params, "Cond-Path-" + (string)item_number + ":" + (string)item_number2);
					value = al_dst_node(params, "Cond-Value-" + (string)item_number + ":" + (string)item_number2);
					obj2.putField("LineNumber", (string)(item_number2 + 1));
					obj3.putField("Path", path);
					obj3.putField("Value", value);
				} else {
					child_path = al_dst_node(params, "ChildPath-" + (string)item_number);
					type = al_dst_node(params, "Type-" + (string)item_number);
					default = al_dst_node(params, "Default-" + (string)item_number);
					obj2.putField("LineNumber", (string)(item_number + 1));
					obj2.putField("ChildPath", child_path);
					obj2.putField("Type", type);
					obj2.putField("Default", default);
				}
			} else {
				error("appropriate radio not checked.");
				return null;
			}
		}
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "delete") {
		if (item == "Children-1") {
			error("msgType must not be deleted.");
			return null;
		} else {
			if (obj2 = findItem(itr, item_number)) {
				ls = obj2.getChildren("Condition");
				itr2 = al_dst_itr(ls);
				if (obj3 = findItem(itr2, item_number2)) {
					itr = itr2;
					obj2 = obj3;
				} else {
				}
			} else {
				error("appropriate radio not checked.");
				return null;
			}
			obj2.delete();
			decLineNumber(itr);
		}
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "up") {
		if (item == "Children-1") {
			error("this item is top.");
			return null;
		} else {
			if (obj2 = findItem(itr, item_number)) {
				ls = obj2.getChildren("Condition", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
				itr2 = al_dst_itr(ls);
				if (obj3 = findItem(itr2, item_number2)) {
					itr = itr2;
					obj2 = obj3;
				} else {
					if (item_number == 2) {
						error("msgType must be top.");
						return null;
					} else {
					}
				}
				if (obj3 = al_prev(itr)) {
				} else {
					error("appropriate radio not checked.");
					return null;
				}
			} else {
				error("appropriate radio not checked.");
				return null;
			}
			i = (integer)obj2.getField("LineNumber");
			i2 = (integer)obj3.getField("LineNumber");
			obj2.putField("LineNumber", (string)i2);
			obj3.putField("LineNumber", (string)i);
		}
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "down") {
		if (item == "Children-1") {
			error("msgType must be top.");
			return null;
		} else {
			if (obj2 = findItem(itr, item_number)) {
				ls = obj2.getChildren("Condition", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
				itr2 = al_dst_itr(ls);
				if (obj3 = findItem(itr2, item_number2)) {
					itr = itr2;
					obj2 = obj3;
				} else {
				}
				if (obj3 = al_next(itr)) {
				} else {
					error("appropriate radio not checked.");
					return null;
				}
			} else {
				error("appropriate radio not checked.");
				return null;
			}
			i = (integer)obj2.getField("LineNumber");
			i2 = (integer)obj3.getField("LineNumber");
			obj2.putField("LineNumber", (string)i2);
			obj3.putField("LineNumber", (string)i);
		}
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "condition update") {
		range_path = al_dst_node(params, "RangePath");
		range_type = al_dst_node(params, "RangeType");
		from = al_dst_node(params, "From");
		to = al_dst_node(params, "To");
		orderby_path = al_dst_node(params, "OrderByPath");
		orderby_type = al_dst_node(params, "OrderByType");
		desc = al_dst_node(params, "Desc");
		count_from = al_dst_node(params, "CountFrom");
		count_max = al_dst_node(params, "CountMax");
		column_name = al_dst_node(params, "ColumnName");
		column_value = al_dst_node(params, "ColumnValue");
		column_name2 = al_dst_node(params, "ColumnName2");
		column_value2 = al_dst_node(params, "ColumnValue2");
		obj.putField("Selectable/Condition2/RangePath", range_path);
		obj.putField("Selectable/Condition2/RangeType", range_type);
		obj.putField("Selectable/Condition2/From", from);
		obj.putField("Selectable/Condition2/To", to);
		obj.putField("Selectable/Condition2/OrderByPath", orderby_path);
		obj.putField("Selectable/Condition2/OrderByType", orderby_type);
		obj.putField("Selectable/Condition2/Desc", desc);
		obj.putField("Selectable/Condition2/CountFrom", count_from);
		obj.putField("Selectable/Condition2/CountMax", count_max);
		obj.putField("Selectable/Condition2/ColumnName", column_name);
		obj.putField("Selectable/Condition2/ColumnValue", column_value);
		obj.putField("Selectable/Condition2/ColumnName", column_name);
		obj.putField("Selectable/Condition2/ColumnValue2", column_value2);
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "condition delete") {
		obj.removeField("Selectable/Condition2/RangePath");
		obj.removeField("Selectable/Condition2/RangeType");
		obj.removeField("Selectable/Condition2/From");
		obj.removeField("Selectable/Condition2/To");
		obj.removeField("Selectable/Condition2/OrderByPath");
		obj.removeField("Selectable/Condition2/OrderByType");
		obj.removeField("Selectable/Condition2/Desc");
		obj.removeField("Selectable/Condition2/CountFrom");
		obj.removeField("Selectable/Condition2/CountMax");
		obj.removeField("Selectable/Condition2/ColumnName");
		obj.removeField("Selectable/Condition2/ColumnValue");
		obj.removeField("Selectable/Condition2/ColumnName2");
		obj.removeField("Selectable/Condition2/ColumnValue2");
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "table item update") {
		if (item && item != "") {
			path = al_dst_node(params, item + "-Path");
			ls = obj.getChildren("Selectable/TableItem");
			itr = al_dst_itr(ls);
			if (obj2 = findItem(itr, "Path", path)) {
			} else {
				obj2 = obj.createChild("Selectable/TableItem");
			}
			line_number = al_dst_node(params, item + "-LineNumber");
			visible = al_dst_node(params, item + "-Visible");
			visible = (visible == "true" ? "true" : "false");
			editable = al_dst_node(params, item + "-Editable");
			editable = (editable == "true" ? "true" : "false");
			password = al_dst_node(params, item + "-Password");
			password = (password == "true" ? "true" : "false");
			if (visible == "true") {
				obj2.putField("Path", path);
				obj2.putField("LineNumber", line_number);
				obj2.putField("Editable", editable);
				obj2.putField("Password", password);
			} else {
				obj2.delete();
			}
		} else {
			error("radio button not checked.");
			return null;
		}
		return invokeWebUiAdminSelectableHome(params, conn);
	} else {
	}
	if (submit == "return") {
		session.setAttribute("db_parts_name", null);
		return invokeWebUiAdminViewHome(params, conn);
	} else {
	}
}
end_body
member
public: XmlDbObject findItem(list itr, integer line_number);
body
{
	max_line_number = 0;
	if (line_number == null) {
		return null;
	} else {
	}
	var XmlDbObject obj;
	var integer i;
	loop {
		if (obj = al_next(itr)) {
		} else {
			return null;
		}
		max_line_number = i = (integer)obj.getField("LineNumber");
		if (i == line_number) {
			return obj;
		} else {
		}
	}
}
end_body
member
public: XmlDbObject findItem(list itr, string path, string value);
body
{
	var XmlDbObject obj;
	var string val;
	loop {
		if (obj = al_next(itr)) {
		} else {
			return null;
		}
		val = obj.getField(path);
		if (val == value) {
			return obj;
		} else {
		}
	}
}
end_body
member
public: integer max_line_number;
member
public: void incLineNumber(list itr);
body
{
	var XmlDbObject obj;
	var integer i;
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		i = (integer)obj.getField("LineNumber");
		i = i + 1;
		obj.putField("LineNumber", (string)i);
	}
}
end_body
member
public: void decLineNumber(list itr);
body
{
	var XmlDbObject obj;
	var integer i;
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		i = (integer)obj.getField("LineNumber");
		i = i - 1;
		obj.putField("LineNumber", (string)i);
	}
}
end_body
member
public: list invokeAdminHome(list params, DbConnection conn);
body
{
	if (checkUserRole("admin")) {
	} else {
		return null;
	}
	res.out("<HTML><HEAD>\n<META http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n");
	res.out("<TITLE>Altair Server Administration</TITLE></HEAD>\n");
	res.out("<FRAMESET COLS=\"20%,*\" FRAMEBORDER=\"YES\">\n");
	res.out("<FRAME SRC=\"ebiz?action=AdminMenu\" SCROLLING=\"auto\" NAME=\"menu\"/>\n");
	res.out("<FRAME SRC=\"home.html\" SCROLLING=\"auto\" NAME=\"action\"/>\n");
	res.out("</FRAMESET>\n");
	res.out("</HTML>\n");
	return null;
}
end_body
member
public: list invokeAdminMenu(list params, DbConnection conn);
body
{
	if (checkUserRole("admin")) {
	} else {
		return null;
	}
	return menu(params, conn);
}
end_body
member
public: list menu(list params, DbConnection conn);
body
{
	res.out("<HTML><HEAD>\n<META http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n");
	res.out("<BASE TARGET=\"action\"></HEAD><BODY>\n");
	{
		var XmlDbAccessor acc;
		var XmlDbObject obj;
		var list ls, itr, in_ul;
		acc = new XmlDbAccessor;
		acc.create("WebUiData", "", conn);
		acc.setDTDfilename("WebUiData.dtd");
		ls = acc.get("WebUiData/Target", admin_target);
		itr = al_dst_itr(ls);
		if (al_count(itr) == 0) {
			error("webuidata for target '" + admin_target + "' not found.");
			return null;
		} else {
		}
		if (al_count(itr) > 1) {
			error("number of webuidata for target '" + admin_target + "' is more than 1.");
			return null;
		} else {
		}
		obj = al_next(itr);
		ls = obj.getChildren("WebUiData/MenuItem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
		itr = al_dst_itr(ls);
		loop {
			if (obj = al_next(itr)) {
			} else {
				break;
			}
			var string name, kind, text;
			name = obj.getField("Name");
			kind = obj.getField("Kind");
			text = obj.getField("Text");
			if (kind == "Title") {
				if (in_ul) {
					res.out("</UL>\n");
					in_ul = null;
				} else {
				}
				genTitle(text);
			} else {
			}
			if (kind == "View" || kind == "RefreshView") {
				if (in_ul == null) {
					res.out("<UL>\n");
					in_ul = 1;
				} else {
				}
				res.out("<LI>");
				genLink("ebiz?action=" + (string)name, text);
			} else {
			}
		}
		if (in_ul) {
			res.out("</UL>\n");
			in_ul = null;
		} else {
		}
	}
	res.out("<A HREF=\"ebiz?action=Logout\" TARGET=\"_top\">Logout</A>\n");
	res.out("</BODY></HTML>\n");
	return null;
}
end_body
member
public: string adminMenuTarget(string target, string user_name);
body
{
	if (user_name) {
	} else {
		return null;
	}
	var integer idx;
	idx = al_search_str(user_name, 0, ":");
	if (idx >= 0) {
		user_name = al_tail_str(user_name, idx + 1);
	} else {
	}
	if (user_name != "admin") {
		return target;
	} else {
	}
	var string amt;
	var integer n, i, ch;
	amt = al_copy("");
	n = al_strlen(target);
	i = 0;
	loop {
		if (i < n) {
		} else {
			break;
		}
		ch = al_get_char(target, i);
		if (i == 0) {
			al_append_str(amt, ch);
		} else {
			if ('A' <= ch && ch <= 'Z') {
				return amt;
			} else {
				al_append_str(amt, ch);
			}
		}
		i = i + 1;
	}
	return amt;
}
end_body
member
public: list invokeView(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var XmlDbAccessor acc, data_acc;
	var XmlDbObject obj, obj2, obj3, data_obj;
	var list ls, itr, upload, itr2, itr3, cond, checked, values, data_ls, not_condition2, not_last;
	var string name, kind, text;
	var string path, value, child_path;
	var string msgType, msgVersion, dtd_filename, single_multi, default;
	var string range_path, range_type, from, to;
	var string order_path, order_type;
	var list desc;
	var integer count_from, count_max;
	var string column_name, column_value;
	var string column_name2, column_value2;
	var integer children_number;
	var list visibles, editables, passwords, visible, editable, password;
	var list edit_mode, checks, radio;
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	ls = acc.get("WebUiData/Target", (string)admin_target);
	itr = al_dst_itr(ls);
	if (al_count(itr) == 0) {
		error("webuidata for target '" + (string)admin_target + "' not found.");
		return null;
	} else {
	}
	if (al_count(itr) > 1) {
		error("number of webuidata for target '" + (string)admin_target + "' is more than 1.");
		return null;
	} else {
	}
	obj = al_next(itr);
	ls = obj.getChildren("WebUiData/MenuItem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		kind = obj.getField("Kind");
		name = obj.getField("Name");
		if ((kind == "View" || kind == "RefreshView") && name == action) {
			break;
		} else {
		}
	}
	if (kind == "View") {
		genPageBegin(action);
	} else {
		genRefreshPageBegin(action, 60);
	}
	genFormBegin(action, upload);
	genTitle(action);
	if (obj) {
		ls = obj.getChildren("View/UiElem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	} else {
		ls = al_cons(null, null);
	}
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		kind = obj.getField("Kind");
		if (kind == "Upload") {
			upload = 1;
		} else {
		}
	}
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		name = obj.getField("Name");
		kind = obj.getField("Kind");
		text = obj.getField("Text");
		if (kind == "Title") {
			genTitle(text);
		} else {
		}
		if (kind == "Text") {
			genText(text);
		} else {
		}
		if (kind == "Link") {
			genLink(name, text);
		} else {
		}
		if (kind == "BR") {
			genBR();
		} else {
		}
		if (kind == "Button") {
			genButton(name, text);
		} else {
		}
		if (kind == "Check") {
			genCheck(name, text, null);
		} else {
		}
		if (kind == "Radio") {
			genRadio(name, text, text, null);
		} else {
		}
		if (kind == "TextField") {
			genTextField(name, 20, getValue(text));
		} else {
		}
		if (kind == "Password") {
			genPassword(name, 20, getValue(text));
		} else {
		}
		if (kind == "TextArea") {
			genTextArea(name, 20, 72, getValue(text));
		} else {
		}
		if (kind == "Upload") {
			genUpload(name);
		} else {
		}
		if (kind == "Select" || kind == "Table1" || kind == "Table2") {
			not_condition2 = 1;
			loop {
				if (range_path = obj.getField("Selectable/Condition2/RangePath")) {
					range_path = getValue(range_path);
				} else {
					break;
				}
				if (range_type = obj.getField("Selectable/Condition2/RangeType")) {
					range_type = getValue(range_type);
				} else {
					break;
				}
				if (from = obj.getField("Selectable/Condition2/From")) {
					from = getValue(from);
				} else {
					break;
				}
				if (to = obj.getField("Selectable/Condition2/To")) {
					to = getValue(to);
				} else {
					break;
				}
				if (order_path = obj.getField("Selectable/Condition2/OrderByPath")) {
					order_path = getValue(order_path);
				} else {
					break;
				}
				if (order_type = obj.getField("Selectable/Condition2/OrderByType")) {
					order_type = getValue(order_type);
				} else {
					break;
				}
				if (desc = obj.getField("Selectable/Condition2/Desc")) {
					desc = (getValue((string)desc) == "true");
				} else {
					break;
				}
				if (column_name = obj.getField("Selectable/Condition2/ColumnName")) {
					column_name = getValue(column_name);
				} else {
					break;
				}
				if (column_value = obj.getField("Selectable/Condition2/ColumnValue")) {
					column_value = getValue(column_value);
				} else {
					break;
				}
				if (column_name2 = obj.getField("Selectable/Condition2/ColumnName2")) {
					column_name2 = getValue(column_name2);
				} else {
					break;
				}
				if (column_value2 = obj.getField("Selectable/Condition2/ColumnValue2")) {
					column_value2 = getValue(column_value2);
				} else {
					break;
				}
				not_condition2 = null;
				break;
			}
			if (count_from = obj.getField("Selectable/Condition2/CountFrom")) {
				if (count_from = getValue((string)count_from) && count_from != "") {
					count_from = (integer)count_from;
				} else {
					count_from = 1;
				}
			} else {
				count_from = 1;
			}
			if (count_max = obj.getField("Selectable/Condition2/CountMax")) {
				if (count_max = getValue((string)count_max) && count_max != "") {
					count_max = (integer)count_max;
				} else {
					count_max = 1000;
				}
			} else {
				count_max = 1000;
			}
			children_number = 1;
			ls = obj.getChildren("Selectable/Children", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
			itr2 = al_dst_itr(ls);
			if (obj2 = al_next(itr2)) {
			} else {
				error("First record containig MsgType not found.");
				return null;
			}
			msgType = obj2.getField("MsgType");
			msgVersion = obj2.getField("MsgVersion");
			dtd_filename = obj2.getField("DTDfilename");
			single_multi = obj2.getField("Type");
			default = getValue(obj2.getField("Default"));
			if (msgType && msgVersion && dtd_filename && single_multi) {
			} else {
				error("MsgType, MsgVersion, DTDfilename or Type is empty.");
				return null;
			}
			if (msgVersion = getValue(msgVersion)) {
			} else {
				error("can't get MsgType value.");
				return null;
			}
			if (msgVersion == "dbTable") {
				data_acc = new XmlDbTableAccessor;
			} else {
				data_acc = new XmlDbAccessor;
			}
			data_acc.create(msgType, msgVersion, conn);
			data_acc.setDTDfilename(dtd_filename);
			ls = obj2.getChildren("Condition");
			itr3 = al_dst_itr(ls);
			child_path = null;
			data_obj = null;
			data_ls = al_cons(null, null);
			cond = al_cons(null, null);
			loop {
				if (obj3 = al_next(itr3)) {
				} else {
					break;
				}
				path = obj3.getField("Path");
				value = obj3.getField("Value");
				value = getValue(value);
				if (path == msgType + "/Target" && value == "system") {
					continue;
				} else {
				}
				if (path && value) {
					al_create_arc(cond, value, path);
				} else {
				}
			}
			not_last = (al_next(itr2) != null);
			al_prev(itr2);
			if (single_multi == "single") {
				data_obj = getSingle(data_acc, cond);
			} else {
				if (single_multi == "multiple") {
					data_acc.count_max = count_max;
					if (not_last || not_condition2) {
						data_ls = getMultiple(data_acc, cond);
					} else {
						if (column_name && column_value && column_value != "") {
							al_create_arc(cond, column_value, column_name);
						} else {
						}
						if (column_name2 && column_value2 && column_value2 != "") {
							al_create_arc(cond, column_value2, column_name2);
						} else {
						}
						if (range_path && range_type && from && to && order_path && order_type) {
							data_ls = getMultiple(data_acc, cond, range_path, range_type, from, to, order_path, order_type, desc);
						} else {
							data_ls = getMultiple(data_acc, cond);
						}
					}
				} else {
					error("Type must be single or multiple. (name = " + (string)name + ")");
					return null;
				}
			}
			loop {
				if (obj2 = al_next(itr2)) {
				} else {
					break;
				}
				if (single_multi != "single") {
					error("nest parent must be single. (name = " + (string)name + ")");
					return null;
				} else {
				}
				child_path = obj2.getField("ChildPath");
				single_multi = obj2.getField("Type");
				default = getValue(obj2.getField("Default"));
				if (child_path == null) {
					error("ChildPath is null. (name = " + (string)name + ")");
					return null;
				} else {
				}
				ls = obj2.getChildren("Condition");
				itr3 = al_dst_itr(ls);
				cond = al_cons(null, null);
				loop {
					if (obj3 = al_next(itr3)) {
					} else {
						break;
					}
					path = obj3.getField("Path");
					value = obj3.getField("Value");
					if (path && value = getValue(value)) {
						al_create_arc(cond, value, path);
					} else {
					}
				}
				not_last = (al_next(itr2) != null);
				al_prev(itr2);
				if (single_multi == "single") {
					data_obj = getSingle(data_obj, child_path, cond);
				} else {
					if (single_multi == "multiple") {
						if (not_last || not_condition2) {
							data_ls = getMultiple(data_obj, child_path, cond);
						} else {
							if (column_name && column_value && column_value != "") {
								al_create_arc(cond, column_value, column_name);
							} else {
							}
							if (column_name2 && column_value2 && column_value2 != "") {
								al_create_arc(cond, column_value2, column_name2);
							} else {
							}
							if (range_path && range_type && from && to && order_path && order_type) {
								data_ls = getMultiple(data_obj, child_path, cond, range_path, range_type, from, to, order_path, order_type, desc);
							} else {
								data_ls = getMultiple(data_obj, child_path, cond);
							}
						}
					} else {
						error("Type must be single or multiple. (name = " + (string)name + ")");
						return null;
					}
				}
				children_number = children_number + 1;
			}
			if (kind == "Select") {
				if (single_multi != "multiple") {
					error("Type of Select must be multiple (name = " + (string)name + ")");
					return null;
				} else {
				}
				values = al_cons(null, null);
				itr2 = al_dst_itr(data_ls);
				loop {
					if (data_obj = al_next(itr2)) {
					} else {
						break;
					}
					ls = obj.getChildren("Selectable/TableItem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
					itr3 = al_dst_itr(ls);
					value = "";
					var string val;
					loop {
						if (obj2 = al_next(itr3)) {
						} else {
							break;
						}
						if (path = obj2.getField("Path")) {
						} else {
							continue;
						}
						if (val = data_obj.getField(path)) {
						} else {
							val = "";
						}
						if (value == "") {
							value = val;
						} else {
							value = value + ": " + val;
						}
					}
					al_create_arc(values, value, value == default);
				}
				values = al_misc("sort", values, al_list2(0, 0));
				genSelect(name, values);
			} else {
			}
			if (kind == "Table1") {
				if (single_multi != "single") {
					error("Type of Table1 must be single (name = " + (string)name + ")");
					return null;
				} else {
				}
				edit_mode = getValue(text);
				visibles = al_cons(null, null);
				editables = al_cons(null, null);
				passwords = al_cons(null, null);
				ls = obj.getChildren("Selectable/TableItem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
				itr3 = al_dst_itr(ls);
				loop {
					if (obj2 = al_next(itr3)) {
					} else {
						break;
					}
					if (path = obj2.getField("Path")) {
					} else {
						path = "";
					}
					if (edit_mode && editable = (integer)obj2.getField("Editable") && editable >= edit_mode) {
						editable = 1;
					} else {
						editable = null;
					}
					if (password = obj2.getField("Password") && password == "true") {
						password = 1;
					} else {
						password = null;
					}
					al_create_arc(visibles, al_copy(1), path);
					al_create_arc(editables, editable, path);
					al_create_arc(passwords, password, path);
				}
				if (edit_mode) {
					genTable1(data_obj, visibles, editables, passwords, null);
				} else {
					genTable1(data_obj, visibles, null, passwords, null);
				}
			} else {
			}
			if (kind == "Table2") {
				if (single_multi != "multiple") {
					error("Type of Table2 must be multiple (name = " + (string)name + ")");
					return null;
				} else {
				}
				radio = getValue(text);
				visibles = al_cons(null, null);
				checks = al_cons(null, null);
				ls = obj.getChildren("Selectable/TableItem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
				itr3 = al_dst_itr(ls);
				loop {
					if (obj2 = al_next(itr3)) {
					} else {
						break;
					}
					if (path = obj2.getField("Path")) {
					} else {
						path = "";
					}
					al_create_arc(visibles, al_copy(1), path);
				}
				if (radio && radio != "") {
					genTable2(data_ls, visibles, checks, (list)(radio == "check" ? null : radio), count_from, count_max, null);
				} else {
					genTable2(data_ls, visibles, null, null, count_from, count_max, null);
				}
			} else {
			}
		} else {
		}
	}
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: string getValue(string name);
body
{
	if (name == null || name == "*") {
		return null;
	} else {
	}
	var integer ch;
	if (al_strlen(name) == 0) {
		return name;
	} else {
	}
	ch = al_get_char(name, 0);
	if (ch == '@') {
		name = al_tail_str(name, 1);
		return al_dst_node(this, name);
	} else {
	}
	if (ch == '#') {
		name = al_tail_str(name, 1);
		return session.getAttribute(name);
	} else {
	}
	return name;
}
end_body
member
public: XmlDbObject getSingle(XmlDbAccessor acc, list cond);
body
{
	var list ls, itr;
	ls = acc.get(cond);
	itr = al_dst_itr(ls);
	if (al_count(itr) > 1) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "webui: record of " + acc.msgType + "-" + acc.msgVersion + " is more than 1.";
		throw ex;
	} else {
	}
	return al_next(itr);
}
end_body
member
public: XmlDbObject getSingle(XmlDbObject obj, string path, list cond);
body
{
	if (obj) {
	} else {
		return null;
	}
	var list ls, itr;
	ls = obj.getChildren(path, cond);
	itr = al_dst_itr(ls);
	if (al_count(itr) > 1) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "webui: record of " + obj.msgType + "-" + obj.msgVersion + " is more than 1.";
		throw ex;
	} else {
	}
	return al_next(itr);
}
end_body
member
public: list getMultiple(XmlDbAccessor acc, list cond);
body
{
	return acc.get(cond);
}
end_body
member
public: list getMultiple(XmlDbObject obj, string path, list cond);
body
{
	if (obj) {
	} else {
		return al_cons(null, null);
	}
	return obj.getChildren(path, cond);
}
end_body
member
public: list getMultiple(XmlDbAccessor acc, list cond, string range_path, string range_type, string from, string to, string order_path, string order_type, list desc);
body
{
	var list ls, itr;
	var XmlDbObject obj2;
	ls = acc.get(cond, range_path, range_type, from, to, order_path, order_type, desc);
	itr = al_dst_itr(ls);
	if (obj2 = al_prev(itr)) {
		session.setAttribute("range_end", obj2.getField(range_path));
	} else {
	}
	return ls;
}
end_body
member
public: list getMultiple(XmlDbObject obj, string path, list cond, string range_path, string range_type, string from, string to, string order_path, string order_type, list desc);
body
{
	if (obj) {
	} else {
		return al_cons(null, null);
	}
	var list ls, itr;
	var XmlDbObject obj2;
	var string value1, value2;
	ls = obj.getChildren(path, cond, range_path, range_type, from, to, order_path, order_type, desc);
	if (obj2 = al_prev(itr)) {
		session.setAttribute("range_end", obj2.getField(range_path));
	} else {
	}
	return ls;
}
end_body
member
public: list checkPath(string msgType, string msgVersion, string dtd_filename, string path, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	acc = new XmlDbAccessor;
	acc.create(msgType, msgVersion, conn);
	acc.setDTDfilename(dtd_filename);
	obj = acc.getMetaInfo();
	if (obj = acc.getMetaInfo() && al_dst_node(obj.xpath_list, path)) {
		return 1;
	} else {
		error("path '" + (string)path + "' not fonund in '" + (string)msgType + "'");
		return null;
	}
}
end_body
member
public: list checkFromTo(string from, string to);
body
{
	var list t;
	t = al_list4("String", 19, 19, "9999X99X99X99X99X99");
	if (al_xml("type_check", from, t, null)) {
		error("From time format must be 'yyy:MM:dd-HH:mm:ss'");
		return null;
	} else {
	}
	if (al_xml("type_check", to, t, null)) {
		error("To time format must be 'yyy:MM:dd-HH:mm:ss'");
		return null;
	} else {
	}
	return 1;
}
end_body
member
public: list invokeProcessDefinition(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, proc_def_name;
	submit = al_dst_node(params, "submit");
	proc_def_name = al_dst_node(params, "ProcessDefSelect");
	if (session.getAttribute("proc_def_name")) {
	} else {
		session.setAttribute("proc_def_name", "#");
	}
	if (submit == "Show") {
		session.setAttribute("proc_def_name", proc_def_name);
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeProcessInstance(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, proc_act_id, proc_id, act_id;
	var string column_name, column_value;
	var string column_name2, column_value2;
	submit = al_dst_node(params, "submit");
	proc_act_id = al_dst_node(params, "ProcActId");
	column_name = al_dst_node(params, "ColumnNameTextField");
	column_value = al_dst_node(params, "ColumnValueTextField");
	column_name2 = al_dst_node(params, "ColumnNameTextField2");
	column_value2 = al_dst_node(params, "ColumnValueTextField2");
	if (proc_act_id) {
		var list ls, itr;
		ls = al_str_misc("split", proc_act_id, ':');
		itr = al_dst_itr(ls);
		var string s;
		var file f;
		s = al_next(itr);
		f = al_file_open(s, "sr");
		proc_id = (string)al_file_read(f, "string");
		s = al_next(itr);
		f = al_file_open(s, "sr");
		act_id = (string)al_file_read(f, "string");
		if (proc_id == "0") {
			proc_id = null;
		} else {
		}
		if (act_id == "0") {
			act_id = null;
		} else {
		}
	} else {
	}
	if (session.getAttribute("process_inst_column_name")) {
	} else {
		session.setAttribute("process_inst_column_name", "ProcessQueue/Status");
	}
	if (session.getAttribute("process_inst_column_value")) {
	} else {
		session.setAttribute("process_inst_column_value", "");
	}
	if (session.getAttribute("process_inst_column_name2")) {
	} else {
		session.setAttribute("process_inst_column_name2", "ProcessQueue/ProcessDefName");
	}
	if (session.getAttribute("process_inst_column_value2")) {
	} else {
		session.setAttribute("process_inst_column_value2", "");
	}
	if (session.getAttribute("proc_id")) {
	} else {
		session.setAttribute("proc_id", "#");
	}
	if (session.getAttribute("act_id")) {
	} else {
		session.setAttribute("act_id", "#");
	}
	if (submit == "Show") {
		if (proc_act_id == null || proc_act_id == "") {
			session.setAttribute("proc_id", "#");
			session.setAttribute("act_id", "#");
		} else {
			session.setAttribute("proc_id", proc_id);
			session.setAttribute("act_id", act_id);
		}
		if (checkPath("ProcessQueue", "dbTable", "ProcessQueue.dtd", column_name, conn)) {
		} else {
			return null;
		}
		if (checkPath("ProcessQueue", "dbTable", "ProcessQueue.dtd", column_name2, conn)) {
		} else {
			return null;
		}
		session.setAttribute("process_inst_column_name", column_name);
		session.setAttribute("process_inst_column_value", column_value);
		session.setAttribute("process_inst_column_name2", column_name2);
		session.setAttribute("process_inst_column_value2", column_value2);
	} else {
	}
	if (submit == "Suspend") {
		if (proc_id == null || proc_id == "") {
			error("radio button is not selected.");
			return null;
		} else {
		}
		var ProcMgr mgr;
		mgr = new ProcMgr;
		mgr.suspend(proc_id, conn);
	} else {
	}
	if (submit == "Resume") {
		if (proc_id == null || proc_id == "") {
			error("radio button is not selected.");
			return null;
		} else {
		}
		var ProcMgr mgr;
		mgr = new ProcMgr;
		mgr.resume(proc_id, conn);
	} else {
	}
	if (submit == "Abort") {
		if (proc_id == null || proc_id == "") {
			error("radio button is not selected.");
			return null;
		} else {
		}
		var ProcMgr mgr;
		mgr = new ProcMgr;
		mgr.abort(proc_id, conn);
	} else {
	}
	if (submit == "Delete") {
		if (proc_id == null || proc_id == "") {
			error("radio button is not selected.");
			return null;
		} else {
		}
		var ProcMgr mgr;
		mgr = new ProcMgr;
		mgr.delete(proc_id, conn);
	} else {
	}
	if (submit == "Delete cleanup") {
		var ProcMgr mgr;
		mgr = new ProcMgr;
		mgr.deleteCleanup(conn);
	} else {
	}
	if (submit == "Delete all") {
		var ProcMgr mgr;
		mgr = new ProcMgr;
		mgr.deleteAll(conn);
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeTickerCheck(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	genPageBegin("Ticker Last TimeStamp");
	genTitle("Ticket Alive Check");
	genText("Last TimeStamp = " + (string)appServer.pe.sched.ticker_last_timestamp);
	genPageEnd();
	return null;
}
end_body
member
public: list invokeSystemLog(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit;
	var string range_path, from, to;
	var string order_path, count_max, desc;
	var string column_name, column_value;
	var string column_name2, column_value2;
	submit = al_dst_node(params, "submit");
	range_path = al_dst_node(params, "RangePathTextField");
	from = al_dst_node(params, "FromTextField");
	to = al_dst_node(params, "ToTextField");
	order_path = al_dst_node(params, "OrderByPathTextField");
	count_max = al_dst_node(params, "CountMaxTextField");
	desc = al_dst_node(params, "DescTextField");
	column_name = al_dst_node(params, "ColumnNameTextField");
	column_value = al_dst_node(params, "ColumnValueTextField");
	column_name2 = al_dst_node(params, "ColumnNameTextField2");
	column_value2 = al_dst_node(params, "ColumnValueTextField2");
	if (session.getAttribute("system_log_range_path")) {
	} else {
		session.setAttribute("system_log_range_path", "SystemLog/Time");
	}
	if (session.getAttribute("system_log_from")) {
	} else {
		session.setAttribute("system_log_from", "0000/00/00-00:00:00");
	}
	if (session.getAttribute("system_log_to")) {
	} else {
		session.setAttribute("system_log_to", "9999/99/99-99:99:99");
	}
	if (session.getAttribute("system_log_order_path")) {
	} else {
		session.setAttribute("system_log_order_path", "SystemLog/Time");
	}
	if (session.getAttribute("system_log_count_max")) {
	} else {
		session.setAttribute("system_log_count_max", "100");
	}
	if (session.getAttribute("system_log_desc")) {
	} else {
		session.setAttribute("system_log_desc", "true");
	}
	if (session.getAttribute("system_log_column_name")) {
	} else {
		session.setAttribute("system_log_column_name", "SystemLog/LogLevel");
	}
	if (session.getAttribute("system_log_column_value")) {
	} else {
		session.setAttribute("system_log_column_value", "");
	}
	if (session.getAttribute("system_log_column_name2")) {
	} else {
		session.setAttribute("system_log_column_name2", "SystemLog/Message");
	}
	if (session.getAttribute("system_log_column_value2")) {
	} else {
		session.setAttribute("system_log_column_value2", "");
	}
	if (submit == "Next") {
		var string str;
		if (str = session.getAttribute("range_end")) {
			if (desc == "true") {
				from = "0000/00/00-00:00:00";
				to = str;
			} else {
				from = str;
				to = "9999/99/99-99:99:99";
			}
		} else {
		}
	} else {
	}
	if (submit == "ShowLog" || submit == "Next") {
		if (checkFromTo(from, to)) {
		} else {
			return null;
		}
		if (checkPath("SystemLog", "dbTable", "SystemLog.dtd", range_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("SystemLog", "dbTable", "SystemLog.dtd", order_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("SystemLog", "dbTable", "SystemLog.dtd", column_name, conn)) {
		} else {
			return null;
		}
		if (checkPath("SystemLog", "dbTable", "SystemLog.dtd", column_name2, conn)) {
		} else {
			return null;
		}
		session.setAttribute("system_log_range_path", range_path);
		session.setAttribute("system_log_from", from);
		session.setAttribute("system_log_to", to);
		session.setAttribute("system_log_order_path", order_path);
		session.setAttribute("system_log_count_max", count_max);
		session.setAttribute("system_log_desc", desc);
		session.setAttribute("system_log_column_name", column_name);
		session.setAttribute("system_log_column_value", column_value);
		session.setAttribute("system_log_column_name2", column_name2);
		session.setAttribute("system_log_column_value2", column_value2);
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeCommLog(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, dataId;
	var string range_path, from, to;
	var string order_path, count_max, desc;
	var string column_name, column_value;
	var string column_name2, column_value2;
	submit = al_dst_node(params, "submit");
	dataId = al_dst_node(params, "dataId");
	range_path = al_dst_node(params, "RangePathTextField");
	from = al_dst_node(params, "FromTextField");
	to = al_dst_node(params, "ToTextField");
	order_path = al_dst_node(params, "OrderByPathTextField");
	count_max = al_dst_node(params, "CountMaxTextField");
	desc = al_dst_node(params, "DescTextField");
	column_name = al_dst_node(params, "ColumnNameTextField");
	column_value = al_dst_node(params, "ColumnValueTextField");
	column_name2 = al_dst_node(params, "ColumnNameTextField2");
	column_value2 = al_dst_node(params, "ColumnValueTextField2");
	if (session.getAttribute("comm_log_range_path")) {
	} else {
		session.setAttribute("comm_log_range_path", "CommLog/Time");
	}
	if (session.getAttribute("comm_log_from")) {
	} else {
		session.setAttribute("comm_log_from", "0000/00/00-00:00:00");
	}
	if (session.getAttribute("comm_log_to")) {
	} else {
		session.setAttribute("comm_log_to", "9999/99/99-99:99:99");
	}
	if (session.getAttribute("comm_log_order_path")) {
	} else {
		session.setAttribute("comm_log_order_path", "CommLog/Time");
	}
	if (session.getAttribute("comm_log_count_max")) {
	} else {
		session.setAttribute("comm_log_count_max", "100");
	}
	if (session.getAttribute("comm_log_desc")) {
	} else {
		session.setAttribute("comm_log_desc", "true");
	}
	if (session.getAttribute("comm_log_column_name")) {
	} else {
		session.setAttribute("comm_log_column_name", "CommLog/TransactionId");
	}
	if (session.getAttribute("comm_log_column_value")) {
	} else {
		session.setAttribute("comm_log_column_value", "");
	}
	if (session.getAttribute("comm_log_column_name2")) {
	} else {
		session.setAttribute("comm_log_column_name2", "CommLog/Reason");
	}
	if (session.getAttribute("comm_log_column_value2")) {
	} else {
		session.setAttribute("comm_log_column_value2", "");
	}
	if (submit == "Next") {
		var string str;
		if (str = session.getAttribute("range_end")) {
			if (desc == "true") {
				from = "0000/00/00-00:00:00";
				to = str;
			} else {
				from = str;
				to = "9999/99/99-99:99:99";
			}
		} else {
		}
	} else {
	}
	if (submit == "ShowLog" || submit == "Next") {
		if (checkFromTo(from, to)) {
		} else {
			return null;
		}
		if (checkPath("CommLog", "dbTable", "CommLog.dtd", range_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("CommLog", "dbTable", "CommLog.dtd", order_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("CommLog", "dbTable", "CommLog.dtd", column_name, conn)) {
		} else {
			return null;
		}
		if (checkPath("CommLog", "dbTable", "CommLog.dtd", column_name2, conn)) {
		} else {
			return null;
		}
		session.setAttribute("comm_log_range_path", range_path);
		session.setAttribute("comm_log_from", from);
		session.setAttribute("comm_log_to", to);
		session.setAttribute("comm_log_order_path", order_path);
		session.setAttribute("comm_log_count_max", count_max);
		session.setAttribute("comm_log_desc", desc);
		session.setAttribute("comm_log_column_name", column_name);
		session.setAttribute("comm_log_column_value", column_value);
		session.setAttribute("comm_log_column_name2", column_name2);
		session.setAttribute("comm_log_column_value2", column_value2);
	} else {
	}
	if (submit == "ShowMessage") {
		if (dataId && dataId != "") {
			var XmlDbAccessor acc;
			var XmlDbObject obj;
			var Context ctx;
			var string send_recv, msg_dir, msgId, filename, message;
			acc = new XmlDbTableAccessor;
			acc.create("CommLog", "", conn);
			acc.setDTDfilename("CommLog.dtd");
			ctx = new Context;
			try {
				obj = acc.get(dataId);
				send_recv = obj.getField("CommLog/SendRecv");
				msgId = obj.getField("CommLog/rawMsgId");
			} catch (AlException e) {
				error("required log recored not found; " + e.msg);
				return null;
			}
			try {
				if (send_recv == "send") {
					msg_dir = ctx.getMyProperty(target, "-- default setting --", "msg.send.dir", conn);
				} else {
				}
				if (send_recv == "recv") {
					msg_dir = ctx.getMyProperty(target, "-- default setting --", "msg.recv.dir", conn);
				} else {
				}
				if (msg_dir && msg_dir != "") {
				} else {
					error("message dirctory not found.");
					return null;
				}
				if (msgId && msgId != "") {
				} else {
					error("rawMsgId not found.");
					return null;
				}
				filename = msg_dir + "/" + msgId;
			} catch (AlException e) {
				error("my -- default setting -- not found: " + e.msg);
				return null;
			}
			try {
				message = FileUtility::readString(filename);
			} catch (AlException e) {
				error("raw message read error: " + e.msg);
				return null;
			}
			genPageBegin("Raw Message");
			res.out("<TABLE BORDER=\"1\"><TR><TD><PRE>\n");
			genText(message);
			res.out("</PRE></TD></TR></TABLE>");
			genPageEnd();
			return null;
		} else {
			error("radio button not checked.");
			return null;
		}
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeAccessLog(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit;
	var string range_path, from, to;
	var string order_path, count_max, desc;
	var string column_name, column_value;
	var string column_name2, column_value2;
	submit = al_dst_node(params, "submit");
	range_path = al_dst_node(params, "RangePathTextField");
	from = al_dst_node(params, "FromTextField");
	to = al_dst_node(params, "ToTextField");
	order_path = al_dst_node(params, "OrderByPathTextField");
	count_max = al_dst_node(params, "CountMaxTextField");
	desc = al_dst_node(params, "DescTextField");
	column_name = al_dst_node(params, "ColumnNameTextField");
	column_value = al_dst_node(params, "ColumnValueTextField");
	column_name2 = al_dst_node(params, "ColumnNameTextField2");
	column_value2 = al_dst_node(params, "ColumnValueTextField2");
	if (session.getAttribute("access_log_range_path")) {
	} else {
		session.setAttribute("access_log_range_path", "AccessLog/Time");
	}
	if (session.getAttribute("access_log_from")) {
	} else {
		session.setAttribute("access_log_from", "0000/00/00-00:00:00");
	}
	if (session.getAttribute("access_log_to")) {
	} else {
		session.setAttribute("access_log_to", "9999/99/99-99:99:99");
	}
	if (session.getAttribute("access_log_order_path")) {
	} else {
		session.setAttribute("access_log_order_path", "AccessLog/Time");
	}
	if (session.getAttribute("access_log_count_max")) {
	} else {
		session.setAttribute("access_log_count_max", "100");
	}
	if (session.getAttribute("access_log_desc")) {
	} else {
		session.setAttribute("access_log_desc", "true");
	}
	if (session.getAttribute("access_log_column_name")) {
	} else {
		session.setAttribute("access_log_column_name", "AccessLog/Path");
	}
	if (session.getAttribute("access_log_column_value")) {
	} else {
		session.setAttribute("access_log_column_value", "");
	}
	if (session.getAttribute("access_log_column_name2")) {
	} else {
		session.setAttribute("access_log_column_name2", "AccessLog/ResponseCode");
	}
	if (session.getAttribute("access_log_column_value2")) {
	} else {
		session.setAttribute("access_log_column_value2", "");
	}
	if (submit == "Next") {
		var string str;
		if (str = session.getAttribute("range_end")) {
			if (desc == "true") {
				from = "0000/00/00-00:00:00";
				to = str;
			} else {
				from = str;
				to = "9999/99/99-99:99:99";
			}
		} else {
		}
	} else {
	}
	if (submit == "ShowLog" || submit == "Next") {
		if (checkFromTo(from, to)) {
		} else {
			return null;
		}
		if (checkPath("AccessLog", "dbTable", "AccessLog.dtd", range_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("AccessLog", "dbTable", "AccessLog.dtd", order_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("AccessLog", "dbTable", "AccessLog.dtd", column_name, conn)) {
		} else {
			return null;
		}
		if (checkPath("AccessLog", "dbTable", "AccessLog.dtd", column_name2, conn)) {
		} else {
			return null;
		}
		session.setAttribute("access_log_range_path", range_path);
		session.setAttribute("access_log_from", from);
		session.setAttribute("access_log_to", to);
		session.setAttribute("access_log_order_path", order_path);
		session.setAttribute("access_log_count_max", count_max);
		session.setAttribute("access_log_desc", desc);
		session.setAttribute("access_log_column_name", column_name);
		session.setAttribute("access_log_column_value", column_value);
		session.setAttribute("access_log_column_name2", column_name2);
		session.setAttribute("access_log_column_value2", column_value2);
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeProxyLog(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit;
	var string range_path, from, to;
	var string order_path, count_max, desc;
	var string column_name, column_value;
	var string column_name2, column_value2;
	submit = al_dst_node(params, "submit");
	range_path = al_dst_node(params, "RangePathTextField");
	from = al_dst_node(params, "FromTextField");
	to = al_dst_node(params, "ToTextField");
	order_path = al_dst_node(params, "OrderByPathTextField");
	count_max = al_dst_node(params, "CountMaxTextField");
	desc = al_dst_node(params, "DescTextField");
	column_name = al_dst_node(params, "ColumnNameTextField");
	column_value = al_dst_node(params, "ColumnValueTextField");
	column_name2 = al_dst_node(params, "ColumnNameTextField2");
	column_value2 = al_dst_node(params, "ColumnValueTextField2");
	if (session.getAttribute("proxy_log_range_path")) {
	} else {
		session.setAttribute("proxy_log_range_path", "ProxyLog/Time");
	}
	if (session.getAttribute("proxy_log_from")) {
	} else {
		session.setAttribute("proxy_log_from", "0000/00/00-00:00:00");
	}
	if (session.getAttribute("proxy_log_to")) {
	} else {
		session.setAttribute("proxy_log_to", "9999/99/99-99:99:99");
	}
	if (session.getAttribute("proxy_log_order_path")) {
	} else {
		session.setAttribute("proxy_log_order_path", "ProxyLog/Time");
	}
	if (session.getAttribute("proxy_log_count_max")) {
	} else {
		session.setAttribute("proxy_log_count_max", "100");
	}
	if (session.getAttribute("proxy_log_desc")) {
	} else {
		session.setAttribute("proxy_log_desc", "true");
	}
	if (session.getAttribute("proxy_log_column_name")) {
	} else {
		session.setAttribute("proxy_log_column_name", "ProxyLog/Path");
	}
	if (session.getAttribute("proxy_log_column_value")) {
	} else {
		session.setAttribute("proxy_log_column_value", "");
	}
	if (session.getAttribute("proxy_log_column_name2")) {
	} else {
		session.setAttribute("proxy_log_column_name2", "ProxyLog/Reason");
	}
	if (session.getAttribute("proxy_log_column_value2")) {
	} else {
		session.setAttribute("proxy_log_column_value2", "");
	}
	if (submit == "Next") {
		var string str;
		if (str = session.getAttribute("range_end")) {
			if (desc == "true") {
				from = "0000/00/00-00:00:00";
				to = str;
			} else {
				from = str;
				to = "9999/99/99-99:99:99";
			}
		} else {
		}
	} else {
	}
	if (submit == "ShowLog" || submit == "Next") {
		if (checkFromTo(from, to)) {
		} else {
			return null;
		}
		if (checkPath("ProxyLog", "dbTable", "ProxyLog.dtd", range_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("ProxyLog", "dbTable", "ProxyLog.dtd", order_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("ProxyLog", "dbTable", "ProxyLog.dtd", column_name, conn)) {
		} else {
			return null;
		}
		if (checkPath("ProxyLog", "dbTable", "ProxyLog.dtd", column_name2, conn)) {
		} else {
			return null;
		}
		session.setAttribute("proxy_log_range_path", range_path);
		session.setAttribute("proxy_log_from", from);
		session.setAttribute("proxy_log_to", to);
		session.setAttribute("proxy_log_order_path", order_path);
		session.setAttribute("proxy_log_count_max", count_max);
		session.setAttribute("proxy_log_desc", desc);
		session.setAttribute("proxy_log_column_name", column_name);
		session.setAttribute("proxy_log_column_value", column_value);
		session.setAttribute("proxy_log_column_name2", column_name2);
		session.setAttribute("proxy_log_column_value2", column_value2);
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeProcessLog(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit;
	var string range_path, from, to;
	var string order_path, count_max, desc;
	var string column_name, column_value;
	var string column_name2, column_value2;
	submit = al_dst_node(params, "submit");
	range_path = al_dst_node(params, "RangePathTextField");
	from = al_dst_node(params, "FromTextField");
	to = al_dst_node(params, "ToTextField");
	order_path = al_dst_node(params, "OrderByPathTextField");
	count_max = al_dst_node(params, "CountMaxTextField");
	desc = al_dst_node(params, "DescTextField");
	column_name = al_dst_node(params, "ColumnNameTextField");
	column_value = al_dst_node(params, "ColumnValueTextField");
	column_name2 = al_dst_node(params, "ColumnNameTextField2");
	column_value2 = al_dst_node(params, "ColumnValueTextField2");
	if (session.getAttribute("process_log_range_path")) {
	} else {
		session.setAttribute("process_log_range_path", "ProcessLog/Time");
	}
	if (session.getAttribute("process_log_from")) {
	} else {
		session.setAttribute("process_log_from", "0000/00/00-00:00:00");
	}
	if (session.getAttribute("process_log_to")) {
	} else {
		session.setAttribute("process_log_to", "9999/99/99-99:99:99");
	}
	if (session.getAttribute("process_log_order_path")) {
	} else {
		session.setAttribute("process_log_order_path", "ProcessLog/Time");
	}
	if (session.getAttribute("process_log_count_max")) {
	} else {
		session.setAttribute("process_log_count_max", "100");
	}
	if (session.getAttribute("process_log_desc")) {
	} else {
		session.setAttribute("process_log_desc", "true");
	}
	if (session.getAttribute("process_log_column_name")) {
	} else {
		session.setAttribute("process_log_column_name", "ProcessLog/Action");
	}
	if (session.getAttribute("process_log_column_value")) {
	} else {
		session.setAttribute("process_log_column_value", "");
	}
	if (session.getAttribute("process_log_column_name2")) {
	} else {
		session.setAttribute("process_log_column_name2", "ProcessLog/ProcessId");
	}
	if (session.getAttribute("process_log_column_value2")) {
	} else {
		session.setAttribute("process_log_column_value2", "");
	}
	if (submit == "Next") {
		var string str;
		if (str = session.getAttribute("range_end")) {
			if (desc == "true") {
				from = "0000/00/00-00:00:00";
				to = str;
			} else {
				from = str;
				to = "9999/99/99-99:99:99";
			}
		} else {
		}
	} else {
	}
	if (submit == "ShowLog" || submit == "Next") {
		if (checkFromTo(from, to)) {
		} else {
			return null;
		}
		if (checkPath("ProcessLog", "dbTable", "ProcessLog.dtd", range_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("ProcessLog", "dbTable", "ProcessLog.dtd", order_path, conn)) {
		} else {
			return null;
		}
		if (checkPath("ProcessLog", "dbTable", "ProcessLog.dtd", column_name, conn)) {
		} else {
			return null;
		}
		if (checkPath("ProcessLog", "dbTable", "ProcessLog.dtd", column_name2, conn)) {
		} else {
			return null;
		}
		session.setAttribute("process_log_range_path", range_path);
		session.setAttribute("process_log_from", from);
		session.setAttribute("process_log_to", to);
		session.setAttribute("process_log_order_path", order_path);
		session.setAttribute("process_log_count_max", count_max);
		session.setAttribute("process_log_desc", desc);
		session.setAttribute("process_log_column_name", column_name);
		session.setAttribute("process_log_column_value", column_value);
		session.setAttribute("process_log_column_name2", column_name2);
		session.setAttribute("process_log_column_value2", column_value2);
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeBackupLog(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, op;
	var string from, to;
	var string comm_log, message, raw_message, xpath_id;
	var string system_log, access_log, proxy_log, process_log, log_files;
	var string err;
	submit = al_dst_node(params, "submit");
	op = al_dst_node(params, "op");
	if (submit == "Execute" && op == null) {
		error("please select operation type");
		return null;
	} else {
	}
	from = al_dst_node(params, "FromTextField");
	to = al_dst_node(params, "ToTextField");
	if (comm_log = al_dst_node(params, "CommLog")) {
		comm_log = al_str_misc("to_lower", comm_log, null);
	} else {
	}
	if (message = al_dst_node(params, "Message")) {
		message = al_str_misc("to_lower", message, null);
	} else {
	}
	if (raw_message = al_dst_node(params, "RawMessage")) {
		raw_message = al_str_misc("to_lower", raw_message, null);
	} else {
	}
	if (xpath_id = al_dst_node(params, "XPathId")) {
		xpath_id = al_str_misc("to_lower", xpath_id, null);
	} else {
	}
	if (system_log = al_dst_node(params, "SystemLog")) {
		system_log = al_str_misc("to_lower", system_log, null);
	} else {
	}
	if (access_log = al_dst_node(params, "AccessLog")) {
		access_log = al_str_misc("to_lower", access_log, null);
	} else {
	}
	if (proxy_log = al_dst_node(params, "ProxyLog")) {
		proxy_log = al_str_misc("to_lower", proxy_log, null);
	} else {
	}
	if (process_log = al_dst_node(params, "ProcessLog")) {
		process_log = al_str_misc("to_lower", process_log, null);
	} else {
	}
	if (log_files = al_dst_node(params, "LogFiles")) {
		log_files = al_str_misc("to_lower", log_files, null);
	} else {
	}
	if (from == null || from == "") {
		from = session.getAttribute("backup_log_from");
	} else {
	}
	if (from == null || from == "") {
		from = "0000/00/00-00:00:00";
	} else {
	}
	if (to == null || to == "") {
		to = session.getAttribute("backup_log_to");
	} else {
	}
	if (to == null || to == "") {
		var RNContext ctx;
		var string time_str;
		var integer time;
		ctx = new RNContext;
		if (time_str = ctx.getMyProperty("-- default setting --", "backup.span", conn)) {
			time = al_misc("get_time", null, null) - getTime(time_str);
			time = al_misc("get_localtime", time, null);
			to = al_misc("format_time", time, "yyyy'/'MM'/'dd'-'HH':'mm':'ss");
		} else {
			to = "9999/99/99-99:99:99";
		}
	} else {
	}
	if (checkFromTo(from, to)) {
	} else {
		return null;
	}
	session.setAttribute("backup_log_from", from);
	session.setAttribute("backup_log_to", to);
	if (submit == "Execute" && (op == "backup" || op == "delete" || op == "backup&delete" || op == "doRestore")) {
		var DataMgr mgr;
		mgr = new DataMgr;
		var list props;
		props = al_cons(null, null);
		al_set_dst_node(props, "CommLog", comm_log == "on");
		al_set_dst_node(props, "Message", message == "on");
		al_set_dst_node(props, "RawMessage", raw_message == "on");
		al_set_dst_node(props, "XPathId", xpath_id == "on");
		al_set_dst_node(props, "SystemLog", system_log == "on");
		al_set_dst_node(props, "AccessLog", access_log == "on");
		al_set_dst_node(props, "ProxyLog", proxy_log == "on");
		al_set_dst_node(props, "ProcessLog", process_log == "on");
		al_set_dst_node(props, "LogFiles", log_files == "on");
		if (err = mgr.start_backup_job(target, user_name, op, from, to, props, req._server.documentRoot, req.input_file)) {
			error(err);
			return null;
		} else {
		}
		op = "show status";
	} else {
	}
	if (submit == "Execute" && op == "restore") {
		genPageBegin("Restore");
		res.out("<FORM METHOD=\"POST\" ACTION=\"upload?action=BackupLog&submit=Execute&op=doRestore\" ENCTYPE=\"multipart/form-data\">\n");
		genText("Restore");
		genBR();
		res.out("<INPUT TYPE=\"file\" NAME=\"restoreFile\"/>");
		genButton("restore", "Restore");
		res.out("</FORM>\n");
		genPageEnd();
		return null;
	} else {
	}
	if (submit == "erace performed") {
		var DataMgr mgr;
		mgr = new DataMgr;
		mgr.erace_backup_jobs();
		submit = "Execute";
		op = "show status";
	} else {
	}
	if (submit == "refresh") {
		var DataMgr mgr;
		mgr = new DataMgr;
		if (err = mgr.refresh_backup_jobs()) {
			error(err);
			return null;
		} else {
		}
		submit = "Execute";
		op = "show status";
	} else {
	}
	if (submit == "Execute" && op == "show status") {
		genPageBegin("Backup Status");
		genFormBegin("BackupLog", null);
		genTitle("Backup Status");
		res.out("<TABLE BORDER=\"1\">\n");
		res.out("<TR><TD>user</TD><TD>operation</TD><TD>from</TD><TD>to</TD><TD>status</TD></TR>\n");
		var list itr, job;
		itr = al_dst_itr(DataMgr::jobs);
		loop {
			if (job = al_next(itr)) {
			} else {
				break;
			}
			res.out("<TR><TD>");
			genText((string)al_dst_node(job, "user"));
			res.out("</TD><TD>");
			genText((string)al_dst_node(job, "op"));
			res.out("</TD><TD>");
			genText((string)al_dst_node(job, "from"));
			res.out("</TD><TD>");
			genText((string)al_dst_node(job, "to"));
			res.out("</TD><TD>");
			genText((string)al_dst_node(job, "status"));
			res.out("</TD></TR>\n");
		}
		res.out("</TABLE>\n");
		genButton("submit", "refresh");
		genButton("submit", "erace performed");
		genBR();
		genBR();
		genText("download from ");
		genLink("/admin/backup/backup.tar.gz", "here");
		genText(" after backup job is completed.");
		genFormEnd();
		genPageEnd();
		return null;
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeUser(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, user, new_user, new_pass, add_role, remove_role;
	submit = al_dst_node(params, "submit");
	user = fromUTF8((list)al_dst_node(params, "UserSelect"));
	new_user = fromUTF8((list)al_dst_node(params, "User/UserId"));
	new_pass = al_dst_node(params, "User/Password");
	add_role = fromUTF8((list)al_dst_node(params, "AddRoleName"));
	remove_role = fromUTF8((list)al_dst_node(params, "RemoveRoleName"));
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	var list ls, itr;
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	if (submit == "Show") {
		session.setAttribute("target_user_id", user);
		session.setAttribute("edit_mode", null);
	} else {
	}
	if (submit == "Create") {
		session.setAttribute("target_user_id", "#");
		session.setAttribute("edit_mode", 1);
	} else {
	}
	if (submit == "Edit") {
		if (user == null || user == "") {
			error("user id is empty.");
			return null;
		} else {
		}
		session.setAttribute("target_user_id", user);
		session.setAttribute("edit_mode", 2);
	} else {
	}
	if (submit == "Delete") {
		// delete user
		if (obj = getUser(acc, user, conn)) {
			obj.delete();
		} else {
			error("user '" + (string)user + "' not found.");
			return null;
		}
		session.setAttribute("target_user_id", "#");
		session.setAttribute("edit_mode", null);
	} else {
	}
	if (submit == "submit for Create/Edit") {
		var string target_user_id;
		if (target_user_id = session.getAttribute("target_user_id")) {
		} else {
			error("target user id is not setted.");
			return null;
		}
		if (target_user_id == "#") {
			// create user
			if (new_user == null || new_user == "") {
				error("new user id is empty.");
				return null;
			} else {
			}
			if (new_user == "#") {
				error("'#' can't be used as user id.");
				return null;
			} else {
			}
			if (new_pass == null || new_pass == "") {
				error("password is empty.");
				return null;
			} else {
			}
			if (obj = getUser(acc, new_user, conn)) {
				error("user '" + new_user + "' already exists.");
				return null;
			} else {
				obj = acc.create();
				obj.putField("User/Target", target);
				obj.putField("User/Id", target + ":" + new_user);
				obj.putField("User/UserId", new_user);
				obj.putField("User/Password", new_pass);
				session.setAttribute("target_user_id", target + ":" + new_user);
				session.setAttribute("edit_mode", null);
			}
		} else {
			// change password
			if (new_pass == null || new_pass == "") {
				error("password is empty.");
				return null;
			} else {
			}
			if (obj = getUser(acc, target_user_id, conn)) {
				obj.putField("User/Password", new_pass);
				session.setAttribute("target_user_id", target_user_id);
				session.setAttribute("edit_mode", null);
			} else {
				error("user '" + target_user_id + "' not found.");
				return null;
			}
		}
	} else {
	}
	if (submit == "AddRole") {
		if (user == null || user == "") {
			error("user id is empty.");
			return null;
		} else {
		}
		if (obj = getUser(acc, user, conn)) {
			if (add_role == null || add_role == "") {
				error("add role name is empty.");
				return null;
			} else {
			}
			ls = obj.getChildren("User/RoleName", "", (string)add_role);
			itr = al_dst_itr(ls);
			if (obj2 = al_next(itr)) {
				error("already has role '" + add_role + "'.");
				return null;
			} else {
			}
			obj2 = obj.createChild("User/RoleName");
			obj2.putField("", add_role);
			session.setAttribute("target_user_id", user);
			session.setAttribute("edit_mode", null);
		} else {
			error("user '" + (string)user + "' not found.");
			return null;
		}
	} else {
	}
	if (submit == "RemoveRole") {
		if (user == null || user == "") {
			error("user id is empty.");
			return null;
		} else {
		}
		if (obj = getUser(acc, user, conn)) {
			if (remove_role == null || remove_role == "") {
				error("remove role name is empty.");
				return null;
			} else {
			}
			ls = obj.getChildren("User/RoleName", "", (string)remove_role);
			itr = al_dst_itr(ls);
			if (obj2 = al_next(itr)) {
				obj2.delete();
				session.setAttribute("target_user_id", user);
				session.setAttribute("edit_mode", null);
			} else {
				error("does not have role '" + remove_role + "'.");
				return null;
			}
		} else {
			error("user '" + (string)user + "' not found.");
			return null;
		}
	} else {
	}
	if (session.getAttribute("target_user_id")) {
	} else {
		session.setAttribute("target_user_id", "#");
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeMyInfo(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, myinfo_id;
	var string my_id, my_biz_id, my_role;
	var string prop_name, prop_value;
	submit = al_dst_node(params, "submit");
	myinfo_id = fromUTF8((list)al_dst_node(params, "MyInfoSelect"));
	my_id = fromUTF8((list)al_dst_node(params, "MyInfo/Id"));
	my_biz_id = fromUTF8((list)al_dst_node(params, "MyInfo/BusinessId"));
	my_role = fromUTF8((list)al_dst_node(params, "MyInfo/MyRole"));
	prop_name = fromUTF8((list)al_dst_node(params, "PropertyName"));
	prop_value = fromUTF8((list)al_dst_node(params, "PropertyValue"));
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	var list ls, itr;
	acc = new XmlDbAccessor;
	acc.create("MyInfo", "", conn);
	acc.setDTDfilename("MyInfo.dtd");
	if (submit == "Show") {
		session.setAttribute("target_myinfo_id", myinfo_id);
		session.setAttribute("edit_mode", null);
	} else {
	}
	if (submit == "Create") {
		session.setAttribute("target_myinfo_id", "#");
		session.setAttribute("edit_mode", 1);
	} else {
	}
	if (submit == "Edit") {
		if (myinfo_id == null || myinfo_id == "") {
			error("my id is empty.");
			return null;
		} else {
		}
		session.setAttribute("target_myinfo_id", myinfo_id);
		session.setAttribute("edit_mode", 2);
	} else {
	}
	if (submit == "Delete") {
		// delete my info
		if (obj = getMyInfo(acc, myinfo_id, conn)) {
			obj.delete();
		} else {
			error("my info '" + (string)myinfo_id + "' not found.");
			return null;
		}
	} else {
	}
	if (submit == "submit for Create/Edit") {
		var string target_myinfo_id;
		if (target_myinfo_id = session.getAttribute("target_myinfo_id")) {
		} else {
			error("target my id is not setted.");
			return null;
		}
		if (target_myinfo_id == "#") {
			// create my info
			if (my_id == null || my_id == "") {
				error("new my id is empty.");
				return null;
			} else {
			}
			if (obj = getMyInfo(acc, my_id, conn)) {
				error("my id '" + my_id + "' already exists.");
				return null;
			} else {
			}
			obj = acc.create();
			obj.putField("MyInfo/Target", admin_target);
			obj.putField("MyInfo/Id", admin_target + ":" + my_id);
			obj.putField("MyInfo/BusinessId", my_biz_id);
			obj.putField("MyInfo/MyRole", my_role);
			session.setAttribute("target_myinfo_id", admin_target + ":" + my_id);
			session.setAttribute("edit_mode", null);
		} else {
			// edit my info
			if (obj = getMyInfo(acc, target_myinfo_id, conn)) {
				obj.putField("MyInfo/BusinessId", my_biz_id);
				obj.putField("MyInfo/MyRole", my_role);
				session.setAttribute("target_myinfo_id", target_myinfo_id);
				session.setAttribute("edit_mode", null);
			} else {
				error("my id '" + target_myinfo_id + "' not found.");
				return null;
			}
		}
	} else {
	}
	if (submit == "submit for Create/Update") {
		// create or update my properties
		if (myinfo_id == null || myinfo_id == "") {
			error("my id is empty.");
			return null;
		} else {
		}
		if (obj = getMyInfo(acc, myinfo_id, conn)) {
		} else {
			error("my id '" + (string)myinfo_id + "' not found.");
			return null;
		}
		if (prop_name == null || prop_name == "") {
			error("property name is empty.");
			return null;
		} else {
		}
		ls = obj.getChildren("MyInfo/Properties", "Name", prop_name);
		itr = al_dst_itr(ls);
		if (obj2 = al_next(itr)) {
			obj2.putField("Value", prop_value);
		} else {
			obj2 = obj.createChild("MyInfo/Properties");
			obj2.putField("Name", prop_name);
			obj2.putField("Value", prop_value);
		}
	} else {
	}
	if (submit == "submit for Delete") {
		// remove my properties
		if (myinfo_id == null || myinfo_id == "") {
			error("my id is empty.");
			return null;
		} else {
		}
		if (obj = getMyInfo(acc, myinfo_id, conn)) {
		} else {
			error("my id '" + (string)myinfo_id + "' not found.");
			return null;
		}
		ls = obj.getChildren("MyInfo/Properties");
		itr = al_dst_itr(ls);
		loop {
			var list checked;
			if (obj2 = al_next(itr)) {
			} else {
				break;
			}
			checked = al_dst_node(params, obj2.dataId);
			if (al_is_type(checked, "string") && al_str_misc("strcmpi", checked, "on") == 0) {
				obj2.delete();
			} else {
			}
		}
	} else {
	}
	if (session.getAttribute("target_myinfo_id")) {
	} else {
		session.setAttribute("target_myinfo_id", "#");
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokePartnerInfo(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, partnerinfo_id;
	var string partner_id, partner_biz_id, msg_type, my_role, partner_role;
	var string prop_name, prop_value;
	submit = al_dst_node(params, "submit");
	partnerinfo_id = fromUTF8((list)al_dst_node(params, "PartnerInfoSelect"));
	partner_id = fromUTF8((list)al_dst_node(params, "PartnerInfo/Id"));
	partner_biz_id = fromUTF8((list)al_dst_node(params, "PartnerInfo/BusinessId"));
	msg_type = fromUTF8((list)al_dst_node(params, "PartnerInfo/MsgType"));
	my_role = fromUTF8((list)al_dst_node(params, "PartnerInfo/MyRole"));
	partner_role = fromUTF8((list)al_dst_node(params, "PartnerInfo/PartnerRole"));
	prop_name = fromUTF8((list)al_dst_node(params, "PropertyName"));
	prop_value = fromUTF8((list)al_dst_node(params, "PropertyValue"));
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	var list ls, itr;
	acc = new XmlDbAccessor;
	acc.create("PartnerInfo", "", conn);
	acc.setDTDfilename("PartnerInfo.dtd");
	if (submit == "Show") {
		session.setAttribute("target_partnerinfo_id", partnerinfo_id);
		session.setAttribute("edit_mode", null);
	} else {
	}
	if (submit == "Create") {
		session.setAttribute("target_partnerinfo_id", "#");
		session.setAttribute("edit_mode", 1);
	} else {
	}
	if (submit == "Edit") {
		if (partnerinfo_id == null || partnerinfo_id == "") {
			error("partner id is empty.");
			return null;
		} else {
		}
		session.setAttribute("target_partnerinfo_id", partnerinfo_id);
		session.setAttribute("edit_mode", 2);
	} else {
	}
	if (submit == "Delete") {
		// delete partner info
		if (obj = getPartnerInfo(acc, partnerinfo_id, conn)) {
			obj.delete();
		} else {
			error("partner '" + (string)partnerinfo_id + "' not found.");
			return null;
		}
	} else {
	}
	if (submit == "submit for Create/Edit") {
		var string target_partnerinfo_id;
		if (target_partnerinfo_id = session.getAttribute("target_partnerinfo_id")) {
		} else {
			error("target partner id is not setted.");
			return null;
		}
		if (target_partnerinfo_id == "#") {
			// create partner info
			if (partner_id == null || partner_id == "") {
				error("new partner id is empty.");
				return null;
			} else {
			}
			if (obj = getPartnerInfo(acc, partner_id, conn)) {
				error("partner '" + partner_id + "' already exists.");
				return null;
			} else {
			}
			obj = acc.create();
			obj.putField("PartnerInfo/Target", admin_target);
			obj.putField("PartnerInfo/Id", admin_target + ":" + partner_id);
			obj.putField("PartnerInfo/BusinessId", partner_biz_id);
			obj.putField("PartnerInfo/MsgType", msg_type);
			obj.putField("PartnerInfo/MyRole", my_role);
			obj.putField("PartnerInfo/PartnerRole", partner_role);
			session.setAttribute("target_partnerinfo_id", admin_target + ":" + partner_id);
			session.setAttribute("edit_mode", null);
		} else {
			// edit partner info
			if (obj = getPartnerInfo(acc, target_partnerinfo_id, conn)) {
				obj.putField("PartnerInfo/BusinessId", partner_biz_id);
				obj.putField("PartnerInfo/MsgType", msg_type);
				obj.putField("PartnerInfo/MyRole", my_role);
				obj.putField("PartnerInfo/PartnerRole", partner_role);
				session.setAttribute("target_partnerinfo_id", target_partnerinfo_id);
				session.setAttribute("edit_mode", null);
			} else {
				error("partner '" + target_partnerinfo_id + "' not found.");
				return null;
			}
		}
	} else {
	}
	if (submit == "submit for Create/Update") {
		// create or update partner properties
		if (partnerinfo_id == null || partnerinfo_id == "") {
			error("partner id is empty.");
			return null;
		} else {
		}
		if (obj = getPartnerInfo(acc, partnerinfo_id, conn)) {
		} else {
			error("partner '" + (string)partnerinfo_id + "' not found.");
			return null;
		}
		if (prop_name == null || prop_name == "") {
			error("property name is empty.");
			return null;
		} else {
		}
		ls = obj.getChildren("PartnerInfo/Properties", "Name", prop_name);
		itr = al_dst_itr(ls);
		if (obj2 = al_next(itr)) {
			obj2.putField("Value", prop_value);
		} else {
			obj2 = obj.createChild("PartnerInfo/Properties");
			obj2.putField("Name", prop_name);
			obj2.putField("Value", prop_value);
		}
	} else {
	}
	if (submit == "submit for Delete") {
		// remove partner properties
		if (partnerinfo_id == null || partnerinfo_id == "") {
			error("partner id is empty.");
			return null;
		} else {
		}
		if (obj = getPartnerInfo(acc, partnerinfo_id, conn)) {
		} else {
			error("partner '" + (string)partnerinfo_id + "' not found.");
			return null;
		}
		ls = obj.getChildren("PartnerInfo/Properties");
		itr = al_dst_itr(ls);
		loop {
			var list checked;
			if (obj2 = al_next(itr)) {
			} else {
				break;
			}
			checked = al_dst_node(params, obj2.dataId);
			if (al_is_type(checked, "string") && al_str_misc("strcmpi", checked, "on") == 0) {
				obj2.delete();
			} else {
			}
		}
	} else {
	}
	if (session.getAttribute("target_partnerinfo_id")) {
	} else {
		session.setAttribute("target_partnerinfo_id", "#");
	}
	return invokeView(params, conn);
}
end_body
member
public: XmlDbObject getUser(XmlDbAccessor acc, string user, DbConnection conn);
body
{
	var list ls, itr;
	ls = acc.get("User/Id", user);
	itr = al_dst_itr(ls);
	return al_next(itr);
}
end_body
member
public: XmlDbObject getMyInfo(XmlDbAccessor acc, string my_id, DbConnection conn);
body
{
	var list ls, itr;
	ls = acc.get("MyInfo/Id", my_id);
	itr = al_dst_itr(ls);
	return al_next(itr);
}
end_body
member
public: XmlDbObject getPartnerInfo(XmlDbAccessor acc, string partner_id, DbConnection conn);
body
{
	var list ls, itr;
	ls = acc.get("PartnerInfo/Id", partner_id);
	itr = al_dst_itr(ls);
	return al_next(itr);
}
end_body
member
public: list invokeBackupSetting(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeRestart(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit;
	submit = al_dst_node(params, "submit");
	if (submit == "Restart") {
		res.system_command = "restart";
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeShutdown(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit;
	submit = al_dst_node(params, "submit");
	if (submit == "Shutdown") {
		res.system_command = "shutdown";
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeCacheClear(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, op;
	submit = al_dst_node(params, "submit");
	op = al_dst_node(params, "op");
	if (submit == "Clear") {
		if (op == null) {
			error("please check kind");
			return null;
		} else {
		}
		if (op == "DTD") {
			XmlUtility::dtd_cache = null;
		} else {
		}
		if (op == "XSL") {
			XmlUtility::xsl_cache = null;
		} else {
		}
		if (op == "hostaddr") {
			ProxyClientConnection::hostaddr_cache = null;
		} else {
		}
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeGC(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit;
	submit = al_dst_node(params, "submit");
	if (submit == "doGC") {
		var list r;
		var integer recycled, free, used;
		r = al_gc(null);
		recycled = r.head;
		free = r.tail.head;
		used = r.tail.tail.head;
		genPageBegin("GC Result");
		genText("recycled = " + (string)recycled);
		genBR();
		genText("free = " + (string)free);
		genBR();
		genText("used = " + (string)used);
		genBR();
		genPageEnd();
		return null;
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeShell(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, pwd, cmd, output, filename, content;
	submit = al_dst_node(params, "submit");
	if (pwd = session.getAttribute("shell_pwd")) {
	} else {
		pwd = al_file_manip("get_dir", null, null);
		session.setAttribute("shell_pwd", pwd);
	}
	if (submit == "cd") {
		pwd = al_dst_node(params, "pwd");
		if (pwd != "") {
			session.setAttribute("shell_pwd", pwd);
		} else {
		}
		session.setAttribute("shell_output", "");
	} else {
	}
	if (submit == "exec") {
		cmd = al_dst_node(params, "cmd");
		output = al_copy("");
		if (cmd != "") {
			session.setAttribute("shell_cmd", cmd);
			var list pipe;
			var integer pid;
			pipe = al_file_open("", "pipe");
			if (pid = al_exec(cmd, pwd, null, pipe)) {
				var string line;
				loop {
					if (line = al_file_read(pipe, "line")) {
						if (line == 0x0000000080000000) {
							al_next_process();
							continue;
						} else {
						}
					} else {
						break;
					}
					al_append_str(output, line);
					al_append_str(output, "\n");
				}
			} else {
				output = "fail to execute '" + cmd + "'";
			}
		} else {
		}
		session.setAttribute("shell_output", output);
	} else {
	}
	if (submit == "put") {
		filename = al_dst_node(params, "filename");
		content = al_dst_node(params, "output");
		session.setAttribute("shell_filename", filename);
		if (filename != "") {
			try {
				FileUtility::writeBinary(pwd + "/" + filename, content);
				session.setAttribute("shell_output", "[INFO] file '" + pwd + "/" + filename + "' created.");
			} catch (AlException e) {
				session.setAttribute("shell_output", "[ERROR] " + (string)e.msg);
			}
		} else {
		}
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: void genPageBegin(string title);
body
{
	res.out("<HTML><HEAD>\n<META http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n<TITLE>");
	res.out(toUTF8(title));
	res.out("</TITLE></HEAD><BODY>\n");
}
end_body
member
public: void genRefreshPageBegin(string title, integer interval);
body
{
	res.out("<HTML><HEAD>\n<META http-equiv=\"Refresh\" content=\"");
	res.out((string)interval);
	res.out("; charset=UTF-8\">\n<TITLE>");
	res.out(toUTF8(title));
	res.out("</TITLE><BODY>\n");
}
end_body
member
public: void genPageEnd();
body
{
	res.out("</BODY></HTML>\n");
}
end_body
member
public: void genFormBegin(string action, list upload);
body
{
	res.out("<FORM METHOD=\"POST\" ACTION=\"ebiz?action=");
	res.out(action);
	res.out("\"");
	if (upload) {
		res.out(" ENCTYPE=\"multipart/form-data\"");
	} else {
	}
	res.out(">\n");
}
end_body
member
public: void genFormEnd();
body
{
	res.out("</FORM>\n");
}
end_body
member
public: void genTitle(string text);
body
{
	res.out("<H3>");
	res.out(toUTF8(text));
	res.out("</H3>\n");
}
end_body
member
public: void genText(string text);
body
{
	res.out(toUTF8(text));
}
end_body
member
public: void genLink(string path, string text);
body
{
	res.out("<A HREF=\"");
	res.out(path);
	res.out("\">");
	res.out(toUTF8(text));
	res.out("</A>\n");
}
end_body
member
public: void genBR();
body
{
	res.out("<BR/>\n");
}
end_body
member
public: void genHR();
body
{
	res.out("<HR/>\n");
}
end_body
member
public: void genButton(string name, string value);
body
{
	res.out("<INPUT TYPE=\"submit\" NAME=\"");
	res.out(name);
	res.out("\" VALUE=\"");
	res.out(toUTF8(value));
	res.out("\"/>\n");
}
end_body
member
public: void genTextField(string name, integer size, string value);
body
{
	res.out("<INPUT TYPE=\"text\" NAME=\"");
	res.out(name);
	res.out("\" VALUE=\"");
	res.out(toUTF8(value));
	res.out("\" SIZE=\"");
	res.out((string)size);
	res.out("\"/>\n");
}
end_body
member
public: void genPassword(string name, integer size, string value);
body
{
	res.out("<INPUT TYPE=\"password\" NAME=\"");
	res.out(name);
	res.out("\" VALUE=\"");
	res.out(toUTF8(value));
	res.out("\" SIZE=\"");
	res.out((string)size);
	res.out("\"/>\n");
}
end_body
member
public: void genTextArea(string name, integer rows, integer cols, string value);
body
{
	res.out("<TEXTAREA NAME=\"");
	res.out(name);
	res.out("\" ROWS=\"");
	res.out((string)rows);
	res.out("\" COLS=\"");
	res.out((string)cols);
	res.out("\">\n");
	res.out(toUTF8(value));
	res.out("</TEXTAREA>\n");
}
end_body
member
public: void genCheck(string name, string text, list checked);
body
{
	res.out("<INPUT TYPE=\"checkBox\" NAME=\"");
	res.out(name);
	res.out("\"");
	if (checked) {
		res.out(" CHECKED=\"true\"");
	} else {
	}
	res.out("/>");
	res.out(toUTF8(text));
	res.out("\n");
}
end_body
member
public: void genRadio(string name, string value, string text, list checked);
body
{
	res.out("<INPUT TYPE=\"radio\" NAME=\"");
	res.out(name);
	res.out("\" VALUE=\"");
	res.out(toUTF8(value));
	res.out("\"");
	if (checked) {
		res.out(" CHECKED=\"true\"");
	} else {
	}
	res.out("/>");
	res.out(toUTF8(text));
	res.out("\n");
}
end_body
member
public: void genHidden(string name, string value);
body
{
	res.out("<INPUT TYPE=\"hidden\" NAME=\"");
	res.out(name);
	res.out("\" VALUE=\"");
	res.out(toUTF8(value));
	res.out("\"/>\n");
}
end_body
member
public: void genUpload(string name);
body
{
	res.out("<INPUT TYPE=\"file\" NAME=\"");
	res.out(name);
	res.out("\"/>\n");
}
end_body
member
public: void genSelect(string name, list values);
body
{
	res.out("<SELECT NAME=\"");
	res.out(name);
	res.out("\" SIZE=\"1\">\n");
	var string value;
	var list itr;
	itr = al_dst_itr(values);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		res.out("  <OPTION");
		if (al_arc_a(itr)) {
			res.out(" SELECTED=\"true\"");
		} else {
		}
		res.out(">");
		res.out(toUTF8(value));
		res.out("</OPTION>\n");
	}
	res.out("</SELECT>\n");
}
end_body
member
public: void genTable1(XmlDbObject obj, list visibles, list editables, list passwords, list io_map);
body
{
	res.out("<TABLE BORDER=\"1\">\n");
	var list itr;
	var string path, disp_name, value;
	itr = al_dst_itr(visibles);
	loop {
		if (al_next(itr)) {
		} else {
			break;
		}
		path = al_arc_a(itr);
		if (obj) {
			value = obj.getField(path);
		} else {
			value = "";
		}
		if (value == null || value == XmlUtility::ctrl_a) {
			value = "";
		} else {
		}
		if (io_map && disp_name = al_dst_node(io_map, path)) {
		} else {
			disp_name = al_str_misc("chg_delimiter", path, al_list2('/', ' '));
		}
		res.out("<TR><TD>");
		res.out(toUTF8(disp_name));
		res.out("</TD><TD>");
		if (editables && al_dst_node(editables, path)) {
			if (al_dst_node(passwords, path)) {
				genPassword(path, 20, value);
			} else {
				genTextField(path, 20, value);
			}
		} else {
			if (al_dst_node(passwords, path)) {
				genText("********");
			} else {
				genText(value);
			}
		}
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
}
end_body
member
public: void genTable2(list objs, list visibles, list checks, list radio, integer count_from, integer count_max, list io_map);
body
{
	res.out("<TABLE BORDER=\"1\">\n");
	var XmlDbObject obj;
	var list itr, itr2;
	var string path, disp_name, value;
	var integer count;
	itr2 = al_dst_itr(visibles);
	res.out("<TR>");
	if (checks) {
		res.out("<TD></TD>");
	} else {
	}
	loop {
		if (al_next(itr2)) {
		} else {
			break;
		}
		path = al_arc_a(itr2);
		if (io_map && disp_name = al_dst_node(io_map, path)) {
		} else {
			disp_name = al_str_misc("chg_delimiter", path, al_list2('/', ' '));
		}
		res.out("<TD>");
		res.out(toUTF8(disp_name));
		res.out("</TD>");
	}
	res.out("</TR>\n");
	itr = al_dst_itr(objs);
	count = 1;
	loop {
		if (count_from > 1 && count < count_from) {
		} else {
			break;
		}
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		count = count + 1;
	}
	obj = 1;
	loop {
		if (count_max > 0 && count > count_max) {
			break;
		} else {
		}
		if (obj && obj = al_next(itr)) {
		} else {
			break;
		}
		count = count + 1;
		res.out("<TR>");
		if (checks) {
			res.out("<TD>");
			var list checked;
			checked = al_dst_node(checks, obj.dataId);
			if (radio) {
				genRadio((string)radio, obj.dataId, "", checked);
			} else {
				genCheck(obj.dataId, "", checked);
			}
			res.out("</TD>");
		} else {
		}
		itr2 = al_dst_itr(visibles);
		loop {
			if (al_next(itr2)) {
			} else {
				break;
			}
			path = al_arc_a(itr2);
			value = obj.getField(path);
			if (io_map && disp_name = al_dst_node(io_map, path)) {
			} else {
				disp_name = path;
			}
			if (value == null || value == XmlUtility::ctrl_a) {
				value = "";
			} else {
			}
			res.out("<TD>");
			genText(value);
			res.out("</TD>");
		}
		res.out("</TR>\n");
	}
	res.out("</TABLE>\n");
}
end_body
member
public: string toUTF8(string str);
body
{
	return HttpServlet::toUTF8(str);
}
end_body
member
public: string fromUTF8(string str);
body
{
	return HttpServlet::fromUTF8(str);
}
end_body
member
public: string fromUTF8(list str);
body
{
	return HttpServlet::fromUTF8(str);
}
end_body
member
public: void invokeTest(list params, DbConnection conn);
body
{
	dumpProps(params);
	invokeTestWebUiParts(params, conn);
}
end_body
member
public: void dumpProps(list params);
body
{
	al_print("==== begin Dump params <<<<\n");
	var list itr;
	var string name, value;
	itr = al_dst_itr(params);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		name = fromUTF8((string)al_arc_a(itr));
		value = fromUTF8(value);
		al_print("name = " + (string)name + ", value = " + (string)value + "\n");
	}
	al_print("==== end Dump params >>>>\n");
}
end_body
member
public: void invokeTestWebUiParts(list params, DbConnection conn);
body
{
	genPageBegin("Title");
	genTitle("Title");
	genFormBegin("NextAction&fileparam=file", (list)1);
	genButton("button", "Button");
	genBR();
	genTextField("text/a/b/c", 20, "TextField");
	genPassword("pass", 20, "inamoto");
	genBR();
	genCheck("check1", "Check1", null);
	genCheck("check2", "Check2", (list)1);
	genCheck("check3", "Check3", null);
	genBR();
	genRadio("radio", "radio1", "Radio1", null);
	genRadio("radio", "radio2", "Radio2", (list)1);
	genRadio("radio", "radio3", "Radio3", null);
	genBR();
	genUpload("file");
	var list values;
	values = al_cons(null, null);
	al_create_arc(values, "Item1", null);
	al_create_arc(values, "Item2", 1);
	al_create_arc(values, "Item3", null);
	genBR();
	genSelect("select", values);
	genBR();
	genTextArea("textArea", 15, 50, "TextArea");
	{
		var XmlDbAccessor acc;
		var string msgId;
		var XmlDbObject obj, obj2;
		var list children, itr;
		acc = new XmlDbAccessor;
		acc.create("Pip3A4PurchaseOrderRequest", "", conn);
		acc.setDTDfilename("rosetta/3A4PurchaseOrderRequestMessageGuideline_v1_1.dtd");
		msgId = "6";
		// obj = acc.get(msgId);
		// genTable1(obj, obj.xpath_list, null, null);
		// genTable1(obj, obj.xpath_list, obj.xpath_list, null);
		// children = obj.getChildren("Pip3A4PurchaseOrderRequest/PurchaseOrder/ProductLineItem");
		// itr = al_dst_itr(children);
		// if (obj2 = al_next(itr)) {
		if (null) {
			// genTable2(children, obj2.xpath_list, null, null, null);
			// genTable2(children, obj2.xpath_list, obj2.xpath_list, null, null);
			// genTable2(children, obj2.xpath_list, obj2.xpath_list, (list)"table_radio", null);
		} else {
		}
	}
	genFormEnd();
	genPageEnd();
}
end_body
member
public: void invokeNextAction(list params, DbConnection conn);
body
{
	dumpProps(params);
}
end_body
member
public: string date_str(list datetime);
body
{
	var string yyyy, mm, dd, str;
	yyyy = datetime.head;
	mm = datetime.tail.head;
	dd = datetime.tail.tail.head;
	str = (string)yyyy + "/";
	if (mm < 10) {
		str = str + "0";
	} else {
	}
	str = str + (string)mm + "/";
	if (dd < 10) {
		str = str + "0";
	} else {
	}
	str = str + (string)dd;
	return str;
}
end_body
member
public: string date_str_2(list datetime);
body
{
	var string yyyy, mm, dd, str;
	yyyy = datetime.head;
	mm = datetime.tail.head;
	dd = datetime.tail.tail.head;
	str = (string)yyyy;
	if (mm < 10) {
		str = str + "0";
	} else {
	}
	str = str + (string)mm;
	if (dd < 10) {
		str = str + "0";
	} else {
	}
	str = str + (string)dd;
	return str;
}
end_body
member
public: list date_xml(list datetime);
body
{
	var string yyyy, mm, dd, str;
	var file f;
	var list xml;
	yyyy = datetime.head;
	mm = datetime.tail.head;
	dd = datetime.tail.tail.head;
	str = al_copy("");
	al_append_str(str, "<Date>");
	al_append_str(str, "<Year>");
	al_append_str(str, (string)yyyy);
	al_append_str(str, "</Year>");
	al_append_str(str, "<Month>");
	al_append_str(str, (string)mm);
	al_append_str(str, "</Month>");
	al_append_str(str, "<Day>");
	al_append_str(str, (string)dd);
	al_append_str(str, "</Day>");
	al_append_str(str, "</Date>");
	f = al_file_open(str, "sr");
	xml = al_xml("parse", f, null, null);
	xml = xml.head;
	return xml;
}
end_body
member
public: string from_date_html(list xml);
body
{
	var string xml_str;
	xml_str = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/from_date.xsl", xml);
	return xml_str;
}
end_body
member
public: string to_date_html(list xml);
body
{
	var string xml_str;
	xml_str = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/to_date.xsl", xml);
	return xml_str;
}
end_body
member
public: integer date_int(string date_str);
body
{
	var list ls, itr;
	var integer yyyy, mm, dd;
	ls = al_str_misc("split", date_str, '/');
	itr = al_dst_itr(ls);
	yyyy = (integer)al_next(itr);
	mm = (integer)al_next(itr);
	dd = (integer)al_next(itr);
	return al_list6(yyyy, mm, dd, 0, 0, 0);
}
end_body
class WebUIbizsoftServlet
class WebUIbizsoftCustomerServlet
member
public: void doGet(HttpRequest req, HttpResponse res);
body
{
	this.req = req;
	this.res = res;
	var list params;
	params = req.getParameters();
	action = (string)al_dst_node(params, "action");
	if (session = req.getSession()) {
		target = session.getAttribute("target");
		user_name = session.getAttribute("user_name");
		user_roles = session.getAttribute("user_roles");
		admin_target = adminMenuTarget(target, user_name);
	} else {
		session = req.createSession();
		session.setAttribute("target", "bizsoftCustomer");
	}
	doAction(params);
}
end_body
member
public: void doPost(HttpRequest req, HttpResponse res);
body
{
	this.req = req;
	this.res = res;
	var list params;
	params = req.getParameters();
	action = (string)al_dst_node(params, "action");
	if (session = req.getSession()) {
		target = session.getAttribute("target");
		user_name = session.getAttribute("user_name");
		user_roles = session.getAttribute("user_roles");
		admin_target = adminMenuTarget(target, user_name);
		if (al_search_str(action, 0, "Login") < 0) {
		} else {
			target = fromUTF8((list)al_dst_node(params, "target"));
			if (target == null || target == "") {
				target = "system";
			} else {
			}
			user_name = target + ":" + (string)fromUTF8((list)al_dst_node(params, "user"));
		}
	} else {
		if (al_search_str(action, 0, "Login") < 0 && session == null) {
			error("no session");
			return;
		} else {
			target = fromUTF8((list)al_dst_node(params, "target"));
			if (target == null || target == "") {
				target = "system";
			} else {
			}
			user_name = target + ":" + (string)fromUTF8((list)al_dst_node(params, "user"));
		}
	}
	doAction(params);
}
end_body
member
public: list invokeProductList(list params, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	var string xml_str1, xml_str2;
	var list xml2;
	acc = new XmlDbAccessor;
	acc.create("Products", "", conn);
	acc.setDTDfilename("bizsoft/stock/stock.dtd");
	xml_str2 = acc.getXML("product_stock");
	var file f;
	f = al_file_open(xml_str2, "sr");
	xml2 = al_xml("parse", f, null, null);
	xml2 = xml2.head;
	xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/sales/product_list.xsl", xml2);
	genPageBegin("ProductList");
	res.out(toUTF8_direct(xml_str1));
	genPageEnd();
	return null;
}
end_body
member
public: list invokeCart(list params, DbConnection conn);
body
{
	var string product_name, product_id;
	var integer unit_price, total_price, tax, sales_price;
	var string e_product, e_license, start_date, end_date;
	var integer num, delivery;
	var list cart, itr;
	var string submit;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	if (cart = session.getAttribute("cart")) {
	} else {
		cart = al_cons(null, null);
		session.setAttribute("cart", cart);
	}
	if (submit == "C") {
		itr = al_dst_itr(cart);
		loop {
			if (al_next(itr)) {
			} else {
				break;
			}
			product_id = al_arc_a(itr);
			num = (integer)al_dst_node(params, product_id);
			if (num <= 0) {
				al_remove(itr);
			} else {
				al_set_dst_node(cart, product_id, num);
			}
		}
	} else {
	}
	if (submit == "") {
		if (user_name) {
			res.redirectWithSession("ebiz?action=Buy");
			return null;
		} else {
			res.redirectWithSession("login.html");
			return null;
		}
	} else {
	}
	if (submit == "null") {
		product_id = al_dst_node(params, "product");
	} else {
	}
	if (submit == "null" && product_id) {
		if (num = al_dst_node(cart, product_id)) {
			num = num + 1;
		} else {
			num = 1;
		}
		al_set_dst_node(cart, product_id, num);
	} else {
	}
	if (consumer_tax_rate) {
	} else {
		try {
			var XmlDbAccessor acc;
			var XmlDbObject obj;
			var list ls, itr;
			acc = new XmlDbAccessor;
			acc.create("TaxRate", "", conn);
			acc.setDTDfilename("bizsoft/finance/tax_rate.dtd");
			ls = acc.getAll();
			itr = al_dst_itr(ls);
			if (obj = al_next(itr)) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "}X^[B";
				throw ex;
			}
			ls = obj.getChildren("}X^[/", "", "");
			itr = al_dst_itr(ls);
			if (obj = al_next(itr) && consumer_tax_rate = obj.getField("")) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "B";
				throw ex;
			}
		} catch (AlException e) {
			throw e;
		}
	}
	var string xml_str1, xml_str2;
	itr = al_dst_itr(cart);
	xml_str2 = al_copy("<EBIZ>");
	total_price = delivery = 0;
	loop {
		if (num = al_next(itr)) {
		} else {
			break;
		}
		product_id = al_arc_a(itr);
		try {
			var XmlDbAccessor acc;
			var XmlDbObject obj1, obj2;
			var list ls2, itr2;
			acc = new XmlDbAccessor;
			acc.create("Products", "", conn);
			acc.setDTDfilename("bizsoft/stock/stock.dtd");
			obj1 = acc.get("product_stock");
			ls2 = obj1.getChildren("i}X^[/i", "^", product_id);
			itr2 = al_dst_itr(ls2);
			if (obj2 = al_next(itr2)) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "^ " + (string)product_id + " iB";
				throw ex;
			}
			product_name = obj2.getField("i");
			e_product = obj2.getField("dq}");
			e_license = obj2.getField("CZX");
			if (e_license == "Yes") {
				var integer period, date_int;
				var list date1, date2;
				if (al_str_misc("ends_with", product_id, "L01")) {
					period = 1;
				} else {
					if (al_str_misc("ends_with", product_id, "L03")) {
						period = 3;
					} else {
						if (al_str_misc("ends_with", product_id, "L12")) {
							period = 12;
						} else {
							error("CZX^B");
							return null;
						}
					}
				}
				date_int = al_misc("get_time", null, null);
				date1 = al_misc("get_localtime", date_int, null);
				date_int = date_int + 60 * 60 * 24 * 31 * period;
				date2 = al_misc("get_localtime", date_int, null);
				start_date = al_misc("format_time", date1, "yyyy'/'MM'/'dd");
				end_date = al_misc("format_time", date2, "yyyy'/'MM'/'dd");
			} else {
				delivery = 1000;
				start_date = end_date = "";
			}
			unit_price = (integer)obj2.getField("P");
			total_price = total_price + unit_price * num;
			al_append_str(xml_str2, "<i>");
			al_append_str(xml_str2, "<i>");
			al_append_str(xml_str2, product_name);
			al_append_str(xml_str2, "</i>");
			al_append_str(xml_str2, "<^>");
			al_append_str(xml_str2, product_id);
			al_append_str(xml_str2, "</^>");
			al_append_str(xml_str2, "<^>");
			al_append_str(xml_str2, product_id);
			al_append_str(xml_str2, "</^>");
			al_append_str(xml_str2, "<dq}>");
			al_append_str(xml_str2, e_product);
			al_append_str(xml_str2, "</dq}>");
			al_append_str(xml_str2, "<CZX>");
			al_append_str(xml_str2, e_license);
			al_append_str(xml_str2, "</CZX>");
			al_append_str(xml_str2, "<Jn>");
			al_append_str(xml_str2, start_date);
			al_append_str(xml_str2, "</Jn>");
			al_append_str(xml_str2, "<I>");
			al_append_str(xml_str2, end_date);
			al_append_str(xml_str2, "</I>");
			al_append_str(xml_str2, "<P>");
			al_append_str(xml_str2, (string)unit_price);
			al_append_str(xml_str2, "</P>");
			al_append_str(xml_str2, "<>");
			al_append_str(xml_str2, (string)num);
			al_append_str(xml_str2, "</>");
			al_append_str(xml_str2, "<i>");
			al_append_str(xml_str2, (string)(unit_price * num));
			al_append_str(xml_str2, "</i>");
			al_append_str(xml_str2, "</i>");
		} catch (AlException e) {
			throw e;
		}
	}
	tax = total_price * (integer)consumer_tax_rate / 100;
	sales_price = total_price + tax + delivery;
	al_append_str(xml_str2, "<v>");
	al_append_str(xml_str2, (string)total_price);
	al_append_str(xml_str2, "</v>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, (string)tax);
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, (string)delivery);
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "<v>");
	al_append_str(xml_str2, (string)sales_price);
	al_append_str(xml_str2, "</v>");
	al_append_str(xml_str2, "</EBIZ>");
	var list xml2;
	var file f;
	f = al_file_open(xml_str2, "sr");
	xml2 = al_xml("parse", f, null, null);
	xml2 = xml2.head;
	xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/sales/cart.xsl", xml2);
	genPageBegin("Cart");
	genFormBegin("Cart", null);
	res.out(toUTF8_direct(xml_str1));
	genButton("submit", "C");
	genButton("submit", "");
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeRegist(list params, DbConnection conn);
body
{
	var string submit;
	submit = al_dst_node(params, "submit");
	if (submit == null) {
		if (req.getSession()) {
		} else {
			req.createSession();
		}
		res.redirectWithSession("/products/regist.html");
		return null;
	} else {
	}
	var string last_name, last_name_yomi, first_name, first_name_yomi;
	var string sex, birth_year, birth_month, birth_day;
	var string zip_code_1, zip_code_2, prifecture;
	var string address1, address2, address3;
	var string phone, mobile, email, password, job, company;
	var string interest1, interest2, interest3;
	last_name = al_dst_node(params, "last_name");
	last_name_yomi = al_dst_node(params, "last_name_yomi");
	first_name = al_dst_node(params, "first_name");
	first_name_yomi = al_dst_node(params, "first_name_yomi");
	sex = al_dst_node(params, "sex");
	birth_year = al_dst_node(params, "birth_year");
	birth_month = al_dst_node(params, "birth_month");
	birth_day = al_dst_node(params, "birth_day");
	zip_code_1 = al_dst_node(params, "zip_code_1");
	zip_code_2 = al_dst_node(params, "zip_code_2");
	prifecture = al_dst_node(params, "prifecture");
	address1 = al_dst_node(params, "address1");
	address2 = al_dst_node(params, "address2");
	address3 = al_dst_node(params, "address3");
	phone = al_dst_node(params, "phone");
	mobile = al_dst_node(params, "mobile");
	email = al_dst_node(params, "email");
	password = al_dst_node(params, "password");
	job = al_dst_node(params, "job");
	company = al_dst_node(params, "company");
	interest1 = al_dst_node(params, "interest1");
	interest2 = al_dst_node(params, "interest2");
	interest3 = al_dst_node(params, "interest3");
	if (email == null || email == "") {
		error("dq[K{B");
		return null;
	} else {
	}
	var string xml_str, date;
	date = Context::genTimeStamp();
	xml_str = al_copy("");
	al_append_str(xml_str, "<q>");
	al_append_str(xml_str, "<o^>");
	al_append_str(xml_str, date);
	al_append_str(xml_str, "</o^>");
	al_append_str(xml_str, "<O>");
	al_append_str(xml_str, "<>");
	al_append_str(xml_str, last_name);
	al_append_str(xml_str, "</>");
	al_append_str(xml_str, "<>");
	al_append_str(xml_str, first_name);
	al_append_str(xml_str, "</>");
	al_append_str(xml_str, "<tKi>");
	al_append_str(xml_str, last_name_yomi);
	al_append_str(xml_str, "</tKi>");
	al_append_str(xml_str, "<tKi>");
	al_append_str(xml_str, first_name_yomi);
	al_append_str(xml_str, "</tKi>");
	al_append_str(xml_str, "</O>");
	al_append_str(xml_str, "<>");
	al_append_str(xml_str, sex);
	al_append_str(xml_str, "</>");
	al_append_str(xml_str, "<N>");
	al_append_str(xml_str, "<N>");
	al_append_str(xml_str, birth_year);
	al_append_str(xml_str, "</N>");
	al_append_str(xml_str, "<>");
	al_append_str(xml_str, birth_month);
	al_append_str(xml_str, "</>");
	al_append_str(xml_str, "<>");
	al_append_str(xml_str, birth_day);
	al_append_str(xml_str, "</>");
	al_append_str(xml_str, "</N>");
	al_append_str(xml_str, "<Z>");
	al_append_str(xml_str, "<X>");
	al_append_str(xml_str, zip_code_1);
	al_append_str(xml_str, zip_code_2);
	al_append_str(xml_str, "</X>");
	al_append_str(xml_str, "<s{>");
	al_append_str(xml_str, prifecture);
	al_append_str(xml_str, "</s{>");
	al_append_str(xml_str, "<snP>");
	al_append_str(xml_str, address1);
	al_append_str(xml_str, "</snP>");
	al_append_str(xml_str, "<snQ>");
	al_append_str(xml_str, address2);
	al_append_str(xml_str, "</snQ>");
	al_append_str(xml_str, "<snR>");
	al_append_str(xml_str, address3);
	al_append_str(xml_str, "</snR>");
	al_append_str(xml_str, "</Z>");
	al_append_str(xml_str, "<db>");
	al_append_str(xml_str, phone);
	al_append_str(xml_str, "</db>");
	al_append_str(xml_str, "<gdb>");
	al_append_str(xml_str, mobile);
	al_append_str(xml_str, "</gdb>");
	al_append_str(xml_str, "<dq[>");
	al_append_str(xml_str, email);
	al_append_str(xml_str, "</dq[>");
	al_append_str(xml_str, "<E>");
	al_append_str(xml_str, job);
	al_append_str(xml_str, "</E>");
	al_append_str(xml_str, "<>");
	al_append_str(xml_str, company);
	al_append_str(xml_str, "</>");
	al_append_str(xml_str, "<>");
	al_append_str(xml_str, "<P>");
	al_append_str(xml_str, interest1);
	al_append_str(xml_str, "</P>");
	al_append_str(xml_str, "<Q>");
	al_append_str(xml_str, interest2);
	al_append_str(xml_str, "</Q>");
	al_append_str(xml_str, "<R>");
	al_append_str(xml_str, interest3);
	al_append_str(xml_str, "</R>");
	al_append_str(xml_str, "</>");
	al_append_str(xml_str, "</q>");
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	acc = new XmlDbAccessor;
	acc.create("Customer", "", conn);
	acc.setDTDfilename("bizsoft/customer/customer.dtd");
	try {
		obj = acc.get(email);
		obj.delete();
	} catch (AlException e) {
	}
	acc = new XmlDbAccessor;
	acc.create("Customer", "", conn);
	acc.setDTDfilename("bizsoft/customer/customer.dtd");
	acc.putXML(xml_str, email);
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	try {
		obj = acc.get(email);
		obj.putField("User/Password", password);
	} catch (AlException e) {
		obj = acc.create(email);
		obj.putField("User/Target", "bizspftCustomer");
		obj.putField("User/Id", "bizsoftCustomer:" + email);
		obj.putField("User/UserId", email);
		obj.putField("User/Password", password);
		obj2 = obj.createChild("User/RoleName");
		obj2.putField("", "customer");
	}
	session.setAttribute("target", "bizsoftCustomer");
	session.setAttribute("user_name", "bizsoftCustomer:" + email);
	user_roles = al_cons(null, null);
	al_create_arc(user_roles, al_cons(null, null), "customer");
	session.setAttribute("user_roles", user_roles);
	res.redirect("ebiz?action=CustomerHome");
	return null;
}
end_body
member
public: list invokeLogin(list params, DbConnection conn);
body
{
	if (authorize2(params, conn)) {
	} else {
		return null;
	}
	if (al_dst_node(user_roles, "webuiadmin")) {
		res.redirect("ebiz?action=WebUiAdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "admin")) {
		res.redirect("ebiz?action=AdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "customer")) {
		res.redirect("ebiz?action=CustomerHome");
		return null;
	} else {
	}
	error("User '" + user_name + "' does not have required user role");
	return null;
}
end_body
member
public: list invokeCustomerHome(list params, DbConnection conn);
body
{
	if (checkUserRole("customer")) {
	} else {
		return null;
	}
	res.out("<HTML><HEAD>\n<META http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n");
	res.out("<TITLE>Welcome</TITLE></HEAD>\n");
	res.out("<FRAMESET COLS=\"20%,*\" FRAMEBORDER=\"YES\">\n");
	res.out("<FRAME SRC=\"ebiz?action=CustomerMenu\" SCROLLING=\"auto\" NAME=\"menu\"/>\n");
	res.out("<FRAME SRC=\" customer_home.html\" SCROLLING=\"auto\" NAME=\"action\"/>\n");
	res.out("</FRAMESET>\n");
	res.out("</HTML>\n");
	return null;
}
end_body
member
public: list invokeCustomerMenu(list params, DbConnection conn);
body
{
	if (checkUserRole("customer")) {
	} else {
		return null;
	}
	return menu(params, conn);
}
end_body
member
public: list invokeMyAccount(list params, DbConnection conn);
body
{
	if (user_name) {
	} else {
		error("no session");
		return null;
	}
	var string submit;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	if (submit == "C") {
		var string last_name, last_name_yomi, first_name, first_name_yomi;
		var string sex, birth_year, birth_month, birth_day;
		var string zip_code, prifecture;
		var string address1, address2, address3;
		var string phone, mobile, email, job, company;
		var string interest1, interest2, interest3;
		last_name = fromUTF8((string)al_dst_node(params, "last_name"));
		last_name_yomi = fromUTF8((string)al_dst_node(params, "last_name_yomi"));
		first_name = fromUTF8((string)al_dst_node(params, "first_name"));
		first_name_yomi = fromUTF8((string)al_dst_node(params, "first_name_yomi"));
		sex = fromUTF8((string)al_dst_node(params, "sex"));
		birth_year = fromUTF8((string)al_dst_node(params, "birth_year"));
		birth_month = fromUTF8((string)al_dst_node(params, "birth_month"));
		birth_day = fromUTF8((string)al_dst_node(params, "birth_day"));
		zip_code = fromUTF8((string)al_dst_node(params, "zip_code"));
		prifecture = fromUTF8((string)al_dst_node(params, "prifecture"));
		address1 = fromUTF8((string)al_dst_node(params, "address1"));
		address2 = fromUTF8((string)al_dst_node(params, "address2"));
		address3 = fromUTF8((string)al_dst_node(params, "address3"));
		phone = fromUTF8((string)al_dst_node(params, "phone"));
		mobile = fromUTF8((string)al_dst_node(params, "mobile"));
		email = fromUTF8((string)al_dst_node(params, "email"));
		job = fromUTF8((string)al_dst_node(params, "job"));
		company = fromUTF8((string)al_dst_node(params, "company"));
		interest1 = fromUTF8((string)al_dst_node(params, "interest1"));
		interest2 = fromUTF8((string)al_dst_node(params, "interest2"));
		interest3 = fromUTF8((string)al_dst_node(params, "interest3"));
		var string xml_str, date;
		date = Context::genTimeStamp();
		xml_str = al_copy("");
		al_append_str(xml_str, "<q>");
		al_append_str(xml_str, "<o^>");
		al_append_str(xml_str, date);
		al_append_str(xml_str, "</o^>");
		al_append_str(xml_str, "<O>");
		al_append_str(xml_str, "<>");
		al_append_str(xml_str, last_name);
		al_append_str(xml_str, "</>");
		al_append_str(xml_str, "<>");
		al_append_str(xml_str, first_name);
		al_append_str(xml_str, "</>");
		al_append_str(xml_str, "<tKi>");
		al_append_str(xml_str, last_name_yomi);
		al_append_str(xml_str, "</tKi>");
		al_append_str(xml_str, "<tKi>");
		al_append_str(xml_str, first_name_yomi);
		al_append_str(xml_str, "</tKi>");
		al_append_str(xml_str, "</O>");
		al_append_str(xml_str, "<>");
		al_append_str(xml_str, sex);
		al_append_str(xml_str, "</>");
		al_append_str(xml_str, "<N>");
		al_append_str(xml_str, "<N>");
		al_append_str(xml_str, birth_year);
		al_append_str(xml_str, "</N>");
		al_append_str(xml_str, "<>");
		al_append_str(xml_str, birth_month);
		al_append_str(xml_str, "</>");
		al_append_str(xml_str, "<>");
		al_append_str(xml_str, birth_day);
		al_append_str(xml_str, "</>");
		al_append_str(xml_str, "</N>");
		al_append_str(xml_str, "<Z>");
		al_append_str(xml_str, "<X>");
		al_append_str(xml_str, zip_code);
		al_append_str(xml_str, "</X>");
		al_append_str(xml_str, "<s{>");
		al_append_str(xml_str, prifecture);
		al_append_str(xml_str, "</s{>");
		al_append_str(xml_str, "<snP>");
		al_append_str(xml_str, address1);
		al_append_str(xml_str, "</snP>");
		al_append_str(xml_str, "<snQ>");
		al_append_str(xml_str, address2);
		al_append_str(xml_str, "</snQ>");
		al_append_str(xml_str, "<snR>");
		al_append_str(xml_str, address3);
		al_append_str(xml_str, "</snR>");
		al_append_str(xml_str, "</Z>");
		al_append_str(xml_str, "<db>");
		al_append_str(xml_str, phone);
		al_append_str(xml_str, "</db>");
		al_append_str(xml_str, "<gdb>");
		al_append_str(xml_str, mobile);
		al_append_str(xml_str, "</gdb>");
		al_append_str(xml_str, "<dq[>");
		al_append_str(xml_str, email);
		al_append_str(xml_str, "</dq[>");
		al_append_str(xml_str, "<E>");
		al_append_str(xml_str, job);
		al_append_str(xml_str, "</E>");
		al_append_str(xml_str, "<>");
		al_append_str(xml_str, company);
		al_append_str(xml_str, "</>");
		al_append_str(xml_str, "<>");
		al_append_str(xml_str, "<P>");
		al_append_str(xml_str, interest1);
		al_append_str(xml_str, "</P>");
		al_append_str(xml_str, "<Q>");
		al_append_str(xml_str, interest2);
		al_append_str(xml_str, "</Q>");
		al_append_str(xml_str, "<R>");
		al_append_str(xml_str, interest3);
		al_append_str(xml_str, "</R>");
		al_append_str(xml_str, "</>");
		al_append_str(xml_str, "</q>");
		var XmlDbAccessor acc;
		var XmlDbObject obj;
		acc = new XmlDbAccessor;
		acc.create("Customer", "", conn);
		acc.setDTDfilename("bizsoft/customer/customer.dtd");
		obj = acc.get(email);
		obj.delete();
		acc.putXML(xml_str, email);
		conn.commit();
	} else {
	}
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string email, xml_str1, xml_str2;
	var list xml2;
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	ls = acc.get("User/Id", user_name);
	itr = al_dst_itr(ls);
	obj = al_next(itr);
	email = obj.getField("User/UserId");
	acc = new XmlDbAccessor;
	acc.create("Customer", "", conn);
	acc.setDTDfilename("bizsoft/customer/customer.dtd");
	xml_str2 = acc.getXML(email);
	var file f;
	f = al_file_open(xml_str2, "sr");
	xml2 = al_xml("parse", f, null, null);
	xml2 = xml2.head;
	xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/customer/customer.xsl", xml2);
	genPageBegin("MyAccount");
	genFormBegin("MyAccount", null);
	res.out(toUTF8_direct(xml_str1));
	genButton("submit", "C");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeBuy(list params, DbConnection conn);
body
{
	if (user_name) {
	} else {
		error("no session");
		return null;
	}
	var string product_name, product_id;
	var integer unit_price, total_price, tax, sales_price;
	var string e_product, e_license, start_date, end_date;
	var list cart, itr;
	var integer num, delivery;
	var string xml_str2, timestamp, msgId, text, email;
	msgId = Context::genMsgId();
	cart = session.getAttribute("cart");
	xml_str2 = al_copy("");
	itr = al_dst_itr(cart);
	total_price = delivery = 0;
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls2, itr2;
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	ls2 = acc.get("User/Id", user_name);
	itr2 = al_dst_itr(ls2);
	obj = al_next(itr2);
	email = obj.getField("User/UserId");
	acc = new XmlDbAccessor;
	acc.create("Customer", "", conn);
	acc.setDTDfilename("bizsoft/customer/customer.dtd");
	obj = acc.get(email);
	text = al_copy("");
	al_append_str(text, "\n" + obj.getField("q/O/") + " " + obj.getField("q/O/") + " l\n\n");
	al_append_str(text, "xAB\n\n");
	al_append_str(text, "F" + msgId + "\n\n");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, "<t>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, timestamp = Context::genTimeStamp());
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "</t>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, "online system");
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "<q>");
	al_append_str(xml_str2, user_name);
	al_append_str(xml_str2, "</q>");
	loop {
		if (num = al_next(itr)) {
		} else {
			break;
		}
		product_id = al_arc_a(itr);
		try {
			var XmlDbAccessor acc;
			var XmlDbObject obj1, obj2;
			var list ls2, itr2;
			acc = new XmlDbAccessor;
			acc.create("Products", "", conn);
			acc.setDTDfilename("bizsoft/stock/stock.dtd");
			obj1 = acc.get("product_stock");
			ls2 = obj1.getChildren("i}X^[/i", "^", product_id);
			itr2 = al_dst_itr(ls2);
			if (obj2 = al_next(itr2)) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "^ " + (string)product_id + " iB";
				throw ex;
			}
			product_name = obj2.getField("i");
			e_product = obj2.getField("dq}");
			e_license = obj2.getField("CZX");
			if (e_license == "Yes") {
				var integer period, date_int;
				var list date1, date2;
				if (al_str_misc("ends_with", product_id, "L01")) {
					period = 1;
				} else {
					if (al_str_misc("ends_with", product_id, "L03")) {
						period = 3;
					} else {
						if (al_str_misc("ends_with", product_id, "L12")) {
							period = 12;
						} else {
							error("CZX^B");
							return null;
						}
					}
				}
				date_int = al_misc("get_time", null, null);
				date1 = al_misc("get_localtime", date_int, null);
				date_int = date_int + 60 * 60 * 24 * 31 * period;
				date2 = al_misc("get_localtime", date_int, null);
				start_date = al_misc("format_time", date1, "yyyy'/'MM'/'dd");
				end_date = al_misc("format_time", date2, "yyyy'/'MM'/'dd");
			} else {
				delivery = 1000;
				start_date = end_date = "";
			}
			unit_price = (integer)obj2.getField("P");
			total_price = total_price + unit_price * num;
			al_append_str(text, "iF " + product_name + "\n");
			al_append_str(text, "^F " + product_id + "\n");
			if (e_license == "Yes") {
				al_append_str(text, "JnF " + start_date + "\n");
				al_append_str(text, "IF " + end_date + "\n");
			} else {
			}
			al_append_str(text, "PF " + (string)unit_price + "~\n");
			al_append_str(text, "F " + (string)num + "\n\n");
			al_append_str(xml_str2, "<>");
			al_append_str(xml_str2, "<i>");
			al_append_str(xml_str2, product_name);
			al_append_str(xml_str2, "</i>");
			al_append_str(xml_str2, "<^>");
			al_append_str(xml_str2, product_id);
			al_append_str(xml_str2, "</^>");
			al_append_str(xml_str2, "<dq}>");
			al_append_str(xml_str2, e_product);
			al_append_str(xml_str2, "</dq}>");
			al_append_str(xml_str2, "<Jn>");
			al_append_str(xml_str2, start_date);
			al_append_str(xml_str2, "</Jn>");
			al_append_str(xml_str2, "<I>");
			al_append_str(xml_str2, end_date);
			al_append_str(xml_str2, "</I>");
			al_append_str(xml_str2, "<>");
			al_append_str(xml_str2, (string)num);
			al_append_str(xml_str2, "</>");
			al_append_str(xml_str2, "<P>");
			al_append_str(xml_str2, (string)unit_price);
			al_append_str(xml_str2, "</P>");
			al_append_str(xml_str2, "</>");
			// [CZXt@CYt
			// ### TODO
		} catch (AlException e) {
			throw e;
		}
	}
	tax = total_price * (integer)consumer_tax_rate / 100;
	sales_price = total_price + tax + delivery;
	al_append_str(text, "vF " + (string)total_price + "~\n");
	al_append_str(text, "F " + (string)tax + "~\n");
	if (delivery > 0) {
		al_append_str(text, "F " + (string)delivery + "~\n");
	} else {
	}
	al_append_str(text, "vF " + (string)sales_price + "~\n\n");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, (string)tax);
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "<z>");
	al_append_str(xml_str2, (string)delivery);
	al_append_str(xml_str2, "</z>");
	al_append_str(xml_str2, "<xz>");
	al_append_str(xml_str2, (string)sales_price);
	al_append_str(xml_str2, "</xz>");
	al_append_str(xml_str2, "<z>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, delivery == 0 ? "N/A" : "z");
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, delivery == 0 ? "N/A" : "");
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "</z>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, "1");
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, timestamp);
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, "mF");
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "<>");
	al_append_str(xml_str2, "</>");
	al_append_str(xml_str2, "</>");
	al_append_str(text, "PLvzXUUB\n\n");
	al_append_str(text, "F xxx-xxxxxxx\n");
	al_append_str(text, "`F jb|Gp[gJ\n\n");
	al_append_str(text, "pB\n\n");
	al_append_str(text, "\n");
	al_append_str(xml_str2, "</>");
	acc = new XmlDbAccessor;
	acc.create("PurchaseOrder", "", conn);
	acc.setDTDfilename("bizsoft/sales/purchase_order.dtd");
	acc.putXML(xml_str2, msgId);
	{
		acc = new XmlDbAccessor;
		acc.create("Check", "", conn);
		acc.setDTDfilename("bizsoft/finance/check.dtd");
		var list date1;
		var string date_str1;
		date1 = al_file_manip("current_datetime", null, null);
		date_str1 = date_str(date1);
		xml_str2 = al_copy("");
		al_append_str(xml_str2, "<`[>");
		al_append_str(xml_str2, "<t>");
		al_append_str(xml_str2, date_str1);
		al_append_str(xml_str2, "</t>");
		al_append_str(xml_str2, "<`FbN>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, Context::genTimeStamp());
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<[U>");
		al_append_str(xml_str2, "online_system");
		al_append_str(xml_str2, "</[U>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</`FbN>");
		al_append_str(xml_str2, "<d>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "Y-|");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<z>");
		al_append_str(xml_str2, (string)sales_price);
		al_append_str(xml_str2, "</z>");
		al_append_str(xml_str2, "<z>");
		al_append_str(xml_str2, "</z>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "vZO");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<Ev>");
		al_append_str(xml_str2, "</Ev>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<t>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</t>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</d>");
		al_append_str(xml_str2, "<d>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "-");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<z>");
		al_append_str(xml_str2, (string)sales_price);
		al_append_str(xml_str2, "</z>");
		al_append_str(xml_str2, "<z>");
		al_append_str(xml_str2, (string)(sales_price * (integer)consumer_tax_rate / (100 + (integer)consumer_tax_rate)));
		al_append_str(xml_str2, "</z>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, consumer_tax_rate);
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<Ev>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</Ev>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "F" + msgId);
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<t>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</t>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</d>");
		al_append_str(xml_str2, "</`[>");
		acc.putXML(xml_str2, msgId);
	}
	var list props;
	var string smtp_host, from_address, domain;
	if (props = al_dst_node(req._server.servlet_param_list, "WebUIbizsoftCustomerServlet") && smtp_host = al_dst_node(props, "smtp.host") && from_address = al_dst_node(props, "from.mailaddress") && domain = al_dst_node(props, "domain")) {
	} else {
		conn.rollback();
		res.response_code = 500;
		return null;
	}
	var SmtpClient client;
	client = new SmtpClient;
	client.create(smtp_host);
	client.from = from_address;
	client.domain = domain;
	al_create_arc(client.to, email, null);
	al_create_arc(client.rcpts, email, null);
	al_create_arc(client.rcpts, from_address, null);
	client.subject = "Thank you for your oder.";
	client.text = text;
	var list err;
	if (err = client.start()) {
		conn.rollback();
		obj.putField("q/M", "Ms");
		res.out("dq[MsB<BR>");
		res.out("dq[AhXA[Uo^B<BR>");
		return null;
	} else {
	}
	session.setAttribute("cart", null);
	res.out("pB<BR>");
	res.out("dq[MB<BR>");
	return null;
}
end_body
member
public: static integer consumer_tax_rate;
end_class
class WebUIbizsoftSalesServlet
member
public: list invokeLogin(list params, DbConnection conn);
body
{
	if (authorize(params, conn)) {
	} else {
		return null;
	}
	if (al_dst_node(user_roles, "webuiadmin")) {
		res.redirect("ebiz?action=WebUiAdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "admin")) {
		res.redirect("ebiz?action=AdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "sales")) {
		res.redirect("ebiz?action=SalesHome");
		return null;
	} else {
	}
	error("User '" + user_name + "' does not have required user role");
	return null;
}
end_body
member
public: list invokeSalesHome(list params, DbConnection conn);
body
{
	if (checkUserRole("sales")) {
	} else {
		return null;
	}
	res.out("<HTML><HEAD>\n<META http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n");
	res.out("<TITLE>Sales</TITLE></HEAD>\n");
	res.out("<FRAMESET COLS=\"20%,*\" FRAMEBORDER=\"YES\">\n");
	res.out("<FRAME SRC=\"ebiz?action=SalesMenu\" SCROLLING=\"auto\" NAME=\"menu\"/>\n");
	res.out("<FRAME SRC=\"sales_home.html\" SCROLLING=\"auto\" NAME=\"action\"/>\n");
	res.out("</FRAMESET>\n");
	res.out("</HTML>\n");
	return null;
}
end_body
member
public: list invokeSalesMenu(list params, DbConnection conn);
body
{
	if (checkUserRole("sales")) {
	} else {
		return null;
	}
	return menu(params, conn);
}
end_body
member
public: list invokePurchaseOrder(list params, DbConnection conn);
body
{
	if (checkUserRole("sales")) {
	} else {
		return null;
	}
	var string submit, type, po_id;
	var string from_year, from_month, from_day, to_year, to_month, to_day;
	var list date1, date2, xml1, xml2;
	var string xml_str1, xml_str2, date_str1, date_str2;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	type = fromUTF8((string)al_dst_node(params, "type"));
	po_id = al_dst_node(params, "po_id");
	if (submit == "\") {
		if (po_id && po_id != "") {
			var XmlDbAccessor acc;
			acc = new XmlDbAccessor;
			acc.create("PurchaseOrder", "", conn);
			acc.setDTDfilename("bizsoft/sales/purchase_order.dtd");
			xml_str2 = acc.getXML(po_id);
			var file f;
			f = al_file_open(xml_str2, "sr");
			xml2 = al_xml("parse", f, null, null);
			xml2 = xml2.head;
			xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/sales/purchase_order.xsl", xml2);
			genPageBegin("PurchaseOrderDetail");
			res.out(toUTF8_direct(xml_str1));
			genPageEnd();
			return null;
		} else {
		}
	} else {
	}
	if (submit == "" || submit == "zmF" || submit == "" || submit == "mF") {
		from_year = al_dst_node(params, "from_year");
		from_month = al_dst_node(params, "from_month");
		from_day = al_dst_node(params, "from_day");
		to_year = al_dst_node(params, "to_year");
		to_month = al_dst_node(params, "to_month");
		to_day = al_dst_node(params, "to_day");
		date1 = al_list6((integer)from_year, (integer)from_month, (integer)from_day, 0, 0, 0);
		date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
	} else {
		var integer date1_int, date2_int;
		date2_int = al_misc("get_time", null, null);
		date1_int = date2_int - 60 * 60 * 24 * 30;
		date1 = al_misc("get_localtime", date1_int, null);
		date2 = al_misc("get_localtime", date2_int, null);
	}
	if (submit == "") {
		if (po_id && po_id != "") {
			// [
			// ### TODO
			var XmlDbAccessor acc;
			var XmlDbObject obj;
			acc = new XmlDbAccessor;
			acc.create("PurchaseOrder", "", conn);
			acc.setDTDfilename("bizsoft/sales/purchase_order.dtd");
			try {
				obj = acc.get(po_id);
				obj.putField("//", (string)((integer)obj.getField("//") + 1));
				obj.putField("//", Context::genTimeStamp());
				conn.commit();
			} catch (AlException e) {
				error("BmFB");
			}
		} else {
			error("IB");
			return null;
		}
	} else {
	}
	if (submit == "mF") {
		if (po_id && po_id != "") {
			var XmlDbAccessor acc;
			var XmlDbObject obj;
			acc = new XmlDbAccessor;
			acc.create("PurchaseOrder", "", conn);
			acc.setDTDfilename("bizsoft/sales/purchase_order.dtd");
			try {
				obj = acc.get(po_id);
				obj.putField("//", "mF");
				obj.putField("//", Context::genTimeStamp());
				conn.commit();
			} catch (AlException e) {
				error("BmFB");
			}
			conn.commit();
		} else {
			error("IB");
			return null;
		}
	} else {
	}
	xml1 = date_xml(date1);
	xml2 = date_xml(date2);
	xml_str1 = from_date_html(xml1);
	xml_str2 = to_date_html(xml2);
	date_str1 = date_str_2(date1) + "-000000";
	date_str2 = date_str_2(date2) + "-999999";
	genPageBegin("PurchaseOrder");
	genFormBegin("PurchaseOrder", null);
	genText("FromF");
	res.out(toUTF8_direct(xml_str1));
	genBR();
	genText("ToF");
	res.out(toUTF8_direct(xml_str2));
	genBR();
	var list values;
	values = al_cons(null, null);
	al_create_arc(values, "", null);
	al_create_arc(values, "z", null);
	al_create_arc(values, "mF", null);
	genSelect("type", values);
	genButton("submit", "");
	genBR();
	genButton("submit", "\");
	genButton("submit", "");
	genButton("submit", "mF");
	genBR();
	var XmlDbAccessor acc;
	var list ls, itr;
	var XmlDbObject obj;
	acc = new XmlDbAccessor;
	acc.create("PurchaseOrder", "", conn);
	acc.setDTDfilename("bizsoft/sales/purchase_order.dtd");
	ls = acc.get((list)al_cons(null, null), "/t/", "string", date_str1, date_str2, "/t/", "string", null);
	itr = al_dst_itr(ls);
	res.out("<TABLE BORDER>\n");
	res.out(toUTF8_direct("<TR><TD></TD><TD></TD><TD>z</TD><TD>z</TD><TD></TD><TD></TD><TD></TD><TD></TD><TD>z</TD></TR>\n"));
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		var string no_delivery, no_payment;
		if (obj.getField("/z/") == "z") {
			no_delivery = 1;
		} else {
		}
		if (obj.getField("//") == "mF") {
			no_payment = 1;
		} else {
		}
		if (type == "z") {
			if (no_delivery) {
			} else {
				continue;
			}
		} else {
		}
		if (type == "mF") {
			if (no_payment) {
			} else {
				continue;
			}
		} else {
		}
		var string po_id, delivery, delivery_date, invoice, invoice_date, payment, payment_date, money;
		po_id = obj.msgId;
		delivery = obj.getField("/z/");
		delivery_date = obj.getField("/z/");
		invoice = obj.getField("//");
		invoice_date = obj.getField("//");
		payment = obj.getField("//");
		payment_date = obj.getField("//");
		money = obj.getField("/xz");
		res.out("<TR><TD>");
		genRadio("po_id", obj.msgId, "", null);
		res.out("</TD><TD>");
		genText(po_id);
		res.out("</TD><TD>");
		genText(delivery);
		res.out("</TD><TD>");
		genText(delivery_date);
		res.out("</TD><TD>");
		genText(invoice + "");
		res.out("</TD><TD>");
		genText(invoice_date);
		res.out("</TD><TD>");
		genText(payment);
		res.out("</TD><TD>");
		genText(payment_date);
		res.out("</TD><TD>");
		genText(money);
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeInventory(list params, DbConnection conn);
body
{
	if (checkUserRole("sales")) {
	} else {
		return null;
	}
	var string xml_str1, xml_str2;
	var list xml2;
	var XmlDbAccessor acc;
	acc = new XmlDbAccessor;
	acc.create("Products", "", conn);
	acc.setDTDfilename("bizsoft/stock/stock.dtd");
	xml_str2 = acc.getXML("product_stock");
	var file f;
	f = al_file_open(xml_str2, "sr");
	xml2 = al_xml("parse", f, null, null);
	xml2 = xml2.head;
	xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/stock/stock_list.xsl", xml2);
	genPageBegin("Stock");
	res.out(toUTF8_direct(xml_str1));
	genPageEnd();
	return null;
}
end_body
member
public: list invokeProductArrival(list params, DbConnection conn);
body
{
	if (checkUserRole("sales")) {
	} else {
		return null;
	}
	var string submit, product_id;
	var string xml_str1, xml_str2;
	var list xml2;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	product_id = al_dst_node(params, "product_id");
	var XmlDbAccessor acc;
	acc = new XmlDbAccessor;
	acc.create("Products", "", conn);
	acc.setDTDfilename("bizsoft/stock/stock.dtd");
	xml_str2 = acc.getXML("product_stock");
	var file f;
	f = al_file_open(xml_str2, "sr");
	xml2 = al_xml("parse", f, null, null);
	xml2 = xml2.head;
	xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/stock/product_id_list.xsl", xml2);
	genPageBegin("ProductArrival");
	genFormBegin("ProductArrival", null);
	genText("^F");
	res.out(toUTF8_direct(xml_str1));
	genBR();
	genButton("submit", "\");
	genBR();
	if (submit == "\") {
		var XmlDbObject obj1, obj2;
		var list ls, itr;
		acc = new XmlDbAccessor;
		acc.create("Products", "", conn);
		acc.setDTDfilename("bizsoft/stock/stock.dtd");
		obj1 = acc.get("product_stock");
		ls = obj1.getChildren("i}X^[/i", "^", product_id);
		itr = al_dst_itr(ls);
		obj2 = al_next(itr);
		var string product_name, num_stock;
		product_name = obj2.getField("i");
		num_stock = obj2.getField("");
		genText("iF");
		genText(product_name);
		genHidden("product_name", product_name);
		genBR();
		genText("^F");
		genText(product_id);
		genBR();
		genText("F");
		genText(num_stock);
		genBR();
		genText("F");
		genTextField("num", 10, "");
		genBR();
		genText("zF");
		genTextField("money", 20, "");
		genRadio("tax", "O", "O", (list)1);
		genRadio("tax", "", "", null);
		genBR();
		genText("xF");
		genRadio("payment", "", "", (list)1);
		genRadio("payment", "|", "|", null);
		genRadio("payment", "x`", "x`", null);
		genBR();
		genButton("submit", "");
		genBR();
	} else {
	}
	if (submit == "") {
		if (consumer_tax_rate) {
		} else {
			try {
				var XmlDbAccessor acc;
				var XmlDbObject obj;
				var list ls, itr;
				acc = new XmlDbAccessor;
				acc.create("TaxRate", "", conn);
				acc.setDTDfilename("bizsoft/finance/tax_rate.dtd");
				ls = acc.getAll();
				itr = al_dst_itr(ls);
				if (obj = al_next(itr)) {
				} else {
					var AlException ex;
					ex = new AlException;
					ex.msg = "}X^[B";
					throw ex;
				}
				ls = obj.getChildren("}X^[/", "", "");
				itr = al_dst_itr(ls);
				if (obj = al_next(itr) && consumer_tax_rate = obj.getField("")) {
				} else {
					var AlException ex;
					ex = new AlException;
					ex.msg = "B";
					throw ex;
				}
			} catch (AlException e) {
				throw e;
			}
		}
		var string msgId, product_name, num, money, tax, payment;
		msgId = Context::genMsgId();
		num = (integer)al_dst_node(params, "num");
		if (num <= 0) {
			error("0B");
			return null;
		} else {
		}
		product_name = fromUTF8((string)al_dst_node(params, "product_name"));
		money = (integer)al_dst_node(params, "money");
		tax = fromUTF8((string)al_dst_node(params, "tax"));
		payment = fromUTF8((string)al_dst_node(params, "payment"));
		if (payment <= 0) {
			error("dl0B");
			return null;
		} else {
		}
		acc = new XmlDbAccessor;
		acc.create("StockInOut", "", conn);
		acc.setDTDfilename("bizsoft/stock/stock_in_out.dtd");
		xml_str2 = al_copy("");
		al_append_str(xml_str2, "<o>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "<i>");
		al_append_str(xml_str2, product_name);
		al_append_str(xml_str2, "</i>");
		al_append_str(xml_str2, "<^>");
		al_append_str(xml_str2, product_id);
		al_append_str(xml_str2, "</^>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, (integer)num);
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, Context::genTimeStamp());
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</o>");
		acc.putXML(xml_str2, msgId);
		acc = new XmlDbAccessor;
		acc.create("Products", "", conn);
		acc.setDTDfilename("bizsoft/stock/stock.dtd");
		var XmlDbObject obj1, obj2;
		var list ls, itr;
		obj1 = acc.get("product_stock");
		ls = obj1.getChildren("i}X^[/i", "^", product_id);
		itr = al_dst_itr(ls);
		obj2 = al_next(itr);
		obj2.putField("", (string)((integer)obj2.getField("") + num));
		acc = new XmlDbAccessor;
		acc.create("Check", "", conn);
		acc.setDTDfilename("bizsoft/finance/check.dtd");
		var list date1;
		var string date_str1;
		date1 = al_file_manip("current_datetime", null, null);
		date_str1 = date_str(date1);
		xml_str2 = al_copy("");
		al_append_str(xml_str2, "<`[>");
		al_append_str(xml_str2, "<t>");
		al_append_str(xml_str2, date_str1);
		al_append_str(xml_str2, "</t>");
		al_append_str(xml_str2, "<`FbN>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, Context::genTimeStamp());
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<[U>");
		al_append_str(xml_str2, "online_system");
		al_append_str(xml_str2, "</[U>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</`FbN>");
		al_append_str(xml_str2, "<d>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "-d");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		if (tax == "O") {
			al_append_str(xml_str2, "<z>");
			al_append_str(xml_str2, (string)(money + money * (integer)consumer_tax_rate / 100));
			al_append_str(xml_str2, "</z>");
			al_append_str(xml_str2, "<z>");
			al_append_str(xml_str2, (string)(money * (integer)consumer_tax_rate / 100));
			al_append_str(xml_str2, "</z>");
		} else {
		}
		if (tax == "") {
			al_append_str(xml_str2, "<z>");
			al_append_str(xml_str2, (string)money);
			al_append_str(xml_str2, "</z>");
			al_append_str(xml_str2, "<z>");
			al_append_str(xml_str2, (string)(money * (integer)consumer_tax_rate / (100 + (integer)consumer_tax_rate)));
			al_append_str(xml_str2, "</z>");
		} else {
		}
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "d");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, consumer_tax_rate);
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<Ev>");
		al_append_str(xml_str2, "d");
		al_append_str(xml_str2, "</Ev>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, product_name + ", " + product_id + ", " + (string)num + "");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<t>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</t>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</d>");
		al_append_str(xml_str2, "<d>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "<>");
		if (payment == "") {
			al_append_str(xml_str2, "Y-");
		} else {
		}
		if (payment == "|") {
			al_append_str(xml_str2, "-|");
		} else {
		}
		if (payment == "x`") {
			al_append_str(xml_str2, "-x`");
		} else {
		}
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<z>");
		if (tax == "O") {
			al_append_str(xml_str2, (string)(money + money * (integer)consumer_tax_rate / 100));
		} else {
		}
		if (tax == "") {
			al_append_str(xml_str2, (string)money);
		} else {
		}
		al_append_str(xml_str2, "</z>");
		al_append_str(xml_str2, "<z>");
		al_append_str(xml_str2, "</z>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "vZO");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<Ev>");
		al_append_str(xml_str2, "</Ev>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<t>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</t>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</d>");
		al_append_str(xml_str2, "</`[>");
		acc.putXML(xml_str2, msgId);
		res.redirectWithSession("ebiz?action=Inventory");
		return null;
	} else {
	}
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeShipment(list params, DbConnection conn);
body
{
	if (checkUserRole("sales")) {
	} else {
		return null;
	}
	var string submit, product_id;
	var string xml_str1, xml_str2;
	var list xml2;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	product_id = al_dst_node(params, "product_id");
	var XmlDbAccessor acc;
	acc = new XmlDbAccessor;
	acc.create("Products", "", conn);
	acc.setDTDfilename("bizsoft/stock/stock.dtd");
	xml_str2 = acc.getXML("product_stock");
	var file f;
	f = al_file_open(xml_str2, "sr");
	xml2 = al_xml("parse", f, null, null);
	xml2 = xml2.head;
	xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/stock/product_id_list.xsl", xml2);
	genPageBegin("Shipment");
	genFormBegin("Shipment", null);
	genText("^F");
	res.out(toUTF8_direct(xml_str1));
	genBR();
	genButton("submit", "\");
	genBR();
	if (submit == "\") {
		var XmlDbObject obj1, obj2;
		var list ls, itr;
		obj1 = acc.get("product_stock");
		ls = obj1.getChildren("i}X^[/i", "^", product_id);
		itr = al_dst_itr(ls);
		obj2 = al_next(itr);
		var string product_name, num_stock;
		product_name = obj2.getField("i");
		num_stock = obj2.getField("");
		genText("iF");
		genText(product_name);
		genBR();
		genText("^F");
		genText(product_id);
		genBR();
		genText("F");
		genText(num_stock);
		genBR();
		genText("F");
		genTextField("po_id", 20, "");
		genBR();
		genText("oF");
		genTextField("num", 10, "");
		genBR();
		genText("F");
		genTextField("money", 20, "");
		genRadio("tax", "O", "O", null);
		genRadio("tax", "", "", (list)1);
		genBR();
		genButton("submit", "o");
		genBR();
	} else {
	}
	if (submit == "o") {
		if (consumer_tax_rate) {
		} else {
			try {
				var XmlDbAccessor acc;
				var XmlDbObject obj;
				var list ls, itr;
				acc = new XmlDbAccessor;
				acc.create("TaxRate", "", conn);
				acc.setDTDfilename("bizsoft/finance/tax_rate.dtd");
				ls = acc.getAll();
				itr = al_dst_itr(ls);
				if (obj = al_next(itr)) {
				} else {
					var AlException ex;
					ex = new AlException;
					ex.msg = "}X^[B";
					throw ex;
				}
				ls = obj.getChildren("}X^[/", "", "");
				itr = al_dst_itr(ls);
				if (obj = al_next(itr) && consumer_tax_rate = obj.getField("")) {
				} else {
					var AlException ex;
					ex = new AlException;
					ex.msg = "B";
					throw ex;
				}
			} catch (AlException e) {
				throw e;
			}
		}
		var string msgId, product_name, po_id, num, money, tax, payment;
		msgId = Context::genMsgId();
		product_name = fromUTF8((string)al_dst_node(params, "product_name"));
		po_id = al_dst_node(params, "po_id");
		num = (integer)al_dst_node(params, "num");
		if (num <= 0) {
			error("o0B");
			return null;
		} else {
		}
		money = (integer)al_dst_node(params, "money");
		tax = fromUTF8((string)al_dst_node(params, "tax"));
		payment = fromUTF8((string)al_dst_node(params, "payment"));
		if (payment <= 0) {
			error("0B");
			return null;
		} else {
		}
		acc = new XmlDbAccessor;
		acc.create("StockInOut", "", conn);
		acc.setDTDfilename("bizsoft/stock/stock_in_out.dtd");
		xml_str2 = al_copy("");
		al_append_str(xml_str2, "<o>");
		al_append_str(xml_str2, "<o>");
		al_append_str(xml_str2, "<i>");
		al_append_str(xml_str2, product_name);
		al_append_str(xml_str2, "</i>");
		al_append_str(xml_str2, "<^>");
		al_append_str(xml_str2, product_id);
		al_append_str(xml_str2, "</^>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, (integer)num);
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, Context::genTimeStamp());
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</o>");
		al_append_str(xml_str2, "</o>");
		acc.putXML(xml_str2, msgId);
		acc = new XmlDbAccessor;
		acc.create("Products", "", conn);
		acc.setDTDfilename("bizsoft/stock/stock.dtd");
		var XmlDbObject obj1, obj2;
		var list ls, itr;
		obj1 = acc.get("product_stock");
		ls = obj1.getChildren("i}X^[/i", "^", product_id);
		itr = al_dst_itr(ls);
		obj2 = al_next(itr);
		obj2.putField("", (string)(num = (integer)obj2.getField("") - num));
		if (num < 0) {
			error("sB");
			return null;
		} else {
		}
		acc = new XmlDbAccessor;
		acc.create("Check", "", conn);
		acc.setDTDfilename("bizsoft/finance/check.dtd");
		var list date1;
		var string date_str1;
		date1 = al_file_manip("current_datetime", null, null);
		date_str1 = date_str(date1);
		xml_str2 = al_copy("");
		al_append_str(xml_str2, "<`[>");
		al_append_str(xml_str2, "<t>");
		al_append_str(xml_str2, date_str1);
		al_append_str(xml_str2, "</t>");
		al_append_str(xml_str2, "<`FbN>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, Context::genTimeStamp());
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<[U>");
		al_append_str(xml_str2, "online_system");
		al_append_str(xml_str2, "</[U>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</`FbN>");
		al_append_str(xml_str2, "<d>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "y-");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		if (tax == "O") {
			al_append_str(xml_str2, "<z>");
			al_append_str(xml_str2, (string)(money + money * (integer)consumer_tax_rate / 100));
			al_append_str(xml_str2, "</z>");
			al_append_str(xml_str2, "<z>");
			al_append_str(xml_str2, (string)(money * (integer)consumer_tax_rate / 100));
			al_append_str(xml_str2, "</z>");
		} else {
		}
		if (tax == "") {
			al_append_str(xml_str2, "<z>");
			al_append_str(xml_str2, (string)money);
			al_append_str(xml_str2, "</z>");
			al_append_str(xml_str2, "<z>");
			al_append_str(xml_str2, (string)(money * (integer)consumer_tax_rate / (100 + (integer)consumer_tax_rate)));
			al_append_str(xml_str2, "</z>");
		} else {
		}
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "d");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, consumer_tax_rate);
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<Ev>");
		al_append_str(xml_str2, "d");
		al_append_str(xml_str2, "</Ev>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, ", F" + (string)po_id);
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<t>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</t>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</d>");
		al_append_str(xml_str2, "<d>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "Y-");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<z>");
		if (tax == "O") {
			al_append_str(xml_str2, (string)(money + money * (integer)consumer_tax_rate / 100));
		} else {
		}
		if (tax == "") {
			al_append_str(xml_str2, (string)money);
		} else {
		}
		al_append_str(xml_str2, "</z>");
		al_append_str(xml_str2, "<z>");
		al_append_str(xml_str2, "</z>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "vZO");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<Ev>");
		al_append_str(xml_str2, "</Ev>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "<t>");
		al_append_str(xml_str2, "");
		al_append_str(xml_str2, "</t>");
		al_append_str(xml_str2, "</>");
		al_append_str(xml_str2, "</d>");
		al_append_str(xml_str2, "</`[>");
		acc.putXML(xml_str2, msgId);
		var XmlDbObject obj;
		acc = new XmlDbAccessor;
		acc.create("PurchaseOrder", "", conn);
		acc.setDTDfilename("bizsoft/sales/purchase_order.dtd");
		try {
			obj = acc.get(po_id);
			obj.putField("/z/", "z");
			obj.putField("/z/", Context::genTimeStamp());
		} catch (AlException e) {
			error("BmFB");
		}
		res.redirectWithSession("ebiz?action=Inventory");
		return null;
	} else {
	}
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: static integer consumer_tax_rate;
end_class
class WebUIbizsoftAccountServlet
member
public: list invokeLogin(list params, DbConnection conn);
body
{
	if (authorize(params, conn)) {
	} else {
		return null;
	}
	if (al_dst_node(user_roles, "webuiadmin")) {
		res.redirect("ebiz?action=WebUiAdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "admin")) {
		res.redirect("ebiz?action=AdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "account")) {
		res.redirect("ebiz?action=AccountHome");
		return null;
	} else {
	}
	error("User '" + user_name + "' does not have required user role");
	return null;
}
end_body
member
public: list invokeAccountHome(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	res.out("<HTML><HEAD>\n<META http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n");
	res.out("<TITLE>Accounting</TITLE></HEAD>\n");
	res.out("<FRAMESET COLS=\"20%,*\" FRAMEBORDER=\"YES\">\n");
	res.out("<FRAME SRC=\"ebiz?action=AccountMenu\" SCROLLING=\"auto\" NAME=\"menu\"/>\n");
	res.out("<FRAME SRC=\"account_home.html\" SCROLLING=\"auto\" NAME=\"action\"/>\n");
	res.out("</FRAMESET>\n");
	res.out("</HTML>\n");
	return null;
}
end_body
member
public: list invokeAccountMenu(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	return menu(params, conn);
}
end_body
member
public: list invokeCheckList(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	var string submit, check_id;
	var string from_year, from_month, from_day, to_year, to_month, to_day;
	var list date1, date2, xml1, xml2;
	var string xml_str1, xml_str2, date_str1, date_str2;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	check_id = al_dst_node(params, "check_id");
	if (submit == "\") {
		if (check_id && check_id != "") {
			var XmlDbAccessor acc;
			acc = new XmlDbAccessor;
			acc.create("Check", "", conn);
			acc.setDTDfilename("bizsoft/finance/check.dtd");
			xml_str2 = acc.getXML(check_id);
			var file f;
			f = al_file_open(xml_str2, "sr");
			xml2 = al_xml("parse", f, null, null);
			xml2 = xml2.head;
			xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/check_show.xsl", xml2);
			genPageBegin("CheckDetail");
			res.out(toUTF8_direct(xml_str1));
			genPageEnd();
			return null;
		} else {
			from_year = al_dst_node(params, "from_year");
			from_month = al_dst_node(params, "from_month");
			from_day = al_dst_node(params, "from_day");
			to_year = al_dst_node(params, "to_year");
			to_month = al_dst_node(params, "to_month");
			to_day = al_dst_node(params, "to_day");
			date1 = al_list6((integer)from_year, (integer)from_month, (integer)from_day, 0, 0, 0);
			date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
		}
	} else {
		if (submit == "C") {
			if (check_id && check_id != "") {
			} else {
				error("`[IB");
				return null;
			}
			var XmlDbAccessor acc;
			var XmlDbObject obj, obj2;
			acc = new XmlDbAccessor;
			acc.create("Check", "", conn);
			acc.setDTDfilename("bizsoft/finance/check.dtd");
			if (obj = acc.get(check_id)) {
			} else {
				error("I`[B");
				return null;
			}
			var integer num_debtor, num_credit_side;
			var string tmp;
			var list tmp_ls, tmp_itr;
			tmp = obj.getField("`[/t");
			tmp_ls = al_str_misc("split", tmp, '/');
			tmp_itr = al_dst_itr(tmp_ls);
			al_set_dst_node(params, "to_year", al_next(tmp_itr));
			al_set_dst_node(params, "to_month", al_next(tmp_itr));
			al_set_dst_node(params, "to_day", al_next(tmp_itr));
			num_debtor = num_credit_side = 0;
			tmp_ls = obj.getChildren("`[/d");
			tmp_itr = al_dst_itr(tmp_ls);
			loop {
				if (obj2 = al_next(tmp_itr)) {
				} else {
					break;
				}
				tmp = toUTF8_direct(obj2.getField("/"));
				if (tmp != "") {
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_selected_ah", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_selected_as", tmp);
					tmp = toUTF8_direct(obj2.getField("/z"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_money", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_tax_kind", tmp);
					tmp = toUTF8_direct(obj2.getField("/z"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_tax", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_tax_rate", tmp);
					tmp = toUTF8_direct(obj2.getField("/Ev"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_summary", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_memo", tmp);
					tmp = toUTF8_direct(obj2.getField("/t"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_tag", tmp);
					num_debtor = num_debtor + 1;
				} else {
				}
				tmp = toUTF8_direct(obj2.getField("/"));
				if (tmp != "") {
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_selected_ah", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_selected_as", tmp);
					tmp = toUTF8_direct(obj2.getField("/z"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_money", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_tax_kind", tmp);
					tmp = toUTF8_direct(obj2.getField("/z"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_tax", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_tax_rate", tmp);
					tmp = toUTF8_direct(obj2.getField("/Ev"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_summary", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_memo", tmp);
					tmp = toUTF8_direct(obj2.getField("/t"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_tag", tmp);
					num_credit_side = num_credit_side + 1;
				} else {
				}
			}
			al_set_dst_node(params, "num_debtor", (string)num_debtor);
			al_set_dst_node(params, "num_credit_side", (string)num_credit_side);
			session.setAttribute("check_id", check_id);
			return invokeCheckInput(params, conn);
		} else {
			if (submit == "") {
				if (check_id && check_id != "") {
					var XmlDbAccessor acc;
					var XmlDbObject obj;
					acc = new XmlDbAccessor;
					acc.create("Check", "", conn);
					acc.setDTDfilename("bizsoft/finance/check.dtd");
					try {
						obj = acc.get(check_id);
					} catch (AlException e) {
						error("I`[B");
						return null;
					}
					date_str1 = obj.getField("`[/t");
					obj.delete();
					{
						var string date_str2, tmp;
						var list ls, itr, ls2, itr2;
						var XmlDbObject obj;
						acc = new XmlDbAccessor;
						acc.create("Stock", "", conn);
						acc.setDTDfilename("bizsoft/finance/stock.dtd");
						ls = acc.getAll();
						itr = al_dst_itr(ls);
						loop {
							if (obj = al_next(itr)) {
							} else {
								break;
							}
							date_str2 = obj.getField("XgbN/t");
							if (date_str2 >= date_str1) {
								obj.putField("XgbN/", "_[eB[");
							} else {
							}
						}
						acc = new XmlDbAccessor;
						acc.create("Flow", "", conn);
						acc.setDTDfilename("bizsoft/finance/flow.dtd");
						ls = acc.getAll();
						itr = al_dst_itr(ls);
						loop {
							if (obj = al_next(itr)) {
							} else {
								break;
							}
							tmp = obj.getField("t[/");
							ls2 = al_str_misc("split", tmp, '-');
							itr2 = al_dst_itr(ls2);
							date_str2 = al_prev(itr2);
							if (date_str2 >= date_str1) {
								obj.putField("t[/", "_[eB[");
							} else {
							}
						}
					}
					conn.commit();
				} else {
					error("`[IB");
					return null;
				}
				from_year = al_dst_node(params, "from_year");
				from_month = al_dst_node(params, "from_month");
				from_day = al_dst_node(params, "from_day");
				to_year = al_dst_node(params, "to_year");
				to_month = al_dst_node(params, "to_month");
				to_day = al_dst_node(params, "to_day");
				date1 = al_list6((integer)from_year, (integer)from_month, (integer)from_day, 0, 0, 0);
				date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
			} else {
				var integer date1_int, date2_int;
				date2_int = al_misc("get_time", null, null);
				date1_int = date2_int - 60 * 60 * 24 * 30;
				date1 = al_misc("get_localtime", date1_int, null);
				date2 = al_misc("get_localtime", date2_int, null);
			}
		}
	}
	xml1 = date_xml(date1);
	xml2 = date_xml(date2);
	xml_str1 = from_date_html(xml1);
	xml_str2 = to_date_html(xml2);
	date_str1 = date_str(date1);
	date_str2 = date_str(date2);
	genPageBegin("CheckList");
	genFormBegin("CheckList", null);
	genText("FromF");
	res.out(toUTF8_direct(xml_str1));
	genBR();
	genText("ToF");
	res.out(toUTF8_direct(xml_str2));
	genBR();
	genButton("submit", "\");
	genButton("submit", "C");
	genButton("submit", "");
	genBR();
	var XmlDbAccessor acc;
	var list ls1, itr1, ls2, itr2;
	var XmlDbObject obj1, obj2;
	acc = new XmlDbAccessor;
	acc.create("Check", "", conn);
	acc.setDTDfilename("bizsoft/finance/check.dtd");
	ls1 = acc.get((list)al_cons(null, null), "`[/t", "string", date_str1, date_str2, "`[/t", "string", null);
	itr1 = al_dst_itr(ls1);
	res.out("<TABLE BORDER>\n");
	res.out(toUTF8_direct("<TR><TD></TD><TD>F</TD><TD>`FbN</TD><TD>t</TD><TD></TD><TD>z</TD><TD></TD><TD>z</TD><TD>Ev</TD><TD></TD><TD>t</TD></TR>\n"));
	loop {
		if (obj1 = al_next(itr1)) {
		} else {
			break;
		}
		var string approval, checked, date;
		date = obj1.getField("`[/t");
		ls2 = obj1.getChildren("`[/`FbN");
		itr2 = al_dst_itr(ls2);
		loop {
			if (obj2 = al_next(itr2)) {
			} else {
				break;
			}
			if (obj2.getField("") == "F") {
				approval = "";
			} else {
			}
			if (obj2.getField("") == "`FbN") {
				checked = "";
			} else {
			}
		}
		var string str, debtor, credit_side, summary, memo, tag;
		var integer debtor_money, credit_side_money;
		ls2 = obj1.getChildren("`[/d");
		itr2 = al_dst_itr(ls2);
		debtor_money = credit_side_money = 0;
		loop {
			if (obj2 = al_next(itr2)) {
			} else {
				break;
			}
			str = obj2.getField("/");
			if (str && str != "") {
				if (debtor) {
				} else {
					debtor = str;
				}
				debtor_money = debtor_money + (integer)obj2.getField("/z");
				str = obj2.getField("/Ev");
				if (str && str != "") {
					if (summary == null) {
						summary = str;
					} else {
						summary = summary + ":" + str;
					}
				} else {
				}
				str = obj2.getField("/");
				if (str && str != "") {
					if (memo == null) {
						memo = str;
					} else {
						memo = memo + ":" + str;
					}
				} else {
				}
				str = obj2.getField("/t");
				if (str == "L") {
					tag = "L";
				} else {
				}
			} else {
			}
			str = obj2.getField("/");
			if (str && str != "") {
				if (credit_side) {
				} else {
					credit_side = str;
				}
				credit_side_money = credit_side_money + (integer)obj2.getField("/z");
				str = obj2.getField("/Ev");
				if (str && str != "") {
					if (summary == null) {
						summary = str;
					} else {
						summary = summary + ":" + str;
					}
				} else {
				}
				str = obj2.getField("/");
				if (str && str != "") {
					if (memo == null) {
						memo = str;
					} else {
						memo = memo + ":" + str;
					}
				} else {
				}
				str = obj2.getField("/t");
				if (str == "L") {
					tag = "L";
				} else {
				}
			} else {
			}
		}
		res.out("<TR><TD>");
		genRadio("check_id", obj1.msgId, "", null);
		res.out("</TD><TD>");
		genText(approval);
		res.out("</TD><TD>");
		genText(checked);
		res.out("</TD><TD>");
		genText(date);
		res.out("</TD><TD>");
		genText(debtor);
		res.out("</TD><TD>");
		genText((string)debtor_money);
		res.out("</TD><TD>");
		genText(credit_side);
		res.out("</TD><TD>");
		genText((string)credit_side_money);
		res.out("</TD><TD>");
		genText(summary);
		res.out("</TD><TD>");
		genText(memo);
		res.out("</TD><TD>");
		genText(tag);
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeCheckInput(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	var string submit, date_xml1_str, xml_str1, xml_str2;
	var integer num_debtor, num_credit_side;
	var list input, date_xml1, debtor_xmls, credit_side_xmls, debtor_xmls2, credit_side_xmls2, xml2;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	if (submit == "U`[" || submit == "`[" || submit == "o`[" || submit == "`[" || submit == "id`[" || submit == "d`[" || submit == "co" || submit == "o" || submit == "w") {
		session.setAttribute("check_id", null);
		input = 1;
		num_debtor = num_credit_side = 1;
		date_xml1 = date_xml((list)al_misc("get_localtime", al_misc("get_time", null, null), null));
		debtor_xmls = al_cons(al_list2(submit, null), null);
		credit_side_xmls = al_cons(al_list2(submit, null), null);
	} else {
	}
	if (submit == "" || submit == "") {
		input = 1;
		num_debtor = (integer)al_dst_node(params, "num_debtor");
		num_credit_side = (integer)al_dst_node(params, "num_credit_side");
		date_xml1 = date_xml((list)al_list3((integer)al_dst_node(params, "to_year"), (integer)al_dst_node(params, "to_month"), (integer)al_dst_node(params, "to_day")));
		var integer idx;
		idx = 0;
		loop {
			if (idx < num_debtor) {
			} else {
				break;
			}
			var string ah_type, selected_ah;
			ah_type = fromUTF8((string)al_dst_node(params, "debtor_" + (string)idx + "_ah_type"));
			selected_ah = fromUTF8((string)al_dst_node(params, "debtor_" + (string)idx + "_selected_ah"));
			debtor_xmls = al_append_list(debtor_xmls, al_list2(ah_type, selected_ah));
			idx = idx + 1;
		}
		idx = 0;
		loop {
			if (idx < num_credit_side) {
			} else {
				break;
			}
			var string ah_type, selected_ah;
			ah_type = fromUTF8((string)al_dst_node(params, "credit_side_" + (string)idx + "_ah_type"));
			selected_ah = fromUTF8((string)al_dst_node(params, "credit_side_" + (string)idx + "_selected_ah"));
			credit_side_xmls = al_append_list(credit_side_xmls, al_list2(ah_type, selected_ah));
			idx = idx + 1;
		}
		if (submit == "") {
			num_debtor = num_debtor + 1;
			debtor_xmls = al_append_list(debtor_xmls, al_list2("U`[", null));
		} else {
			num_credit_side = num_credit_side + 1;
			credit_side_xmls = al_append_list(credit_side_xmls, al_list2("U`[", null));
		}
	} else {
	}
	if (submit == "") {
		input = 2;
		num_debtor = (integer)al_dst_node(params, "num_debtor");
		num_credit_side = (integer)al_dst_node(params, "num_credit_side");
		date_xml1 = date_xml((list)al_list3((integer)al_dst_node(params, "to_year"), (integer)al_dst_node(params, "to_month"), (integer)al_dst_node(params, "to_day")));
		var integer idx;
		idx = 0;
		loop {
			if (idx < num_debtor) {
			} else {
				break;
			}
			var string selected_ah;
			var list props;
			props = al_cons(null, null);
			al_create_arc(props, "", "selected_as");
			al_create_arc(props, "", "money");
			al_create_arc(props, "", "tax");
			al_create_arc(props, consumer_tax_rate, "tax_rate");
			al_create_arc(props, "", "summary");
			al_create_arc(props, "", "memo");
			al_create_arc(props, "", "tag");
			selected_ah = fromUTF8((string)al_dst_node(params, "debtor_" + (string)idx + "_selected_ah"));
			debtor_xmls = al_append_list(debtor_xmls, al_list3(null, selected_ah, props));
			idx = idx + 1;
		}
		idx = 0;
		loop {
			if (idx < num_credit_side) {
			} else {
				break;
			}
			var string selected_ah;
			var list props;
			props = al_cons(null, null);
			al_create_arc(props, "", "selected_as");
			al_create_arc(props, "", "money");
			al_create_arc(props, "", "tax");
			al_create_arc(props, consumer_tax_rate, "tax_rate");
			al_create_arc(props, "", "summary");
			al_create_arc(props, "", "memo");
			al_create_arc(props, "", "tag");
			selected_ah = fromUTF8((string)al_dst_node(params, "credit_side_" + (string)idx + "_selected_ah"));
			credit_side_xmls = al_append_list(credit_side_xmls, al_list3(null, selected_ah, props));
			idx = idx + 1;
		}
	} else {
	}
	if (submit == "O" || submit == "" || submit == "O" || submit == "" || submit == "m" || submit == "C") {
		input = 2;
		num_debtor = (integer)al_dst_node(params, "num_debtor");
		num_credit_side = (integer)al_dst_node(params, "num_credit_side");
		date_xml1 = date_xml((list)al_list3((integer)al_dst_node(params, "to_year"), (integer)al_dst_node(params, "to_month"), (integer)al_dst_node(params, "to_day")));
		var integer idx;
		idx = 0;
		debtor_xmls = null;
		loop {
			if (idx < num_debtor) {
			} else {
				break;
			}
			var string selected_ah, selected_as, tmp;
			selected_ah = fromUTF8((string)al_dst_node(params, "debtor_" + (string)idx + "_selected_ah"));
			var list props;
			props = al_cons(null, null);
			tmp = al_dst_node(params, "debtor_" + (string)idx + "_selected_as");
			al_create_arc(props, fromUTF8(tmp), "selected_as");
			tmp = al_dst_node(params, "debtor_" + (string)idx + "_money");
			al_create_arc(props, fromUTF8(tmp), "money");
			tmp = al_dst_node(params, "debtor_" + (string)idx + "_tax_kind");
			al_create_arc(props, fromUTF8(tmp), "tax_kind");
			tmp = al_dst_node(params, "debtor_" + (string)idx + "_tax");
			al_create_arc(props, fromUTF8(tmp), "tax");
			tmp = al_dst_node(params, "debtor_" + (string)idx + "_tax_rate");
			al_create_arc(props, fromUTF8(tmp), "tax_rate");
			tmp = al_dst_node(params, "debtor_" + (string)idx + "_summary");
			al_create_arc(props, fromUTF8(tmp), "summary");
			tmp = al_dst_node(params, "debtor_" + (string)idx + "_memo");
			al_create_arc(props, fromUTF8(tmp), "memo");
			tmp = al_dst_node(params, "debtor_" + (string)idx + "_tag");
			al_create_arc(props, fromUTF8(tmp), "tag");
			debtor_xmls = al_append_list(debtor_xmls, al_list3(null, selected_ah, props));
			idx = idx + 1;
		}
		idx = 0;
		credit_side_xmls = null;
		loop {
			if (idx < num_credit_side) {
			} else {
				break;
			}
			var string selected_ah, selected_as, tmp;
			selected_ah = fromUTF8((string)al_dst_node(params, "credit_side_" + (string)idx + "_selected_ah"));
			var list props;
			props = al_cons(null, null);
			tmp = al_dst_node(params, "credit_side_" + (string)idx + "_selected_as");
			al_create_arc(props, fromUTF8(tmp), "selected_as");
			tmp = al_dst_node(params, "credit_side_" + (string)idx + "_money");
			al_create_arc(props, fromUTF8(tmp), "money");
			tmp = al_dst_node(params, "credit_side_" + (string)idx + "_tax_kind");
			al_create_arc(props, fromUTF8(tmp), "tax_kind");
			tmp = al_dst_node(params, "credit_side_" + (string)idx + "_tax");
			al_create_arc(props, fromUTF8(tmp), "tax");
			tmp = al_dst_node(params, "credit_side_" + (string)idx + "_tax_rate");
			al_create_arc(props, fromUTF8(tmp), "tax_rate");
			tmp = al_dst_node(params, "credit_side_" + (string)idx + "_summary");
			al_create_arc(props, fromUTF8(tmp), "summary");
			tmp = al_dst_node(params, "credit_side_" + (string)idx + "_memo");
			al_create_arc(props, fromUTF8(tmp), "memo");
			tmp = al_dst_node(params, "credit_side_" + (string)idx + "_tag");
			al_create_arc(props, fromUTF8(tmp), "tag");
			credit_side_xmls = al_append_list(credit_side_xmls, al_list3(null, selected_ah, props));
			idx = idx + 1;
		}
	} else {
	}
	if (submit == "O") {
		var integer idx;
		idx = 0;
		debtor_xmls2 = debtor_xmls;
		loop {
			if (idx < num_debtor) {
			} else {
				break;
			}
			var list props;
			props = debtor_xmls2.head.tail.tail.head;
			var string money, tax, tax_rate;
			money = al_dst_node(props, "money");
			tax = al_dst_node(props, "tax");
			tax_rate = al_dst_node(props, "tax_rate");
			if (money != "" && tax == "" && tax_rate != "") {
				tax = (string)((integer)money * (integer)tax_rate / 100);
				money = (string)((integer)money + (integer)tax);
				al_set_dst_node(props, "tax", tax);
				al_set_dst_node(props, "money", money);
			} else {
			}
			debtor_xmls2 = debtor_xmls2.tail;
			idx = idx + 1;
		}
	} else {
	}
	if (submit == "") {
		var integer idx;
		idx = 0;
		debtor_xmls2 = debtor_xmls;
		loop {
			if (idx < num_debtor) {
			} else {
				break;
			}
			var list props;
			props = debtor_xmls2.head.tail.tail.head;
			var string money, tax, tax_rate;
			money = al_dst_node(props, "money");
			tax = al_dst_node(props, "tax");
			tax_rate = al_dst_node(props, "tax_rate");
			if (money != "" && tax == "" && tax_rate != "") {
				tax = (string)((integer)money * (integer)tax_rate / (100 + (integer)tax_rate));
				al_set_dst_node(props, "tax", tax);
			} else {
			}
			debtor_xmls2 = debtor_xmls2.tail;
			idx = idx + 1;
		}
	} else {
	}
	if (submit == "O") {
		var integer idx;
		idx = 0;
		credit_side_xmls2 = credit_side_xmls;
		loop {
			if (idx < num_credit_side) {
			} else {
				break;
			}
			var list props;
			props = credit_side_xmls2.head.tail.tail.head;
			var string money, tax, tax_rate;
			money = al_dst_node(props, "money");
			tax = al_dst_node(props, "tax");
			tax_rate = al_dst_node(props, "tax_rate");
			if (money != "" && tax == "" && tax_rate != "") {
				tax = (string)((integer)money * (integer)tax_rate / 100);
				money = (string)((integer)money + (integer)tax);
				al_set_dst_node(props, "tax", tax);
				al_set_dst_node(props, "money", money);
			} else {
			}
			credit_side_xmls2 = credit_side_xmls2.tail;
			idx = idx + 1;
		}
	} else {
	}
	if (submit == "") {
		var integer idx;
		idx = 0;
		credit_side_xmls2 = credit_side_xmls;
		loop {
			if (idx < num_credit_side) {
			} else {
				break;
			}
			var list props;
			props = credit_side_xmls2.head.tail.tail.head;
			var string money, tax, tax_rate;
			money = al_dst_node(props, "money");
			tax = al_dst_node(props, "tax");
			tax_rate = al_dst_node(props, "tax_rate");
			if (money != "" && tax == "" && tax_rate != "") {
				tax = (string)((integer)money * (integer)tax_rate / (100 + (integer)tax_rate));
				al_set_dst_node(props, "tax", tax);
			} else {
			}
			credit_side_xmls2 = credit_side_xmls2.tail;
			idx = idx + 1;
		}
	} else {
	}
	if (submit == "m") {
		var string check_id;
		if (check_id = session.getAttribute("check_id")) {
			try {
				var XmlDbAccessor acc;
				var XmlDbObject obj;
				acc = new XmlDbAccessor;
				acc.create("Check", "", conn);
				acc.setDTDfilename("bizsoft/finance/check.dtd");
				if (obj = acc.get(check_id)) {
					obj.delete();
				} else {
				}
			} catch (AlException e) {
			}
		} else {
		}
		var string message, xml, msgId;
		var integer debtor_total, credit_side_total;
		debtor_total = credit_side_total = 0;
		xml = al_copy("<`[>");
		al_append_str(xml, "<t>");
		al_append_str(xml, al_dst_node(params, "to_year") + "/" + al_dst_node(params, "to_month") + "/" + al_dst_node(params, "to_day"));
		al_append_str(xml, "</t>");
		al_append_str(xml, "<`FbN>");
		al_append_str(xml, "<>");
		al_append_str(xml, Context::genTimeStamp2());
		al_append_str(xml, "</>");
		al_append_str(xml, "<[U>");
		al_append_str(xml, user_name);
		al_append_str(xml, "</[U>");
		al_append_str(xml, "<></>");
		al_append_str(xml, "<></>");
		al_append_str(xml, "</`FbN>");
		var integer idx;
		idx = 0;
		debtor_xmls2 = debtor_xmls;
		loop {
			if (idx < num_debtor) {
			} else {
				break;
			}
			al_append_str(xml, "<d><>");
			var string selected_ah, selected_as;
			var string money, tax_kind, tax, tax_rate, summary, memo, tag;
			var list props;
			selected_ah = debtor_xmls2.head.tail.head;
			props = debtor_xmls2.head.tail.tail.head;
			selected_as = al_dst_node(props, "selected_as");
			money = al_dst_node(props, "money");
			if (message) {
			} else {
				if (money == "") {
					message = "zB";
				} else {
				}
			}
			debtor_total = debtor_total + (integer)money;
			tax_kind = al_dst_node(props, "tax_kind");
			tax = al_dst_node(props, "tax");
			if (message) {
			} else {
				if (al_str_misc("starts_with", tax_kind, "") && tax == "") {
					message = "zB";
				} else {
				}
			}
			tax_rate = al_dst_node(props, "tax_rate");
			summary = al_dst_node(props, "summary");
			memo = al_dst_node(props, "memo");
			tag = al_dst_node(props, "tag");
			al_append_str(xml, "<>");
			al_append_str(xml, selected_ah);
			al_append_str(xml, "</>");
			al_append_str(xml, "<>");
			al_append_str(xml, selected_as);
			al_append_str(xml, "</>");
			al_append_str(xml, "<z>");
			al_append_str(xml, money);
			al_append_str(xml, "</z>");
			al_append_str(xml, "<z>");
			al_append_str(xml, tax);
			al_append_str(xml, "</z>");
			al_append_str(xml, "<>");
			al_append_str(xml, tax_kind);
			al_append_str(xml, "</>");
			al_append_str(xml, "<>");
			al_append_str(xml, tax_rate);
			al_append_str(xml, "</>");
			al_append_str(xml, "<Ev>");
			al_append_str(xml, summary);
			al_append_str(xml, "</Ev>");
			al_append_str(xml, "<>");
			al_append_str(xml, memo);
			al_append_str(xml, "</>");
			al_append_str(xml, "<t>");
			al_append_str(xml, tag);
			al_append_str(xml, "</t>");
			al_append_str(xml, "</></d>");
			debtor_xmls2 = debtor_xmls2.tail;
			idx = idx + 1;
		}
		idx = 0;
		credit_side_xmls2 = credit_side_xmls;
		loop {
			if (idx < num_credit_side) {
			} else {
				break;
			}
			al_append_str(xml, "<d><>");
			var string selected_ah, selected_as;
			var string money, tax_kind, tax, tax_rate, summary, memo, tag;
			var list props;
			selected_ah = credit_side_xmls2.head.tail.head;
			props = credit_side_xmls2.head.tail.tail.head;
			selected_as = al_dst_node(props, "selected_as");
			money = al_dst_node(props, "money");
			if (message) {
			} else {
				if (money == "") {
					message = "zB";
				} else {
				}
			}
			credit_side_total = credit_side_total + (integer)money;
			tax_kind = al_dst_node(props, "tax_kind");
			tax = al_dst_node(props, "tax");
			if (message) {
			} else {
				if (al_str_misc("starts_with", tax_kind, "") && tax == "") {
					message = "zB";
				} else {
				}
			}
			tax_rate = al_dst_node(props, "tax_rate");
			summary = al_dst_node(props, "summary");
			memo = al_dst_node(props, "memo");
			tag = al_dst_node(props, "tag");
			al_append_str(xml, "<>");
			al_append_str(xml, selected_ah);
			al_append_str(xml, "</>");
			al_append_str(xml, "<>");
			al_append_str(xml, selected_as);
			al_append_str(xml, "</>");
			al_append_str(xml, "<z>");
			al_append_str(xml, money);
			al_append_str(xml, "</z>");
			al_append_str(xml, "<z>");
			al_append_str(xml, tax);
			al_append_str(xml, "</z>");
			al_append_str(xml, "<>");
			al_append_str(xml, tax_kind);
			al_append_str(xml, "</>");
			al_append_str(xml, "<>");
			al_append_str(xml, tax_rate);
			al_append_str(xml, "</>");
			al_append_str(xml, "<Ev>");
			al_append_str(xml, summary);
			al_append_str(xml, "</Ev>");
			al_append_str(xml, "<>");
			al_append_str(xml, memo);
			al_append_str(xml, "</>");
			al_append_str(xml, "<t>");
			al_append_str(xml, tag);
			al_append_str(xml, "</t>");
			al_append_str(xml, "</></d>");
			credit_side_xmls2 = credit_side_xmls2.tail;
			idx = idx + 1;
		}
		al_append_str(xml, "</`[>");
		if (message) {
		} else {
			if (debtor_total != credit_side_total) {
				message = "vzvzvB";
			} else {
			}
		}
		if (message) {
			error(message);
			return null;
		} else {
		}
		var XmlDbAccessor acc;
		acc = new XmlDbAccessor;
		acc.create("Check", "", conn);
		acc.setDTDfilename("bizsoft/finance/check.dtd");
		acc.putXML(xml, msgId = Context::genMsgId());
		{
			var string date_str1, date_str2, tmp;
			date_str1 = al_dst_node(params, "to_year") + "/" + al_dst_node(params, "to_month") + "/" + al_dst_node(params, "to_day");
			var list ls, itr, ls2, itr2;
			var XmlDbObject obj;
			acc = new XmlDbAccessor;
			acc.create("Stock", "", conn);
			acc.setDTDfilename("bizsoft/finance/stock.dtd");
			ls = acc.getAll();
			itr = al_dst_itr(ls);
			loop {
				if (obj = al_next(itr)) {
				} else {
					break;
				}
				date_str2 = obj.getField("XgbN/t");
				if (date_str2 >= date_str1) {
					obj.putField("XgbN/", "_[eB[");
				} else {
				}
			}
			acc = new XmlDbAccessor;
			acc.create("Flow", "", conn);
			acc.setDTDfilename("bizsoft/finance/flow.dtd");
			ls = acc.getAll();
			itr = al_dst_itr(ls);
			loop {
				if (obj = al_next(itr)) {
				} else {
					break;
				}
				tmp = obj.getField("t[/");
				ls2 = al_str_misc("split", tmp, '-');
				itr2 = al_dst_itr(ls2);
				date_str2 = al_prev(itr2);
				if (date_str2 >= date_str1) {
					obj.putField("t[/", "_[eB[");
				} else {
				}
			}
		}
		conn.commit();
		var list params2;
		params2 = al_cons(null, null);
		al_create_arc(params2, "\", "submit");
		al_create_arc(params2, msgId, "check_id");
		return invokeCheckList(params2, conn);
	} else {
	}
	if (input) {
		genPageBegin("CheckInput");
		genFormBegin("CheckInput", null);
		genText("tF");
		date_xml1_str = to_date_html(date_xml1);
		res.out(toUTF8_direct(date_xml1_str));
		genBR();
		genHidden("num_debtor", (string)num_debtor);
		genHidden("num_credit_side", (string)num_credit_side);
		if (input == 1) {
			genText(" ");
			genBR();
			var integer idx;
			idx = 0;
			debtor_xmls2 = debtor_xmls;
			loop {
				if (idx < num_debtor) {
				} else {
					break;
				}
				var string ah_type, selected_ah;
				ah_type = debtor_xmls2.head.head;
				selected_ah = debtor_xmls2.head.tail.head;
				xml_str2 = al_copy("<EBIZ>");
				al_append_str(xml_str2, "<Name>");
				al_append_str(xml_str2, "debtor_" + (string)idx);
				al_append_str(xml_str2, "</Name>");
				al_append_str(xml_str2, "<Type>");
				al_append_str(xml_str2, (string)ah_type);
				al_append_str(xml_str2, "</Type>");
				al_append_str(xml_str2, "<Selected>");
				al_append_str(xml_str2, (string)selected_ah);
				al_append_str(xml_str2, "</Selected>");
				al_append_str(xml_str2, debtor_ah_list(ah_type, conn));
				al_append_str(xml_str2, "</EBIZ>");
				var file f;
				f = al_file_open(xml_str2, "sr");
				xml2 = al_xml("parse", f, null, null);
				xml2 = xml2.head;
				xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/check_input_1.xsl", xml2);
				res.out(toUTF8_direct(xml_str1));
				genBR();
				idx = idx + 1;
				debtor_xmls2 = debtor_xmls2.tail;
			}
			genButton("submit", "");
			genBR();
			genText(" ");
			genBR();
			idx = 0;
			credit_side_xmls2 = credit_side_xmls;
			loop {
				if (idx < num_credit_side) {
				} else {
					break;
				}
				var string ah_type, selected_ah;
				ah_type = credit_side_xmls2.head.head;
				selected_ah = credit_side_xmls2.head.tail.head;
				xml_str2 = al_copy("<EBIZ>");
				al_append_str(xml_str2, "<Name>");
				al_append_str(xml_str2, "credit_side_" + (string)idx);
				al_append_str(xml_str2, "</Name>");
				al_append_str(xml_str2, "<Type>");
				al_append_str(xml_str2, (string)ah_type);
				al_append_str(xml_str2, "</Type>");
				al_append_str(xml_str2, "<Selected>");
				al_append_str(xml_str2, (string)selected_ah);
				al_append_str(xml_str2, "</Selected>");
				al_append_str(xml_str2, credit_side_ah_list(ah_type, conn));
				al_append_str(xml_str2, "</EBIZ>");
				var file f;
				f = al_file_open(xml_str2, "sr");
				xml2 = al_xml("parse", f, null, null);
				xml2 = xml2.head;
				xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/check_input_1.xsl", xml2);
				res.out(toUTF8_direct(xml_str1));
				genBR();
				idx = idx + 1;
				credit_side_xmls2 = credit_side_xmls2.tail;
			}
			genButton("submit", "");
			genBR();
			genButton("submit", "");
			genBR();
		} else {
		}
		if (input == 2) {
			genText(" ");
			genBR();
			var integer idx;
			idx = 0;
			debtor_xmls2 = debtor_xmls;
			loop {
				if (idx < num_debtor) {
				} else {
					break;
				}
				var string selected_ah, selected_as;
				var list props;
				selected_ah = debtor_xmls2.head.tail.head;
				props = debtor_xmls2.head.tail.tail.head;
				selected_as = al_dst_node(props, "selected_as");
				xml_str2 = al_copy("<EBIZ>");
				al_append_str(xml_str2, "<Name>");
				al_append_str(xml_str2, "debtor_" + (string)idx);
				al_append_str(xml_str2, "</Name>");
				al_append_str(xml_str2, "<Selected>");
				al_append_str(xml_str2, (string)selected_ah);
				al_append_str(xml_str2, "</Selected>");
				al_append_str(xml_str2, "<Selected2>");
				if (selected_as) {
					al_append_str(xml_str2, selected_as);
				} else {
				}
				al_append_str(xml_str2, "</Selected2>");
				al_append_str(xml_str2, as_list(selected_ah, "debtor", props, conn));
				al_append_str(xml_str2, "</EBIZ>");
				var file f;
				f = al_file_open(xml_str2, "sr");
				xml2 = al_xml("parse", f, null, null);
				xml2 = xml2.head;
				xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/check_input_2.xsl", xml2);
				res.out(toUTF8_direct(xml_str1));
				genBR();
				idx = idx + 1;
				debtor_xmls2 = debtor_xmls2.tail;
			}
			genButton("submit", "O");
			genButton("submit", "");
			genBR();
			genText(" ");
			genBR();
			idx = 0;
			credit_side_xmls2 = credit_side_xmls;
			loop {
				if (idx < num_credit_side) {
				} else {
					break;
				}
				var string selected_ah, selected_as;
				var list props;
				selected_ah = credit_side_xmls2.head.tail.head;
				props = credit_side_xmls2.head.tail.tail.head;
				selected_as = al_dst_node(props, "selected_as");
				xml_str2 = al_copy("<EBIZ>");
				al_append_str(xml_str2, "<Name>");
				al_append_str(xml_str2, "credit_side_" + (string)idx);
				al_append_str(xml_str2, "</Name>");
				al_append_str(xml_str2, "<Selected>");
				al_append_str(xml_str2, (string)selected_ah);
				al_append_str(xml_str2, "</Selected>");
				al_append_str(xml_str2, "<Selected2>");
				if (selected_as) {
					al_append_str(xml_str2, selected_as);
				} else {
				}
				al_append_str(xml_str2, "</Selected2>");
				al_append_str(xml_str2, as_list(selected_ah, "credit_side", props, conn));
				al_append_str(xml_str2, "</EBIZ>");
				var file f;
				f = al_file_open(xml_str2, "sr");
				xml2 = al_xml("parse", f, null, null);
				xml2 = xml2.head;
				xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/check_input_2.xsl", xml2);
				res.out(toUTF8_direct(xml_str1));
				genBR();
				idx = idx + 1;
				credit_side_xmls2 = credit_side_xmls2.tail;
			}
			genButton("submit", "O");
			genButton("submit", "");
			genBR();
			genButton("submit", "m");
			genBR();
		} else {
		}
		genFormEnd();
		genPageEnd();
		return null;
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeCheckCheck(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	var string submit, type, memo, check_id, from_year, from_month, from_day, to_year, to_month, to_day;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	type = fromUTF8((string)al_dst_node(params, "type"));
	memo = fromUTF8((string)al_dst_node(params, "memo"));
	check_id = al_dst_node(params, "check_id");
	var list date1, date2, xml1, xml2;
	var string xml_str1, xml_str2, date_str1, date_str2;
	if (submit == "\") {
		if (check_id && check_id != "") {
			var XmlDbAccessor acc;
			acc = new XmlDbAccessor;
			acc.create("Check", "", conn);
			acc.setDTDfilename("bizsoft/finance/check.dtd");
			xml_str2 = acc.getXML(check_id);
			var file f;
			f = al_file_open(xml_str2, "sr");
			xml2 = al_xml("parse", f, null, null);
			xml2 = xml2.head;
			xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/check_show.xsl", xml2);
			genPageBegin("CheckDetail");
			res.out(toUTF8_direct(xml_str1));
			genPageEnd();
			return null;
		} else {
			error("`[IB");
			return null;
		}
	} else {
		if (submit == "C") {
			if (check_id && check_id != "") {
			} else {
				error("`[IB");
				return null;
			}
			var XmlDbAccessor acc;
			var XmlDbObject obj, obj2;
			acc = new XmlDbAccessor;
			acc.create("Check", "", conn);
			acc.setDTDfilename("bizsoft/finance/check.dtd");
			if (obj = acc.get(check_id)) {
			} else {
				error("I`[B");
				return null;
			}
			var integer num_debtor, num_credit_side;
			var string tmp;
			var list tmp_ls, tmp_itr;
			tmp = obj.getField("`[/t");
			tmp_ls = al_str_misc("split", tmp, '/');
			tmp_itr = al_dst_itr(tmp_ls);
			al_set_dst_node(params, "to_year", al_next(tmp_itr));
			al_set_dst_node(params, "to_month", al_next(tmp_itr));
			al_set_dst_node(params, "to_day", al_next(tmp_itr));
			num_debtor = num_credit_side = 0;
			tmp_ls = obj.getChildren("`[/d");
			tmp_itr = al_dst_itr(tmp_ls);
			loop {
				if (obj2 = al_next(tmp_itr)) {
				} else {
					break;
				}
				tmp = toUTF8_direct(obj2.getField("/"));
				if (tmp != "") {
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_selected_ah", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_selected_as", tmp);
					tmp = toUTF8_direct(obj2.getField("/z"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_money", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_tax_kind", tmp);
					tmp = toUTF8_direct(obj2.getField("/z"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_tax", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_tax_rate", tmp);
					tmp = toUTF8_direct(obj2.getField("/Ev"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_summary", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_memo", tmp);
					tmp = toUTF8_direct(obj2.getField("/t"));
					al_set_dst_node(params, "debtor_" + (string)num_debtor + "_tag", tmp);
					num_debtor = num_debtor + 1;
				} else {
				}
				tmp = toUTF8_direct(obj2.getField("/"));
				if (tmp != "") {
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_selected_ah", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_selected_as", tmp);
					tmp = toUTF8_direct(obj2.getField("/z"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_money", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_tax_kind", tmp);
					tmp = toUTF8_direct(obj2.getField("/z"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_tax", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_tax_rate", tmp);
					tmp = toUTF8_direct(obj2.getField("/Ev"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_summary", tmp);
					tmp = toUTF8_direct(obj2.getField("/"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_memo", tmp);
					tmp = toUTF8_direct(obj2.getField("/t"));
					al_set_dst_node(params, "credit_side_" + (string)num_credit_side + "_tag", tmp);
					num_credit_side = num_credit_side + 1;
				} else {
				}
			}
			al_set_dst_node(params, "num_debtor", (string)num_debtor);
			al_set_dst_node(params, "num_credit_side", (string)num_credit_side);
			session.setAttribute("check_id", check_id);
			return invokeCheckInput(params, conn);
		} else {
			if (submit == "`FbN") {
				if (check_id && check_id != "") {
					var XmlDbAccessor acc;
					var XmlDbObject obj, obj2;
					acc = new XmlDbAccessor;
					acc.create("Check", "", conn);
					acc.setDTDfilename("bizsoft/finance/check.dtd");
					if (obj = acc.get(check_id)) {
					} else {
						error("I`[B");
						return null;
					}
					obj2 = obj.createChild("`[/`FbN");
					obj2.putField("", Context::genTimeStamp2());
					obj2.putField("[U", user_name);
					obj2.putField("", "`FbN");
					obj2.putField("", memo);
					conn.commit();
				} else {
					error("`[IB");
					return null;
				}
				from_year = al_dst_node(params, "from_year");
				from_month = al_dst_node(params, "from_month");
				from_day = al_dst_node(params, "from_day");
				to_year = al_dst_node(params, "to_year");
				to_month = al_dst_node(params, "to_month");
				to_day = al_dst_node(params, "to_day");
				date1 = al_list6((integer)from_year, (integer)from_month, (integer)from_day, 0, 0, 0);
				date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
			} else {
				if (submit == "F") {
					if (check_id && check_id != "") {
						var XmlDbAccessor acc;
						var XmlDbObject obj, obj2;
						acc = new XmlDbAccessor;
						acc.create("Check", "", conn);
						acc.setDTDfilename("bizsoft/finance/check.dtd");
						if (obj = acc.get(check_id)) {
						} else {
							error("I`[B");
							return null;
						}
						obj2 = obj.createChild("`[/`FbN");
						obj2.putField("", Context::genTimeStamp2());
						obj2.putField("[U", user_name);
						obj2.putField("", "F");
						obj2.putField("", memo);
						conn.commit();
					} else {
						error("`[IB");
						return null;
					}
					from_year = al_dst_node(params, "from_year");
					from_month = al_dst_node(params, "from_month");
					from_day = al_dst_node(params, "from_day");
					to_year = al_dst_node(params, "to_year");
					to_month = al_dst_node(params, "to_month");
					to_day = al_dst_node(params, "to_day");
					date1 = al_list6((integer)from_year, (integer)from_month, (integer)from_day, 0, 0, 0);
					date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
				} else {
					if (submit == "") {
						from_year = al_dst_node(params, "from_year");
						from_month = al_dst_node(params, "from_month");
						from_day = al_dst_node(params, "from_day");
						to_year = al_dst_node(params, "to_year");
						to_month = al_dst_node(params, "to_month");
						to_day = al_dst_node(params, "to_day");
						date1 = al_list6((integer)from_year, (integer)from_month, (integer)from_day, 0, 0, 0);
						date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
					} else {
						var integer date1_int, date2_int;
						date2_int = al_misc("get_time", null, null);
						date1_int = date2_int - 60 * 60 * 24 * 30;
						date1 = al_misc("get_localtime", date1_int, null);
						date2 = al_misc("get_localtime", date2_int, null);
					}
				}
			}
		}
	}
	xml1 = date_xml(date1);
	xml2 = date_xml(date2);
	xml_str1 = from_date_html(xml1);
	xml_str2 = to_date_html(xml2);
	date_str1 = date_str(date1);
	date_str2 = date_str(date2);
	var XmlDbAccessor acc;
	var list ls1, itr1, ls2, itr2;
	var XmlDbObject obj1, obj2;
	if (type == "`FbN" || type == "F") {
		acc = new XmlDbAccessor;
		acc.create("Check", "", conn);
		acc.setDTDfilename("bizsoft/finance/check.dtd");
		ls1 = acc.get((list)al_cons(null, null), "`[/t", "string", date_str1, date_str2, "`[/t", "string", null);
	} else {
	}
	genPageBegin("CheckCheck");
	genFormBegin("CheckCheck", null);
	genText("FromF");
	res.out(toUTF8_direct(xml_str1));
	genBR();
	genText("ToF");
	res.out(toUTF8_direct(xml_str2));
	genBR();
	if (type == "`FbN" || type == "F") {
		genButton("submit", "\");
		genButton("submit", "C");
		genButton("submit", "`FbN");
		genButton("submit", "F");
		genBR();
		genText("");
		genTextField("memo", 40, "");
	} else {
		var list values;
		values = al_cons(null, null);
		al_create_arc(values, "`FbN", null);
		al_create_arc(values, "F", null);
		genSelect("type", values);
		genButton("submit", "");
	}
	genBR();
	if (type == "`FbN" || type == "F") {
		itr1 = al_dst_itr(ls1);
		res.out("<TABLE BORDER>\n");
		res.out(toUTF8_direct("<TR><TD></TD><TD>F</TD><TD>`FbN</TD><TD>t</TD><TD></TD><TD>z</TD><TD></TD><TD>z</TD><TD>Ev</TD><TD></TD><TD>t</TD></TR>\n"));
		loop {
			if (obj1 = al_next(itr1)) {
			} else {
				break;
			}
			var string approval, checked, date;
			date = obj1.getField("`[/t");
			ls2 = obj1.getChildren("`[/`FbN");
			itr2 = al_dst_itr(ls2);
			loop {
				if (obj2 = al_next(itr2)) {
				} else {
					break;
				}
				if (obj2.getField("") == "F") {
					approval = "";
				} else {
				}
				if (obj2.getField("") == "`FbN") {
					checked = "";
				} else {
				}
			}
			if (type == "F" && approval == "") {
				continue;
			} else {
			}
			if (type == "`FbN" && checked == "") {
				continue;
			} else {
			}
			var string str, debtor, credit_side, summary, memo, tag;
			var integer debtor_money, credit_side_money;
			ls2 = obj1.getChildren("`[/d");
			itr2 = al_dst_itr(ls2);
			debtor_money = credit_side_money = 0;
			loop {
				if (obj2 = al_next(itr2)) {
				} else {
					break;
				}
				str = obj2.getField("/");
				if (str && str != "") {
					if (debtor) {
					} else {
						debtor = str;
					}
					debtor_money = debtor_money + (integer)obj2.getField("/z");
					str = obj2.getField("/Ev");
					if (str && str != "") {
						if (summary == null) {
							summary = str;
						} else {
							summary = summary + ":" + str;
						}
					} else {
					}
					str = obj2.getField("/");
					if (str && str != "") {
						if (memo == null) {
							memo = str;
						} else {
							memo = memo + ":" + str;
						}
					} else {
					}
					str = obj2.getField("/t");
					if (str == "L") {
						tag = "L";
					} else {
					}
				} else {
				}
				str = obj2.getField("/");
				if (str && str != "") {
					if (credit_side) {
					} else {
						credit_side = str;
					}
					credit_side_money = credit_side_money + (integer)obj2.getField("/z");
					str = obj2.getField("/Ev");
					if (str && str != "") {
						if (summary == null) {
							summary = str;
						} else {
							summary = summary + ":" + str;
						}
					} else {
					}
					str = obj2.getField("/");
					if (str && str != "") {
						if (memo == null) {
							memo = str;
						} else {
							memo = memo + ":" + str;
						}
					} else {
					}
					str = obj2.getField("/t");
					if (str == "L") {
						tag = "L";
					} else {
					}
				} else {
				}
			}
			res.out("<TR><TD>");
			genRadio("check_id", obj1.msgId, "", null);
			res.out("</TD><TD>");
			genText(approval);
			res.out("</TD><TD>");
			genText(checked);
			res.out("</TD><TD>");
			genText(date);
			res.out("</TD><TD>");
			genText(debtor);
			res.out("</TD><TD>");
			genText((string)debtor_money);
			res.out("</TD><TD>");
			genText(credit_side);
			res.out("</TD><TD>");
			genText((string)credit_side_money);
			res.out("</TD><TD>");
			genText(summary);
			res.out("</TD><TD>");
			genText(memo);
			res.out("</TD><TD>");
			genText(tag);
			res.out("</TD></TR>\n");
		}
		res.out("</TABLE>\n");
	} else {
	}
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeLedger(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	var string submit, sheet_id, ah_name_id;
	var string to_year, to_month, to_day;
	var list date1, date2, xml1, xml2;
	var string xml_str1, xml_str2, date_str1, date_str2, date_str3;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	sheet_id = al_dst_node(params, "sheet_id");
	ah_name_id = fromUTF8((string)al_dst_node(params, "ah_name"));
	if (submit == "\") {
		if (sheet_id && sheet_id != "") {
		} else {
			error("JntV[gIB");
			return null;
		}
		if (ah_name_id && ah_name_id != "") {
		} else {
			error("IB");
			return null;
		}
		var list bs_items;
		bs_items = getStockFlowItems(conn);
		var XmlDbAccessor acc;
		var XmlDbObject obj, obj2;
		var list ls, itr, ls2, itr2, item;
		var string dai, chuu, shou, ah_name, ah_str, name, side, hojo, hojo2;
		var integer money, debtor_money, credit_side_money;
		acc = new XmlDbAccessor;
		acc.create("Stock", "", conn);
		acc.setDTDfilename("bizsoft/finance/stock.dtd");
		try {
			obj = acc.get(sheet_id);
		} catch (AlException e) {
			error("IJntV[gB");
			return null;
		}
		date_str1 = obj.getField("XgbN/t");
		var integer date_int1;
		date1 = date_int(date_str1);
		date_int1 = al_misc("get_mktime", date1, null);
		date_int1 = date_int1 + 60 * 60 * 24;
		date1 = al_misc("get_localtime", date_int1, null);
		ls = obj.getChildren("XgbN/");
		itr = al_dst_itr(ls);
		loop {
			if (obj2 = al_next(itr)) {
			} else {
				break;
			}
			dai = obj2.getField("");
			chuu = obj2.getField("");
			shou = obj2.getField("");
			ah_name = obj2.getField("");
			money = (integer)obj2.getField("z");
			if (shou) {
				ah_str = shou;
			} else {
				shou = "";
				if (chuu) {
					ah_str = chuu;
				} else {
					chuu = "";
					if (dai) {
						ah_str = dai;
					} else {
						ah_str = "";
						dai = "";
					}
				}
			}
			if (ah_name) {
			} else {
				ah_name = "";
			}
			if (ah_str + "-" + ah_name == ah_name_id) {
				break;
			} else {
			}
		}
		to_year = al_dst_node(params, "to_year");
		to_month = al_dst_node(params, "to_month");
		to_day = al_dst_node(params, "to_day");
		date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
		date_str1 = date_str(date1);
		date_str2 = date_str(date2);
		xml_str2 = al_copy("<>");
		al_append_str(xml_str2, "<Jnt>");
		al_append_str(xml_str2, date_str1);
		al_append_str(xml_str2, "</Jnt>");
		al_append_str(xml_str2, "<It>");
		al_append_str(xml_str2, date_str2);
		al_append_str(xml_str2, "</It>");
		al_append_str(xml_str2, "<>");
		al_append_str(xml_str2, ah_name_id);
		al_append_str(xml_str2, "</>");
		acc = new XmlDbAccessor;
		acc.create("Check", "", conn);
		acc.setDTDfilename("bizsoft/finance/check.dtd");
		ls = acc.get((list)al_cons(null, null), "`[/t", "string", date_str1, date_str2, "`[/t", "string", null);
		itr = al_dst_itr(ls);
		loop {
			if (obj = al_next(itr)) {
			} else {
				break;
			}
			date_str3 = obj.getField("`[/t");
			ls2 = obj.getChildren("`[/d");
			itr2 = al_dst_itr(ls2);
			side = null;
			loop {
				if (obj2 = al_next(itr2)) {
				} else {
					break;
				}
				var list value;
				name = obj2.getField("/");
				if (name == ah_name_id) {
					hojo = obj2.getField("/");
					value = al_dst_node(ah_tree, name);
					if (value.tail.head == "") {
						money = money + (integer)obj2.getField("/z");
					} else {
						money = money - (integer)obj2.getField("/z");
					}
					side = "debtor";
					break;
				} else {
				}
				name = obj2.getField("/");
				if (name == ah_name_id) {
					hojo = obj2.getField("/");
					value = al_dst_node(ah_tree, name);
					if (value.tail.head == "") {
						money = money + (integer)obj2.getField("/z");
					} else {
						money = money - (integer)obj2.getField("/z");
					}
					side = "credit_side";
					break;
				} else {
				}
			}
			if (side) {
			} else {
				continue;
			}
			itr2 = al_dst_itr(ls2);
			loop {
				if (obj2 = al_next(itr2)) {
				} else {
					break;
				}
				var string tax_kind, tax_rate, summary;
				if (side == "debtor") {
					name = obj2.getField("/");
					if (name && name != "") {
						hojo2 = obj2.getField("/");
						credit_side_money = (integer)obj2.getField("/z");
						tax_kind = obj2.getField("/");
						tax_rate = obj2.getField("/");
						summary = obj2.getField("/Ev");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, "<t>");
						al_append_str(xml_str2, date_str3);
						al_append_str(xml_str2, "</t>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, hojo);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, name);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, hojo2);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<Ev>");
						al_append_str(xml_str2, summary);
						al_append_str(xml_str2, "</Ev>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, tax_kind);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, tax_rate);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, (string)credit_side_money);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<c>");
						al_append_str(xml_str2, (string)money);
						al_append_str(xml_str2, "</c>");
						al_append_str(xml_str2, "</>");
					} else {
					}
				} else {
				}
				if (side == "credit_side") {
					name = obj2.getField("/");
					if (name && name != "") {
						hojo2 = obj2.getField("/");
						debtor_money = (integer)obj2.getField("/z");
						tax_kind = obj2.getField("/");
						tax_rate = obj2.getField("/");
						summary = obj2.getField("/Ev");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, "<t>");
						al_append_str(xml_str2, date_str3);
						al_append_str(xml_str2, "</t>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, hojo);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, name);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, hojo2);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<Ev>");
						al_append_str(xml_str2, summary);
						al_append_str(xml_str2, "</Ev>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, tax_kind);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, tax_rate);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<>");
						al_append_str(xml_str2, (string)debtor_money);
						al_append_str(xml_str2, "</>");
						al_append_str(xml_str2, "<c>");
						al_append_str(xml_str2, (string)money);
						al_append_str(xml_str2, "</c>");
						al_append_str(xml_str2, "</>");
					} else {
					}
				} else {
				}
			}
		}
		al_append_str(xml_str2, "</>");
		var file f;
		f = al_file_open(xml_str2, "sr");
		xml2 = al_xml("parse", f, null, null);
		xml2 = xml2.head;
		xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/ledger_show.xsl", xml2);
		genPageBegin("Ledger");
		res.out(toUTF8_direct(xml_str1));
		genPageEnd();
		return null;
	} else {
		var integer date2_int;
		date2_int = al_misc("get_time", null, null);
		date2 = al_misc("get_localtime", date2_int, null);
	}
	xml2 = date_xml(date2);
	xml_str2 = to_date_html(xml2);
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr, ls2, itr2;
	acc = new XmlDbAccessor;
	acc.create("Stock", "", conn);
	acc.setDTDfilename("bizsoft/finance/stock.dtd");
	ls = acc.get((list)al_cons(null, null), "XgbN/t", "string", "0000/00/00", "999/99/99", "XgbN/t", "string", null);
	genPageBegin("Ledger");
	genFormBegin("Ledger", null);
	res.out(toUTF8_direct(xml_str2));
	genBR();
	{
		ls2 = al_cons(null, null);
		itr2 = al_dst_itr(ah_tree);
		loop {
			if (al_next(itr2)) {
			} else {
				break;
			}
			name = al_arc_a(itr2);
			al_create_arc(ls2, name, null);
		}
	}
	genSelect("ah_name", ls2);
	genButton("submit", "\");
	to_year = al_dst_node(params, "to_year");
	to_month = al_dst_node(params, "to_month");
	to_day = al_dst_node(params, "to_day");
	date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
	genBR();
	itr = al_dst_itr(ls);
	res.out("<TABLE BORDER>\n");
	res.out(toUTF8_direct("<TR><TD></TD><TD>t</TD><TD></TD></TR>\n"));
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		res.out("<TR><TD>");
		genRadio("sheet_id", obj.msgId, "", null);
		res.out("</TD><TD>");
		genText(obj.getField("XgbN/t"));
		res.out("</TD><TD>");
		genText(obj.getField("XgbN/"));
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeBalanceSheet(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	var string submit, sheet_id;
	var string to_year, to_month, to_day;
	var list date1, date2, xml1, xml2;
	var string xml_str1, xml_str2, date_str1, date_str2;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	sheet_id = al_dst_node(params, "sheet_id");
	if (submit == "\") {
		if (sheet_id && sheet_id != "") {
		} else {
			error("V[gIB");
			return null;
		}
		var XmlDbAccessor acc;
		acc = new XmlDbAccessor;
		acc.create("Stock", "", conn);
		acc.setDTDfilename("bizsoft/finance/stock.dtd");
		xml_str2 = acc.getXML(sheet_id);
		var file f;
		f = al_file_open(xml_str2, "sr");
		xml2 = al_xml("parse", f, null, null);
		xml2 = xml2.head;
		xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/stock.xsl", xml2);
		genPageBegin("BalanceSheet");
		res.out(toUTF8_direct(xml_str1));
		genPageEnd();
		return null;
	} else {
		if (submit == "") {
			if (sheet_id && sheet_id != "") {
			} else {
				error("JntV[gIB");
				return null;
			}
			var list bs_items;
			bs_items = getStockFlowItems(conn);
			var XmlDbAccessor acc;
			var XmlDbObject obj, obj2;
			var list ls, itr, ls2, itr2, item;
			var string dai, chuu, shou, ah_name, ah_str, name;
			var integer money;
			acc = new XmlDbAccessor;
			acc.create("Stock", "", conn);
			acc.setDTDfilename("bizsoft/finance/stock.dtd");
			try {
				obj = acc.get(sheet_id);
			} catch (AlException e) {
				error("IJntV[gB");
				return null;
			}
			date_str1 = obj.getField("XgbN/t");
			var integer date_int1;
			date1 = date_int(date_str1);
			date_int1 = al_misc("get_mktime", date1, null);
			date_int1 = date_int1 + 60 * 60 * 24;
			date1 = al_misc("get_localtime", date_int1, null);
			ls = obj.getChildren("XgbN/");
			itr = al_dst_itr(ls);
			loop {
				if (obj2 = al_next(itr)) {
				} else {
					break;
				}
				dai = obj2.getField("");
				chuu = obj2.getField("");
				shou = obj2.getField("");
				ah_name = obj2.getField("");
				money = (integer)obj2.getField("z");
				if (shou) {
					ah_str = shou;
				} else {
					shou = "";
					if (chuu) {
						ah_str = chuu;
					} else {
						chuu = "";
						if (dai) {
							ah_str = dai;
						} else {
							ah_str = "";
							dai = "";
						}
					}
				}
				if (ah_name) {
				} else {
					ah_name = "";
				}
				if (ah_name == "") {
					item = al_list8(dai, chuu, shou, ah_name, 0, 0, 0, 0);
					item = al_dst_node(bs_items.head, item);
					if (item) {
					} else {
						item = al_list3(dai, chuu, shou);
						error("JntV[g " + (string)item + "B");
						return null;
					}
					item.tail.tail.tail.tail.head = money;
				} else {
					name = ah_str + "-" + ah_name;
					itr2 = al_dst_itr(bs_items.tail.head);
					item = al_prev_a(itr2, name);
					if (item) {
					} else {
						error("JntV[g " + (string)name + "B");
						return null;
					}
					item.tail.tail.tail.tail.head = money;
				}
			}
			to_year = al_dst_node(params, "to_year");
			to_month = al_dst_node(params, "to_month");
			to_day = al_dst_node(params, "to_day");
			date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
			date_str1 = date_str(date1);
			date_str2 = date_str(date2);
			acc = new XmlDbAccessor;
			acc.create("Check", "", conn);
			acc.setDTDfilename("bizsoft/finance/check.dtd");
			ls = acc.get((list)al_cons(null, null), "`[/t", "string", date_str1, date_str2, "`[/t", "string", null);
			itr = al_dst_itr(ls);
			loop {
				if (obj = al_next(itr)) {
				} else {
					break;
				}
				ls2 = obj.getChildren("`[/d");
				itr2 = al_dst_itr(ls2);
				loop {
					if (obj2 = al_next(itr2)) {
					} else {
						break;
					}
					var list value, itr3;
					name = obj2.getField("/");
					if (name && name != "") {
						value = al_dst_node(ah_tree, name);
						money = (integer)obj2.getField("/z");
						itr3 = al_dst_itr(bs_items.tail.head);
						loop {
							if (item = al_next_a(itr3, name)) {
							} else {
								break;
							}
							if (value.tail.head == "") {
								item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.head + money;
							} else {
								item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.head - money;
							}
						}
					} else {
					}
					name = obj2.getField("/");
					if (name && name != "") {
						value = al_dst_node(ah_tree, name);
						money = (integer)obj2.getField("/z");
						itr3 = al_dst_itr(bs_items.tail.head);
						loop {
							if (item = al_next_a(itr3, name)) {
							} else {
								break;
							}
							if (value.tail.head == "") {
								item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.head + money;
							} else {
								item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.head - money;
							}
						}
					} else {
					}
				}
			}
			{
				// ---- automatic calculation
				var list tmp1, tmp2;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "");
				money = tmp1.tail.tail.tail.tail.head;
				itr = al_dst_itr(bs_items.tail.head);
				loop {
					if (tmp1 = al_next_a(itr, "-i")) {
					} else {
						break;
					}
					tmp1.tail.tail.tail.tail.head = tmp1.tail.tail.tail.tail.head + money;
				}
				tmp1 = al_dst_node(bs_items.tail.tail.head, "");
				tmp2 = al_dst_node(bs_items.tail.tail.head, "");
				money = tmp1.tail.tail.tail.tail.head - tmp2.tail.tail.tail.tail.head;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
				tmp1.tail.tail.tail.tail.head = money;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "y");
				money = money - tmp1.tail.tail.tail.tail.head;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "cv");
				tmp1.tail.tail.tail.tail.head = money;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "cOv");
				tmp2 = al_dst_node(bs_items.tail.tail.head, "cOp");
				money = money + tmp1.tail.tail.tail.tail.head - tmp2.tail.tail.tail.tail.head;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "ov");
				tmp1.tail.tail.tail.tail.head = money;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
				tmp2 = al_dst_node(bs_items.tail.tail.head, "");
				money = money + tmp1.tail.tail.tail.tail.head - tmp2.tail.tail.tail.tail.head;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "Ov");
				tmp1.tail.tail.tail.tail.head = money;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "@l");
				money = money - tmp1.tail.tail.tail.tail.head;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
				tmp1.tail.tail.tail.tail.head = money;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
				money = money + tmp1.tail.tail.tail.tail.head;
				tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
				tmp1.tail.tail.tail.tail.head = money;
				itr = al_dst_itr(bs_items.tail.head);
				loop {
					if (tmp1 = al_next_a(itr, "v-v")) {
					} else {
						break;
					}
					tmp1.tail.tail.tail.tail.head = tmp1.tail.tail.tail.tail.head + money;
				}
			}
			// ---- BalanceSheet
			itr = al_dst_itr(bs_items.head);
			xml_str2 = al_copy("<XgbN>");
			al_append_str(xml_str2, "<t>");
			al_append_str(xml_str2, date_str2);
			al_append_str(xml_str2, "</t>");
			loop {
				if (item = al_next(itr)) {
				} else {
					break;
				}
				dai = item.head;
				chuu = item.tail.head;
				shou = item.tail.tail.head;
				ah_name = item.tail.tail.tail.head;
				money = item.tail.tail.tail.tail.head;
				if (dai == "Y" || dai == "" || dai == "{") {
				} else {
					continue;
				}
				if (ah_name && ah_name != "" && money == 0) {
					continue;
				} else {
				}
				al_append_str(xml_str2, "<>");
				al_append_str(xml_str2, "<>");
				al_append_str(xml_str2, dai);
				al_append_str(xml_str2, "</>");
				if (chuu && chuu != "") {
					al_append_str(xml_str2, "<>");
					al_append_str(xml_str2, chuu);
					al_append_str(xml_str2, "</>");
				} else {
				}
				if (shou && shou != "") {
					al_append_str(xml_str2, "<>");
					al_append_str(xml_str2, shou);
					al_append_str(xml_str2, "</>");
				} else {
				}
				if (ah_name && ah_name != "") {
					al_append_str(xml_str2, "<>");
					al_append_str(xml_str2, ah_name);
					al_append_str(xml_str2, "</>");
				} else {
				}
				al_append_str(xml_str2, "<z>");
				al_append_str(xml_str2, (string)money);
				al_append_str(xml_str2, "</z>");
				al_append_str(xml_str2, "</>");
			}
			al_append_str(xml_str2, "</XgbN>");
			acc = new XmlDbAccessor;
			acc.create("Stock", "", conn);
			acc.setDTDfilename("bizsoft/finance/stock.dtd");
			ls = acc.get("XgbN/t", date_str2);
			itr = al_dst_itr(ls);
			if (obj = al_next(itr)) {
				obj.delete();
			} else {
			}
			acc.putXML(xml_str2, Context::genMsgId());
			// ---- Profit-and-Loss Statement
			itr = al_dst_itr(bs_items.head);
			xml_str2 = al_copy("<t[>");
			al_append_str(xml_str2, "<>");
			al_append_str(xml_str2, date_str1 + "-" + date_str2);
			al_append_str(xml_str2, "</>");
			loop {
				if (item = al_next(itr)) {
				} else {
					break;
				}
				dai = item.head;
				chuu = item.tail.head;
				shou = item.tail.tail.head;
				ah_name = item.tail.tail.tail.head;
				money = item.tail.tail.tail.tail.head;
				if (dai == "Y" || dai == "" || dai == "{") {
					continue;
				} else {
				}
				if ((dai == "v" || dai == "p") && chuu == "") {
					continue;
				} else {
				}
				if (ah_name && ah_name != "" && money == 0) {
					continue;
				} else {
				}
				al_append_str(xml_str2, "<>");
				al_append_str(xml_str2, "<>");
				al_append_str(xml_str2, dai);
				al_append_str(xml_str2, "</>");
				if (chuu && chuu != "") {
					al_append_str(xml_str2, "<>");
					al_append_str(xml_str2, chuu);
					al_append_str(xml_str2, "</>");
				} else {
				}
				if (shou && shou != "") {
					al_append_str(xml_str2, "<>");
					al_append_str(xml_str2, shou);
					al_append_str(xml_str2, "</>");
				} else {
				}
				if (ah_name && ah_name != "") {
					al_append_str(xml_str2, "<>");
					al_append_str(xml_str2, ah_name);
					al_append_str(xml_str2, "</>");
				} else {
				}
				al_append_str(xml_str2, "<z>");
				al_append_str(xml_str2, (string)money);
				al_append_str(xml_str2, "</z>");
				al_append_str(xml_str2, "</>");
			}
			al_append_str(xml_str2, "</t[>");
			acc = new XmlDbAccessor;
			acc.create("Flow", "", conn);
			acc.setDTDfilename("bizsoft/finance/flow.dtd");
			ls = acc.get("t[/", date_str1 + "-" + date_str2);
			itr = al_dst_itr(ls);
			if (obj = al_next(itr)) {
				obj.delete();
			} else {
			}
			acc.putXML(xml_str2, Context::genMsgId());
			conn.commit();
		} else {
			if (submit == "") {
				if (sheet_id && sheet_id != "") {
				} else {
					error("V[gIB");
					return null;
				}
				var XmlDbAccessor acc;
				var XmlDbObject obj;
				acc = new XmlDbAccessor;
				acc.create("Stock", "", conn);
				acc.setDTDfilename("bizsoft/finance/stock.dtd");
				try {
					obj = acc.get(sheet_id);
				} catch (AlException e) {
					error("IV[gB");
					return null;
				}
				obj.delete();
				conn.commit();
				to_year = al_dst_node(params, "to_year");
				to_month = al_dst_node(params, "to_month");
				to_day = al_dst_node(params, "to_day");
				date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
			} else {
				var integer date2_int;
				date2_int = al_misc("get_time", null, null);
				date2 = al_misc("get_localtime", date2_int, null);
			}
		}
	}
	xml2 = date_xml(date2);
	xml_str2 = to_date_html(xml2);
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	acc = new XmlDbAccessor;
	acc.create("Stock", "", conn);
	acc.setDTDfilename("bizsoft/finance/stock.dtd");
	ls = acc.get((list)al_cons(null, null), "XgbN/t", "string", "0000/00/00", "999/99/99", "XgbN/t", "string", null);
	genPageBegin("BalanceSheet");
	genFormBegin("BalanceSheet", null);
	res.out(toUTF8_direct(xml_str2));
	genBR();
	genButton("submit", "\");
	genButton("submit", "");
	genButton("submit", "");
	genBR();
	itr = al_dst_itr(ls);
	res.out("<TABLE BORDER>\n");
	res.out(toUTF8_direct("<TR><TD></TD><TD>t</TD><TD></TD></TR>\n"));
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		res.out("<TR><TD>");
		genRadio("sheet_id", obj.msgId, "", null);
		res.out("</TD><TD>");
		genText(obj.getField("XgbN/t"));
		res.out("</TD><TD>");
		genText(obj.getField("XgbN/"));
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeEarningStatement(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	var string submit, sheet_id;
	var string to_year, to_month, to_day;
	var list date1, date2, xml1, xml2;
	var string xml_str1, xml_str2, date_str1, date_str2;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	sheet_id = al_dst_node(params, "sheet_id");
	if (submit == "\") {
		if (sheet_id && sheet_id != "") {
		} else {
			error("V[gIB");
			return null;
		}
		var XmlDbAccessor acc;
		acc = new XmlDbAccessor;
		acc.create("Flow", "", conn);
		acc.setDTDfilename("bizsoft/finance/flow.dtd");
		xml_str2 = acc.getXML(sheet_id);
		var file f;
		f = al_file_open(xml_str2, "sr");
		xml2 = al_xml("parse", f, null, null);
		xml2 = xml2.head;
		xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/flow.xsl", xml2);
		genPageBegin("EarningStatement");
		res.out(toUTF8_direct(xml_str1));
		genPageEnd();
		return null;
	} else {
		if (submit == "") {
			if (sheet_id && sheet_id != "") {
			} else {
				error("V[gIB");
				return null;
			}
			var XmlDbAccessor acc;
			var XmlDbObject obj;
			acc = new XmlDbAccessor;
			acc.create("Flow", "", conn);
			acc.setDTDfilename("bizsoft/finance/flow.dtd");
			try {
				obj = acc.get(sheet_id);
			} catch (AlException e) {
				error("IV[gB");
				return null;
			}
			obj.delete();
			conn.commit();
			to_year = al_dst_node(params, "to_year");
			to_month = al_dst_node(params, "to_month");
			to_day = al_dst_node(params, "to_day");
			date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
		} else {
			var integer date2_int;
			date2_int = al_misc("get_time", null, null);
			date2 = al_misc("get_localtime", date2_int, null);
		}
	}
	xml2 = date_xml(date2);
	xml_str2 = to_date_html(xml2);
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	acc = new XmlDbAccessor;
	acc.create("Flow", "", conn);
	acc.setDTDfilename("bizsoft/finance/flow.dtd");
	ls = acc.get((list)al_cons(null, null), "t[/", "string", "0000/00/00-0000/00/00", "9999/99/99-9999/99/99", "t[/", "string", null);
	genPageBegin("EarningStatement");
	genFormBegin("EarningStatement", null);
	res.out(toUTF8_direct(xml_str2));
	genBR();
	genButton("submit", "\");
	genButton("submit", "");
	genBR();
	itr = al_dst_itr(ls);
	res.out("<TABLE BORDER>\n");
	res.out(toUTF8_direct("<TR><TD></TD><TD>t</TD><TD></TD></TR>\n"));
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		res.out("<TR><TD>");
		genRadio("sheet_id", obj.msgId, "", null);
		res.out("</TD><TD>");
		genText(obj.getField("t[/"));
		res.out("</TD><TD>");
		genText(obj.getField("t[/"));
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeTrialBalanceSheet(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	var string submit, sheet_id;
	var string to_year, to_month, to_day;
	var list date1, date2, xml1, xml2;
	var string xml_str1, xml_str2, date_str1, date_str2;
	submit = fromUTF8((string)al_dst_node(params, "submit"));
	sheet_id = al_dst_node(params, "sheet_id");
	if (submit == "\") {
		if (sheet_id && sheet_id != "") {
		} else {
			error("JntV[gIB");
			return null;
		}
		var list bs_items;
		bs_items = getStockFlowItems(conn);
		var XmlDbAccessor acc;
		var XmlDbObject obj, obj2;
		var list ls, itr, ls2, itr2, item;
		var string dai, chuu, shou, ah_name, ah_str, name;
		var integer money;
		acc = new XmlDbAccessor;
		acc.create("Stock", "", conn);
		acc.setDTDfilename("bizsoft/finance/stock.dtd");
		try {
			obj = acc.get(sheet_id);
		} catch (AlException e) {
			error("IJntV[gB");
			return null;
		}
		date_str1 = obj.getField("XgbN/t");
		var integer date_int1;
		date1 = date_int(date_str1);
		date_int1 = al_misc("get_mktime", date1, null);
		date_int1 = date_int1 + 60 * 60 * 24;
		date1 = al_misc("get_localtime", date_int1, null);
		ls = obj.getChildren("XgbN/");
		itr = al_dst_itr(ls);
		loop {
			if (obj2 = al_next(itr)) {
			} else {
				break;
			}
			dai = obj2.getField("");
			chuu = obj2.getField("");
			shou = obj2.getField("");
			ah_name = obj2.getField("");
			money = (integer)obj2.getField("z");
			if (shou) {
				ah_str = shou;
			} else {
				shou = "";
				if (chuu) {
					ah_str = chuu;
				} else {
					chuu = "";
					if (dai) {
						ah_str = dai;
					} else {
						ah_str = "";
						dai = "";
					}
				}
			}
			if (ah_name) {
			} else {
				ah_name = "";
			}
			if (ah_name == "") {
				item = al_list8(dai, chuu, shou, ah_name, 0, 0, 0, 0);
				item = al_dst_node(bs_items.head, item);
				if (item) {
				} else {
					item = al_list3(dai, chuu, shou);
					error("JntV[g " + (string)item + "B");
					return null;
				}
				item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.tail.head = money;
			} else {
				name = ah_str + "-" + ah_name;
				itr2 = al_dst_itr(bs_items.tail.head);
				item = al_prev_a(itr2, name);
				if (item) {
				} else {
					error("JntV[g " + (string)name + "B");
					return null;
				}
				item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.tail.head = money;
			}
		}
		to_year = al_dst_node(params, "to_year");
		to_month = al_dst_node(params, "to_month");
		to_day = al_dst_node(params, "to_day");
		date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
		date_str1 = date_str(date1);
		date_str2 = date_str(date2);
		acc = new XmlDbAccessor;
		acc.create("Check", "", conn);
		acc.setDTDfilename("bizsoft/finance/check.dtd");
		ls = acc.get((list)al_cons(null, null), "`[/t", "string", date_str1, date_str2, "`[/t", "string", null);
		itr = al_dst_itr(ls);
		loop {
			if (obj = al_next(itr)) {
			} else {
				break;
			}
			ls2 = obj.getChildren("`[/d");
			itr2 = al_dst_itr(ls2);
			loop {
				if (obj2 = al_next(itr2)) {
				} else {
					break;
				}
				var list value, itr3;
				name = obj2.getField("/");
				if (name && name != "") {
					value = al_dst_node(ah_tree, name);
					money = (integer)obj2.getField("/z");
					itr3 = al_dst_itr(bs_items.tail.head);
					loop {
						if (item = al_next_a(itr3, name)) {
						} else {
							break;
						}
						if (value.tail.head == "") {
							item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.head + money;
						} else {
							item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.head - money;
						}
						item.tail.tail.tail.tail.tail.tail.head = item.tail.tail.tail.tail.tail.tail.head + money;
					}
				} else {
				}
				name = obj2.getField("/");
				if (name && name != "") {
					value = al_dst_node(ah_tree, name);
					money = (integer)obj2.getField("/z");
					itr3 = al_dst_itr(bs_items.tail.head);
					loop {
						if (item = al_next_a(itr3, name)) {
						} else {
							break;
						}
						if (value.tail.head == "") {
							item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.head + money;
						} else {
							item.tail.tail.tail.tail.head = item.tail.tail.tail.tail.head - money;
						}
						item.tail.tail.tail.tail.tail.tail.tail.head = item.tail.tail.tail.tail.tail.tail.tail.head + money;
					}
				} else {
				}
			}
		}
		{
			// ---- automatic calculation
			var list tmp1, tmp2;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "");
			money = tmp1.tail.tail.tail.tail.head;
			itr = al_dst_itr(bs_items.tail.head);
			loop {
				if (tmp1 = al_next_a(itr, "-i")) {
				} else {
					break;
				}
				tmp1.tail.tail.tail.tail.head = tmp1.tail.tail.tail.tail.head + money;
			}
			tmp1 = al_dst_node(bs_items.tail.tail.head, "");
			tmp2 = al_dst_node(bs_items.tail.tail.head, "");
			money = tmp1.tail.tail.tail.tail.head - tmp2.tail.tail.tail.tail.head;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
			tmp1.tail.tail.tail.tail.head = money;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "y");
			money = money - tmp1.tail.tail.tail.tail.head;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "cv");
			tmp1.tail.tail.tail.tail.head = money;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "cOv");
			tmp2 = al_dst_node(bs_items.tail.tail.head, "cOp");
			money = money + tmp1.tail.tail.tail.tail.head - tmp2.tail.tail.tail.tail.head;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "ov");
			tmp1.tail.tail.tail.tail.head = money;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
			tmp2 = al_dst_node(bs_items.tail.tail.head, "");
			money = money + tmp1.tail.tail.tail.tail.head - tmp2.tail.tail.tail.tail.head;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "Ov");
			tmp1.tail.tail.tail.tail.head = money;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "@l");
			money = money - tmp1.tail.tail.tail.tail.head;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
			tmp1.tail.tail.tail.tail.head = money;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
			money = money + tmp1.tail.tail.tail.tail.head;
			tmp1 = al_dst_node(bs_items.tail.tail.head, "v");
			tmp1.tail.tail.tail.tail.head = money;
			itr = al_dst_itr(bs_items.tail.head);
			loop {
				if (tmp1 = al_next_a(itr, "v-v")) {
				} else {
					break;
				}
				tmp1.tail.tail.tail.tail.head = tmp1.tail.tail.tail.tail.head + money;
			}
		}
		// ---- BalanceSheet
		itr = al_dst_itr(bs_items.head);
		xml_str2 = al_copy("<XgbN>");
		al_append_str(xml_str2, "<Jnt>");
		al_append_str(xml_str2, date_str1);
		al_append_str(xml_str2, "</Jnt>");
		al_append_str(xml_str2, "<It>");
		al_append_str(xml_str2, date_str2);
		al_append_str(xml_str2, "</It>");
		loop {
			if (item = al_next(itr)) {
			} else {
				break;
			}
			var integer begin_money, debtor_money, credit_side_money;
			dai = item.head;
			chuu = item.tail.head;
			shou = item.tail.tail.head;
			ah_name = item.tail.tail.tail.head;
			money = item.tail.tail.tail.tail.head;
			begin_money = item.tail.tail.tail.tail.tail.head;
			debtor_money = item.tail.tail.tail.tail.tail.tail.head;
			credit_side_money = item.tail.tail.tail.tail.tail.tail.tail.head;
			if (dai == "Y" || dai == "" || dai == "{") {
			} else {
				continue;
			}
			if (ah_name && ah_name != "" && begin_money == 0 && debtor_money == 0 && credit_side_money == 0) {
				continue;
			} else {
			}
			al_append_str(xml_str2, "<>");
			al_append_str(xml_str2, "<>");
			al_append_str(xml_str2, dai);
			al_append_str(xml_str2, "</>");
			if (chuu && chuu != "") {
				al_append_str(xml_str2, "<>");
				al_append_str(xml_str2, chuu);
				al_append_str(xml_str2, "</>");
			} else {
			}
			if (shou && shou != "") {
				al_append_str(xml_str2, "<>");
				al_append_str(xml_str2, shou);
				al_append_str(xml_str2, "</>");
			} else {
			}
			if (ah_name && ah_name != "") {
				al_append_str(xml_str2, "<>");
				al_append_str(xml_str2, ah_name);
				al_append_str(xml_str2, "</>");
			} else {
			}
			al_append_str(xml_str2, "<Jz>");
			al_append_str(xml_str2, (string)begin_money);
			al_append_str(xml_str2, "</Jz>");
			al_append_str(xml_str2, "<>");
			al_append_str(xml_str2, (string)debtor_money);
			al_append_str(xml_str2, "</>");
			al_append_str(xml_str2, "<>");
			al_append_str(xml_str2, (string)credit_side_money);
			al_append_str(xml_str2, "</>");
			al_append_str(xml_str2, "<c>");
			al_append_str(xml_str2, (string)money);
			al_append_str(xml_str2, "</c>");
			al_append_str(xml_str2, "</>");
		}
		al_append_str(xml_str2, "</XgbN>");
		var file f;
		f = al_file_open(xml_str2, "sr");
		xml2 = al_xml("parse", f, null, null);
		xml2 = xml2.head;
		xml_str1 = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/tbs_show.xsl", xml2);
		genPageBegin("TrialBalanceSheet");
		res.out(toUTF8_direct(xml_str1));
		genPageEnd();
		return null;
	} else {
		var integer date2_int;
		date2_int = al_misc("get_time", null, null);
		date2 = al_misc("get_localtime", date2_int, null);
	}
	xml2 = date_xml(date2);
	xml_str2 = to_date_html(xml2);
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	acc = new XmlDbAccessor;
	acc.create("Stock", "", conn);
	acc.setDTDfilename("bizsoft/finance/stock.dtd");
	ls = acc.get((list)al_cons(null, null), "XgbN/t", "string", "0000/00/00", "999/99/99", "XgbN/t", "string", null);
	genPageBegin("TrialBalanceSheet");
	genFormBegin("TrialBalanceSheet", null);
	res.out(toUTF8_direct(xml_str2));
	genBR();
	genButton("submit", "\");
	to_year = al_dst_node(params, "to_year");
	to_month = al_dst_node(params, "to_month");
	to_day = al_dst_node(params, "to_day");
	date2 = al_list6((integer)to_year, (integer)to_month, (integer)to_day, 0, 0, 0);
	genBR();
	itr = al_dst_itr(ls);
	res.out("<TABLE BORDER>\n");
	res.out(toUTF8_direct("<TR><TD></TD><TD>t</TD><TD></TD></TR>\n"));
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		res.out("<TR><TD>");
		genRadio("sheet_id", obj.msgId, "", null);
		res.out("</TD><TD>");
		genText(obj.getField("XgbN/t"));
		res.out("</TD><TD>");
		genText(obj.getField("XgbN/"));
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeAccountHeadings(list params, DbConnection conn);
body
{
	if (checkUserRole("account")) {
	} else {
		return null;
	}
	getAccountHeadingsData(conn);
	var string xml_str;
	xml_str = XmlUtility::xslTransform(XmlUtility::xsl_base + "/bizsoft/finance/account_headings.xsl", ah_xml);
	genPageBegin("Accounting");
	res.out(toUTF8_direct(xml_str));
	genPageEnd();
	return null;
}
end_body
member
public: void getAccountHeadingsData(DbConnection conn);
body
{
	if (ah_xml) {
	} else {
		var string xml_str;
		try {
			var list dtd;
			dtd = XmlUtility::loadDTD(XmlUtility::dtd_base + "/bizsoft/finance/account_headings.dtd");
			var SimpleDb2Xml db2xml;
			db2xml = new SimpleDb2Xml;
			db2xml.msgType = "AccountHeadings";
			db2xml.msgId = "account_headings";
			db2xml.db_type = conn.db_type;
			db2xml.conn = conn;
			var list err;
			if (err = db2xml.compose(dtd)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "fail to retrive acount_headings data: reason = " + (string)err;
				throw ex;
			} else {
			}
			xml_str = db2xml.xml;
		} catch (AlException e) {
			throw e;
		}
		ah_xml = XmlUtility::parseXML(xml_str, null);
		var XmlDataRetriver retriver, itr1, bunnrui, itr2, ah, itr3, hojo;
		retriver = new XmlDataRetriver;
		retriver.create(ah_xml);
		itr1 = retriver.getItr("}X^[/");
		ah_tree = al_cons(null, null);
		loop {
			if (bunnrui = itr1.getNext()) {
			} else {
				break;
			}
			var string ah_str, dai, chuu, shou;
			dai = bunnrui.getValue("");
			chuu = bunnrui.getValue("");
			shou = bunnrui.getValue("");
			if (shou) {
				ah_str = shou;
			} else {
				if (chuu) {
					ah_str = chuu;
				} else {
					if (dai) {
						ah_str = dai;
					} else {
						ah_str = "";
					}
				}
			}
			itr2 = bunnrui.getItr("");
			loop {
				if (ah = itr2.getNext()) {
				} else {
					break;
				}
				var string ah_name, cash, kubun, debt_tax, credit_side_tax;
				var list ls;
				ah_name = ah.getValue("");
				cash = ah.getValue("LbV");
				kubun = ah.getValue("");
				debt_tax = ah.getValue("");
				credit_side_tax = ah.getValue("");
				al_create_arc(ah_tree, ls = al_list5(cash, kubun, debt_tax, credit_side_tax, al_list4(dai, chuu, shou, ah_name)), ah_str + "-" + ah_name);
				itr3 = ah.getItr("");
				loop {
					if (hojo = itr3.getNext()) {
					} else {
						break;
					}
					var string hojo_name;
					hojo_name = hojo.getValue("");
					al_create_arc(ls, al_cons(null, null), hojo_name);
				}
			}
		}
		try {
			var XmlDbAccessor acc;
			var XmlDbObject obj;
			var list ls, itr;
			acc = new XmlDbAccessor;
			acc.create("TaxRate", "", conn);
			acc.setDTDfilename("bizsoft/finance/tax_rate.dtd");
			ls = acc.getAll();
			itr = al_dst_itr(ls);
			if (obj = al_next(itr)) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "}X^[B";
				throw ex;
			}
			ls = obj.getChildren("}X^[/", "", "");
			itr = al_dst_itr(ls);
			if (obj = al_next(itr) && consumer_tax_rate = obj.getField("")) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "B";
				throw ex;
			}
		} catch (AlException e) {
			throw e;
		}
	}
}
end_body
member
public: list getStockFlowItems(DbConnection conn);
body
{
	getAccountHeadingsData(conn);
	var list ret, ls, idxs, idxs2, tmp, itr, value, name, value2;
	var list dai_item, chuu_item, shou_item;
	var string dai0, chuu0, shou0;
	ret = al_list3(ls = al_cons(null, null), idxs = al_cons(null, null), idxs2 = al_cons(null, null));
	itr = al_dst_itr(ah_tree);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		name = al_arc_a(itr);
		var string dai, chuu, shou, ah_name;
		value2 = value.tail.tail.tail.tail.head;
		dai = value2.head;
		chuu = value2.tail.head;
		shou = value2.tail.tail.head;
		ah_name = value2.tail.tail.tail.head;
		if (dai && dai != dai0) {
			dai0 = dai;
			chuu0 = shou0 = null;
			chuu_item = shou_item = null;
			dai_item = al_list8(dai, "", "", "", 0, 0, 0, 0);
			if (al_dst_node(ls, dai_item)) {
				dai_item = al_dst_node(ls, dai_item);
			} else {
				if (dai == "@l") {
					al_create_arc(idxs2, dai_item, "@l");
					al_create_arc(ls, tmp = al_list8("v", "Ov", "", "", 0, 0, 0, 0), null);
					al_create_arc(idxs2, tmp, "Ov");
				} else {
				}
				if (dai == "v") {
					al_create_arc(idxs2, dai_item, "v");
					al_create_arc(ls, tmp = al_list8("v", "v", "", "", 0, 0, 0, 0), null);
					al_create_arc(idxs2, tmp, "v");
				} else {
				}
				al_create_arc(ls, dai_item, dai_item);
			}
		} else {
			if (dai) {
			} else {
				dai_item = chuu_item = shou_item = null;
			}
		}
		if (chuu && chuu != chuu0) {
			chuu0 = chuu;
			shou0 = null;
			shou_item = null;
			chuu_item = al_list8(dai, chuu, "", "", 0, 0, 0, 0);
			if (al_dst_node(ls, chuu_item)) {
				chuu_item = al_dst_node(ls, chuu_item);
			} else {
				if (dai == "v" && chuu == "") {
					al_create_arc(idxs2, chuu_item, "");
				} else {
				}
				if (dai == "p" && chuu == "") {
					al_create_arc(idxs2, chuu_item, "");
				} else {
				}
				if (dai == "p" && chuu == "y") {
					al_create_arc(idxs2, chuu_item, "y");
					al_create_arc(ls, tmp = al_list8("v", "v", "", "", 0, 0, 0, 0), null);
					al_create_arc(idxs2, tmp, "v");
				} else {
				}
				if (dai == "v" && chuu == "cOv") {
					al_create_arc(idxs2, chuu_item, "cOv");
					al_create_arc(ls, tmp = al_list8("v", "cv", "", "", 0, 0, 0, 0), null);
					al_create_arc(idxs2, tmp, "cv");
				} else {
				}
				if (dai == "p" && chuu == "cOp") {
					al_create_arc(idxs2, chuu_item, "cOp");
				} else {
				}
				if (dai == "v" && chuu == "v") {
					al_create_arc(idxs2, chuu_item, "v");
					al_create_arc(ls, tmp = al_list8("v", "ov", "", "", 0, 0, 0, 0), null);
					al_create_arc(idxs2, tmp, "ov");
				} else {
				}
				if (dai == "p" && chuu == "") {
					al_create_arc(idxs2, chuu_item, "");
				} else {
				}
				if (dai == "p" && chuu == "") {
					al_create_arc(idxs2, chuu_item, "");
					al_create_arc(ls, tmp = al_list8("v", "v", "", "", 0, 0, 0, 0), null);
					al_create_arc(idxs2, tmp, "v");
				} else {
				}
				al_create_arc(ls, chuu_item, chuu_item);
			}
		} else {
			if (chuu) {
			} else {
				chuu_item = shou_item = null;
			}
		}
		if (shou && shou != shou0) {
			shou0 = shou;
			shou_item = al_list8(dai, chuu, shou, "", 0, 0, 0, 0);
			if (al_dst_node(ls, shou_item)) {
				shou_item = al_dst_node(ls, shou_item);
			} else {
				al_create_arc(ls, shou_item, shou_item);
			}
		} else {
			if (shou) {
			} else {
				shou_item = null;
			}
		}
		al_create_arc(ls, tmp = al_list8(dai, chuu, shou, ah_name, 0, 0, 0, 0), null);
		if (dai_item) {
			al_create_arc(idxs, dai_item, name);
		} else {
		}
		if (chuu_item) {
			al_create_arc(idxs, chuu_item, name);
		} else {
		}
		if (shou_item) {
			al_create_arc(idxs, shou_item, name);
		} else {
		}
		al_create_arc(idxs, tmp, name);
	}
	return ret;
}
end_body
member
public: static list ah_xml;
member
public: static list ah_tree;
member
public: static string consumer_tax_rate;
member
public: string debtor_ah_list(string submit, DbConnection conn);
body
{
	getAccountHeadingsData(conn);
	if (submit == "U`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "Y")) {
			} else {
				continue;
			}
			if (al_str_misc("starts_with", name, "Y-|")) {
				continue;
			} else {
			}
			if (al_str_misc("starts_with", name, "Y-`")) {
				continue;
			} else {
			}
			if (al_str_misc("starts_with", name, "Y-L")) {
				continue;
			} else {
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "o`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "-|")) {
			} else {
				if (al_str_misc("starts_with", name, "-x`")) {
				} else {
					if (al_str_misc("starts_with", name, "-cOx`")) {
					} else {
						if (al_str_misc("starts_with", name, "-Z")) {
						} else {
							if (al_str_misc("starts_with", name, "-")) {
							} else {
								continue;
							}
						}
					}
				}
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "Y")) {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "id`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (name == "-d") {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "d`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (name == "-d") {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "co") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "y")) {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "o") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "o")) {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "w") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "L`Y")) {
			} else {
				continue;
			}
			if (al_str_misc("starts_with", name, "L`Y-yn")) {
				continue;
			} else {
			}
			if (al_str_misc("starts_with", name, "L`Y-pvz")) {
				continue;
			} else {
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
}
end_body
member
public: string credit_side_ah_list(string submit, DbConnection conn);
body
{
	getAccountHeadingsData(conn);
	if (submit == "U`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "Y-|")) {
			} else {
				if (al_str_misc("starts_with", name, "Y-`")) {
				} else {
					if (al_str_misc("starts_with", name, "Y-Zt")) {
					} else {
						if (al_str_misc("starts_with", name, "Y-t")) {
						} else {
							continue;
						}
					}
				}
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "o`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "Y")) {
			} else {
				continue;
			}
			if (al_str_misc("starts_with", name, "Y-|")) {
				continue;
			} else {
			}
			if (al_str_misc("starts_with", name, "Y-`")) {
				continue;
			} else {
			}
			if (al_str_misc("starts_with", name, "Y-L")) {
				continue;
			} else {
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (name == "-") {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "id`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "Y")) {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "d`[") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "Y")) {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "co") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "Y")) {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "o") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "Y")) {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
	if (submit == "w") {
		var list itr, value;
		var string xml, name;
		itr = al_dst_itr(ah_tree);
		xml = al_copy("<>");
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			if (al_str_misc("starts_with", name, "Y")) {
			} else {
				continue;
			}
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		al_append_str(xml, "</>");
		return xml;
	} else {
	}
}
end_body
member
public: string as_list(string selected_ah, string side, list props, DbConnection conn);
body
{
	getAccountHeadingsData(conn);
	var list itr, value, itr2;
	var string xml, name, name2;
	itr = al_dst_itr(ah_tree);
	xml = al_copy("<>");
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		name = al_arc_a(itr);
		if (name != selected_ah) {
			continue;
		} else {
		}
		al_append_str(xml, "<>");
		al_append_str(xml, name);
		al_append_str(xml, "</>");
		al_append_str(xml, "<>");
		al_append_str(xml, al_dst_node(props, "selected_as"));
		al_append_str(xml, "</>");
		al_append_str(xml, "<>");
		if (side == "debtor") {
			al_append_str(xml, value.tail.tail.head);
		} else {
		}
		if (side == "credit_side") {
			al_append_str(xml, value.tail.tail.tail.head);
		} else {
		}
		al_append_str(xml, "</>");
		al_append_str(xml, "<z>");
		al_append_str(xml, al_dst_node(props, "money"));
		al_append_str(xml, "</z>");
		al_append_str(xml, "<z>");
		al_append_str(xml, al_dst_node(props, "tax"));
		al_append_str(xml, "</z>");
		al_append_str(xml, "<>");
		al_append_str(xml, al_dst_node(props, "tax_rate"));
		al_append_str(xml, "</>");
		al_append_str(xml, "<Ev>");
		al_append_str(xml, al_dst_node(props, "summary"));
		al_append_str(xml, "</Ev>");
		al_append_str(xml, "<>");
		al_append_str(xml, al_dst_node(props, "memo"));
		al_append_str(xml, "</>");
		al_append_str(xml, "<t>");
		al_append_str(xml, al_dst_node(props, "tag"));
		al_append_str(xml, "</t>");
		itr2 = al_dst_itr(value);
		loop {
			if (al_next(itr2)) {
			} else {
				break;
			}
			name2 = al_arc_a(itr2);
			al_append_str(xml, "<>");
			al_append_str(xml, "<>");
			al_append_str(xml, name2);
			al_append_str(xml, "</>");
			al_append_str(xml, "</>");
		}
		break;
	}
	al_append_str(xml, "</>");
	return xml;
}
end_body
member
public: static void test();
body
{
	ah_xml = null;
}
end_body
end_class
end_class
class WebUIrosettaServlet
member
public: list invokePipInfo(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, selected_item, target_msg_type, target_msg_version;
	var string msg_type, msg_version, dtd_filename, msg_code;
	var string from_role_class, from_service, to_role_class, to_service, transaction_code;
	var string indicator, process_code, process_version;
	var string next_action;
	submit = al_dst_node(params, "submit");
	selected_item = al_dst_node(params, "PipInfoSelect");
	if (selected_item) {
		var integer idx;
		idx = al_search_str(selected_item, 0, ": ");
		if (idx > 0) {
			target_msg_type = al_substr(selected_item, 0, idx);
			target_msg_version = al_substr(selected_item, idx + 2, al_strlen(selected_item));
		} else {
		}
	} else {
	}
	msg_type = al_dst_node(params, "MsgType");
	msg_version = al_dst_node(params, "MessageVersion");
	dtd_filename = al_dst_node(params, "DTDfilename");
	msg_code = al_dst_node(params, "MessageCode");
	from_role_class = al_dst_node(params, "FromRoleClass");
	from_service = al_dst_node(params, "FromService");
	to_role_class = al_dst_node(params, "ToRoleClass");
	to_service = al_dst_node(params, "ToService");
	transaction_code = al_dst_node(params, "TransactionCode");
	indicator = al_dst_node(params, "Indicator");
	process_code = al_dst_node(params, "ProcessCode");
	process_version = al_dst_node(params, "ProcessVersion");
	next_action = al_dst_node(params, "NextAction");
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	var list ls, itr;
	acc = new XmlDbAccessor;
	acc.create("PipInfo", "", conn);
	acc.setDTDfilename("rosetta/PipInfo.dtd");
	ls = acc.get("PipInfo/Target", admin_target, "PipInfo/Id", "message type");
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
	} else {
		error("PipInfo not found.");
		return null;
	}
	if (submit == "Show") {
		session.setAttribute("target_pip_info", selected_item);
		session.setAttribute("target_msg_type", target_msg_type);
		session.setAttribute("target_msg_version", target_msg_version);
		session.setAttribute("edit_mode", null);
	} else {
	}
	if (submit == "Create") {
		session.setAttribute("target_pip_info", "#");
		session.setAttribute("target_msg_type", "#");
		session.setAttribute("target_msg_version", "#");
		session.setAttribute("edit_mode", 1);
	} else {
	}
	if (submit == "Edit") {
		if (target_msg_type == null || target_msg_type == "") {
			error("target MsgType is empty.");
			return null;
		} else {
		}
		if (target_msg_version == null || target_msg_version == "") {
			error("target MsgVersion is empty.");
			return null;
		} else {
		}
		session.setAttribute("target_pip_info", selected_item);
		session.setAttribute("target_msg_type", target_msg_type);
		session.setAttribute("target_msg_version", target_msg_version);
		session.setAttribute("edit_mode", 2);
	} else {
	}
	if (submit == "Delete") {
		if (obj2 = getPipInfo(obj, target_msg_type, target_msg_version, conn)) {
			obj2.delete();
		} else {
			error("PipInfo '" + (string)target_msg_type + ": " + (string)target_msg_version + "' not found.");
			return null;
		}
	} else {
	}
	if (submit == "submit for Create/Edit") {
		if (target_msg_type = session.getAttribute("target_msg_type") && target_msg_version = session.getAttribute("target_msg_version")) {
		} else {
			error("target MsgType or target MessageVersion is not setted.");
		}
		if (target_msg_type == null || target_msg_type == "") {
			error("target MsgType is empty.");
			return null;
		} else {
		}
		if (target_msg_version == null || target_msg_version == "") {
			error("target MsgVersion is empty.");
			return null;
		} else {
		}
		if (target_msg_type == "#" && target_msg_version == "#") {
			if (obj2 = getPipInfo(obj, msg_type, msg_version, conn)) {
				error("PipInfo '" + (string)msg_type + ": " + (string)msg_version + "' already exists.");
				return null;
			} else {
			}
			obj2 = obj.createChild("PipInfo/Message");
			obj2.putField("MessageCode", msg_code);
			obj2.putField("MessageVersion", msg_version);
			obj2.putField("MsgType", msg_type);
			obj2.putField("DTDfilename", dtd_filename);
			obj2.putField("FromRoleClass", from_role_class);
			obj2.putField("FromService", from_service);
			obj2.putField("ToRoleClass", to_role_class);
			obj2.putField("ToService", to_service);
			obj2.putField("TransactionCode", transaction_code);
			obj2.putField("Indicator", indicator);
			obj2.putField("ProcessCode", process_code);
			obj2.putField("ProcessVersion", process_version);
			obj2.putField("NextAction", next_action);
			session.setAttribute("target_pip_info", msg_type + ": " + msg_version);
			session.setAttribute("target_msg_type", msg_type);
			session.setAttribute("target_msg_version", msg_version);
			session.setAttribute("edit_mode", null);
		} else {
			if (obj2 = getPipInfo(obj, target_msg_type, target_msg_version, conn)) {
			} else {
				error("PipInfo '" + (string)target_msg_type + ": " + (string)target_msg_version + "' not found.");
				return null;
			}
			obj2.putField("DTDfilename", dtd_filename);
			obj2.putField("MessageCode", msg_code);
			obj2.putField("FromRoleClass", from_role_class);
			obj2.putField("FromService", from_service);
			obj2.putField("ToRoleClass", to_role_class);
			obj2.putField("ToService", to_service);
			obj2.putField("TransactionCode", transaction_code);
			obj2.putField("Indicator", indicator);
			obj2.putField("ProcessCode", process_code);
			obj2.putField("ProcessVersion", process_version);
			obj2.putField("NextAction", next_action);
			session.setAttribute("target_pip_info", selected_item);
			session.setAttribute("target_msg_type", target_msg_type);
			session.setAttribute("target_msg_version", target_msg_version);
			session.setAttribute("edit_mode", null);
		}
	} else {
	}
	if (session.getAttribute("target_pip_info")) {
	} else {
		session.setAttribute("target_pip_info", "#");
	}
	if (session.getAttribute("target_msg_type")) {
	} else {
		session.setAttribute("target_msg_type", "#");
	}
	if (session.getAttribute("target_msg_version")) {
	} else {
		session.setAttribute("target_msg_version", "#");
	}
	return invokeView(params, conn);
}
end_body
member
public: XmlDbObject getPipInfo(XmlDbObject obj, string msg_type, string msg_version, DbConnection conn);
body
{
	var list ls, itr;
	ls = obj.getChildren("PipInfo/Message", "MsgType", msg_type, "MessageVersion", msg_version);
	itr = al_dst_itr(ls);
	return al_next(itr);
}
end_body
member
public: list invokeCommLog(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var list msg_info;
	var string submit, dataId, msgId;
	submit = al_dst_node(params, "submit");
	dataId = al_dst_node(params, "dataId");
	if (dataId && dataId != "") {
		try {
			var XmlDbAccessor acc;
			var XmlDbObject obj;
			acc = new XmlDbTableAccessor;
			acc.create("CommLog", "", conn);
			acc.setDTDfilename("CommLog.dtd");
			obj = acc.get(dataId);
			msgId = obj.getField("CommLog/rawMsgId");
		} catch (AlException e) {
			error("required log recored not found; " + e.msg);
			return null;
		}
	} else {
	}
	if (submit == "ShowPreamble") {
		if (dataId && dataId != "") {
			msg_info = al_cons(null, null);
			al_set_dst_node(msg_info, "msgId", msgId);
			al_set_dst_node(msg_info, "msgType", "Preamble");
			al_set_dst_node(msg_info, "msgVersion", "V02.00");
			al_set_dst_node(msg_info, "dtdFilename", "rosetta/Preamble_MS_V02_00.dtd");
		} else {
			error("radio button not checked.");
			return null;
		}
	} else {
	}
	if (submit == "ShowDeliveryHeader") {
		if (dataId && dataId != "") {
			msg_info = al_cons(null, null);
			al_set_dst_node(msg_info, "msgId", msgId);
			al_set_dst_node(msg_info, "msgType", "DeliveryHeader");
			al_set_dst_node(msg_info, "msgVersion", "V02.00");
			al_set_dst_node(msg_info, "dtdFilename", "rosetta/DeliveryHeader_MS_V02_00.dtd");
		} else {
			error("radio button not checked.");
			return null;
		}
	} else {
	}
	if (submit == "ShowServiceHeader") {
		if (dataId && dataId != "") {
			msg_info = al_cons(null, null);
			al_set_dst_node(msg_info, "msgId", msgId);
			al_set_dst_node(msg_info, "msgType", "ServiceHeader");
			al_set_dst_node(msg_info, "msgVersion", "V02.00");
			al_set_dst_node(msg_info, "dtdFilename", "rosetta/ServiceHeader_MS_V02_00.dtd");
		} else {
			error("radio button not checked.");
			return null;
		}
	} else {
	}
	if (submit == "ShowServiceContent") {
		if (dataId && dataId != "") {
			msg_info = al_cons(null, null);
			al_set_dst_node(msg_info, "msgId", msgId);
			var XmlDbAccessor acc;
			try {
				acc = new XmlDbAccessor;
				acc.create("", "", conn);
				acc.getWithMsgTypeAndMsgVersion(msgId);
			} catch (AlException e) {
				error("not found message corresponding to msgId '" + (string)msgId + "'");
				return null;
			}
			al_set_dst_node(msg_info, "msgType", acc.msgType);
			al_set_dst_node(msg_info, "msgVersion", acc.msgVersion);
			al_set_dst_node(msg_info, "dtdFilename", acc._dtd_filename);
		} else {
			error("radio button not checked.");
			return null;
		}
	} else {
	}
	if (msg_info) {
		session.setAttribute("msg_info", msg_info);
		return invokeShowMessage(params, conn);
	} else {
	}
	return WebUIServlet::invokeCommLog(params, conn);
}
end_body
member
public: list invokeShowMessage(list params, DbConnection conn);
body
{
	if (checkUserRole("admin")) {
	} else {
		return null;
	}
	var list msg_info, msg_info2;
	if (msg_info = session.getAttribute("msg_info")) {
	} else {
		error("not found message information in session.");
		return null;
	}
	var string submit, dataId;
	submit = al_dst_node(params, "submit");
	dataId = al_dst_node(params, "dataId");
	var string msgId, msg_type, msg_version, dtd_filename;
	msgId = al_dst_node(msg_info, "msgId");
	msg_type = al_dst_node(msg_info, "msgType");
	msg_version = al_dst_node(msg_info, "msgVersion");
	dtd_filename = al_dst_node(msg_info, "dtdFilename");
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	try {
		acc = new XmlDbAccessor;
		acc.create(msg_type, msg_version, conn);
		acc.setDTDfilename(dtd_filename);
		obj = acc.get(msgId);
	} catch (AlException e) {
		error("not found message corresponding to msgId '" + (string)msgId + "'");
		return null;
	}
	genPageBegin("ShowMessage");
	genFormBegin("ShowMessage", null);
	genTitle("Show Message");
	genTable1(obj, obj.xpath_list, null, null, null);
	var string child_xpath, dataId2;
	var list child_xpath_list, itr, ls;
	var XmlDbObject obj2;
	loop {
		if (msg_info2 = al_dst_node(msg_info, "child")) {
		} else {
			break;
		}
		if (submit == "return" && al_dst_node(msg_info2, "child") == null) {
			al_set_dst_node(msg_info, "child", null);
			break;
		} else {
		}
		msg_info = msg_info2;
		child_xpath = msg_info.head;
		dataId2 = msg_info.tail.head;
		ls = obj.getChildren(child_xpath);
		if (obj = al_dst_node(ls, dataId2)) {
		} else {
			error("not found child: dataId = " + (string)dataId2 + ", xpath = " + (string)child_xpath);
			return null;
		}
		genHR();
		genText("Child: xpath = " + (string)child_xpath);
		genBR();
		genTable1(obj, obj.xpath_list, null, null, null);
	}
	if (submit == "showChild") {
		if (obj.dtd_itr && child_xpath_list = obj.dtd_itr.getChildList()) {
			itr = al_dst_itr(child_xpath_list);
			loop {
				if (child_xpath = al_next(itr)) {
				} else {
					break;
				}
				ls = obj.getChildren(child_xpath);
				if (obj2 = al_dst_node(ls, dataId)) {
				} else {
					continue;
				}
				al_set_dst_node(msg_info, "child", al_list2(child_xpath, dataId));
				obj = obj2;
				genHR();
				genText("Child: xpath = " + (string)child_xpath);
				genBR();
				genTable1(obj, obj.xpath_list, null, null, null);
				break;
			}
		} else {
		}
	} else {
	}
	if (obj.dtd_itr && child_xpath_list = obj.dtd_itr.getChildList()) {
		itr = al_dst_itr(child_xpath_list);
		genHR();
		loop {
			if (child_xpath = al_next(itr)) {
			} else {
				break;
			}
			genText("Child: xpath = " + (string)child_xpath);
			genBR();
			ls = obj.getChildren(child_xpath);
			obj2 = obj.getMetaInfo(child_xpath);
			genTable2(ls, obj2.xpath_list, (list)1, (list)"dataId", 1, 0, null);
		}
	} else {
	}
	genButton("submit", "showChild");
	genButton("submit", "return");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
class WebUIrosettaSampleBuyerServlet
member
public: list invokeLogin(list params, DbConnection conn);
body
{
	if (authorize(params, conn)) {
	} else {
		return null;
	}
	if (al_dst_node(user_roles, "webuiadmin")) {
		res.redirect("ebiz?action=WebUiAdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "admin")) {
		res.redirect("ebiz?action=AdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "buyer")) {
		res.redirect("ebiz?action=BuyerHome");
		return null;
	} else {
	}
	error("User '" + user_name + "' does not have required user role");
	return null;
}
end_body
member
public: list invokeBuyerHome(list params, DbConnection conn);
body
{
	if (checkUserRole("buyer")) {
	} else {
		return null;
	}
	res.out("<HTML><HEAD>\n<META http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n");
	res.out("<TITLE>Sample Buyer Site</TITLE></HEAD>\n");
	res.out("<FRAMESET COLS=\"20%,*\" FRAMEBORDER=\"YES\">\n");
	res.out("<FRAME SRC=\"ebiz?action=BuyerMenu\" SCROLLING=\"auto\" NAME=\"menu\"/>\n");
	res.out("<FRAME SRC=\"buyer_home.html\" SCROLLING=\"auto\" NAME=\"action\"/>\n");
	res.out("</FRAMESET>\n");
	res.out("</HTML>\n");
	return null;
}
end_body
member
public: list invokeBuyerMenu(list params, DbConnection conn);
body
{
	if (checkUserRole("buyer")) {
	} else {
		return null;
	}
	return menu(params, conn);
}
end_body
member
public: list invokeCatalog(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, buyer, supplier;
	var string product1, quantity1, price1, ship_date1;
	var string product2, quantity2, price2, ship_date2;
	submit = al_dst_node(params, "submit");
	buyer = al_dst_node(params, "Buyer");
	supplier = al_dst_node(params, "Supplier");
	product1 = al_dst_node(params, "Product1");
	quantity1 = al_dst_node(params, "Quantity1");
	price1 = al_dst_node(params, "RequestPrice1");
	ship_date1 = al_dst_node(params, "ShipDate1");
	product2 = al_dst_node(params, "Product2");
	quantity2 = al_dst_node(params, "Quantity2");
	price2 = al_dst_node(params, "RequestPrice2");
	ship_date2 = al_dst_node(params, "ShipDate2");
	if (submit == "Register") {
		var ProcMgr mgr;
		var string pid;
		var list ps;
		mgr = new ProcMgr;
		pid = mgr.create("PoSendProcess", conn);
		ps = al_cons(null, null);
		al_set_dst_node(ps, "buyer", buyer);
		al_set_dst_node(ps, "supplier", supplier);
		al_set_dst_node(ps, "product1", product1);
		al_set_dst_node(ps, "quantity1", quantity1);
		al_set_dst_node(ps, "price1", price1);
		al_set_dst_node(ps, "shipDate1", ship_date1);
		al_set_dst_node(ps, "product2", product2);
		al_set_dst_node(ps, "quantity2", quantity2);
		al_set_dst_node(ps, "price2", price2);
		al_set_dst_node(ps, "shipDate2", ship_date2);
		mgr.putProperties(pid, ps, conn);
		mgr.start(pid, conn);
		genPageBegin("Registered");
		genText("PoRequest send process started. PeProcessId = " + (string)pid + ".");
		genPageEnd();
		return null;
	} else {
	}
	return invokeView(params, conn);
}
end_body
member
public: list invokeApproval(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, item_id;
	var string processId, activityId;
	submit = al_dst_node(params, "submit");
	item_id = al_dst_node(params, "itemId");
	var ProcMgr mgr;
	var list workitems, itr, ids;
	mgr = new ProcMgr;
	if (submit == "Approval" && item_id) {
		var integer idx;
		idx = al_search_str(item_id, 0, ",");
		processId = al_substr(item_id, 0, idx);
		activityId = al_tail_str(item_id, idx + 1);
		mgr.complete(processId, activityId, conn);
	} else {
	}
	workitems = mgr.getWorkItems(conn);
	genPageBegin("Approval");
	genFormBegin("Approval", null);
	genTitle("Approval");
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD></TD><TD>Work Item</TD></TR>\n");
	itr = al_dst_itr(workitems);
	loop {
		if (ids = al_next_a(itr, "Approval")) {
		} else {
			break;
		}
		var string item_id;
		processId = ids.head;
		activityId = ids.tail.head;
		item_id = processId + "," + activityId;
		res.out("<TR><TD>");
		genRadio("itemId", item_id, "", null);
		res.out("</TD><TD>");
		genText(item_id);
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genButton("submit", "Approval");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeTransmit(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, item_id;
	var string processId, activityId;
	submit = al_dst_node(params, "submit");
	item_id = al_dst_node(params, "itemId");
	var ProcMgr mgr;
	var list workitems, itr, ids;
	mgr = new ProcMgr;
	if (submit == "Transmit" && item_id) {
		var integer idx;
		idx = al_search_str(item_id, 0, ",");
		processId = al_substr(item_id, 0, idx);
		activityId = al_tail_str(item_id, idx + 1);
		mgr.complete(processId, activityId, conn);
	} else {
	}
	workitems = mgr.getWorkItems(conn);
	genPageBegin("Transmit");
	genFormBegin("Transmit", null);
	genTitle("Transmit");
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD></TD><TD>Work Item</TD></TR>\n");
	itr = al_dst_itr(workitems);
	loop {
		if (ids = al_next_a(itr, "Transmit")) {
		} else {
			break;
		}
		var string item_id;
		processId = ids.head;
		activityId = ids.tail.head;
		item_id = processId + "," + activityId;
		res.out("<TR><TD>");
		genRadio("itemId", item_id, "", null);
		res.out("</TD><TD>");
		genText(item_id);
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genButton("submit", "Transmit");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
end_class
class WebUIrosettaSampleSupplierServlet
member
public: list invokeLogin(list params, DbConnection conn);
body
{
	if (authorize(params, conn)) {
	} else {
		return null;
	}
	if (al_dst_node(user_roles, "webuiadmin")) {
		res.redirect("ebiz?action=WebUiAdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "admin")) {
		res.redirect("ebiz?action=AdminHome");
		return null;
	} else {
	}
	if (al_dst_node(user_roles, "supplier")) {
		res.redirect("ebiz?action=SupplierHome");
		return null;
	} else {
	}
	error("User '" + user_name + "' does not have required user role");
	return null;
}
end_body
member
public: list invokeSupplierHome(list params, DbConnection conn);
body
{
	if (checkUserRole("supplier")) {
	} else {
		return null;
	}
	res.out("<HTML><HEAD>\n<META http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n");
	res.out("<TITLE>Sample Supplier Site</TITLE></HEAD>\n");
	res.out("<FRAMESET COLS=\"20%,*\" FRAMEBORDER=\"YES\">\n");
	res.out("<FRAME SRC=\"ebiz?action=SupplierMenu\" SCROLLING=\"auto\" NAME=\"menu\"/>\n");
	res.out("<FRAME SRC=\"supplier_home.html\" SCROLLING=\"auto\" NAME=\"action\"/>\n");
	res.out("</FRAMESET>\n");
	res.out("</HTML>\n");
	return null;
}
end_body
member
public: list invokeSupplierMenu(list params, DbConnection conn);
body
{
	if (checkUserRole("supplier")) {
	} else {
		return null;
	}
	return menu(params, conn);
}
end_body
member
public: list invokeReceipt(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, item_id;
	var string processId, activityId;
	submit = al_dst_node(params, "submit");
	item_id = al_dst_node(params, "itemId");
	var ProcMgr mgr;
	var list workitems, itr, ids;
	mgr = new ProcMgr;
	if (submit == "Receipt" && item_id) {
		var integer idx;
		idx = al_search_str(item_id, 0, ",");
		processId = al_substr(item_id, 0, idx);
		activityId = al_tail_str(item_id, idx + 1);
		mgr.complete(processId, activityId, conn);
	} else {
	}
	workitems = mgr.getWorkItems(conn);
	genPageBegin("Receipt");
	genFormBegin("Receipt", null);
	genTitle("Receipt");
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD></TD><TD>Work Item</TD></TR>\n");
	itr = al_dst_itr(workitems);
	loop {
		if (ids = al_next_a(itr, "Receipt")) {
		} else {
			break;
		}
		var string item_id;
		processId = ids.head;
		activityId = ids.tail.head;
		item_id = processId + "," + activityId;
		res.out("<TR><TD>");
		genRadio("itemId", item_id, "", null);
		res.out("</TD><TD>");
		genText(item_id);
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genButton("submit", "Receipt");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeInventory(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, item_id;
	var string processId, activityId;
	submit = al_dst_node(params, "submit");
	item_id = al_dst_node(params, "itemId");
	var ProcMgr mgr;
	var list workitems, itr, ids;
	mgr = new ProcMgr;
	if (submit == "Inventory" && item_id) {
		var integer idx;
		idx = al_search_str(item_id, 0, ",");
		processId = al_substr(item_id, 0, idx);
		activityId = al_tail_str(item_id, idx + 1);
		mgr.complete(processId, activityId, conn);
	} else {
	}
	workitems = mgr.getWorkItems(conn);
	genPageBegin("Inventory");
	genFormBegin("Inventory", null);
	genTitle("Inventory");
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD></TD><TD>Work Item</TD></TR>\n");
	itr = al_dst_itr(workitems);
	loop {
		if (ids = al_next_a(itr, "Inventory")) {
		} else {
			break;
		}
		var string item_id;
		processId = ids.head;
		activityId = ids.tail.head;
		item_id = processId + "," + activityId;
		res.out("<TR><TD>");
		genRadio("itemId", item_id, "", null);
		res.out("</TD><TD>");
		genText(item_id);
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genButton("submit", "Inventory");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeFulfill(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, item_id;
	var string processId, activityId;
	submit = al_dst_node(params, "submit");
	item_id = al_dst_node(params, "itemId");
	var ProcMgr mgr;
	var list workitems, itr, ids;
	mgr = new ProcMgr;
	if (submit == "Fulfill" && item_id) {
		var integer idx;
		idx = al_search_str(item_id, 0, ",");
		processId = al_substr(item_id, 0, idx);
		activityId = al_tail_str(item_id, idx + 1);
		mgr.complete(processId, activityId, conn);
	} else {
	}
	workitems = mgr.getWorkItems(conn);
	genPageBegin("Fulfill");
	genFormBegin("Fulfill", null);
	genTitle("Fulfill");
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD></TD><TD>Work Item</TD></TR>\n");
	itr = al_dst_itr(workitems);
	loop {
		if (ids = al_next_a(itr, "Fulfill")) {
		} else {
			break;
		}
		var string item_id;
		processId = ids.head;
		activityId = ids.tail.head;
		item_id = processId + "," + activityId;
		res.out("<TR><TD>");
		genRadio("itemId", item_id, "", null);
		res.out("</TD><TD>");
		genText(item_id);
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genButton("submit", "Fulfill");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
member
public: list invokeInvoice(list params, DbConnection conn);
body
{
	if (checkUserRole(conn)) {
	} else {
		return null;
	}
	var string submit, item_id;
	var string processId, activityId;
	submit = al_dst_node(params, "submit");
	item_id = al_dst_node(params, "itemId");
	var ProcMgr mgr;
	var list workitems, itr, ids;
	mgr = new ProcMgr;
	if (submit == "Invoice" && item_id) {
		var integer idx;
		idx = al_search_str(item_id, 0, ",");
		processId = al_substr(item_id, 0, idx);
		activityId = al_tail_str(item_id, idx + 1);
		mgr.complete(processId, activityId, conn);
	} else {
	}
	workitems = mgr.getWorkItems(conn);
	genPageBegin("Invoice");
	genFormBegin("Invoice", null);
	genTitle("Invoice");
	res.out("<TABLE BORDER=\"1\">\n");
	res.out("<TR><TD></TD><TD>Work Item</TD></TR>\n");
	itr = al_dst_itr(workitems);
	loop {
		if (ids = al_next_a(itr, "Invoice")) {
		} else {
			break;
		}
		var string item_id;
		processId = ids.head;
		activityId = ids.tail.head;
		item_id = processId + "," + activityId;
		res.out("<TR><TD>");
		genRadio("itemId", item_id, "", null);
		res.out("</TD><TD>");
		genText(item_id);
		res.out("</TD></TR>\n");
	}
	res.out("</TABLE>\n");
	genButton("submit", "Invoice");
	genBR();
	genFormEnd();
	genPageEnd();
	return null;
}
end_body
end_class
end_class
end_class
class TransportServlet
member
public: static string pool_name;
class RNIF20Servlet
member
public: void doPost(HttpRequest req, HttpResponse res);
body
{
	var DbConnection conn;
	var string async, msgId;
	var WaitObj wait_obj;
	res.response_code = 500;
	var list props;
	if (props = al_dst_node(req._server.servlet_param_list, "RNIF20Servlet") && al_dst_node(props, "proxy") == "true") {
		// ---- in case of Proxy
		try {
			var AlException ex;
			var string dir;
			async = al_dst_node_i(req.headers, "x-RN-Response-Type");
			if (async != "async" && async != "sync") {
				res.response_code = 505;
				ex = new AlException;
				ex.msg = "Proxy: not support response type: type = " + (string)async;
				throw ex;
			} else {
			}
			dir = al_dst_node(props, "inbound.dir");
			if (dir = al_dst_node(props, "inbound.dir") && al_file_manip("is_dir", dir, null)) {
			} else {
				ex = new AlException;
				ex.msg = "Proxy: inbound directory is illegal.";
				throw ex;
			}
			msgId = ProxyPolleeServlet::add(req.fromIP, (string)req.cert_info, dir, req.bin_raw_http_header, req.input);
			if (async == "sync") {
				wait_obj = new WaitObj;
				wait_obj.value = 500;
				wait_obj.value2 = res;
				DataMgr::putProperty(msgId, (list)wait_obj);
			} else {
			}
		} catch (AlException e) {
			try {
				conn = DbManager::getConnection(pool_name);
				log("fatal", req.fromIP, e.msg, "", conn);
				conn.close();
			} catch (AlException e) {
				if (conn) {
					try {
						conn.close();
					} catch (AlException e) {
					}
				} else {
				}
			}
			return;
		}
		if (wait_obj = DataMgr::getProperty(msgId)) {
			wait_obj.wait();
			DataMgr::removeProperty(msgId);
			res.response_code = wait_obj.value;
		} else {
			res.response_code = 202;
		}
		return;
	} else {
	}
	props = al_cons(null, null);
	al_create_arc(props, req.fromIP, "fromIP");
	if (req.cert_info) {
		al_create_arc(props, (string)req.cert_info, "certInfo");
	} else {
	}
	try {
		conn = DbManager::getConnection(pool_name);
		loop {
			var AlException ex;
			var RNContext ctx;
			var list my_props;
			var string dir, filename, pid;
			var file out;
			var integer header_len, content_len;
			var ProcMgr pm;
			msgId = Context::genMsgId();
			al_create_arc(props, msgId, "msgId");
			ctx = new RNContext;
			try {
				my_props = ctx.getMyProperties("-- default setting --", conn);
			} catch (AlException e) {
				e.msg = "fail to get my -- default setting -- properties: " + e.msg;
				log("fatal", req.fromIP, e.msg, msgId, conn);
				throw e;
			}
			if (dir = al_dst_node(my_props, "msg.tmp.dir")) {
			} else {
				ex = new AlException;
				ex.msg = "property msg.tmp.dir is empty.";
				log("fatal", req.fromIP, ex.msg, msgId, conn);
				throw ex;
			}
			al_create_arc(props, dir, "tempDir");
			if (dir = al_dst_node(my_props, "msg.attach.dir")) {
			} else {
				ex = new AlException;
				ex.msg = "property msg.attach.dir is empty.";
				log("fatal", req.fromIP, ex.msg, msgId, conn);
				throw ex;
			}
			al_create_arc(props, dir, "attachDir");
			if (dir = al_dst_node(my_props, "msg.recv.dir")) {
			} else {
				ex = new AlException;
				ex.msg = "property msg.recv.dir is empty.";
				log("fatal", req.fromIP, ex.msg, msgId, conn);
				throw ex;
			}
			// save to file;
			filename = dir + "/" + msgId;
			al_create_arc(props, filename, "filename");
			if (out = al_file_open(filename, "wb")) {
			} else {
				ex = new AlException;
				ex.msg = "file open error: file = " + filename + ".";
				log("fatal", req.fromIP, ex.msg, msgId, conn);
				throw ex;
			}
			header_len = al_misc("binary_size", req.bin_raw_http_header, null);
			content_len = al_misc("binary_size", req.input, null);
			if (al_file_write(out, al_list3(req.bin_raw_http_header, 0, header_len), null) || al_file_write(out, al_list3(req.input, 0, content_len), null)) {
				ex = new AlException;
				ex.msg = "file write error: file = " + filename + ".";
				log("fatal", req.fromIP, ex.msg, msgId, conn);
				throw ex;
			} else {
			}
			out = null;
			async = al_dst_node_i(req.headers, "x-RN-Response-Type");
			if (async != "async" && async != "sync") {
				res.response_code = 505;
				ex = new AlException;
				ex.msg = "not support response type: type = " + (string)async;
				log("error", req.fromIP, ex.msg, msgId, conn);
				throw ex;
			} else {
			}
			// start transport receive process;
			try {
				pm = new ProcMgr;
				if (async == "sync") {
					al_set_dst_node(props, "syncType", "sync");
					wait_obj = new WaitObj;
					wait_obj.value = 500;
					wait_obj.value2 = res;
					DataMgr::putProperty(msgId, (list)wait_obj);
				} else {
				}
				pid = pm.create("RNIF20ReceiveProcess", conn);
				al_set_dst_node(props, "startTime", Context::genTimeStamp());
				pm.putProperties(pid, props, conn);
				pm.start(pid, conn);
				conn.commit();
			} catch (AlException e) {
				e.msg = "receive process start error: " + e.msg;
				log("fatal", req.fromIP, e.msg, msgId, conn);
				throw e;
			}
			break;
		}
		conn.close();
		if (wait_obj = DataMgr::getProperty(msgId)) {
			wait_obj.wait();
			DataMgr::removeProperty(msgId);
			res.response_code = wait_obj.value;
		} else {
			res.response_code = 202;
		}
	} catch (AlException e) {
		if (DataMgr::getProperty(msgId)) {
			DataMgr::removeProperty(msgId);
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: void log(string log_level, string fromIP, string msg, string msgId, DbConnection conn);
body
{
	var list props;
	props = al_cons(null, null);
	al_set_dst_node(props, "errorReason", msg);
	al_set_dst_node(props, "sendRecv", "recv");
	al_set_dst_node(props, "errorLevel", log_level);
	al_set_dst_node(props, "fromIP", fromIP);
	al_set_dst_node(props, "msgId", msgId);
	var RNIF20ServiceHandler handler;
	handler = new RNIF20ServiceHandler;
	handler.conn = conn;
	handler.invokeWriteLog(props);
	conn.commit();
}
end_body
end_class
end_class
class ProxyPolleeServlet
member
public: void doGet(HttpRequest req, HttpResponse res);
body
{
	var string pass, action, id;
	var list params;
	params = req.getParameters();
	pass = (string)al_dst_node(params, "pass");
	action = (string)al_dst_node(params, "action");
	id = (string)al_dst_node(params, "id");
	try {
		var AlException ex;
		var list props;
		var string dir, pass2;
		if (props = al_dst_node(req._server.servlet_param_list, "ProxyPolleeServlet") && dir = al_dst_node(props, "inbound.dir") && al_file_manip("is_dir", dir, null)) {
		} else {
			ex = new AlException;
			ex.msg = "Pollee: inbound directory is illegal.";
			throw ex;
		}
		pass2 = al_dst_node(props, "password");
		if (pass2 != pass) {
			res.out("password mismatch.");
			res.response_code = 401;
			return;
		} else {
		}
		if (action == "list") {
			var string s;
			var file f;
			listup(dir);
			s = al_copy("");
			f = al_file_open(s, "sw");
			al_file_write(f, "graph", ids);
			f = null;
			res.out(s);
			return;
		} else {
		}
		if (action == "get") {
			var string s;
			s = get(dir, id);
			res.out(s);
			return;
		} else {
		}
		if (action == "delete") {
			remove(dir, id);
			res.out("OK");
			return;
		} else {
		}
		res.response_code = 400;
	} catch (AlException e) {
		res.out(e.msg);
		res.response_code = 500;
	}
}
end_body
member
public: static string add(string fromIP, string cert_info, string dir, list headers, list message);
body
{
	// allocate id
	var string id;
	id = Context::genMsgId();
	// save message
	var AlException ex;
	var file f;
	if (f = al_file_open(dir + "/" + id, "wb")) {
	} else {
		ex = new AlException;
		ex.msg = "Proxy: can not open file to be saved in inbound directory: filename = " + dir + "/" + id;
		throw ex;
	}
	if (al_file_write(f, al_list3(headers, 0, al_misc("binary_size", headers, null)), null)) {
		ex = new AlException;
		ex.msg = "Proxy: fail to save message to inbound directory: filename = " + dir + "/" + id;
		throw ex;
	} else {
	}
	if (al_file_write(f, al_list3(message, 0, al_misc("binary_size", message, null)), null)) {
		ex = new AlException;
		ex.msg = "Proxy: fail to save message to inbound directory: filename = " + dir + "/" + id;
		throw ex;
	} else {
	}
	var file f;
	if (ids) {
	} else {
		if (f = al_file_open(dir + "/id_list", "r")) {
			ids = al_file_read(f, "graph");
		} else {
			ids = al_cons(null, null);
		}
		f = null;
	}
	al_create_arc(ids, al_list3(fromIP, cert_info, id), id);
	if (f = al_file_open(dir + "/id_list", "w")) {
	} else {
		ex = new AlException;
		ex.msg = "Proxy: can not open id table file: filename = " + (string)dir + "/id_list";
		throw ex;
	}
	if (al_file_write(f, "graph", ids)) {
		ex = new AlException;
		ex.msg = "Proxy: fail to write id table file: filename = " + (string)dir + "/id_list";
		throw ex;
	} else {
	}
	al_file_manip("flush", f, null);
	return id;
}
end_body
member
public: static string get(string dir, string id);
body
{
	if (id) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "Pollee: id is empty.";
		throw ex;
	}
	var list buf;
	var string s;
	try {
		buf = FileUtility::readBinary(dir + "/" + id);
		s = al_misc("binary_to_string", al_list3(buf, 0, al_misc("binary_size", buf, null)), null);
	} catch (AlException e) {
		e.msg = "Pollee: fail to read message from inbound directory: id = " + id + ", exception = " + e.msg;
		throw e;
	}
	return s;
}
end_body
member
public: static void remove(string dir, string id);
body
{
	if (id) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "Pollee: id is empty.";
		throw ex;
	}
	al_file_manip("remove", dir + "/" + id, null);
	var file f;
	if (ids) {
	} else {
		if (f = al_file_open(dir + "/id_list", "r")) {
			ids = al_file_read(f, "graph");
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "Proxy: can not open id table file: filename = " + (string)dir + "/id_list";
			throw ex;
		}
		f = null;
	}
	al_set_dst_node(ids, id, null);
	if (f = al_file_open(dir + "/id_list", "w")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "Proxy: can not open id table file: filename = " + (string)dir + "/id_list";
		throw ex;
	}
	if (al_file_write(f, "graph", ids)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "Proxy: fail to write id table file: filename = " + (string)dir + "/id_list";
		throw ex;
	} else {
	}
	al_file_manip("flush", f, null);
}
end_body
member
public: static void listup(string dir);
body
{
	var file f;
	if (ids) {
	} else {
		if (f = al_file_open(dir + "/id_list", "r")) {
			ids = al_file_read(f, "graph");
		} else {
			ids = al_cons(null, null);
		}
		f = null;
	}
}
end_body
member
public: static list ids;
member
public: void doPost(HttpRequest req, HttpResponse res);
body
{
	var string msgId;
	var string code;
	var WaitObj wait_obj;
	var HttpResponse res2;
	msgId = al_dst_node(req.headers, "x-AL-OrgMsgId");
	code = al_dst_node(req.headers, "x-AL-ResponseCode");
	if (msgId && code) {
	} else {
		res.response_code = 400;
		return;
	}
	if (wait_obj = DataMgr::getProperty(msgId)) {
	} else {
		res.response_code = 404;
		return;
	}
	res2 = (HttpResponse)wait_obj.value2;
	al_set_dst_node(req.headers, "x-AL-OrgMsgId", null);
	al_set_dst_node(req.headers, "x-AL-ResponseCode", null);
	res2.headers = req.headers;
	res2.out(req.input);
	wait_obj.value = (integer)code;
	wait_obj.notify();
}
end_body
end_class
class TestServlet1
member
public: void doGet(HttpRequest req, HttpResponse res);
body
{
	res.out("<HTML><HEAD><TITLE>Test1</TITLE></HEAD><BODY>\n");
	res.out("<H1>Hello World !!</H1>\n");
	res.out("</BODY></HTML>\n");
}
end_body
end_class
class TestServlet2
member
public: void doGet(HttpRequest req, HttpResponse res);
body
{
	var HttpSession session;
	var string action;
	action = req.getParameter("action");
	if (action == "Login") {
		var string id, pass;
		id = req.getParameter("UserID");
		pass = req.getParameter("Password");
		// TODO: insert authorization code here
		session = req.createSession();
		res.redirect("servlet2?action=AddressMap");
		return;
	} else {
	}
	if (action == "AddressMap") {
		if (session = req.getSession()) {
		} else {
			res.redirect("no_session.html");
			return;
		}
		var string operation, name, phone, submit;
		operation = req.getParameter("operation");
		name = req.getParameter("name");
		phone = req.getParameter("phone");
		submit = req.getParameter("submit");
		if (submit == "logout") {
			session.invalidate();
			res.redirect("index.html");
			return;
		} else {
		}
		if (operation == "Insert/Update") {
			if (name != "") {
				session.setAttribute(name, phone);
			} else {
			}
		} else {
		}
		if (operation == "Delete") {
			if (name != "") {
				session.setAttribute(name, null);
			} else {
			}
		} else {
		}
		res.out("<HTML><HEAD>\n");
		res.out("<META http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n");
		res.out("<TITLE>Name Phone</TITLE></HEAD><BODY>\n");
		res.out("<FORM METHOD=\"POST\">\n");
		res.out("  Name <INPUT TYPE=\"text\" NAME=\"name\"><BR>\n");
		res.out("  Phone <INPUT TYPE=\"text\" NAME=\"phone\"><BR>\n");
		res.out("  <SELECT NAME=\"operation\">\n");
		res.out("    <OPTION SELECTED=\"true\">Insert/Update</OPTION>\n");
		res.out("    <OPTION>Delete</OPTION>\n");
		res.out("  </SELECT><BR>\n");
		res.out("  <INPUT TYPE=\"submit\" Name=\"submit\" VALUE=\"execute\">\n");
		res.out("<TABLE BORDER=\"1\">\n");
		res.out("  <TR><TD>Name</TD><TD>Phone</TD></TR>\n");
		var list attrs, itr;
		var string str;
		if (attrs = session.getAttributes()) {
			itr = al_dst_itr(attrs);
			loop {
				if (phone = al_next(itr)) {
				} else {
					break;
				}
				name = al_arc_a(itr);
				res.out("<TR><TD>");
				res.out(name);
				res.out("</TD><TD>");
				res.out(phone);
				res.out("</TD></TR>\n");
			}
		} else {
		}
		res.out("</TABLE>\n");
		res.out("  <INPUT TYPE=\"submit\" Name=\"submit\" VALUE=\"logout\">\n");
		res.out("</FORM>\n");
		res.out("</BODY></HTML>\n");
		return;
	} else {
	}
}
end_body
member
public: void doPost(HttpRequest req, HttpResponse res);
body
{
	doGet(req, res);
}
end_body
end_class
end_class
class HttpRequest
member
public: WebServer _server;
member
public: HttpResponse _response;
member
public: string _command;
member
public: string _path;
member
public: string _params;
member
public: list bin_raw_http_header;
member
public: list headers;
member
public: string fromIP;
member
public: list cert_info;
member
public: list input;
member
public: string input_file;
member
public: list getParameters();
body
{
	if (parameters) {
		return parameters;
	} else {
	}
	parameters = al_cons(null, null);
	var list ls, itr, nv;
	var string name_value, name, value;
	ls = al_str_misc("split", _params, '&');
	itr = al_dst_itr(ls);
	loop {
		if (name_value = al_next(itr)) {
		} else {
			break;
		}
		nv = splitNameValue(name_value);
		name = al_str_misc("param_to_string", nv.head, null);
		value = nv.tail.head;
		al_create_arc(parameters, value, name);
	}
	if (_command == "POST") {
		var string contentType;
		var list mimeMultipart, mimeBody, itr, hdr, hdr_val;
		var integer idx, size;
		contentType = al_dst_node_i(headers, "Content-Type");
		if (al_str_misc("strcmpi", contentType, "multipart/form-data") == 0) {
			mimeMultipart = al_crypt("mime_multipart_read", input, headers, null);
			itr = al_dst_itr(mimeMultipart);
			loop {
				if (mimeBody = al_next(itr)) {
				} else {
					break;
				}
				size = al_misc("binary_size", mimeBody, null);
				hdr = al_crypt("mime_headers_read", mimeBody, null, null);
				if (hdr) {
					idx = hdr.tail.head;
					hdr = hdr.head;
					hdr_val = al_dst_node_i(hdr, "Content-Disposition");
					if (hdr_val == "form-data") {
						name = al_dst_node_i(hdr_val, "name");
						value = al_misc("binary_to_string", al_list3(mimeBody, idx, size - idx), null);
						al_create_arc(parameters, value, name);
					} else {
					}
				} else {
				}
			}
			return parameters;
		} else {
		}
		var string params;
		size = al_misc("binary_size", input, null);
		params = al_misc("binary_to_string", al_list3(input, 0, size), null);
		ls = al_str_misc("split", params, '&');
		itr = al_dst_itr(ls);
		loop {
			if (name_value = al_next(itr)) {
			} else {
				break;
			}
			nv = splitNameValue(name_value);
			name = al_str_misc("param_to_string", nv.head, null);
			value = nv.tail.head;
			value = al_str_misc("param_to_string", value, null);
			al_create_arc(parameters, value, name);
		}
	} else {
	}
	return parameters;
}
end_body
member
public: string getParameter(string name);
body
{
	parameters = getParameters();
	return al_dst_node_i(parameters, name);
}
end_body
member
public: list parameters;
member
public: HttpSession createSession();
body
{
	var HttpSession session;
	if (session = getSession()) {
		return session;
	} else {
	}
	session = new HttpSession;
	session._create(_server);
	getCookies();
	al_create_arc(cookies, session._sessionId, "AltairSession");
	var string cookie;
	cookie = "AltairSession=" + session._sessionId + "; Path=" + getBasePath();
	al_create_arc(_response.headers, cookie, "Set-Cookie");
	return session;
}
end_body
member
public: HttpSession getSession();
body
{
	if (_server.sessions) {
	} else {
		return null;
	}
	getCookies();
	var string session_id;
	var list itr;
	itr = al_dst_itr(cookies);
	loop {
		if (session_id = al_next(itr)) {
		} else {
			break;
		}
		if (al_str_misc("strcmpi", al_arc_a(itr), "AltairSession") != 0) {
			continue;
		} else {
		}
		var HttpSession session;
		if (session = al_dst_node_i(_server.sessions, session_id)) {
			session._time = 0;
			return session;
		} else {
		}
	}
	return null;
}
end_body
member
public: list getCookies();
body
{
	if (cookies) {
		return cookies;
	} else {
	}
	cookies = al_cons(null, null);
	var list itr, nv, itr2;
	var string name_value, name, value;
	itr = al_dst_itr(headers);
	loop {
		if (name_value = al_next(itr)) {
		} else {
			break;
		}
		if (al_str_misc("strcmpi", al_arc_a(itr), "Cookie") != 0) {
			continue;
		} else {
		}
		nv = splitNameValue(name_value);
		name = nv.head;
		value = nv.tail.head;
		al_create_arc(cookies, value, name);
		itr2 = al_dst_itr(name_value);
		loop {
			if (value = al_next(itr2)) {
			} else {
				break;
			}
			name = al_arc_a(itr2);
			al_create_arc(cookies, value, name);
		}
	}
	return cookies;
}
end_body
member
public: string getCookie(string name);
body
{
	getCookies();
	return al_dst_node_i(cookies, name);
}
end_body
member
public: list cookies;
member
public: string getBasePath();
body
{
	var string path;
	var integer idx;
	idx = al_strlen(_path) - 1;
	loop {
		if (idx < 0 || al_get_char(_path, idx) == '/') {
			path = al_substr(_path, 0, idx + 1);
			break;
		} else {
		}
		idx = idx - 1;
	}
	return path;
}
end_body
member
public: static list splitNameValue(string name_value);
body
{
	var string name, value;
	var integer idx;
	idx = al_search_str(name_value, 0, "=");
	if (idx >= 0) {
		name = al_substr(name_value, 0, idx);
		value = al_substr(name_value, idx + 1, al_strlen(name_value));
	} else {
		name = name_value;
		value = "";
	}
	return al_list2(name, value);
}
end_body
end_class
class HttpResponse
member
public: void _create();
body
{
	response_code = 200;
	headers = al_cons(null, null);
	max_size = 4096;
	output = al_misc("binary", max_size, null);
	content_length = 0;
}
end_body
member
public: HttpRequest _request;
member
public: integer response_code;
member
public: list headers;
member
public: list output;
member
public: integer max_size;
member
public: integer content_length;
member
public: void out(string s);
body
{
	var integer len;
	len = al_strlen(s);
	if (content_length + len > max_size) {
		al_misc("extend_binary", output, len);
		max_size = max_size + len;
	} else {
	}
	al_misc("binary_copy", al_list2(output, content_length), s);
	content_length = content_length + len;
	if (content_length > _server.maxMsgSize * 1000) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "response message too large: size >= " + (string)content_length;
		throw ex;
	} else {
	}
}
end_body
member
public: void out(list binary);
body
{
	var integer size;
	size = al_misc("binary_size", binary, null);
	out(binary, 0, size);
}
end_body
member
public: void out(list binary, integer index, integer size);
body
{
	if (content_length + size > max_size) {
		al_misc("extend_binary", output, size);
		max_size = max_size + size;
	} else {
	}
	al_misc("binary_copy", al_list2(output, content_length), al_list3(binary, index, size));
	content_length = content_length + size;
	if (content_length > _server.maxMsgSize * 1000) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "response message too large: size >= " + (string)content_length;
		throw ex;
	} else {
	}
}
end_body
member
public: void redirect(string url);
body
{
	if (al_strlen(url) >= 4 && al_substr(url, 0, 4) == "http") {
	} else {
		var string host;
		if (host = al_dst_node_i(_request.headers, "Host")) {
		} else {
			host = "localhost";
		}
		if (al_strlen(url) >= 1 && al_get_char(url, 0) == '/') {
			if (_server.ssl == null) {
				url = "http://" + host + url;
			} else {
				url = "https://" + host + url;
			}
		} else {
			if (_server.ssl == null) {
				url = "http://" + host + _request.getBasePath() + url;
			} else {
				url = "https://" + host + _request.getBasePath() + url;
			}
		}
	}
	// redirect
	response_code = 302;
	al_set_dst_node(headers, "Location", url);
	if (http_ver == "HTTP/1.1") {
		al_set_dst_node(headers, "Connection", "Close");
	} else {
	}
	out("<HTML><HEAD><TITLE>Document moved</TITLE><HEAD><BODY>\n");
	out("<H1>Document moved</H1>\n");
	out("This document has moved <A HREF=\"");
	out(url);
	out("\">here</A>.<P>\n");
	out("</BODY></HTML>\n");
}
end_body
member
public: void redirectWithSession(string url);
body
{
	var HttpSession session;
	if (session = _request.getSession()) {
		var string cookie;
		cookie = "AltairSession=" + session._sessionId + "; Path=" + _request.getBasePath();
		al_set_dst_node(headers, "Set-Cookie", cookie);
	} else {
	}
	redirect(url);
}
end_body
member
public: WebServer _server;
member
public: string http_ver;
member
public: string system_command;
member
public: string response_filepath;
member
public: string response_content_disposition;
end_class
class HttpSession
member
public: void _create(WebServer server);
body
{
	_server = server;
	_sessionId = al_crypt("random", 64, null, null);
	_time = 0;
	if (_server.sessions) {
	} else {
		_server.sessions = al_cons(null, null);
	}
	al_set_dst_node(_server.sessions, _sessionId, this);
}
end_body
member
public: WebServer _server;
member
public: string _sessionId;
member
public: integer _time;
member
public: void invalidate();
body
{
	var list itr;
	var HttpSession s;
	itr = al_dst_itr(_server.sessions);
	loop {
		if (s = al_next(itr)) {
		} else {
			break;
		}
		if (al_addr_eq(s, this)) {
			al_remove(itr);
			break;
		} else {
		}
	}
}
end_body
member
public: list getAttributes();
body
{
	return attrs;
}
end_body
member
public: list getAttribute(string name);
body
{
	if (attrs) {
	} else {
		return null;
	}
	return al_dst_node(attrs, name);
}
end_body
member
public: void setAttribute(string name, list attr);
body
{
	if (attrs) {
	} else {
		attrs = al_cons(null, null);
	}
	al_set_dst_node(attrs, name, attr);
}
end_body
member
public: void setAttribute(string name, integer attr);
body
{
	setAttribute(name, (list)attr);
}
end_body
member
public: void setAttribute(string name, string attr);
body
{
	setAttribute(name, (list)attr);
}
end_body
member
public: void setAttribute(string name, AlObject attr);
body
{
	setAttribute(name, (list)attr);
}
end_body
member
public: list attrs;
end_class
class TransportTransmitter
member
public: string send(string msgId, string partner_id, string partner_role, string my_id, string my_role, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	acc = new XmlDbAccessor;
	acc.create("", "", conn);
	acc.getWithMsgTypeAndMsgVersion(msgId);
	var ProcMgr mgr;
	mgr = new ProcMgr;
	var string sendProcessId;
	sendProcessId = mgr.create(send_process_name, conn);
	var list ps;
	ps = al_cons(null, null);
	al_set_dst_node(ps, "msgId", msgId);
	al_set_dst_node(ps, "msgType", acc.msgType);
	al_set_dst_node(ps, "msgVersion", acc.msgVersion);
	al_set_dst_node(ps, "dtdFilename", acc._dtd_filename);
	if (org_msgId) {
		acc.getWithMsgTypeAndMsgVersion(org_msgId);
		al_set_dst_node(ps, "orgMsgId", org_msgId);
		al_set_dst_node(ps, "orgMsgType", acc.msgType);
		al_set_dst_node(ps, "orgMsgVersion", acc.msgVersion);
		al_set_dst_node(ps, "orgDtdFilename", acc._dtd_filename);
	} else {
	}
	al_set_dst_node(ps, "myId", my_id);
	al_set_dst_node(ps, "myRole", my_role);
	al_set_dst_node(ps, "partnerId", partner_id);
	al_set_dst_node(ps, "partnerRole", partner_role);
	if (app_pid) {
		al_set_dst_node(ps, "appProcessId", app_pid);
	} else {
	}
	if (sync_type) {
		al_set_dst_node(ps, "syncType", sync_type);
	} else {
	}
	al_set_dst_node(ps, "startTime", Context::genTimeStamp());
	mgr.putProperties(sendProcessId, ps, conn);
	mgr.start(sendProcessId, conn);
	return sendProcessId;
}
end_body
member
public: void set_org_msg_info(string msgId);
body
{
	org_msgId = msgId;
}
end_body
member
public: void set_app_pid(string pid);
body
{
	app_pid = pid;
}
end_body
member
public: string send_process_name;
member
public: string org_msgId;
member
public: string org_msg_type;
member
public: string org_msg_version;
member
public: string org_dtd_filename;
member
public: string app_pid;
member
public: string sync_type;
class RNIF20Transmitter
member
public: string send(string msgId, string partner_id);
body
{
	var DbConnection conn;
	try {
		var string sendProcessId;
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		sendProcessId = send(msgId, partner_id, conn);
		conn.commit();
		conn.close();
		return sendProcessId;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: string send(string msgId, string partner_id, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	acc = new XmlDbAccessor;
	acc.create("", "", conn);
	acc.getWithMsgTypeAndMsgVersion(msgId);
	var RNContext ctx;
	ctx = new RNContext;
	var list partner_props;
	var string partner_role, my_id, my_role;
	partner_role = ctx.getPartnerRole(partner_id, acc.msgType, conn);
	partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
	if (al_dst_node(partner_props, acc.msgType + ".sync") == "true") {
		sync_type = "sync";
	} else {
	}
	my_role = ctx.getMyRole(partner_id, acc.msgType, conn);
	my_id = ctx.my_id;
	send_process_name = "RNIF20SendProcess";
	return TransportTransmitter::send(msgId, partner_id, partner_role, my_id, my_role, conn);
}
end_body
member
public: string send(string msgId, string partner_id, string partner_role, string my_id, string my_role);
body
{
	var DbConnection conn;
	try {
		var string sendProcessId;
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		sendProcessId = send(msgId, partner_id, partner_role, my_id, my_role, conn);
		conn.commit();
		conn.close();
		return sendProcessId;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: string send(string msgId, string partner_id, string partner_role, string my_id, string my_role, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	acc = new XmlDbAccessor;
	acc.create("", "", conn);
	acc.getWithMsgTypeAndMsgVersion(msgId);
	var RNContext ctx;
	ctx = new RNContext;
	var list partner_props;
	partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
	if (al_dst_node(partner_props, acc.msgType + ".sync") == "true") {
		sync_type = "sync";
	} else {
	}
	send_process_name = "RNIF20SendProcess";
	return TransportTransmitter::send(msgId, partner_id, partner_role, my_id, my_role, conn);
}
end_body
end_class
end_class
end_class
class ProxyServer
member
public: string name;
member
public: integer port;
member
public: integer connect_timeout;
member
public: list start();
body
{
	var string err;
	conn_mgr = new ProxyServerConnectionMgr;
	conn_mgr.create(this);
	if (err = conn_mgr.start()) {
		return err;
	} else {
	}
}
end_body
member
public: void stop();
body
{
	if (conn_mgr) {
		conn_mgr.close();
		conn_mgr = null;
	} else {
	}
	ap_server = null;
}
end_body
member
public: ProxyServerConnectionMgr conn_mgr;
member
public: void timeoutCheck();
body
{
	var list itr;
	if (conn_mgr && conn_mgr.connections) {
		var ProxyServerConnection conn;
		itr = al_dst_itr(conn_mgr.connections);
		loop {
			if (conn = al_next(itr)) {
			} else {
				break;
			}
			conn._time = conn._time + 1;
			if (conn._time >= connectionTimeout) {
				al_prev(itr);
				conn.close();
			} else {
			}
		}
	} else {
	}
}
end_body
member
public: integer connectionTimeout;
member
public: AltairServer ap_server;
member
public: integer maxMsgSize;
member
public: void proxy_log(string fromIP, string path, string reason);
body
{
	if (ap_server) {
		if (proxy_log_filepath) {
			var string s;
			s = fromIP + " \"" + path + "\" " + reason;
			ap_server.log(proxy_log_filepath, s);
		} else {
		}
		if (proxy_log_db) {
			var DbConnection conn;
			var string db_type;
			try {
				conn = DbManager::getConnection(ProcessEngine::pool_name);
				db_type = DbManager::getDbType(ProcessEngine::pool_name);
				var string sql, time;
				time = al_misc("get_time", null, null);
				time = al_misc("get_localtime", time, null);
				time = al_misc("format_time", time, "yyyy'/'MM'/'dd'-'HH':'mm':'ss");
				sql = al_copy("insert into ProxyLog (ProxyLogId, Time, FromIP, Path, Reason) values ('");
				al_append_str(sql, conn.getNextSeq("ProxyLogId_seq"));
				al_append_str(sql, "','");
				al_append_str(sql, time);
				al_append_str(sql, "','");
				al_append_str(sql, (string)fromIP);
				al_append_str(sql, "','");
				al_append_str(sql, DbUtility::convChar((string)path));
				al_append_str(sql, "','");
				al_append_str(sql, (string)reason);
				al_append_str(sql, "')");
				conn.executeUpdate(sql);
				conn.commit();
				conn.close();
			} catch (AlException e) {
				if (conn) {
					try {
						conn.rollback();
					} catch (AlException e) {
					}
					try {
						conn.close();
					} catch (AlException e) {
					}
				} else {
				}
			}
		} else {
		}
	} else {
	}
}
end_body
member
public: string proxy_log_filepath;
member
public: string proxy_log_db;
member
public: void error_log(string str);
body
{
	ap_server.system_log("error", "ProxyServer: " + str);
}
end_body
class ProxyServerConnectionMgr
member
public: void create(ProxyServer server);
body
{
	this.server = server;
	connections = al_cons(null, null);
}
end_body
member
public: void close();
body
{
	if (server_socket_id) {
		al_socket("close", server_socket_id, null, null);
		server_socket_id = null;
	} else {
	}
	if (hwnd && msg) {
		al_wnd_message(null, "msg_callback", msg, null);
		al_wnd_message(null, "unregister_msg", msg, null);
		hwnd = msg = null;
	} else {
	}
	var list itr;
	var ProxyServerConnection conn;
	loop {
		itr = al_dst_itr(connections);
		if (conn = al_next(itr)) {
		} else {
			break;
		}
		conn.close();
	}
	server = null;
}
end_body
member
public: ProxyServer server;
member
public: list connections;
member
public: list start();
body
{
	var string err;
	if (server_socket_id = al_socket("socket", null, null, null)) {
	} else {
		return "fail to create server socket.";
	}
	if (al_socket("bind", server_socket_id, al_list2(0, server.port), null)) {
		err = (string)al_socket("get_last_error", server_socket_id, null, null);
		err = "fail to bind socket with port = " + (string)server.port + ". (" + err + ")";
		close();
		return err;
	} else {
	}
	if (al_socket("listen", server_socket_id, null, null)) {
		err = (string)al_socket("get_last_error", server_socket_id, null, null);
		close();
		return "fail to listen socket. (" + err + ")";
	} else {
	}
	var list cb;
	hwnd = al_wnd_message(null, "hwnd", null, null);
	msg = al_wnd_message(null, "register_msg", "ACCEPT" + (string)server_socket_id, null);
	cb = al_list3(al_root_class(), this, ProxyServerConnectionMgr::accepted);
	al_wnd_message(null, "msg_callback", msg, cb);
	if (al_socket("accept_que", server_socket_id, al_list2(hwnd, msg), null)) {
		err = (string)al_socket("get_last_error", server_socket_id, null, null);
		close();
		return "fail to start accept_queue. (" + err + ")";
	} else {
	}
	return null;
}
end_body
member
public: integer server_socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: void accepted();
body
{
	var integer socket_id;
	server_socket_id = al_wnd_message(null, "wParam", null, null);
	if (socket_id = al_socket("get_socket", server_socket_id, null, null)) {
	} else {
		server.error_log("fail to get_socket: port = " + (string)server.port);
		return;
	}
	if (socket_id < 0) {
		server.error_log("fail to accept socket: port = " + (string)server.port);
		return;
	} else {
	}
	var ProxyServerConnection conn;
	conn = new ProxyServerConnection;
	conn.create(server, socket_id);
	conn._time = 0;
	var list ip_addr;
	ip_addr = al_socket("getpeername", socket_id, null, null);
	if (ip_addr) {
		ip_addr = ip_addr.head;
		conn.fromIP = al_socket("address_string", ip_addr, null, null);
	} else {
		conn.fromIP = "";
	}
	al_create_arc(connections, conn, socket_id);
	conn.startReceiveCommand();
}
end_body
end_class
class ProxyServerConnection
member
public: void create(ProxyServer server, integer socket_id);
body
{
	connection_debug();
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::create: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyServerConnection::create: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	this.server = server;
	this.socket_id = socket_id;
	hwnd = al_wnd_message(null, "hwnd", null, null);
	msg = al_wnd_message(null, "register_msg", "ProxySvrConn-" + (string)socket_id, null);
	msg2 = al_wnd_message(null, "register_msg", "ProxySvrConn2-" + (string)socket_id, null);
	buffer_size = 4096;
}
end_body
member
public: void close();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::close: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyServerConnection::close: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var integer id;
	id = socket_id;
	if (socket_id) {
		al_socket("close", socket_id, null, null);
		socket_id = null;
	} else {
	}
	if (hwnd && msg && msg2) {
		al_wnd_message(null, "msg_callback", msg, null);
		al_wnd_message(null, "msg_callback", msg2, null);
		al_wnd_message(null, "unregister_msg", msg, null);
		al_wnd_message(null, "unregister_msg", msg2, null);
		hwnd = msg = msg2 = null;
	} else {
	}
	var list connections;
	if (connections = al_src_node(this, id)) {
		al_set_dst_node(connections, id, null);
	} else {
	}
	if (conn && conn.socket_id) {
		conn.close();
		conn = null;
	} else {
	}
}
end_body
member
public: ProxyServer server;
member
public: integer socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer msg2;
member
public: integer _time;
member
public: void startReceiveCommand();
body
{
	if (msg) {
	} else {
		return;
	}
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::startReceiveCommand: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyServerConnection::startReceiveCommand: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, ProxyServerConnection::commandReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buffer = al_misc("binary", buffer_size, null);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 1))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error.(" + err + ")");
		close();
		return;
	} else {
	}
}
end_body
member
public: void startReceiveHeaders();
body
{
	if (msg) {
	} else {
		return;
	}
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::startReceiveHeaders: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyServerConnection::startReceiveHeaders: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, ProxyServerConnection::headersReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buffer = al_misc("binary", buffer_size, null);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 2))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error.(" + err + ")");
		close();
		return;
	} else {
	}
}
end_body
member
public: void startReceive();
body
{
	if (msg) {
	} else {
		return;
	}
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::startReceive: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyServerConnection::startReceive: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, ProxyServerConnection::received);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list2(hwnd, msg))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error.(" + err + ")");
		close();
		return;
	} else {
	}
}
end_body
member
public: void commandReceived();
body
{
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::commandReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! ProxyServerConnection::commandReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error. (" + err + ")");
		close();
		return;
	} else {
	}
	if (al_misc("get_byte", al_list2(buffer, read_bytes - 1), null) == '\r') {
		command_line = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes - 1), null);
	} else {
		command_line = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null);
	}
	var string cmd;
	in = al_file_open(command_line, "sr");
	if (cmd = al_file_read(in, "string")) {
	} else {
		// *** server.error_log("request Method not found.");
		close();
		return;
	}
	cmd = al_str_misc("to_upper", cmd, null);
	if (request_url = al_file_read(in, "string")) {
	} else {
		// *** server.error_log("request URI not found.");
		close();
		return;
	}
	if (http_ver = al_file_read(in, "string")) {
	} else {
		// *** server.error_log("HTTP version not found.");
		close();
		return;
	}
	command = cmd;
	if (command == "CONNECT") {
		request_url = "https://" + request_url + "/";
	} else {
	}
	_time = 0;
	conn = new ProxyClientConnection;
	if (err = conn.create(server, request_url)) {
		conn = null;
		send_status = "proxy_response_400";
		if (err = send(http_ver + " 400 Bad Request\n")) {
			// *** server.error_log("bad request URI.");
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	if (err = conn.connect()) {
		server.proxy_log(fromIP, command_line, (string)err);
		send_status = "proxy_response_400";
		if (err = send(http_ver + " 400 Bad Request\n")) {
			// *** server.error_log("can't connect to server of request URI.");
			close();
			return;
		} else {
		}
		return;
	} else {
		server.proxy_log(fromIP, command_line, "");
	}
	conn.conn = this;
	if (command == "CONNECT") {
		var string status, headers_str, res;
		var list headers, buf;
		status = http_ver + " 200 Connection established\n";
		headers = al_cons(null, null);
		al_set_dst_node(headers, "Server", "AltairServer" + al_misc("version", null, null));
		buf = al_crypt("mime_headers_write", headers, null, null);
		headers_str = al_misc("binary_to_string", al_list3(buf, 0, al_misc("binary_size", buf, null)), null);
		res = status + headers_str;
		send_status = "proxy_response_200";
		if (err = send(res)) {
			close();
			return;
		} else {
		}
		if (err = conn.startReceive()) {
			close();
			return;
		} else {
		}
	} else {
		startReceiveHeaders();
	}
}
end_body
member
public: void headersReceived();
body
{
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::headersReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! ProxyServerConnection::headersReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error. (" + err + ")");
		close();
		return;
	} else {
	}
	if (send_status) {
		startReceive();
	} else {
		var string cmd_str, hdrs_str;
		var integer size;
		cmd_str = command + " " + conn.path + " " + http_ver + "\n";
		headers = al_misc("binary", read_bytes, null);
		al_misc("binary_copy", al_list2(headers, 0), al_list3(buffer, 0, read_bytes));
		if (debug2) {
			size = al_misc("binary_size", headers, null);
			hdrs_str = al_misc("binary_to_string", al_list3(headers, 0, size), null);
			if (debug_log_file && appServer) {
				appServer.log(debug_log_file, "======== Recv Proxy Request Header: proxy_server_socket_id = " + (string)socket_id + ", proxy_client_socket_id = " + (string)conn.socket_id + "\n" + cmd_str + hdrs_str);
			} else {
				al_print("======== Recv Proxy Request Header: proxy_server_socket_id = " + (string)socket_id + ", proxy_client_socket_id = " + (string)conn.socket_id + "\n" + cmd_str + hdrs_str);
			}
		} else {
		}
		headers = al_crypt("remove_header", headers, "Proxy-Connection", null);
		headers = al_crypt("add_header", headers, "Connection: Close\n", null);
		// ignore cache-control
		headers = al_crypt("remove_header", headers, "If-Modified-Since", null);
		headers = al_crypt("remove_header", headers, "If-Match", null);
		headers = al_crypt("remove_header", headers, "If-None-Match", null);
		headers = al_crypt("remove_header", headers, "If-Range", null);
		headers = al_crypt("remove_header", headers, "If-Unmodified-Since", null);
		headers = al_crypt("remove_header", headers, "Pragma", null);
		size = al_misc("binary_size", headers, null);
		hdrs_str = al_misc("binary_to_string", al_list3(headers, 0, size), null);
		if (debug2) {
			if (debug_log_file && appServer) {
				appServer.log(debug_log_file, "======== Send Proxy Request Header: proxy_server_socket_id = " + (string)socket_id + ", proxy_client_socket_id = " + (string)conn.socket_id + "\n" + cmd_str + hdrs_str);
			} else {
				al_print("======== Send Proxy Request Header: proxy_server_socket_id = " + (string)socket_id + ", proxy_client_socket_id = " + (string)conn.socket_id + "\n" + cmd_str + hdrs_str);
			}
		} else {
		}
		send_status = "proxy_response";
		if (err = conn.send(cmd_str + hdrs_str)) {
			close();
			return;
		} else {
		}
		if (err = conn.startReceiveCommand()) {
			close();
			return;
		} else {
		}
	}
}
end_body
member
public: void received();
body
{
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::received: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! ProxyServerConnection::received: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error. (" + err + ")");
		close();
		return;
	} else {
	}
	if (read_bytes > 0 && conn) {
		conn.send(buffer, 0, read_bytes);
	} else {
	}
}
end_body
member
public: integer buffer_size;
member
public: list buffer;
member
public: string command_line;
member
public: string command;
member
public: string request_url;
member
public: string path;
member
public: string http_ver;
member
public: list headers;
member
public: list send(string str);
body
{
	var integer size;
	var list binary;
	size = al_strlen(str);
	binary = al_misc("binary", size, null);
	al_misc("binary_copy", al_list2(binary, 0), str);
	return send(binary, 0, size);
}
end_body
member
public: list send(list binary);
body
{
	var integer size;
	size = al_misc("binary_size", binary, null);
	return send(binary, 0, size);
}
end_body
member
public: list send(list binary, integer index, integer size);
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::send: socket_id = " + (string)socket_id + ", size = " + (string)size);
		} else {
			al_print("!!! ProxyServerConnection::send: socket_id = " + (string)socket_id + ", size = " + (string)size + "\n");
		}
	} else {
	}
	var list cb, block;
	cb = al_list3(al_root_class(), this, ProxyServerConnection::sendCompleted);
	al_wnd_message(null, "msg_callback", msg2, cb);
	block = al_list3(binary, index, size);
	if (debug3) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "---- send to Browser\n" + (string)al_misc("binary_to_string", block, null));
		} else {
			al_print("---- send to Browser\n" + (string)al_misc("binary_to_string", block, null));
		}
	} else {
	}
	if (al_socket("send", socket_id, block, al_list2(hwnd, msg2))) {
		return "send error. (" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
	} else {
	}
	sending = 1;
	return null;
}
end_body
member
public: void sendCompleted();
body
{
	sending = null;
	var string err;
	var integer send_bytes;
	send_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyServerConnection::sendCompleted: socket_id = " + (string)socket_id + ", send_bytes = " + (string)send_bytes);
		} else {
			al_print("!!! ProxyServerConnection::sendCompleted: socket_id = " + (string)socket_id + ", send_bytes = " + (string)send_bytes + "\n");
		}
	} else {
	}
	if (send_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("send error. (" + err + ")");
		close();
		return;
	} else {
	}
	if (exiting) {
		close();
		return;
	} else {
	}
	if (send_status == "proxy_response_200") {
		send_status = "proxy_response";
		if (err = startReceiveHeaders()) {
			close();
			return;
		} else {
		}
		_time = 0;
		return;
	} else {
	}
	if (send_status == "proxy_response") {
		if (conn && conn.socket_id) {
			if (err = conn.startReceive()) {
				close();
				return;
			} else {
			}
			return;
		} else {
		}
		_time = 0;
		return;
	} else {
	}
	close();
	return;
}
end_body
member
public: string send_status;
member
public: list exiting;
member
public: file in;
member
public: string fromIP;
member
public: ProxyClientConnection conn;
member
public: list sending;
end_class
class ProxyClientConnection
member
public: list create(ProxyServer server, string url);
body
{
	connection_debug();
	this.server = server;
	if (url == null) {
		return "url is null.";
	} else {
	}
	this.url = url;
	var integer i;
	var string head, tail;
	i = al_search_str(url, 0, "//");
	if (i < 0) {
		return "http:// or https:// required: url = " + (string)url;
	} else {
	}
	head = al_substr(url, 0, i);
	if (head == "http:") {
		ssl = null;
	} else {
		if (head == "https:") {
			ssl = 1;
		} else {
			return "http:// or https:// required: url = " + (string)url;
		}
	}
	tail = al_tail_str(url, i + 2);
	i = al_search_str(tail, 0, "/");
	if (i > 0) {
		path = al_tail_str(tail, i);
		tail = al_substr(tail, 0, i);
	} else {
		path = "/";
	}
	i = al_search_str(tail, 0, ":");
	if (i >= 0) {
		host = al_substr(tail, 0, i);
		port = (integer)al_tail_str(tail, i + 1);
	} else {
		host = tail;
		if (ssl) {
			port = 443;
		} else {
			port = 80;
		}
	}
	buffer_size = 4096;
	buffer = al_misc("binary", buffer_size, null);
	// default timeout is 60 sec (1 minutes)
	_time = 0;
	timeout = 60;
	return null;
}
end_body
member
public: ProxyServer server;
member
public: list connect();
body
{
	var integer hostaddr;
	if (socket_id = al_socket("socket", null, null, null)) {
	} else {
		return "fail to create socket";
	}
	if (hostaddr_cache) {
	} else {
		hostaddr_cache = al_cons(null, null);
	}
	if (hostaddr = al_dst_node(hostaddr_cache, host)) {
	} else {
		if (hostaddr = al_socket("gethostbyname", host, null, null)) {
		} else {
			return "fail to get hostaddr: host = " + (string)host;
		}
		al_create_arc(hostaddr_cache, hostaddr, host);
	}
	if (al_socket("connect", socket_id, al_list2(hostaddr, port), server.connect_timeout)) {
		return "fail to connect socket.(" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
	} else {
	}
	hwnd = al_wnd_message(null, "hwnd", null, null);
	msg = al_wnd_message(null, "register_msg", "ProxyClntConn-" + (string)socket_id, null);
	msg2 = al_wnd_message(null, "register_msg", "ProxyClntConn2-" + (string)socket_id, null);
	if (connections) {
	} else {
		connections = al_cons(null, null);
	}
	al_create_arc(connections, this, socket_id);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::create: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyClientConnection::create: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	return null;
}
end_body
member
public: void close();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::close: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyClientConnection::close: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var integer id;
	id = socket_id;
	if (socket_id) {
		al_socket("close", socket_id, null, null);
		socket_id = null;
	} else {
	}
	if (hwnd && msg && msg2) {
		al_wnd_message(null, "msg_callback", msg, null);
		al_wnd_message(null, "msg_callback", msg2, null);
		al_wnd_message(null, "unregister_msg", msg, null);
		al_wnd_message(null, "unregister_msg", msg2, null);
		hwnd = msg = msg2 = null;
	} else {
	}
	var list conns;
	if (conns = al_src_node(this, id)) {
		al_set_dst_node(conns, id, null);
	} else {
	}
	conn = null;
}
end_body
member
public: string url;
member
public: list ssl;
member
public: string host;
member
public: integer port;
member
public: string path;
member
public: integer socket_id;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer msg2;
member
public: integer _time;
member
public: void setTimeout(integer sec);
body
{
	timeout = sec;
}
end_body
member
public: integer timeout;
member
public: list send(string str);
body
{
	var integer size;
	var list binary;
	size = al_strlen(str);
	binary = al_misc("binary", size, null);
	al_misc("binary_copy", al_list2(binary, 0), str);
	return send(binary, 0, size);
}
end_body
member
public: list send(list binary);
body
{
	var integer size;
	size = al_misc("binary_size", binary, null);
	return send(binary, 0, size);
}
end_body
member
public: list send(list binary, integer index, integer size);
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::send: socket_id = " + (string)socket_id + ", size = " + (string)size);
		} else {
			al_print("!!! ProxyClientConnection::send: socket_id = " + (string)socket_id + ", size = " + (string)size + "\n");
		}
	} else {
	}
	var list cb, block;
	cb = al_list3(al_root_class(), this, ProxyClientConnection::sendCompleted);
	al_wnd_message(null, "msg_callback", msg2, cb);
	block = al_list3(binary, index, size);
	if (debug3) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "---- send to Server\n" + (string)al_misc("binary_to_string", block, null));
		} else {
			al_print("---- send to Server\n" + (string)al_misc("binary_to_string", block, null));
		}
	} else {
	}
	if (al_socket("send", socket_id, block, al_list2(hwnd, msg2))) {
		return "send error. (" + (string)al_socket("get_last_error", socket_id, null, null) + ")";
	} else {
	}
	return null;
}
end_body
member
public: void sendCompleted();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::sendCompleted: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyClientConnection::sendCompleted: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	if (conn) {
		conn.startReceive();
	} else {
	}
}
end_body
member
public: list startReceiveCommand();
body
{
	if (msg) {
	} else {
		return "already closed.";
	}
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::startReceiveCommand: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyClientConnection::startReceiveCommand: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, ProxyClientConnection::commandReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buffer = al_misc("binary", buffer_size, null);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 1))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		err = "recv error.(" + err + ")";
		// *** server.error_log(err);
		close();
		return err;
	} else {
	}
	return null;
}
end_body
member
public: list startReceiveHeaders();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::startReceiveHeaders: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyClientConnection::startReceiveHeaders: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, ProxyClientConnection::headersReceived);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list3(hwnd, msg, 2))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		err = "recv error. (" + err + ")";
		// *** server.error_log(err);
		return err;
	} else {
	}
	return null;
}
end_body
member
public: list startReceive();
body
{
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::startReceive: socket_id = " + (string)socket_id);
		} else {
			al_print("!!! ProxyClientConnection::startReceive: socket_id = " + (string)socket_id + "\n");
		}
	} else {
	}
	var list cb, buf, err;
	cb = al_list3(al_root_class(), this, ProxyClientConnection::received);
	al_wnd_message(null, "msg_callback", msg, cb);
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", socket_id, buf, al_list2(hwnd, msg))) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error.(" + err + ")");
		close();
		return err;
	} else {
	}
	return null;
}
end_body
member
public: void commandReceived();
body
{
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::commandReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! ProxyClientConnection::commandReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error. (" + err + ")");
		close();
		return;
	} else {
	}
	if (al_misc("get_byte", al_list2(buffer, read_bytes - 1), null) == '\r') {
		command_line = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes - 1), null);
	} else {
		command_line = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null);
	}
	startReceiveHeaders();
}
end_body
member
public: void headersReceived();
body
{
	if (socket_id) {
	} else {
		return;
	}
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::headersReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! ProxyClientConnection::headersReceived: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes < 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		// *** server.error_log("recv error. (" + err + ")");
		close();
		return;
	} else {
	}
	var string cmd_str, hdrs_str;
	var integer size;
	cmd_str = command_line + "\n";
	headers = al_misc("binary", read_bytes, null);
	al_misc("binary_copy", al_list2(headers, 0), al_list3(buffer, 0, read_bytes));
	if (debug2) {
		size = al_misc("binary_size", headers, null);
		hdrs_str = al_misc("binary_to_string", al_list3(headers, 0, size), null);
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "======== Recv Proxy Response Header: proxy_server_socket_id = " + (string)conn.socket_id + ", proxy_client_socket_id = " + (string)socket_id + "\n" + cmd_str + hdrs_str);
		} else {
			al_print("======== Recv Proxy Response Header: proxy_server_socket_id = " + (string)conn.socket_id + ", proxy_client_socket_id = " + (string)socket_id + "\n" + cmd_str + hdrs_str);
		}
	} else {
	}
	headers = al_crypt("remove_header", headers, "Connection", null);
	headers = al_crypt("add_header", headers, "Proxy-Connection: Close\n", null);
	// ignore cache control
	headers = al_crypt("remove_header", headers, "Cache-Control", null);
	headers = al_crypt("remove_header", headers, "ETag", null);
	if (content_length = al_crypt("get_header", headers, "Content-Length", null)) {
		content_length = (integer)content_length;
		if (debug2) {
			if (debug_log_file && appServer) {
				appServer.log(debug_log_file, "Content-Length = " + (string)content_length + "\n");
			} else {
				al_print("Content-Length = " + (string)content_length + "\n");
			}
		} else {
		}
		if (content_length < 0) {
			close();
			return;
		} else {
		}
		total_read_bytes = 0;
	} else {
	}
	size = al_misc("binary_size", headers, null);
	hdrs_str = al_misc("binary_to_string", al_list3(headers, 0, size), null);
	if (debug2) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "======== Send Proxy Response Header: proxy_server_socket_id = " + (string)conn.socket_id + ", proxy_client_socket_id = " + (string)socket_id + "\n" + cmd_str + hdrs_str);
		} else {
			al_print("======== Send Proxy Response Header: proxy_server_socket_id = " + (string)conn.socket_id + ", proxy_client_socket_id = " + (string)socket_id + "\n" + cmd_str + hdrs_str);
		}
	} else {
	}
	if (err = conn.send(cmd_str + hdrs_str)) {
		close();
		return;
	} else {
	}
}
end_body
member
public: void received();
body
{
	var list err;
	var integer read_bytes;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (debug) {
		if (debug_log_file && appServer) {
			appServer.log(debug_log_file, "!!! ProxyClientConnection::received: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes);
		} else {
			al_print("!!! ProxyClientConnection::received: socket_id = " + (string)socket_id + ", read_bytes = " + (string)read_bytes + "\n");
		}
	} else {
	}
	if (read_bytes <= 0) {
		err = (string)al_socket("get_last_error", socket_id, null, null);
		if (conn && conn.sending == null) {
			conn.close();
		} else {
			close();
		}
		return;
	} else {
	}
	if (read_bytes > 0 && conn) {
		if (content_length) {
			total_read_bytes = total_read_bytes + read_bytes;
			if (total_read_bytes >= content_length) {
				conn.exiting = 1;
			} else {
			}
		} else {
		}
		conn.send(buffer, 0, read_bytes);
	} else {
	}
}
end_body
member
public: list error;
member
public: integer buffer_size;
member
public: list buffer;
member
public: string command_line;
member
public: list headers;
member
public: integer content_length;
member
public: integer total_read_bytes;
member
public: static list connections;
member
public: ProxyServerConnection conn;
member
public: static list hostaddr_cache;
end_class
end_class
class InetClient
member
public: void create(string host, integer port);
body
{
	this.host = host;
	this.port = port;
	// default timeout is 60 sec (1 minutes)
	timeout = 60;
	_time = 0;
}
end_body
member
public: void close();
body
{
	var integer id;
	id = s_id;
	if (s_id) {
		al_socket("close", s_id, null, null);
		s_id = null;
	} else {
	}
	if (msg) {
		al_wnd_message(null, "msg_callback", msg, null);
		msg = null;
	} else {
	}
	if (msg2) {
		al_wnd_message(null, "msg_callback", msg2, null);
		msg2 = null;
	} else {
	}
	if (wait_obj) {
		wait_obj.notify();
		wait_obj = null;
	} else {
	}
	var list conns;
	if (conns = al_src_node(this, id)) {
		al_set_dst_node(conns, id, null);
	} else {
	}
}
end_body
member
public: string host;
member
public: integer port;
member
public: WaitObj wait_obj;
member
public: string state;
member
public: string msg_prefix;
member
public: list start();
body
{
	var integer hostaddr;
	if (hostaddr = al_socket("gethostbyname", host, null, null)) {
	} else {
		error = "fail to gethostbyname: host = " + (string)host;
		return error;
	}
	// --------
	if (s_id = al_socket("socket", null, null, null)) {
	} else {
		return "fail to create socket";
	}
	if (al_socket("connect", s_id, al_list2(hostaddr, port), null)) {
		error = (string)al_socket("get_last_error", s_id, null, null);
		error = "fail to connect socket(" + error + "): host = " + (string)host + ", port = " + (string)port;
		close();
		return error;
	} else {
	}
	buffer_size = 4096;
	buffer = al_misc("binary", buffer_size, null);
	hwnd = al_wnd_message(null, "hwnd", null, null);
	msg = al_wnd_message(null, "register_msg", msg_prefix + "-recv-" + (string)s_id, null);
	msg2 = al_wnd_message(null, "register_msg", msg_prefix + "-send-" + (string)s_id, null);
	var list cb;
	cb = al_list3(al_root_class(), this, InetClient::received);
	al_wnd_message(null, "msg_callback", msg, cb);
	cb = al_list3(al_root_class(), this, InetClient::sendCompleted);
	al_wnd_message(null, "msg_callback", msg2, cb);
	if (connections) {
	} else {
		connections = al_cons(null, null);
	}
	al_create_arc(connections, this, s_id);
	// --------
	if (error = startReceive()) {
		close();
		return error;
	} else {
	}
	wait_obj = new WaitObj;
	wait_obj.wait();
	return error;
}
end_body
member
public: integer s_id;
member
public: string error;
member
public: integer buffer_size;
member
public: list buffer;
member
public: integer hwnd;
member
public: integer msg;
member
public: integer msg2;
member
public: list startReceive();
body
{
	var list buf;
	var list err;
	buf = al_list3(buffer, 0, buffer_size);
	if (al_socket("recv", s_id, buf, al_list3(hwnd, msg, 1))) {
		err = (string)al_socket("get_last_error", s_id, null, null);
		return "recv error(" + err + ")";
	} else {
	}
	return null;
}
end_body
member
public: void received();
body
{
}
end_body
member
public: integer read_bytes;
member
public: list send(string msg);
body
{
	var list err;
	if (debug) {
		al_print("send: " + msg);
	} else {
	}
	if (al_socket("send", s_id, msg, al_list2(hwnd, msg2))) {
		err = (string)al_socket("get_last_error", s_id, null, null);
		return "send error(" + err + ")";
	} else {
	}
	return null;
}
end_body
member
public: void sendCompleted();
member
public: integer timeout;
member
public: integer _time;
member
public: static void timeoutCheck();
body
{
	var list itr;
	var InetClient client;
	if (connections) {
	} else {
		return;
	}
	itr = al_dst_itr(connections);
	loop {
		if (client = al_next(itr)) {
		} else {
			break;
		}
		client._time = client._time + 1;
		if (client._time > client.timeout) {
			al_prev(itr);
			client.error = "timeout";
			client.close();
		} else {
		}
	}
}
end_body
member
public: static list connections;
class SmtpClient
member
public: void create(string host, integer port);
body
{
	InetClient::create(host, port);
	state = "AwaitGreeting";
	msg_prefix = "SMTP";
	rcpts = al_cons(null, null);
	to = al_cons(null, null);
	cc = al_cons(null, null);
	headers = al_cons(null, null);
}
end_body
member
public: void create(string host);
body
{
	create(host, 25);
}
end_body
member
public: void received();
body
{
	_time = 0;
	var list response;
	var integer code;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (read_bytes <= 0) {
		error = "socket read error(" + (string)al_socket("get_last_error", s_id, null, null) + ")";
		close();
		return;
	} else {
	}
	// --------
	if (state == "AwaitGreeting") {
		response = checkResponse();
		error = response.head;
		code = response.tail.head;
		if (code / 10 != 22) {
			close();
			return;
		} else {
		}
		if (response.tail.tail.head) {
			if (error = startReceive()) {
				close();
			} else {
			}
			return;
		} else {
		}
		if (error = send("HELO " + (string)al_socket("gethostname", null, null, null) + "\n")) {
			close();
			return;
		} else {
		}
		state = "AwaitHelloResponse";
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	// --------
	if (state == "AwaitHelloResponse") {
		response = checkResponse();
		error = response.head;
		code = response.tail.head;
		if (code / 10 != 25) {
			close();
			return;
		} else {
		}
		if (response.tail.tail.head) {
			if (error = startReceive()) {
				close();
			} else {
			}
			return;
		} else {
		}
		if (from) {
		} else {
			error = "from is empty.";
			close();
			return;
		}
		if (error = send("MAIL FROM:<" + from + ">\n")) {
			close();
			return;
		} else {
		}
		state = "AwaitMailFromResponse";
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	// --------
	if (state == "AwaitMailFromResponse") {
		response = checkResponse();
		error = response.head;
		code = response.tail.head;
		if (code / 10 != 25) {
			close();
			return;
		} else {
		}
		if (response.tail.tail.head) {
			if (error = startReceive()) {
				close();
			} else {
			}
			return;
		} else {
		}
		var string rcpt_to;
		rcpts_itr = al_dst_itr(rcpts);
		rcpt_to = al_next(rcpts_itr);
		if (rcpt_to) {
		} else {
			error = "rcpt to is empty.";
			close();
			return;
		}
		if (error = send("RCPT TO:<" + rcpt_to + ">\n")) {
			close();
			return;
		} else {
		}
		state = "AwaitRcptToResponse";
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	// --------
	if (state == "AwaitRcptToResponse") {
		response = checkResponse();
		error = response.head;
		code = response.tail.head;
		if (code / 10 != 25) {
			close();
			return;
		} else {
		}
		if (response.tail.tail.head) {
			if (error = startReceive()) {
				close();
			} else {
			}
			return;
		} else {
		}
		var string rcpt_to;
		if (rcpt_to = al_next(rcpts_itr)) {
			if (error = send("RCPT TO:<" + rcpt_to + ">\n")) {
				close();
				return;
			} else {
			}
		} else {
			if (error = send("DATA\n")) {
				close();
				return;
			} else {
			}
			state = "AwaitDataResponse";
		}
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	// --------
	if (state == "AwaitDataResponse") {
		response = checkResponse();
		error = response.head;
		code = response.tail.head;
		if (code / 10 != 35) {
			close();
			return;
		} else {
		}
		if (response.tail.tail.head) {
			if (error = startReceive()) {
				close();
			} else {
			}
			return;
		} else {
		}
		var list itr;
		var string addr;
		itr = al_dst_itr(to);
		loop {
			if (addr = al_next(itr)) {
			} else {
				break;
			}
			al_create_arc(headers, addr, "To");
		}
		itr = al_dst_itr(cc);
		loop {
			if (addr = al_next(itr)) {
			} else {
				break;
			}
			al_create_arc(headers, addr, "Cc");
		}
		al_create_arc(headers, from, "From");
		al_create_arc(headers, getDate(), "Date");
		if (subject) {
		} else {
			subject = "";
		}
		al_create_arc(headers, subject, "Subject");
		if (messageid) {
		} else {
			messageid = getMessageID();
		}
		al_create_arc(headers, messageid, "Message-Id");
		if (in_reply_to) {
			al_create_arc(headers, in_reply_to, "In-Reply-To");
		} else {
		}
		if (references) {
			al_create_arc(headers, references, "References");
		} else {
		}
		al_create_arc(headers, "1.0", "MIME-Version");
		al_create_arc(headers, "AltairMailClient " + (string)al_misc("version", null, null), "X-Mailer");
		if (text) {
		} else {
			error = "mail content text is empty.";
			close();
			return;
		}
		if (al_dst_node_i(headers, "Content-Type")) {
		} else {
			if (content_type) {
			} else {
				var string text2;
				if (text2 = al_str_misc("sjis_to_jis", text, null)) {
					text = text2;
					content_type = "text/plain; charset =\"iso-2022-jp\"";
				} else {
					content_type = "text/plain; charset =\"us-ascii\"";
				}
			}
			al_create_arc(headers, content_type, "Content-Type");
		}
		if (al_dst_node_i(headers, "Content-Length")) {
		} else {
			if (content_length) {
				al_create_arc(headers, (string)content_length, "Content-Length");
			} else {
			}
		}
		if (al_dst_node_i(headers, "Content-Transfer-Encoding")) {
		} else {
			al_create_arc(headers, "7bit", "Content-Transfer-Encoding");
		}
		var list buf;
		var string send_msg;
		buf = al_crypt("mime_headers_write", headers, null, null);
		send_msg = al_misc("binary_to_string", al_list3(buf, 0, al_misc("binary_size", buf, null)), null);
		var file f;
		var string line;
		f = al_file_open(text, "sr");
		loop {
			if (line = al_file_read(f, "line")) {
			} else {
				break;
			}
			if (al_strlen(line) > 0 && al_get_char(line, 0) == '.') {
				send_msg = al_append_str(send_msg, ".");
			} else {
			}
			send_msg = al_append_str(send_msg, line + "\n");
		}
		send_msg = al_append_str(send_msg, "\n.\n");
		if (error = send(send_msg)) {
			close();
			return;
		} else {
		}
		state = "AwaitDataTransferResponse";
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	// --------
	if (state == "AwaitDataTransferResponse") {
		response = checkResponse();
		error = response.head;
		code = response.tail.head;
		if (code / 10 != 25) {
			close();
			return;
		} else {
		}
		if (response.tail.tail.head) {
			if (error = startReceive()) {
				close();
			} else {
			}
			return;
		} else {
		}
		if (error = send("QUIT\n")) {
			close();
			return;
		} else {
		}
		state = "AwaitQuitResponse";
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	// --------
	if (state == "AwaitQuitResponse") {
		response = checkResponse();
		error = response.head;
		code = response.tail.head;
		if (code / 10 != 22) {
			close();
			return;
		} else {
		}
		if (response.tail.tail.head) {
			if (error = startReceive()) {
				close();
			} else {
			}
			return;
		} else {
		}
		error = null;
		close();
		return;
	} else {
	}
	error = "unknown state(" + state + ")";
	close();
}
end_body
member
public: list checkResponse();
body
{
	var list err;
	var string recv_msg;
	if (read_bytes <= 0) {
		err = (string)al_socket("get_last_error", s_id, null, null);
		return al_list3(err, 0, null);
	} else {
	}
	recv_msg = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null);
	if (debug) {
		al_print("recv: " + recv_msg + "\n");
	} else {
	}
	var file f;
	var integer code, ch;
	f = al_file_open(recv_msg, "sr");
	if (code = al_file_read(f, "integer")) {
	} else {
		code = 0;
	}
	ch = al_file_read(f, "char");
	if (ch == '-') {
		ch = 1;
	} else {
		ch = null;
	}
	return al_list3("msg = \"" + (string)recv_msg + "\"", code, ch);
}
end_body
member
public: list headers;
member
public: string from;
member
public: list rcpts;
member
public: list rcpts_itr;
member
public: list to;
member
public: list cc;
member
public: string subject;
member
public: string text;
member
public: string date;
member
public: string messageid;
member
public: string in_reply_to;
member
public: string references;
member
public: string content_type;
member
public: integer content_length;
member
public: string domain;
member
public: string getDate();
body
{
	var list time;
	time = al_misc("get_time", null, null);
	time = al_misc("get_localtime", time, null);
	timestamp = al_misc("format_time", time, "yyyyMMdd'.'HHmmss");
	al_misc("para_lock", 1, null);
	if (seq) {
		seq = seq + 1;
	} else {
		seq = 1;
	}
	al_misc("para_lock", null, null);
	timestamp = timestamp + "." + (string)seq;
	var integer mm, dd, dayofweek;
	var string time_str;
	mm = time.tail.head;
	dayofweek = al_file_manip("get_dayofweek", time, null);
	if (dayofweek == 1) {
		time_str = "Sun";
	} else {
	}
	if (dayofweek == 2) {
		time_str = "Mon";
	} else {
	}
	if (dayofweek == 3) {
		time_str = "Tue";
	} else {
	}
	if (dayofweek == 4) {
		time_str = "Wed";
	} else {
	}
	if (dayofweek == 5) {
		time_str = "Thu";
	} else {
	}
	if (dayofweek == 6) {
		time_str = "Fri";
	} else {
	}
	if (dayofweek == 7) {
		time_str = "Sat";
	} else {
	}
	time_str = time_str + al_misc("format_time", time, "', 'dd' '");
	if (mm == 1) {
		time_str = time_str + "Jan";
	} else {
	}
	if (mm == 2) {
		time_str = time_str + "Feb";
	} else {
	}
	if (mm == 3) {
		time_str = time_str + "Mar";
	} else {
	}
	if (mm == 4) {
		time_str = time_str + "April";
	} else {
	}
	if (mm == 5) {
		time_str = time_str + "March";
	} else {
	}
	if (mm == 6) {
		time_str = time_str + "June";
	} else {
	}
	if (mm == 7) {
		time_str = time_str + "July";
	} else {
	}
	if (mm == 8) {
		time_str = time_str + "Aug";
	} else {
	}
	if (mm == 9) {
		time_str = time_str + "Sep";
	} else {
	}
	if (mm == 10) {
		time_str = time_str + "Oct";
	} else {
	}
	if (mm == 11) {
		time_str = time_str + "Nov";
	} else {
	}
	if (mm == 12) {
		time_str = time_str + "Dec";
	} else {
	}
	time_str = time_str + al_misc("format_time", time, "' 'yyyy' 'HH':'mm':'ss");
	return time_str;
}
end_body
member
public: integer timestamp;
member
public: static integer seq;
member
public: string getMessageID();
body
{
	timestamp = timestamp + "." + al_crypt("random", 16, null, null) + "@" + al_socket("gethostname", null, null, null);
	if (domain) {
		timestamp = timestamp + "." + domain;
	} else {
	}
	return "<" + timestamp + ">";
}
end_body
end_class
class PopClient
member
public: void create(string host, integer port);
body
{
	InetClient::create(host, port);
	state = "AwaitGreeting";
	msg_prefix = "POP";
	texts = al_cons(null, null);
}
end_body
member
public: void create(string host);
body
{
	create(host, 110);
}
end_body
member
public: void received();
body
{
	_time = 0;
	read_bytes = al_wnd_message(null, "lParam", null, null);
	if (state == "AwaitGreeting") {
		if (error = checkResponse()) {
			close();
			return;
		} else {
		}
		if (userid) {
		} else {
			error = "userID is empty.";
			close();
			return;
		}
		if (error = send("USER " + userid + "\n")) {
			close();
			return;
		} else {
		}
		state = "AwaitUserResponse";
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	if (state == "AwaitUserResponse") {
		if (error = checkResponse()) {
			close();
			return;
		} else {
		}
		if (password) {
		} else {
			error = "password is empty.";
			close();
			return;
		}
		if (error = send("PASS " + password + "\n")) {
			close();
			return;
		} else {
		}
		state = "AwaitPassResponse";
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	if (state == "AwaitPassResponse") {
		if (error = checkResponse()) {
			close();
			return;
		} else {
		}
		if (error = send("STAT\n")) {
			close();
			return;
		} else {
		}
		state = "AwaitStatResponse";
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	if (state == "AwaitStatResponse") {
		if (error = checkResponse()) {
			close();
			return;
		} else {
		}
		num_msg = num;
		msg_idx = 0;
		state = "retr1";
	} else {
	}
	if (state == "retr1") {
		msg_idx = msg_idx + 1;
		if (msg_idx <= num_msg) {
			text = al_copy("");
			if (error = send("RETR " + (string)msg_idx + "\n")) {
				close();
				return;
			} else {
			}
			state = "AwaitRetrResponse";
			if (error = startReceive()) {
				close();
				return;
			} else {
			}
			return;
		} else {
			msg_idx = 0;
			state = "dele1";
		}
	} else {
	}
	if (state == "AwaitRetrResponse") {
		if (error = checkResponse()) {
			close();
			return;
		} else {
		}
		state = "retr2";
		if (error = startReceive()) {
			close();
			return;
		} else {
		}
		return;
	} else {
	}
	if (state == "retr2") {
		var string recv_msg;
		recv_msg = readLine();
		if (recv_msg == "." || recv_msg == ".\r") {
			if (process(text)) {
				state = "retr1";
				received();
				return;
			} else {
				if (error = send("QUIT\n")) {
					close();
					return;
				} else {
				}
				state = "AwaitQuitResponse";
				if (error = startReceive()) {
					close();
					return;
				} else {
				}
				return;
			}
		} else {
			if (al_strlen(recv_msg) > 0 && al_get_char(recv_msg, 0) == '.') {
				recv_msg = al_tail_str(recv_msg, 1);
			} else {
			}
			al_append_str(text, recv_msg);
			al_append_str(text, "\n");
			if (error = startReceive()) {
				close();
				return;
			} else {
			}
			return;
		}
	} else {
	}
	if (state == "dele1") {
		msg_idx = msg_idx + 1;
		if (msg_idx <= num_msg) {
			if (error = send("DELE " + (string)msg_idx + "\n")) {
				close();
				return;
			} else {
			}
			state = "AwaitDeleResponse";
			if (error = startReceive()) {
				close();
				return;
			} else {
			}
			return;
		} else {
			if (error = send("QUIT\n")) {
				close();
				return;
			} else {
			}
			state = "AwaitQuitResponse";
			if (error = startReceive()) {
				close();
				return;
			} else {
			}
			return;
		}
	} else {
	}
	if (state == "AwaitDeleResponse") {
		if (error = checkResponse()) {
			close();
			return;
		} else {
		}
		state = "dele1";
		received();
		return;
	} else {
	}
	if (state == "AwaitQuitResponse") {
		if (error = checkResponse()) {
			close();
			return;
		} else {
		}
		close();
		return;
	} else {
	}
	error = "unknown state(" + state + ")";
	close();
}
end_body
member
public: list checkResponse();
body
{
	var list err;
	var string recv_msg;
	recv_msg = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null);
	if (debug) {
		al_print("recv: " + recv_msg + "\n");
	} else {
	}
	var file f;
	f = al_file_open(recv_msg, "sr");
	if (al_file_match_str(f, "+OK")) {
	} else {
		return recv_msg;
	}
	num = al_file_read(f, "integer");
	return null;
}
end_body
member
public: list process(string text);
body
{
	al_create_arc(texts, text, null);
	return 1;
}
end_body
member
public: integer num;
member
public: list readLine();
body
{
	var list err;
	var string recv_msg;
	recv_msg = al_misc("binary_to_string", al_list3(buffer, 0, read_bytes), null);
	if (debug) {
		al_print("recv: " + recv_msg + "\n");
	} else {
	}
	return recv_msg;
}
end_body
member
public: string userid;
member
public: string password;
member
public: integer num_msg;
member
public: integer msg_idx;
member
public: string text;
member
public: list texts;
class RNIF20PopClient
member
public: list process(string text);
body
{
	var string msgId;
	try {
		var list props;
		props = al_cons(null, null);
		var AlException ex;
		var RNContext ctx;
		ctx = new RNContext;
		msgId = Context::genMsgId();
		al_create_arc(props, msgId, "msgId");
		var list my_props;
		my_props = ctx.getMyProperties("-- default setting --", conn);
		var string dir;
		if (dir = al_dst_node(my_props, "msg.tmp.dir")) {
		} else {
			ex = new AlException;
			ex.msg = "property msg.tmp.dir is empty.";
			throw ex;
		}
		al_create_arc(props, dir, "tempDir");
		if (dir = al_dst_node(my_props, "msg.attach.dir")) {
		} else {
			ex = new AlException;
			ex.msg = "property msg.attach.dir is empty.";
			throw ex;
		}
		al_create_arc(props, dir, "attachDir");
		if (dir = al_dst_node(my_props, "msg.recv.dir")) {
		} else {
			ex = new AlException;
			ex.msg = "property msg.recv.dir is empty.";
			throw ex;
		}
		// save to file;
		var string filename;
		filename = dir + "/" + msgId;
		al_create_arc(props, filename, "filename");
		try {
			FileUtility::writeBinary(filename, text);
		} catch (AlException e) {
			ex = new AlException;
			ex.msg = "file write error: file = " + filename + ".";
			throw ex;
		}
		var list headers;
		var string from, async;
		if (headers = al_crypt("mime_headers_read", filename, null, null)) {
		} else {
			ex = new AlException;
			ex.msg = "mime header read error: file = " + filename + ".";
			throw ex;
		}
		if (from = al_dst_node_i(headers.head, "From")) {
			al_create_arc(props, from, "fromIP");
		} else {
		}
		try {
			var ProcMgr pm;
			var string pid;
			pm = new ProcMgr;
			pid = pm.create("RNIF20ReceiveProcess", conn);
			al_set_dst_node(props, "startTime", Context::genTimeStamp());
			pm.putProperties(pid, props, conn);
			pm.start(pid, conn);
			conn.commit();
		} catch (AlException e) {
			e.msg = "receive process start error: " + e.msg;
			throw e;
		}
	} catch (AlException e) {
		try {
			var list props;
			props = al_cons(null, null);
			al_set_dst_node(props, "errorReason", e.msg);
			al_set_dst_node(props, "sendRecv", "recv");
			al_set_dst_node(props, "errorLevel", "fatal");
			al_set_dst_node(props, "fromIP", "mail");
			al_set_dst_node(props, "msgId", msgId);
			var RNIF20ServiceHandler handler;
			handler = new RNIF20ServiceHandler;
			handler.conn = conn;
			handler.invokeWriteLog(props);
			conn.commit();
		} catch (AlException e) {
		}
	}
	return 1;
}
end_body
member
public: DbConnection conn;
end_class
end_class
end_class
class Poller
member
public: void poll();
body
{
	_time = 0;
	if (processing) {
		return;
	} else {
	}
	processing = 1;
	para this.process();
}
end_body
member
public: void process();
body
{
	processing = null;
}
end_body
member
public: list processing;
member
public: integer _time;
member
public: integer interval;
member
public: string host;
member
public: string userid;
member
public: string password;
member
public: AltairServer ap_server;
member
public: static void timeoutCheck();
body
{
	if (pollers) {
	} else {
		return;
	}
	var list itr;
	var Poller poller;
	itr = al_dst_itr(pollers);
	loop {
		if (poller = al_next(itr)) {
		} else {
			break;
		}
		poller._time = poller._time + 1;
		if (poller._time >= poller.interval) {
			poller.poll();
		} else {
		}
	}
}
end_body
member
public: static void addPoller(Poller poller);
body
{
	if (pollers) {
	} else {
		pollers = al_cons(null, null);
	}
	al_create_arc(pollers, poller, null);
}
end_body
member
public: static void closeAllPollers();
body
{
	if (pollers) {
	} else {
		return;
	}
	var list itr;
	var Poller poller;
	itr = al_dst_itr(pollers);
	loop {
		if (poller = al_next(itr)) {
		} else {
			break;
		}
		al_remove(itr);
	}
	pollers = null;
}
end_body
member
public: static list pollers;
class RNIF20ProxyPoller
member
public: void process();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var RNContext ctx;
		var list my_default_props;
		var string url, pass, proxy_server;
		var integer proxy_port;
		ctx = new RNContext;
		my_default_props = ctx.getMyProperties("-- default setting --", conn);
		if (url = al_dst_node(my_default_props, "proxy.poll.url")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "proxy.poll.url is empty.";
			throw ex;
		}
		if (pass = al_dst_node(my_default_props, "proxy.poll.password")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "proxy.poll.password is empty.";
			throw ex;
		}
		url = url + "?pass=" + pass + "&action=";
		var AlException ex;
		var HttpClientConnection client;
		var list err;
		client = new HttpClientConnection;
		if (err = client.create(url + "list")) {
			ex = new AlException;
			ex.msg = "bad proxy.poll.url: url = " + (string)url + "list, error = " + (string)err;
			throw ex;
		} else {
		}
		client.proxy_server = al_dst_node(my_default_props, "proxy.server");
		client.proxy_port = (integer)al_dst_node(my_default_props, "proxy.port");
		if (err = client.doGet()) {
			ex = new AlException;
			ex.msg = "proxy.poll.url doGet error: url = " + (string)url + "list, error = " + (string)err;
			throw ex;
		} else {
		}
		if (client.response_code != 200) {
			ex = new AlException;
			ex.msg = "proxy.poll.url doGet bad response code: url = " + (string)url + "list, response code = " + (string)client.response_code;
			throw ex;
		} else {
		}
		var string s;
		var file f;
		var string ids;
		if (s = al_misc("binary_to_string", al_list3(client.contents, 0, al_misc("binary_size", client.contents, null)), null)) {
		} else {
			ex = new AlException;
			ex.msg = "proxy.poll.url doGet empty response: url = " + (string)url + "list";
			throw ex;
		}
		f = al_file_open(s, "sr");
		if (ids = al_file_read(f, "graph")) {
		} else {
			ex = new AlException;
			ex.msg = "proxy.poll.url doGet bad response: url = " + (string)url + "list, response = " + (string)s;
			throw ex;
		}
		var list itr, ls;
		var string fromIP, cert_info, async, id;
		itr = al_dst_itr(ids);
		loop {
			if (ls = al_next(itr)) {
			} else {
				break;
			}
			fromIP = ls.head;
			cert_info = ls.tail.head;
			if (cert_info == "null") {
				cert_info = null;
			} else {
			}
			id = ls.tail.tail.head;
			client = new HttpClientConnection;
			if (err = client.create(url + "get&id=" + (string)id)) {
				ex = new AlException;
				ex.msg = "bad proxy.poll.url: url = " + (string)url + "get&id=" + (string)id + ", error = " + (string)err;
				throw ex;
			} else {
			}
			client.proxy_server = al_dst_node(my_default_props, "proxy.server");
			client.proxy_port = (integer)al_dst_node(my_default_props, "proxy.port");
			if (err = client.doGet()) {
				ex = new AlException;
				ex.msg = "proxy.poll.url doGet error: url = " + (string)url + "get&id=" + (string)id + ", error = " + (string)err;
				throw ex;
			} else {
			}
			if (client.response_code != 200) {
				ex = new AlException;
				ex.msg = "proxy.poll.url doGet bad response code: url = " + (string)url + "get&id=" + (string)id + ", response code = " + (string)client.response_code;
				throw ex;
			} else {
			}
			if (client.contents && s = al_misc("binary_to_string", al_list3(client.contents, 0, al_misc("binary_size", client.contents, null)), null)) {
			} else {
				ex = new AlException;
				ex.msg = "proxy.poll.url doGet empty response: url = " + (string)url + "get&id=" + (string)id;
				throw ex;
			}
			if (process(fromIP, cert_info, id, s, conn)) {
				client = new HttpClientConnection;
				if (err = client.create(url + "delete&id=" + (string)id)) {
					ex = new AlException;
					ex.msg = "bad proxy.poll.url: url = " + (string)url + "delete&id=" + (string)id + ", error = " + (string)err;
					throw ex;
				} else {
				}
				client.proxy_server = al_dst_node(my_default_props, "proxy.server");
				client.proxy_port = (integer)al_dst_node(my_default_props, "proxy.port");
				if (err = client.doGet()) {
					ex = new AlException;
					ex.msg = "proxy.poll.url doGet error: url = " + (string)url + "delete&id=" + (string)id + ", error = " + (string)err;
					throw ex;
				} else {
				}
				if (client.response_code != 200) {
					ex = new AlException;
					ex.msg = "proxy.poll.url doGet bad response code: url = " + (string)url + "delete&id=" + (string)id + ", response code = " + (string)client.response_code;
					throw ex;
				} else {
				}
				if (client.contents && s = al_misc("binary_to_string", al_list3(client.contents, 0, al_misc("binary_size", client.contents, null)), null)) {
				} else {
					ex = new AlException;
					ex.msg = "proxy.poll.url doGet empty response: url = " + (string)url + "delete&id=" + (string)id;
					throw ex;
				}
			} else {
			}
		}
		conn.close();
	} catch (AlException e) {
		try {
			if (conn) {
				conn.close();
			} else {
			}
		} catch (AlException e) {
		}
		ap_server.system_log("error", "RNIF20 Proxy Poller error: exception = " + (string)e.msg);
	}
	processing = null;
}
end_body
member
public: list process(string fromIP, string cert_info, string id, string message, DbConnection conn);
body
{
	var string msgId;
	try {
		var list props;
		props = al_cons(null, null);
		var AlException ex;
		var RNContext ctx;
		ctx = new RNContext;
		msgId = Context::genMsgId();
		al_create_arc(props, msgId, "msgId");
		var list my_props;
		my_props = ctx.getMyProperties("-- default setting --", conn);
		var string dir;
		if (dir = al_dst_node(my_props, "msg.tmp.dir")) {
		} else {
			ex = new AlException;
			ex.msg = "property msg.tmp.dir is empty.";
			throw ex;
		}
		al_create_arc(props, dir, "tempDir");
		if (dir = al_dst_node(my_props, "msg.attach.dir")) {
		} else {
			ex = new AlException;
			ex.msg = "property msg.attach.dir is empty.";
			throw ex;
		}
		al_create_arc(props, dir, "attachDir");
		if (dir = al_dst_node(my_props, "msg.recv.dir")) {
		} else {
			ex = new AlException;
			ex.msg = "property msg.recv.dir is empty.";
			throw ex;
		}
		// save to file;
		var string filename;
		filename = dir + "/" + msgId;
		al_create_arc(props, filename, "filename");
		try {
			FileUtility::writeBinary(filename, message);
		} catch (AlException e) {
			ex = new AlException;
			ex.msg = "file write error: file = " + filename + ".";
			throw ex;
		}
		al_set_dst_node(props, "fromIP", fromIP);
		if (cert_info) {
			al_create_arc(props, cert_info, "certInfo");
		} else {
		}
		var list headers;
		var string async;
		if (headers = al_crypt("mime_headers_read", filename, null, null)) {
			headers = headers.head;
			async = al_dst_node_i(headers, "x-RN-Response-Type");
		} else {
			ex = new AlException;
			ex.msg = "mime header read error: file = " + filename + ".";
			throw ex;
		}
		al_set_dst_node(props, "syncType", async);
		al_set_dst_node(props, "useProxy", "true");
		al_set_dst_node(props, "proxyMsgId", id);
		try {
			var ProcMgr pm;
			var string pid;
			pm = new ProcMgr;
			pid = pm.create("RNIF20ReceiveProcess", conn);
			al_set_dst_node(props, "startTime", Context::genTimeStamp());
			pm.putProperties(pid, props, conn);
			pm.start(pid, conn);
			conn.commit();
		} catch (AlException e) {
			e.msg = "receive process start error: " + e.msg;
			throw e;
		}
	} catch (AlException e) {
		try {
			var list props;
			props = al_cons(null, null);
			al_set_dst_node(props, "errorReason", e.msg);
			al_set_dst_node(props, "sendRecv", "recv");
			al_set_dst_node(props, "errorLevel", "fatal");
			al_set_dst_node(props, "fromIP", "mail");
			al_set_dst_node(props, "msgId", msgId);
			var RNIF20ServiceHandler handler;
			handler = new RNIF20ServiceHandler;
			handler.conn = conn;
			handler.invokeWriteLog(props);
			conn.commit();
		} catch (AlException e) {
		}
		return null;
	}
	return 1;
}
end_body
end_class
class RNIF20PopPoller
member
public: void process();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var RNIF20PopClient client;
		client = new RNIF20PopClient;
		client.conn = conn;
		client.create(host);
		client.userid = userid;
		client.password = password;
		client.start();
		if (client.error) {
			var AlException ex;
			ex = new AlException;
			ex.msg = client.error;
			throw ex;
		} else {
		}
		conn.close();
	} catch (AlException e) {
		try {
			if (conn) {
				conn.close();
			} else {
			}
		} catch (AlException e) {
		}
		ap_server.system_log("error", "RNIF20 POP Poller error: exception = " + (string)e.msg);
	}
	processing = null;
}
end_body
end_class
end_class
class MultipartSecureMessage
member
public: void setHeader(string name, string value);
body
{
	_genContentType();
	al_set_dst_node(header, name, value);
}
end_body
member
public: void addHeaderSubType(string name, string subtype, string value);
body
{
	_genContentType();
	var list ls;
	if (ls = al_dst_node_i(header, name)) {
		al_set_dst_node(ls, subtype, value);
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "not found name '" + (string)name + "'";
		throw ex;
	}
}
end_body
member
public: void setBodyHeader(string name, string value);
body
{
	if (body_header) {
	} else {
		body_header = al_cons(null, null);
	}
	al_set_dst_node(body_header, name, value);
}
end_body
member
public: void addBodyHeaderSubType(string name, string subtype, string value);
body
{
	if (body_header) {
	} else {
		body_header = al_cons(null, null);
	}
	var list ls;
	if (ls = al_dst_node_i(body_header, name)) {
		al_set_dst_node(ls, subtype, value);
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "not found name '" + (string)name + "'";
		throw ex;
	}
}
end_body
member
public: void addBodyText(string text);
body
{
	var integer len;
	var list bin;
	len = al_strlen(text);
	bin = al_misc("binary", len, null);
	al_misc("binary_copy", al_list2(bin, 0), text);
	addBodyBinary(bin, 0, len);
}
end_body
member
public: void addBodyFile(string filename);
body
{
	var integer len;
	var list bin;
	var file in;
	if (al_file_manip("does_exist", filename, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file not found '" + (string)filename + "'.";
		throw ex;
	}
	len = al_file_manip("get_size", filename, null);
	bin = al_misc("binary", len, null);
	if (in = al_file_open(filename, "rb")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't open file '" + (string)filename + "'.";
		throw ex;
	}
	if (al_file_read(in, al_list3(bin, 0, len))) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file read error '" + (string)filename + "'.";
		throw ex;
	} else {
	}
	addBodyBinary(bin, 0, len);
}
end_body
member
public: void addBodyBinary(list content_bin, integer from, integer content_len);
body
{
	_genContentType();
	if (multipart) {
	} else {
		multipart = al_cons(header, null);
	}
	var list bin, header_bin;
	var integer header_len;
	if (header_bin = al_crypt("mime_headers_write", body_header, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't generate mime body header.";
		throw ex;
	}
	header_len = al_misc("binary_size", header_bin, null);
	var string encoding;
	encoding = al_dst_node_i(body_header, "Content-Transfer-Encoding");
	if (encoding == "base64") {
		// NG: following codes do not work well, may be due to OpenSSL bug
		// content_bin = al_crypt("base64_encode", content_bin, null, null);
		// use temporary file in order to avoid this bug
		var string tmp_filename;
		try {
			tmp_filename = FileUtility::tempFile();
			if (al_crypt("base64_encode", content_bin, tmp_filename, null)) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "fail to encode mime body header by base64.";
				throw ex;
			}
			content_bin = FileUtility::readBinary(tmp_filename);
			content_len = al_misc("binary_size", content_bin, null);
			al_file_manip("remove", tmp_filename, null);
		} catch (AlException e) {
			if (tmp_filename && al_file_manip("does_exist", tmp_filename, null)) {
				al_file_manip("remove", tmp_filename, null);
			} else {
			}
			throw e;
		}
	} else {
	}
	bin = al_misc("binary", header_len + content_len, null);
	al_misc("binary_copy", al_list2(bin, 0), al_list3(header_bin, 0, header_len));
	al_misc("binary_copy", al_list2(bin, header_len), al_list3(content_bin, 0, content_len));
	var list itr;
	itr = al_dst_itr(multipart);
	al_create_arc(multipart, bin, al_count(itr));
	body_header = null;
}
end_body
member
public: void addMultipartSecureMessage(MultipartSecureMessage msm);
body
{
	if (multipart && msm && msm.multipart) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "not multipart object.";
		throw ex;
	}
	var list itr, body;
	var integer count;
	itr = al_dst_itr(multipart);
	count = al_count(itr);
	itr = al_dst_itr(msm.multipart);
	loop {
		if (body = al_next(itr)) {
		} else {
			break;
		}
		al_create_arc(multipart, body, count);
		count = count + 1;
	}
}
end_body
member
public: string _genContentType();
body
{
	if (header) {
	} else {
		header = al_cons(null, null);
	}
	var list ls;
	if (ls = al_dst_node_i(header, "Content-Type")) {
	} else {
		al_set_dst_node(header, "Content-Type", ls = al_copy("multipart/related"));
	}
	var string boundary;
	if (boundary = al_dst_node(ls, "boundary")) {
	} else {
		boundary = al_crypt("random", 64, null, null);
		al_create_arc(ls, boundary, "boundary");
	}
	return boundary;
}
end_body
member
public: void writeHeader(file out);
body
{
	var list header_bin;
	var integer header_len;
	if (header_bin = al_crypt("mime_headers_write", header, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't generate mime message header.";
		throw ex;
	}
	header_len = al_misc("binary_size", header_bin, null);
	if (al_file_write(out, al_list3(header_bin, 0, header_len), null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "write error: (mime message header).";
		throw ex;
	} else {
	}
}
end_body
member
public: void writeMultipart(file out);
body
{
	var list content_bin;
	var integer content_len;
	if (content_bin = al_crypt("mime_multipart_write", multipart, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't generate mime multipart.";
		throw ex;
	}
	content_len = al_misc("binary_size", content_bin, null);
	var string encoding;
	if (encoding = al_dst_node_i(header, "Content-Transfer-Encoding")) {
	} else {
		encoding = al_dst_node_i(header, "Transfer-Encoding");
	}
	if (encoding == "base64") {
		// NG: following codes do not work well, may be due to OpenSSL bug
		// content_bin = al_crypt("base64_encode", content_bin, null, null);
		// use temporary file in order to avoid this bug
		var string tmp_filename, tmp_str;
		try {
			tmp_filename = FileUtility::tempFile();
			if (al_crypt("base64_encode", content_bin, tmp_filename, null)) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "fail to encode mime body header by base64.";
				throw ex;
			}
			content_bin = FileUtility::readBinary(tmp_filename);
			content_len = al_misc("binary_size", content_bin, null);
			al_file_manip("remove", tmp_filename, null);
		} catch (AlException e) {
			if (tmp_filename && al_file_manip("does_exist", tmp_filename, null)) {
				al_file_manip("remove", tmp_filename, null);
			} else {
			}
			throw e;
		}
	} else {
	}
	if (al_file_write(out, al_list3(content_bin, 0, content_len), null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "write error: (mime multipart).";
		throw ex;
	} else {
	}
}
end_body
member
public: void writeMultipartMessage(file out);
body
{
	writeHeader(out);
	writeMultipart(out);
}
end_body
member
public: list header;
member
public: list body_header;
member
public: list body_header_bin;
member
public: integer body_index;
member
public: list body_content;
member
public: void readMultipartMessage(string filename);
body
{
	var list bin;
	var integer len;
	bin = FileUtility::readBinary(filename);
	len = al_misc("binary_size", bin, null);
	readMultipartMessage(bin, len);
}
end_body
member
public: void readMultipartMessage(list bin, integer size);
body
{
	var list result;
	var integer i;
	if (result = al_crypt("mime_headers_read", al_list3(bin, 0, size), null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't read mime message header.";
		throw ex;
	}
	header = result.head;
	i = result.tail.head;
	var string encoding;
	if (encoding = al_dst_node_i(header, "Content-Transfer-Encoding")) {
	} else {
		encoding = al_dst_node_i(header, "Transfer-Encoding");
	}
	if (encoding == "base64") {
		var list buf;
		buf = al_misc("binary", size - i, null);
		al_misc("binary_copy", al_list2(buf, 0), al_list3(bin, i, size - i));
		bin = null;
		if (buf = al_crypt("base64_decode", buf, null, null)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "fail to decode mime message by base64.";
			throw ex;
		}
		multipart = al_crypt("mime_multipart_read", buf, header, null);
		buf = null;
	} else {
		multipart = al_crypt("mime_multipart_read", al_list3(bin, i, size - i), header, null);
		bin = null;
	}
	if (multipart) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't read mime multipart.";
		throw ex;
	}
	body_header = body_content = body_index = null;
}
end_body
member
public: void readMultipartMessage2(list bin, integer size);
body
{
	var list result;
	var integer i;
	if (result = al_crypt("mime_headers_read", al_list3(bin, 0, size), null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't read mime message header.";
		throw ex;
	}
	header = result.head;
	i = result.tail.head;
	multipart = al_crypt("mime_multipart_read", al_list3(bin, i, size - i), header, null);
	bin = null;
	if (multipart) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't read mime multipart.";
		throw ex;
	}
	body_header = body_content = body_index = null;
}
end_body
member
public: string getHeader(string name);
body
{
	if (header) {
	} else {
		return null;
	}
	return al_dst_node_i(header, name);
}
end_body
member
public: string getHeaderSubType(string name, string subtype);
body
{
	if (header) {
	} else {
		return null;
	}
	var list ls;
	if (ls = al_dst_node_i(header, name)) {
	} else {
		return null;
	}
	return al_dst_node_i(ls, subtype);
}
end_body
member
public: integer getCount();
body
{
	if (multipart) {
	} else {
		return 0;
	}
	var list itr;
	itr = al_dst_itr(multipart);
	return al_count(itr);
}
end_body
member
public: string getBodyHeader(integer index, string name);
body
{
	getBody(index);
	if (body_header) {
	} else {
		return null;
	}
	return al_dst_node_i(body_header, name);
}
end_body
member
public: string getBodyHeaderSubType(integer index, string name, string subtype);
body
{
	getBody(index);
	if (body_header) {
	} else {
		return null;
	}
	var list ls;
	if (ls = al_dst_node_i(body_header, name)) {
	} else {
		return null;
	}
	return al_dst_node_i(ls, subtype);
}
end_body
member
public: string getBodyText(integer index);
body
{
	getBody(index);
	var integer len;
	len = al_misc("binary_size", body_content, null);
	return al_misc("binary_to_string", al_list3(body_content, 0, len), null);
}
end_body
member
public: list getBodyBinary(integer index);
body
{
	getBody(index);
	return body_content;
}
end_body
member
public: void getBody(integer index);
body
{
	var list bin;
	var integer size;
	if (index == body_index) {
		return;
	} else {
	}
	if (multipart) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "multipart is null.";
		throw ex;
	}
	if (bin = al_dst_node(multipart, index)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "body index is out of range: index = " + (string)index + ".";
		throw ex;
	}
	size = al_misc("binary_size", bin, null);
	var list result;
	var integer i;
	if (result = al_crypt("mime_headers_read", al_list3(bin, 0, size), null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't read mime body header: index = " + (string)index + ".";
		throw ex;
	}
	body_header = result.head;
	i = result.tail.head;
	body_header_bin = al_misc("binary", i, null);
	al_misc("binary_copy", al_list2(body_header_bin, 0), al_list3(bin, 0, i));
	body_content = al_misc("binary", size - i, null);
	al_misc("binary_copy", al_list2(body_content, 0), al_list3(bin, i, size - i));
	var string encoding;
	encoding = al_dst_node_i(body_header, "Content-Transfer-Encoding");
	if (encoding == "base64") {
		if (body_content = al_crypt("base64_decode", body_content, null, null)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "fail to decode mime body header by base64.";
			throw ex;
		}
	} else {
	}
	body_index = index;
}
end_body
member
public: list multipart;
member
public: void encrypt(string cipher, string cert);
body
{
	if (cipher) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MultipartSecureMessage.encrypt: encryption algorithm is null.";
		throw ex;
	}
	if (cert) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MultipartSecureMessage.encrypt: partner cert is null.";
		throw ex;
	}
	var list files, bin, out_bin;
	files = al_list4(cipher, cert, null, null);
	var list header_bin, content_bin;
	var integer header_len, content_len, out_bin_len;
	if (header_bin = al_crypt("mime_headers_write", header, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't generate mime message header.";
		throw ex;
	}
	header_len = al_misc("binary_size", header_bin, null);
	if (content_bin = al_crypt("mime_multipart_write", multipart, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't generate mime multipart.";
		throw ex;
	}
	content_len = al_misc("binary_size", content_bin, null);
	bin = al_misc("binary", header_len + content_len, null);
	al_misc("binary_copy", al_list2(bin, 0), al_list3(header_bin, 0, header_len));
	al_misc("binary_copy", al_list2(bin, header_len), al_list3(content_bin, 0, content_len));
	if (out_bin = al_crypt("smime_encrypt", bin, null, files)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "fail to_encrypt.";
		throw ex;
	}
	out_bin_len = al_misc("binary_size", out_bin, null);
	var list result;
	result = al_crypt("mime_headers_read", al_list3(out_bin, 0, out_bin_len), null, null);
	body_header = result.head;
	al_set_dst_node(body_header, "MIME-Version", null);
	header = multipart = null;
	addBodyBinary(out_bin, (integer)result.tail.head, (integer)(out_bin_len - result.tail.head));
}
end_body
member
public: void sign(string cert, string key);
body
{
	if (cert) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MultipartSecureMessage.sign: my cert is null.";
		throw ex;
	}
	if (key) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MultipartSecureMessage.sign: my key is null.";
		throw ex;
	}
	var list files, out_bin;
	var integer out_bin_len;
	files = al_list4(null, cert, key, null);
	// NG: following codes do not work well, may be due to OpenSSL bug
	// if (out_bin = al_crypt("smime_sign", bin, null, files)) {
	// use temporary file in order to avoid this bug
	var string tmp1, tmp2;
	try {
		tmp1 = FileUtility::tempFile();
		tmp2 = FileUtility::tempFile();
		var file f;
		if (f = al_file_open(tmp1, "wb")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open temp file.";
			throw ex;
		}
		writeMultipartMessage(f);
		f = null;
		if (al_crypt("smime_sign", tmp1, tmp2, files)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "fail to sign.";
			throw ex;
		}
		out_bin = FileUtility::readBinary(tmp2);
		out_bin_len = al_misc("binary_size", out_bin, null);
		al_file_manip("remove", tmp1, null);
		al_file_manip("remove", tmp2, null);
	} catch (AlException e) {
		if (tmp1 && al_file_manip("does_exist", tmp1, null)) {
			al_file_manip("remove", tmp1, null);
		} else {
		}
		if (tmp2 && al_file_manip("does_exist", tmp2, null)) {
			al_file_manip("remove", tmp2, null);
		} else {
		}
		throw e;
	}
	var list result;
	result = al_crypt("mime_headers_read", al_list3(out_bin, 0, out_bin_len), null, null);
	header = result.head;
	al_set_dst_node(header, "MIME-Version", null);
	multipart = al_crypt("mime_multipart_read", al_list3(out_bin, (integer)result.tail.head, (integer)(out_bin_len - result.tail.head)), header, null);
}
end_body
member
public: list isEncrypted(integer index);
body
{
	var string content_type;
	content_type = getBodyHeader(index, "Content-Type");
	if (al_str_misc("strcmpi", content_type, "application/x-pkcs7-mime") == 0) {
		return 1;
	} else {
	}
	if (al_str_misc("strcmpi", content_type, "application/pkcs7-mime") == 0) {
		return 1;
	} else {
	}
	return null;
}
end_body
member
public: void decrypt(integer index, string cert, string key);
body
{
	if (cert) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MultipartSecureMessage.decrypt: my cert is null.";
		throw ex;
	}
	if (key) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MultipartSecureMessage.decrypt: my key is null.";
		throw ex;
	}
	var list files, bin, out_bin;
	var integer out_bin_size;
	files = al_list4(null, cert, key, null);
	bin = getBodyBinary(index);
	if (out_bin = al_crypt("smime_decrypt", bin, null, files)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "fail to_decrypt.";
		throw ex;
	}
	out_bin_size = al_misc("binary_size", out_bin, null);
	readMultipartMessage(out_bin, out_bin_size);
}
end_body
member
public: list isSigned();
body
{
	var string content_type;
	content_type = getHeader("Content-Type");
	if (al_str_misc("strcmpi", content_type, "multipart/signed") == 0) {
		return 1;
	} else {
	}
	return null;
}
end_body
member
public: list verify(string cert, string ca_cert);
body
{
	if (cert) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MultipartSecureMessage.verify: partner cert is null.";
		throw ex;
	}
	if (ca_cert) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MultipartSecureMessage.verify: CA cert is null.";
		throw ex;
	}
	var list files, bin;
	files = al_list4(null, cert, null, ca_cert);
	var list header_bin, content_bin;
	var integer header_len, content_len;
	if (header_bin = al_crypt("mime_headers_write", header, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't generate mime message header.";
		throw ex;
	}
	header_len = al_misc("binary_size", header_bin, null);
	if (content_bin = al_crypt("mime_multipart_write", multipart, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't generate mime multipart.";
		throw ex;
	}
	content_len = al_misc("binary_size", content_bin, null);
	bin = al_misc("binary", header_len + content_len, null);
	al_misc("binary_copy", al_list2(bin, 0), al_list3(header_bin, 0, header_len));
	al_misc("binary_copy", al_list2(bin, header_len), al_list3(content_bin, 0, content_len));
	var list digest;
	if (digest = al_crypt("smime_verify", bin, null, files)) {
		// verify OK
		return digest;
	} else {
		// verify NG
		return null;
	}
}
end_body
member
public: void multipartToOneBody();
body
{
	var list content_bin;
	var integer content_len;
	if (content_bin = al_crypt("mime_multipart_write", multipart, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't generate mime multipart.";
		throw ex;
	}
	content_len = al_misc("binary_size", content_bin, null);
	body_header = header;
	header = multipart = null;
	addBodyBinary(content_bin, 0, content_len);
}
end_body
member
public: void oneBodyToMultipart(integer index);
body
{
	var list header_bin, content_bin, bin;
	var integer header_len, content_len;
	content_bin = getBodyBinary(index);
	header_bin = body_header_bin;
	content_len = al_misc("binary_size", content_bin, null);
	header_len = al_misc("binary_size", header_bin, null);
	bin = al_misc("binary", header_len + content_len, null);
	al_misc("binary_copy", al_list2(bin, 0), al_list3(header_bin, 0, header_len));
	al_misc("binary_copy", al_list2(bin, header_len), al_list3(content_bin, 0, content_len));
	readMultipartMessage2(bin, header_len + content_len);
}
end_body
member
public: static void getBody(string in_file, string name, string out_file);
body
{
	var file in, out;
	var list buffer, block, hdr, last_block, current_block, work_block;
	var integer buffer_size, read_bytes, read_index, tail_size;
	var integer size1, size2, idx, size;
	var string content_type, boundary;
	var string content_disposition, name2;
	if (al_file_manip("does_exist", in_file, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "not found: filename = " + (string)in_file;
		throw ex;
	}
	if (in = al_file_open(in_file, "rb")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't open: filename = " + (string)in_file;
		throw ex;
	}
	buffer_size = 4096;
	buffer = al_misc("binary", buffer_size, null);
	block = al_list3(buffer, 0, buffer_size);
	if (read_bytes = al_file_read(in, block)) {
		if (read_bytes < 0) {
			var AlException ex;
			ex = new AlException;
			ex.msg = "read error: filename = " + (string)in_file;
			throw ex;
		} else {
		}
	} else {
		read_bytes = buffer_size;
	}
	if (hdr = al_crypt("mime_headers_read", al_list3(buffer, 0, buffer_size), null, null)) {
		read_index = hdr.tail.head;
		hdr = hdr.head;
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "mime header read error.";
		throw ex;
	}
	if (content_type = al_dst_node_i(hdr, "Content-Type")) {
		boundary = al_dst_node_i(content_type, "boundary");
	} else {
	}
	if (boundary) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "boundary of multipart not found.";
		throw ex;
	}
	boundary = "--" + boundary;
	current_block = al_misc("binary", read_bytes, null);
	al_misc("binary_copy", al_list2(current_block, 0), al_list3(buffer, 0, read_bytes));
	loop {
		last_block = current_block;
		if (read_bytes = al_file_read(in, block)) {
			if (read_bytes < 0) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "read error: filename = " + (string)in_file;
				throw ex;
			} else {
			}
		} else {
			read_bytes = buffer_size;
		}
		if (read_bytes >= 0) {
			current_block = al_misc("binary", read_bytes, null);
			al_misc("binary_copy", al_list2(current_block, 0), al_list3(buffer, 0, read_bytes));
		} else {
			if (out == null) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "expected mime body not found.";
				throw ex;
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "mime body not terminated.";
				throw ex;
			}
		}
		size1 = al_misc("binary_size", last_block, null);
		size2 = read_bytes;
		work_block = al_misc("binary", size1 + size2, null);
		al_misc("binary_copy", al_list2(work_block, 0), al_list3(last_block, 0, size1));
		al_misc("binary_copy", al_list2(work_block, size1), al_list3(current_block, 0, size2));
		idx = al_misc("binary_search_str", al_list2(work_block, read_index), boundary);
		if (out == null) {
			if (idx >= 0 && idx < size1) {
				read_index = idx + al_strlen(boundary);
				if (al_misc("get_byte", al_list2(work_block, read_index), null) == '\r') {
					read_index = read_index + 1;
				} else {
				}
				if (al_misc("get_byte", al_list2(work_block, read_index), null) == '\n') {
					read_index = read_index + 1;
				} else {
				}
				if (hdr = al_crypt("mime_headers_read", al_list3(work_block, read_index, size1 + size2 - read_index), null, null)) {
					size = hdr.tail.head;
					hdr = hdr.head;
				} else {
					var AlException ex;
					ex = new AlException;
					ex.msg = "mime body header read error.";
					throw ex;
				}
				if (content_disposition = al_dst_node_i(hdr, "Content-Disposition")) {
					name2 = al_dst_node_i(content_disposition, "name");
				} else {
				}
				if (name2) {
				} else {
					var AlException ex;
					ex = new AlException;
					ex.msg = "content-disposition name not found.";
					throw ex;
				}
				read_index = read_index + size;
				if (name2 != name) {
					continue;
				} else {
				}
				if (out = al_file_open(out_file, "wb")) {
				} else {
					var AlException ex;
					ex = new AlException;
					ex.msg = "can't open: filename = " + (string)out_file;
					throw ex;
				}
				idx = al_misc("binary_search_str", al_list2(work_block, read_index), boundary);
				if (idx >= 0) {
					if (al_misc("get_byte", al_list2(work_block, idx - 1), null) == '\n') {
						idx = idx - 1;
					} else {
					}
					if (al_misc("get_byte", al_list2(work_block, idx - 1), null) == '\r') {
						idx = idx - 1;
					} else {
					}
					tail_size = idx - read_index;
				} else {
					tail_size = size1 - read_index;
				}
				if (tail_size > 0 && al_file_write(out, al_list3(work_block, read_index, tail_size), null)) {
					var AlException ex;
					ex = new AlException;
					ex.msg = "write error: filename = " + (string)out_file;
					throw ex;
				} else {
				}
				if (idx >= 0) {
					out = null;
					break;
				} else {
					read_index = 0;
				}
			} else {
			}
		} else {
			if (idx >= 0) {
				if (al_misc("get_byte", al_list2(work_block, idx - 1), null) == '\n') {
					idx = idx - 1;
				} else {
				}
				if (al_misc("get_byte", al_list2(work_block, idx - 1), null) == '\r') {
					idx = idx - 1;
				} else {
				}
				tail_size = idx;
			} else {
				tail_size = size1;
			}
			if (tail_size > 0 && al_file_write(out, al_list3(work_block, read_index, tail_size), null)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "write error: filename = " + (string)out_file;
				throw ex;
			} else {
			}
			if (idx >= 0) {
				out = null;
				break;
			} else {
			}
		}
	}
}
end_body
end_class
class XmlUtility
member
public: static void Initialize();
body
{
	if (init) {
		return;
	} else {
	}
	var list bin;
	bin = al_misc("binary", 1, null);
	al_misc("put_byte", al_list2(bin, 0), 0x0000000000000001);
	ctrl_a = al_misc("binary_to_string", al_list3(bin, 0, 1), null);
	dtd_base = ".";
	content_validation_base = ".";
	XmlDbObject::MAX_VALUE_SIZE = 3000;
	init = 1;
}
end_body
member
public: static list init;
member
public: static string ctrl_a;
member
public: static list parseXML(string xml, list debug);
body
{
	var file in;
	in = al_file_open(xml, "sr");
	return parseXML(in, debug);
}
end_body
member
public: static list parseXML(file in, list debug);
body
{
	var list tree_error, opt, err;
	opt = (debug ? 1 : null);
	tree_error = al_xml("parse", in, null, opt);
	if (err = tree_error.tail.head) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "xml: parse error: " + (string)err;
		throw ex;
	} else {
	}
	return tree_error.head;
}
end_body
member
public: static list parseXML(string filename);
body
{
	var file in;
	if (in = al_file_open(filename, "r")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "xml: can't open file '" + (string)filename + "'";
		throw ex;
	}
	return parseXML(in, null);
}
end_body
member
public: static string xslTransform(string xsl_filename, list xml);
body
{
	var list xsl, str, err;
	var file f;
	xsl = loadXSL(xsl_filename);
	str = al_copy("");
	f = al_file_open(str, "sw");
	err = al_xml("xslt", xsl, xml, f);
	if (err) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "xsl transform error: reason=" + al_str_misc("xml_encode", (string)err, 0x0000000000000001);
		throw ex;
	} else {
	}
	var integer idx;
	idx = al_search_str(str, 0, "\n");
	str = al_tail_str(str, idx + 1);
	return str;
}
end_body
member
public: static string getDocType(list parse_tree);
body
{
	var list tree_itr;
	var string text, attr, str;
	var file f;
	tree_itr = al_dst_itr(parse_tree);
	loop {
		if (text = al_next(tree_itr)) {
		} else {
			return null;
		}
		attr = al_arc_a(tree_itr);
		if (attr != "!comment") {
			return null;
		} else {
		}
		f = al_file_open(text, "sr");
		if (al_file_match_str(f, "!DOCTYPE")) {
		} else {
			continue;
		}
		return al_file_read(f, "string");
	}
}
end_body
member
public: static string getDTDfile(list parse_tree);
body
{
	var list tree_itr;
	var string text, attr, str;
	var file f;
	tree_itr = al_dst_itr(parse_tree);
	loop {
		if (text = al_next(tree_itr)) {
		} else {
			return null;
		}
		attr = al_arc_a(tree_itr);
		if (attr != "!comment") {
			return null;
		} else {
		}
		f = al_file_open(text, "sr");
		if (al_file_match_str(f, "!DOCTYPE")) {
		} else {
			continue;
		}
		loop {
			if (str = al_file_read(f, "string")) {
			} else {
				return null;
			}
			if (str == "SYSTEM") {
				return al_file_read(f, "quote_string");
			} else {
			}
		}
	}
}
end_body
member
public: static list loadDTD(string filename);
body
{
	if (dtd_cache) {
	} else {
		dtd_cache = al_cons(null, null);
	}
	var list ret;
	if (ret = al_dst_node(dtd_cache, filename)) {
		return ret;
	} else {
	}
	var DtdLoader loader;
	var file in, out;
	var list err;
	var string tmp_file;
	loader = new ExtendedDtdLoader;
	loader.log_level = 20;
	loop {
		if (in = al_file_open(filename, "r")) {
		} else {
			err = "can't open DTD file \"" + filename + "\"";
			break;
		}
		if (err = loader.read_entities(in)) {
			break;
		} else {
		}
		if (tmp_file = FileUtility::tempFile()) {
		} else {
			err = "can't get temp file name";
			break;
		}
		if (in = al_file_open(filename, "r")) {
		} else {
			err = "can't open DTD file \"" + filename + "\"";
			break;
		}
		if (out = al_file_open(tmp_file, "w")) {
		} else {
			err = "can't open temp file \"" + tmp_file + "\"";
			break;
		}
		if (err = loader.apply_entities(in, out)) {
			break;
		} else {
		}
		in = out = null;
		if (in = al_file_open(tmp_file, "r")) {
		} else {
			err = "can't open temp file \"" + tmp_file + "\"";
			break;
		}
		if (err = loader.read_element(in)) {
			break;
		} else {
		}
		in = null;
		if (in = al_file_open(tmp_file, "r")) {
		} else {
			err = "can't open temp file \"" + tmp_file + "\"";
			break;
		}
		if (err = loader.elem_attr(in)) {
			break;
		} else {
		}
		in = null;
		break;
	}
	in = out = null;
	if (tmp_file) {
		al_file_manip("remove", tmp_file, null);
	} else {
	}
	if (err) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "xml: " + (string)err;
		throw ex;
	} else {
	}
	ret = loader.root_elem;
	al_set_dst_node(dtd_cache, filename, ret);
	return ret;
}
end_body
member
public: static list loadXmlSchema(string filename);
body
{
	if (dtd_cache) {
	} else {
		dtd_cache = al_cons(null, null);
	}
	var list ret;
	if (ret = al_dst_node(dtd_cache, filename)) {
		return ret;
	} else {
	}
	var XmlSchemaLoader loader;
}
end_body
member
public: static list loadXSL(string filename);
body
{
	if (xsl_cache) {
	} else {
		xsl_cache = al_cons(null, null);
	}
	var list ret;
	if (ret = al_dst_node(xsl_cache, filename)) {
		return ret;
	} else {
	}
	ret = parseXML(filename);
	al_set_dst_node(xsl_cache, filename, ret);
	return ret;
}
end_body
member
public: static void validateXML(list dtd, list parse_tree);
body
{
	var XmlValidator validator;
	var list err;
	validator = new XmlValidator;
	if (err = validator.validate(dtd, parse_tree)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "xml: validation error: " + (string)err;
		throw ex;
	} else {
	}
}
end_body
member
public: static string dtd_base;
member
public: static string xsl_base;
member
public: static string content_validation_base;
member
public: static list dtd_cache;
member
public: static list xsl_cache;
member
public: static XmlDbObject createMsgData(string msgId, string msgType, string msgVersion, string dtdFilename, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	acc = new XmlDbAccessor;
	acc.create(msgType, msgVersion, conn);
	acc.setDTDfilename(dtdFilename);
	if (msgId) {
	} else {
		msgId = Context::genMsgId();
	}
	obj = acc.create(msgId);
	return obj;
}
end_body
member
public: static XmlDbObject getMsgData(string msgId, string msgType, string msgVersion, string dtdFilename, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	acc = new XmlDbAccessor;
	acc.create(msgType, msgVersion, conn);
	acc.setDTDfilename(dtdFilename);
	obj = acc.get(msgId);
	return obj;
}
end_body
member
public: list isLike(string value);
body
{
	var integer len, ch1, ch2;
	len = al_strlen(value);
	if (len > 2) {
	} else {
		return null;
	}
	ch1 = al_get_char(value, 0);
	ch2 = al_get_char(value, len - 1);
	if (ch1 == '%' && ch2 == '%') {
		return al_substr(value, 1, len - 1);
	} else {
		return null;
	}
}
end_body
member
public: void skip_optional();
body
{
	var integer count;
	var string type;
	count = 1;
	loop {
		type = dtd_itr.Next((list)1);
		if (type == "end") {
			printStackTrace();
			al_print("%%% end appears during finding end_optional.\n");
			break;
		} else {
		}
		if (type == "optional") {
			count = count + 1;
		} else {
		}
		if (type == "end_optional") {
			count = count - 1;
			if (count == 0) {
				break;
			} else {
			}
		} else {
		}
	}
}
end_body
member
public: void skip_choice();
body
{
	var integer count;
	var string type;
	count = 1;
	loop {
		type = dtd_itr.Next((list)1);
		if (type == "end") {
			al_print("%%% end appears during finding end_choice.\n");
			break;
		} else {
		}
		if (type == "choice") {
			count = count + 1;
			continue;
		} else {
		}
		if (type == "end_choice") {
			count = count - 1;
			if (count == 0) {
				break;
			} else {
			}
		} else {
		}
	}
}
end_body
member
public: void skip_case();
body
{
	var integer count;
	var string type;
	count = 1;
	loop {
		type = dtd_itr.Next((list)1);
		if (type == "end") {
			al_print("%%% end appears during finding end_case.\n");
			break;
		} else {
		}
		if (type == "choice") {
			skip_choice();
		} else {
		}
		if (type == "case") {
			count = count + 1;
			continue;
		} else {
		}
		if (type == "end_case") {
			count = count - 1;
			if (count == 0) {
				break;
			} else {
			}
		} else {
		}
	}
}
end_body
member
public: void skip_all_opt();
body
{
	var integer count;
	var string type;
	count = 1;
	loop {
		type = dtd_itr.Next((list)1);
		if (type == "end") {
			al_print("%%% end appears during finding end_all_opt.\n");
			break;
		} else {
		}
		if (type == "all_opt") {
			count = count + 1;
		} else {
		}
		if (type == "end_all_opt") {
			count = count - 1;
			if (count == 0) {
				break;
			} else {
			}
		} else {
		}
	}
}
end_body
member
public: DtdItr dtd_itr;
member
public: list content_validate;
member
public: string validation_errors;
member
public: static list content_validation_report;
class XmlSchemaLoader
end_class
class DtdLoader
member
public: list read_entities(file in);
body
{
	entities = al_cons(null, null);
	var string str, name, value, name2, value2;
	var integer ch;
	loop {
		if (al_file_match_str(in, "<")) {
		} else {
			if (str = al_file_read(in, "xident")) {
				error_log("unexpected string '" + str + "'");
				return "unexpected string '" + str + "'";
			} else {
			}
			return null;
		}
		al_file_manip("unput", in, 1);
		if (al_file_match_str(in, "<!ENTITY")) {
			if (al_file_match_str(in, "%")) {
			} else {
				warning_log("not found '%' after \"<!ENTITY\".");
				if (al_file_read(in, al_list2("find", '>'))) {
				} else {
					error_log("unexpected EOF (1)");
					return "unexpected EOF (1)";
				}
				continue;
			}
			if (name = al_file_read(in, "string")) {
			} else {
				error_log("entity_name expected.");
				return "entity_name expected.";
			}
			info_log("entity: " + name);
			if (value = al_file_read(in, "quote_string") || value = al_file_read(in, "single_quote_string")) {
				var file in2;
				var string value_ref;
				value_ref = value;
				in2 = al_file_open(value, "sr");
				value = al_copy("");
				loop {
					ch = al_file_read(in2, "char");
					if (ch ==  - 1) {
						break;
					} else {
					}
					if (ch != '%') {
						al_append_str(value, ch);
					} else {
						if (name2 = al_file_read(in2, "xident")) {
						} else {
							error_log("sub-entity_name expected.");
							return "sub-entity_name expected.";
						}
						info_log("sub-entity: " + name2);
						if (al_file_match_str(in2, ";")) {
						} else {
							error_log("';' expected after'" + name2 + "'.");
							return "';' expected after'" + name2 + "'.";
						}
						if (value2 = al_dst_node(entities, name2)) {
						} else {
							error_log("entity " + name2 + "not found.(in entity " + name + ")");
							return "entity " + name2 + "not found.(in entity " + name + ")";
						}
						al_append_str(value, value2);
					}
				}
			} else {
				error_log("entity_value expected. (entity " + name + ")");
				return "entity_value expected. (entity " + name + ")";
			}
			al_create_arc(entities, value, name);
			info_log("value: " + value);
			if (al_file_match_str(in, ">")) {
			} else {
				error_log("'>' expected.");
				return "'>' expected.";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!--")) {
			if (al_file_read(in, al_list2("find", "-->"))) {
			} else {
				error_log("unexpected EOF (2)");
				return "unexpected EOF (2)";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<?")) {
			if (al_file_read(in, al_list2("find", "?>"))) {
			} else {
				error_log("unexpected EOF (3)");
				return "unexpected EOF (3)";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!")) {
			if (al_file_read(in, al_list2("find", ">"))) {
			} else {
				error_log("unexpected EOF (4)");
				return "unexpected EOF (4)";
			}
			continue;
		} else {
		}
	}
}
end_body
member
public: list apply_entities(file in, file out);
body
{
	var string str, name, value;
	var integer pos, ch;
	loop {
		if (al_file_match_str(in, "<")) {
		} else {
			if (str = al_file_read(in, "string")) {
				error_log("unexpected string '" + str + "'");
				return "unexpected string '" + str + "'";
			} else {
			}
			return null;
		}
		al_file_manip("unput", in, 1);
		if (al_file_match_str(in, "<!ENTITY")) {
			if (al_file_read(in, al_list2("find", '>'))) {
			} else {
				error_log("unexpected EOF (5)");
				return "unexpected EOF (5)";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!--")) {
			if (al_file_read(in, al_list2("find", "-->"))) {
			} else {
				error_log("unexpected EOF (6)");
				return "unexpected EOF (6)";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!NOTATION")) {
			if (al_file_read(in, al_list2("find", ">"))) {
			} else {
				error_log("unexpected EOF (7)");
				return "unexpected EOF (7)";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!")) {
			str = al_copy("<!");
			loop {
				pos = al_file_manip("curr_pos", in, null);
				if (al_file_match_str(in, ">")) {
					al_append_str(str, ">\n");
					al_file_write(out, "string", str);
					break;
				} else {
				}
				al_file_manip("back", in, pos);
				ch = al_file_read(in, "char");
				if (ch != '%') {
					al_append_str(str, ch);
				} else {
					if (name = al_file_read(in, "xident")) {
					} else {
						error_log("not found entity name");
						return "not found entity name";
					}
					if (value = al_dst_node(entities, name)) {
					} else {
						error_log("not found entity '" + name + "'");
						return "not found entity '" + name + "'";
					}
					if (al_file_match_str(in, ";")) {
					} else {
						error_log("';' expected after'" + name + "'.");
						return "';' expected after'" + name + "'.";
					}
					al_append_str(str, value);
					al_append_str(str, ' ');
				}
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<?")) {
			if (al_file_read(in, al_list2("find", "?>"))) {
			} else {
				error_log("unexpected EOF (8)");
				return "unexpected EOF (8)";
			}
			continue;
		} else {
		}
	}
}
end_body
member
public: list entities;
member
public: list read_element(file in);
body
{
	var string tag, str;
	var list elem;
	elems = al_cons(null, null);
	loop {
		if (al_file_match_str(in, "<!ELEMENT")) {
			if (tag = al_file_read(in, "xident")) {
			} else {
				error_log("element tag name expected.");
				return "element tag name expected.";
			}
			info_log("element tag: " + tag);
			if (elem = al_dst_node(elems, tag)) {
			} else {
				elem = al_list5("elem", null, tag, "", null);
				al_create_arc(elems, elem, tag);
			}
			if (al_file_read(in, al_list2("find", ">"))) {
			} else {
				error_log("unexpected EOF (9)");
				return "unexpected EOF (9)";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!ATTLIST")) {
			if (al_file_read(in, al_list2("find", ">"))) {
			} else {
				error_log("unexpected EOF (10)");
				return "unexpected EOF (10)";
			}
			continue;
		} else {
		}
		if (str = al_file_read(in, "string")) {
			error_log("unexpected token'" + str + "'");
			return "unexpected token'" + str + "'";
		} else {
		}
		return null;
	}
}
end_body
member
public: list elems;
member
public: list root_elem;
member
public: list elem_attr(file in);
body
{
	var string tag, str;
	var list elem, elem2, itr, tags, all_opt;
	loop {
		if (al_file_match_str(in, "<!ELEMENT")) {
			if (tag = al_file_read(in, "xident")) {
			} else {
				error_log("element tag name expected.");
				return "element tag name expected.";
			}
			info_log("element tag: " + tag);
			if (elem = al_dst_node(elems, tag)) {
			} else {
				error_log("element tag '" + tag + "' not found.");
				return "element tag '" + tag + "' not found.";
			}
			if (elem2 = load_elem(in)) {
				al_create_arc(elem, elem2, null);
			} else {
				error_log("element definition of tag name '" + tag + "' is illegal.");
				return "element definition of tag name '" + tag + "' is illegal.";
			}
			if (al_file_match_str(in, ">")) {
			} else {
				error_log("'>' expected at !ELEMENT (tag = " + tag + ").");
				return "'>' expected at !ELEMENT (tag = " + tag + ").";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!ATTLIST")) {
			if (tag = al_file_read(in, "xident")) {
			} else {
				error_log("attlist tag name expected.");
				return "attlist tag name expected.";
			}
			info_log("attlist tag: " + tag);
			if (elem = al_dst_node(elems, tag)) {
			} else {
				error_log("attlist tag '" + tag + "' not found.");
				return "attlist tag '" + tag + "' not found.";
			}
			if (add_attr(elem, in)) {
				error_log("attr definition of tag name '" + tag + "' is illegal.");
				return "attr definition of tag name '" + tag + "' is illegal.";
			} else {
			}
			if (al_file_match_str(in, ">")) {
			} else {
				error_log("'>' expected at !ATTLIST (tag = " + tag + ").");
				return "'>' expected at !ATTLIST (tag = " + tag + ").";
			}
			continue;
		} else {
		}
		if (str = al_file_read(in, "string")) {
			error_log("unexpected token'" + str + "'");
			return "unexpected token'" + str + "'";
		} else {
		}
		itr = al_dst_itr(elems);
		root_elem = al_next(itr);
		normalize();
		elems = null;
		tags = al_cons(null, null);
		check_recursive(root_elem, tags);
		return null;
	}
}
end_body
member
public: list load_elem(file in);
body
{
	var list elem, elem2;
	if (elem = load_elem1(in)) {
	} else {
		error_log("<elem1> expected.");
		return null;
	}
	if (al_file_match_str(in, "?")) {
		elem.tail.tail.tail.head = "?";
		return elem;
	} else {
	}
	if (al_file_match_str(in, "*")) {
		elem.tail.tail.tail.head = "*";
		return elem;
	} else {
	}
	if (al_file_match_str(in, "+")) {
		elem.tail.tail.tail.head = "+";
		return elem;
	} else {
	}
	return elem;
}
end_body
member
public: list load_elem1(file in);
body
{
	var list elem, elem2, opt;
	if (al_file_match_str(in, "(")) {
		elem = al_list5("elem", null, null, "", 1);
		loop {
			if (elem2 = load_elem(in)) {
			} else {
				error_log("<elem> expected.");
				return null;
			}
			if (elem2.head == "elem") {
				if (elem2.tail.tail.head) {
					// elem_tag
					opt = elem2.tail.tail.tail.head;
					if (opt == "?" || opt == "*") {
					} else {
						elem.tail.tail.tail.tail.head = null;
					}
				} else {
					// not elem tag
					if (elem2.tail.tail.tail.tail.head) {
					} else {
						elem.tail.tail.tail.tail.head = null;
					}
				}
			} else {
			}
			if (al_file_match_str(in, ")")) {
				if (elem.tail.head == null) {
					elem.tail.head = ",";
				} else {
				}
				if (elem.tail.head == "|") {
					var list elem3;
					elem3 = al_list5(null, null, null, null, null);
					al_create_arc(elem, elem3, null);
					al_create_arc(elem3, elem2, null);
				} else {
					al_create_arc(elem, elem2, null);
				}
				return elem;
			} else {
			}
			if (elem.tail.head) {
				if (al_file_match_str(in, elem.tail.head)) {
					if (elem.tail.head == "|") {
						var list elem3;
						elem3 = al_list5(null, null, null, null, null);
						al_create_arc(elem, elem3, null);
						al_create_arc(elem3, elem2, null);
					} else {
						al_create_arc(elem, elem2, null);
					}
					continue;
				} else {
					error_log("'" + elem.tail.head + "' expected.");
					return null;
				}
			} else {
				if (al_file_match_str(in, "|")) {
					elem.tail.head = "|";
					var list elem3;
					elem3 = al_list5(null, null, null, null, null);
					al_create_arc(elem, elem3, null);
					al_create_arc(elem3, elem2, null);
					continue;
				} else {
				}
				if (al_file_match_str(in, ",")) {
					elem.tail.head = ",";
					al_create_arc(elem, elem2, null);
					continue;
				} else {
				}
			}
		}
	} else {
		if (elem2 = load_elem2(in)) {
			return elem2;
		} else {
			error_log("<elem2> expected.");
			return null;
		}
	}
}
end_body
member
public: list load_elem2(file in);
body
{
	var list elem;
	if (elem = load_elem_empty_any(in)) {
		return elem;
	} else {
	}
	if (elem = load_elem_tag(in)) {
		return elem;
	} else {
	}
	if (elem = load_elem_data(in)) {
		return elem;
	} else {
	}
	return null;
}
end_body
member
public: list load_elem_tag(file in);
body
{
	var list tag, elem, elem2;
	if (tag = al_file_read(in, "xident")) {
		if (elem = al_dst_node(elems, tag)) {
			elem2 = al_list_misc("copy", elem, null);
			al_create_arc(elem, elem2, "$refer");
			return elem2;
		} else {
			error_log("element not found (tag = '" + tag + ").");
			return null;
		}
	} else {
		return null;
	}
}
end_body
member
public: list load_elem_empty_any(file in);
body
{
	var list ident;
	var integer pos;
	pos = al_file_manip("curr_pos", in, null);
	if (ident = al_file_read(in, "ident")) {
		if (ident == "EMPTY" || ident == "ANY") {
			return al_list5("elem", ident, null, "", null);
		} else {
		}
		al_file_manip("back", in, pos);
	} else {
	}
	return null;
}
end_body
member
public: list load_elem_data(file in);
body
{
	if (al_file_match_str(in, "#PCDATA")) {
		return al_list5("elem", "#PCDATA", null, "", null);
	} else {
	}
	return null;
}
end_body
member
public: list add_attr(list elem, file in);
body
{
	var list name, kind, type, default_value;
	loop {
		if (name = al_file_read(in, "xident")) {
		} else {
			return null;
		}
		if (al_file_match_str(in, "(")) {
			var list tag;
			kind = load_attr_choice(in);
			if (al_file_match_str(in, ")")) {
			} else {
				error_log("')' expected at attribute kind.");
				return "')' expected at attribute kind.";
			}
		} else {
			if (kind = al_file_read(in, "string")) {
			} else {
				error_log("attribute kind expected.");
				return "attribute kind expected.";
			}
		}
		if (al_file_match_str(in, "#")) {
			if (type = al_file_read(in, "ident")) {
			} else {
				error_log("attribute type expected.");
				return "attribute type expected.";
			}
			type = "#" + type;
		} else {
			if (type = al_file_read(in, "single_quote_string")) {
			} else {
				if (type = al_file_read(in, "quote_string")) {
				} else {
					error_log("attribute type expected.");
					return "attribute type expected.";
				}
			}
		}
		if (type == "#FIXED") {
			if (default_value = al_file_read(in, "quote_string")) {
			} else {
				error_log("attribute default_value expected.");
				return "attribute default_value expected.";
			}
		} else {
		}
		var list attr;
		attr = al_list5("attr", name, kind, type, default_value);
		al_create_arc(elem, attr, "attr");
	}
}
end_body
member
public: list attr;
member
public: list load_attr_choice(file in);
body
{
	var list kind;
	var string value;
	kind = al_cons("|", null);
	loop {
		if (value = al_file_read(in, "xident")) {
			al_create_arc(kind, al_cons(null, null), value);
		} else {
			return kind;
		}
		if (al_file_match_str(in, "|")) {
			continue;
		} else {
			return kind;
		}
	}
}
end_body
member
public: void normalize();
body
{
	var list itr, elem, itr2, elem2, itr3, dst, attr, opt, all_opt;
	itr = al_dst_itr(elems);
	loop {
		if (elem = al_next(itr)) {
		} else {
			break;
		}
		{
			all_opt = 1;
			itr3 = al_dst_itr(elem);
			loop {
				if (dst = al_next(itr3)) {
				} else {
					break;
				}
				attr = al_arc_a(itr3);
				if (al_is_type(attr, "string") && al_strlen(attr) > 0 && al_get_char(attr, 0) == '$') {
					continue;
				} else {
				}
				if (dst.head == "elem") {
					if (dst.tail.tail.head) {
						// elem tag
						opt = dst.tail.tail.tail.head;
						if (opt == "?" || opt == "*") {
						} else {
							all_opt = null;
						}
					} else {
						// not elem tag
						if (dst.tail.tail.tail.tail.head) {
						} else {
							all_opt = null;
						}
					}
				} else {
				}
			}
			elem.tail.tail.tail.tail.head = all_opt;
		}
		itr2 = al_dst_itr(elem);
		loop {
			if (elem2 = al_next_a(itr2, "$refer")) {
			} else {
				break;
			}
			elem2.tail.tail.tail.tail.head = all_opt;
			itr3 = al_dst_itr(elem);
			loop {
				if (dst = al_next(itr3)) {
				} else {
					break;
				}
				attr = al_arc_a(itr3);
				if (attr == "$refer") {
					continue;
				} else {
				}
				al_create_arc(elem2, dst, attr);
			}
			al_remove(itr2);
		}
	}
}
end_body
member
public: list check_recursive(list elem, list tags);
body
{
	var string tag;
	var list recursive, itr, elem2, ret;
	if (elem.head == "elem") {
		if (tag = elem.tail.tail.head) {
			if (al_dst_node(tags, tag)) {
				recursive = 1;
			} else {
			}
		} else {
		}
	} else {
	}
	if (recursive) {
		al_set_dst_node(elem, "$recursive", 0);
		return tag;
	} else {
	}
	al_create_arc(tags = al_copy(tags), 0, tag);
	itr = al_dst_itr(elem);
	loop {
		if (elem2 = al_next_a(itr, null)) {
		} else {
			break;
		}
		if (al_dst_node(elem2, "$recursive")) {
			continue;
		} else {
		}
		var list tag2;
		if (tag2 = check_recursive(elem2, tags)) {
			if (ret) {
			} else {
				ret = al_cons(null, null);
			}
			al_create_arc(ret, tag2, tag2);
		} else {
			if (data_duplicate) {
				al_arc_dst(itr, al_copy(elem2));
			} else {
			}
		}
	}
	if (al_dst_node(elem, "$recursive") != 0) {
		if (ret) {
			if (tag = elem.tail.tail.head) {
				if (check_recursive(ret, tag)) {
					al_set_dst_node(elem, "$recursive", 1);
				} else {
					al_set_dst_node(elem, "$recursive", 2);
				}
			} else {
				al_set_dst_node(elem, "$recursive", 2);
			}
		} else {
		}
	} else {
	}
	return ret;
}
end_body
member
public: list check_recursive(list ret, string tag);
body
{
	if (al_is_type(ret, "string")) {
		if (tag == ret) {
			return 1;
		} else {
			return null;
		}
	} else {
	}
	var list itr, ret2;
	itr = al_dst_itr(ret);
	loop {
		if (ret2 = al_next(itr)) {
		} else {
			break;
		}
		if (check_recursive(ret2, tag)) {
			return 1;
		} else {
		}
	}
	return null;
}
end_body
member
public: list data_duplicate;
member
public: void error_log(string s);
body
{
	if (log_level >= 10) {
		al_print("[Error] " + s + "\n");
	} else {
	}
}
end_body
member
public: void warning_log(string s);
body
{
	if (log_level >= 20) {
		al_print("[Warning] " + s + "\n");
	} else {
	}
}
end_body
member
public: void info_log(string s);
body
{
	if (log_level >= 30) {
		al_print("[Info] " + s + "\n");
	} else {
	}
}
end_body
member
public: list log_level;
member
public: static void attach_content_validation_data(list dtd, string csv_filename);
body
{
	if (al_dst_node(dtd, "$validation_data")) {
		return;
	} else {
	}
	var file in, in2;
	var list data, node, dics, dic, ret, itr;
	var string type_dic, xpath;
	var string dic_id, value;
	var string type, repr;
	var integer min, max, idx;
	dics = al_cons(null, null);
	if (in = al_file_open(csv_filename, "r")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't open " + (string)csv_filename;
		throw ex;
	}
	loop {
		if (data = al_file_read(in, "csv") && data != 1) {
		} else {
			break;
		}
		type_dic = al_dst_node(data, 1);
		if (type_dic == "type") {
			xpath = al_dst_node(data, 2);
			idx = al_search_str(xpath, 1, "/");
			xpath = al_tail_str(xpath, idx + 1);
			ret = al_cons(null, null);
			get_node(ret, dtd, xpath);
			itr = al_dst_itr(ret);
			if (al_count(itr) == 0) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "dtd node not found: validation-csv-file = " + (string)csv_filename + ", xpath = " + (string)xpath;
				throw ex;
			} else {
			}
			type = al_dst_node(data, 3);
			min = al_dst_node(data, 4);
			if (min != "") {
				min = (integer)min;
			} else {
			}
			max = al_dst_node(data, 5);
			if (max != "") {
				max = (integer)max;
			} else {
			}
			repr = al_dst_node(data, 6);
			loop {
				if (node = al_next(itr)) {
				} else {
					break;
				}
				if (al_dst_node(node, "$type")) {
				} else {
					al_create_arc(node, al_list4(type, min, max, repr), "$type");
				}
			}
		} else {
		}
		if (type_dic == "dic") {
			xpath = al_dst_node(data, 2);
			idx = al_search_str(xpath, 1, "/");
			xpath = al_tail_str(xpath, idx + 1);
			ret = al_cons(null, null);
			get_node(ret, dtd, xpath);
			itr = al_dst_itr(ret);
			if (al_count(itr) == 0) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "dtd node not found: validation-csv-file = " + (string)csv_filename + ", xpath = " + (string)xpath;
				throw ex;
			} else {
			}
			dic_id = al_dst_node(data, 3);
			if (dic = al_dst_node(dics, dic_id)) {
			} else {
				in2 = al_file_open(csv_filename, "r");
				loop {
					if (data = al_file_read(in2, "csv") && data != 1) {
					} else {
						var AlException ex;
						ex = new AlException;
						ex.msg = "unexpected EOF: validation-csv-file = " + (string)csv_filename + ", xpath = " + (string)xpath;
						throw ex;
					}
					type_dic = al_dst_node(data, 1);
					if (type_dic == "end-" + dic_id) {
						break;
					} else {
					}
					if (type_dic != dic_id) {
						continue;
					} else {
					}
					value = al_dst_node(data, 2);
					dic = al_cons(value, dic);
				}
				al_create_arc(dics, dic, dic_id);
			}
			loop {
				if (node = al_next(itr)) {
				} else {
					break;
				}
				if (al_dst_node(node, "$dic")) {
				} else {
					al_create_arc(node, dic, "$dic");
				}
			}
		} else {
		}
	}
	al_create_arc(dtd, al_cons(null, null), "$validation_data");
}
end_body
member
public: static void get_node(list ret, list elem, string xpath);
body
{
	if (xpath == "" && elem.tail.head == "#PCDATA") {
		al_create_arc(ret, elem, null);
		return;
	} else {
	}
	var integer idx;
	var string h, t;
	idx = al_search_str(xpath, 0, "/");
	if (idx >= 0) {
		h = al_substr(xpath, 0, idx);
		t = al_tail_str(xpath, idx + 1);
	} else {
		h = xpath;
		t = "";
	}
	var list choice, itr, elem2;
	var string tag;
	choice = (elem.tail.head == "|");
	itr = al_dst_itr(elem);
	loop {
		if (elem2 = al_next_a(itr, null)) {
		} else {
			break;
		}
		if (choice) {
			elem2 = al_dst_node(elem2, null);
		} else {
		}
		if (elem2.head == "elem") {
			tag = elem2.tail.tail.head;
			if (tag) {
				if (tag == h) {
					get_node(ret, elem2, t);
				} else {
				}
			} else {
				get_node(ret, elem2, xpath);
			}
		} else {
		}
		if (elem2.head == "attr") {
			if ("@" + elem2.tail.head == h && t == "") {
				al_create_arc(ret, elem2, null);
			} else {
			}
		} else {
		}
	}
}
end_body
class ExtendedDtdLoader
member
public: list read_element(file in);
body
{
	var string tag, str;
	var list elem;
	elems = al_cons(null, null);
	loop {
		if (al_file_match_str(in, "<!ELEMENT")) {
			if (tag = al_file_read(in, "xident")) {
			} else {
				error_log("element tag name expected.");
				return "element tag name expected.";
			}
			info_log("element tag: " + tag);
			if (elem = al_dst_node(elems, tag)) {
			} else {
				elem = al_list5("elem", null, tag, "", null);
				al_create_arc(elems, elem, tag);
			}
			if (al_file_read(in, al_list2("find", ">"))) {
			} else {
				error_log("unexpected EOF (11)");
				return "unexpected EOF (11)";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!ATTLIST")) {
			if (al_file_read(in, al_list2("find", ">"))) {
			} else {
				error_log("unexpected EOF (12)");
				return "unexpected EOF (12)";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!METAINFO")) {
			if (al_file_read(in, al_list2("find", ">"))) {
			} else {
				error_log("unexpected EOF (13)");
				return "unexpected EOF (13)";
			}
			continue;
		} else {
		}
		if (str = al_file_read(in, "string")) {
			error_log("unexpected token'" + str + "'");
			return "unexpected token'" + str + "'";
		} else {
		}
		return null;
	}
}
end_body
member
public: list elem_attr(file in);
body
{
	var string tag, str;
	var list elem, elem2, itr, tags, all_opt;
	loop {
		if (al_file_match_str(in, "<!ELEMENT")) {
			if (tag = al_file_read(in, "xident")) {
			} else {
				error_log("element tag name expected.");
				return "element tag name expected.";
			}
			info_log("element tag: " + tag);
			if (elem = al_dst_node(elems, tag)) {
			} else {
				error_log("element tag '" + tag + "' not found.");
				return "element tag '" + tag + "' not found.";
			}
			if (elem2 = load_elem(in)) {
				al_create_arc(elem, elem2, null);
			} else {
				error_log("element definition of tag name '" + tag + "' is illegal.");
				return "element definition of tag name '" + tag + "' is illegal.";
			}
			if (al_file_match_str(in, ">")) {
			} else {
				error_log("'>' expected at !ELEMENT (tag = " + tag + ").");
				return "'>' expected at !ELEMENT (tag = " + tag + ").";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!ATTLIST")) {
			if (tag = al_file_read(in, "xident")) {
			} else {
				error_log("attlist tag name expected.");
				return "attlist tag name expected.";
			}
			info_log("attlist tag: " + tag);
			if (elem = al_dst_node(elems, tag)) {
			} else {
				error_log("attlist tag '" + tag + "' not found.");
				return "attlist tag '" + tag + "' not found.";
			}
			if (add_attr(elem, in)) {
				error_log("attr definition of tag name '" + tag + "' is illegal.");
				return "attr definition of tag name '" + tag + "' is illegal.";
			} else {
			}
			if (al_file_match_str(in, ">")) {
			} else {
				error_log("'>' expected at !ATTLIST (tag = " + tag + ").");
				return "'>' expected at !ATTLIST (tag = " + tag + ").";
			}
			continue;
		} else {
		}
		if (al_file_match_str(in, "<!METAINFO")) {
			var string name, value;
			if (tag = al_file_read(in, "xident")) {
			} else {
				error_log("metainfo tag name expected.");
				return "metainfo tag name expected.";
			}
			info_log("metainfo tag: " + tag);
			if (elem = al_dst_node(elems, tag)) {
			} else {
				error_log("metainfo tag '" + tag + "' not found.");
				return "metainfo tag '" + tag + "' not found.";
			}
			if (name = al_file_read(in, "quote_string")) {
			} else {
				error_log("metainfo property name expected (tag = " + tag + ").");
				return "metainfo property name expected (tag = " + tag + ").";
			}
			if (value = al_file_read(in, "quote_string")) {
			} else {
				error_log("metainfo property value expected (tag = " + tag + ").");
				return "metainfo property value expected (tag = " + tag + ").";
			}
			al_create_arc(elem, value, "$" + name);
			if (al_file_match_str(in, ">")) {
			} else {
				error_log("'>' expected at !METAINFO (tag = " + tag + ").");
				return "'>' expected at !METAINFO (tag = " + tag + ").";
			}
			continue;
		} else {
		}
		if (str = al_file_read(in, "string")) {
			error_log("unexpected token'" + str + "'");
			return "unexpected token'" + str + "'";
		} else {
		}
		itr = al_dst_itr(elems);
		root_elem = al_next(itr);
		data_duplicate = (al_dst_node(root_elem, "$data.duplicate") != "false");
		normalize();
		elems = null;
		tags = al_cons(null, null);
		check_recursive(root_elem, tags);
		return null;
	}
}
end_body
member
public: list add_attr(list elem, file in);
body
{
	var list name, kind, type, default_value;
	loop {
		if (name = al_file_read(in, "xident")) {
		} else {
			return null;
		}
		if (al_file_match_str(in, "(")) {
			var list tag;
			kind = load_attr_choice(in);
			if (al_file_match_str(in, ")")) {
			} else {
				error_log("')' expected at attribute kind.");
				return "')' expected at attribute kind.";
			}
		} else {
			if (kind = al_file_read(in, "string")) {
			} else {
				error_log("attribute kind expected.");
				return "attribute kind expected.";
			}
		}
		if (al_file_match_str(in, "#")) {
			if (type = al_file_read(in, "ident")) {
			} else {
				error_log("attribute type expected.");
				return "attribute type expected.";
			}
			type = "#" + type;
		} else {
			if (type = al_file_read(in, "single_quote_string")) {
			} else {
				if (type = al_file_read(in, "quote_string")) {
				} else {
					error_log("attribute type expected.");
					return "attribute type expected.";
				}
			}
		}
		if (type == "#FIXED") {
			if (default_value = al_file_read(in, "quote_string")) {
			} else {
				error_log("attribute default_value expected.");
				return "attribute default_value expected.";
			}
		} else {
		}
		var list attr;
		attr = al_list5("attr", name, kind, type, default_value);
		al_create_arc(elem, attr, "attr");
		loop {
			if (al_file_match_str(in, "METAINFO")) {
				var string name2, value2;
				if (name2 = al_file_read(in, "quote_string")) {
				} else {
					error_log("metainfo property name expected (attr = " + name + ").");
					return "metainfo property name expected (attr = " + name + ").";
				}
				if (value2 = al_file_read(in, "quote_string")) {
				} else {
					error_log("metainfo property value expected (attr = " + name + ").");
					return "metainfo property value expected (attr = " + name + ").";
				}
				al_create_arc(attr, value2, "$" + name2);
			} else {
				break;
			}
		}
	}
}
end_body
end_class
end_class
class DtdItr
member
public: void Reset(list node0);
body
{
	var list itr, info;
	var string tag;
	itr = al_dst_itr(node = node0);
	stack = al_cons(al_list6("main", itr, node0, "attr", null, al_cons(null, null)), null);
	if (node0.tail.head == null) {
		tag = node0.tail.tail.head;
		abs_xpath = "/" + tag;
		rel_xpath = tag;
		if (handler) {
			handler.startElement(tag);
		} else {
		}
	} else {
		abs_xpath = "";
		rel_xpath = "";
	}
	info = al_list2(abs_xpath, rel_xpath);
	xpath_stack = al_cons(info, null);
	ns_stack = al_cons(null, null);
	type = "begin";
}
end_body
member
public: list Next(list skip_flag);
body
{
	if (type == "elem2") {
		var list info;
		info = xpath_stack.head;
		abs_xpath = info.head;
		rel_xpath = info.tail.head;
		xpath_stack = xpath_stack.tail;
	} else {
	}
	recursive_expanded = null;
	attr = null;
	var list itr, node2, info, kind, attr2;
	if (all_tag && type == "begin") {
		type = "elem3";
		opt = "";
		return type;
	} else {
	}
	if (type == "end") {
		return type;
	} else {
	}
	if (type == "end_repetition") {
		repetition_stack = repetition_stack.tail;
		if (pop()) {
			return type;
		} else {
		}
	} else {
	}
	if (type == "end_optional") {
		if (pop()) {
			return type;
		} else {
		}
	} else {
	}
	if (type == "end_choice") {
		node2 = stack.head.tail.tail.head;
		opt = node2.tail.tail.tail.head;
		if (opt == "*" || opt == "+") {
			stack.head.head = type = "end_repetition";
			return type;
		} else {
			if (opt == "?") {
				stack.head.head = type = "end_optional";
				return type;
			} else {
			}
		}
		if (pop()) {
			return type;
		} else {
		}
	} else {
	}
	if (type == "end_case") {
		stack = stack.tail;
		itr = stack.head.tail.head;
		if (node = al_next_a(itr, null)) {
			itr = al_dst_itr(node);
			stack = al_cons(al_list6(null, itr, node, "attr", null, al_cons(null, null)), stack);
			stack.head.head = type = "case";
			return type;
		} else {
			stack.head.head = type = "end_choice";
			return type;
		}
	} else {
	}
	if (type == "end_all_opt") {
		if (stack.head.head == "case") {
			type = "end_case";
			return type;
		} else {
		}
	} else {
	}
	if (type == "repetition") {
		info = al_list6(stack, node, opt, abs_xpath, xpath_stack, repetition_tag);
		repetition_stack = al_cons(info, repetition_stack);
		rel_xpath = "";
		node2 = stack.head.tail.tail.head;
		if (node2.tail.head == "|") {
			stack.head.head = type = "choice";
			return type;
		} else {
		}
	} else {
	}
	if (type == "choice") {
		itr = stack.head.tail.head;
		if (node = al_next_a(itr, null)) {
			itr = al_dst_itr(node);
			stack = al_cons(al_list6(null, itr, node, "attr", null, al_cons(null, null)), stack);
			stack.head.head = type = "case";
			return type;
		} else {
			stack.head.head = type = "end_choice";
			return type;
		}
	} else {
	}
	if (type == "all_opt") {
		node = stack.head.tail.tail.head;
		opt = node.tail.tail.tail.head;
		if (opt == "*" || opt == "+") {
			if (node.tail.head == null) {
				repetition_tag = node.tail.tail.head;
			} else {
				repetition_tag = null;
			}
			stack.head.head = type = "repetition";
			return type;
		} else {
		}
		if (opt == "?") {
			stack.head.head = type = "optional";
			return type;
		} else {
		}
		if (node.tail.head == "|") {
			stack.head.head = type = "choice";
			return type;
		} else {
		}
		if (al_dst_node(node, null) == null) {
			type = "elem";
			attr = null;
			return type;
		} else {
			if (all_tag && node.tail.tail.head) {
				type = "elem3";
				attr = null;
				return type;
			} else {
			}
		}
	} else {
	}
	loop {
		itr = stack.head.tail.head;
		kind = stack.head.tail.tail.tail.head;
		if (kind == "attr") {
			if (node = al_next_a(itr, "attr")) {
				attr = node.tail.head;
				if (attr == "xml:lang") {
					continue;
				} else {
				}
				opt = node.tail.tail.tail.head;
				if (opt == "#REQUIRED") {
					opt = "";
				} else {
					opt = "?";
				}
				if (al_str_misc("starts_with", attr, "xmlns")) {
					// push namespace stack
					var string ns_name, ns_url;
					if (al_strlen(attr) >= 6) {
						ns_name = al_tail_str(attr, 6);
					} else {
						ns_name = al_copy("");
					}
					if (ns_url = node.tail.tail.tail.tail.head) {
					} else {
						ns_url = "";
					}
					var list itr2;
					itr2 = al_dst_itr(ns_stack);
					if (node2 = al_next(itr2)) {
						al_insert_before(ns_stack, node2, ns_name, ns_url);
					} else {
						al_create_arc(ns_stack, ns_name, ns_url);
					}
					al_create_arc(ns_name, node, "$attr_node");
					al_create_arc(stack.head.tail.tail.tail.tail.tail.head, ns_name, ns_name);
					if (al_dst_node(node, "$scope") != "global") {
						if (handler) {
							handler.setNamespace(ns_name);
						} else {
						}
					} else {
					}
				} else {
				}
				type = "attr";
				return type;
			} else {
				stack.head.tail.tail.tail.head = null;
				node2 = stack.head.tail.tail.head;
				stack.head.tail.head = itr = al_dst_itr(node2);
				{
					if (al_dst_node(node2, "$treat.below.as.text") == "true") {
						al_prev(itr);
						type = "as_text";
						return type;
					} else {
					}
				}
			}
			continue;
		} else {
		}
		if (node = al_next_a(itr, null)) {
			if (skip_flag) {
				if (al_dst_node(node, "$recursive") == 0) {
					if (stack.head.head == "case") {
						type = "end_case";
						return type;
					} else {
					}
					// continue;
					info = al_list2(abs_xpath, rel_xpath);
					xpath_stack = al_cons(info, xpath_stack);
					tag = node.tail.tail.head;
					abs_xpath = abs_xpath + "/" + tag;
					if (rel_xpath == "") {
						rel_xpath = tag;
					} else {
						rel_xpath = rel_xpath + "/" + tag;
					}
					type = "elem2";
					attr = null;
					return type;
				} else {
				}
				if (skip_flag == 1) {
					if (stack.head.head == "case") {
					} else {
						continue;
					}
				} else {
				}
			} else {
			}
			expand_recursive();
			itr = al_dst_itr(node);
			stack = al_cons(al_list6(null, itr, node, "attr", null, al_cons(null, null)), stack);
			if (node.tail.head == null) {
				info = al_list2(abs_xpath, rel_xpath);
				xpath_stack = al_cons(info, xpath_stack);
				tag = node.tail.tail.head;
				abs_xpath = abs_xpath + "/" + tag;
				if (rel_xpath == "") {
					rel_xpath = tag;
				} else {
					rel_xpath = rel_xpath + "/" + tag;
				}
				if (handler) {
					handler.startElement(tag);
				} else {
				}
			} else {
			}
			opt = node.tail.tail.tail.head;
			{
				var list is_tag, all_opt;
				is_tag = node.tail.tail.head;
				all_opt = node.tail.tail.tail.tail.head;
				if (is_tag && all_opt && (opt == "" || opt == "+")) {
					stack.head.tail.tail.tail.tail.head = "all_opt";
					type = "all_opt";
					return type;
				} else {
				}
			}
			if (opt == "*" || opt == "+") {
				if (node.tail.head == null) {
					repetition_tag = tag;
				} else {
					repetition_tag = null;
				}
				stack.head.head = type = "repetition";
				return type;
			} else {
			}
			if (opt == "?") {
				stack.head.head = type = "optional";
				return type;
			} else {
			}
			if (node.tail.head == "|") {
				stack.head.head = type = "choice";
				return type;
			} else {
			}
			if (al_dst_node(node, null) == null) {
				type = "elem";
				attr = null;
				return type;
			} else {
				if (all_tag && node.tail.tail.head) {
					type = "elem3";
					attr = null;
					return type;
				} else {
				}
			}
		} else {
			node2 = stack.head.tail.tail.head;
			if (node2.head == "elem" && node2.tail.head == null) {
				info = xpath_stack.head;
				if (abs_xpath == info.head) {
					tag = al_tail_str(abs_xpath, 1);
				} else {
					tag = al_tail_str(abs_xpath, al_strlen(info.head) + 1);
				}
				abs_xpath = info.head;
				rel_xpath = info.tail.head;
				xpath_stack = xpath_stack.tail;
				repetition_tag = null;
				if (handler) {
					handler.endElement(tag);
				} else {
				}
				{
					// pop namespace stack
					var string ns_name;
					var list itr2, itr3;
					itr2 = al_dst_itr(stack.head.tail.tail.tail.tail.tail.head);
					loop {
						if (ns_name = al_next(itr2)) {
						} else {
							break;
						}
						itr3 = al_dst_itr(ns_stack);
						loop {
							if (al_next(itr3) == ns_name) {
							} else {
								break;
							}
							al_remove(itr3);
							break;
						}
					}
					itr3 = al_dst_itr(ns_stack);
					loop {
						if (ns_name = al_next(itr3)) {
						} else {
							if (handler) {
								handler.setNamespace(ns_name);
							} else {
							}
							break;
						}
						if (node2 = al_dst_node(ns_name, "$attr_node") && al_dst_node(node2, "$scope") == "global") {
							continue;
						} else {
						}
						if (handler) {
							handler.setNamespace(ns_name);
						} else {
						}
						break;
					}
				}
			} else {
			}
			kind = stack.head.head;
			if (kind == "repetition") {
				type = "end_repetition";
				return type;
			} else {
			}
			if (kind == "optional") {
				type = "end_optional";
				return type;
			} else {
			}
			if (kind == "main") {
				stack = stack.tail;
				type = "end";
				return type;
			} else {
			}
			if (pop()) {
				return type;
			} else {
			}
			if (stack.head.head == "case") {
				type = "end_case";
				return type;
			} else {
			}
		}
	}
}
end_body
member
public: list pop();
body
{
	if (stack.head.tail.tail.tail.tail.head == "all_opt") {
		type = "end_all_opt";
		attr = tag = null;
		stack = stack.tail;
		return 1;
	} else {
		stack = stack.tail;
		return null;
	}
}
end_body
member
public: list stack;
member
public: list type;
member
public: list node;
member
public: list opt;
member
public: void ContinueRepetition();
body
{
	var list itr, info, node2;
	info = repetition_stack.head;
	repetition_stack = repetition_stack.tail;
	stack = info.head;
	node = info.tail.head;
	opt = info.tail.tail.head;
	abs_xpath = info.tail.tail.tail.head;
	xpath_stack = info.tail.tail.tail.tail.head;
	repetition_tag = info.tail.tail.tail.tail.tail.head;
	node2 = stack.head.tail.tail.head;
	itr = al_dst_itr(node2);
	stack.head.tail.head = itr;
	stack.head.head = type = "repetition";
	stack.head.tail.tail.tail.head = "attr";
	if (handler && repetition_tag) {
		handler.startElement(repetition_tag);
	} else {
	}
}
end_body
member
public: void BreakRepetition();
body
{
	var integer count;
	count = 1;
	loop {
		if (type == "end_repetition") {
			count = count - 1;
			if (count == 0) {
				break;
			} else {
			}
		} else {
		}
		Next((list)1);
		if (type == "end") {
			al_print("%%% BreakRepetition: end appears during finding end_repetition.\n");
			break;
		} else {
		}
		if (type == "repetition") {
			count = count + 1;
		} else {
		}
	}
}
end_body
member
public: list repetition_stack;
member
public: string abs_xpath;
member
public: string rel_xpath;
member
public: string attr;
member
public: string tag;
member
public: list xpath_stack;
member
public: void expand_recursive();
body
{
	if (al_dst_node(node, "$recursive") == 0) {
	} else {
		return;
	}
	recursive_expanded = 1;
	var list node2, itr, elem, itr2, elem2;
	node2 = al_copy(node);
	mark(node2);
	unmark(node2);
	al_graph_misc("mark", node2, null);
	itr = al_src_itr(node2);
	loop {
		if (elem = al_next(itr)) {
		} else {
			break;
		}
		al_arc_dst(itr, node);
	}
	itr = al_src_itr(node);
	loop {
		if (elem = al_next(itr)) {
		} else {
			break;
		}
		if (al_graph_misc("is_marked", elem, null)) {
			continue;
		} else {
		}
		al_arc_dst(itr, node2);
	}
	itr = al_dst_itr(node);
	itr2 = al_dst_itr(node2);
	loop {
		if (al_next(itr)) {
		} else {
			break;
		}
		elem2 = al_next(itr2);
		al_arc_dst(itr, elem2);
	}
	al_graph_misc("unmark", node2, null);
	node = node2;
}
end_body
member
public: void mark(list elem);
body
{
	if (al_dst_node(elem, "$mark")) {
		return;
	} else {
	}
	al_set_dst_node(elem, "$mark", "mark");
	if (al_dst_node(elem, "$recursive") == 0) {
		al_set_dst_node(elem, "$recursive", 1);
	} else {
	}
	var list itr, elem2;
	itr = al_dst_itr(elem);
	loop {
		if (elem2 = al_next_a(itr, null)) {
		} else {
			break;
		}
		mark(elem2);
	}
}
end_body
member
public: void unmark(list elem);
body
{
	if (al_dst_node(elem, "$mark")) {
	} else {
		return;
	}
	al_set_dst_node(elem, "$mark", null);
	var list itr, elem2;
	itr = al_dst_itr(elem);
	loop {
		if (elem2 = al_next_a(itr, null)) {
		} else {
			break;
		}
		unmark(elem2);
	}
}
end_body
member
public: list recursive_expanded;
member
public: string repetition_tag;
member
public: DtdHandler handler;
member
public: DtdItr Copy();
body
{
	var DtdItr itr;
	itr = new DtdItr;
	itr.stack = stack_copy(stack);
	itr.type = type;
	itr.node = node;
	itr.opt = opt;
	itr.repetition_stack = repetition_stack_copy(repetition_stack);
	itr.abs_xpath = abs_xpath;
	itr.rel_xpath = rel_xpath;
	itr.attr = attr;
	itr.xpath_stack = xpath_stack;
	itr.repetition_tag = repetition_tag;
	itr.ns_stack = al_copy(ns_stack);
	return itr;
}
end_body
member
public: list stack_copy(list stack);
body
{
	if (stack) {
	} else {
		return null;
	}
	var list info, info2;
	info = stack.head;
	info2 = al_list6(info.head, al_copy(info.tail.head), info.tail.tail.head, info.tail.tail.tail.head, info.tail.tail.tail.tail.head, info.tail.tail.tail.tail.tail.head);
	return al_cons(info2, stack_copy(stack.tail));
}
end_body
member
public: list repetition_stack_copy(list repetition_stack);
body
{
	if (repetition_stack) {
	} else {
		return null;
	}
	var list info, info2;
	info = repetition_stack.head;
	info2 = al_list6(stack_copy(info.head), info.tail.head, info.tail.tail.head, info.tail.tail.tail.head, info.tail.tail.tail.tail.head, info.tail.tail.tail.tail.tail.head);
	return al_cons(info2, repetition_stack_copy(repetition_stack.tail));
}
end_body
member
public: list getFieldList();
body
{
	var DtdItr itr;
	var list field_list, type;
	var string path;
	itr = Copy();
	field_list = al_cons(null, null);
	loop {
		type = itr.Next((list)2);
		if (type == "end_repetition" || type == "end") {
			break;
		} else {
		}
		if (type == "elem" || type == "all_opt") {
			path = itr.rel_xpath;
			al_create_arc(field_list, path, path);
			continue;
		} else {
		}
		if (type == "attr") {
			if (rel_xpath == "") {
				path = "@" + itr.attr;
			} else {
				path = itr.rel_xpath + "/@" + itr.attr;
			}
			al_create_arc(field_list, path, path);
			continue;
		} else {
		}
		if (type == "optional" || type == "end_optional") {
			continue;
		} else {
		}
		if (type == "choice" || type == "end_choice") {
			continue;
		} else {
		}
		if (type == "case" || type == "end_case") {
			continue;
		} else {
		}
		if (type == "repetition") {
			var integer count;
			count = 1;
			loop {
				type = itr.Next((list)1);
				if (type == "end") {
					al_print("%%% getFieldList: end appears during finding end_repetition.\n");
					break;
				} else {
				}
				if (type == "end_repetition") {
					count = count - 1;
					if (count == 0) {
						break;
					} else {
					}
				} else {
				}
				if (type == "repetition") {
					count = count + 1;
				} else {
				}
			}
			continue;
		} else {
		}
	}
	return field_list;
}
end_body
member
public: list getChildList();
body
{
	var DtdItr itr;
	var list child_list, type;
	var string path;
	itr = Copy();
	child_list = al_cons(null, null);
	loop {
		type = itr.Next((list)2);
		if (type == "end_repetition" || type == "end") {
			break;
		} else {
		}
		if (type == "elem") {
			continue;
		} else {
		}
		if (type == "attr") {
			continue;
		} else {
		}
		if (type == "optional" || type == "end_optional") {
			continue;
		} else {
		}
		if (type == "choice" || type == "end_choice") {
			continue;
		} else {
		}
		if (type == "case" || type == "end_case") {
			continue;
		} else {
		}
		if (type == "repetition") {
			al_create_arc(child_list, itr.rel_xpath, itr.rel_xpath);
			var integer count;
			count = 1;
			loop {
				type = itr.Next((list)1);
				if (type == "end") {
					al_print("%%% getChildList: end appears during finding end_repetition.\n");
					break;
				} else {
				}
				if (type == "end_repetition") {
					count = count - 1;
					if (count == 0) {
						break;
					} else {
					}
				} else {
				}
				if (type == "repetition") {
					count = count + 1;
				} else {
				}
			}
			continue;
		} else {
		}
	}
	return child_list;
}
end_body
member
public: DtdItr getChild(string xpath);
body
{
	var DtdItr itr;
	var list field_list, type;
	itr = Copy();
	field_list = al_cons(null, null);
	loop {
		type = itr.Next((list)2);
		if (type == "end_repetition" || type == "end") {
			break;
		} else {
		}
		if (type == "elem" || type == "attr") {
			continue;
		} else {
		}
		if (type == "optional" || type == "end_optional") {
			continue;
		} else {
		}
		if (type == "choice" || type == "end_choice") {
			continue;
		} else {
		}
		if (type == "case" || type == "end_case") {
			continue;
		} else {
		}
		if (type == "repetition") {
			if (itr.rel_xpath == xpath) {
				return itr;
			} else {
			}
			var integer count;
			count = 1;
			loop {
				type = itr.Next((list)1);
				if (type == "end") {
					al_print("%%% getChild: end appears during finding end_repetition.\n");
					break;
				} else {
				}
				if (type == "end_repetition") {
					count = count - 1;
					if (count == 0) {
						break;
					} else {
					}
				} else {
				}
				if (type == "repetition") {
					count = count + 1;
				} else {
				}
			}
			continue;
		} else {
		}
	}
	return null;
}
end_body
member
public: list getFieldList2();
body
{
	var DtdItr itr;
	var list field_list, pkey_list, fkey_list, rev_field_list, type;
	var string path;
	itr = Copy();
	field_list = al_cons(null, null);
	pkey_list = al_cons(null, null);
	fkey_list = al_cons(null, null);
	rev_field_list = al_cons(null, null);
	loop {
		type = itr.Next((list)2);
		if (type == "end_repetition" || type == "end") {
			break;
		} else {
		}
		if (type == "elem" || type == "all_opt") {
			if (tag2) {
			} else {
				tag2 = al_dst_node(al_str_misc("split", itr.rel_xpath, '/'), null);
			}
			path = itr.rel_xpath;
			al_create_arc(field_list, itr.tag, path);
			al_create_arc(rev_field_list, path, itr.tag);
			continue;
		} else {
		}
		if (type == "attr") {
			if (itr.attr == "primary-key") {
				al_create_arc(pkey_list, itr.tag, null);
			} else {
				al_create_arc(fkey_list, itr.attr, itr.tag);
			}
			continue;
		} else {
		}
		if (type == "optional" || type == "end_optional") {
			continue;
		} else {
		}
		if (type == "choice" || type == "end_choice") {
			continue;
		} else {
		}
		if (type == "case" || type == "end_case") {
			continue;
		} else {
		}
		if (type == "repetition") {
			var integer count;
			count = 1;
			loop {
				type = itr.Next((list)1);
				if (type == "end") {
					al_print("%%% getFieldList2: end appears during finding end_repetition.\n");
					break;
				} else {
				}
				if (type == "end_repetition") {
					count = count - 1;
					if (count == 0) {
						break;
					} else {
					}
				} else {
				}
				if (type == "repetition") {
					count = count + 1;
				} else {
				}
			}
			continue;
		} else {
		}
	}
	return al_list5(field_list, tag2, pkey_list, fkey_list, rev_field_list);
}
end_body
member
public: list getChild2(string xpath);
body
{
	var DtdItr itr;
	var list field_list, type;
	itr = Copy();
	field_list = al_cons(null, null);
	loop {
		type = itr.Next((list)2);
		if (type == "end_repetition" || type == "end") {
			break;
		} else {
		}
		if (type == "elem" || type == "attr") {
			continue;
		} else {
		}
		if (type == "optional" || type == "end_optional") {
			continue;
		} else {
		}
		if (type == "choice" || type == "end_choice") {
			continue;
		} else {
		}
		if (type == "case" || type == "end_case") {
			continue;
		} else {
		}
		if (type == "repetition") {
			if (itr.rel_xpath == xpath) {
				var list itr2;
				itr2 = al_dst_itr(al_str_misc("split", xpath, '/'));
				return al_list2(itr, al_prev(itr2));
			} else {
			}
			var integer count;
			count = 1;
			loop {
				type = itr.Next((list)1);
				if (type == "end") {
					al_print("%%% getChild2: end appears during finding end_repetition.\n");
					break;
				} else {
				}
				if (type == "end_repetition") {
					count = count - 1;
					if (count == 0) {
						break;
					} else {
					}
				} else {
				}
				if (type == "repetition") {
					count = count + 1;
				} else {
				}
			}
			continue;
		} else {
		}
	}
	return null;
}
end_body
member
public: list tag2;
member
public: list ns_stack;
member
public: list all_tag;
end_class
class DtdHandler
member
public: void startElement(string tag);
body
{
	al_print("startElement: tag = " + tag + "\n");
}
end_body
member
public: void endElement(string tag);
body
{
	al_print("endElement: tag = " + tag + "\n");
}
end_body
member
public: void setNamespace(string name);
body
{
	if (name) {
		al_print("setNamespace: name = " + name + "\n");
	} else {
		al_print("setNamespace: null is setted.\n");
	}
}
end_body
class XmlComposerHandler
member
public: void startElement(string tag);
body
{
	if (debug) {
		DtdHandler::startElement(tag);
	} else {
	}
	out_current_tag();
	current_tag = tag;
	ns_names = al_cons(null, null);
}
end_body
member
public: void endElement(string tag);
body
{
	if (debug) {
		DtdHandler::endElement(tag);
	} else {
	}
	out_current_tag();
	out_str("</");
	if (ns_name && ns_name != "") {
		out_str(ns_name);
		out_str(":");
	} else {
	}
	out_str(tag);
	out_str(">");
}
end_body
member
public: void setNamespace(string name);
body
{
	if (debug) {
		DtdHandler::setNamespace(name);
	} else {
	}
	ns_name = name;
}
end_body
member
public: XmlComposer composer;
member
public: void out_current_tag();
body
{
	if (current_tag) {
		out_str("<");
		if (ns_name && ns_name != "") {
			out_str(ns_name);
			out_str(":");
		} else {
		}
		out_str(current_tag);
		current_tag = null;
		if (current_attrs) {
			var list itr, nv;
			var string attr;
			itr = al_dst_itr(current_attrs);
			loop {
				if (nv = al_next(itr)) {
				} else {
					break;
				}
				out_str(" ");
				out_str((string)nv.head);
				out_str("=\"");
				attr = al_str_misc("xml_encode", nv.tail.head, 3);
				attr = al_str_misc("to_quote_string", attr, null);
				out_str(attr);
				out_str("\"");
			}
			var string ns_name2, ns_url2;
			itr = al_dst_itr(ns_names);
			loop {
				if (ns_name2 = al_next(itr)) {
				} else {
					break;
				}
				ns_url2 = al_arc_a(itr);
				out_str(" xmlns:");
				out_str(ns_name2);
				out_str("=\"");
				attr = al_str_misc("xml_encode", ns_url2, 3);
				attr = al_str_misc("to_quote_string", attr, null);
				out_str(attr);
				out_str("\"");
			}
			current_attrs = null;
		} else {
		}
		out_str(">");
	} else {
	}
	if (current_value) {
		out_str((string)al_str_misc("xml_encode", current_value, 3));
		current_value = null;
	} else {
	}
	if (raw_current_value) {
		out_str(raw_current_value);
		raw_current_value = null;
	} else {
	}
}
end_body
member
public: string current_tag;
member
public: list current_attrs;
member
public: string current_value;
member
public: string raw_current_value;
member
public: void out_str(string val);
body
{
	composer.out_str(val);
}
end_body
member
public: string ns_name;
member
public: list ns_names;
end_class
end_class
class XmlItr
member
public: void Reset(list parse_tree);
body
{
	var list itr;
	itr = al_dst_itr(parse_tree);
	xpath = "";
	stack = al_cons(al_list2(xpath, itr), null);
}
end_body
member
public: list Next();
body
{
	var list itr, tag, body, attr;
	loop {
		if (stack == null) {
			if (debug) {
				al_print("XmlItr::Next: stack is empty.\n");
			} else {
			}
			return null;
		} else {
		}
		xpath = stack.head.head;
		itr = stack.head.tail.head;
		if (debug) {
			al_print("XmlItr::Next: next xpath (1) = " + xpath + "\n");
		} else {
		}
		if (itr) {
			loop {
				if (tag = al_next(itr)) {
				} else {
					break;
				}
				attr = al_arc_a(itr);
				if (attr == "!comment") {
					continue;
				} else {
				}
				if (attr == "!text") {
					continue;
				} else {
				}
				xpath = xpath + "/" + attr;
				if (debug) {
					al_print("XmlItr::Next: next xpath (2) = " + xpath + "\n");
				} else {
				}
				if (body = al_dst_node(tag, "!body")) {
					itr = al_dst_itr(body);
					value = al_dst_node(body, "!text");
				} else {
					value = ctrl_a;
					itr = null;
				}
				stack = al_cons(al_list2(xpath, itr), stack);
				if (debug) {
					al_print("XmlItr::Next: value = " + (string)value + "\n");
				} else {
				}
				return tag;
			}
		} else {
		}
		stack = stack.tail;
	}
}
end_body
member
public: list Next2();
body
{
	var list itr, tag, body, attr;
	loop {
		if (stack == null) {
			if (debug) {
				al_print("XmlItr::Next2: stack is empty.\n");
			} else {
			}
			return null;
		} else {
		}
		xpath = stack.head.head;
		itr = stack.head.tail.head;
		if (itr) {
			loop {
				if (tag = al_next(itr)) {
				} else {
					break;
				}
				attr = al_arc_a(itr);
				if (attr == "!comment") {
					continue;
				} else {
				}
				if (attr == "!text") {
					continue;
				} else {
				}
				xpath = xpath + "/" + attr;
				if (body = al_dst_node(tag, "!body")) {
					itr = al_dst_itr(body);
					value = al_dst_node(body, "!text");
				} else {
					value = ctrl_a;
					itr = null;
				}
				stack = al_cons(al_list2(xpath, itr), stack);
				if (debug) {
					al_print("XmlItr::Next2: value = " + (string)value + "\n");
				} else {
				}
				return tag;
			}
		} else {
		}
		if (debug) {
			al_print("XmlItr::Next2: no more iterator element.\n");
		} else {
		}
		return null;
	}
}
end_body
member
public: list Next3();
body
{
	var string null_str;
	return Next3(null_str);
}
end_body
member
public: list Next3(string prev_rept_xpath);
body
{
	var list itr, tag, body, attr;
	loop {
		if (stack == null) {
			if (debug) {
				al_print("XmlItr::Next3: stack is empty.\n");
			} else {
			}
			return null;
		} else {
		}
		xpath = stack.head.head;
		itr = stack.head.tail.head;
		if (xpath == prev_rept_xpath) {
			if (debug) {
				al_print("XmlItr::Next2: xpath is previous xpath.\n");
			} else {
			}
			return null;
		} else {
		}
		if (debug) {
			al_print("XmlItr::Next3: next xpath = " + xpath + "\n");
		} else {
		}
		if (itr) {
			loop {
				if (tag = al_next(itr)) {
				} else {
					break;
				}
				attr = al_arc_a(itr);
				if (attr == "!comment") {
					continue;
				} else {
				}
				if (attr == "!text") {
					continue;
				} else {
				}
				al_prev(itr);
				if (debug) {
					al_print("XmlItr::Next3: next element found.\n");
				} else {
				}
				return tag;
			}
		} else {
		}
		stack = stack.tail;
	}
}
end_body
member
public: list stack;
member
public: list xpath;
member
public: string value;
member
public: list getNext(string xpath, string attr);
body
{
	var string null_str;
	return getNext(null_str, xpath, attr);
}
end_body
member
public: list getNext(string prev_rept_xpath, string xpath, string attr);
body
{
	var list tag;
	tag = Next3(prev_rept_xpath);
	var XmlItr xml_itr2;
	xml_itr2 = Copy();
	xml_itr2.value = null;
	if (debug) {
		if (attr) {
			al_print("XmlItr::getNext: required xpath = " + xpath + "/@" + attr + "\n");
		} else {
			al_print("XmlItr::getNext: required xpath = " + xpath + "\n");
		}
	} else {
	}
	loop {
		if (xpath == xml_itr2.xpath) {
			break;
		} else {
		}
		if (tag = xml_itr2.Next2()) {
		} else {
			if (debug) {
				al_print("XmlItr::getNext: not found\n");
			} else {
			}
			return null;
		}
		if (debug) {
			al_print("XmlItr::getNext: next xpath = " + xml_itr2.xpath + "\n");
		} else {
		}
	}
	if (attr) {
		if (xml_itr2.getAttribute(tag, attr)) {
		} else {
			if (debug) {
				al_print("XmlItr::getNext: not found(attr)\n");
			} else {
			}
			return null;
		}
	} else {
	}
	Copy(xml_itr2);
	if (debug) {
		al_print("XmlItr::getNext: found: value = " + (string)value + "\n");
	} else {
	}
	return 1;
}
end_body
member
public: list getAttribute(list tag, string attr);
body
{
	if (tag == null) {
		return null;
	} else {
	}
	var list val_ls;
	if (val_ls = al_dst_node(tag, attr)) {
		value = val_ls.head;
		if (value == "") {
			value = ctrl_a;
		} else {
		}
	} else {
		return null;
	}
	return 1;
}
end_body
member
public: list getNodeAsText(string xpath);
body
{
	Next3();
	var list tag;
	var XmlItr xml_itr2;
	xml_itr2 = Copy();
	xml_itr2.value = null;
	if (debug) {
		al_print("XmlItr::getNodeAsText: required xpath = " + xpath + "\n");
	} else {
	}
	loop {
		if (xpath == xml_itr2.xpath) {
			break;
		} else {
		}
		if (tag = xml_itr2.Next2()) {
		} else {
			if (debug) {
				al_print("XmlItr::getNodeAsText: not found\n");
			} else {
			}
			return null;
		}
		if (debug) {
			al_print("XmlItr::getNodeAsText: next xpath = " + xml_itr2.xpath + "\n");
		} else {
		}
	}
	{
		var list body;
		var file out;
		if (body = al_dst_node(tag, "!body")) {
			value = al_copy("");
			out = al_file_open(value, "sw");
			if (al_xml("generate", out, body, al_cons(2, null))) {
				return null;
			} else {
			}
			loop {
				xml_itr2.Next();
				var integer idx;
				idx = al_search_str(xml_itr2.xpath, 0, xpath);
				if (idx < 0) {
					break;
				} else {
				}
			}
			xml_itr2.value = value;
		} else {
			xml_itr2.value = ctrl_a;
		}
	}
	Copy(xml_itr2);
	if (debug) {
		al_print("XmlItr::getNodeAsText: found: value = " + (string)value + "\n");
	} else {
	}
	return 1;
}
end_body
member
public: XmlItr Copy();
body
{
	return al_copy(this);
}
end_body
member
public: void Copy(XmlItr xml_itr);
body
{
	stack = xml_itr.stack;
	xpath = xml_itr.xpath;
	value = xml_itr.value;
	debug = xml_itr.debug;
}
end_body
end_class
class XmlValidator
member
public: list validate(list dtd, list xml);
body
{
	xml_debug();
	var list err;
	dtd_itr = new DtdItr;
	dtd_itr.Reset(dtd);
	var XmlItr xml_itr;
	xml_itr = new XmlItr;
	if (debug2) {
		xml_itr.debug = 1;
	} else {
	}
	xml_itr.Reset(xml);
	if (save) {
		Begin();
	} else {
	}
	read_tag_count = 0;
	read_elem_count = read_tag_count;
	read_recursive_tag_count = 0;
	if (err = validate1(xml_itr)) {
		return err;
	} else {
	}
	if (dtd_itr.type != "end") {
		return "xml is not enough: xpath = \"" + dtd_itr.abs_xpath + "\"";
	} else {
	}
	if (save) {
		End();
	} else {
	}
	return null;
}
end_body
member
public: list validate1(XmlItr xml_itr);
body
{
	var list err;
	var string type, abs_xpath, attr, opt;
	var integer count, read_tag_count_save, read_recursive_tag_count_save;
	var XmlItr xml_itr2, xml_itr3;
	loop {
		type = dtd_itr.Next(null);
		if (al_dst_node(dtd_itr.node, "$recursive") && dtd_itr.node.tail.tail.head) {
			read_recursive_tag_count = read_recursive_tag_count + 1;
		} else {
		}
		if (type == "end_optional" || type == "end_repetition" || type == "end_case" || type == "end_all_opt" || type == "end") {
			return null;
		} else {
		}
		abs_xpath = dtd_itr.abs_xpath;
		attr = dtd_itr.attr;
		opt = dtd_itr.opt;
		if (type == "repetition") {
			var string prev_rept_xpath;
			var list brk_rep, all_opt;
			if (debug) {
				al_print("Enter repetition: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			if (stack) {
				prev_rept_xpath = stack.head.tail.tail.tail.tail.tail.tail.tail.head;
			} else {
			}
			all_opt = (dtd_itr.node.tail.tail.head && dtd_itr.node.tail.tail.tail.tail.head);
			if (save) {
				BeginRepetition(abs_xpath, dtd_itr.rel_xpath);
			} else {
			}
			count = 0;
			loop {
				read_tag_count_save = read_tag_count;
				read_elem_count = read_tag_count;
				if (debug) {
					al_print("repetition: count = " + (string)(count + 1) + "\n\n");
				} else {
				}
				xml_itr2 = xml_itr.Copy();
				if (xml_itr2.getNext(prev_rept_xpath, abs_xpath, attr)) {
					xml_itr3 = xml_itr.Copy();
					xml_itr3.Next3(prev_rept_xpath);
					if (err = validate1(xml_itr3)) {
						brk_rep = 1;
					} else {
						xml_itr.Copy(xml_itr3);
						if (read_tag_count == read_tag_count_save) {
							if (all_opt) {
								xml_itr.Copy(xml_itr2);
							} else {
								xml_itr.Next();
								brk_rep = 1;
							}
						} else {
							if (read_elem_count == read_tag_count_save) {
								if (all_opt) {
									xml_itr.Copy(xml_itr2);
								} else {
								}
							} else {
							}
						}
					}
				} else {
					brk_rep = 1;
				}
				if (brk_rep) {
					if (count == 0) {
						if (opt != "*") {
							if (save) {
								BreakRepetition();
							} else {
							}
							if (debug) {
								al_print("Leave repetition(no item(a) at +): xpath = " + abs_xpath + "\n\n");
							} else {
							}
							return "repetition xpath \"" + abs_xpath + "\" requrired.";
						} else {
						}
					} else {
					}
					dtd_itr.BreakRepetition();
					if (save) {
						BreakRepetition();
					} else {
					}
					break;
				} else {
				}
				count = count + 1;
				dtd_itr.ContinueRepetition();
				if (save) {
					ContinueRepetition();
				} else {
				}
			}
			if (debug) {
				al_print("Leave repetition: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			continue;
		} else {
		}
		if (type == "optional") {
			if (debug) {
				al_print("Enter optional: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			var string tmp_str;
			read_tag_count_save = read_tag_count;
			tmp_str = dtd_itr.abs_xpath;
			xml_itr2 = xml_itr.Copy();
			var list found, skip;
			if (xml_itr2.getNext(abs_xpath, attr)) {
				xml_itr2 = xml_itr.Copy();
				if (validate1(xml_itr2)) {
					skip = 1;
				} else {
					if (read_tag_count == read_tag_count_save) {
					} else {
						xml_itr.Copy(xml_itr2);
						found = 1;
					}
				}
			} else {
				skip = 1;
			}
			if (found) {
				if (debug) {
					al_print("Leave optional(found): xpath = " + abs_xpath + "\n\n");
				} else {
				}
			} else {
				if (skip) {
					skip_optional();
				} else {
				}
				if (debug) {
					al_print("Leave optional(not found): xpath = " + abs_xpath + "\n\n");
				} else {
				}
			}
			continue;
		} else {
		}
		if (type == "choice") {
			if (debug) {
				al_print("Enter choice: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			var integer num;
			num = 0;
			loop {
				type = dtd_itr.Next((list)1);
				if (type == "choice") {
					skip_choice();
				} else {
				}
				if (type == "end_choice") {
					if (opt != "?") {
						return "choice xpath \"" + abs_xpath + "\" requrired.";
					} else {
					}
					break;
				} else {
				}
				if (type == "case") {
					if (debug) {
						al_print("Enter choice_case: xpath = " + abs_xpath + "\n\n");
					} else {
					}
					read_tag_count_save = read_tag_count;
					read_recursive_tag_count_save = read_recursive_tag_count;
					var list found;
					xml_itr2 = xml_itr.Copy();
					if (xml_itr2.getNext(abs_xpath, attr)) {
						xml_itr2 = xml_itr.Copy();
						if (validate1(xml_itr2)) {
						} else {
							if (read_tag_count == read_tag_count_save && read_recursive_tag_count > read_recursive_tag_count_save) {
							} else {
								xml_itr.Copy(xml_itr2);
								found = 1;
							}
						}
					} else {
					}
					if (found) {
						skip_choice();
						if (debug) {
							al_print("Leave choice_case(found): xpath = " + abs_xpath + "\n\n");
						} else {
						}
						break;
					} else {
						if (read_tag_count == read_tag_count_save && read_recursive_tag_count > read_recursive_tag_count_save) {
						} else {
							skip_case();
						}
						if (debug) {
							al_print("Leave choice_case(not found): xpath = " + abs_xpath + "\n\n");
						} else {
						}
					}
				} else {
				}
			}
			if (debug) {
				al_print("Leave choice: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			continue;
		} else {
		}
		if (type == "all_opt") {
			if (debug) {
				al_print("Enter all_opt: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			var string path;
			path = dtd_itr.rel_xpath;
			xml_itr2 = xml_itr.Copy();
			read_tag_count_save = read_tag_count;
			if (validate1(xml_itr2)) {
				skip_all_opt();
			} else {
				if (read_tag_count == read_tag_count_save) {
					var string null_str;
					if (xml_itr.getNext(abs_xpath, null_str)) {
						if (debug) {
							al_print("tag with all optional empty child: path = " + path + ", abs_xpath = " + abs_xpath + "\n\n");
						} else {
						}
						if (save) {
							putValue("0", path, ctrl_a);
						} else {
						}
						read_tag_count = read_tag_count + 1;
					} else {
					}
				} else {
					xml_itr.Copy(xml_itr2);
				}
			}
			if (debug) {
				al_print("Leave all_opt: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			continue;
		} else {
		}
		if (type == "attr") {
			var string p;
			if (dtd_itr.rel_xpath == "") {
				p = "@" + attr;
			} else {
				p = dtd_itr.rel_xpath + "/@" + attr;
			}
			xml_itr2 = xml_itr.Copy();
			if (xml_itr2.getNext(abs_xpath, attr)) {
				if (save) {
					putValue("0", p, xml_itr2.value);
				} else {
				}
				read_tag_count = read_tag_count + 1;
				if (debug) {
					al_print("attr: value = " + (string)xml_itr2.value + ", xpath = " + abs_xpath + "/@" + attr + "\n\n");
				} else {
				}
			} else {
				if (dtd_itr.node.tail.tail.tail.head == "#REQUIRED") {
					if (debug) {
						al_print("attr(not found): xpath = " + abs_xpath + "/@" + attr + "\n\n");
					} else {
					}
					return "xpath \"" + abs_xpath + "\" requrired.";
				} else {
				}
			}
			continue;
		} else {
		}
		if (type == "elem") {
			if (xml_itr.getNext(abs_xpath, attr)) {
				if (xml_itr.value) {
					if (save) {
						putValue("0", dtd_itr.rel_xpath, xml_itr.value);
					} else {
					}
				} else {
					if (opt != "?") {
						if (debug) {
							al_print("elem(not found): xpath = " + abs_xpath + "\n\n");
						} else {
						}
						return "xpath \"" + abs_xpath + "\" requrired.";
					} else {
					}
				}
				read_tag_count = read_tag_count + 1;
				read_elem_count = read_elem_count + 1;
				if (debug) {
					al_print("elem: value = " + (string)xml_itr.value + ", xpath = " + abs_xpath + "\n\n");
				} else {
				}
			} else {
				if (opt != "?") {
					if (debug) {
						al_print("elem(not found): xpath = " + abs_xpath + "\n\n");
					} else {
					}
					return "xpath \"" + abs_xpath + "\" requrired.";
				} else {
				}
			}
			continue;
		} else {
		}
		if (type == "as_text") {
			if (xml_itr.getNodeAsText(abs_xpath)) {
				if (save && xml_itr.value) {
					putValue("0", dtd_itr.rel_xpath, xml_itr.value);
				} else {
				}
				read_tag_count = read_tag_count + 1;
				if (debug) {
					al_print("as_text: value = " + (string)xml_itr.value + ", xpath = " + abs_xpath + "\n\n");
				} else {
				}
			} else {
				if (opt != "?") {
					if (debug) {
						al_print("as_text(not found): xpath = " + abs_xpath + "\n\n");
					} else {
					}
					return "xpath \"" + abs_xpath + "\" requrired.";
				} else {
				}
			}
			continue;
		} else {
		}
	}
}
end_body
member
public: void save;
member
public: void Begin();
body
{
	dataId = getMsgId();
	if (msgId) {
	} else {
		msgId = dataId;
	}
	parentId = "0";
	if (msgType && msgVersion) {
		tagId = msgType + "-" + msgVersion;
	} else {
		tagId = "0";
	}
	child_seq = field_seq = 0;
	values = al_cons(null, null);
}
end_body
member
public: void End();
body
{
	Flush();
}
end_body
member
public: void BeginRepetition(string abs_xpath, string xpath);
body
{
	var list info;
	child_seq = child_seq + 1;
	info = al_list8(dataId, parentId, tagId, child_seq, field_seq, values, null, abs_xpath);
	stack = al_cons(info, stack);
	parentId = dataId;
	dataId = dataId + "c" + XmlDbAccessor::digit5(child_seq);
	tagId = stack.head.tail.tail.tail.tail.tail.tail.head = XPath2TagId(xpath);
	child_seq = field_seq = 0;
	values = al_cons(null, null);
}
end_body
member
public: void ContinueRepetition();
body
{
	Flush();
	child_seq = stack.head.tail.tail.tail.head;
	child_seq = child_seq + 1;
	stack.head.tail.tail.tail.head = child_seq;
	parentId = stack.head.head;
	dataId = stack.head.head + "c" + XmlDbAccessor::digit5(child_seq);
	tagId = stack.head.tail.tail.tail.tail.tail.tail.head;
	child_seq = field_seq = 0;
	values = al_cons(null, null);
}
end_body
member
public: void BreakRepetition();
body
{
	var list info;
	info = stack.head;
	dataId = info.head;
	parentId = info.tail.head;
	tagId = info.tail.tail.head;
	child_seq = info.tail.tail.tail.head;
	field_seq = info.tail.tail.tail.tail.head;
	values = info.tail.tail.tail.tail.tail.head;
	stack = stack.tail;
}
end_body
member
public: string getMsgId();
body
{
	return "1";
}
end_body
member
public: string msgType;
member
public: string msgVersion;
member
public: string putValue(string kind, string xpath, string value);
body
{
	if (kind == "0") {
		al_create_arc(values, value, xpath);
	} else {
	}
}
end_body
member
public: void Flush();
body
{
	var list itr;
	var string path2, value2, dataId2;
	itr = al_dst_itr(values);
	loop {
		if (value2 = al_next(itr)) {
		} else {
			break;
		}
		path2 = al_arc_a(itr);
		dataId2 = dataId + "f" + XmlDbAccessor::digit5(field_seq = field_seq + 1);
		value2 = al_str_misc("to_csv_string", value2, null);
		al_print("F," + dataId2 + "," + msgId + "," + dataId + "," + value2 + "," + path2 + "\n");
	}
	al_print("C," + dataId + "," + msgId + "," + parentId + ",," + tagId + "\n");
}
end_body
member
public: string XPath2TagId(string xpath);
body
{
	return xpath;
}
end_body
member
public: string dataId;
member
public: string msgId;
member
public: string parentId;
member
public: string tagId;
member
public: integer child_seq;
member
public: integer field_seq;
member
public: string last_repetition_xpath;
member
public: list values;
member
public: list stack;
member
public: integer read_tag_count;
member
public: integer read_elem_count;
member
public: integer read_recursive_tag_count;
class SimpleXml2Db
member
public: void Begin();
body
{
	if (msgType) {
	} else {
		msgType = "default";
	}
	if (msgVersion) {
	} else {
		msgVersion = "default";
	}
	createXPathTagIdMap();
	XmlValidator::Begin();
}
end_body
member
public: void End();
body
{
	XmlValidator::End();
}
end_body
member
public: void BeginRepetition(string abs_xpath, string xpath);
body
{
	XmlValidator::BeginRepetition(abs_xpath, xpath);
}
end_body
member
public: void ContinueRepetition();
body
{
	XmlValidator::ContinueRepetition();
}
end_body
member
public: void BreakRepetition();
body
{
	XmlValidator::BreakRepetition();
}
end_body
member
public: string getMsgId();
body
{
	if (acc) {
	} else {
		acc = new XmlDbAccessor;
		acc.create(msgType, msgVersion, conn);
	}
	return acc.getMsgId();
}
end_body
member
public: string putValue(string kind, string xpath, string value);
body
{
	if (content_validate) {
		var list t, d;
		var string e;
		if (t = al_dst_node(dtd_itr.node, "$type")) {
			if (al_xml("type_check", value, t, null)) {
				e = "dictionary type check error, value = " + (value == ctrl_a ? "" : value) + ", tag = " + dtd_itr.abs_xpath;
				if (validation_errors) {
					validation_errors = validation_errors + "; " + e;
				} else {
					validation_errors = e;
				}
				if (content_validation_report) {
					al_print("putXML: type check error: value = " + value + ", tag = " + dtd_itr.abs_xpath + ", type = " + (string)t + "\n");
				} else {
				}
			} else {
			}
		} else {
		}
		if (d = al_dst_node(dtd_itr.node, "$dic")) {
			if (al_xml("dic_check", value, d, null)) {
				e = "dictionary check error, value = " + (value == ctrl_a ? "" : value) + ", tag = " + dtd_itr.abs_xpath;
				if (validation_errors) {
					validation_errors = validation_errors + "; " + e;
				} else {
					validation_errors = e;
				}
				if (content_validation_report) {
					al_print("putXML: dic check error: value = " + value + ", tag = " + dtd_itr.abs_xpath + ", dic = " + (string)d + "\n");
				} else {
				}
			} else {
			}
		} else {
		}
	} else {
	}
	XmlValidator::putValue(kind, xpath, value);
}
end_body
member
public: void Flush();
body
{
	var string sql, path2, tagId2, value2, dataId2;
	var list itr;
	itr = al_dst_itr(values);
	loop {
		if (value2 = al_next(itr)) {
		} else {
			break;
		}
		if (al_strlen(value2) > XmlDbObject::MAX_VALUE_SIZE) {
			value2 = al_substr(value2, 0, XmlDbObject::MAX_VALUE_SIZE);
		} else {
		}
		path2 = al_arc_a(itr);
		tagId2 = XPath2TagId(path2);
		dataId2 = dataId + "f" + XmlDbAccessor::digit5(field_seq = field_seq + 1);
		sql = al_copy("");
		al_append_str(sql, "insert into MsgData (dataId,msgId,parentId,tagId,value) values('");
		al_append_str(sql, dataId2);
		al_append_str(sql, "','");
		al_append_str(sql, msgId);
		al_append_str(sql, "','");
		al_append_str(sql, dataId);
		al_append_str(sql, "','");
		al_append_str(sql, tagId2);
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(value2));
		al_append_str(sql, "')");
		conn.executeUpdate(sql);
	}
	sql = al_copy("");
	if (parentId == "0") {
		al_append_str(sql, "insert into ParentRelation (dataId,msgId,msgType,msgVersion,dtdFile,parentId,tagId,fieldSeq,childSeq) values('");
	} else {
		al_append_str(sql, "insert into ParentRelation (dataId,msgId,parentId,tagId,fieldSeq,childSeq) values('");
	}
	al_append_str(sql, dataId);
	al_append_str(sql, "','");
	al_append_str(sql, msgId);
	al_append_str(sql, "','");
	if (parentId == "0") {
		al_append_str(sql, DbUtility::convChar(msgType));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(msgVersion));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(acc._dtd_filename));
		al_append_str(sql, "','");
	} else {
	}
	al_append_str(sql, parentId);
	al_append_str(sql, "','");
	al_append_str(sql, tagId);
	al_append_str(sql, "','");
	al_append_str(sql, (string)field_seq);
	al_append_str(sql, "','");
	al_append_str(sql, (string)child_seq);
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
}
end_body
member
public: string getTagId();
body
{
	if (acc) {
	} else {
		acc = new XmlDbAccessor;
		acc.create(msgType, msgVersion, conn);
	}
	return acc.getTagId();
}
end_body
member
public: string XPath2TagId(string xpath);
body
{
	if (acc) {
	} else {
		acc = new XmlDbAccessor;
		acc.create(msgType, msgVersion, conn);
	}
	return acc.XPath2TagId(xpath);
}
end_body
member
public: void createXPathTagIdMap();
body
{
	if (acc) {
	} else {
		acc = new XmlDbAccessor;
		acc.create(msgType, msgVersion, conn);
	}
	acc.createTagPathMap();
	map = acc.map;
}
end_body
member
public: list map;
member
public: DbConnection conn;
member
public: string db_type;
member
public: XmlDbAccessor acc;
end_class
end_class
class XmlComposer
member
public: list compose(list dtd);
body
{
	xml_debug();
	var list err;
	handler = new XmlComposerHandler;
	handler.debug = debug;
	handler.composer = this;
	if (err = Begin()) {
		return err;
	} else {
	}
	xml = al_copy("");
	out_str("<?xml version=\"1.0\" encoding=\"UTF-8\"?>");
	if (doctype && dtd_filename) {
		out_str("<!DOCTYPE ");
		out_str(doctype);
		out_str(" SYSTEM \"");
		out_str(dtd_filename);
		out_str("\">");
	} else {
	}
	dtd_itr = new DtdItr;
	dtd_itr.handler = handler;
	dtd_itr.Reset(dtd);
	read_tag_count = 0;
	if (err = compose1()) {
		clear();
		return err;
	} else {
	}
	if (dtd_itr.type != "end") {
		err = "data is not enough: xpath = \"" + dtd_itr.abs_xpath + "\"";
		clear();
		return err;
	} else {
	}
	clear();
	return null;
}
end_body
member
public: list compose1();
body
{
	var list err;
	var string type, abs_xpath, attr, opt, xml_save1, xml_save2;
	var integer count, read_tag_count_save;
	loop {
		type = dtd_itr.Next(null);
		if (al_dst_node(dtd_itr.node, "$recursive") && dtd_itr.node.tail.tail.head) {
			var string check_xpath;
			check_xpath = recursive_check_xpath(dtd_itr.abs_xpath);
			if (recursive_expand_tag_count) {
				if (count = al_dst_node(recursive_expand_tag_count, check_xpath)) {
					if (read_tag_count == count) {
						if (debug) {
							al_print("compose1: return; recursive tag '" + dtd_itr.abs_xpath + "' expanded although no tags are readed after last recursive tag is expanded.\n\n");
						} else {
						}
						return "recursive tag '" + dtd_itr.abs_xpath + "' expanded although no tags are readed after last recursive tag is expanded.";
					} else {
					}
				} else {
				}
			} else {
				recursive_expand_tag_count = al_cons(null, null);
			}
			al_set_dst_node(recursive_expand_tag_count, check_xpath, read_tag_count);
		} else {
		}
		if (type == "end_optional" || type == "end_repetition" || type == "end_case" || type == "end_all_opt" || type == "end") {
			return null;
		} else {
		}
		abs_xpath = dtd_itr.abs_xpath;
		attr = dtd_itr.attr;
		opt = dtd_itr.opt;
		if (type == "repetition") {
			if (debug) {
				al_print("Enter repetition: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			if (GetChildren(dtd_itr.rel_xpath)) {
			} else {
				if (opt != "*") {
					BreakRepetition();
					return "repetition xpath \"" + abs_xpath + "\" requrired.";
				} else {
					xml_save1 = xml;
					xml = null;
					dtd_itr.BreakRepetition();
					xml = xml_save1;
					BreakRepetition();
					continue;
				}
			}
			count = 0;
			loop {
				if (nextChild()) {
					if (GetFields()) {
					} else {
						BreakRepetition();
						return "data is not enough: xpath = \"" + dtd_itr.abs_xpath + "\"";
					}
					if (compose1()) {
						break;
					} else {
						count = count + 1;
						dtd_itr.ContinueRepetition();
						continue;
					}
				} else {
					break;
				}
			}
			if (count == 0) {
				if (opt != "*") {
					BreakRepetition();
					return "repetition xpath \"" + abs_xpath + "\" requrired.";
				} else {
				}
			} else {
				xml_save1 = xml;
				xml = null;
				dtd_itr.BreakRepetition();
				xml = xml_save1;
				BreakRepetition();
			}
			if (debug) {
				al_print("Leave repetition: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			continue;
		} else {
		}
		if (type == "optional") {
			var list found;
			if (debug) {
				al_print("Enter optional: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			var list recursive_expand_tag_count_save;
			read_tag_count_save = read_tag_count;
			recursive_expand_tag_count_save = al_copy(recursive_expand_tag_count);
			xml_save1 = xml;
			xml = al_copy("");
			if (compose1()) {
				handler.out_current_tag();
				skip_optional();
				xml = xml_save1;
				read_tag_count = read_tag_count_save;
				recursive_expand_tag_count = recursive_expand_tag_count_save;
			} else {
				if (read_tag_count > read_tag_count_save) {
					xml_save2 = xml;
					xml = xml_save1;
					out_str(xml_save2);
					found = 1;
				} else {
					xml = xml_save1;
				}
			}
			if (found) {
				if (debug) {
					al_print("Leave optional(found): xpath = " + abs_xpath + "\n\n");
				} else {
				}
			} else {
				if (debug) {
					al_print("Leave optional(not found): xpath = " + abs_xpath + "\n\n");
				} else {
				}
			}
			continue;
		} else {
		}
		if (type == "choice") {
			if (debug) {
				al_print("Enter choice: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			handler.out_current_tag();
			loop {
				type = dtd_itr.Next(null);
				if (type == "case") {
					break;
				} else {
				}
			}
			xml_save1 = xml;
			loop {
				xml = al_copy("");
				if (type == "case") {
					if (debug) {
						al_print("Enter choice_case: xpath = " + abs_xpath + "\n\n");
					} else {
					}
					read_tag_count_save = read_tag_count;
					var list found;
					if (compose1()) {
					} else {
						if (read_tag_count == read_tag_count_save) {
						} else {
							handler.out_current_tag();
							xml_save2 = xml;
							xml = xml_save1;
							out_str(xml_save2);
							found = 1;
						}
					}
					if (found) {
						xml_save1 = xml;
						xml = null;
						skip_choice();
						xml = xml_save1;
						if (debug) {
							al_print("Leave choice_case(found): xpath = " + abs_xpath + "\n\n");
						} else {
						}
						break;
					} else {
						if (read_tag_count == read_tag_count_save) {
						} else {
							xml = null;
							skip_case();
						}
						if (debug) {
							al_print("Leave choice_case(not found): xpath = " + abs_xpath + "\n\n");
						} else {
						}
					}
				} else {
				}
				type = dtd_itr.Next((list)1);
				if (type == "choice") {
					skip_choice();
				} else {
				}
				if (type == "end_choice") {
					if (opt != "?") {
						if (debug) {
							al_print("Leave choice(not found): xpath = " + abs_xpath + "\n\n");
						} else {
						}
						return "choice xpath \"" + abs_xpath + "\" requrired.";
					} else {
					}
					break;
				} else {
				}
			}
			if (debug) {
				al_print("Leave choice(found): xpath = " + abs_xpath + "\n\n");
			} else {
			}
			continue;
		} else {
		}
		if (type == "all_opt") {
			if (debug) {
				al_print("Enter all_opt: xpath = " + abs_xpath + "\n\n");
			} else {
			}
			var list all_opt, brk_all_opt;
			var string tag, path, xml_save;
			tag = dtd_itr.tag;
			path = dtd_itr.rel_xpath;
			if (getValue(path)) {
				all_opt = 1;
				handler.out_current_tag();
				read_tag_count = read_tag_count + 1;
				brk_all_opt = 1;
				if (debug) {
					al_print("elem(all opt): value = " + (string)value + ", xpath = " + abs_xpath + "\n\n");
				} else {
				}
			} else {
				if (compose1()) {
					brk_all_opt = 1;
				} else {
				}
			}
			if (brk_all_opt) {
				xml_save = xml;
				xml = al_copy("");
				skip_all_opt();
				xml = xml_save;
			} else {
			}
			if (all_opt) {
				handler.out_str("</");
				handler.out_str(tag);
				handler.out_str(">");
			} else {
			}
			if (debug) {
				al_print("Leave all_opt: xpath = " + path + ", abs_xpath = " + abs_xpath + "\n\n");
			} else {
			}
			continue;
		} else {
		}
		if (type == "attr") {
			if (dtd_itr.node.tail.tail.tail.head == "#FIXED" && al_dst_node(dtd_itr.node, "$scope") != "global") {
				value = dtd_itr.node.tail.tail.tail.tail.head;
				if (handler.current_attrs) {
				} else {
					handler.current_attrs = al_cons(null, null);
				}
				var string ns_name, ns_url, g_url;
				var list itr2;
				g_url = ns_url = al_dst_node(dtd_itr.node, "$namespace");
				itr2 = al_dst_itr(dtd_itr.ns_stack);
				if (ns_url || al_next(itr2) && ns_url = al_arc_a(itr2)) {
					if (ns_name = al_dst_node(dtd_itr.ns_stack, ns_url)) {
						if (handler && g_url) {
							if (al_dst_node(handler.ns_names, ns_url)) {
							} else {
								al_create_arc(handler.ns_names, ns_name, ns_url);
							}
						} else {
						}
					} else {
					}
				} else {
					if (handler) {
						ns_name = handler.ns_name;
					} else {
					}
				}
				if (ns_name && ns_name != "" && al_str_misc("starts_with", attr, "xmlns") == null) {
					al_create_arc(handler.current_attrs, al_list2(ns_name + ":" + attr, value), null);
				} else {
					al_create_arc(handler.current_attrs, al_list2(attr, value), null);
				}
				read_tag_count = read_tag_count + 1;
				if (debug) {
					al_print("attr: value = " + (string)value + ", xpath = " + abs_xpath + "/@" + attr + "\n\n");
				} else {
				}
				continue;
			} else {
			}
			var string p;
			if (dtd_itr.rel_xpath == "") {
				p = "@" + dtd_itr.attr;
			} else {
				p = dtd_itr.rel_xpath + "/@" + dtd_itr.attr;
			}
			if (getValue(p)) {
				if (handler.current_attrs) {
				} else {
					handler.current_attrs = al_cons(null, null);
				}
				var string ns_name, ns_url, g_url;
				var list itr2;
				g_url = ns_url = al_dst_node(dtd_itr.node, "$namespace");
				itr2 = al_dst_itr(dtd_itr.ns_stack);
				if (ns_url || al_next(itr2) && ns_url = al_arc_a(itr2)) {
					if (ns_name = al_dst_node(dtd_itr.ns_stack, ns_url)) {
						if (handler && g_url) {
							if (al_dst_node(handler.ns_names, ns_url)) {
							} else {
								al_create_arc(handler.ns_names, ns_name, ns_url);
							}
						} else {
						}
					} else {
					}
				} else {
					if (handler) {
						ns_name = handler.ns_name;
					} else {
					}
				}
				if (ns_name && ns_name != "" && al_str_misc("starts_with", attr, "xmlns") == null) {
					al_create_arc(handler.current_attrs, al_list2(ns_name + ":" + attr, value), null);
				} else {
					al_create_arc(handler.current_attrs, al_list2(attr, value), null);
				}
				read_tag_count = read_tag_count + 1;
				if (debug) {
					al_print("attr: value = " + (string)value + ", xpath = " + abs_xpath + "/@" + attr + "\n\n");
				} else {
				}
			} else {
				if (dtd_itr.node.tail.tail.tail.head == "#REQUIRED") {
					if (debug) {
						al_print("attr(not found): xpath = " + abs_xpath + "/@" + attr + "\n\n");
					} else {
					}
					return "xpath \"" + abs_xpath + "/@" + "\" requrired.";
				} else {
				}
			}
			continue;
		} else {
		}
		if (type == "elem") {
			if (getValue(dtd_itr.rel_xpath)) {
				if (handler.current_value) {
					al_print("%%% handler.current_value is not null.\n");
				} else {
				}
				if (handler.raw_current_value) {
					al_print("%%% handler.raw_current_value is not null.\n");
				} else {
				}
				if (value != ctrl_a) {
					handler.current_value = value;
				} else {
				}
				read_tag_count = read_tag_count + 1;
				if (debug) {
					al_print("elem: value = " + (string)value + ", xpath = " + abs_xpath + "\n\n");
				} else {
				}
			} else {
				if (debug) {
					al_print("elem(not found): xpath = " + abs_xpath + "\n\n");
				} else {
				}
				return "xpath \"" + abs_xpath + "\" requrired.";
			}
			continue;
		} else {
		}
		if (type == "as_text") {
			if (getValue(dtd_itr.rel_xpath)) {
				if (handler.current_value) {
					al_print("%%% handler.current_value is not null.\n");
				} else {
				}
				if (handler.raw_current_value) {
					al_print("%%% handler.raw_current_value is not null.\n");
				} else {
				}
				if (value != ctrl_a) {
					handler.raw_current_value = value;
				} else {
				}
				read_tag_count = read_tag_count + 1;
				if (debug) {
					al_print("as_text: value = " + (string)value + ", xpath = " + abs_xpath + "\n\n");
				} else {
				}
			} else {
				if (debug) {
					al_print("as_text(not found): xpath = " + abs_xpath + "\n\n");
				} else {
				}
				return "xpath \"" + abs_xpath + "\" requrired.";
			}
			continue;
		} else {
		}
	}
}
end_body
member
public: void clear();
body
{
	handler.composer = null;
	handler = null;
	dtd_itr.handler = null;
	dtd_itr = null;
}
end_body
member
public: string recursive_check_xpath(string xpath);
body
{
	var list ls, itr;
	var string last_tag, tag, check_xpath;
	ls = al_str_misc("split", xpath, '/');
	itr = al_dst_itr(ls);
	check_xpath = last_tag = al_prev(itr);
	loop {
		if (tag = al_prev(itr)) {
		} else {
			break;
		}
		if (tag == last_tag) {
			break;
		} else {
		}
		check_xpath = tag + "/" + check_xpath;
	}
	return check_xpath;
}
end_body
member
public: string doctype;
member
public: string dtd_filename;
member
public: string xml;
member
public: void out_str(string val);
body
{
	if (xml) {
		al_append_str(xml, val);
	} else {
	}
}
end_body
member
public: list Begin();
body
{
}
end_body
member
public: list GetFields();
body
{
}
end_body
member
public: list GetChildren(string path);
body
{
}
end_body
member
public: list nextChild();
body
{
}
end_body
member
public: void BreakRepetition();
body
{
}
end_body
member
public: string getValue(string path);
body
{
}
end_body
member
public: string msgType;
member
public: string msgVersion;
member
public: string value;
member
public: XmlComposerHandler handler;
member
public: integer read_tag_count;
member
public: list recursive_expand_tag_count;
class SimpleDb2Xml
member
public: list Begin();
body
{
	if (msgType) {
	} else {
		msgType = "default";
	}
	if (msgVersion) {
	} else {
		msgVersion = "default";
	}
	createTagIdPathMap();
	parentId = "0";
	tagId = msgType + "-" + msgVersion;
	var string path;
	if (GetChildren(path)) {
	} else {
		return "data not found: msgId = " + (string)msgId;
	}
	dataId = al_next(children);
	al_prev(children);
	if (GetFields()) {
	} else {
		return "data not found: msgId = " + (string)msgId;
	}
	return null;
}
end_body
member
public: list GetFields();
body
{
	var string sql, path2, tagId2, value2;
	var list rs, itr, rec;
	sql = al_copy("");
	al_append_str(sql, "select tagId, value from MsgData ");
	al_append_str(sql, "where msgId ='");
	al_append_str(sql, msgId);
	al_append_str(sql, "' and parentId='");
	al_append_str(sql, dataId);
	al_append_str(sql, "' order by dataId");
	rs = conn.executeQuery(2, sql);
	itr = al_dst_itr(rs);
	values = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		tagId2 = al_dst_node(rec, 1);
		value2 = al_dst_node(rec, 2);
		if (tagId2 && value2) {
		} else {
			break;
		}
		if (path2 = al_dst_node(map2, tagId2)) {
		} else {
			return null;
		}
		al_create_arc(values, value2, path2);
	}
	return 1;
}
end_body
member
public: list GetChildren(string path);
body
{
	var list info;
	info = al_list6(dataId, tagId, values, children, null, null);
	stack = al_cons(info, stack);
	var string sql, dataId2;
	if (path) {
		if (tagId = stack.head.tail.tail.tail.head = al_dst_node(map, path)) {
		} else {
			// return "not found tagId of path \'" + path + "\'";
			return null;
		}
	} else {
		tagId = stack.head.tail.tail.tail.head = msgType + "-" + msgVersion;
	}
	var list rs, itr, rec, ret;
	sql = al_copy("");
	al_append_str(sql, "select dataId from ParentRelation where msgId='");
	al_append_str(sql, msgId);
	al_append_str(sql, "' and parentId='");
	if (path) {
		al_append_str(sql, dataId);
	} else {
		al_append_str(sql, "0");
	}
	al_append_str(sql, "'  and tagId='");
	al_append_str(sql, tagId);
	al_append_str(sql, "' order by dataId");
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	children = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		dataId2 = al_dst_node(rec, 1);
		al_create_arc(children, dataId2, null);
		ret = 1;
	}
	children = stack.head.tail.tail.tail.tail.head = al_dst_itr(children);
	return ret;
}
end_body
member
public: list nextChild();
body
{
	children = stack.head.tail.tail.tail.tail.head;
	var list dataId2;
	if (dataId2 = al_next(children)) {
		dataId = dataId2;
		tagId = stack.head.tail.tail.tail.head;
		return 1;
	} else {
		return null;
	}
}
end_body
member
public: void BreakRepetition();
body
{
	var list info;
	info = stack.head;
	stack = stack.tail;
	dataId = info.head;
	tagId = info.tail.head;
	values = info.tail.tail.head;
	children = info.tail.tail.tail.head;
}
end_body
member
public: string getValue(string path);
body
{
	value = al_dst_node(values, path);
	if (value == ctrl_a) {
		value = "";
	} else {
	}
	if (content_validate) {
		var list t, d;
		var string e;
		if (t = al_dst_node(dtd_itr.node, "$type")) {
			if (al_xml("type_check", value, t, null)) {
				e = "dictionary type check error, value = " + value + ", tag = " + dtd_itr.abs_xpath;
				if (validation_errors) {
					validation_errors = validation_errors + "; " + e;
				} else {
					validation_errors = e;
				}
				if (content_validation_report) {
					al_print("getXML: type check error: value = " + value + ", tag = " + dtd_itr.abs_xpath + ", type = " + (string)t + "\n");
				} else {
				}
			} else {
			}
		} else {
		}
		if (d = al_dst_node(dtd_itr.node, "$dic")) {
			if (al_xml("dic_check", value, d, null)) {
				e = "dictionary check error, value = " + value + ", tag = " + dtd_itr.abs_xpath;
				if (validation_errors) {
					validation_errors = validation_errors + "; " + e;
				} else {
					validation_errors = e;
				}
				if (content_validation_report) {
					al_print("getXML: dic check error: value = " + value + ", tag = " + dtd_itr.abs_xpath + ", dic = " + (string)d + "\n");
				} else {
				}
			} else {
			}
		} else {
		}
	} else {
	}
	return value;
}
end_body
member
public: void createTagIdPathMap();
body
{
	if (acc) {
	} else {
		acc = new XmlDbAccessor;
		acc.create(msgType, msgVersion, conn);
	}
	acc.createTagPathMap();
	map = acc.map;
	map2 = acc.map2;
}
end_body
member
public: string dataId;
member
public: string msgId;
member
public: string parentId;
member
public: string tagId;
member
public: list values;
member
public: list children;
member
public: list stack;
member
public: list map;
member
public: list map2;
member
public: DbConnection conn;
member
public: string db_type;
member
public: XmlDbAccessor acc;
end_class
end_class
class XmlDataRetriver
member
public: void create(list tree);
body
{
	body_tree = tree;
}
end_body
member
public: list tag_tree;
member
public: list body_tree;
member
public: list itr;
member
public: string tag;
member
public: XmlDataRetriver getItr(string xpath);
body
{
	var list body_tree2, tag_tree2, tags, itr2;
	var string tag2;
	tag_tree2 = tag_tree;
	body_tree2 = body_tree;
	tags = al_str_misc("split", xpath, '/');
	itr2 = al_dst_itr(tags);
	loop {
		if (tag2 = al_next(itr2)) {
		} else {
			return null;
		}
		if (al_next(itr2)) {
			al_prev(itr2);
		} else {
			break;
		}
		if (tag_tree2 = al_dst_node(body_tree2, tag2)) {
		} else {
			return null;
		}
		if (body_tree2 = al_dst_node(tag_tree2, "!body")) {
		} else {
			return null;
		}
	}
	var XmlDataRetriver obj;
	obj = new XmlDataRetriver;
	obj.itr = al_dst_itr(body_tree2);
	obj.tag = tag2;
	return obj;
}
end_body
member
public: XmlDataRetriver getNext();
body
{
	var list tag_tree2, body_tree2;
	if (tag_tree2 = al_next_a(itr, tag)) {
	} else {
		return null;
	}
	if (body_tree2 = al_dst_node(tag_tree2, "!body")) {
	} else {
		return null;
	}
	var XmlDataRetriver obj;
	obj = new XmlDataRetriver;
	obj.tag_tree = tag_tree2;
	obj.body_tree = body_tree2;
	obj.itr = itr;
	obj.tag = tag;
	return obj;
}
end_body
member
public: string getValue(string xpath);
body
{
	var list body_tree2, tag_tree2, tags, itr2, param;
	var string tag2, text;
	tag_tree2 = tag_tree;
	body_tree2 = body_tree;
	tags = al_str_misc("split", xpath, '/');
	itr2 = al_dst_itr(tags);
	loop {
		if (tag2 = al_next(itr2)) {
		} else {
			return null;
		}
		if (al_next(itr2)) {
			al_prev(itr2);
		} else {
			break;
		}
		if (tag_tree2 = al_dst_node(body_tree2, tag2)) {
		} else {
			return null;
		}
		if (body_tree2 = al_dst_node(tag_tree2, "!body")) {
		} else {
			return null;
		}
	}
	if (al_strlen(tag2) > 0 && al_get_char(tag2, 0) == '@') {
		tag2 = al_substr(tag2, 1, al_strlen(tag2));
		if (param = al_dst_node(tag_tree2, tag2)) {
			text = param.head;
			return text == "" ? null : text;
		} else {
			return null;
		}
	} else {
		if (tag_tree2 = al_dst_node(body_tree2, tag2)) {
		} else {
			return null;
		}
		if (body_tree2 = al_dst_node(tag_tree2, "!body")) {
		} else {
			return null;
		}
		text = al_dst_node(body_tree2, "!text");
		return text == "" ? null : text;
	}
}
end_body
end_class
class XmlDbAccessor
member
public: void create(string msgType, string msgVersion, DbConnection conn);
body
{
	if (msgType && msgType != "") {
	} else {
		msgType = "default";
	}
	if (msgVersion && msgVersion != "") {
	} else {
		msgVersion = "default";
	}
	this.msgType = msgType;
	this.msgVersion = msgVersion;
	this.conn = conn;
	db_type = conn.db_type;
}
end_body
member
public: void setDTD(list dtd);
body
{
	_dtd = dtd;
}
end_body
member
public: void setDTDbase(string dtd_base);
body
{
	_dtd_base = dtd_base;
}
end_body
member
public: void setDTDfilename(string dtd_filename);
body
{
	_dtd_filename = dtd_filename;
}
end_body
member
public: void setContentValidationBase(string content_validation_base);
body
{
	_content_validation_base = content_validation_base;
}
end_body
member
public: void setContentValidation(list flag);
body
{
	content_validate = flag;
}
end_body
member
public: void setDocType(string doc_type);
body
{
	_doc_type = doc_type;
}
end_body
member
public: string putXML(string xml);
body
{
	var file in;
	var list parse_tree;
	var string msgId;
	in = al_file_open(xml, "sr");
	parse_tree = parseXML(in, null);
	return putXML(parse_tree, msgId);
}
end_body
member
public: string putXML(string xml, string msgId);
body
{
	var file in;
	var list parse_tree;
	in = al_file_open(xml, "sr");
	parse_tree = parseXML(in, null);
	return putXML(parse_tree, msgId);
}
end_body
member
public: string putXML(list parse_tree, string msgId);
body
{
	if (_dtd) {
	} else {
		if (_dtd_filename) {
		} else {
			if (_dtd_filename = getDTDfile(parse_tree)) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "xml: dtd required for XmlDbAccessor::putXML.";
				throw ex;
			}
		}
		if (_dtd_base) {
		} else {
			_dtd_base = dtd_base;
		}
		_dtd = loadDTD(_dtd_base + "/" + _dtd_filename);
		if (_content_validation_base) {
		} else {
			_content_validation_base = content_validation_base;
		}
		var string filename;
		filename = _content_validation_base + "/" + msgType + "-" + msgVersion + ".csv";
		if (al_file_manip("does_exist", filename, null)) {
			DtdLoader::attach_content_validation_data(_dtd, filename);
		} else {
		}
	}
	try {
		var SimpleXml2Db xml2db;
		xml2db = new SimpleXml2Db;
		xml2db.save = 1;
		xml2db.db_type = conn.db_type;
		xml2db.conn = conn;
		xml2db.acc = this;
		xml2db.msgType = msgType;
		xml2db.msgVersion = msgVersion;
		xml2db.msgId = msgId;
		xml2db.content_validate = content_validate;
		var list err;
		if (err = xml2db.validate(_dtd, parse_tree)) {
			var AlException ex;
			ex = new AlException;
			ex.msg = (string)err;
			throw ex;
		} else {
		}
		validation_errors = xml2db.validation_errors;
		return xml2db.msgId;
	} catch (AlException e) {
		e.msg = "xml: XmlDbAccessor::putXML: " + e.msg;
		throw e;
	}
}
end_body
member
public: string getXML(string msgId);
body
{
	if (_dtd) {
	} else {
		if (_dtd_filename) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "xml: dtd required for XmlDbAccessor::getXML.";
			throw ex;
		}
		if (_dtd_base) {
		} else {
			_dtd_base = dtd_base;
		}
		_dtd = loadDTD(_dtd_base + "/" + _dtd_filename);
		if (_content_validation_base) {
		} else {
			_content_validation_base = content_validation_base;
		}
		var string filename;
		filename = _content_validation_base + "/" + msgType + "-" + msgVersion + ".csv";
		if (al_file_manip("does_exist", filename, null)) {
			DtdLoader::attach_content_validation_data(_dtd, filename);
		} else {
		}
	}
	try {
		var SimpleDb2Xml db2xml;
		db2xml = new SimpleDb2Xml;
		db2xml.msgId = msgId;
		db2xml.db_type = conn.db_type;
		db2xml.conn = conn;
		db2xml.acc = this;
		db2xml.msgType = msgType;
		db2xml.msgVersion = msgVersion;
		db2xml.doctype = _doc_type;
		db2xml.dtd_filename = _dtd_filename;
		db2xml.content_validate = content_validate;
		var list err;
		if (err = db2xml.compose(_dtd)) {
			var AlException ex;
			ex = new AlException;
			ex.msg = (string)err;
			throw ex;
		} else {
		}
		validation_errors = db2xml.validation_errors;
		return db2xml.xml;
	} catch (AlException e) {
		e.msg = "xml: XmlDbAccessor::getXML: " + e.msg;
		throw e;
	}
}
end_body
member
public: XmlDbObject create();
body
{
	var string msgId;
	return create(msgId);
}
end_body
member
public: XmlDbObject create(string msgId);
body
{
	createFieldList();
	if (map && map2) {
	} else {
		createTagPathMap();
	}
	var XmlDbObject obj;
	obj = new XmlDbObject;
	obj.msgType = msgType;
	obj.msgVersion = msgVersion;
	obj.conn = conn;
	obj.db_type = db_type;
	obj.acc = this;
	obj.dataId = getMsgId();
	if (msgId) {
		obj.msgId = msgId;
	} else {
		obj.msgId = obj.dataId;
	}
	obj.parentId = "0";
	obj.tagId = msgType + "-" + msgVersion;
	obj.field_seq = obj.child_seq = 0;
	obj.values = al_cons(null, null);
	obj.fetched = 1;
	obj.xpath_list = xpath_list;
	obj.dtd_itr = dtd_itr;
	var string sql;
	sql = al_copy("");
	al_append_str(sql, "insert into ParentRelation (dataId,msgId,msgType,msgVersion,dtdFile,parentId,tagId,fieldSeq,childSeq) values('");
	al_append_str(sql, obj.dataId);
	al_append_str(sql, "','");
	al_append_str(sql, obj.msgId);
	al_append_str(sql, "','");
	al_append_str(sql, DbUtility::convChar(msgType));
	al_append_str(sql, "','");
	al_append_str(sql, DbUtility::convChar(msgVersion));
	al_append_str(sql, "','");
	al_append_str(sql, DbUtility::convChar(_dtd_filename));
	al_append_str(sql, "','");
	al_append_str(sql, obj.parentId);
	al_append_str(sql, "','");
	al_append_str(sql, obj.tagId);
	al_append_str(sql, "','");
	al_append_str(sql, (string)obj.field_seq);
	al_append_str(sql, "','");
	al_append_str(sql, (string)obj.child_seq);
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
	return obj;
}
end_body
member
public: XmlDbObject getMetaInfo();
body
{
	createFieldList();
	if (map && map2) {
	} else {
		createTagPathMap();
	}
	var XmlDbObject obj;
	obj = new XmlDbObject;
	obj.msgType = msgType;
	obj.msgVersion = msgVersion;
	obj.conn = conn;
	obj.db_type = db_type;
	obj.acc = this;
	obj.xpath_list = xpath_list;
	obj.dtd_itr = dtd_itr;
	return obj;
}
end_body
member
public: XmlDbObject get(string msgId);
body
{
	createFieldList();
	if (map && map2) {
	} else {
		createTagPathMap();
	}
	var string sql;
	var list rs, itr, rec;
	sql = al_copy("");
	al_append_str(sql, "select dataId, fieldSeq, childSeq from ParentRelation where msgId='");
	al_append_str(sql, msgId);
	al_append_str(sql, "' and parentId='0' and tagId='");
	al_append_str(sql, msgType + "-" + msgVersion);
	al_append_str(sql, "'");
	rs = conn.executeQuery(3, sql);
	itr = al_dst_itr(rs);
	if (rec = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "xml: XmlDbAccessor::get: record not found: msgId=" + (string)msgId;
		throw ex;
	}
	var XmlDbObject obj;
	obj = new XmlDbObject;
	obj.msgType = msgType;
	obj.msgVersion = msgVersion;
	obj.conn = conn;
	obj.db_type = db_type;
	obj.acc = this;
	obj.dataId = al_dst_node(rec, 1);
	obj.field_seq = (integer)al_dst_node(rec, 2);
	obj.child_seq = (integer)al_dst_node(rec, 3);
	obj.msgId = msgId;
	obj.parentId = obj.tagId = "0";
	obj.xpath_list = xpath_list;
	obj.dtd_itr = dtd_itr;
	return obj;
}
end_body
member
public: XmlDbObject getWithMsgTypeAndMsgVersion(string msgId);
body
{
	var string sql;
	var list rs, itr, rec;
	sql = al_copy("");
	al_append_str(sql, "select msgType, msgVersion, dtdFile, dataId, fieldSeq, childSeq from ParentRelation where msgId='");
	al_append_str(sql, msgId);
	al_append_str(sql, "' and parentId='0'");
	rs = conn.executeQuery(3, sql);
	itr = al_dst_itr(rs);
	loop {
		if (rec = al_next(itr)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "data not found: msgId = " + (string)msgId;
			throw ex;
		}
		msgType = al_dst_node(rec, 1);
		if (msgType == "Preamble" || msgType == "DeliveryHeader" || msgType == "ServiceHeader") {
			continue;
		} else {
		}
		msgVersion = al_dst_node(rec, 2);
		_dtd_filename = al_dst_node(rec, 3);
		var XmlDbAccessor acc;
		acc = new XmlDbAccessor;
		acc.create(msgType, msgVersion, conn);
		acc.setDTDfilename(_dtd_filename);
		acc.createFieldList();
		acc.createTagPathMap();
		var XmlDbObject obj;
		obj = new XmlDbObject;
		obj.msgType = msgType;
		obj.msgVersion = msgVersion;
		obj.conn = conn;
		obj.db_type = conn.db_type;
		obj.acc = acc;
		obj.dataId = al_dst_node(rec, 4);
		obj.field_seq = (integer)al_dst_node(rec, 5);
		obj.child_seq = (integer)al_dst_node(rec, 6);
		obj.msgId = msgId;
		obj.parentId = obj.tagId = "0";
		obj.xpath_list = acc.xpath_list;
		obj.dtd_itr = acc.dtd_itr;
		return obj;
	}
}
end_body
member
public: list getAll();
body
{
	return get((list)al_cons(null, null));
}
end_body
member
public: list get(string path, string value);
body
{
	var list cond;
	cond = al_cons(null, null);
	al_create_arc(cond, value, path);
	return get(cond);
}
end_body
member
public: list get(string path1, string value1, string path2, string value2);
body
{
	var list cond;
	cond = al_cons(null, null);
	al_create_arc(cond, value1, path1);
	al_create_arc(cond, value2, path2);
	return get(cond);
}
end_body
member
public: list get(string path1, string value1, string path2, string value2, string path3, string value3);
body
{
	var list cond;
	cond = al_cons(null, null);
	al_create_arc(cond, value1, path1);
	al_create_arc(cond, value2, path2);
	al_create_arc(cond, value3, path3);
	return get(cond);
}
end_body
member
public: list get(list cond);
body
{
	createFieldList();
	if (map && map2) {
	} else {
		createTagPathMap();
	}
	var string sql, path, value, tagId2;
	var list rs, itr, rec, ret;
	sql = al_copy("");
	al_append_str(sql, "select dataId, fieldSeq, childSeq, msgId from ParentRelation");
	al_append_str(sql, " where parentId='0' and tagId='");
	al_append_str(sql, msgType + "-" + msgVersion);
	al_append_str(sql, "'");
	itr = al_dst_itr(cond);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		path = al_arc_a(itr);
		if (tagId2 = XPath2TagId(path)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db accessor: can't find path '" + path + "' in (" + msgType + "," + msgVersion + ")";
			throw ex;
		}
		al_append_str(sql, " and dataId in (select parentId from MsgData where tagId='");
		al_append_str(sql, tagId2);
		if (isLike(value)) {
			al_append_str(sql, "' and value like '");
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
		} else {
			al_append_str(sql, "' and value='");
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
		}
	}
	al_append_str(sql, " order by dataId");
	if (count_max) {
		conn.setMaxResultSet(count_max);
	} else {
	}
	rs = conn.executeQuery(4, sql);
	conn.clearMaxResultSet();
	itr = al_dst_itr(rs);
	ret = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		var XmlDbObject obj;
		obj = new XmlDbObject;
		obj.msgType = msgType;
		obj.msgVersion = msgVersion;
		obj.conn = conn;
		obj.db_type = db_type;
		obj.acc = this;
		obj.dataId = al_dst_node(rec, 1);
		obj.field_seq = (integer)al_dst_node(rec, 2);
		obj.child_seq = (integer)al_dst_node(rec, 3);
		obj.msgId = al_dst_node(rec, 4);
		obj.parentId = obj.tagId = "0";
		obj.xpath_list = xpath_list;
		obj.dtd_itr = dtd_itr;
		al_create_arc(ret, obj, obj.dataId);
	}
	return ret;
}
end_body
member
public: list get(list cond, string range_path, string range_type, string from, string to, string orderby_path, string orderby_type, list desc);
body
{
	createFieldList();
	if (map && map2) {
	} else {
		createTagPathMap();
	}
	var string range_tagId, orderby_tagId;
	if (range_tagId = XPath2TagId(range_path)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "db accessor: can't find path '" + (string)range_path + "' in (" + msgType + "," + msgVersion + ")";
		throw ex;
	}
	if (orderby_path == null || orderby_tagId = XPath2TagId(orderby_path)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "db accessor: can't find path '" + (string)orderby_path + "' in (" + msgType + "," + msgVersion + ")";
		throw ex;
	}
	var string sql, path, value, tagId2;
	var list rs, itr, rec, ret;
	sql = al_copy("");
	if (orderby_tagId) {
		al_append_str(sql, "select p.dataId, p.fieldSeq, p.childSeq, p.msgId from ParentRelation p, MsgData r1, MsgData r2");
	} else {
		al_append_str(sql, "select p.dataId, p.fieldSeq, p.childSeq, p.msgId from ParentRelation p, MsgData r1");
	}
	al_append_str(sql, " where p.parentId='0' and p.tagId='");
	al_append_str(sql, msgType + "-" + msgVersion);
	al_append_str(sql, "' and p.dataId=r1.parentId and r1.tagId='");
	al_append_str(sql, range_tagId);
	al_append_str(sql, "'");
	if (range_type == "string") {
		al_append_str(sql, " and r1.value>='");
		al_append_str(sql, DbUtility::convChar(from));
		al_append_str(sql, "' and r1.value<='");
		al_append_str(sql, DbUtility::convChar(to));
		al_append_str(sql, "'");
	} else {
	}
	if (range_type == "integer") {
		al_append_str(sql, " and lpad(r1.value, 20, '0')>=lpad('");
		al_append_str(sql, DbUtility::convChar(from));
		al_append_str(sql, "', 20, '0') and lpad(r1.value, 20, '0')<=lpad('");
		al_append_str(sql, DbUtility::convChar(to));
		al_append_str(sql, "', 20, '0')");
	} else {
	}
	if (orderby_tagId) {
		al_append_str(sql, " and p.dataId=r2.parentId and r2.tagId='");
		al_append_str(sql, orderby_tagId);
		al_append_str(sql, "'");
	} else {
	}
	itr = al_dst_itr(cond);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		path = al_arc_a(itr);
		if (tagId2 = XPath2TagId(path)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db accessor: can't find path '" + path + "' in (" + msgType + "," + msgVersion + ")";
			throw ex;
		}
		al_append_str(sql, " and p.dataId in (select parentId from MsgData where tagId='");
		al_append_str(sql, tagId2);
		if (isLike(value)) {
			al_append_str(sql, "' and value like '");
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
		} else {
			al_append_str(sql, "' and value='");
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
		}
	}
	if (orderby_tagId) {
		if (orderby_type == "string") {
			if (desc == null) {
				al_append_str(sql, " order by r2.value");
			} else {
				al_append_str(sql, " order by r2.value desc");
			}
		} else {
		}
		if (orderby_type == "integer") {
			if (desc == null) {
				al_append_str(sql, " order by lpad(r2.value, 20, '0')");
			} else {
				al_append_str(sql, " order by lpad(r2.value, 20, '0') desc");
			}
		} else {
		}
	} else {
		if (desc == null) {
			al_append_str(sql, " order by p.dataId");
		} else {
			al_append_str(sql, " order by p.dataId desc");
		}
	}
	if (count_max) {
		conn.setMaxResultSet(count_max);
	} else {
	}
	rs = conn.executeQuery(4, sql);
	conn.clearMaxResultSet();
	itr = al_dst_itr(rs);
	ret = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		var XmlDbObject obj;
		obj = new XmlDbObject;
		obj.msgType = msgType;
		obj.msgVersion = msgVersion;
		obj.conn = conn;
		obj.db_type = db_type;
		obj.acc = this;
		obj.dataId = al_dst_node(rec, 1);
		obj.field_seq = (integer)al_dst_node(rec, 2);
		obj.child_seq = (integer)al_dst_node(rec, 3);
		obj.msgId = al_dst_node(rec, 4);
		obj.parentId = obj.tagId = "0";
		obj.xpath_list = xpath_list;
		obj.dtd_itr = dtd_itr;
		al_create_arc(ret, obj, obj.dataId);
	}
	return ret;
}
end_body
member
public: string msgType;
member
public: string msgVersion;
member
public: DbConnection conn;
member
public: string db_type;
member
public: list _dtd;
member
public: string _dtd_base;
member
public: string _content_validation_base;
member
public: string _dtd_filename;
member
public: string _doc_type;
member
public: void createTagPathMap();
body
{
	var string sql, tagId2, path2;
	var list rs, itr, rec;
	sql = al_copy("");
	al_append_str(sql, "select tagId, path from TagPathName where msgType='");
	al_append_str(sql, msgType);
	al_append_str(sql, "' and msgVersion='");
	al_append_str(sql, msgVersion);
	al_append_str(sql, "'");
	rs = conn.executeQuery(2, sql);
	itr = al_dst_itr(rs);
	map = al_cons(null, null);
	map2 = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		tagId2 = al_dst_node(rec, 1);
		if (path2 = al_dst_node(rec, 2)) {
		} else {
			path2 = al_copy("");
		}
		al_create_arc(map, tagId2, path2);
		al_create_arc(map2, path2, tagId2);
	}
}
end_body
member
public: string getTagId();
body
{
	return conn.getNextSeq("tagId_seq");
}
end_body
member
public: string XPath2TagId(string xpath);
body
{
	var string sql, tagId2;
	if (map) {
	} else {
		createTagPathMap();
	}
	if (tagId2 = al_dst_node(map, xpath)) {
		return tagId2;
	} else {
	}
	tagId2 = getTagId();
	sql = al_copy("");
	al_append_str(sql, "insert into TagPathName (tagId,path,msgType,msgVersion) values ('");
	al_append_str(sql, tagId2);
	al_append_str(sql, "','");
	al_append_str(sql, xpath);
	al_append_str(sql, "','");
	al_append_str(sql, msgType);
	al_append_str(sql, "','");
	al_append_str(sql, msgVersion);
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
	al_create_arc(map, tagId2, xpath);
	return tagId2;
}
end_body
member
public: list map;
member
public: list map2;
member
public: string getMsgId();
body
{
	return conn.getNextSeq("msgId_seq");
}
end_body
member
public: static string digit5(integer val);
body
{
	if (val < 10) {
		return "0000" + (string)val;
	} else {
	}
	if (val < 100) {
		return "000" + (string)val;
	} else {
	}
	if (val < 1000) {
		return "00" + (string)val;
	} else {
	}
	if (val < 10000) {
		return "0" + (string)val;
	} else {
	}
	return (string)val;
}
end_body
member
public: void createFieldList();
body
{
	if (xpath_list) {
		return;
	} else {
	}
	if (_dtd) {
	} else {
		if (_dtd_base) {
		} else {
			_dtd_base = dtd_base;
		}
		if (_dtd_filename) {
			_dtd = loadDTD(_dtd_base + "/" + _dtd_filename);
		} else {
		}
	}
	if (_dtd) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "xml: dtd is null.";
		throw ex;
	}
	dtd_itr = new DtdItr;
	dtd_itr.Reset(_dtd);
	xpath_list = dtd_itr.getFieldList();
}
end_body
member
public: list xpath_list;
member
public: DtdItr dtd_itr;
member
public: integer count_max;
class XmlDbTableAccessor
member
public: string putXML(list parse_tree, string msgId);
body
{
	var AlException ex;
	ex = new AlException;
	ex.msg = "XmlDbTableAccessor::putXML not implemented.";
	throw ex;
}
end_body
member
public: string getXML(string msgId);
body
{
	var AlException ex;
	ex = new AlException;
	ex.msg = "XmlDbTableAccessor::getXML not implemented.";
	throw ex;
}
end_body
member
public: XmlDbObject create();
body
{
	var AlException ex;
	ex = new AlException;
	ex.msg = "XmlDbTableAccessor::create not implemented.";
	throw ex;
}
end_body
member
public: XmlDbObject create(string msgId);
body
{
	var AlException ex;
	ex = new AlException;
	ex.msg = "XmlDbTableAccessor::create not implemented.";
	throw ex;
}
end_body
member
public: XmlDbObject get(string msgId);
body
{
	createFieldList2();
	var list itr, rs, rec, pkey_values;
	var string name, sql;
	itr = al_dst_itr(pkey_names);
	name = al_next(itr);
	sql = al_copy("select ");
	al_append_str(sql, name);
	al_append_str(sql, " from ");
	al_append_str(sql, table_name);
	al_append_str(sql, " where ");
	al_append_str(sql, name);
	al_append_str(sql, "='");
	al_append_str(sql, DbUtility::convChar(msgId));
	al_append_str(sql, "'");
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	if (rec = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "xml: XmlDbAccessor::get: record not found: msgId=" + (string)msgId;
		throw ex;
	}
	var XmlDbTableObject obj;
	obj = new XmlDbTableObject;
	obj.msgType = msgType;
	obj.msgVersion = msgVersion;
	obj.conn = conn;
	obj.db_type = db_type;
	obj.acc = this;
	obj.pkey_values = pkey_values = al_cons(null, null);
	al_create_arc(pkey_values, msgId, name);
	obj.xpath_list = xpath_list;
	obj.rev_xpath_list = rev_xpath_list;
	obj.table_name = table_name;
	obj.dtd_itr = dtd_itr;
	obj.dataId = msgId;
	return obj;
}
end_body
member
public: list get(list cond);
body
{
	createFieldList2();
	var string sql, name, path, value, dataId;
	var list first, itr, rs, rec, ret;
	var list itr2, pkey_values;
	var integer num_cols;
	sql = al_copy("");
	al_append_str(sql, "select ");
	itr = al_dst_itr(pkey_names);
	first = 1;
	num_cols = 0;
	loop {
		if (name = al_next(itr)) {
		} else {
			break;
		}
		if (first) {
			first = null;
		} else {
			al_append_str(sql, ",");
		}
		al_append_str(sql, name);
		num_cols = num_cols + 1;
	}
	al_append_str(sql, " from ");
	al_append_str(sql, table_name);
	itr = al_dst_itr(cond);
	first = 1;
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		path = al_arc_a(itr);
		if (name = al_dst_node(xpath_list, path)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db accessor: can't find path '" + path + "' in (" + msgType + "," + msgVersion + ")";
			throw ex;
		}
		if (first) {
			first = null;
			al_append_str(sql, " where ");
		} else {
			al_append_str(sql, " and ");
		}
		al_append_str(sql, name);
		if (isLike(value)) {
			al_append_str(sql, " like '");
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "'");
		} else {
			al_append_str(sql, "='");
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "'");
		}
	}
	if (count_max) {
		conn.setMaxResultSet(count_max);
	} else {
	}
	rs = conn.executeQuery(num_cols, sql);
	conn.clearMaxResultSet();
	itr = al_dst_itr(rs);
	ret = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		var XmlDbTableObject obj;
		obj = new XmlDbTableObject;
		obj.msgType = msgType;
		obj.msgVersion = msgVersion;
		obj.conn = conn;
		obj.db_type = db_type;
		obj.acc = this;
		obj.pkey_values = pkey_values = al_cons(null, null);
		itr2 = al_dst_itr(pkey_names);
		num_cols = 0;
		dataId = "";
		loop {
			if (name = al_next(itr2)) {
			} else {
				break;
			}
			if (value = al_dst_node(rec, num_cols = num_cols + 1)) {
			} else {
				value = "";
			}
			if (dataId == "") {
				dataId = value;
			} else {
				dataId = dataId + ": " + value;
			}
			al_create_arc(pkey_values, value, name);
		}
		obj.xpath_list = xpath_list;
		obj.rev_xpath_list = rev_xpath_list;
		obj.table_name = table_name;
		obj.dtd_itr = dtd_itr;
		obj.dataId = dataId;
		al_create_arc(ret, obj, null);
	}
	return ret;
}
end_body
member
public: list get(list cond, string range_path, string range_type, string from, string to, string orderby_path, string orderby_type, list desc);
body
{
	createFieldList2();
	var string sql, name, path, value, dataId;
	var list first, itr, rs, rec, ret;
	var list itr2, pkey_values;
	var integer num_cols, i;
	sql = al_copy("");
	al_append_str(sql, "select ");
	itr = al_dst_itr(pkey_names);
	first = 1;
	num_cols = 0;
	loop {
		if (name = al_next(itr)) {
		} else {
			break;
		}
		if (first) {
			first = null;
		} else {
			al_append_str(sql, ",");
		}
		al_append_str(sql, name);
		num_cols = num_cols + 1;
	}
	al_append_str(sql, " from ");
	al_append_str(sql, table_name);
	al_append_str(sql, " where ");
	if (name = al_dst_node(xpath_list, range_path)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "db accessor: can't find path '" + path + "' in (" + msgType + "," + msgVersion + ")";
		throw ex;
	}
	if (range_type == "string") {
		al_append_str(sql, name);
		al_append_str(sql, ">='");
		al_append_str(sql, DbUtility::convChar(from));
		al_append_str(sql, "' and ");
		al_append_str(sql, name);
		al_append_str(sql, "<='");
		al_append_str(sql, DbUtility::convChar(to));
		al_append_str(sql, "'");
	} else {
	}
	if (range_type == "integer") {
		al_append_str(sql, "lpad(");
		al_append_str(sql, name);
		al_append_str(sql, ", 20, '0')>=lpad('");
		al_append_str(sql, DbUtility::convChar(from));
		al_append_str(sql, "', 20, '0') and lpad(");
		al_append_str(sql, name);
		al_append_str(sql, ", 20, '0')<=lpad('");
		al_append_str(sql, DbUtility::convChar(to));
		al_append_str(sql, "', 20, '0')");
	} else {
	}
	itr = al_dst_itr(cond);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		path = al_arc_a(itr);
		if (name = al_dst_node(xpath_list, path)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db accessor: can't find path '" + path + "' in (" + msgType + "," + msgVersion + ")";
			throw ex;
		}
		al_append_str(sql, " and ");
		al_append_str(sql, name);
		if (isLike(value)) {
			al_append_str(sql, " like '");
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "'");
		} else {
			al_append_str(sql, "='");
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "'");
		}
	}
	if (name = al_dst_node(xpath_list, orderby_path)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "db accessor: can't find path '" + path + "' in (" + msgType + "," + msgVersion + ")";
		throw ex;
	}
	if (orderby_type == "string") {
		al_append_str(sql, " order by ");
		al_append_str(sql, name);
		if (desc) {
			al_append_str(sql, " desc");
		} else {
		}
		itr = al_dst_itr(pkey_names);
		loop {
			if (name = al_next(itr)) {
			} else {
				break;
			}
			al_append_str(sql, ", lpad(");
			al_append_str(sql, name);
			al_append_str(sql, ", 20, '0')");
			if (desc) {
				al_append_str(sql, " desc");
			} else {
			}
		}
	} else {
	}
	if (orderby_type == "integer") {
		al_append_str(sql, " order by lpad(");
		al_append_str(sql, name);
		al_append_str(sql, ", 20, '0')");
		if (desc) {
			al_append_str(sql, " desc");
		} else {
		}
		itr = al_dst_itr(pkey_names);
		loop {
			if (name = al_next(itr)) {
			} else {
				break;
			}
			al_append_str(sql, ", lpad(");
			al_append_str(sql, name);
			al_append_str(sql, ", 20, '0')");
			if (desc) {
				al_append_str(sql, " desc");
			} else {
			}
		}
	} else {
	}
	if (count_max) {
		conn.setMaxResultSet(count_max);
	} else {
	}
	rs = conn.executeQuery(num_cols, sql);
	conn.clearMaxResultSet();
	itr = al_dst_itr(rs);
	ret = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		var XmlDbTableObject obj;
		obj = new XmlDbTableObject;
		obj.msgType = msgType;
		obj.msgVersion = msgVersion;
		obj.conn = conn;
		obj.db_type = db_type;
		obj.acc = this;
		obj.pkey_values = pkey_values = al_cons(null, null);
		itr2 = al_dst_itr(pkey_names);
		num_cols = 0;
		dataId = "";
		loop {
			if (name = al_next(itr2)) {
			} else {
				break;
			}
			if (value = al_dst_node(rec, num_cols = num_cols + 1)) {
			} else {
				value = "";
			}
			if (dataId == "") {
				dataId = value;
			} else {
				dataId = dataId + ": " + value;
			}
			al_create_arc(pkey_values, value, name);
		}
		obj.xpath_list = xpath_list;
		obj.rev_xpath_list = rev_xpath_list;
		obj.table_name = table_name;
		obj.dtd_itr = dtd_itr;
		obj.dataId = dataId;
		al_create_arc(ret, obj, null);
	}
	return ret;
}
end_body
member
public: void createFieldList2();
body
{
	if (xpath_list) {
		return;
	} else {
	}
	if (_dtd) {
	} else {
		if (_dtd_base) {
		} else {
			_dtd_base = dtd_base;
		}
		if (_dtd_filename) {
			_dtd = loadDTD(_dtd_base + "/" + _dtd_filename);
		} else {
		}
	}
	if (_dtd) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "xml: dtd is null.";
		throw ex;
	}
	dtd_itr = new DtdItr;
	dtd_itr.Reset(_dtd);
	var list ls;
	ls = dtd_itr.getFieldList2();
	xpath_list = ls.head;
	table_name = ls.tail.head;
	pkey_names = ls.tail.tail.head;
	rev_xpath_list = ls.tail.tail.tail.tail.head;
}
end_body
member
public: string table_name;
member
public: string pkey_names;
member
public: list rev_xpath_list;
end_class
end_class
class XmlDbObject
member
public: static integer MAX_VALUE_SIZE;
member
public: string msgType;
member
public: string msgVersion;
member
public: DbConnection conn;
member
public: string db_type;
member
public: XmlDbAccessor acc;
member
public: string dataId;
member
public: string msgId;
member
public: string parentId;
member
public: string tagId;
member
public: integer field_seq;
member
public: integer child_seq;
member
public: void putField(string path, string value);
body
{
	if (xpath_list) {
		if (al_dst_node(xpath_list, path)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db object: path not found: msgId=" + msgId + ", path = " + path;
			throw ex;
		}
	} else {
	}
	if (value == null || value == "") {
		removeField(path);
		return;
	} else {
	}
	fetch();
	if (al_strlen(value) > MAX_VALUE_SIZE) {
		value = al_substr(value, 0, MAX_VALUE_SIZE);
	} else {
	}
	var string dataId2, tagId2, sql;
	tagId2 = acc.XPath2TagId(path);
	sql = al_copy("");
	if (al_dst_node(values, path)) {
		al_append_str(sql, "update MsgData set value='");
		al_append_str(sql, DbUtility::convChar(value));
		al_append_str(sql, "' where msgId='");
		al_append_str(sql, msgId);
		al_append_str(sql, "' and parentId='");
		al_append_str(sql, dataId);
		al_append_str(sql, "' and tagId='");
		al_append_str(sql, tagId2);
		al_append_str(sql, "'");
		conn.executeUpdate(sql);
	} else {
		dataId2 = dataId + "f" + XmlDbAccessor::digit5(field_seq = field_seq + 1);
		al_append_str(sql, "insert into MsgData (dataId,msgId,parentId,tagId,value) values ('");
		al_append_str(sql, dataId2);
		al_append_str(sql, "','");
		al_append_str(sql, msgId);
		al_append_str(sql, "','");
		al_append_str(sql, dataId);
		al_append_str(sql, "','");
		al_append_str(sql, tagId2);
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(value));
		al_append_str(sql, "')");
		conn.executeUpdate(sql);
		sql = al_copy("");
		al_append_str(sql, "update ParentRelation set fieldSeq='");
		al_append_str(sql, (string)field_seq);
		al_append_str(sql, "' where dataId='");
		al_append_str(sql, dataId);
		al_append_str(sql, "'");
		conn.executeUpdate(sql);
	}
	al_set_dst_node(values, path, value);
}
end_body
member
public: void removeField(string path);
body
{
	fetch();
	var string tagId2, sql;
	tagId2 = acc.XPath2TagId(path);
	if (al_dst_node(values, path)) {
		sql = al_copy("");
		al_append_str(sql, "delete from MsgData");
		al_append_str(sql, " where msgId='");
		al_append_str(sql, msgId);
		al_append_str(sql, "' and parentId='");
		al_append_str(sql, dataId);
		al_append_str(sql, "' and tagId='");
		al_append_str(sql, tagId2);
		al_append_str(sql, "'");
		conn.executeUpdate(sql);
	} else {
	}
	al_set_dst_node(values, path, null);
}
end_body
member
public: XmlDbObject createChild(string path);
body
{
	var DtdItr child_dtd_itr;
	var list child_xpath_list;
	if (dtd_itr) {
		if (child_dtd_itr = dtd_itr.getChild(path)) {
			child_xpath_list = child_dtd_itr.getFieldList();
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db object: path not found: msgId=" + msgId + ", path = " + path;
			throw ex;
		}
	} else {
	}
	var string tagId2;
	tagId2 = acc.XPath2TagId(path);
	var XmlDbObject obj;
	obj = new XmlDbObject;
	obj.msgType = msgType;
	obj.msgVersion = msgVersion;
	obj.conn = conn;
	obj.db_type = db_type;
	obj.acc = acc;
	obj.dataId = dataId + "c" + XmlDbAccessor::digit5(child_seq = child_seq + 1);
	obj.msgId = msgId;
	obj.parentId = dataId;
	obj.tagId = tagId2;
	obj.field_seq = obj.child_seq = 0;
	obj.values = al_cons(null, null);
	obj.fetched = 1;
	if (child_dtd_itr) {
		obj.dtd_itr = child_dtd_itr.Copy();
		obj.xpath_list = child_xpath_list;
	} else {
	}
	var string sql;
	sql = al_copy("");
	al_append_str(sql, "insert into ParentRelation (dataId,msgId,parentId,tagId,fieldSeq,childSeq) values('");
	al_append_str(sql, obj.dataId);
	al_append_str(sql, "','");
	al_append_str(sql, obj.msgId);
	al_append_str(sql, "','");
	al_append_str(sql, obj.parentId);
	al_append_str(sql, "','");
	al_append_str(sql, obj.tagId);
	al_append_str(sql, "','");
	al_append_str(sql, (string)obj.field_seq);
	al_append_str(sql, "','");
	al_append_str(sql, (string)obj.child_seq);
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
	sql = al_copy("");
	al_append_str(sql, "update ParentRelation set childSeq='");
	al_append_str(sql, (string)child_seq);
	al_append_str(sql, "' where dataId='");
	al_append_str(sql, dataId);
	al_append_str(sql, "'");
	conn.executeUpdate(sql);
	return obj;
}
end_body
member
public: XmlDbObject getMetaInfo(string path);
body
{
	var DtdItr child_dtd_itr;
	var list child_xpath_list;
	if (dtd_itr) {
		if (child_dtd_itr = dtd_itr.getChild(path)) {
			child_xpath_list = child_dtd_itr.getFieldList();
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db object: path not found: path = " + path;
			throw ex;
		}
	} else {
	}
	var XmlDbObject obj;
	obj = new XmlDbObject;
	obj.msgType = msgType;
	obj.msgVersion = msgVersion;
	obj.conn = conn;
	obj.db_type = db_type;
	obj.acc = acc;
	if (child_dtd_itr) {
		obj.dtd_itr = child_dtd_itr.Copy();
		obj.xpath_list = child_xpath_list;
	} else {
	}
	return obj;
}
end_body
member
public: string getField(string path);
body
{
	if (xpath_list) {
		if (al_dst_node(xpath_list, path)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db object: path not found: msgId=" + msgId + ", path = " + path;
			throw ex;
		}
	} else {
	}
	fetch();
	var string val;
	val = al_dst_node(values, path);
	if (val == ctrl_a) {
		return "";
	} else {
	}
	return val;
}
end_body
member
public: list getChildren(string path);
body
{
	return getChildren(path, (list)al_cons(null, null));
}
end_body
member
public: list getChildren(string path, string path1, string value1);
body
{
	var list cond;
	cond = al_cons(null, null);
	al_create_arc(cond, value1, path1);
	return getChildren(path, cond);
}
end_body
member
public: list getChildren(string path, string path1, string value1, string path2, string value2);
body
{
	var list cond;
	cond = al_cons(null, null);
	al_create_arc(cond, value1, path1);
	al_create_arc(cond, value2, path2);
	return getChildren(path, cond);
}
end_body
member
public: list getChildren(string path, list cond);
body
{
	var DtdItr child_dtd_itr;
	var list child_xpath_list;
	if (dtd_itr) {
		if (child_dtd_itr = dtd_itr.getChild(path)) {
			child_xpath_list = child_dtd_itr.getFieldList();
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db object: path not found: msgId=" + msgId + ", path = " + path;
			throw ex;
		}
	} else {
	}
	var string sql, path2, value2, tagId2;
	var list children, rs, itr, rec;
	if (tagId2 = al_dst_node(acc.map, path)) {
	} else {
		return al_cons(null, null);
	}
	sql = al_copy("");
	al_append_str(sql, "select dataId, childSeq, fieldSeq from ParentRelation where msgId='");
	al_append_str(sql, msgId);
	al_append_str(sql, "' and parentId='");
	al_append_str(sql, dataId);
	al_append_str(sql, "' and tagId='");
	al_append_str(sql, tagId2);
	al_append_str(sql, "'");
	itr = al_dst_itr(cond);
	loop {
		if (value2 = al_next(itr)) {
		} else {
			break;
		}
		path2 = al_arc_a(itr);
		if (tagId2 = acc.XPath2TagId(path2)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db object: can't find path '" + path2 + "' in (" + msgType + "," + msgVersion + ")";
			throw ex;
		}
		al_append_str(sql, " and dataId in (select parentId from MsgData where msgId='");
		al_append_str(sql, msgId);
		al_append_str(sql, "' and tagId='");
		al_append_str(sql, tagId2);
		if (isLike(value2)) {
			al_append_str(sql, "' and value like '");
			al_append_str(sql, DbUtility::convChar(value2));
			al_append_str(sql, "')");
		} else {
			al_append_str(sql, "' and value='");
			al_append_str(sql, DbUtility::convChar(value2));
			al_append_str(sql, "')");
		}
	}
	al_append_str(sql, " order by dataId");
	if (count_max) {
		conn.setMaxResultSet(count_max);
	} else {
	}
	rs = conn.executeQuery(3, sql);
	conn.clearMaxResultSet();
	itr = al_dst_itr(rs);
	children = al_cons(null, null);
	var integer i;
	i = 0;
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		var XmlDbObject obj;
		obj = new XmlDbObject;
		obj.msgType = msgType;
		obj.msgVersion = msgVersion;
		obj.conn = conn;
		obj.db_type = db_type;
		obj.acc = acc;
		obj.dataId = al_dst_node(rec, 1);
		obj.msgId = msgId;
		obj.parentId = dataId;
		obj.tagId = tagId2;
		obj.child_seq = (integer)al_dst_node(rec, 2);
		obj.field_seq = (integer)al_dst_node(rec, 3);
		if (child_dtd_itr) {
			obj.dtd_itr = child_dtd_itr.Copy();
			obj.xpath_list = child_xpath_list;
		} else {
		}
		al_create_arc(children, obj, obj.dataId);
	}
	return children;
}
end_body
member
public: list getChildren(string path, list cond, string range_path, string range_type, string from, string to, string orderby_path, string orderby_type, list desc);
body
{
	var DtdItr child_dtd_itr;
	var list child_xpath_list;
	if (dtd_itr) {
		if (child_dtd_itr = dtd_itr.getChild(path)) {
			child_xpath_list = child_dtd_itr.getFieldList();
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db object: path not found: msgId=" + msgId + ", path = " + path;
			throw ex;
		}
	} else {
	}
	var string range_tagId, orderby_tagId;
	if (range_tagId = acc.XPath2TagId(range_path)) {
	} else {
		return al_cons(null, null);
	}
	if (orderby_path == null || orderby_tagId = acc.XPath2TagId(orderby_path)) {
	} else {
		return al_cons(null, null);
	}
	var string sql, path2, value2, tagId2;
	var list children, rs, itr, rec;
	if (tagId2 = al_dst_node(acc.map, path)) {
	} else {
		return al_cons(null, null);
	}
	sql = al_copy("");
	if (orderby_tagId) {
		al_append_str(sql, "select p.dataId, p.childSeq, p.fieldSeq from ParentRelation p, MsgData r1, MsgData r2");
	} else {
		al_append_str(sql, "select p.dataId, p.childSeq, p.fieldSeq from ParentRelation p, MsgData r1");
	}
	al_append_str(sql, " where p.msgId='");
	al_append_str(sql, msgId);
	al_append_str(sql, "' and p.parentId='");
	al_append_str(sql, dataId);
	al_append_str(sql, "' and p.tagId='");
	al_append_str(sql, tagId2);
	al_append_str(sql, "' and p.dataId=r1.parentId and r1.tagId='");
	al_append_str(sql, range_tagId);
	al_append_str(sql, "'");
	if (range_type == "string") {
		al_append_str(sql, " and r1.value>='");
		al_append_str(sql, DbUtility::convChar(from));
		al_append_str(sql, "' and r1.value<='");
		al_append_str(sql, DbUtility::convChar(to));
		al_append_str(sql, "'");
	} else {
	}
	if (range_type == "integer") {
		al_append_str(sql, " and lpad(r1.value, 20, '0')>=lpad('");
		al_append_str(sql, DbUtility::convChar(from));
		al_append_str(sql, "', 20, '0') and lpad(r1.value, 20, '0')<=lpad('");
		al_append_str(sql, DbUtility::convChar(to));
		al_append_str(sql, "', 20, '0')");
	} else {
	}
	if (orderby_tagId) {
		al_append_str(sql, " and p.dataId=r2.parentId and r2.tagId='");
		al_append_str(sql, orderby_tagId);
		al_append_str(sql, "'");
	} else {
	}
	itr = al_dst_itr(cond);
	loop {
		if (value2 = al_next(itr)) {
		} else {
			break;
		}
		path2 = al_arc_a(itr);
		if (tagId2 = acc.XPath2TagId(path2)) {
		} else {
			return al_cons(null, null);
		}
		al_append_str(sql, " and p.dataId in (select parentId from MsgData where msgId='");
		al_append_str(sql, msgId);
		al_append_str(sql, "' and tagId='");
		al_append_str(sql, tagId2);
		if (isLike(value2)) {
			al_append_str(sql, "' and value like '");
			al_append_str(sql, DbUtility::convChar(value2));
			al_append_str(sql, "')");
		} else {
			al_append_str(sql, "' and value='");
			al_append_str(sql, DbUtility::convChar(value2));
			al_append_str(sql, "')");
		}
	}
	if (orderby_tagId) {
		if (orderby_type == "string") {
			if (desc == null) {
				al_append_str(sql, " order by r2.value");
			} else {
				al_append_str(sql, " order by r2.value desc");
			}
		} else {
		}
		if (orderby_type == "integer") {
			if (desc == null) {
				al_append_str(sql, " order by lpad(r2.value, 20, '0')");
			} else {
				al_append_str(sql, " order by lpad(r2.value, 20, '0') desc");
			}
		} else {
		}
	} else {
		if (desc == null) {
			al_append_str(sql, " order by p.dataId");
		} else {
			al_append_str(sql, " order by p.dataId desc");
		}
	}
	if (count_max) {
		conn.setMaxResultSet(count_max);
	} else {
	}
	rs = conn.executeQuery(3, sql);
	conn.clearMaxResultSet();
	itr = al_dst_itr(rs);
	children = al_cons(null, null);
	var integer i;
	i = 0;
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		var XmlDbObject obj;
		obj = new XmlDbObject;
		obj.msgType = msgType;
		obj.msgVersion = msgVersion;
		obj.conn = conn;
		obj.db_type = db_type;
		obj.acc = acc;
		obj.dataId = al_dst_node(rec, 1);
		obj.msgId = msgId;
		obj.parentId = dataId;
		obj.tagId = tagId2;
		obj.child_seq = (integer)al_dst_node(rec, 2);
		obj.field_seq = (integer)al_dst_node(rec, 3);
		if (child_dtd_itr) {
			obj.dtd_itr = child_dtd_itr.Copy();
			obj.xpath_list = child_xpath_list;
		} else {
		}
		al_create_arc(children, obj, obj.dataId);
	}
	return children;
}
end_body
member
public: void fetch();
body
{
	if (fetched) {
		return;
	} else {
	}
	var string sql, path2, tagId2, value2;
	var list rs, itr, rec;
	sql = al_copy("");
	al_append_str(sql, "select tagId, value from MsgData ");
	al_append_str(sql, "where msgId ='");
	al_append_str(sql, msgId);
	al_append_str(sql, "' and parentId='");
	al_append_str(sql, dataId);
	al_append_str(sql, "' order by dataId");
	rs = conn.executeQuery(2, sql);
	itr = al_dst_itr(rs);
	values = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		tagId2 = al_dst_node(rec, 1);
		value2 = al_dst_node(rec, 2);
		if (tagId2 && value2) {
		} else {
			break;
		}
		if (path2 = al_dst_node(acc.map2, tagId2)) {
		} else {
			var AlException ex;
			ex.msg = "db object: path of tagId not found: msgId=" + msgId + ", tagId = " + tagId2;
			ex = new AlException;
			throw ex;
		}
		al_create_arc(values, value2, path2);
	}
	fetched = 1;
}
end_body
member
public: list values;
member
public: void delete();
body
{
	var string sql, path;
	var list child_list, itr, ls, itr2;
	var XmlDbObject obj;
	child_list = dtd_itr.getChildList();
	itr = al_dst_itr(child_list);
	loop {
		if (path = al_next(itr)) {
		} else {
			break;
		}
		ls = getChildren(path);
		itr2 = al_dst_itr(ls);
		loop {
			if (obj = al_next(itr2)) {
			} else {
				break;
			}
			obj.delete();
		}
	}
	sql = al_copy("");
	al_append_str(sql, "delete from MsgData where parentId='");
	al_append_str(sql, dataId);
	al_append_str(sql, "'");
	conn.executeUpdate(sql);
	sql = al_copy("");
	al_append_str(sql, "delete from ParentRelation where dataId='");
	al_append_str(sql, dataId);
	al_append_str(sql, "'");
	conn.executeUpdate(sql);
}
end_body
member
public: list fetched;
member
public: DtdItr dtd_itr;
member
public: list xpath_list;
member
public: integer count_max;
class XmlDbTableObject
member
public: void putField(string path, string value);
body
{
	var AlException ex;
	ex = new AlException;
	ex.msg = "XmlDbTableObject::putField not implemented.";
	throw ex;
}
end_body
member
public: void removeField(string path);
body
{
	var AlException ex;
	ex = new AlException;
	ex.msg = "XmlDbTableObject::removeField not implemented.";
	throw ex;
}
end_body
member
public: XmlDbObject createChild(string path);
body
{
	var AlException ex;
	ex = new AlException;
	ex.msg = "XmlDbTableObject::createChild not implemented.";
	throw ex;
}
end_body
member
public: void delete();
body
{
	var AlException ex;
	ex = new AlException;
	ex.msg = "XmlDbTableObject::delete not implemented.";
	throw ex;
}
end_body
member
public: string getField(string path);
body
{
	if (xpath_list) {
		if (al_dst_node(xpath_list, path)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db table object: path not found: path = " + path;
			throw ex;
		}
	} else {
	}
	fetch();
	var string val;
	val = al_dst_node(values, path);
	if (val == ctrl_a) {
		return "";
	} else {
	}
	return val;
}
end_body
member
public: list getChildren(string path, list cond);
body
{
	var DtdItr child_dtd_itr;
	var list ls, ls, child_xpath_list, child_rev_xpath_list;
	var list child_pkey_names, child_fkey_names;
	var string child_table_name, pkey_path, fkey_name, value;
	var string orderby, orderby_type;
	if (dtd_itr) {
		if (ls = dtd_itr.getChild2(path)) {
			child_dtd_itr = ls.head;
			child_table_name = ls.tail.head;
			ls = child_dtd_itr.getFieldList2();
			child_xpath_list = ls.head;
			child_pkey_names = ls.tail.tail.head;
			child_fkey_names = ls.tail.tail.tail.head;
			child_rev_xpath_list = ls.tail.tail.tail.tail.head;
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db table object: path not found:  path = " + path;
			throw ex;
		}
	} else {
	}
	var string sql, name, path2, value2, dataId;
	var list first, itr, rs, rec, ret;
	var list itr2, pkey_values;
	var integer num_cols;
	sql = al_copy("");
	al_append_str(sql, "select ");
	itr = al_dst_itr(child_pkey_names);
	first = 1;
	num_cols = 0;
	loop {
		if (name = al_next(itr)) {
		} else {
			break;
		}
		if (orderby || al_dst_node(child_fkey_names, name)) {
		} else {
			orderby = name;
			orderby_type = "string";
			var integer len;
			var string id_str;
			len = al_strlen(orderby);
			if (len >= 2) {
				id_str = al_substr(orderby, len - 2, len);
				id_str = al_str_misc("to_lower", id_str, null);
				if (id_str == "id") {
					orderby_type = "integer";
				} else {
				}
			} else {
			}
		}
		if (first) {
			first = null;
		} else {
			al_append_str(sql, ",");
		}
		al_append_str(sql, name);
		num_cols = num_cols + 1;
	}
	al_append_str(sql, " from ");
	al_append_str(sql, child_table_name);
	itr = al_dst_itr(child_fkey_names);
	first = 1;
	loop {
		if (pkey_path = al_next(itr)) {
		} else {
			break;
		}
		fkey_name = al_arc_a(itr);
		pkey_path = al_dst_node(rev_xpath_list, pkey_path);
		value = getField(pkey_path);
		if (first) {
			first = null;
			al_append_str(sql, " where ");
		} else {
			al_append_str(sql, " and ");
		}
		al_append_str(sql, fkey_name);
		al_append_str(sql, "='");
		al_append_str(sql, DbUtility::convChar(value));
		al_append_str(sql, "'");
	}
	itr = al_dst_itr(cond);
	loop {
		if (value2 = al_next(itr)) {
		} else {
			break;
		}
		path2 = al_arc_a(itr);
		if (name = al_dst_node(xpath_list, path)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "db accessor: can't find path '" + path2 + "' in (" + msgType + "," + msgVersion + ")";
			throw ex;
		}
		al_append_str(sql, " and ");
		al_append_str(sql, name);
		if (isLike(value2)) {
			al_append_str(sql, " like '");
			al_append_str(sql, DbUtility::convChar(value2));
			al_append_str(sql, "'");
		} else {
			al_append_str(sql, "='");
			al_append_str(sql, DbUtility::convChar(value2));
			al_append_str(sql, "'");
		}
	}
	if (orderby && orderby_type == "string") {
		al_append_str(sql, " order by ");
		al_append_str(sql, orderby);
	} else {
	}
	if (orderby && orderby_type == "integer") {
		al_append_str(sql, " order by lpad(");
		al_append_str(sql, orderby);
		al_append_str(sql, ", 20, '0')");
	} else {
	}
	var string pkey_names;
	if (count_max) {
		conn.setMaxResultSet(count_max);
	} else {
	}
	rs = conn.executeQuery(num_cols, sql);
	conn.clearMaxResultSet();
	itr = al_dst_itr(rs);
	ret = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		var XmlDbTableObject obj;
		obj = new XmlDbTableObject;
		obj.msgType = msgType;
		obj.msgVersion = msgVersion;
		obj.conn = conn;
		obj.db_type = db_type;
		obj.acc = this;
		obj.pkey_values = pkey_values = al_cons(null, null);
		itr2 = al_dst_itr(child_pkey_names);
		num_cols = 0;
		dataId = "";
		loop {
			if (name = al_next(itr2)) {
			} else {
				break;
			}
			if (value2 = al_dst_node(rec, num_cols = num_cols + 1)) {
			} else {
				value2 = "";
			}
			if (dataId == "") {
				dataId = value2;
			} else {
				dataId = dataId + ": " + value2;
			}
			al_create_arc(pkey_values, value2, name);
		}
		if (child_dtd_itr) {
			obj.dtd_itr = child_dtd_itr.Copy();
			obj.xpath_list = child_xpath_list;
			obj.rev_xpath_list = child_rev_xpath_list;
			obj.table_name = child_table_name;
		} else {
		}
		obj.dataId = dataId;
		al_create_arc(ret, obj, null);
	}
	return ret;
}
end_body
member
public: list getChildren(string path, list cond, string range_path, string range_type, string from, string to, string orderby_path, string orderby_type, list desc);
body
{
	var AlException ex;
	ex = new AlException;
	ex.msg = "XmlDbTableObject::get(list cond, string range_path, string range_type, string from, string to, string orderby_path, string orderby_type, list desc) not implemented.";
	throw ex;
}
end_body
member
public: void fetch();
body
{
	if (fetched) {
		return;
	} else {
	}
	var string sql, name, value, path;
	var list first, itr, rs, rec, itr2;
	var integer num_cols, i;
	sql = al_copy("");
	itr = al_dst_itr(xpath_list);
	num_cols = 0;
	first = 1;
	loop {
		if (name = al_next(itr)) {
		} else {
			break;
		}
		if (first) {
			first = null;
			al_append_str(sql, "select ");
		} else {
			al_append_str(sql, ", ");
		}
		al_append_str(sql, name);
		num_cols = num_cols + 1;
	}
	al_append_str(sql, " from ");
	al_append_str(sql, table_name);
	itr = al_dst_itr(pkey_values);
	first = 1;
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		name = al_arc_a(itr);
		if (first) {
			first = null;
			al_append_str(sql, " where ");
		} else {
			al_append_str(sql, " and ");
		}
		al_append_str(sql, name);
		al_append_str(sql, "='");
		al_append_str(sql, DbUtility::convChar(value));
		al_append_str(sql, "'");
		name = al_arc_a(itr);
	}
	rs = conn.executeQuery(num_cols, sql);
	itr = al_dst_itr(rs);
	values = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		itr2 = al_dst_itr(xpath_list);
		i = 0;
		loop {
			if (name = al_next(itr2)) {
			} else {
				break;
			}
			value = al_dst_node(rec, i = i + 1);
			path = al_dst_node(rev_xpath_list, name);
			al_create_arc(values, value, path);
		}
	}
	fetched = 1;
}
end_body
member
public: list table_name;
member
public: list pkey_values;
member
public: list rev_xpath_list;
end_class
end_class
class Csv1Data
member
public: void loadCSV(string filename);
body
{
	var file in;
	if (in = al_file_open(filename, "r")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't open csv file '" + (string)filename + "'";
		throw ex;
	}
	root_csv_data = al_cons(null, null);
	var list data, data2, parents, parent, children, child, child_csv_data;
	parents = al_cons(null, null);
	children = al_cons(null, null);
	loop {
		if (data = al_file_read(in, "csv")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "fail to read csv file '" + (string)filename + "'";
			throw ex;
		}
		if (data == 1) {
			break;
		} else {
		}
		parent = al_dst_node(data, 2);
		if (parent != "") {
			al_create_arc(parents, data, parent);
		} else {
		}
		child = al_dst_node(data, 3);
		if (child != "") {
			al_create_arc(children, data, child);
		} else {
			al_create_arc(root_csv_data, data, null);
		}
	}
	var list itr, itr2;
	itr = al_dst_itr(parents);
	loop {
		if (data = al_next(itr)) {
		} else {
			break;
		}
		parent = al_arc_a(itr);
		al_create_arc(data, child_csv_data = al_cons(null, null), "$child");
		itr2 = al_dst_itr(children);
		loop {
			if (data2 = al_next_a(itr2, parent)) {
			} else {
				break;
			}
			al_create_arc(child_csv_data, data2, null);
			al_remove(itr2);
		}
	}
}
end_body
member
public: list root_csv_data;
class Csv1DataItr
member
public: void Reset(list csv_data);
body
{
	base_csv_data = csv_data;
	Reset();
}
end_body
member
public: void Reset();
body
{
	if (base_csv_data) {
	} else {
		base_csv_data = root_csv_data;
	}
	if (base_csv_data) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "no csv data.";
		throw ex;
	}
	csv_data_itr = al_dst_itr(base_csv_data);
}
end_body
member
public: list base_csv_data;
member
public: list csv_data_itr;
member
public: list nextRow();
body
{
	var list data;
	loop {
		if (data = al_next(csv_data_itr)) {
		} else {
			return null;
		}
		if (al_dst_node(data, "$child")) {
			continue;
		} else {
		}
		if (al_dst_node(data, 1) != "") {
			continue;
		} else {
		}
		break;
	}
	parent_id = al_dst_node(data, 2);
	child_id = al_dst_node(data, 3);
	dst_path = al_dst_node(data, 4);
	src_path = al_dst_node(data, 5);
	value = al_dst_node(data, 6);
	return 1;
}
end_body
member
public: string parent_id;
member
public: string child_id;
member
public: string dst_path;
member
public: string src_path;
member
public: string value;
member
public: Csv1Data nextChild();
body
{
	var list data, itr, child_csv_data, child;
	loop {
		if (data = al_next(csv_data_itr)) {
		} else {
			return null;
		}
		if (child_csv_data = al_dst_node(data, "$child")) {
		} else {
			continue;
		}
		var Csv1DataItr csv_itr;
		csv_itr = new Csv1DataItr;
		csv_itr.Reset(child_csv_data);
		csv_itr.base_parent_name = al_dst_node(data, 1);
		csv_itr.base_parent_id = al_dst_node(data, 2);
		csv_itr.base_child_id = al_dst_node(data, 3);
		csv_itr.base_dst_path = al_dst_node(data, 4);
		csv_itr.base_src_path = al_dst_node(data, 5);
		csv_itr.base_value = al_dst_node(data, 6);
		return csv_itr;
	}
}
end_body
member
public: Csv1Data nextChild(string name);
body
{
	var list data, itr, child_csv_data, child;
	loop {
		if (data = al_next(csv_data_itr)) {
		} else {
			return null;
		}
		itr = al_dst_itr(data);
		loop {
			if (child_csv_data = al_next(itr)) {
			} else {
				break;
			}
			child = al_arc_a(itr);
			if (child != "$child") {
				continue;
			} else {
			}
			if (al_dst_node(data, 1) != name) {
				continue;
			} else {
			}
			var Csv1DataItr csv_itr;
			csv_itr = new Csv1DataItr;
			csv_itr.Reset(child_csv_data);
			csv_itr.base_parent_name = al_dst_node(data, 1);
			csv_itr.base_parent_id = al_dst_node(data, 2);
			csv_itr.base_child_id = al_dst_node(data, 3);
			csv_itr.base_dst_path = al_dst_node(data, 4);
			csv_itr.base_src_path = al_dst_node(data, 5);
			csv_itr.base_value = al_dst_node(data, 6);
			return csv_itr;
		}
	}
}
end_body
member
public: string base_parent_name;
member
public: string base_parent_id;
member
public: string base_child_id;
member
public: string base_dst_path;
member
public: string base_src_path;
member
public: string base_value;
end_class
end_class
end_class
class ProcessEngine
member
public: list start();
body
{
	ProcMgr::Initialize();
	ProcSched::instance = sched = new ProcSched;
	sched.pe = this;
	timer_id = al_get_id();
	var list cb;
	cb = al_list3(al_root_class(), sched, ProcSched::execute);
	al_gui_misc("timer", al_list2(timer_id, ticker_interval), cb);
}
end_body
member
public: void stop();
body
{
	if (timer_id) {
		al_gui_misc("timer", al_list2(timer_id, ticker_interval), null);
		al_release_id(timer_id);
		timer_id = null;
	} else {
	}
	if (sched) {
		if (sched.conn) {
			sched.conn.rollback();
			sched.conn.close();
			sched.conn = null;
		} else {
		}
		sched.pe = null;
	} else {
	}
	ProcSched::instance = sched = null;
}
end_body
member
public: integer timer_id;
member
public: integer ticker_interval;
member
public: string cleanup_time;
member
public: string process_log_filepath;
member
public: list process_log_db;
member
public: AltairServer ap_server;
member
public: ProcSched sched;
member
public: integer max_property_cache;
member
public: static string pool_name;
member
public: list debug_mode;
member
public: list exception_detail;
class ProcMgr
member
public: static void Initialize();
body
{
	Begin = "Begin";
	End = "End";
	OrSplit = "OrSplit";
	OrJoin = "OrJoin";
	AndSplit = "AndAplit";
	AndJoin = "AndJoin";
	Auto = "Auto";
	Manual = "Manual";
	Wait = "Wait";
}
end_body
member
public: void register(string processDefName, list def);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		register(processDefName, def, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void register(string processDefName, list def, DbConnection conn);
body
{
	unregister(processDefName, conn);
	var list acts, act, props, itr;
	var string sql, name, value;
	sql = al_copy("");
	al_append_str(sql, "insert into ProcDef (ProcessDefName) values ('");
	al_append_str(sql, processDefName);
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
	acts = al_dst_node(def, "activities");
	itr = al_dst_itr(acts);
	loop {
		if (act = al_next(itr)) {
		} else {
			break;
		}
		sql = al_copy("");
		al_append_str(sql, "insert into ProcessDefinition (ProcessDefName, ActivityId, ActivityKind, ActivityName, ");
		al_append_str(sql, "AndJoinCount, Time, ClassName, PropertyValue, ");
		al_append_str(sql, "NextActivityId, NextActivityKind, NextActivityName, NextPropertyName) values ('");
		al_append_str(sql, processDefName);
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "ActivityId"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "ActivityKind"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "ActivityName"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "AndJoinCount"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "Time"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "ClassName"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "PropertyValue"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "NextActivityId"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "NextActivityKind"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "NextActivityName"));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(act, "NextPropertyName"));
		al_append_str(sql, "')");
		conn.executeUpdate(sql);
	}
	props = al_dst_node(def, "properties");
	itr = al_dst_itr(props);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		name = al_arc_a(itr);
		sql = al_copy("");
		al_append_str(sql, "insert into ProcessDefaultProperties (");
		al_append_str(sql, "ProcessDefName, Name, Value) values ('");
		al_append_str(sql, processDefName);
		al_append_str(sql, "','");
		al_append_str(sql, name);
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(value));
		al_append_str(sql, "')");
		conn.executeUpdate(sql);
	}
}
end_body
member
public: void unregister(string processDefName);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		unregister(processDefName, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void unregister(string processDefName, DbConnection conn);
body
{
	var string sql;
	sql = "delete from ProcDef where ProcessDefName='" + processDefName + "'";
	conn.executeUpdate(sql);
	sql = "delete from ProcessDefinition where ProcessDefName='" + processDefName + "'";
	conn.executeUpdate(sql);
	sql = "delete from ProcessDefaultProperties where ProcessDefName='" + processDefName + "'";
	conn.executeUpdate(sql);
}
end_body
member
public: string create(string processDefName);
body
{
	var string processId;
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		processId = create(processDefName, conn);
		conn.commit();
		conn.close();
		return processId;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: string create(string processDefName, DbConnection conn);
body
{
	var string sql, processId, activityKind, name, value;
	var list rs, itr, rec;
	sql = al_copy("");
	al_append_str(sql, "select ActivityId, ActivityKind, ActivityName, ");
	al_append_str(sql, "AndJoinCount, Time, ClassName, PropertyValue, ");
	al_append_str(sql, "NextActivityId, NextActivityKind, NextActivityName, NextPropertyName from ProcessDefinition ");
	al_append_str(sql, "where ProcessDefName='");
	al_append_str(sql, processDefName);
	al_append_str(sql, "'");
	rs = conn.executeQuery(11, sql);
	itr = al_dst_itr(rs);
	if (al_count(itr) == 0) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "ProcessDefinition not found. processName = '" + (string)processDefName + "'";
		throw ex;
	} else {
	}
	processId = conn.getNextSeq("ProcessId_seq");
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		var list acts;
		sql = al_copy("");
		al_append_str(sql, "insert into ProcessActivities (ProcessDefName, ProcessId, ActivityId, ActivityKind, ActivityName, ");
		al_append_str(sql, "AndJoinCount, Time, ClassName, PropertyValue, ");
		al_append_str(sql, "NextActivityId, NextActivityKind, NextActivityName, NextPropertyName, Status, Count) values ('");
		al_append_str(sql, processDefName);
		al_append_str(sql, "','");
		al_append_str(sql, processId);
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 1));
		al_append_str(sql, "','");
		al_append_str(sql, activityKind = al_dst_node(rec, 2));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 3));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 4));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 5));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 6));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 7));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 8));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 9));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 10));
		al_append_str(sql, "','");
		al_append_str(sql, al_dst_node(rec, 11));
		al_append_str(sql, "','");
		al_append_str(sql, activityKind == Begin ? "active" : "deactive");
		al_append_str(sql, "','0')");
		conn.executeUpdate(sql);
	}
	sql = al_copy("");
	al_append_str(sql, "select Name, Value from ProcessDefaultProperties ");
	al_append_str(sql, "where ProcessDefName='");
	al_append_str(sql, processDefName);
	al_append_str(sql, "'");
	rs = conn.executeQuery(2, sql);
	itr = al_dst_itr(rs);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		name = al_dst_node(rec, 1);
		value = al_dst_node(rec, 2);
		sql = al_copy("");
		al_append_str(sql, "insert into ProcessProperties (");
		al_append_str(sql, "ProcessId, Name, Value) values ('");
		al_append_str(sql, processId);
		al_append_str(sql, "','");
		al_append_str(sql, name);
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(value));
		al_append_str(sql, "')");
		conn.executeUpdate(sql);
	}
	return processId;
}
end_body
member
public: string start(string processId);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		start(processId, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
	if (ProcSched::instance) {
		ProcSched::instance.execute();
	} else {
	}
}
end_body
member
public: string start(string processId, DbConnection conn);
body
{
	var string sql, processDefName, beginActivityId, beginActivityName;
	var list rs, itr, rec;
	sql = "select ProcessDefName, ActivityId, ActivityName from ProcessActivities where processId='" + processId + "' and ActivityKind='" + Begin + "'";
	rs = conn.executeQuery(3, sql);
	itr = al_dst_itr(rs);
	if (rec = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "begin activity not found: processId = " + (string)processId;
		throw ex;
	}
	processDefName = al_dst_node(rec, 1);
	beginActivityId = al_dst_node(rec, 2);
	beginActivityName = al_dst_node(rec, 3);
	rec = null;
	sql = "insert into ProcessQueue (ProcessDefName, ProcessId, ActivityId, ActivityKind, ActivityName, Status) values ('";
	sql = sql + processDefName + "','" + processId + "','" + beginActivityId + "','" + Begin + "','" + beginActivityName + "','execute')";
	conn.executeUpdate(sql);
}
end_body
member
public: void putProperties(string processId, list props);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		putProperties(processId, props, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void putProperties(string processId, list props, DbConnection conn);
body
{
	var string sql;
	var list itr, name, value;
	itr = al_dst_itr(props);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		if (name = al_arc_a(itr)) {
			sql = al_copy("");
			al_append_str(sql, "insert into CmdQueue (CmdQueueId,ProcessId,Command,Arg1,Arg2) values ('");
			al_append_str(sql, getCmdQueueId(conn));
			al_append_str(sql, "','");
			al_append_str(sql, processId);
			al_append_str(sql, "','");
			al_append_str(sql, "putProperty");
			al_append_str(sql, "','");
			al_append_str(sql, name);
			al_append_str(sql, "','");
			al_append_str(sql, value);
			al_append_str(sql, "')");
			conn.executeUpdate(sql);
		} else {
		}
	}
}
end_body
member
public: list getProperties(string processId);
body
{
	var list props;
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		props = getProperties(processId, conn);
		conn.close();
		return props;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: list getProperties(string processId, DbConnection conn);
body
{
	var list props, rs, itr, rec, name, value;
	var string sql;
	sql = "select PropertyName, PropertyValue from ProcessProperties where ProcessId='" + processId + "'";
	rs = conn.executeQuery(2, sql);
	itr = al_dst_itr(rs);
	props = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		name = al_dst_node(rec, 1);
		if (value = al_dst_node(rec, 2)) {
		} else {
			value = "";
		}
		al_create_arc(props, value, name);
	}
	return props;
}
end_body
member
public: string getWorkItem(string processId, string activityName);
body
{
	var DbConnection conn;
	var string workItem;
	try {
		conn = DbManager::getConnection(pool_name);
		workItem = getWorkItem(processId, activityName, conn);
		conn.close();
		return workItem;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: string getWorkItem(string processId, string activityName, DbConnection conn);
body
{
	var list rs, itr, rec;
	var string sql;
	sql = "select CurrActivityId from ProcessQueue where ProcessId='" + processId + "' and CurrActivityName = '" + activityName + "' and status='manual'";
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	if (rec = al_next(itr)) {
	} else {
		return null;
	}
	return al_dst_node(rec, 1);
}
end_body
member
public: list getWorkItems(string processId);
body
{
	var DbConnection conn;
	var list workItems;
	try {
		conn = DbManager::getConnection(pool_name);
		workItems = getWorkItems(processId, conn);
		conn.close();
		return workItems;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: list getWorkItems(string processId, DbConnection conn);
body
{
	var string activityId, activityName;
	var list ls, rs, itr, rec;
	var string sql;
	sql = "select CurrActivityId, CurrActivityName from ProcessQueue where ProcessId='" + processId + "' and status='manual'";
	rs = conn.executeQuery(2, sql);
	itr = al_dst_itr(rs);
	ls = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		activityId = al_dst_node(rec, 1);
		activityName = al_dst_node(rec, 2);
		al_create_arc(ls, activityId, activityName);
	}
	return ls;
}
end_body
member
public: list getWorkItems();
body
{
	var DbConnection conn;
	var list workItems;
	try {
		conn = DbManager::getConnection(pool_name);
		workItems = getWorkItems(conn);
		conn.close();
		return workItems;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: list getWorkItems(DbConnection conn);
body
{
	var string processId, activityId, activityName;
	var list ls, rs, itr, rec;
	var string sql;
	sql = "select ProcessId, CurrActivityId, CurrActivityName from ProcessQueue where status='manual'";
	rs = conn.executeQuery(3, sql);
	itr = al_dst_itr(rs);
	ls = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		processId = al_dst_node(rec, 1);
		activityId = al_dst_node(rec, 2);
		activityName = al_dst_node(rec, 3);
		al_create_arc(ls, al_list2(processId, activityId), activityName);
	}
	return ls;
}
end_body
member
public: list getProcList();
body
{
	var DbConnection conn;
	var list procList;
	try {
		conn = DbManager::getConnection(pool_name);
		procList = getProcList(conn);
		conn.close();
		return procList;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: list getProcList(DbConnection conn);
body
{
	var string processId;
	var list ls, rs, itr, rec;
	var string sql;
	sql = "select ProcessId from ProcessQueue";
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	ls = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		processId = al_dst_node(rec, 1);
		al_create_arc(ls, processId, null);
	}
	return ls;
}
end_body
member
public: list getProcList(string status);
body
{
	var DbConnection conn;
	var list procList;
	try {
		conn = DbManager::getConnection(pool_name);
		procList = getProcList(status, conn);
		conn.close();
		return procList;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: list getProcList(string status, DbConnection conn);
body
{
	var string processId;
	var list ls, rs, itr, rec;
	var string sql;
	sql = "select ProcessId from ProcessQueue where Status='" + status + "'";
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	ls = al_cons(null, null);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		processId = al_dst_node(rec, 1);
		al_create_arc(ls, processId, null);
	}
	return ls;
}
end_body
member
public: list complete(string processId, string workItem);
body
{
	var DbConnection conn;
	var list result;
	try {
		conn = DbManager::getConnection(pool_name);
		result = complete(processId, workItem, conn);
		conn.close();
		return result;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: list complete(string processId, string workItem, DbConnection conn);
body
{
	var list rs, itr, rec;
	var string sql;
	sql = "select ProcessDefName, CurrActivityKind, CurrActivityName from ProcessQueue where ProcessId='" + processId + "' and CurrActivityId = '" + workItem + "' and Status='manual'";
	rs = conn.executeQuery(3, sql);
	itr = al_dst_itr(rs);
	if (rec = al_next(itr)) {
	} else {
		return null;
	}
	var ProcSched sched;
	sched = new ProcSched;
	sched.conn = conn;
	sched.processDefName = al_dst_node(rec, 1);
	sched.processId = processId;
	sched.activityId = workItem;
	sched.activityKind = al_dst_node(rec, 2);
	sched.activityName = al_dst_node(rec, 3);
	sched.invokeComplete(processId, workItem);
	sched.process_log("completed", "");
	return 1;
}
end_body
member
public: void completeByName(string processId, string activityName);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		completeByName(processId, activityName, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void completeByName(string processId, string activityName, DbConnection conn);
body
{
	var string sql;
	sql = al_copy("");
	al_append_str(sql, "insert into CmdQueue (CmdQueueId,ProcessId,Command,Arg1) values ('");
	al_append_str(sql, getCmdQueueId(conn));
	al_append_str(sql, "','");
	al_append_str(sql, processId);
	al_append_str(sql, "','");
	al_append_str(sql, "complete");
	al_append_str(sql, "','");
	al_append_str(sql, activityName);
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
}
end_body
member
public: void suspend(string processId);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		suspend(processId, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void suspend(string processId, DbConnection conn);
body
{
	var string sql;
	sql = al_copy("");
	al_append_str(sql, "insert into CmdQueue (CmdQueueId,ProcessId,Command) values ('");
	al_append_str(sql, getCmdQueueId(conn));
	al_append_str(sql, "','");
	al_append_str(sql, processId);
	al_append_str(sql, "','");
	al_append_str(sql, "suspend");
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
}
end_body
member
public: void resume(string processId);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		resume(processId, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void resume(string processId, DbConnection conn);
body
{
	var string sql;
	sql = al_copy("");
	al_append_str(sql, "insert into CmdQueue (CmdQueueId,ProcessId,Command) values ('");
	al_append_str(sql, getCmdQueueId(conn));
	al_append_str(sql, "','");
	al_append_str(sql, processId);
	al_append_str(sql, "','");
	al_append_str(sql, "resume");
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
}
end_body
member
public: void abort(string processId);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		abort(processId, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void abort(string processId, DbConnection conn);
body
{
	var string sql;
	sql = al_copy("");
	al_append_str(sql, "insert into CmdQueue (CmdQueueId,ProcessId,Command) values ('");
	al_append_str(sql, getCmdQueueId(conn));
	al_append_str(sql, "','");
	al_append_str(sql, processId);
	al_append_str(sql, "','");
	al_append_str(sql, "abort");
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
}
end_body
member
public: void delete(string processId);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		delete(processId, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void delete(string processId, DbConnection conn);
body
{
	var string sql;
	sql = al_copy("");
	al_append_str(sql, "insert into CmdQueue (CmdQueueId,ProcessId,Command) values ('");
	al_append_str(sql, getCmdQueueId(conn));
	al_append_str(sql, "','");
	al_append_str(sql, processId);
	al_append_str(sql, "','");
	al_append_str(sql, "delete");
	al_append_str(sql, "')");
	conn.executeUpdate(sql);
}
end_body
member
public: void deleteCleanup();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		deleteCleanup(conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void deleteCleanup(DbConnection conn);
body
{
	var list ls, itr;
	var string processId;
	ls = getProcList("cleanup", conn);
	itr = al_dst_itr(ls);
	loop {
		if (processId = al_next(itr)) {
		} else {
			break;
		}
		delete(processId, conn);
	}
}
end_body
member
public: void deleteAll();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(pool_name);
		deleteAll(conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
member
public: void deleteAll(DbConnection conn);
body
{
	var list ls, itr;
	var string processId;
	ls = getProcList(conn);
	itr = al_dst_itr(ls);
	loop {
		if (processId = al_next(itr)) {
		} else {
			break;
		}
		delete(processId, conn);
	}
}
end_body
member
public: string getCmdQueueId(DbConnection conn);
body
{
	return conn.getNextSeq("CmdQueueId_seq");
}
end_body
member
public: static string Begin;
member
public: static string End;
member
public: static string OrSplit;
member
public: static string OrJoin;
member
public: static string AndSplit;
member
public: static string AndJoin;
member
public: static string Auto;
member
public: static string Manual;
member
public: static string Wait;
end_class
class ProcSched
member
public: void execute();
body
{
	para this._execute();
}
end_body
member
public: void _execute();
body
{
	if (running) {
		return;
	} else {
	}
	running = 1;
	try {
		conn = DbManager::getConnection(pool_name);
		db_type = DbManager::getDbType(pool_name);
		loop {
			if (process()) {
				conn.commit();
			} else {
				break;
			}
		}
		conn.close();
		conn = null;
	} catch (AlException e) {
	}
	var integer time;
	time = al_misc("get_time", null, null);
	time = al_misc("get_localtime", time, null);
	ticker_last_timestamp = al_misc("format_time", time, "yyyy'/'MM'/'dd'-'HH':'mm':'ss");
	running = null;
}
end_body
member
public: list running;
member
public: string ticker_last_timestamp;
member
public: list process();
body
{
	var string sql, time, cmd_id, cmd, arg1, arg2;
	var list rs, itr, rec, cont;
	var list rs2, itr2, rec2;
	try {
		// get exec queue items
		sql = "select ProcessDefName, ProcessId, ActivityId, ActivityKind, ActivityName, PropertyName from ProcessQueue where Status='execute'";
		rs = conn.executeQuery(6, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				break;
			}
			processDefName = al_dst_node(rec, 1);
			processId = al_dst_node(rec, 2);
			activityId = al_dst_node(rec, 3);
			activityKind = al_dst_node(rec, 4);
			if (activityName = al_dst_node(rec, 5)) {
			} else {
				activityName = "";
			}
			if (propertyName = al_dst_node(rec, 6)) {
			} else {
				propertyName = "";
			}
			// check activity status
			sql = "select Status, Count from ProcessActivities where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
			rs2 = conn.executeQuery(2, sql);
			itr2 = al_dst_itr(rs2);
			if (rec2 = al_next(itr2)) {
			} else {
				makeSuspendQueueItem(processId, activityId);
				handleError("activity not found:", (AlException)null);
				continue;
			}
			status = al_dst_node(rec2, 1);
			exec_count = (integer)al_dst_node(rec2, 2);
			if (exec_count = al_dst_node(rec2, 2)) {
				exec_count = (integer)exec_count + 1;
			} else {
				exec_count = 1;
			}
			if (status == "active") {
			} else {
				makeSuspendQueueItem(processId, activityId);
				handleError("activity not active: status = " + (string)status, (AlException)null);
				continue;
			}
			sql = "update ProcessActivities set Count='" + (string)exec_count + "' where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
			conn.executeUpdate(sql);
			suspend = null;
			if (activityKind == ProcMgr::Begin) {
				invokeNext(processId, activityId);
			} else {
			}
			if (activityKind == ProcMgr::End) {
				invokeEnd(processId);
			} else {
			}
			if (activityKind == ProcMgr::OrSplit) {
				invokeOrSplit(processId, activityId, propertyName);
			} else {
			}
			if (activityKind == ProcMgr::OrJoin) {
				invokeNext(processId, activityId);
			} else {
			}
			if (activityKind == ProcMgr::AndSplit) {
				invokeAndSplit(processId, activityId);
			} else {
			}
			if (activityKind == ProcMgr::AndJoin) {
				invokeAndJoin(processId, activityId);
			} else {
			}
			if (activityKind == ProcMgr::Auto) {
				invokeAuto(processId, activityId);
			} else {
			}
			if (activityKind == ProcMgr::Manual) {
				invokeManual(processId, activityId);
			} else {
			}
			if (activityKind == ProcMgr::Wait) {
				invokeWait(processId, activityId);
			} else {
			}
			if (suspend) {
				process_log("suspend (service invocation error)", "");
			} else {
				process_log("exec", "");
			}
			cont = 1;
		}
		// get wait queue items
		time = (string)al_misc("get_time", null, null);
		sql = "select ProcessDefName, ProcessId, ActivityId, ActivityKind, ActivityName from ProcessQueue where Status='wait' and Time<='" + time + "'";
		rs = conn.executeQuery(5, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				break;
			}
			processDefName = al_dst_node(rec, 1);
			processId = al_dst_node(rec, 2);
			activityId = al_dst_node(rec, 3);
			activityKind = al_dst_node(rec, 4);
			if (activityName = al_dst_node(rec, 5)) {
			} else {
				activityName = "";
			}
			process_log("wait-complete", "");
			invokeNext(processId, activityId);
			cont = 1;
		}
		// get command queue item
		sql = "select CmdQueueId, ProcessId, Command, Arg1, Arg2 from CmdQueue order by CmdQueueId";
		rs = conn.executeQuery(5, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				break;
			}
			processDefName = activityId = activityKind = activityName = null;
			cmd_id = al_dst_node(rec, 1);
			processId = al_dst_node(rec, 2);
			cmd = al_dst_node(rec, 3);
			arg1 = al_dst_node(rec, 4);
			if (arg2 = al_dst_node(rec, 5)) {
			} else {
				arg2 = "";
			}
			if (cmd == "putProperty" && arg1 && arg2) {
				invokePutProperty(cmd_id, processId, arg1, arg2);
			} else {
			}
			if (cmd == "suspend") {
				invokeSuspend(cmd_id, processId);
			} else {
			}
			if (cmd == "resume") {
				invokeResume(cmd_id, processId);
			} else {
			}
			if (cmd == "abort") {
				invokeAbort(cmd_id, processId);
			} else {
			}
			if (cmd == "delete") {
				invokeDelete(cmd_id, processId);
			} else {
			}
			if (cmd == "complete" && arg1) {
				activityName = arg1;
				invokeCompleteByActivityName(cmd_id, processId, activityName);
			} else {
			}
			cont = 1;
		}
		// get cleanup queue items
		time = (string)al_misc("get_time", null, null);
		sql = "select ProcessDefName, ProcessId, ActivityId, ActivityKind, ActivityName from ProcessQueue where Status='cleanup' and Time<='" + time + "'";
		rs = conn.executeQuery(5, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				break;
			}
			processDefName = al_dst_node(rec, 1);
			processId = al_dst_node(rec, 2);
			activityId = al_dst_node(rec, 3);
			activityKind = al_dst_node(rec, 4);
			if (activityName = al_dst_node(rec, 5)) {
			} else {
				activityName = "";
			}
			process_log("cleanup", "");
			deleteProcess(processId);
			cont = 1;
		}
		return cont;
	} catch (AlException e) {
		handleError("fatal error", e);
		try {
			conn.commit();
		} catch (AlException e) {
		}
		return null;
	}
}
end_body
member
public: string processDefName;
member
public: string processId;
member
public: string activityId;
member
public: string activityKind;
member
public: string activityName;
member
public: string propertyName;
member
public: string status;
member
public: integer exec_count;
member
public: list suspend;
member
public: void invokeNext(string processId, string activityId);
body
{
	var string nextActivityId, nextActivityKind, nextActivityName, nextPropertyName;
	var list itr, rec;
	itr = getNextActivities(processId, activityId);
	if (rec = al_next(itr)) {
	} else {
		handleError("next activity not found:", (AlException)null);
		return;
	}
	nextActivityId = al_dst_node(rec, 1);
	nextActivityKind = al_dst_node(rec, 2);
	if (nextActivityName = al_dst_node(rec, 3)) {
	} else {
		nextActivityName = "";
	}
	if (nextPropertyName = al_dst_node(rec, 4)) {
	} else {
		nextPropertyName = "";
	}
	activateActivity(processId, nextActivityId);
	enqueueExecQueueItem(processId, nextActivityId, nextActivityKind, nextActivityName, nextPropertyName);
	deactivateActivity(processId, activityId);
	dequeueQueueItem(processId, activityId);
}
end_body
member
public: void invokeEnd(string processId);
body
{
	makeCleanupQueueItem(processId);
}
end_body
member
public: void invokeOrSplit(string processId, string activityId, string propertyName);
body
{
	var string propertyValue, sql, nextActivityId, nextActivityKind, nextActivityName, nextPropertyName;
	var list props, rs, itr, rec;
	// get process properties
	props = getProperties(processId);
	if (propertyValue = al_dst_node(props, propertyName)) {
	} else {
		propertyValue = "";
	}
	// get next activity
	sql = "select NextActivityId, NextActivityKind, NextActivityName, NextPropertyName from ProcessActivities ";
	sql = sql + "where ProcessId='" + processId + "' and ActivityId='" + activityId + "' and PropertyValue='" + propertyValue + "'";
	rs = conn.executeQuery(4, sql);
	itr = al_dst_itr(rs);
	if (rec = al_next(itr)) {
	} else {
		sql = "select NextActivityId, NextActivityKind, NextActivityName, NextPropertyName from ProcessActivities ";
		sql = sql + "where ProcessId='" + processId + "' and ActivityId='" + activityId + "' and PropertyValue='_default'";
		rs = conn.executeQuery(4, sql);
		itr = al_dst_itr(rs);
		if (rec = al_next(itr)) {
		} else {
			handleError("orsplit next activity not found:", (AlException)null);
			return;
		}
	}
	nextActivityId = al_dst_node(rec, 1);
	nextActivityKind = al_dst_node(rec, 2);
	if (nextActivityName = al_dst_node(rec, 3)) {
	} else {
		nextActivityName = "";
	}
	if (nextPropertyName = al_dst_node(rec, 4)) {
	} else {
		nextPropertyName = "";
	}
	activateActivity(processId, nextActivityId);
	enqueueExecQueueItem(processId, nextActivityId, nextActivityKind, nextActivityName, nextPropertyName);
	deactivateActivity(processId, activityId);
	dequeueQueueItem(processId, activityId);
}
end_body
member
public: void invokeAndSplit(string processId, string activityId);
body
{
	var string nextActivityId, nextActivityKind, nextActivityName, nextPropertyName;
	var list itr, rec;
	itr = getNextActivities(processId, activityId);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		nextActivityId = al_dst_node(rec, 1);
		nextActivityKind = al_dst_node(rec, 2);
		if (nextActivityName = al_dst_node(rec, 3)) {
		} else {
			nextActivityName = "";
		}
		if (nextPropertyName = al_dst_node(rec, 4)) {
		} else {
			nextPropertyName = "";
		}
		activateActivity(processId, nextActivityId);
		enqueueExecQueueItem(processId, nextActivityId, nextActivityKind, nextActivityName, nextPropertyName);
	}
	deactivateActivity(processId, activityId);
	dequeueQueueItem(processId, activityId);
}
end_body
member
public: void invokeAndJoin(string processId, string activityId);
body
{
	var integer count;
	var string sql;
	var list rs, itr, rec;
	sql = "select AndJoinCount from ProcessActivities where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	if (rec = al_next(itr)) {
	} else {
		handleError("activity not found:", (AlException)null);
		return;
	}
	count = (integer)al_dst_node(rec, 1) - 1;
	sql = "update ProcessActivities set AndJoinCount=" + count + " where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
	conn.executeUpdate(sql);
	if (count <= 0) {
		invokeNext(processId, activityId);
	} else {
	}
}
end_body
member
public: void invokeAuto(string processId, string activityId);
body
{
	var string nextActivityId, nextActivityKind, nextActivityName, nextPropertyName;
	var string className, sql;
	var list itr, rec, props, ret_props;
	itr = getNextActivities(processId, activityId);
	if (rec = al_next(itr)) {
	} else {
		handleError("next activity not found:", (AlException)null);
		return;
	}
	nextActivityId = al_dst_node(rec, 1);
	nextActivityKind = al_dst_node(rec, 2);
	if (nextActivityName = al_dst_node(rec, 3)) {
	} else {
		nextActivityName = "";
	}
	if (nextPropertyName = al_dst_node(rec, 4)) {
	} else {
		nextPropertyName = "";
	}
	if (className = al_dst_node(rec, 6)) {
		var PeService ps;
		if (ps = al_gp("new", className, null, null, null)) {
			props = getProperties(processId);
			try {
				ps.conn = conn;
				ps.db_type = db_type;
				ps.debug_mode = pe.debug_mode;
				ps.exception_detail = pe.exception_detail;
				al_set_dst_node(props, "*process.id", processId);
				al_set_dst_node(props, "*activity.id", activityId);
				al_set_dst_node(props, "*activity.name", activityName);
				ret_props = ps.invoke(props);
			} catch (AlException e) {
				conn.rollback();
				handleError("service invocation error: exception occurs in '" + className + "'", e);
				makeSuspendQueueItem(processId, activityId);
				suspend = 1;
				return;
			}
			putProperties(processId, props, ret_props);
		} else {
			conn.rollback();
			handleError("service invocation error: can' create '" + className + "'", (AlException)null);
			makeSuspendQueueItem(processId, activityId);
			suspend = 1;
			return;
		}
	} else {
	}
	activateActivity(processId, nextActivityId);
	enqueueExecQueueItem(processId, nextActivityId, nextActivityKind, nextActivityName, nextPropertyName);
	deactivateActivity(processId, activityId);
	dequeueQueueItem(processId, activityId);
}
end_body
member
public: void invokeManual(string processId, string activityId);
body
{
	var string nextActivityId, nextActivityKind, nextActivityName, nextPropertyName;
	var list itr, rec;
	itr = getNextActivities(processId, activityId);
	if (rec = al_next(itr)) {
	} else {
		handleError("next activity not found:", (AlException)null);
		return;
	}
	nextActivityId = al_dst_node(rec, 1);
	nextActivityKind = al_dst_node(rec, 2);
	if (nextActivityName = al_dst_node(rec, 3)) {
	} else {
		nextActivityName = "";
	}
	if (nextPropertyName = al_dst_node(rec, 4)) {
	} else {
		nextPropertyName = "";
	}
	enqueueWorkItem(processId, nextActivityId, nextActivityKind, nextActivityName, nextPropertyName);
	dequeueQueueItem(processId, activityId);
}
end_body
member
public: void invokeWait(string processId, string activityId);
body
{
	var string nextActivityId, nextActivityKind, nextActivityName, nextPropertyName;
	var integer current_time;
	var string time, interval;
	var list itr, rec, props;
	itr = getNextActivities(processId, activityId);
	if (rec = al_next(itr)) {
	} else {
		handleError("next activity not found:", (AlException)null);
		return;
	}
	nextActivityId = al_dst_node(rec, 1);
	nextActivityKind = al_dst_node(rec, 2);
	if (nextActivityName = al_dst_node(rec, 3)) {
	} else {
		nextActivityName = "";
	}
	if (nextPropertyName = al_dst_node(rec, 4)) {
	} else {
		nextPropertyName = "";
	}
	current_time = al_misc("get_time", null, null);
	interval = al_dst_node(rec, 5);
	if (al_strlen(interval) > 0 && al_get_char(interval, 0) == '$') {
		interval = al_tail_str(interval, 1);
		props = getProperties(processId);
		if (interval = al_dst_node(props, interval)) {
		} else {
			process_log("warn", "interval is null. interval 1h is used.");
			interval = "1h";
		}
	} else {
	}
	time = (string)(current_time + getTime(interval));
	makeWaitQueueItem(processId, activityId, time);
}
end_body
member
public: void invokeComplete(string processId, string activityId);
body
{
	var string nextActivityId, nextActivityKind, nextActivityName, nextPropertyName;
	var list itr, rec;
	itr = getNextActivities(processId, activityId);
	if (rec = al_next(itr)) {
	} else {
		handleError("next activity not found:", (AlException)null);
		return;
	}
	nextActivityId = al_dst_node(rec, 1);
	nextActivityKind = al_dst_node(rec, 2);
	if (nextActivityName = al_dst_node(rec, 3)) {
	} else {
		nextActivityName = "";
	}
	if (nextPropertyName = al_dst_node(rec, 4)) {
	} else {
		nextPropertyName = "";
	}
	activateActivity(processId, nextActivityId);
	makeExecQueueItem(processId, nextActivityId);
	deactivateActivity(processId, activityId);
}
end_body
member
public: void deleteProcess(string processId);
body
{
	var string sql;
	// delete queue
	sql = "delete from ProcessQueue where ProcessId='" + processId + "'";
	conn.executeUpdate(sql);
	// delete process instance
	sql = "delete from ProcessActivities where ProcessId='" + processId + "'";
	conn.executeUpdate(sql);
	// delete process properties
	sql = "delete from ProcessProperties where ProcessId='" + processId + "'";
	conn.executeUpdate(sql);
	// remove property cache
	if (property_cache) {
		al_set_dst_node(property_cache, processId, null);
	} else {
	}
}
end_body
member
public: list getNextActivities(string processId, string activityId);
body
{
	var string sql;
	var list rs, itr;
	sql = "select NextActivityId, NextActivityKind, NextActivityName, NextPropertyName, Time, ClassName from ProcessActivities where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
	rs = conn.executeQuery(6, sql);
	itr = al_dst_itr(rs);
	return itr;
}
end_body
member
public: list getProperties(string processId);
body
{
	var list props;
	var string sql;
	var list rs, itr, rec, name, value;
	if (property_cache) {
		if (props = al_dst_node(property_cache, processId)) {
			al_set_dst_node(property_cache, processId, null);
			al_create_arc(property_cache, props, processId);
			return props;
		} else {
		}
	} else {
		property_cache = al_cons(null, null);
	}
	props = al_cons(null, null);
	sql = "select Name, Value from ProcessProperties where ProcessId='" + processId + "'";
	rs = conn.executeQuery(2, sql);
	itr = al_dst_itr(rs);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		name = al_dst_node(rec, 1);
		if (value = al_dst_node(rec, 2)) {
		} else {
			value = "";
		}
		al_create_arc(props, value, name);
	}
	itr = al_dst_itr(property_cache);
	if (al_count(itr) >= pe.max_property_cache) {
		al_next(itr);
		al_remove(itr);
	} else {
	}
	al_create_arc(property_cache, props, processId);
	return props;
}
end_body
member
public: void putProperties(string processId, list props, list ret_props);
body
{
	var string sql, value;
	var list itr, name;
	itr = al_dst_itr(ret_props);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		name = al_arc_a(itr);
		if (al_dst_node(props, name)) {
			al_set_dst_node(props, name, value);
			sql = "update ProcessProperties set Value='" + DbUtility::convChar(value) + "' where ProcessId='" + processId + "' and Name='" + name + "'";
			conn.executeUpdate(sql);
		} else {
		}
	}
}
end_body
member
public: list property_cache;
member
public: void activateActivity(string processId, string nextActivityId);
body
{
	var string sql;
	sql = "update ProcessActivities set Status='active' where ProcessId='" + processId + "' and ActivityId='" + nextActivityId + "'";
	conn.executeUpdate(sql);
}
end_body
member
public: void deactivateActivity(string processId, string activityId);
body
{
	var string sql;
	sql = "update ProcessActivities set Status='deactive' where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
	conn.executeUpdate(sql);
}
end_body
member
public: void enqueueExecQueueItem(string processId, string nextActivityId, string nextActivityKind, string nextActivityName, string nextPropertyName);
body
{
	var string sql;
	sql = "insert into ProcessQueue (ProcessDefName, ProcessId, CurrActivityId, CurrActivityKind, CurrActivityName, ActivityId, ActivityKind, ActivityName, PropertyName, Status) values ('";
	sql = sql + processDefName + "','" + processId + "','" + activityId + "','" + activityKind + "','" + activityName + "','";
	sql = sql + nextActivityId + "','" + nextActivityKind + "','" + nextActivityName + "','" + nextPropertyName + "','execute')";
	conn.executeUpdate(sql);
}
end_body
member
public: void enqueueWorkItem(string processId, string nextActivityId, string nextActivityKind, string nextActivityName, string nextPropertyName);
body
{
	var string sql;
	sql = "insert into ProcessQueue (ProcessDefName, ProcessId, CurrActivityId, CurrActivityKind, CurrActivityName, ActivityId, ActivityKind, ActivityName, PropertyName, Status) values ('";
	sql = sql + processDefName + "','" + processId + "','" + activityId + "','" + activityKind + "','" + activityName + "','";
	sql = sql + nextActivityId + "','" + nextActivityKind + "','" + nextActivityName + "','" + nextPropertyName + "','manual')";
	conn.executeUpdate(sql);
}
end_body
member
public: void makeExecQueueItem(string processId, string activityId);
body
{
	var string sql;
	sql = "update ProcessQueue set Status='execute' where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
	conn.executeUpdate(sql);
}
end_body
member
public: void makeWaitQueueItem(string processId, string activityId, string time);
body
{
	var string sql;
	sql = "update ProcessQueue set Status='wait',Time='" + time + "' where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
	conn.executeUpdate(sql);
}
end_body
member
public: void makeSuspendQueueItem(string processId, string activityId);
body
{
	var string sql;
	sql = "update ProcessQueue set Status='suspend' where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
	conn.executeUpdate(sql);
}
end_body
member
public: void makeCleanupQueueItem(string processId);
body
{
	var string sql, time, cleanup_time;
	time = al_misc("get_time", null, null);
	if (pe.cleanup_time) {
		cleanup_time = getTime(pe.cleanup_time);
	} else {
		cleanup_time = getTime("24h");
	}
	time = (string)(time + cleanup_time);
	sql = "update ProcessQueue set Status='cleanup',Time='" + time + "' where ProcessId='" + processId + "'";
	conn.executeUpdate(sql);
}
end_body
member
public: void dequeueQueueItem(string processId, string activityId);
body
{
	var string sql;
	sql = "delete from ProcessQueue where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
	conn.executeUpdate(sql);
}
end_body
member
public: void handleError(string reason, AlException ex);
body
{
	var string msg;
	msg = reason;
	if (ex) {
		msg = msg + ": ";
		var file f;
		f = al_file_open(msg, "sa");
		al_file_write(f, "string", "\nException: " + ex.msg + "\n");
		al_misc("stack_trace", ex.stack_frame, f);
		al_misc("error_source", al_list2(ex.stack_frame, ex.pos), f);
		f = null;
	} else {
	}
	al_print("### [ERROR] " + msg + " (processId, activityId) = (" + (string)processId + ", " + (string)activityId + ")\n");
	process_log("error", msg);
	if (appServer) {
		msg = "ProcessLog: " + msg;
		if (al_strlen(msg) > XmlDbObject::MAX_VALUE_SIZE) {
			msg = al_substr(msg, 0, XmlDbObject::MAX_VALUE_SIZE);
		} else {
		}
		appServer.system_log("error", msg);
	} else {
	}
}
end_body
member
public: void process_log(string action, string msg);
body
{
	if (pe) {
		if (pe.process_log_filepath) {
			var string s;
			s = (string)action + ": " + (string)processDefName + ", " + (string)processId + ", " + (string)activityId + ", " + (string)activityName + ", " + (string)activityKind;
			if (msg != "") {
				s = s + ": " + msg;
			} else {
			}
			pe.ap_server.log(pe.process_log_filepath, s);
		} else {
		}
		if (pe.process_log_db) {
			var string sql, time;
			time = al_misc("get_time", null, null);
			time = al_misc("get_localtime", time, null);
			time = al_misc("format_time", time, "yyyy'/'MM'/'dd'-'HH':'mm':'ss");
			sql = al_copy("insert into ProcessLog (ProcessLogId, Action, Time, ProcessDefName, ActivityName, ActivityKind, ProcessId, ActivityId, Message) values ('");
			al_append_str(sql, conn.getNextSeq("ProcessLogId_seq"));
			al_append_str(sql, "','");
			al_append_str(sql, (string)action);
			al_append_str(sql, "','");
			al_append_str(sql, time);
			al_append_str(sql, "','");
			al_append_str(sql, (string)processDefName);
			al_append_str(sql, "','");
			al_append_str(sql, (string)activityName);
			al_append_str(sql, "','");
			al_append_str(sql, (string)activityKind);
			al_append_str(sql, "','");
			al_append_str(sql, (string)processId);
			al_append_str(sql, "','");
			al_append_str(sql, (string)activityId);
			al_append_str(sql, "','");
			al_append_str(sql, (string)DbUtility::convChar(msg));
			al_append_str(sql, "')");
			conn.executeUpdate(sql);
		} else {
		}
	} else {
	}
}
end_body
member
public: DbConnection conn;
member
public: string db_type;
member
public: ProcessEngine pe;
member
public: static ProcSched instance;
member
public: void invokePutProperty(string cmd_id, string processId, string name, string value);
body
{
	var list props, ret_props;
	props = getProperties(processId);
	ret_props = al_cons(null, null);
	al_create_arc(ret_props, value, name);
	putProperties(processId, props, ret_props);
	dequeueCmdQueueItem(cmd_id);
}
end_body
member
public: list invokeSuspend(string cmd_id, string processId);
body
{
	var string sql;
	var list rs, itr, rec;
	var integer count;
	sql = "select ProcessDefName from ProcessQueue where ProcessId='" + processId + "' and Status!='suspend'";
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	if (al_count(itr) == 0) {
		dequeueCmdQueueItem(cmd_id);
		return null;
	} else {
	}
	rec = al_next(itr);
	processDefName = al_dst_node(rec, 1);
	sql = "update ProcessQueue set Status='suspend' where ProcessId='" + processId + "'";
	conn.executeUpdate(sql);
	dequeueCmdQueueItem(cmd_id);
	process_log("suspended", "");
	return 1;
}
end_body
member
public: list invokeResume(string cmd_id, string processId);
body
{
	var string sql;
	var list rs, itr, rec;
	sql = "select ProcessDefName from ProcessQueue where ProcessId='" + processId + "' and Status='suspend'";
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	if (al_count(itr) == 0) {
		dequeueCmdQueueItem(cmd_id);
		return null;
	} else {
	}
	rec = al_next(itr);
	processDefName = al_dst_node(rec, 1);
	sql = "select ActivityId, ActivityKind, Status from ProcessActivities where ProcessId='" + processId + "' and Status='active'";
	rs = conn.executeQuery(3, sql);
	itr = al_dst_itr(rs);
	loop {
		activityId = activityKind = null;
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		activityId = al_dst_node(rec, 1);
		activityKind = al_dst_node(rec, 2);
		status = al_dst_node(rec, 3);
		if (activityKind == ProcMgr::Wait) {
			sql = "update ProcessQueue set Status='wait' where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
		} else {
			if (activityKind == ProcMgr::Manual) {
				sql = "update ProcessQueue set Status='manual' where ProcessId='" + processId + "' and CurrActivityId='" + activityId + "'";
			} else {
				sql = "update ProcessQueue set Status='execute' where ProcessId='" + processId + "' and ActivityId='" + activityId + "'";
			}
		}
		conn.executeUpdate(sql);
		process_log("resumed", "");
	}
	dequeueCmdQueueItem(cmd_id);
	return 1;
}
end_body
member
public: list invokeAbort(string cmd_id, string processId);
body
{
	var string sql;
	var list rs, itr, rec;
	sql = "select ProcessDefName from ProcessQueue where ProcessId='" + processId + "'";
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	if (al_count(itr) == 0) {
		dequeueCmdQueueItem(cmd_id);
		return null;
	} else {
	}
	rec = al_next(itr);
	processDefName = al_dst_node(rec, 1);
	invokeEnd(processId);
	dequeueCmdQueueItem(cmd_id);
	process_log("aborted", "");
	return 1;
}
end_body
member
public: list invokeDelete(string cmd_id, string processId);
body
{
	var string sql;
	var list rs, itr, rec;
	sql = "select ProcessDefName from ProcessQueue where ProcessId='" + processId + "'";
	rs = conn.executeQuery(1, sql);
	itr = al_dst_itr(rs);
	if (al_count(itr) == 0) {
		dequeueCmdQueueItem(cmd_id);
		return null;
	} else {
	}
	rec = al_next(itr);
	processDefName = al_dst_node(rec, 1);
	deleteProcess(processId);
	process_log("deleted", "");
	return 1;
}
end_body
member
public: list invokeCompleteByActivityName(string cmd_id, string processId, string activityName);
body
{
	var ProcMgr mgr;
	var string workItem;
	mgr = new ProcMgr;
	if (workItem = mgr.getWorkItem(processId, activityName, conn)) {
	} else {
		return null;
	}
	mgr.complete(processId, workItem, conn);
	dequeueCmdQueueItem(cmd_id);
	process_log("completed-by-name", "");
	return 1;
}
end_body
member
public: void dequeueCmdQueueItem(string cmd_id);
body
{
	var string sql;
	sql = "delete from CmdQueue where CmdQueueId='" + cmd_id + "'";
	conn.executeUpdate(sql);
}
end_body
end_class
class Process
member
public: list getDefinition();
body
{
	activities = al_cons(null, null);
	activity_seq = 0;
	initActivities();
	if (in_begin_end) {
		var string name;
		name = al_dst_node(activity, "ActivityName");
		var AlException ex;
		ex = new AlException;
		ex.msg = "illegal process definition: end() missing at activity '" + (string)name + "'.";
		throw ex;
	} else {
	}
	validate();
	properties = al_cons(null, null);
	initProperties();
	def = al_cons(null, null);
	al_create_arc(def, activities, "activities");
	al_create_arc(def, properties, "properties");
	return def;
}
end_body
member
public: void initActivities();
body
{
}
end_body
member
public: void beginActivity(string activityName, string activityKind);
body
{
	if (in_begin_end) {
		var string name;
		name = al_dst_node(activity, "ActivityName");
		var AlException ex;
		ex = new AlException;
		ex.msg = "illegal process definition: end() missing at activity '" + (string)name + "'.";
		throw ex;
	} else {
		in_begin_end = 1;
	}
	activity = al_cons(null, null);
	if (activityKind == ProcMgr::OrSplit && activityName == prevActivityName) {
		al_create_arc(activity, (string)activity_seq, "ActivityId");
	} else {
		al_create_arc(activity, (string)(activity_seq = activity_seq + 1), "ActivityId");
	}
	al_create_arc(activity, activityKind, "ActivityKind");
	al_create_arc(activity, activityName, "ActivityName");
	al_create_arc(activity, "0", "AndJoinCount");
	al_create_arc(activity, "0", "Time");
	al_create_arc(activity, "", "ClassName");
	al_create_arc(activity, "_defaut", "PropertyValue");
	al_create_arc(activity, "", "NextPropertyName");
}
end_body
member
public: void andJoinCount(string andJoinCount);
body
{
	al_set_dst_node(activity, "AndJoinCount", andJoinCount);
}
end_body
member
public: void waitTime(string waitTime);
body
{
	al_set_dst_node(activity, "Time", waitTime);
}
end_body
member
public: void serviceClass(string className);
body
{
	al_set_dst_node(activity, "ClassName", className);
}
end_body
member
public: void propertyValue(string propertyValue);
body
{
	al_set_dst_node(activity, "PropertyValue", propertyValue);
}
end_body
member
public: void next(string nextActivityName);
body
{
	al_set_dst_node(activity, "NextActivityName", nextActivityName);
}
end_body
member
public: void nextPropertyName(string nextPropertyName);
body
{
	al_set_dst_node(activity, "NextPropertyName", nextPropertyName);
}
end_body
member
public: void end();
body
{
	if (in_begin_end) {
		in_begin_end = null;
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "illegal process definition: end(), beginActivity missing.";
		throw ex;
	}
	var string activityName;
	activityName = al_dst_node(activity, "ActivityName");
	al_create_arc(activities, activity, activityName);
	prevActivityName = activityName;
}
end_body
member
public: list in_begin_end;
member
public: void validate();
body
{
	var list err, itr, act, next_act, itr2, found_begin, found_end;
	var string act_name, act_kind, next_act_name, next_act_id, next_act_kind;
	itr = al_dst_itr(activities);
	loop {
		if (act = al_next(itr)) {
		} else {
			break;
		}
		act_name = al_dst_node(act, "ActivityName");
		act_kind = al_dst_node(act, "ActivityKind");
		if (act_kind == ProcMgr::Begin) {
			found_begin = 1;
		} else {
		}
		if (act_kind == ProcMgr::Begin) {
			found_end = 1;
		} else {
		}
		if (next_act_name = al_dst_node(act, "NextActivityName")) {
		} else {
			if (act_kind != ProcMgr::End) {
				err = "next activity not specified: activity = " + (string)act_name;
				break;
			} else {
				al_set_dst_node(act, "NextActivityId", "");
				al_set_dst_node(act, "NextActivityKind", "");
				al_set_dst_node(act, "NextActivityName", "");
				continue;
			}
		}
		if (next_act = al_dst_node(activities, next_act_name)) {
			next_act_id = al_dst_node(next_act, "ActivityId");
			next_act_kind = al_dst_node(next_act, "ActivityKind");
			al_set_dst_node(act, "NextActivityId", next_act_id);
			al_set_dst_node(act, "NextActivityKind", next_act_kind);
			al_set_dst_node(act, "NextActivityName", next_act_name);
		} else {
			err = "next activity not found: activity = " + (string)act_name + ", next activity = " + (string)next_act_name;
			break;
		}
	}
	if (found_begin) {
	} else {
		err = "not found Begin activity";
	}
	if (found_end) {
	} else {
		err = "not found End activity";
	}
	if (err) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "illegal process definition: " + (string)err;
		throw ex;
	} else {
	}
}
end_body
member
public: void activity;
member
public: integer activity_seq;
member
public: string prevActivityName;
member
public: list activities;
member
public: void initProperties();
body
{
}
end_body
member
public: void putProperty(string name, string value);
body
{
	al_create_arc(properties, value, name);
}
end_body
member
public: list properties;
member
public: list def;
class RNIF20SendProcess
member
public: void initActivities();
body
{
	beginActivity("Begin", ProcMgr::Begin);
	next("CreateHeader");
	end();
	// CreateHeader
	beginActivity("CreateHeader", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("CreateHeaderIsError");
	end();
	beginActivity("CreateHeaderIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog.Error");
	end();
	beginActivity("CreateHeaderIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("PackMessage");
	end();
	// PackMessage
	beginActivity("PackMessage", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("PackMessageIsError");
	end();
	beginActivity("PackMessageIsError", ProcMgr::OrSplit);
	propertyValue("warnning");
	next("WriteLog.Warnning");
	end();
	beginActivity("PackMessageIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog.Error");
	end();
	beginActivity("PackMessageIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("SimpleSend");
	end();
	beginActivity("WriteLog.Warnning", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("SimpleSend");
	end();
	// SimpleSend
	beginActivity("SimpleSend", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("IsResponseCheck");
	end();
	beginActivity("IsResponseCheck", ProcMgr::OrSplit);
	propertyValue("wait_response");
	next("WaitResponseCheck");
	end();
	beginActivity("IsResponseCheck", ProcMgr::OrSplit);
	propertyValue("_default");
	next("WriteLog.SimpleSend");
	end();
	beginActivity("WaitResponseCheck", ProcMgr::Wait);
	waitTime("1s");
	next("ResponseCheck");
	end();
	beginActivity("ResponseCheck", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("IsResponseCheck");
	end();
	beginActivity("WriteLog.SimpleSend", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("SimpleSendIsError");
	end();
	beginActivity("SimpleSendIsError", ProcMgr::OrSplit);
	propertyValue("timeout");
	next("Complete");
	end();
	beginActivity("SimpleSendIsError", ProcMgr::OrSplit);
	propertyValue("retryover");
	next("CreateNOF");
	end();
	beginActivity("SimpleSendIsError", ProcMgr::OrSplit);
	propertyValue("true");
	nextPropertyName("retryover");
	next("ErrorRetryOverCheck");
	end();
	beginActivity("SimpleSendIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	nextPropertyName("needReceipt");
	next("NeedReceipt");
	end();
	// ErrorRetryOverCheck
	beginActivity("ErrorRetryOverCheck", ProcMgr::OrSplit);
	propertyValue("true");
	next("RetryOverLogInfo");
	end();
	beginActivity("ErrorRetryOverCheck", ProcMgr::OrSplit);
	propertyValue("_default");
	next("WaitErrorRetry");
	end();
	beginActivity("RetryOverLogInfo", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("WriteLog.RetryOver");
	end();
	// WaitErrorRetry
	beginActivity("WaitErrorRetry", ProcMgr::Wait);
	waitTime("$errorRetryTime");
	next("SimpleSend");
	end();
	// NeedReceipt
	beginActivity("NeedReceipt", ProcMgr::OrSplit);
	propertyValue("true");
	next("WaitReceipt");
	end();
	beginActivity("NeedReceipt", ProcMgr::OrSplit);
	propertyValue("_default");
	next("Complete");
	end();
	// WaitReceipt
	beginActivity("WaitReceipt", ProcMgr::Wait);
	waitTime("$receiptWaitTime");
	next("CheckReceipt");
	end();
	// CheckReceipt
	beginActivity("CheckReceipt", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("receiptExist");
	next("DoesReceiptExist");
	end();
	beginActivity("DoesReceiptExist", ProcMgr::OrSplit);
	propertyValue("true");
	next("NeedReply");
	end();
	beginActivity("DoesReceiptExist", ProcMgr::OrSplit);
	propertyValue("exception");
	next("Complete");
	end();
	beginActivity("DoesReceiptExist", ProcMgr::OrSplit);
	propertyValue("_default");
	nextPropertyName("retryover");
	next("RetryOverCheck");
	end();
	// RetryOverCheck
	beginActivity("RetryOverCheck", ProcMgr::OrSplit);
	propertyValue("true");
	next("RetryOverLogInfo");
	end();
	beginActivity("RetryOverCheck", ProcMgr::OrSplit);
	propertyValue("_default");
	next("SimpleSend");
	end();
	// NeedReply
	beginActivity("NeedReply", ProcMgr::OrSplit);
	propertyValue("true");
	next("WaitReply");
	end();
	beginActivity("NeedReply", ProcMgr::OrSplit);
	propertyValue("_default");
	next("Complete");
	end();
	// WaitReply
	beginActivity("WaitReply", ProcMgr::Wait);
	waitTime("$replyWaitTime");
	next("CheckReply");
	end();
	// CheckReply
	beginActivity("CheckReply", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("replyExist");
	next("DoesReplyExist");
	end();
	beginActivity("DoesReplyExist", ProcMgr::OrSplit);
	propertyValue("true");
	next("Complete");
	end();
	beginActivity("DoesReplyExist", ProcMgr::OrSplit);
	propertyValue("exception");
	next("Complete");
	end();
	beginActivity("DoesReplyExist", ProcMgr::OrSplit);
	propertyValue("_default");
	nextPropertyName("retryover");
	next("RetryOverCheck");
	end();
	// RetryOver
	beginActivity("WriteLog.RetryOver", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("CreateNOF");
	end();
	// CreateNOF
	beginActivity("CreateNOF", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("CreateNOFIsError");
	end();
	beginActivity("CreateNOFIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog.Error");
	end();
	beginActivity("CreateNOFIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("Send.NOF");
	end();
	// Send.NOF
	beginActivity("Send.NOF", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("SendNOFIsError");
	end();
	beginActivity("SendNOFIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog.Error");
	end();
	beginActivity("SendNOFIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("Complete");
	end();
	// WriteLog.Error
	beginActivity("WriteLog.Error", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("Complete");
	end();
	// Complete
	beginActivity("Complete", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("CompleteIsError");
	end();
	beginActivity("CompleteIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog.CompleteError");
	end();
	beginActivity("CompleteIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("Cleanup");
	end();
	// WriteLog.CompleteError
	beginActivity("WriteLog.CompleteError", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("Cleanup");
	end();
	// Cleanup
	beginActivity("Cleanup", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("End");
	end();
	// End
	beginActivity("End", ProcMgr::End);
	end();
}
end_body
member
public: void initProperties();
body
{
	// ---- process flow properties
	putProperty("protocol", "RNIF20");
	putProperty("startTime", "");
	putProperty("error", "none");
	putProperty("errorLevel", "info");
	putProperty("errorReason", "OK");
	putProperty("outerErrorReason", "");
	putProperty("retryCount", "0");
	putProperty("errorRetryCount", "0");
	putProperty("retryCountMax", "4");
	putProperty("errorRetryCountMax", "4");
	putProperty("errorRetryTime", "5m");
	putProperty("validationMode", "");
	putProperty("retryover", "false");
	putProperty("needReceipt", "false");
	putProperty("receiptWaitTime", "2h");
	putProperty("receiptExist", "");
	putProperty("needReply", "false");
	putProperty("replyWaitTime", "22h");
	putProperty("replyExist", "");
	// ---- interaction properties
	putProperty("syncType", "async");
	putProperty("useProxy", "false");
	putProperty("proxyMsgId", "");
	putProperty("msgId", "");
	putProperty("msgType", "");
	putProperty("msgVersion", "");
	putProperty("dtdFilename", "");
	putProperty("orgMsgId", "");
	putProperty("orgMsgType", "");
	putProperty("orgMsgVersion", "");
	putProperty("orgDtdFilename", "");
	putProperty("rMsgId", "");
	putProperty("rMsgType", "");
	putProperty("rMsgVersion", "");
	putProperty("rDtdFilename", "");
	putProperty("waitProcessId", "");
	putProperty("myId", "");
	putProperty("myRole", "");
	putProperty("partnerId", "");
	putProperty("partnerRole", "");
	// ---- PackMessage handler properties
	putProperty("tempDir", "");
	putProperty("attachDir", "");
	putProperty("sendDir", "");
	putProperty("domain", "");
	putProperty("encryptionAlgorithm", "");
	putProperty("encryptionPart", "");
	putProperty("encoding", "");
	putProperty("partnerCert", "");
	putProperty("sendSignature", "");
	putProperty("sendClientAuth", "");
	putProperty("myCert", "");
	putProperty("myKey", "");
	putProperty("caCert", "");
	putProperty("filename", "");
	putProperty("validationResult", "OK");
	putProperty("validationReason", "");
	// ---- WriteLog handler specific properties
	putProperty("URL", "");
	putProperty("messageId", "");
	putProperty("referenceId", "");
	putProperty("transactionId", "");
	putProperty("sendRecv", "send");
	putProperty("appProcessId", "");
}
end_body
end_class
class RNIF20ReceiveProcess
member
public: void initActivities();
body
{
	beginActivity("Begin", ProcMgr::Begin);
	next("UnpackMessage");
	end();
	// UnpackMessage
	beginActivity("UnpackMessage", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("UnpackMessageIsError");
	end();
	beginActivity("UnpackMessageIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog.UnpackMessageError");
	end();
	beginActivity("UnpackMessageIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("SaveToDB");
	end();
	beginActivity("WriteLog.UnpackMessageError", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("CreateReceiptException");
	end();
	// SaveToDB
	beginActivity("SaveToDB", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("SaveToDBIsError");
	end();
	beginActivity("SaveToDBIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog.SaveToDBError");
	end();
	beginActivity("SaveToDBIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	nextPropertyName("isSignal");
	next("IsSignal");
	end();
	beginActivity("WriteLog.SaveToDBError", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("CreateReceiptException");
	end();
	// IsSignal
	beginActivity("IsSignal", ProcMgr::OrSplit);
	propertyValue("true");
	next("ReceiveProcess");
	end();
	beginActivity("IsSignal", ProcMgr::OrSplit);
	propertyValue("_default");
	next("PreValidationCheck");
	end();
	// PreValidationCheck
	beginActivity("PreValidationCheck", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("validationResult");
	next("ValidationCheck");
	end();
	// ValidationCheck
	beginActivity("ValidationCheck", ProcMgr::OrSplit);
	propertyValue("error");
	next("WriteLog.ValidationError");
	end();
	beginActivity("ValidationCheck", ProcMgr::OrSplit);
	propertyValue("warnning");
	next("WriteLog.Warnning");
	end();
	beginActivity("ValidationCheck", ProcMgr::OrSplit);
	propertyValue("_default");
	next("CreateReceiptAck");
	end();
	beginActivity("WriteLog.ValidationError", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("CreateReceiptException");
	end();
	beginActivity("WriteLog.Warnning", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("CreateReceiptAck");
	end();
	// CreateReceiptException
	beginActivity("CreateReceiptException", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("CreateReceiptExceptionIsError");
	end();
	beginActivity("CreateReceiptExceptionIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog");
	end();
	beginActivity("CreateReceiptExceptionIsError", ProcMgr::OrSplit);
	propertyValue("process");
	next("WriteLog");
	end();
	beginActivity("CreateReceiptExceptionIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("Send.ReceiptException");
	end();
	// Send.ReceiptExeption
	beginActivity("Send.ReceiptException", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("SendReceiptExceptionIsError");
	end();
	beginActivity("SendReceiptExceptionIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog");
	end();
	beginActivity("SendReceiptExceptionIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("Cleanup");
	end();
	// CreateReceiptAck
	beginActivity("CreateReceiptAck", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("CreateReceiptAckIsError");
	end();
	beginActivity("CreateReceiptAckIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog");
	end();
	beginActivity("CreateReceiptAckIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("Send.ReceiptAck");
	end();
	// Send.ReceiptAck
	beginActivity("Send.ReceiptAck", ProcMgr::Auto);
	serviceClass("ServiceClass");
	nextPropertyName("error");
	next("SendReceiptAckIsError");
	end();
	beginActivity("SendReceiptAckIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog");
	end();
	beginActivity("SendReceiptAckIsError", ProcMgr::OrSplit);
	propertyValue("process");
	next("WriteLog.ReceiveProcess");
	end();
	beginActivity("SendReceiptAckIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("WriteLog.WaitSendReceiptAck");
	end();
	// WaitSendReceiptAck
	beginActivity("WriteLog.WaitSendReceiptAck", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("WaitSendReceiptAck");
	end();
	beginActivity("WaitSendReceiptAck", ProcMgr::Manual);
	nextPropertyName("error");
	next("WaitSendReceiptAckIsError");
	end();
	beginActivity("WaitSendReceiptAckIsError", ProcMgr::OrSplit);
	propertyValue("true");
	next("WriteLog");
	end();
	beginActivity("WaitSendReceiptAckIsError", ProcMgr::OrSplit);
	propertyValue("_default");
	next("ReceiveProcess");
	end();
	// ReceiveProcess
	beginActivity("WriteLog.ReceiveProcess", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("ReceiveProcess");
	end();
	beginActivity("ReceiveProcess", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("WriteLog");
	end();
	// WriteLog
	beginActivity("WriteLog", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("Cleanup");
	end();
	// Cleanup
	beginActivity("Cleanup", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("End");
	end();
	// End
	beginActivity("End", ProcMgr::End);
	end();
}
end_body
member
public: void initProperties();
body
{
	// ---- process flow properties
	putProperty("protocol", "RNIF20");
	putProperty("startTime", "");
	putProperty("error", "none");
	putProperty("errorLevel", "info");
	putProperty("errorReason", "OK");
	putProperty("outerErrorCode", "");
	putProperty("outerErrorReason", "");
	putProperty("headerParsed", "false");
	putProperty("isSignal", "false");
	putProperty("validationResult", "OK");
	putProperty("cleanup", "");
	// ---- servlet specific properties
	putProperty("syncType", "async");
	putProperty("useProxy", "false");
	putProperty("proxyMsgId", "");
	putProperty("msgId", "");
	putProperty("msgType", "");
	putProperty("msgVersion", "");
	putProperty("dtdFilename", "");
	putProperty("orgMsgType", "");
	putProperty("orgMsgVersion", "");
	putProperty("orgDtdFilename", "");
	putProperty("fromIP", "");
	putProperty("certInfo", "");
	putProperty("tempDir", "");
	putProperty("attachDir", "");
	putProperty("filename", "");
	// ---- Unpack handler specific properties
	putProperty("partnerId", "");
	putProperty("myId", "");
	putProperty("messageId", "");
	putProperty("referenceId", "");
	putProperty("transactionId", "");
	putProperty("nextAction", "");
	putProperty("partnerRole", "");
	putProperty("myRole", "");
	putProperty("validationMode", "");
	putProperty("messageDigest", "");
	// ---- SaveToDB handler specific properties
	putProperty("docGenDatetime", "");
	putProperty("docId", "");
	putProperty("validationReason", "");
	// ---- Create Ack,Exception,NOF handler specific properties
	putProperty("rMsgId", "");
	putProperty("rMsgType", "");
	putProperty("rMsgVersion", "");
	putProperty("rDtdFilename", "");
	// ---- ReceiveProcess handler specific properties
	putProperty("appProcessId", "");
	// ---- WriteLog handler specific properties
	putProperty("sendRecv", "recv");
}
end_body
end_class
class PoSendProcess
member
public: void initActivities();
body
{
	beginActivity("Begin", ProcMgr::Begin);
	next("CreatePoRequest");
	end();
	// Catalog
	beginActivity("CreatePoRequest", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("Approval");
	end();
	// Approval
	beginActivity("Approval", ProcMgr::Manual);
	next("Transmit");
	end();
	// Transmit
	beginActivity("Transmit", ProcMgr::Manual);
	next("SendPoRequest");
	end();
	beginActivity("SendPoRequest", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("WaitConfirm");
	end();
	// WaitConfirm
	beginActivity("WaitConfirm", ProcMgr::Manual);
	next("End");
	end();
	// End
	beginActivity("End", ProcMgr::End);
	end();
}
end_body
member
public: void initProperties();
body
{
	putProperty("protocol", "SampleBuyer");
	// my corp, partner corp
	putProperty("buyer", "");
	putProperty("supplier", "");
	// order info
	putProperty("product1", "");
	putProperty("quantity1", "");
	putProperty("price1", "");
	putProperty("shipDate1", "");
	putProperty("product2", "");
	putProperty("quantity2", "");
	putProperty("price2", "");
	putProperty("shipDate2", "");
	// send message info
	putProperty("msgId", "");
	putProperty("myId", "");
	putProperty("myRole", "");
	putProperty("partnerId", "");
	putProperty("partnerRole", "");
}
end_body
end_class
class PoReceiveProcess
member
public: void initActivities();
body
{
	beginActivity("Begin", ProcMgr::Begin);
	next("Receipt");
	end();
	// Receipt
	beginActivity("Receipt", ProcMgr::Manual);
	next("CreatePoAcceptance");
	end();
	beginActivity("CreatePoAcceptance", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("SendPoAcceptance");
	end();
	beginActivity("SendPoAcceptance", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("Inventory");
	end();
	// Inventory
	beginActivity("Inventory", ProcMgr::Manual);
	next("Fulfill");
	end();
	// Fulfill
	beginActivity("Fulfill", ProcMgr::Manual);
	next("CreateAdvanceShipmentNotification");
	end();
	beginActivity("CreateAdvanceShipmentNotification", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("SendAdvanceShipmentNotification");
	end();
	beginActivity("SendAdvanceShipmentNotification", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("Invoice");
	end();
	// Invoice
	beginActivity("Invoice", ProcMgr::Manual);
	next("CreateInvoiceNotification");
	end();
	beginActivity("CreateInvoiceNotification", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("SendInvoiceNotification");
	end();
	beginActivity("SendInvoiceNotification", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("End");
	end();
	// End
	beginActivity("End", ProcMgr::End);
	end();
}
end_body
member
public: void initProperties();
body
{
	putProperty("protocol", "SampleSupplier");
	putProperty("msgId", "");
	// send message info
	putProperty("sendMsgId", "");
	putProperty("myId", "");
	putProperty("myRole", "");
	putProperty("partnerId", "");
	putProperty("partnerRole", "");
}
end_body
end_class
class PoCompleteProcess
member
public: void initActivities();
body
{
	beginActivity("Begin", ProcMgr::Begin);
	next("Complete");
	end();
	// Complete PoSendProcess
	beginActivity("Complete", ProcMgr::Auto);
	serviceClass("ServiceClass");
	next("End");
	end();
	// End
	beginActivity("End", ProcMgr::End);
	end();
}
end_body
member
public: void initProperties();
body
{
	putProperty("protocol", "SampleBuyer");
	putProperty("msgId", "");
}
end_body
end_class
class TestProcess1
member
public: void initActivities();
body
{
	beginActivity("begin", ProcMgr::Begin);
	next("join1");
	end();
	beginActivity("join1", ProcMgr::OrJoin);
	nextPropertyName("result");
	next("or1");
	end();
	beginActivity("or1", ProcMgr::OrSplit);
	propertyValue("error");
	next("wait1");
	end();
	beginActivity("or1", ProcMgr::OrSplit);
	propertyValue("_default");
	next("wait2");
	end();
	beginActivity("wait1", ProcMgr::Wait);
	waitTime("2");
	next("check1");
	end();
	beginActivity("check1", ProcMgr::Auto);
	serviceClass("TestPeService1");
	nextPropertyName("result");
	next("or2");
	end();
	beginActivity("or2", ProcMgr::OrSplit);
	propertyValue("error");
	next("join1");
	end();
	beginActivity("or2", ProcMgr::OrSplit);
	propertyValue("false");
	next("join1");
	end();
	beginActivity("or2", ProcMgr::OrSplit);
	propertyValue("_default");
	next("join2");
	end();
	beginActivity("wait2", ProcMgr::Wait);
	waitTime("5");
	next("check2");
	end();
	beginActivity("check2", ProcMgr::Auto);
	serviceClass("TestPeService1");
	nextPropertyName("result");
	next("or3");
	end();
	beginActivity("or3", ProcMgr::OrSplit);
	propertyValue("error");
	next("join1");
	end();
	beginActivity("or3", ProcMgr::OrSplit);
	propertyValue("false");
	next("join1");
	end();
	beginActivity("or3", ProcMgr::OrSplit);
	propertyValue("_default");
	next("join2");
	end();
	beginActivity("join2", ProcMgr::OrJoin);
	next("end");
	end();
	beginActivity("end", ProcMgr::End);
	end();
}
end_body
member
public: void initProperties();
body
{
	putProperty("msgId", "");
	putProperty("logId", "");
	putProperty("toRole", "");
	putProperty("fromRole", "");
	putProperty("actionId", "");
	putProperty("transactionId", "");
	putProperty("result", "");
	putProperty("count", "1");
	putProperty("errorCount", "1");
	putProperty("countMax", "4");
	putProperty("errorCountMax", "");
	putProperty("attemntCount", "1");
	putProperty("errorRetryTime", "");
	putProperty("receiptWaitTime", "");
	putProperty("validationMode", "");
	putProperty("valdationResult", "");
}
end_body
end_class
class TestProcess2
member
public: void initActivities();
body
{
	beginActivity("begin", ProcMgr::Begin);
	next("join1");
	end();
	beginActivity("join1", ProcMgr::OrJoin);
	nextPropertyName("end");
	next("or1");
	end();
	beginActivity("or1", ProcMgr::OrSplit);
	propertyValue("end");
	next("end");
	end();
	beginActivity("or1", ProcMgr::OrSplit);
	propertyValue("_default");
	next("auto1");
	end();
	beginActivity("auto1", ProcMgr::Auto);
	serviceClass("TestPeService2");
	next("join1");
	end();
	beginActivity("end", ProcMgr::End);
	end();
}
end_body
member
public: void initProperties();
body
{
	putProperty("end", "");
	putProperty("count", "0");
}
end_body
end_class
end_class
class PeService
member
public: list invoke(list props);
body
{
}
end_body
member
public: DbConnection conn;
member
public: string db_type;
member
public: list debug_mode;
member
public: list exception_detail;
class ServiceClass
member
public: list invoke(list props);
body
{
	var string protocol, activity_name, class_name, method_name;
	var ServiceHandler handler;
	var integer idx;
	var list ret, arg_dcl, arg1, args;
	if (protocol = al_dst_node(props, "protocol")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "process: protocol must not be empty.";
		throw ex;
	}
	class_name = protocol + "ServiceHandler";
	if (handler = al_gp("new", class_name, null, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "process: ServiceHandler for protocol '" + (string)protocol + "' not found.";
		throw ex;
	}
	handler.conn = conn;
	handler.db_type = db_type;
	handler.debug_mode = debug_mode;
	handler.exception_detail = exception_detail;
	if (activity_name = al_dst_node(props, "*activity.name")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "process: activity name must not be empty.";
		throw ex;
	}
	idx = al_search_str(activity_name, 0, ".");
	if (idx >= 0) {
		method_name = "invoke" + al_substr(activity_name, 0, idx);
	} else {
		method_name = "invoke" + activity_name;
	}
	arg_dcl = get_arg_dcl(null);
	arg1 = al_list3(arg_dcl.head, props, null);
	args = al_cons(arg1, null);
	try {
		if (debug_mode) {
			al_print("======== enter " + protocol + ", " + activity_name + "\n");
		} else {
		}
		ret = al_gp("run2", handler, arg_dcl, method_name, args);
		if (debug_mode) {
			al_print("======== leave " + protocol + ", " + activity_name + ": retrun properties are as follows.\n");
			var list itr;
			var string name, value;
			itr = al_dst_itr(ret);
			loop {
				if (value = al_next(itr)) {
				} else {
					break;
				}
				name = al_arc_a(itr);
				al_print(name + " = " + value + "\n");
			}
		} else {
		}
		if (ret == 0x0000000080000000) {
			var AlException ex;
			ex = new AlException;
			ex.msg = "process: ServiceHandler for protocol '" + (string)protocol + "' does not have method for activity '" + activity_name + "'.";
			throw ex;
		} else {
		}
	} catch (AlException e) {
		e.msg = "process: ServiceHandler method invocation error. protocol = '" + (string)protocol + "', activity = '" + (string)activity_name + "': exception message = " + e.msg;
		throw e;
	}
	return ret;
}
end_body
member
public: list get_arg_dcl(list props);
body
{
	return al_gp("arg_dcl", null, null, null, null);
}
end_body
end_class
class PoSyncAcceptService
member
public: list invoke(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	// get org db object
	var XmlDbObject org_obj, org_obj2, org_obj3;
	var string orgMsgId, orgMsgType, orgMsgVersion, org_dtd_filename;
	orgMsgId = al_dst_node(props, "msgId");
	orgMsgType = "Pip3A4PurchaseOrderRequest";
	orgMsgVersion = "1.1";
	org_dtd_filename = "rosetta/3A4PurchaseOrderRequestMessageGuideline_v1_1.dtd";
	org_obj = XmlUtility::getMsgData(orgMsgId, orgMsgType, orgMsgVersion, org_dtd_filename, conn);
	// create db object
	var XmlDbObject obj, obj2, obj3;
	var string msgId, msgType, msgVersion, dtd_filename;
	msgType = "Pip3A4PurchaseOrderAcceptance";
	msgVersion = "1.1";
	dtd_filename = "rosetta/3A4PurchaseOrderAcceptanceMessageGuideline_v1_1.dtd";
	obj = XmlUtility::createMsgData(msgId, msgType, msgVersion, dtd_filename, conn);
	msgId = obj.msgId;
	al_set_dst_node(ret, "rMsgId", msgId);
	// set csv data
	var Csv1DataItr csv_itr, csv_itr2, csv_itr3;
	var list org_obj2_ls, org_obj2_itr;
	csv_itr = new Csv1DataItr;
	csv_itr.loadCSV("./data/rosetta_sample/POAccept.csv");
	csv_itr.Reset();
	loop {
		if (csv_itr.nextRow()) {
		} else {
			break;
		}
		if (csv_itr.src_path != "") {
			obj.putField(csv_itr.dst_path, org_obj.getField(csv_itr.src_path));
		} else {
			obj.putField(csv_itr.dst_path, csv_itr.value);
		}
	}
	org_obj2_ls = org_obj.getChildren("Pip3A4PurchaseOrderRequest/PurchaseOrder/ProductLineItem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	org_obj2_itr = al_dst_itr(org_obj2_ls);
	loop {
		if (org_obj2 = al_next(org_obj2_itr)) {
		} else {
			break;
		}
		csv_itr.Reset();
		csv_itr2 = csv_itr.nextChild("ProductLineItem");
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			if (csv_itr2.src_path != "") {
				obj2.putField(csv_itr2.dst_path, org_obj2.getField(csv_itr2.src_path));
			} else {
				obj2.putField(csv_itr2.dst_path, csv_itr2.value);
			}
		}
		csv_itr2.Reset();
		csv_itr3 = csv_itr2.nextChild("ProductQuantity");
		obj3 = obj2.createChild(csv_itr3.base_dst_path);
		obj3.putField("", org_obj2.getField("ProductQuantity"));
	}
	var string my_id, my_role, partner_id, partner_role;
	var list partner_props, my_props;
	var XmlDbObject my_info_obj;
	var RNContext ctx;
	ctx = new RNContext;
	// partner info
	partner_id = al_dst_node(props, "partnerId");
	partner_role = al_dst_node(props, "partnerRole");
	partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
	obj.putField("Pip3A4PurchaseOrderAcceptance/toRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", (string)al_dst_node(partner_props, "Class"));
	obj.putField("Pip3A4PurchaseOrderAcceptance/toRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", partner_id);
	// my info
	my_id = al_dst_node(props, "myId");
	my_role = al_dst_node(props, "myRole");
	my_info_obj = ctx.getMyInfoXmlDbObject(my_role, conn);
	my_id = my_info_obj.getField("MyInfo/BusinessId");
	my_props = ctx.getMyProperties(my_role, conn);
	obj.putField("Pip3A4PurchaseOrderAcceptance/fromRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", (string)al_dst_node(my_props, "Class"));
	obj.putField("Pip3A4PurchaseOrderAcceptance/fromRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", my_id);
	// common info
	obj.putField("Pip3A4PurchaseOrderAcceptance/thisDocumentGenerationDateTime/DateTimeStamp", RNContext::currentDateTime());
	obj.putField("Pip3A4PurchaseOrderAcceptance/thisDocumentIdentifier/ProprietaryDocumentIdentifier", RNContext::genDocId());
	var string req_doc_gen_date_time, req_doc_id;
	req_doc_gen_date_time = org_obj.getField("Pip3A4PurchaseOrderRequest/thisDocumentGenerationDateTime/DateTimeStamp");
	req_doc_id = org_obj.getField("Pip3A4PurchaseOrderRequest/thisDocumentIdentifier/ProprietaryDocumentIdentifier");
	obj.putField("Pip3A4PurchaseOrderAcceptance/requestingDocumentDateTime/DateTimeStamp", req_doc_gen_date_time);
	obj.putField("Pip3A4PurchaseOrderAcceptance/requestingDocumentIdentifier/ProprietaryDocumentIdentifier", req_doc_id);
	// other
	obj.putField("Pip3A4PurchaseOrderAcceptance/PurchaseOrder/purchaseOrderDate/DateStamp", RNContext::currentDateStamp());
	return ret;
}
end_body
end_class
class TestPeService1
member
public: list invoke(list props);
body
{
	var list ret;
	var integer count, countMax;
	ret = al_cons(null, null);
	count = (integer)al_dst_node(props, "count");
	countMax = (integer)al_dst_node(props, "countMax");
	if (count >= countMax) {
		al_set_dst_node(ret, "result", "retryover");
	} else {
		count = count + 1;
		al_set_dst_node(ret, "count", (string)count);
		al_set_dst_node(ret, "result", "error");
	}
	return ret;
}
end_body
end_class
class TestPeService2
member
public: list invoke(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var integer count;
	count = (integer)al_dst_node(props, "count");
	if (count >= 1000) {
		al_set_dst_node(ret, "end", "end");
	} else {
	}
	count = count + 1;
	al_set_dst_node(ret, "count", (string)count);
	return ret;
}
end_body
end_class
end_class
class ServiceHandler
member
public: DbConnection conn;
member
public: string db_type;
member
public: string fromUTF8(string str);
body
{
	if (str) {
	} else {
		return null;
	}
	var string platform, s;
	platform = al_misc("platform", null, null);
	if (s = al_str_misc("utf8_to_sjis", str, null)) {
		str = s;
	} else {
	}
	if (platform == "linux" || platform == "mac") {
		if (s = al_str_misc("sjis_to_euc", str, null)) {
			str = s;
		} else {
		}
	} else {
	}
	return str;
}
end_body
member
public: string toUTF8(string str);
body
{
	if (str) {
	} else {
		return "";
	}
	var string platform, s;
	platform = al_misc("platform", null, null);
	if (platform == "linux" || platform == "mac") {
		if (s = al_str_misc("euc_to_sjis", str, null)) {
			str = s;
		} else {
		}
	} else {
	}
	if (s = al_str_misc("sjis_to_utf8", str, null)) {
		str = s;
	} else {
	}
	return str;
}
end_body
member
public: string errorMsg(string msg, AlException e);
body
{
	var string str;
	var file f;
	str = al_copy(msg);
	if (e != null) {
		f = al_file_open(str, "sa");
		al_file_write(f, "string", ": " + (string)e.msg + "\n");
		if (exception_detail) {
			al_file_write(f, "string", "StackTrace:\n");
			al_misc("stack_trace", e.stack_frame, f);
			al_file_write(f, "string", "ErrorSource:\n");
			al_misc("error_source", al_list2(e.stack_frame, e.pos), f);
		} else {
		}
		f = null;
	} else {
	}
	return str;
}
end_body
member
public: list debug_mode;
member
public: list exception_detail;
member
public: void dumpProps(list props);
body
{
	al_print("==== begin Dump props <<<<\n");
	var list itr;
	var string name, value;
	itr = al_dst_itr(props);
	loop {
		if (value = al_next(itr)) {
		} else {
			break;
		}
		name = al_arc_a(itr);
		value = value;
		al_print("name = " + (string)name + ", value = " + (string)value + "\n");
	}
	al_print("==== end Dump props >>>>\n");
}
end_body
class RNIF20ServiceHandler
member
public: list invokeCreateHeader(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string msg, domain;
	var string msg_type, msg_version, dtd_filename;
	var string org_msgId, org_msg_type, org_msg_version, org_dtd_filename;
	var string next_action;
	var string type;
	var RNContext ctx;
	var list pip_props, org_pip_props;
	var string my_role, partner_role, my_default_props, my_props, partner_props;
	var string val;
	msgId = al_dst_node(props, "msgId");
	try {
		var XmlDbAccessor acc;
		acc = new XmlDbAccessor;
		acc.create("", "", conn);
		acc.getWithMsgTypeAndMsgVersion(msgId);
		msg_type = acc.msgType;
		msg_version = acc.msgVersion;
		dtd_filename = acc._dtd_filename;
		al_set_dst_node(ret, "msgType", msg_type);
		al_set_dst_node(ret, "msgVersion", msg_version);
		al_set_dst_node(ret, "dtdFilename", dtd_filename);
	} catch (AlException e) {
		msg = errorMsg("fail to get msgType/msgVersion/dtdFilename: msgId = " + (string)msgId, e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	org_msgId = al_dst_node(props, "orgMsgId");
	try {
		if (org_msgId && org_msgId != "") {
			var XmlDbAccessor acc;
			acc = new XmlDbAccessor;
			acc.create("", "", conn);
			acc.getWithMsgTypeAndMsgVersion(org_msgId);
			org_msg_type = acc.msgType;
			org_msg_version = acc.msgVersion;
			org_dtd_filename = acc._dtd_filename;
			al_set_dst_node(ret, "orgMsgType", org_msg_type);
			al_set_dst_node(ret, "orgMsgVersion", org_msg_version);
			al_set_dst_node(ret, "orgDtdFilename", org_dtd_filename);
		} else {
		}
	} catch (AlException e) {
		msg = errorMsg("fail to get msgType/msgVersion/dtdFilename: org_msgId = " + (string)msgId, e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	my_id = al_dst_node(props, "myId");
	my_role = al_dst_node(props, "myRole");
	partner_id = al_dst_node(props, "partnerId");
	partner_role = al_dst_node(props, "partnerRole");
	ctx = new RNContext;
	try {
		pip_props = ctx.getPipProperties(msg_type, msg_version, conn);
	} catch (AlException e) {
		msg = errorMsg("fail to create header. fail to get pip properties.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	if (msg_type != "Pip0A1FailureNotification" && org_msg_type && org_msg_version) {
		try {
			org_pip_props = ctx.getPipProperties(org_msg_type, org_msg_version, conn);
		} catch (AlException e) {
			msg = errorMsg("fail to create header. fail to get org pip properties.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "fatal");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	if (org_pip_props) {
		if (msg_type == "ReceiptAcknowledgment" || msg_type == "Exception") {
			type = "Signal";
		} else {
			type = "Response";
			al_set_dst_node(ret, "needReceipt", "true");
			next_action = al_dst_node(pip_props, "NextAction");
			if (next_action && next_action != "") {
				al_set_dst_node(ret, "needReply", "true");
			} else {
			}
		}
	} else {
		type = "Request";
		al_set_dst_node(ret, "needReceipt", "true");
		next_action = al_dst_node(pip_props, "NextAction");
		if (next_action && next_action != "") {
			al_set_dst_node(ret, "needReply", "true");
		} else {
		}
	}
	try {
		if (my_role == "") {
			my_role = ctx.getMyRole(partner_id, msg_type, conn);
		} else {
		}
		if (partner_role == "") {
			partner_role = ctx.getPartnerRole(partner_id, msg_type, conn);
		} else {
		}
	} catch (AlException e) {
		if (my_role == "") {
			my_role = "default";
		} else {
		}
		if (partner_role == "") {
			partner_role = "default";
		} else {
		}
	}
	al_set_dst_node(ret, "myRole", my_role);
	al_set_dst_node(ret, "partnerRole", partner_role);
	try {
		my_default_props = ctx.getMyProperties("-- default setting --", conn);
		al_set_dst_node(ret, "tempDir", al_dst_node(my_default_props, "msg.tmp.dir"));
		al_set_dst_node(ret, "attachDir", attach_dir = al_dst_node(my_default_props, "msg.attach.dir"));
		al_set_dst_node(ret, "sendDir", al_dst_node(my_default_props, "msg.send.dir"));
		al_set_dst_node(ret, "domain", al_dst_node(my_default_props, "domain"));
	} catch (AlException e) {
		msg = errorMsg("fail to create header. fail to get my -- default setting -- properties.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	try {
		my_props = ctx.getMyProperties(my_role, conn);
		al_set_dst_node(ret, "myCert", al_dst_node(my_props, "cert"));
		al_set_dst_node(ret, "myKey", al_dst_node(my_props, "key"));
		al_set_dst_node(ret, "caCert", al_dst_node(my_props, "ca.cert"));
	} catch (AlException e) {
		msg = errorMsg("fail to create header. fail to get my properties: myRole = " + my_role + ".", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	try {
		partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
		al_set_dst_node(ret, "retryCountMax", al_dst_node(partner_props, "retry.max"));
		al_set_dst_node(ret, "errorRetryCountMax", al_dst_node(partner_props, "error.retry.max"));
		al_set_dst_node(ret, "errorRetryTime", al_dst_node(partner_props, "error.retry.time"));
		al_set_dst_node(ret, "receiptWaitTime", al_dst_node(partner_props, "receipt.wait.time"));
		al_set_dst_node(ret, "replyWaitTime", al_dst_node(partner_props, "reply.wait.time"));
		al_set_dst_node(ret, "encryptionAlgorithm", al_dst_node(partner_props, "encryption.algorithm"));
		al_set_dst_node(ret, "encryptionPart", al_dst_node(partner_props, "encryption.part"));
		al_set_dst_node(ret, "encoding", al_dst_node(partner_props, "encoding"));
		al_set_dst_node(ret, "partnerCert", al_dst_node(partner_props, "cert"));
		usage_code = al_dst_node(partner_props, "usage.code");
		al_set_dst_node(ret, "sendSignature", al_dst_node(partner_props, "send.signature"));
		al_set_dst_node(ret, "sendClientAuth", al_dst_node(partner_props, "send.client.auth"));
		al_set_dst_node(ret, "validationMode", al_dst_node(partner_props, "validation.mode"));
	} catch (AlException e) {
		msg = errorMsg("fail to create header. fail to get partner properties: partnerId = " + partner_id + ", partnerRole = " + partner_role + ".", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	if (type == "Response" || type == "Signal") {
		var XmlDbAccessor acc;
		var XmlDbObject obj;
		try {
			acc = new XmlDbAccessor;
			acc.create("DeliveryHeader", "V02.00", conn);
			acc.setDTDfilename("rosetta/DeliveryHeader_MS_V02_00.dtd");
			obj = acc.get(org_msgId);
			reply_id = obj.getField("DeliveryHeader/messageTrackingID/InstanceIdentifier");
			al_set_dst_node(ret, "referenceId", reply_id);
		} catch (AlException e) {
			msg = errorMsg("fail to create header. fail to read original mesage service header.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		try {
			acc = new XmlDbAccessor;
			acc.create("ServiceHeader", "V02.00", conn);
			acc.setDTDfilename("rosetta/ServiceHeader_MS_V02_00.dtd");
			obj = acc.get(org_msgId);
			process_id = obj.getField("ServiceHeader/ProcessControl/pipInstanceId/InstanceIdentifier");
			al_set_dst_node(ret, "transactionId", process_id);
			from_role_class = obj.getField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toRole/GlobalPartnerRoleClassificationCode");
			from_service = obj.getField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toService/GlobalBusinessServiceCode");
			to_role_class = obj.getField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromRole/GlobalPartnerRoleClassificationCode");
			to_service = obj.getField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromService/GlobalBusinessServiceCode");
			usage_code = obj.getField("ServiceHeader/ProcessControl/GlobalUsageCode");
			initiator = obj.getField("ServiceHeader/ProcessControl/KnownInitiatingPartner/PartnerIdentification/GlobalBusinessIdentifier");
		} catch (AlException e) {
			msg = errorMsg("fail to create header. fail to read original mesage service header.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		try {
			acc = new XmlDbAccessor;
			acc.create(org_msg_type, org_msg_version, conn);
			acc.setDTDfilename(org_dtd_filename);
			obj = acc.get(org_msgId);
			req_doc_id = obj.getField(org_msg_type + "/thisDocumentIdentifier/ProprietaryDocumentIdentifier");
		} catch (AlException e) {
			req_doc_id = XmlUtility::ctrl_a;
		}
	} else {
	}
	if (type == "Request") {
		process_code = al_dst_node(pip_props, "ProcessCode");
		indicator = al_dst_node(pip_props, "Indicator");
		process_id = RNContext::genProcessId();
		al_set_dst_node(ret, "transactionId", process_id);
		process_version = al_dst_node(pip_props, "ProcessVersion");
		msg_code = al_dst_node(pip_props, "MessageCode");
		msg_ver = al_dst_node(pip_props, "MessageVersion");
		from_role_class = al_dst_node(pip_props, "FromRoleClass");
		from_service = al_dst_node(pip_props, "FromService");
		to_role_class = al_dst_node(pip_props, "ToRoleClass");
		to_service = al_dst_node(pip_props, "ToService");
		initiator = my_id;
	} else {
	}
	if (type == "Response") {
		process_code = al_dst_node(pip_props, "ProcessCode");
		indicator = al_dst_node(pip_props, "Indicator");
		process_version = al_dst_node(pip_props, "ProcessVersion");
		reply_code = al_dst_node(org_pip_props, "MessageCode");
		msg_code = al_dst_node(pip_props, "MessageCode");
		msg_ver = al_dst_node(pip_props, "MessageVersion");
		from_role_class = al_dst_node(pip_props, "FromRoleClass");
		from_service = al_dst_node(pip_props, "FromService");
		to_role_class = al_dst_node(pip_props, "ToRoleClass");
		to_service = al_dst_node(pip_props, "ToService");
	} else {
	}
	if (type == "Signal") {
		process_code = al_dst_node(org_pip_props, "ProcessCode");
		indicator = al_dst_node(org_pip_props, "Indicator");
		process_version = al_dst_node(org_pip_props, "ProcessVersion");
		reply_code = al_dst_node(org_pip_props, "MessageCode");
		msg_code = al_dst_node(pip_props, "MessageCode");
		msg_ver = al_dst_node(pip_props, "MessageVersion");
	} else {
	}
	try {
		createPreamble();
	} catch (AlException e) {
		msg = errorMsg("fail to create preamble.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	try {
		createDeliveryHeader();
	} catch (AlException e) {
		msg = errorMsg("fail to create delivery header.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	try {
		if (type == "Request") {
			createRequestServiceHeader();
		} else {
		}
		if (type == "Response") {
			createResponseServiceHeader();
		} else {
		}
		if (type == "Signal") {
			createSignalServiceHeader();
		} else {
		}
		al_set_dst_node(ret, "messageId", message_id);
	} catch (AlException e) {
		msg = errorMsg("fail to create service header.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	return ret;
}
end_body
member
public: void createPreamble();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	acc = new XmlDbAccessor;
	acc.create("Preamble", "V02.00", conn);
	acc.setDTDfilename("rosetta/Preamble_MS_V02_00.dtd");
	obj = acc.create(msgId);
	obj.putField("Preamble/standardName/GlobalAdministeringAuthorityCode", "RosettaNet");
	obj.putField("Preamble/standardVersion/VersionIdentifier", "V02.00");
}
end_body
member
public: void createDeliveryHeader();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	acc = new XmlDbAccessor;
	acc.create("DeliveryHeader", "V02.00", conn);
	acc.setDTDfilename("rosetta/DeliveryHeader_MS_V02_00.dtd");
	obj = acc.create(msgId);
	obj.putField("DeliveryHeader/isSecureTransportRequired/AffirmationIndicator", "Yes");
	obj.putField("DeliveryHeader/messageDateTime/DateTimeStamp", RNContext::currentDateTime());
	obj.putField("DeliveryHeader/messageReceiverIdentification/PartnerIdentification/GlobalBusinessIdentifier", partner_id);
	obj.putField("DeliveryHeader/messageSenderIdentification/PartnerIdentification/GlobalBusinessIdentifier", my_id);
	obj.putField("DeliveryHeader/messageTrackingID/InstanceIdentifier", message_id = RNContext::genTrackingId());
}
end_body
member
public: void createRequestServiceHeader();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	acc = new XmlDbAccessor;
	acc.create("ServiceHeader", "V02.00", conn);
	acc.setDTDfilename("rosetta/ServiceHeader_MS_V02_00.dtd");
	obj = acc.create(msgId);
	// process
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/BusinessActivityIdentifier", process_code);
	obj.putField("ServiceHeader/ProcessControl/pipCode/GlobalProcessIndicatorCode", indicator);
	obj.putField("ServiceHeader/ProcessControl/pipInstanceId/InstanceIdentifier", process_id);
	obj.putField("ServiceHeader/ProcessControl/pipVersion/VersionIdentifier", process_version);
	// when Action
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/ActionIdentity/GlobalBusinessActionCode", msg_code);
	// optional: obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/ActionIdentity/standardVersion/VersionIdentifier", msg_ver);
	// attachment
	var list attach_info;
	if (attach_info = DataMgr::getAttachmentInfos(attach_dir, msgId)) {
		var list itr, info;
		var string mime_type, content_id, description;
		var integer count;
		itr = al_dst_itr(attach_info);
		count = 0;
		loop {
			if (info = al_next(itr)) {
			} else {
				break;
			}
			mime_type = al_dst_node(info, "mimeType");
			content_id = al_dst_node(info, "contentId");
			description = al_dst_node(info, "description");
			obj2 = obj.createChild("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/Attachment");
			obj2.putField("description/FreeFormText", description);
			obj2.putField("GlobalMimeTypeQualifierCode", mime_type);
			obj2.putField("UniversalResourceIdentifier", "cid:" + (string)content_id);
			count = count + 1;
		}
		obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/numberOfAttachments/CountableAmount", (string)count);
	} else {
		obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/numberOfAttachments/CountableAmount", "0");
	}
	// role, service
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromRole/GlobalPartnerRoleClassificationCode", from_role_class);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromService/GlobalBusinessServiceCode", from_service);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toRole/GlobalPartnerRoleClassificationCode", to_role_class);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toService/GlobalBusinessServiceCode", to_service);
	// usage code, initial partner
	obj.putField("ServiceHeader/ProcessControl/GlobalUsageCode", usage_code);
	obj.putField("ServiceHeader/ProcessControl/KnownInitiatingPartner/PartnerIdentification/GlobalBusinessIdentifier", initiator);
}
end_body
member
public: void createResponseServiceHeader();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	acc = new XmlDbAccessor;
	acc.create("ServiceHeader", "V02.00", conn);
	acc.setDTDfilename("rosetta/ServiceHeader_MS_V02_00.dtd");
	obj = acc.create(msgId);
	// process
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/BusinessActivityIdentifier", process_code);
	obj.putField("ServiceHeader/ProcessControl/pipCode/GlobalProcessIndicatorCode", indicator);
	obj.putField("ServiceHeader/ProcessControl/pipInstanceId/InstanceIdentifier", process_id);
	obj.putField("ServiceHeader/ProcessControl/pipVersion/VersionIdentifier", process_version);
	// reply to (Response, Signal)
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/inReplyTo/ActionControl/ActionIdentity/GlobalBusinessActionCode", reply_code);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/inReplyTo/ActionControl/messageTrackingID/InstanceIdentifier", reply_id);
	// when Action
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/ActionIdentity/GlobalBusinessActionCode", msg_code);
	// optional: obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/ActionIdentity/standardVersion/VersionIdentifier", msg_ver);
	// attachment
	var list attach_info;
	if (attach_info = DataMgr::getAttachmentInfos(attach_dir, msgId)) {
		var list itr, info;
		var string mime_type, content_id, description;
		var integer count;
		itr = al_dst_itr(attach_info);
		count = 0;
		loop {
			if (info = al_next(itr)) {
			} else {
				break;
			}
			mime_type = al_dst_node(info, "mimeType");
			content_id = al_dst_node(info, "contentId");
			description = al_dst_node(info, "description");
			obj2 = obj.createChild("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/Attachment");
			obj2.putField("description/FreeFormText", description);
			obj2.putField("GlobalMimeTypeQualifierCode", mime_type);
			obj2.putField("UniversalResourceIdentifier", "cid:" + (string)content_id);
			count = count + 1;
		}
		obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/numberOfAttachments/CountableAmount", (string)count);
	} else {
		obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/numberOfAttachments/CountableAmount", "0");
	}
	// role, service
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromRole/GlobalPartnerRoleClassificationCode", from_role_class);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromService/GlobalBusinessServiceCode", from_service);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toRole/GlobalPartnerRoleClassificationCode", to_role_class);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toService/GlobalBusinessServiceCode", to_service);
	// usage code, initial partner
	obj.putField("ServiceHeader/ProcessControl/GlobalUsageCode", usage_code);
	obj.putField("ServiceHeader/ProcessControl/KnownInitiatingPartner/PartnerIdentification/GlobalBusinessIdentifier", initiator);
	// request doc id
	obj.putField("ServiceHeader/ProcessControl/partnerDefinedPIPPayloadBindingId/ProprietaryReferenceIdentifier", req_doc_id);
}
end_body
member
public: void createSignalServiceHeader();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj, obj2;
	acc = new XmlDbAccessor;
	acc.create("ServiceHeader", "V02.00", conn);
	acc.setDTDfilename("rosetta/ServiceHeader_MS_V02_00.dtd");
	obj = acc.create(msgId);
	// process
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/BusinessActivityIdentifier", process_code);
	obj.putField("ServiceHeader/ProcessControl/pipCode/GlobalProcessIndicatorCode", indicator);
	obj.putField("ServiceHeader/ProcessControl/pipInstanceId/InstanceIdentifier", process_id);
	obj.putField("ServiceHeader/ProcessControl/pipVersion/VersionIdentifier", process_version);
	// reply to (Response, Signal)
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/inReplyTo/ActionControl/ActionIdentity/GlobalBusinessActionCode", reply_code);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/inReplyTo/ActionControl/messageTrackingID/InstanceIdentifier", reply_id);
	// when Signal
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/SignalIdentity/GlobalBusinessSignalCode", msg_code);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/SignalIdentity/VersionIdentifier", msg_ver);
	// attachment
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/numberOfAttachments/CountableAmount", "0");
	// role, service
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromRole/GlobalPartnerRoleClassificationCode", from_role_class);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromService/GlobalBusinessServiceCode", from_service);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toRole/GlobalPartnerRoleClassificationCode", to_role_class);
	obj.putField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toService/GlobalBusinessServiceCode", to_service);
	// usage code, initial partner
	obj.putField("ServiceHeader/ProcessControl/GlobalUsageCode", usage_code);
	obj.putField("ServiceHeader/ProcessControl/KnownInitiatingPartner/PartnerIdentification/GlobalBusinessIdentifier", initiator);
	// request doc id
	obj.putField("ServiceHeader/ProcessControl/partnerDefinedPIPPayloadBindingId/ProprietaryReferenceIdentifier", req_doc_id);
}
end_body
member
public: string msgId;
member
public: string attach_dir;
member
public: string my_id;
member
public: string partner_id;
member
public: string process_code;
member
public: string indicator;
member
public: string process_id;
member
public: string process_version;
member
public: string reply_code;
member
public: string reply_id;
member
public: string msg_code;
member
public: string msg_ver;
member
public: string from_role_class;
member
public: string from_service;
member
public: string to_role_class;
member
public: string to_service;
member
public: string usage_code;
member
public: string initiator;
member
public: string req_doc_id;
member
public: string message_id;
member
public: list invokePackMessage(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string domain, tmp_dir, attach_dir, send_dir, msgId, msg;
	var string content_id;
	var string msg_type, msg_version, dtd_filename;
	var string validation_mode, validation_result, validation_reason;
	var string encryption_algorithm, encryption_part, encoding, partner_cert, send_signature;
	var string my_cert, my_key, filename;
	domain = al_dst_node(props, "domain");
	tmp_dir = al_dst_node(props, "tempDir");
	attach_dir = al_dst_node(props, "attachDir");
	send_dir = al_dst_node(props, "sendDir");
	msgId = al_dst_node(props, "msgId");
	msg_type = al_dst_node(props, "msgType");
	msg_version = al_dst_node(props, "msgVersion");
	dtd_filename = al_dst_node(props, "dtdFilename");
	encryption_algorithm = al_dst_node(props, "encryptionAlgorithm");
	encryption_part = al_dst_node(props, "encryptionPart");
	encoding = al_dst_node(props, "encoding");
	partner_cert = al_dst_node(props, "partnerCert");
	send_signature = (al_dst_node(props, "sendSignature") == "true");
	my_cert = al_dst_node(props, "myCert");
	my_key = al_dst_node(props, "myKey");
	sync_type = al_dst_node(props, "syncType");
	validation_mode = al_dst_node(props, "validationMode");
	validation_result = al_dst_node(props, "validationResult");
	validation_reason = al_dst_node(props, "validationReason");
	var string preamble, delivery_header, service_header, service_content;
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var MultipartSecureMessage msm, msm2;
	// ----get Preamble
	try {
		acc = new XmlDbAccessor;
		acc.create("Preamble", "V02.00", conn);
		acc.setDTDfilename("rosetta/Preamble_MS_V02_00.dtd");
		acc.setDocType("Preamble");
		preamble = acc.getXML(msgId);
	} catch (AlException e) {
		msg = errorMsg("fail to pack mesage. fail to compose preamble.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save Preamble to tmp file
	if (debug_mode) {
		try {
			FileUtility::writeString(tmp_dir + "/" + msgId + "-Preamble", preamble);
		} catch (AlException e) {
			msg = errorMsg("fail to save preamble to temporary file.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// ---- get DeliveryHeader
	try {
		acc = new XmlDbAccessor;
		acc.create("DeliveryHeader", "V02.00", conn);
		acc.setDTDfilename("rosetta/DeliveryHeader_MS_V02_00.dtd");
		acc.setDocType("DeliveryHeader");
		delivery_header = acc.getXML(msgId);
	} catch (AlException e) {
		msg = errorMsg("fail to pack mesage. fail to compose delivery header.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save DeliveryHeader to tmp file
	if (debug_mode) {
		try {
			FileUtility::writeString(tmp_dir + "/" + msgId + "-DeliveryHeader", delivery_header);
		} catch (AlException e) {
			msg = errorMsg("fail to save delivery header to temporary file.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// ---- get ServiceHeader
	try {
		acc = new XmlDbAccessor;
		acc.create("ServiceHeader", "V02.00", conn);
		acc.setDTDfilename("rosetta/ServiceHeader_MS_V02_00.dtd");
		acc.setDocType("ServiceHeader");
		service_header = acc.getXML(msgId);
	} catch (AlException e) {
		msg = errorMsg("fail to pack mesage. fail to compose service header.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save ServiceHeader to tmp file
	if (debug_mode) {
		try {
			FileUtility::writeString(tmp_dir + "/" + msgId + "-ServiceHeader", service_header);
		} catch (AlException e) {
			msg = errorMsg("fail to save service header to temporary file.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// ---- get ServiceContent
	try {
		acc = new XmlDbAccessor;
		acc.create(msg_type, msg_version, conn);
		acc.setDTDfilename(dtd_filename);
		acc.setContentValidation((list)(validation_mode != ""));
		acc.setDocType(msg_type);
		service_content = acc.getXML(msgId);
		if (acc.validation_errors) {
			if (validation_mode == "error") {
				al_set_dst_node(ret, "validationResult", validation_result = "error");
			} else {
			}
			if (validation_mode == "warn") {
				al_set_dst_node(ret, "validationResult", validation_result = "warnning");
			} else {
			}
			al_set_dst_node(ret, "validationReason", validation_reason = acc.validation_errors);
		} else {
		}
	} catch (AlException e) {
		msg = errorMsg("fail to pack mesage. fail to compose service content.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save ServiceContent to tmp file
	if (debug_mode) {
		try {
			FileUtility::writeString(tmp_dir + "/" + msgId + "-ServiceContent", service_content);
		} catch (AlException e) {
			msg = errorMsg("fail to save service content to temporary file.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// -------- pack ServiceContent
	try {
		msm = new MultipartSecureMessage;
		msm.setBodyHeader("Content-Type", "application/xml");
		msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
		if (encoding == "base64") {
			msm.setBodyHeader("Content-Transfer-Encoding", "base64");
		} else {
			msm.setBodyHeader("Content-Transfer-Encoding", "binary");
		}
		msm.setBodyHeader("Content-Location", "RN-Service-Content");
		msm.setBodyHeader("Content-Description", "RosettaNet-Service-Content");
		content_id = "<" + msgId + "-ServiceContent@" + domain + ">";
		content_id = al_str_misc("chg_delimiter", content_id, al_list2('-', '.'));
		msm.setBodyHeader("Content-ID", content_id);
		service_content = toUTF8(service_content);
		msm.addBodyText(service_content);
		service_content = null;
	} catch (AlException e) {
		msg = errorMsg("fail to pack service content to multipart.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- pack Attachment
	var list attach_info;
	if (attach_info = RNDataMgr::getAttachmentInfos(msgId)) {
		var list itr, info, content_id_set, attachment;
		var string mime_type, description, filename;
		var integer size;
		itr = al_dst_itr(attach_info);
		content_id_set = al_cons(null, null);
		loop {
			if (info = al_next(itr)) {
			} else {
				break;
			}
			mime_type = al_dst_node(info, "mimeType");
			content_id = al_dst_node(info, "contentId");
			filename = al_dst_node(info, "$filename");
			if (al_dst_node(content_id_set, content_id)) {
				msg = "same attachment Content-ID is used for different attachments.";
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "error");
				al_set_dst_node(ret, "errorReason", msg);
				return ret;
			} else {
			}
			al_create_arc(content_id_set, content_id, null);
			try {
				attachment = FileUtility::readBinary(filename);
				size = al_misc("binary_size", attachment, null);
			} catch (AlException e) {
				msg = errorMsg("attachment file may be not in msg.attach.dir.", e);
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "error");
				al_set_dst_node(ret, "errorReason", msg);
				return ret;
			}
			try {
				msm.setBodyHeader("Content-Type", mime_type);
				msm.setBodyHeader("Content-Transfer-Encoding", "base64");
				msm.setBodyHeader("Content-ID", "<" + (string)content_id + ">");
				msm.addBodyBinary(attachment, 0, size);
				attachment = null;
			} catch (AlException e) {
				msg = errorMsg("fail to pack attachment to multipart.", e);
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "error");
				al_set_dst_node(ret, "errorReason", msg);
				return ret;
			}
		}
	} else {
	}
	// -------- encrypt body
	if (encryption_part == "body") {
		try {
			msm.encrypt(encryption_algorithm, partner_cert);
		} catch (AlException e) {
			msg = errorMsg("fail to encrypt part after service content.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// -------- pack ServiceHeader
	try {
		msm2 = msm;
		msm = new MultipartSecureMessage;
		msm.setBodyHeader("Content-Type", "application/xml");
		msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
		if (encoding == "base64") {
			msm.setBodyHeader("Content-Transfer-Encoding", "base64");
		} else {
			msm.setBodyHeader("Content-Transfer-Encoding", "binary");
		}
		msm.setBodyHeader("Content-Location", "RN-Service-Header");
		msm.setBodyHeader("Content-Description", "RosettaNet-Service-Header");
		content_id = "<" + msgId + "-ServiceHeader@" + domain + ">";
		content_id = al_str_misc("chg_delimiter", content_id, al_list2('-', '.'));
		msm.setBodyHeader("Content-ID", content_id);
		service_header = toUTF8(service_header);
		msm.addBodyText(service_header);
		service_header = null;
		msm.addMultipartSecureMessage(msm2);
	} catch (AlException e) {
		msg = errorMsg("fail to pack service header to multipart.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- encrypt header-body
	if (encryption_part == "header-body") {
		try {
			msm.encrypt(encryption_algorithm, partner_cert);
		} catch (AlException e) {
			msg = errorMsg("fail to encrypt part after service header.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// -------- pack Preamble, DeliveryHeader
	try {
		msm2 = msm;
		msm = new MultipartSecureMessage;
		msm.setBodyHeader("Content-Type", "application/xml");
		msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
		if (encoding == "base64") {
			msm.setBodyHeader("Content-Transfer-Encoding", "base64");
		} else {
			msm.setBodyHeader("Content-Transfer-Encoding", "binary");
		}
		msm.setBodyHeader("Content-Location", "RN-Preamble");
		msm.setBodyHeader("Content-Description", "RosettaNet-Service-Preamble");
		content_id = "<" + msgId + "-Preamble@" + domain + ">";
		content_id = al_str_misc("chg_delimiter", content_id, al_list2('-', '.'));
		msm.setBodyHeader("Content-ID", content_id);
		preamble = toUTF8(preamble);
		msm.addBodyText(preamble);
		preamble = null;
		msm.setBodyHeader("Content-Type", "application/xml");
		msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
		if (encoding == "base64") {
			msm.setBodyHeader("Content-Transfer-Encoding", "base64");
		} else {
			msm.setBodyHeader("Content-Transfer-Encoding", "binary");
		}
		msm.setBodyHeader("Content-Location", "RN-Delivery-Header");
		msm.setBodyHeader("Content-Description", "RosettaNet-Delivery-Header");
		content_id = "<" + msgId + "-DeliveryHeader@" + domain + ">";
		content_id = al_str_misc("chg_delimiter", content_id, al_list2('-', '.'));
		msm.setBodyHeader("Content-ID", content_id);
		delivery_header = toUTF8(delivery_header);
		msm.addBodyText(delivery_header);
		delivery_header = null;
		msm.addMultipartSecureMessage(msm2);
	} catch (AlException e) {
		msg = errorMsg("fail to pack preamble or delivery header to multipart.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- sign
	if (send_signature) {
		try {
			msm.sign(my_cert, my_key);
		} catch (AlException e) {
			msg = errorMsg("fail to sign multipart message.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// -------- create http message from multipart
	try {
		msm.setHeader("Content-Description", "This is the RosettaNet Business Message");
		var string contentType;
		contentType = msm.getHeader("Content-Type");
		msm.multipartToOneBody();
		msm.addHeaderSubType("Content-Type", "type", contentType);
		msm.setHeader("x-RN-Version", "RosettaNet/V02.00");
		if (sync_type == "async") {
			msm.setHeader("x-RN-Response-Type", "async");
		} else {
			msm.setHeader("x-RN-Response-Type", "sync");
		}
	} catch (AlException e) {
		msg = errorMsg("fail to create HTTP message from multipart message.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save packed message to raw message file
	try {
		var file out;
		filename = (string)send_dir + "/" + (string)msgId;
		al_set_dst_node(ret, "filename", filename);
		if (out = al_file_open(filename, "wb")) {
		} else {
			msg = "fail to save raw message to be sent. can't open file '" + filename + "'";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "fatal");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		msm.writeMultipartMessage(out);
		al_file_manip("flush", out, null);
		out = null;
	} catch (AlException e) {
		msg = errorMsg("fail to save raw message to be sent.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	if (validation_result == "error") {
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", validation_reason);
	} else {
	}
	if (validation_result == "warnning") {
		al_set_dst_node(ret, "error", "warnning");
		al_set_dst_node(ret, "errorLevel", "warn");
		al_set_dst_node(ret, "errorReason", validation_reason);
	} else {
	}
	return ret;
}
end_body
member
public: list invokeUnpackMessage(list props);
body
{
	var list ret, ls;
	ret = al_cons(null, null);
	var string msgId, tmp_dir, attach_dir, cert_info, filename, msg;
	msgId = al_dst_node(props, "msgId");
	tmp_dir = al_dst_node(props, "tempDir");
	attach_dir = al_dst_node(props, "attachDir");
	cert_info = al_dst_node(props, "certInfo");
	filename = al_dst_node(props, "filename");
	var list raw_message, signed;
	var integer size, index;
	var MultipartSecureMessage msm;
	var string content_type;
	var string preamble, delivery_header, service_header, service_content;
	var list preamble_parse_tree, delivery_header_parse_tree, service_header_parse_tree;
	var XmlDataRetriver retriver, retriver2;
	var string my_id, partner_id, message_id, reference_id;
	var string action_code, signal_code, msg_code, msg_ver, msg_type, msg_version, dtd_filename, next_action;
	var RNContext ctx;
	var string reply_code, role_msg_type;
	var string my_role, partner_role;
	var list my_props, partner_props, pip_props, reply_pip_props;
	var string receive_client_auth, receive_auth_host, receive_signature, common_name;
	var string validation_mode;
	var string partner_cert, ca_cert, my_cert, my_key;
	var string process_id;
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	try {
		raw_message = FileUtility::readBinary(filename);
		size = al_misc("binary_size", raw_message, null);
	} catch (AlException e) {
		msg = errorMsg("raw message file may be not found.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	msm = new MultipartSecureMessage;
	try {
		msm.readMultipartMessage(raw_message, size);
		raw_message = null;
	} catch (AlException e) {
		msg = errorMsg("raw message may be not multipart.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	if (content_type = msm.getHeader("Content-Type") && al_str_misc("strcmpi", content_type, "multipart/related") == 0) {
	} else {
		msg = "unexpected Content-Type '" + (string)content_type + "', expected 'multipart/related'";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	try {
		msm.oneBodyToMultipart(0);
	} catch (AlException e) {
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		msg = errorMsg("1st body of multipart http message may be not multipart.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	if (signed = msm.isSigned()) {
		// verification is later
		try {
			msm.oneBodyToMultipart(0);
		} catch (AlException e) {
			msg = errorMsg("body for sign may be not multipart.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// -------- read Preamble
	try {
		preamble = msm.getBodyText(0);
		preamble = fromUTF8(preamble);
	} catch (AlException e) {
		msg = errorMsg("preamble not found.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save Preamble to tmp file
	if (debug_mode) {
		try {
			FileUtility::writeBinary(tmp_dir + "/" + msgId + "-Preamble", preamble);
		} catch (AlException e) {
			msg = errorMsg("fail to save preamble to temporary file.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// -------- parse Preamble
	try {
		preamble_parse_tree = XmlUtility::parseXML(preamble, null);
	} catch (AlException e) {
		msg = errorMsg("preamble parse error.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save Preamble to DB
	try {
		acc = new XmlDbAccessor;
		acc.create("Preamble", "V02.00", conn);
		acc.setDTDfilename("rosetta/Preamble_MS_V02_00.dtd");
		acc.putXML(preamble_parse_tree, msgId);
	} catch (AlException e) {
		msg = errorMsg("preamble validation failed.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- read DeliveryHeader
	try {
		delivery_header = msm.getBodyText(1);
		delivery_header = fromUTF8(delivery_header);
	} catch (AlException e) {
		msg = errorMsg("delivery header not found.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save DeliveryHeader to tmp file
	if (debug_mode) {
		try {
			FileUtility::writeBinary(tmp_dir + "/" + msgId + "-DeliveryHeader", delivery_header);
		} catch (AlException e) {
			msg = errorMsg("fail to save delivery header to temporary file.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "fatal");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// -------- parse DeliveryHeader
	try {
		delivery_header_parse_tree = XmlUtility::parseXML(delivery_header, null);
	} catch (AlException e) {
		msg = errorMsg("delivery header parse error.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save DeliveryHeader to DB
	try {
		acc = new XmlDbAccessor;
		acc.create("DeliveryHeader", "V02.00", conn);
		acc.setDTDfilename("rosetta/DeliveryHeader_MS_V02_00.dtd");
		acc.putXML(delivery_header_parse_tree, msgId);
	} catch (AlException e) {
		msg = errorMsg("delivery header validation failed.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- get FromBusinessId, ToBusinessId, messageId from DeliverlyHeader
	retriver = new XmlDataRetriver;
	retriver.create(delivery_header_parse_tree);
	if (partner_id = retriver.getValue("DeliveryHeader/messageSenderIdentification/PartnerIdentification/GlobalBusinessIdentifier")) {
	} else {
		msg = "partner id (sender id) not found in delivery header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	al_set_dst_node(ret, "partnerId", partner_id);
	if (my_id = retriver.getValue("DeliveryHeader/messageReceiverIdentification/PartnerIdentification/GlobalBusinessIdentifier")) {
	} else {
		msg = "my id (receiver id) not found in delivery header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	al_set_dst_node(ret, "myId", my_id);
	if (message_id = retriver.getValue("DeliveryHeader/messageTrackingID/InstanceIdentifier")) {
		al_set_dst_node(ret, "messageId", message_id);
	} else {
		msg = "message tracking id not found in delivery header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- get my default properties
	try {
		ctx = new RNContext;
		my_props = ctx.getMyPropertiesFromId(my_id, conn);
	} catch (AlException e) {
		msg = errorMsg("can't get my_id '" + (string)my_id + "'properties.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- Decryption after ServiceHeader
	if (msm.isEncrypted(2)) {
		my_cert = al_dst_node(my_props, "cert");
		my_key = al_dst_node(my_props, "key");
		if (my_cert == null || my_cert == "" || al_file_manip("does_exist", my_cert, null) == null) {
			msg = "my certification for decryption not found";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		} else {
		}
		if (my_key == null || my_key == "" || al_file_manip("does_exist", my_key, null) == null) {
			msg = "my secret key for decryption not found";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		} else {
		}
		try {
			msm.decrypt(2, my_cert, my_key);
		} catch (AlException e) {
			msg = "decryption failed.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		index = 0;
	} else {
		index = 2;
	}
	// -------- read ServiceHeader
	try {
		service_header = msm.getBodyText(index);
		service_header = fromUTF8(service_header);
	} catch (AlException e) {
		msg = errorMsg("service header not found.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save ServiceHeader to tmp file
	if (debug_mode) {
		try {
			FileUtility::writeBinary(tmp_dir + "/" + msgId + "-ServiceHeader", service_header);
		} catch (AlException e) {
			msg = errorMsg("fail to save service header to temporary file.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "fatal");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
	}
	// -------- parse ServiceHeader
	try {
		service_header_parse_tree = XmlUtility::parseXML(service_header, null);
	} catch (AlException e) {
		msg = errorMsg("service header parse error.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- save ServiceHeader to DB
	try {
		acc = new XmlDbAccessor;
		acc.create("ServiceHeader", "V02.00", conn);
		acc.setDTDfilename("rosetta/ServiceHeader_MS_V02_00.dtd");
		acc.putXML(service_header_parse_tree, msgId);
	} catch (AlException e) {
		msg = errorMsg("service header validation failed.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- get Information from ServiceHeader
	retriver = new XmlDataRetriver;
	retriver.create(service_header_parse_tree);
	if (process_id = retriver.getValue("ServiceHeader/ProcessControl/pipInstanceId/InstanceIdentifier")) {
		al_set_dst_node(ret, "transactionId", process_id);
	} else {
		msg = "process id (transaction id) not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	if (action_code = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/ActionIdentity/GlobalBusinessActionCode")) {
		msg_code = action_code;
		if (reference_id = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/MessageControl/inReplyTo/ActionControl/messageTrackingID/InstanceIdentifier")) {
			al_set_dst_node(ret, "referenceId", reference_id);
		} else {
		}
	} else {
		if (signal_code = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/SignalIdentity/GlobalBusinessSignalCode")) {
			msg_code = signal_code;
			al_set_dst_node(ret, "isSignal", "true");
			if (reference_id = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/MessageControl/inReplyTo/ActionControl/messageTrackingID/InstanceIdentifier")) {
				al_set_dst_node(ret, "referenceId", reference_id);
			} else {
				msg = "reply to message trancking id not found in service header.";
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "error");
				al_set_dst_node(ret, "errorReason", msg);
				return ret;
			}
			if (reply_code = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/MessageControl/inReplyTo/ActionControl/ActionIdentity/GlobalBusinessActionCode")) {
			} else {
				msg = "reply to action code not found in service header.";
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "error");
				al_set_dst_node(ret, "errorReason", msg);
				return ret;
			}
		} else {
			msg = "both of action code and signal code not found in service header.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	}
	if (msg_version = retriver.getValue("ServiceHeader/ProcessControl/pipVersion/VersionIdentifier")) {
		if (action_code) {
			msg_ver = msg_version;
		} else {
			msg_ver = "V02.00";
		}
		al_set_dst_node(ret, "msgVersion", msg_ver);
	} else {
		msg = "action version not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	if (checkServiceHeaderInfo(retriver, ret)) {
		return ret;
	} else {
	}
	try {
		ctx = new RNContext;
		pip_props = ctx.getPipPropertiesFromMessageCode(msg_code, msg_ver, conn);
		msg_type = al_dst_node(pip_props, "MsgType");
		dtd_filename = al_dst_node(pip_props, "DTDfilename");
		next_action = al_dst_node(pip_props, "NextAction");
		al_set_dst_node(ret, "msgType", msg_type);
		al_set_dst_node(ret, "dtdFilename", dtd_filename);
		al_set_dst_node(ret, "nextAction", next_action);
		if (reply_code) {
			reply_pip_props = ctx.getPipPropertiesFromMessageCode(reply_code, msg_version, conn);
			role_msg_type = al_dst_node(reply_pip_props, "MsgType");
		} else {
			role_msg_type = msg_type;
		}
	} catch (AlException e) {
		msg = errorMsg("pip properties not found.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	// -------- get Roles
	try {
		ctx = new RNContext;
		partner_role = ctx.getPartnerRole(partner_id, role_msg_type, conn);
		my_role = ctx.getMyRole(partner_id, role_msg_type, conn);
		partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
	} catch (AlException e) {
		msg = errorMsg("partner infomation not found: partnerId = " + partner_id + ".", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	al_set_dst_node(ret, "partnerRole", partner_role);
	al_set_dst_node(ret, "myRole", my_role);
	// -------- get Partner Properties
	receive_client_auth = al_dst_node(partner_props, "receive.client.auth");
	receive_auth_host = al_dst_node(partner_props, "receive.auth.host");
	receive_signature = al_dst_node(partner_props, "receive.signature");
	if (cert_info == null || cert_info == "") {
		if (receive_client_auth == "true") {
			msg = "SSL client certification required.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			al_set_dst_node(ret, "outerErrorReason", msg);
			al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.GENERR");
			return ret;
		} else {
		}
	} else {
		if (ls = al_scan_list(cert_info)) {
			if (ls = ls.head) {
				common_name = al_list_elem(ls, 1);
			} else {
			}
		} else {
		}
	}
	if (receive_auth_host && receive_auth_host != "") {
		if (common_name != receive_auth_host) {
			msg = "not exppected SSL client certification common name '" + (string)common_name + "', expected '" + receive_auth_host + "'";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			al_set_dst_node(ret, "outerErrorReason", "not exppected SSL certification common name.");
			al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.GENERR");
			return ret;
		} else {
		}
	} else {
	}
	if (validation_mode = al_dst_node(partner_props, "validation.mode")) {
		al_set_dst_node(ret, "validationMode", validation_mode);
	} else {
	}
	// -------- Decryption after ServiceContent
	index = index + 1;
	if (msm.isEncrypted(index)) {
		my_cert = al_dst_node(my_props, "cert");
		my_key = al_dst_node(my_props, "key");
		if (my_cert == null || my_cert == "" || al_file_manip("does_exist", my_cert, null) == null) {
			msg = "my certification for decryption not found";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
			al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.DCRYPTERR");
			return ret;
		} else {
		}
		if (my_key == null || my_key == "" || al_file_manip("does_exist", my_key, null) == null) {
			msg = "my secret key for decryption not found";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
			al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.DCRYPTERR");
			return ret;
		} else {
		}
		try {
			msm.decrypt(index, my_cert, my_key);
		} catch (AlException e) {
			msg = "decryption failed.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			al_set_dst_node(ret, "outerErrorReason", "decryption failed.");
			al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.DCRYPTERR");
			return ret;
		}
		index = 0;
	} else {
	}
	// -------- read ServiceContent
	try {
		service_content = msm.getBodyText(index);
		service_content = fromUTF8(service_content);
	} catch (AlException e) {
		msg = errorMsg("service content read failed.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		al_set_dst_node(ret, "outerErrorReason", "service content read failed.");
		al_set_dst_node(ret, "outerErrorCode", "UNP.SCON.READERR");
		return ret;
	}
	// -------- save ServiceContent to tmp file
	index = index + 1;
	try {
		FileUtility::writeBinary(tmp_dir + "/" + msgId + "-ServiceContent", service_content);
	} catch (AlException e) {
		msg = errorMsg("fail to save service content to temporary file.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
		al_set_dst_node(ret, "outerErrorCode", "UNP.SCON.READERR");
		return ret;
	}
	// -------- read Attachment and save to file
	retriver = new XmlDataRetriver;
	retriver.create(service_header_parse_tree);
	retriver = retriver.getItr("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/Attachment");
	try {
		var list attachment, attach_props;
		var string description, mime_type, content_id, content_id2;
		var integer i, n, count;
		n = msm.getCount();
		loop {
			if (retriver2 = retriver.getNext()) {
			} else {
				break;
			}
			description = retriver2.getValue("description/FreeFormText");
			mime_type = retriver2.getValue("GlobalMimeTypeQualifierCode");
			content_id = retriver2.getValue("UniversalResourceIdentifier");
			content_id = al_str_misc("param_to_string", content_id, null);
			if (content_id && al_str_misc("starts_with", content_id, "cid:")) {
				content_id = al_tail_str(content_id, 4);
			} else {
			}
			attach_props = al_cons(null, null);
			al_create_arc(attach_props, description, "description");
			al_create_arc(attach_props, mime_type, "mimeType");
			al_create_arc(attach_props, content_id, "contentId");
			i = index;
			count = 0;
			loop {
				if (i < n) {
				} else {
					msg = "attachment which has content-id '" + (string)content_id + "' not found.";
					al_set_dst_node(ret, "error", "true");
					al_set_dst_node(ret, "errorLevel", "error");
					al_set_dst_node(ret, "errorReason", msg);
					al_set_dst_node(ret, "outerErrorReason", msg);
					al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.GENERR");
					return ret;
				}
				content_id2 = msm.getBodyHeader(i, "Content-ID");
				if (content_id2 && al_str_misc("starts_with", content_id2, "<") && al_str_misc("ends_with", content_id2, ">")) {
					content_id2 = al_substr(content_id2, 1, al_strlen(content_id2) - 1);
				} else {
				}
				if (content_id == content_id) {
					attachment = msm.getBodyBinary(i);
					size = al_misc("binary_size", attachment, null);
					break;
				} else {
				}
				i = i + 1;
			}
			DataMgr::addAttachment(attach_dir, msgId, attachment, size, attach_props);
		}
	} catch (AlException e) {
		msg = errorMsg("fail to read or save attachment.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		al_set_dst_node(ret, "outerErrorReason", "attachment read error, or Internal Server Error.");
		al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.GENERR");
		return ret;
	}
	// -------- Partner's Signature Verification
	if (signed) {
		partner_cert = al_dst_node(partner_props, "cert");
		ca_cert = al_dst_node(partner_props, "ca.cert");
		if (partner_cert == null || partner_cert == "" || al_file_manip("does_exist", partner_cert, null) == null) {
			msg = "partner certification for signature verification not found";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
			al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.SIGNERR");
			return ret;
		} else {
		}
		if (ca_cert == null || ca_cert == "" || al_file_manip("does_exist", ca_cert, null) == null) {
			msg = "ca certification for signature verification not found";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
			al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.SIGNERR");
			return ret;
		} else {
		}
		try {
			raw_message = FileUtility::readBinary(filename);
			size = al_misc("binary_size", raw_message, null);
			msm = new MultipartSecureMessage;
			msm.readMultipartMessage(raw_message, size);
			msm.oneBodyToMultipart(0);
			raw_message = null;
			var list digest;
			var string base64_digest;
			if (digest = msm.verify(partner_cert, ca_cert)) {
				var string tmp_filename;
				try {
					tmp_filename = FileUtility::tempFile();
					al_crypt("base64_encode", digest, tmp_filename, null);
					base64_digest = FileUtility::readString(tmp_filename);
					al_set_dst_node(ret, "messageDigest", base64_digest);
					al_file_manip("remove", tmp_filename, null);
				} catch (AlException e) {
					if (tmp_filename && al_file_manip("does_exist", tmp_filename, null)) {
						al_file_manip("remove", tmp_filename, null);
					} else {
					}
					throw e;
				}
			} else {
				msg = "signature verification failed.";
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "error");
				al_set_dst_node(ret, "errorReason", msg);
				al_set_dst_node(ret, "outerErrorReason", "signature verification failed.");
				al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.SIGNERR");
				return ret;
			}
		} catch (AlException e) {
			msg = errorMsg("unexpected error when signature verification.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "fatal");
			al_set_dst_node(ret, "errorReason", msg);
			al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
			al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.SIGNERR");
			return ret;
		}
	} else {
		if (receive_signature == "true") {
			msg = "signature required";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			al_set_dst_node(ret, "outerErrorReason", msg);
			al_set_dst_node(ret, "outerErrorCode", "UNP.MESG.SIGNERR");
			return ret;
		} else {
		}
	}
	return ret;
}
end_body
member
public: list checkServiceHeaderInfo(XmlDataRetriver retriver, list ret);
body
{
	var string msg;
	var string fromPartnerRole, fromService, toPartnerRole, toService;
	var string process_code, indicator, processVersion, usageCode;
	var string initiator;
	if (fromPartnerRole = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromRole/GlobalPartnerRoleClassificationCode")) {
	} else {
		msg = "from partner role not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return 1;
	}
	if (fromService = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/MessageControl/fromService/GlobalBusinessServiceCode")) {
	} else {
		msg = "from service not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return 1;
	}
	if (toPartnerRole = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toRole/GlobalPartnerRoleClassificationCode")) {
	} else {
		msg = "to partner role not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return 1;
	}
	if (toService = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/MessageControl/toService/GlobalBusinessServiceCode")) {
	} else {
		msg = "to service not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return 1;
	}
	if (process_code = retriver.getValue("ServiceHeader/ProcessControl/ActivityControl/BusinessActivityIdentifier")) {
	} else {
		msg = "process code (transaction code) not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	if (indicator = retriver.getValue("ServiceHeader/ProcessControl/pipCode/GlobalProcessIndicatorCode")) {
	} else {
		msg = "pip indicator not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return 1;
	}
	if (processVersion = retriver.getValue("ServiceHeader/ProcessControl/pipVersion/VersionIdentifier")) {
	} else {
		msg = "process version not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return 1;
	}
	if (usageCode = retriver.getValue("ServiceHeader/ProcessControl/GlobalUsageCode")) {
	} else {
		msg = "usageCode not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return 1;
	}
	if (initiator = retriver.getValue("ServiceHeader/ProcessControl/KnownInitiatingPartner/PartnerIdentification/GlobalBusinessIdentifier")) {
	} else {
		msg = "initial partner id not found in service header.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return 1;
	}
	return null;
}
end_body
member
public: list invokeSaveToDB(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string msgId, tmp_dir, msg;
	var string msg_type, msg_version, dtd_filename;
	var string validation_mode, service_content;
	var list service_content_parse_tree;
	var XmlDataRetriver retriver;
	var string doc_datetime, doc_id;
	var XmlDbAccessor acc;
	msgId = al_dst_node(props, "msgId");
	tmp_dir = al_dst_node(props, "tempDir");
	msg_type = al_dst_node(props, "msgType");
	msg_version = al_dst_node(props, "msgVersion");
	dtd_filename = al_dst_node(props, "dtdFilename");
	validation_mode = al_dst_node(props, "validationMode");
	try {
		service_content = FileUtility::readString(tmp_dir + "/" + msgId + "-ServiceContent");
	} catch (AlException e) {
		msg = errorMsg("fail to read service content from temporary file.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
		al_set_dst_node(ret, "outerErrorCode", "UNP.SCON.READERR");
		return ret;
	}
	try {
		service_content_parse_tree = XmlUtility::parseXML(service_content, null);
	} catch (AlException e) {
		msg = errorMsg("service content parse error.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		al_set_dst_node(ret, "outerErrorReason", "service content parse error.");
		al_set_dst_node(ret, "outerErrorCode", "UNP.SCON.READERR");
		return ret;
	}
	retriver = new XmlDataRetriver;
	retriver.create(service_content_parse_tree);
	if (doc_datetime = retriver.getValue(msg_type + "")) {
		al_set_dst_node(ret, "docGenDatetime", doc_datetime);
	} else {
	}
	if (doc_id = retriver.getValue(msg_type + "")) {
		al_set_dst_node(ret, "docId", doc_id);
	} else {
	}
	try {
		acc = new XmlDbAccessor;
		acc.create(msg_type, msg_version, conn);
		acc.setDTDfilename(dtd_filename);
		acc.setContentValidation((list)(validation_mode != ""));
		acc.putXML(service_content_parse_tree, msgId);
		if (acc.validation_errors) {
			if (validation_mode == "error") {
				al_set_dst_node(ret, "validationResult", "error");
			} else {
			}
			if (validation_mode == "warn") {
				al_set_dst_node(ret, "validationResult", "warnning");
			} else {
			}
			al_set_dst_node(ret, "validationReason", "content validation error: " + acc.validation_errors);
		} else {
		}
	} catch (AlException e) {
		msg = errorMsg("service content validation failed.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		al_set_dst_node(ret, "outerErrorReason", "service content validation failed, or Internal Server Error.");
		al_set_dst_node(ret, "outerErrorCode", "UNP.SCON.VALERR");
		return ret;
	}
	return ret;
}
end_body
member
public: list invokePreValidationCheck(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string validation_result, validation_reason;
	validation_result = al_dst_node(props, "validationResult");
	validation_reason = al_dst_node(props, "validationReason");
	if (validation_result == "error") {
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", validation_reason);
		al_set_dst_node(ret, "outerErrorCode", "UNP.SCON.VALERR");
		al_set_dst_node(ret, "outerErrorReason", validation_reason);
	} else {
	}
	if (validation_result == "warnning") {
		al_set_dst_node(ret, "errorLevel", "warn");
		al_set_dst_node(ret, "errorReason", validation_reason);
	} else {
	}
	return ret;
}
end_body
member
public: list invokeCreateReceiptAck(list props);
body
{
	var list ret, is_ack;
	ret = al_cons(null, null);
	al_set_dst_node(ret, "error", "none");
	var string msg, r_msgId;
	sync_type = al_dst_node(props, "syncType");
	if (sync_type == "reply") {
		return ret;
	} else {
	}
	var string msg_type, msg_version, next_action;
	msgId = al_dst_node(props, "msgId");
	msg_type = al_dst_node(props, "msgType");
	msg_version = al_dst_node(props, "msgVersion");
	if (sync_type == "sync") {
		var list pip_props;
		try {
			var RNContext ctx;
			ctx = new RNContext;
			pip_props = ctx.getPipProperties(msg_type, msg_version, conn);
		} catch (AlException e) {
			msg = errorMsg("fail to create receipt ack or response. fail to get pip properties.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "fatal");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		next_action = al_dst_node(pip_props, "NextAction");
		if (next_action && next_action != "") {
		} else {
			is_ack = 1;
		}
	} else {
		is_ack = 1;
	}
	if (is_ack) {
		r_msgId = Context::genMsgId();
		var string message_digest;
		message_digest = al_dst_node(props, "messageDigest");
		try {
			var XmlDbAccessor acc;
			var XmlDbObject obj;
			acc = new XmlDbAccessor;
			acc.create("ReceiptAcknowledgment", "V02.00", conn);
			acc.setDTDfilename("rosetta/AcknowledgmentOfReceipt_MS_V02_00.dtd");
			obj = acc.create(r_msgId);
			if (message_digest && message_digest != "") {
				obj.putField("ReceiptAcknowledgment/NonRepudiationInformation/OriginalMessageDigest", message_digest);
			} else {
			}
			al_set_dst_node(ret, "rMsgId", r_msgId);
			al_set_dst_node(ret, "rMsgType", "ReceiptAcknowledgment");
			al_set_dst_node(ret, "rMsgVersion", "V02.00");
			al_set_dst_node(ret, "rDtdFilename", "rosetta/AcknowledgmentOfReceipt_MS_V02_00.dtd");
			return ret;
		} catch (AlException e) {
			msg = errorMsg("fail to create receipt ack. db server may be down", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "fatal");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
	} else {
		var string my_id, my_role;
		var string partner_id, partner_role, partner_props;
		my_id = al_dst_node(props, "myId");
		my_role = al_dst_node(props, "myRole");
		partner_id = al_dst_node(props, "partnerId");
		partner_role = al_dst_node(props, "partnerRole");
		try {
			var RNContext ctx;
			ctx = new RNContext;
			partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
		} catch (AlException e) {
			msg = errorMsg("fail to create sync response. fail to get partner properties.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		var string class_name;
		var PeService ps;
		var WaitObj wait_obj;
		class_name = al_dst_node(partner_props, msg_type + ".reply");
		if (class_name && class_name != "" && ps = al_gp("new", class_name, null, null, null)) {
			var list arg_props, ret_props;
			arg_props = al_cons(null, null);
			al_create_arc(arg_props, msg_type, "msgType");
			al_create_arc(arg_props, msg_version, "msgVersion");
			al_create_arc(arg_props, msgId, "msgId");
			al_create_arc(arg_props, my_id, "myId");
			al_create_arc(arg_props, my_role, "myRole");
			al_create_arc(arg_props, partner_id, "partnerId");
			al_create_arc(arg_props, partner_role, "partnerRole");
			try {
				ps.conn = conn;
				ps.db_type = db_type;
				ps.debug_mode = debug_mode;
				ps.exception_detail = exception_detail;
				ret_props = ps.invoke(arg_props);
			} catch (AlException e) {
				msg = errorMsg("fail to create sync response.", e);
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "fatal");
				al_set_dst_node(ret, "errorReason", msg);
				if (wait_obj = DataMgr::getProperty(msgId)) {
					wait_obj.value = 500;
					wait_obj.notify();
				} else {
				}
				return ret;
			}
			if (ret_props && r_msgId = al_dst_node(ret_props, "rMsgId") && r_msgId != "") {
			} else {
				msg = "sync response msgId not found.";
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "error");
				al_set_dst_node(ret, "errorReason", msg);
				if (wait_obj = DataMgr::getProperty(msgId)) {
					wait_obj.value = 500;
					wait_obj.notify();
				} else {
				}
				return ret;
			}
			try {
				var XmlDbAccessor acc;
				acc = new XmlDbAccessor;
				acc.create("", "", conn);
				acc.getWithMsgTypeAndMsgVersion(r_msgId);
				al_set_dst_node(ret, "rMsgId", r_msgId);
				al_set_dst_node(ret, "rMsgType", acc.msgType);
				al_set_dst_node(ret, "rMsgVersion", acc.msgVersion);
				al_set_dst_node(ret, "rDtdFilename", acc._dtd_filename);
				return ret;
			} catch (AlException e) {
				msg = errorMsg("created sync response is illegal.", e);
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "fatal");
				al_set_dst_node(ret, "errorReason", msg);
				if (wait_obj = DataMgr::getProperty(msgId)) {
					wait_obj.value = 500;
					wait_obj.notify();
				} else {
				}
				return ret;
			}
		} else {
			msg = "no class for sync response creation: class_name = " + (string)class_name;
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			if (wait_obj = DataMgr::getProperty(msgId)) {
				wait_obj.value = 500;
				wait_obj.notify();
			} else {
			}
			return ret;
		}
	}
}
end_body
member
public: list invokeCreateReceiptException(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	al_set_dst_node(ret, "error", "none");
	var string is_signal, outer_reason, outer_error_code, r_msgId, msg;
	is_signal = al_dst_node(props, "isSignal");
	outer_reason = al_dst_node(props, "outerErrorReason");
	if (is_signal == "true" || outer_reason == "") {
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorReason", "");
		return ret;
	} else {
	}
	sync_type = al_dst_node(props, "syncType");
	if (sync_type == "reply") {
		return ret;
	} else {
	}
	outer_error_code = al_dst_node(props, "outerErrorCode");
	r_msgId = Context::genMsgId();
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	try {
		acc = new XmlDbAccessor;
		acc.create("Exception", "V02.00", conn);
		acc.setDTDfilename("rosetta/Exception_MS_V02_00.dtd");
		obj = acc.create(r_msgId);
		obj.putField("Exception/ExceptionDescription/errorClassification/GlobalMessageExceptionCode", outer_error_code);
		obj.putField("Exception/ExceptionDescription/errorDescription/FreeFormText", outer_reason);
		obj.putField("Exception/GlobalExceptionTypeCode", "Receipt Acknowledgment Exception");
		al_set_dst_node(ret, "rMsgId", r_msgId);
		al_set_dst_node(ret, "rMsgType", "Exception");
		al_set_dst_node(ret, "rMsgVersion", "V02.00");
		al_set_dst_node(ret, "rDtdFilename", "rosetta/Exception_MS_V02_00.dtd");
		return ret;
	} catch (AlException e) {
		msg = errorMsg("fail to create receipt execption. db server may be down", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
}
end_body
member
public: list invokeCreateNOF(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	al_set_dst_node(ret, "error", "none");
	var string outer_reason, r_msgId, msg;
	var string msgId, msg_type, msg_version, doc_datetime, doc_id;
	var XmlDbAccessor sh_acc, acc;
	var XmlDbObject sh_obj, obj;
	var RNContext ctx;
	var string pip_props, my_id, my_role, partner_id, partner_role, my_props, partner_props;
	outer_reason = al_dst_node(props, "outerErrorReason");
	if (outer_reason == null || outer_reason == "") {
		msg = "fail to create NOF. outer reason must not be empty.";
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	} else {
	}
	msg_type = al_dst_node(props, "msgType");
	if (msg_type == "Pip0A1FailureNotification" || msg_type == "ReceiptAcknowledgment" || msg_type == "Exception") {
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorReason", "");
		return ret;
	} else {
	}
	r_msgId = Context::genMsgId();
	msg_version = al_dst_node(props, "msgVersion");
	try {
		ctx = new RNContext;
		pip_props = ctx.getPipProperties(msg_type, msg_version, conn);
	} catch (AlException e) {
		msg = errorMsg("fail to create NOF. fail to pip properties.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	my_id = al_dst_node(props, "myId");
	my_role = al_dst_node(props, "myRole");
	try {
		ctx = new RNContext;
		my_props = ctx.getMyProperties(my_role, conn);
	} catch (AlException e) {
		msg = errorMsg("fail to create NOF. fail to get my properties.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	partner_id = al_dst_node(props, "partnerId");
	partner_role = al_dst_node(props, "partnerRole");
	try {
		ctx = new RNContext;
		partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
	} catch (AlException e) {
		msg = errorMsg("fail to create NOF. fail to get partner properties.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	msgId = al_dst_node(props, "msgId");
	try {
		var string value;
		sh_acc = new XmlDbAccessor;
		sh_acc.create("ServiceHeader", "V02.00", conn);
		sh_acc.setDTDfilename("rosetta/ServiceHeader_MS_V02_00.dtd");
		sh_obj = sh_acc.get(msgId);
		acc = new XmlDbAccessor;
		acc.create("Pip0A1FailureNotification", "V02.00", conn);
		acc.setDTDfilename("rosetta/0A1_MS_V02_00_FailureNotification.dtd");
		obj = acc.create(r_msgId);
		value = sh_obj.getField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/ActionIdentity/GlobalBusinessActionCode");
		obj.putField("Pip0A1FailureNotification/ActionControl/ActionIdentity/GlobalBusinessActionCode", value);
		value = al_dst_node(props, "messageId");
		obj.putField("Pip0A1FailureNotification/ActionControl/messageTrackingID/InstanceIdentifier", value);
		value = sh_obj.getField("ServiceHeader/ProcessControl/pipCode/GlobalProcessIndicatorCode");
		obj.putField("Pip0A1FailureNotification/ProcessIdentity/GlobalProcessIndicatorCode", value);
		value = sh_obj.getField("ServiceHeader/ProcessControl/pipInstanceId/InstanceIdentifier");
		obj.putField("Pip0A1FailureNotification/ProcessIdentity/InstanceIdentifier", value);
		value = sh_obj.getField("ServiceHeader/ProcessControl/pipVersion/VersionIdentifier");
		obj.putField("Pip0A1FailureNotification/ProcessIdentity/VersionIdentifier", value);
		if (value = al_dst_node(pip_props, "FromRoleClass")) {
		} else {
			msg = "fail to create NOF. fail to get fromRoleClass from pip properties.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		obj.putField("Pip0A1FailureNotification/fromRole/PartnerRoleDescription/GlobalPartnerRoleClassificationCode", value);
		if (value = al_dst_node(pip_props, "ToRoleClass")) {
		} else {
			msg = "fail to create NOF. fail to get toRoleClass from pip properties.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		obj.putField("Pip0A1FailureNotification/toRole/PartnerRoleDescription/GlobalPartnerRoleClassificationCode", value);
		if (value = al_dst_node(pip_props, "FromRoleClass")) {
		} else {
			msg = "fail to create NOF. fail to get fromRoleClass from pip properties.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		obj.putField("Pip0A1FailureNotification/fromRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", my_id);
		if (value = al_dst_node(my_props, "Supply Chain")) {
		} else {
			msg = "fail to create NOF. fail to get 'Supply Chain' from my properties.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		obj.putField("Pip0A1FailureNotification/fromRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalSupplyChainCode", value);
		if (value = al_dst_node(my_props, "Class")) {
		} else {
			msg = "fail to create NOF. fail to get 'Class' from my properties.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		obj.putField("Pip0A1FailureNotification/fromRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", value);
		obj.putField("Pip0A1FailureNotification/toRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", partner_id);
		if (value = al_dst_node(partner_props, "Supply Chain")) {
		} else {
			msg = "fail to create NOF. fail to get 'Supply Chain' from partner properties.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		obj.putField("Pip0A1FailureNotification/toRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalSupplyChainCode", value);
		if (value = al_dst_node(partner_props, "Class")) {
		} else {
			msg = "fail to create NOF. fail to get 'Class' from partner properties.";
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "error");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		obj.putField("Pip0A1FailureNotification/toRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", value);
		doc_datetime = al_dst_node(props, "docGenDatetime");
		doc_id = al_dst_node(props, "docId");
		obj.putField("Pip0A1FailureNotification/failedInitiatingDocumentDateTime/DateTimeStamp", doc_datetime);
		obj.putField("Pip0A1FailureNotification/failedInitiatingDocumentIdentifier/ProprietaryDocumentIdentifier", doc_id);
		obj.putField("Pip0A1FailureNotification/toRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", value);
		obj.putField("Pip0A1FailureNotification/reason/FreeFormText", outer_reason);
		obj.putField("Pip0A1FailureNotification/thisDocumentGenerationDateTime/DateTimeStamp", RNContext::currentDateTime());
		obj.putField("Pip0A1FailureNotification/thisDocumentIdentifier/ProprietaryDocumentIdentifier", RNContext::genDocId());
		obj.putField("Pip0A1FailureNotification/GlobalDocumentFunctionCode", "Request");
		al_set_dst_node(ret, "rMsgType", "Pip0A1FailureNotification");
		al_set_dst_node(ret, "rMsgVersion", "V02.00");
		al_set_dst_node(ret, "rDtdFilename", "rosetta/0A1_MS_V02_00_FailureNotification.dtd");
		al_set_dst_node(ret, "rMsgId", r_msgId);
		return ret;
	} catch (AlException e) {
		msg = errorMsg("fail to create NOF. may be DB server trouble", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
}
end_body
member
public: list invokeSend(list props);
body
{
	var list ret;
	var string msg;
	ret = al_cons(null, null);
	var string r_msgId, r_msg_type, r_msg_version, r_dtd_filename;
	var string msgId, msg_type, msg_version, dtd_filename;
	var string processId, my_id, my_role, partner_id, partner_role;
	var string send_recv, use_proxy, proxy_msgId;
	r_msgId = al_dst_node(props, "rMsgId");
	r_msg_type = al_dst_node(props, "rMsgType");
	r_msg_version = al_dst_node(props, "rMsgVersion");
	r_dtd_filename = al_dst_node(props, "rDtdFilename");
	msgId = al_dst_node(props, "msgId");
	msg_type = al_dst_node(props, "msgType");
	msg_version = al_dst_node(props, "msgVersion");
	dtd_filename = al_dst_node(props, "dtdFilename");
	processId = al_dst_node(props, "*process.id");
	my_id = al_dst_node(props, "myId");
	my_role = al_dst_node(props, "myRole");
	partner_id = al_dst_node(props, "partnerId");
	partner_role = al_dst_node(props, "partnerRole");
	send_recv = al_dst_node(props, "sendRecv");
	sync_type = al_dst_node(props, "syncType");
	use_proxy = al_dst_node(props, "useProxy");
	proxy_msgId = al_dst_node(props, "proxyMsgId");
	if (send_recv == "recv" && sync_type == "reply") {
		al_set_dst_node(ret, "error", "process");
		return ret;
	} else {
	}
	var string error, reason;
	try {
		var ProcMgr mgr;
		mgr = new ProcMgr;
		var string sendProcessId;
		sendProcessId = mgr.create("RNIF20SendProcess", conn);
		var list ps;
		ps = al_cons(null, null);
		al_set_dst_node(ps, "msgId", r_msgId);
		al_set_dst_node(ps, "msgType", r_msg_type);
		al_set_dst_node(ps, "msgVersion", r_msg_version);
		al_set_dst_node(ps, "dtdFilename", r_dtd_filename);
		al_set_dst_node(ps, "orgMsgId", msgId);
		al_set_dst_node(ps, "orgMsgType", msg_type);
		al_set_dst_node(ps, "orgMsgVersion", msg_version);
		al_set_dst_node(ps, "orgDtdFilename", dtd_filename);
		if (send_recv == "recv" && sync_type == "sync") {
			al_set_dst_node(ps, "URL", "sync");
			al_set_dst_node(ps, "syncType", "reply");
			al_set_dst_node(ps, "useProxy", use_proxy);
			al_set_dst_node(ps, "proxyMsgId", proxy_msgId);
			al_set_dst_node(ret, "error", "process");
		} else {
		}
		if (r_msg_type == "ReceiptAcknowledgment") {
			al_set_dst_node(ps, "waitProcessId", processId);
		} else {
		}
		al_set_dst_node(ps, "myId", my_id);
		al_set_dst_node(ps, "myRole", my_role);
		al_set_dst_node(ps, "partnerId", partner_id);
		al_set_dst_node(ps, "partnerRole", partner_role);
		al_set_dst_node(ps, "startTime", Context::genTimeStamp());
		mgr.putProperties(sendProcessId, ps, conn);
		mgr.start(sendProcessId, conn);
	} catch (AlException e) {
		msg = errorMsg("fail to start transport send process.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	return ret;
}
end_body
member
public: list invokeSimpleSend(list props);
body
{
	var list ret, err;
	ret = al_cons(null, null);
	al_set_dst_node(ret, "error", "none");
	al_set_dst_node(ret, "errorLevel", "info");
	al_set_dst_node(ret, "errorReason", "OK");
	var string filename, msg;
	var RNContext ctx;
	var string partner_id, partner_role, partner_props, url;
	var string my_default_props, proxy_server, proxy_port;
	var integer retry_count_max, error_retry_count_max;
	var string send_client_auth, my_cert, my_key, ca_cert;
	var string org_msgId, use_proxy, proxy_msgId;
	var WaitObj wait_obj;
	var HttpResponse res2;
	var string receive_server_auth, server_auth_host;
	var list raw_message, result, headers, ls;
	var integer size, i;
	filename = al_dst_node(props, "filename");
	partner_id = al_dst_node(props, "partnerId");
	partner_role = al_dst_node(props, "partnerRole");
	retry_count = (integer)al_dst_node(props, "retryCount");
	error_retry_count = (integer)al_dst_node(props, "errorRetryCount");
	retry_count_max = (integer)al_dst_node(props, "retryCountMax");
	error_retry_count_max = (integer)al_dst_node(props, "errorRetryCountMax");
	send_client_auth = (al_dst_node(props, "sendClientAuth") == "true");
	my_cert = al_dst_node(props, "myCert");
	my_key = al_dst_node(props, "myKey");
	ca_cert = al_dst_node(props, "caCert");
	msgId = al_dst_node(props, "msgId");
	org_msgId = al_dst_node(props, "orgMsgId");
	sync_type = al_dst_node(props, "syncType");
	use_proxy = al_dst_node(props, "useProxy");
	proxy_msgId = al_dst_node(props, "proxyMsgId");
	if (isTimeout(props)) {
		msg = "timeout";
		notify(org_msgId, ret);
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	} else {
	}
	if (retry_count < retry_count_max) {
	} else {
		msg = "retry over";
		if (sync_type == "sync" || sync_type == "reply") {
			notify(org_msgId, ret);
		} else {
			al_set_dst_node(ret, "error", "retryover");
			al_set_dst_node(ret, "errorLevel", "error");
		}
		al_set_dst_node(ret, "errorReason", msg);
		al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
		return ret;
	}
	try {
		ctx = new RNContext;
		partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
	} catch (AlException e) {
		msg = errorMsg("send error: fail to get partner properties.", e);
		if (sync_type == "sync" || sync_type == "reply") {
			notify(org_msgId, ret);
		} else {
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "warn");
		}
		al_set_dst_node(ret, "errorReason", msg);
		if (error_retry_count + 1 < error_retry_count_max) {
		} else {
			al_set_dst_node(ret, "retryover", "true");
			al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
		}
		inc_error_retry(ret);
		return ret;
	}
	try {
		ctx = new RNContext;
		my_default_props = ctx.getMyProperties("-- default setting --", conn);
	} catch (AlException e) {
		msg = errorMsg("send error: fail to get my properties.", e);
		if (sync_type == "sync" || sync_type == "reply") {
			notify(org_msgId, ret);
		} else {
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "warn");
		}
		al_set_dst_node(ret, "errorReason", msg);
		if (error_retry_count + 1 < error_retry_count_max) {
		} else {
			al_set_dst_node(ret, "retryover", "true");
			al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
		}
		inc_error_retry(ret);
		return ret;
	}
	try {
		raw_message = FileUtility::readBinary(filename);
		size = al_misc("binary_size", raw_message, null);
	} catch (AlException e) {
		msg = errorMsg("send error: raw message file may be not found.", e);
		if (sync_type == "sync" || sync_type == "reply") {
			notify(org_msgId, ret);
		} else {
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "warn");
		}
		al_set_dst_node(ret, "errorReason", msg);
		if (error_retry_count + 1 < error_retry_count_max) {
		} else {
			al_set_dst_node(ret, "retryover", "true");
			al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
		}
		inc_error_retry(ret);
		return ret;
	}
	if (result = al_crypt("mime_headers_read", al_list3(raw_message, 0, size), null, null)) {
	} else {
		msg = "send error: fail to generate HTTP header.";
		if (sync_type == "sync" || sync_type == "reply") {
			notify(org_msgId, ret);
		} else {
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "warn");
		}
		al_set_dst_node(ret, "errorReason", msg);
		if (error_retry_count + 1 < error_retry_count_max) {
		} else {
			al_set_dst_node(ret, "retryover", "true");
			al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
		}
		inc_error_retry(ret);
		return ret;
	}
	headers = result.head;
	i = result.tail.head;
	proxy_server = al_dst_node(my_default_props, "proxy.server");
	proxy_port = (integer)al_dst_node(my_default_props, "proxy.port");
	var HttpClientConnection http_conn;
	http_conn = new HttpClientConnection;
	if (sync_type == "reply") {
		if (use_proxy == "false") {
			if (org_msgId && org_msgId != "") {
				if (wait_obj = DataMgr::getProperty(org_msgId)) {
					res2 = wait_obj.value2;
					al_create_arc(headers, "1.0", "MIME-Version");
					res2.headers = headers;
					res2.out(raw_message, i, size - i);
					wait_obj.value = 200;
					wait_obj.notify();
				} else {
					msg = "WaitObject of orgMsgId not found: orgMsgId = " + (string)org_msgId;
					notify(org_msgId, ret);
					al_set_dst_node(ret, "errorReason", msg);
					inc_error_retry(ret);
					return ret;
				}
			} else {
				msg = "orgMsgId is empty: orgMsgId = " + (string)org_msgId;
				notify(org_msgId, ret);
				al_set_dst_node(ret, "errorLevel", "fatal");
				al_set_dst_node(ret, "errorReason", msg);
				inc_error_retry(ret);
				return ret;
			}
		} else {
			if (url = al_dst_node(my_default_props, "proxy.poll.url")) {
			} else {
				msg = "send error: proxy.poll.url is empty.";
				notify(org_msgId, ret);
				al_set_dst_node(ret, "errorReason", msg);
				inc_error_retry(ret);
				return ret;
			}
			al_set_dst_node(ret, "URL", al_dst_node(partner_props, "URL"));
			if (err = http_conn.create(url)) {
				msg = "send error: illegal URL = " + (string)url + ": " + (string)err;
				if (sync_type == "sync") {
					notify(org_msgId, ret);
				} else {
					al_set_dst_node(ret, "error", "true");
					al_set_dst_node(ret, "errorLevel", "warn");
				}
				al_set_dst_node(ret, "errorReason", msg);
				if (error_retry_count + 1 < error_retry_count_max) {
				} else {
					al_set_dst_node(ret, "retryover", "true");
					al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
				}
				inc_error_retry(ret);
				return ret;
			} else {
			}
			http_conn.proxy_server = proxy_server;
			http_conn.proxy_port = proxy_port;
			al_set_dst_node(headers, "x-AL-OrgMsgId", proxy_msgId);
			al_set_dst_node(headers, "x-AL-ResponseCode", "200");
			al_create_arc(headers, "1.0", "MIME-Version");
			http_conn.headers = headers;
			http_conn.out(raw_message, i, size - i);
			if (err = http_conn.doPost()) {
				msg = "send error: " + (string)err;
				if (sync_type == "sync") {
					notify(org_msgId, ret);
				} else {
					al_set_dst_node(ret, "error", "true");
					al_set_dst_node(ret, "errorLevel", "warn");
				}
				al_set_dst_node(ret, "errorReason", msg);
				if (error_retry_count + 1 < error_retry_count_max) {
				} else {
					al_set_dst_node(ret, "retryover", "true");
					al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
				}
				inc_error_retry(ret);
				return ret;
			} else {
			}
			if (http_conn.response_code != 200) {
				msg = "send error: unexpected HTTP response code (proxy sync): " + (string)http_conn.response_code + ", expected 200(OK)";
				notify(org_msgId, ret);
				al_set_dst_node(ret, "errorReason", msg);
				inc_error_retry(ret);
				return ret;
			} else {
			}
		}
	} else {
		if (url = al_dst_node(partner_props, "URL")) {
		} else {
			msg = "send error: url is empty.";
			if (sync_type == "sync") {
				notify(org_msgId, ret);
			} else {
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "warn");
			}
			al_set_dst_node(ret, "errorReason", msg);
			if (error_retry_count + 1 < error_retry_count_max) {
			} else {
				al_set_dst_node(ret, "retryover", "true");
				al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
			}
			inc_error_retry(ret);
			return ret;
		}
		al_set_dst_node(ret, "URL", url);
		var file f;
		f = al_file_open(url, "sr");
		if (al_file_match_str(f, "http")) {
			f = null;
			if (err = http_conn.create(url)) {
				msg = "send error: illegal URL = " + (string)url + ": " + (string)err;
				if (sync_type == "sync") {
					notify(org_msgId, ret);
				} else {
					al_set_dst_node(ret, "error", "true");
					al_set_dst_node(ret, "errorLevel", "warn");
				}
				al_set_dst_node(ret, "errorReason", msg);
				if (error_retry_count + 1 < error_retry_count_max) {
				} else {
					al_set_dst_node(ret, "retryover", "true");
					al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
				}
				inc_error_retry(ret);
				return ret;
			} else {
			}
			http_conn.proxy_server = proxy_server;
			http_conn.proxy_port = proxy_port;
			if (http_conn.ssl) {
				if (send_client_auth) {
					if (my_cert == null || my_cert == "" || al_file_manip("does_exist", my_cert, null) == null) {
						msg = "no my certificate for SSL.";
						if (sync_type == "sync") {
							notify(org_msgId, ret);
						} else {
							al_set_dst_node(ret, "error", "true");
							al_set_dst_node(ret, "errorLevel", "warn");
						}
						al_set_dst_node(ret, "errorReason", msg);
						if (error_retry_count + 1 < error_retry_count_max) {
						} else {
							al_set_dst_node(ret, "retryover", "true");
							al_set_dst_node(ret, "outerErrorReason", "Internal Server Error");
						}
						inc_error_retry(ret);
						return ret;
					} else {
					}
					if (my_key == null || my_key == "" || al_file_manip("does_exist", my_key, null) == null) {
						msg = "no my private key for SSL.";
						if (sync_type == "sync") {
							notify(org_msgId, ret);
						} else {
							al_set_dst_node(ret, "error", "true");
							al_set_dst_node(ret, "errorLevel", "warn");
						}
						al_set_dst_node(ret, "errorReason", msg);
						if (error_retry_count + 1 < error_retry_count_max) {
						} else {
							al_set_dst_node(ret, "retryover", "true");
							al_set_dst_node(ret, "outerErrorReason", "Internal Server Error");
						}
						inc_error_retry(ret);
						return ret;
					} else {
					}
					if (ca_cert == null || ca_cert == "" || al_file_manip("does_exist", ca_cert, null) == null) {
						msg = "no CA certificate for SSL.";
						if (sync_type == "sync") {
							notify(org_msgId, ret);
						} else {
							al_set_dst_node(ret, "error", "true");
							al_set_dst_node(ret, "errorLevel", "warn");
						}
						al_set_dst_node(ret, "errorReason", msg);
						if (error_retry_count + 1 < error_retry_count_max) {
						} else {
							al_set_dst_node(ret, "retryover", "true");
							al_set_dst_node(ret, "outerErrorReason", "Internal Server Error");
						}
						inc_error_retry(ret);
						return ret;
					} else {
					}
					http_conn.cert = my_cert;
					http_conn.key = my_key;
					http_conn.ca_cert = ca_cert;
				} else {
				}
				receive_server_auth = al_dst_node(partner_props, "receive.server.auth");
				server_auth_host = al_dst_node(partner_props, "server.auth.host");
				if (receive_server_auth == "true") {
					http_conn.server_auth = 1;
					if (http_conn.ca_cert == null) {
						if (ca_cert == null || ca_cert == "" || al_file_manip("does_exist", ca_cert, null) == null) {
							msg = "no CA certificate for SSL server auth.";
							if (sync_type == "sync") {
								notify(org_msgId, ret);
							} else {
								al_set_dst_node(ret, "error", "true");
								al_set_dst_node(ret, "errorLevel", "warn");
							}
							al_set_dst_node(ret, "errorReason", msg);
							if (error_retry_count + 1 < error_retry_count_max) {
							} else {
								al_set_dst_node(ret, "retryover", "true");
								al_set_dst_node(ret, "outerErrorReason", "Internal Server Error");
							}
							inc_error_retry(ret);
							return ret;
						} else {
						}
						http_conn.ca_cert = ca_cert;
					} else {
					}
				} else {
				}
			} else {
			}
			al_create_arc(headers, "1.0", "MIME-Version");
			http_conn.headers = headers;
			http_conn.out(raw_message, i, size - i);
			if (sync_type == "sync") {
				if (err = http_conn.doPost_noWait()) {
					msg = "send error: " + (string)err;
					notify(org_msgId, ret);
					al_set_dst_node(ret, "errorReason", msg);
					inc_error_retry(ret);
					return ret;
				} else {
					DataMgr::putProperty(msgId, (list)http_conn);
				}
			} else {
				if (err = http_conn.doPost()) {
					msg = "send error: " + (string)err;
					al_set_dst_node(ret, "error", "true");
					al_set_dst_node(ret, "errorLevel", "warn");
					al_set_dst_node(ret, "errorReason", msg);
					if (error_retry_count + 1 < error_retry_count_max) {
					} else {
						al_set_dst_node(ret, "retryover", "true");
						al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
					}
					inc_error_retry(ret);
					return ret;
				} else {
				}
				if (http_conn.response_code != 202) {
					msg = "send error: unexpected HTTP response code: " + (string)http_conn.response_code + ", expected 202(Accepted)";
					if (sync_type == "sync") {
						notify(org_msgId, ret);
					} else {
						al_set_dst_node(ret, "error", "true");
						al_set_dst_node(ret, "errorLevel", "warn");
					}
					al_set_dst_node(ret, "errorReason", msg);
					if (error_retry_count + 1 < error_retry_count_max) {
					} else {
						al_set_dst_node(ret, "retryover", "true");
						al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
					}
					inc_error_retry(ret);
					return ret;
				} else {
				}
			}
			if (http_conn.server_auth == 1) {
				var string common_name;
				if (http_conn.cert_info) {
					if (ls = http_conn.cert_info.head) {
						common_name = al_list_elem(ls, 1);
					} else {
					}
				} else {
				}
				if (common_name == null || common_name != server_auth_host) {
					msg = "not exppected SSL server certification common name '" + (string)common_name + "', expected '" + (string)server_auth_host + "'";
					if (sync_type == "sync") {
						notify(org_msgId, ret);
					} else {
						al_set_dst_node(ret, "error", "true");
						al_set_dst_node(ret, "errorLevel", "error");
					}
					al_set_dst_node(ret, "errorReason", msg);
					if (error_retry_count + 1 < error_retry_count_max) {
					} else {
						al_set_dst_node(ret, "retryover", "true");
						al_set_dst_node(ret, "outerErrorReason", "send message retry over.");
					}
					inc_error_retry(ret);
					return ret;
				} else {
				}
			} else {
			}
		} else {
			if (al_file_match_str(f, "mailto:")) {
				f = null;
				url = al_tail_str(url, 7);
				var string smtp_server, from_address;
				if (smtp_server = al_dst_node(my_default_props, "smtp.server")) {
				} else {
					msg = "send error: smtp server name is empty.";
					if (sync_type == "sync") {
						notify(org_msgId, ret);
					} else {
						al_set_dst_node(ret, "error", "true");
						al_set_dst_node(ret, "errorLevel", "warn");
					}
					al_set_dst_node(ret, "errorReason", msg);
					if (error_retry_count + 1 < error_retry_count_max) {
					} else {
						al_set_dst_node(ret, "retryover", "true");
						al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
					}
					inc_error_retry(ret);
					return ret;
				}
				if (from_address = al_dst_node(my_default_props, "from.mail.address")) {
				} else {
					msg = "send error: from mail address is empty.";
					if (sync_type == "sync") {
						notify(org_msgId, ret);
					} else {
						al_set_dst_node(ret, "error", "true");
						al_set_dst_node(ret, "errorLevel", "warn");
					}
					al_set_dst_node(ret, "errorReason", msg);
					if (error_retry_count + 1 < error_retry_count_max) {
					} else {
						al_set_dst_node(ret, "retryover", "true");
						al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
					}
					inc_error_retry(ret);
					return ret;
				}
				var SmtpClient client;
				client = new SmtpClient;
				client.create(smtp_server);
				client.headers = headers;
				client.from = from_address;
				client.domain = al_dst_node(my_default_props, "domain");
				al_create_arc(client.rcpts, url, null);
				al_create_arc(client.to, url, null);
				client.subject = "This is the RosettaNet Business Message.";
				client.text = al_misc("binary_to_string", al_list3(raw_message, i, size - i), null);
				client.content_length = size - i;
				client.start();
				if (client.error) {
					msg = "send error: mail send error: msg = " + (string)client.error;
					if (sync_type == "sync") {
						notify(org_msgId, ret);
					} else {
						al_set_dst_node(ret, "error", "true");
						al_set_dst_node(ret, "errorLevel", "warn");
					}
					al_set_dst_node(ret, "errorReason", msg);
					if (error_retry_count + 1 < error_retry_count_max) {
					} else {
						al_set_dst_node(ret, "retryover", "true");
						al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
					}
					inc_error_retry(ret);
					return ret;
				} else {
				}
			} else {
				msg = "send error: bad url: url = " + (string)url;
				if (sync_type == "sync") {
					notify(org_msgId, ret);
				} else {
					al_set_dst_node(ret, "error", "true");
					al_set_dst_node(ret, "errorLevel", "warn");
				}
				al_set_dst_node(ret, "errorReason", msg);
				if (error_retry_count + 1 < error_retry_count_max) {
				} else {
					al_set_dst_node(ret, "retryover", "true");
					al_set_dst_node(ret, "outerErrorReason", "Internal Server Error.");
				}
				inc_error_retry(ret);
				return ret;
			}
		}
	}
	if (sync_type == "sync") {
		al_set_dst_node(ret, "error", "wait_response");
	} else {
		inc_retry(ret);
	}
	if (sync_type == "reply") {
		al_set_dst_node(ret, "error", "timeout");
	} else {
	}
	return ret;
}
end_body
member
public: list invokeResponseCheck(list props);
body
{
	var list ret, err;
	ret = al_cons(null, null);
	var string msg, org_msgId;
	var integer retry_count_max, error_retry_count_max;
	var RNContext ctx;
	var string my_default_props;
	var HttpClientConnection http_conn;
	retry_count = (integer)al_dst_node(props, "retryCount");
	error_retry_count = (integer)al_dst_node(props, "errorRetryCount");
	retry_count_max = (integer)al_dst_node(props, "retryCountMax");
	error_retry_count_max = (integer)al_dst_node(props, "errorRetryCountMax");
	msgId = al_dst_node(props, "msgId");
	org_msgId = al_dst_node(props, "orgMsgId");
	sync_type = al_dst_node(props, "syncType");
	try {
		ctx = new RNContext;
		my_default_props = ctx.getMyProperties("-- default setting --", conn);
	} catch (AlException e) {
		msg = errorMsg("send error: fail to get my properties.", e);
		notify(org_msgId, ret);
		al_set_dst_node(ret, "errorReason", msg);
		inc_error_retry(ret);
		return ret;
	}
	if (http_conn = DataMgr::getProperty(msgId)) {
	} else {
		msg = "send error: no connection cache to get http sync response.";
		notify(org_msgId, ret);
		al_set_dst_node(ret, "errorReason", msg);
		inc_error_retry(ret);
		return ret;
	}
	if (http_conn.isCompleted()) {
	} else {
		return ret;
	}
	DataMgr::removeProperty(msgId);
	if (http_conn.error) {
		msg = "send error: " + (string)http_conn.error;
		notify(org_msgId, ret);
		al_set_dst_node(ret, "errorReason", msg);
		inc_error_retry(ret);
		return ret;
	} else {
	}
	if (http_conn.response_code != 200) {
		msg = "send error: unexpected HTTP response code: " + (string)http_conn.response_code + ", expected 200(OK)";
		notify(org_msgId, ret);
		al_set_dst_node(ret, "errorReason", msg);
		inc_error_retry(ret);
		return ret;
	} else {
	}
	var string res_msgId;
	try {
		var list res_props;
		res_props = al_cons(null, null);
		var AlException ex;
		var string dir;
		res_msgId = Context::genMsgId();
		al_create_arc(res_props, res_msgId, "msgId");
		al_create_arc(res_props, "sync", "fromIP");
		if (dir = al_dst_node(my_default_props, "msg.tmp.dir")) {
		} else {
			ex = new AlException;
			ex.msg = "property msg.tmp.dir is empty.";
			throw ex;
		}
		al_create_arc(res_props, dir, "tempDir");
		if (dir = al_dst_node(my_default_props, "msg.attach.dir")) {
		} else {
			ex = new AlException;
			ex.msg = "property msg.attach.dir is empty.";
			throw ex;
		}
		al_create_arc(res_props, dir, "attachDir");
		if (dir = al_dst_node(my_default_props, "msg.recv.dir")) {
		} else {
			ex = new AlException;
			ex.msg = "property msg.recv.dir is empty.";
			throw ex;
		}
		// save to file;
		var string res_filename;
		res_filename = dir + "/" + res_msgId;
		al_create_arc(res_props, res_filename, "filename");
		if (al_crypt("mime_headers_write", http_conn.headers, res_filename, null)) {
		} else {
			ex = new AlException;
			ex.msg = "can't generate mime message header.";
			throw ex;
		}
		try {
			FileUtility::appendBinary(res_filename, http_conn.contents);
		} catch (AlException e) {
			ex = new AlException;
			ex.msg = "file write error: file = " + res_filename + ".";
			throw ex;
		}
		try {
			var ProcMgr pm;
			var string pid;
			pm = new ProcMgr;
			pid = pm.create("RNIF20ReceiveProcess", conn);
			al_set_dst_node(res_props, "syncType", "reply");
			al_set_dst_node(res_props, "startTime", Context::genTimeStamp());
			pm.putProperties(pid, res_props, conn);
			pm.start(pid, conn);
		} catch (AlException e) {
			e.msg = "receive process start error: " + e.msg;
			throw e;
		}
	} catch (AlException e) {
		try {
			var list res_props;
			res_props = al_cons(null, null);
			al_set_dst_node(res_props, "errorReason", e.msg);
			al_set_dst_node(res_props, "sendRecv", "recv");
			al_set_dst_node(res_props, "errorLevel", "fatal");
			al_set_dst_node(res_props, "msgId", res_msgId);
			var RNIF20ServiceHandler handler;
			handler = new RNIF20ServiceHandler;
			handler.conn = conn;
			handler.invokeWriteLog(res_props);
		} catch (AlException e) {
		}
	}
	inc_retry(ret);
	al_set_dst_node(ret, "error", "timeout");
	return ret;
}
end_body
member
public: void notify(string msgId, list ret);
body
{
	var WaitObj wait_obj;
	var HttpResponse res2;
	if (sync_type == "reply" && msgId && wait_obj = DataMgr::getProperty(msgId)) {
		res2 = wait_obj.value2;
		wait_obj.value = 500;
		wait_obj.notify();
	} else {
	}
	al_set_dst_node(ret, "error", "timeout");
	al_set_dst_node(ret, "errorLevel", "error");
}
end_body
member
public: void inc_error_retry(list ret);
body
{
	error_retry_count = error_retry_count + 1;
	al_set_dst_node(ret, "errorRetryCount", (string)error_retry_count);
}
end_body
member
public: void inc_retry(list ret);
body
{
	retry_count = retry_count + 1;
	al_set_dst_node(ret, "retryCount", (string)retry_count);
}
end_body
member
public: integer error_retry_count;
member
public: integer retry_count;
member
public: string sync_type;
member
public: list invokeRetryOverLogInfo(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string msg;
	msg = "retry over";
	al_set_dst_node(ret, "error", "retryover");
	al_set_dst_node(ret, "errorLevel", "error");
	al_set_dst_node(ret, "errorReason", msg);
	return ret;
}
end_body
member
public: list invokeCheckReceipt(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string message_id, msgId, signal_code;
	message_id = al_dst_node(props, "messageId");
	var XmlDbAccessor acc, sh_acc;
	var XmlDbObject obj, sh_obj;
	var list ls, itr, ack, exception;
	acc = new XmlDbTableAccessor;
	acc.create("CommLog", "", conn);
	acc.setDTDfilename("CommLog.dtd");
	sh_acc = new XmlDbAccessor;
	sh_acc.create("ServiceHeader", "V02.00", conn);
	sh_acc.setDTDfilename("rosetta/ServiceHeader_MS_V02_00.dtd");
	ls = acc.get("CommLog/SendRecv", "recv", "CommLog/RefMsgId", message_id);
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		if (msgId = obj.getField("CommLog/rawMsgId")) {
		} else {
			continue;
		}
		try {
			sh_obj = sh_acc.get(msgId);
		} catch (AlException e) {
			continue;
		}
		signal_code = sh_obj.getField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/SignalIdentity/GlobalBusinessSignalCode");
		if (signal_code == "Receipt Acknowledgment") {
			ack = 1;
		} else {
		}
		if (signal_code == "Exception") {
			exception = 1;
		} else {
		}
	}
	if (ack) {
		al_set_dst_node(ret, "receiptExist", "true");
	} else {
	}
	if (exception) {
		al_set_dst_node(ret, "receiptExist", "exception");
	} else {
	}
	return ret;
}
end_body
member
public: list invokeCheckReply(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string message_id, msgId, action_code, signal_code;
	message_id = al_dst_node(props, "messageId");
	var XmlDbAccessor acc, sh_acc;
	var XmlDbObject obj, sh_obj;
	var list ls, itr, reply, exception;
	acc = new XmlDbTableAccessor;
	acc.create("CommLog", "", conn);
	acc.setDTDfilename("CommLog.dtd");
	sh_acc = new XmlDbAccessor;
	sh_acc.create("ServiceHeader", "V02.00", conn);
	sh_acc.setDTDfilename("rosetta/ServiceHeader_MS_V02_00.dtd");
	ls = acc.get("CommLog/SendRecv", "recv", "CommLog/RefMsgId", message_id);
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		if (msgId = obj.getField("CommLog/rawMsgId")) {
		} else {
			continue;
		}
		try {
			sh_obj = sh_acc.get(msgId);
		} catch (AlException e) {
			continue;
		}
		action_code = sh_obj.getField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/ActionIdentity/GlobalBusinessActionCode");
		if (action_code && action_code != "") {
			reply = 1;
		} else {
		}
		signal_code = sh_obj.getField("ServiceHeader/ProcessControl/ActivityControl/MessageControl/Manifest/ServiceContentControl/SignalIdentity/GlobalBusinessSignalCode");
		if (signal_code == "Exception") {
			exception = 1;
		} else {
		}
	}
	if (reply) {
		al_set_dst_node(ret, "replyExist", "true");
	} else {
	}
	if (exception) {
		al_set_dst_node(ret, "replyExist", "exception");
	} else {
	}
	return ret;
}
end_body
member
public: list invokeReceiveProcess(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string msg_type, msg_version, msgId, msg;
	var string my_id, my_role;
	var string partner_id, partner_role, partner_props;
	var string message_id;
	var string sync_type;
	var string process_name, pid;
	msg_type = al_dst_node(props, "msgType");
	msg_version = al_dst_node(props, "msgVersion");
	msgId = al_dst_node(props, "msgId");
	my_id = al_dst_node(props, "myId");
	my_role = al_dst_node(props, "myRole");
	partner_id = al_dst_node(props, "partnerId");
	partner_role = al_dst_node(props, "partnerRole");
	message_id = al_dst_node(props, "messageId");
	sync_type = al_dst_node(props, "syncType");
	try {
		var RNContext ctx;
		ctx = new RNContext;
		partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
	} catch (AlException e) {
		msg = errorMsg("start receive process error. fail to get partner properties.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "error");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	process_name = al_dst_node(partner_props, msg_type + ".process");
	if (process_name && process_name != null) {
		try {
			var XmlDbAccessor acc;
			var XmlDbObject obj;
			var list cond, ls, itr, already_started;
			var string appPid;
			acc = new XmlDbTableAccessor;
			acc.create("CommLog", "", conn);
			acc.setDTDfilename("CommLog.dtd");
			cond = al_cons(null, null);
			al_create_arc(cond, "recv", "CommLog/SendRecv");
			al_create_arc(cond, partner_id, "CommLog/PartnerId");
			al_create_arc(cond, message_id, "CommLog/MsgId");
			ls = acc.get(cond);
			itr = al_dst_itr(ls);
			loop {
				if (obj = al_next(itr)) {
				} else {
					break;
				}
				appPid = obj.getField("CommLog/AppPid");
				if (appPid && appPid != "") {
					already_started = 1;
					break;
				} else {
				}
			}
			if (already_started) {
			} else {
				var ProcMgr mgr;
				var list ps;
				mgr = new ProcMgr;
				ps = al_cons(null, null);
				al_create_arc(ps, msg_type, "msgType");
				al_create_arc(ps, msg_version, "msgVersion");
				al_create_arc(ps, msgId, "msgId");
				al_create_arc(ps, my_id, "myId");
				al_create_arc(ps, my_role, "myRole");
				al_create_arc(ps, partner_id, "partnerId");
				al_create_arc(ps, partner_role, "partnerRole");
				pid = mgr.create(process_name, conn);
				mgr.putProperties(pid, ps, conn);
				mgr.start(pid, conn);
			}
		} catch (AlException e) {
			msg = errorMsg("start receive process error.", e);
			al_set_dst_node(ret, "error", "true");
			al_set_dst_node(ret, "errorLevel", "fatal");
			al_set_dst_node(ret, "errorReason", msg);
			return ret;
		}
		if (pid && pid != "") {
			al_set_dst_node(ret, "errorReason", "receive process started.");
			al_set_dst_node(ret, "appProcessId", pid);
		} else {
			if (al_dst_node(props, "isSignal") == "false") {
				al_set_dst_node(ret, "errorReason", "");
			} else {
			}
		}
	} else {
		if (al_dst_node(props, "isSignal") == "false") {
			al_set_dst_node(ret, "errorReason", "");
		} else {
		}
	}
	// al_print("### ReceiveProcess: time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	return ret;
}
end_body
member
public: list invokeComplete(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string msg, waitProcessId, sync_type;
	var string error, error_level, error_reason;
	waitProcessId = al_dst_node(props, "waitProcessId");
	sync_type = al_dst_node(props, "syncType");
	error = al_dst_node(props, "error");
	error_level = al_dst_node(props, "errorLevel");
	error_reason = al_dst_node(props, "errorReason");
	try {
		if (sync_type == "async" && waitProcessId && waitProcessId != "") {
			var ProcMgr mgr;
			var string workItem;
			mgr = new ProcMgr;
			if (workItem = mgr.getWorkItem(waitProcessId, "WaitSendReceiptAck")) {
				var list ps;
				ps = al_cons(null, null);
				al_set_dst_node(ps, "error", "fail to send ack, exception, or NOF: " + error);
				al_set_dst_node(ps, "errorLevel", error_level);
				al_set_dst_node(ps, "errorReason", "ack send: " + error_reason);
				mgr.putProperties(waitProcessId, ps, conn);
				mgr.complete(waitProcessId, workItem, conn);
			} else {
				msg = "manual activity to be completed not found.";
				al_set_dst_node(ret, "error", "true");
				al_set_dst_node(ret, "errorLevel", "fatal");
				al_set_dst_node(ret, "errorReason", msg);
				return ret;
			}
		} else {
		}
	} catch (AlException e) {
		msg = errorMsg("fail to complete waiting manual activity.", e);
		al_set_dst_node(ret, "error", "true");
		al_set_dst_node(ret, "errorLevel", "fatal");
		al_set_dst_node(ret, "errorReason", msg);
		return ret;
	}
	al_set_dst_node(ret, "error", "none");
	al_set_dst_node(ret, "errorLevel", "info");
	al_set_dst_node(ret, "errorReason", "");
	return ret;
}
end_body
member
public: list invokeWriteLog(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	var string send_recv, log_level, time, error_reason;
	var string url_fromIP, my_id, partner_id;
	var string msg_type, msgId, message_id, reference_id, transaction_id;
	var string transport_pid, application_pid;
	error_reason = al_dst_node(props, "errorReason");
	if (error_reason == null || error_reason == "") {
		return ret;
	} else {
	}
	send_recv = al_dst_node(props, "sendRecv");
	msgId = al_dst_node(props, "msgId");
	log_level = al_dst_node(props, "errorLevel");
	time = al_misc("get_time", null, null);
	time = al_misc("get_localtime", time, null);
	time = al_misc("format_time", time, "yyyy'/'MM'/'dd'-'HH':'mm':'ss");
	my_id = al_dst_node(props, "myId");
	partner_id = al_dst_node(props, "partnerId");
	msg_type = al_dst_node(props, "msgType");
	message_id = al_dst_node(props, "messageId");
	reference_id = al_dst_node(props, "referenceId");
	transaction_id = al_dst_node(props, "transactionId");
	transport_pid = al_dst_node(props, "*process.id");
	application_pid = al_dst_node(props, "appProcessId");
	if (send_recv == "send") {
		url_fromIP = al_dst_node(props, "URL");
	} else {
	}
	if (send_recv == "recv") {
		url_fromIP = al_dst_node(props, "fromIP");
	} else {
	}
	try {
		var string sql;
		sql = al_copy("insert into CommLog values('");
		al_append_str(sql, conn.getNextSeq("CommLogId_seq"));
		al_append_str(sql, "','rosetta','");
		al_append_str(sql, send_recv);
		al_append_str(sql, "','");
		al_append_str(sql, log_level);
		al_append_str(sql, "','");
		al_append_str(sql, time);
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(msg_type));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(error_reason));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(url_fromIP));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(my_id));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(partner_id));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(msgId));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(message_id));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(reference_id));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(transaction_id));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(transport_pid));
		al_append_str(sql, "','");
		al_append_str(sql, DbUtility::convChar(application_pid));
		al_append_str(sql, "')");
		conn.executeUpdate(sql);
		if ((log_level == "fatal" || log_level == "error") && appServer) {
			var string msg;
			msg = "CommLog: " + (string)send_recv + ", " + (string)url_fromIP + ", " + (string)msg_type + ", " + (string)partner_id + ", " + (string)error_reason;
			if (al_strlen(msg) > XmlDbObject::MAX_VALUE_SIZE) {
				msg = al_substr(msg, 0, XmlDbObject::MAX_VALUE_SIZE);
			} else {
			}
			appServer.system_log(log_level, msg);
		} else {
		}
	} catch (AlException e) {
		try {
			var string msg;
			msg = "can't write communication log";
			appServer.system_log("fatal", msg);
		} catch (AlException e) {
		}
	}
	al_set_dst_node(ret, "errorLevel", "info");
	al_set_dst_node(ret, "errorReason", "OK");
	return ret;
}
end_body
member
public: list invokeCleanup(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	if (debug_mode) {
		return ret;
	} else {
	}
	var string msgId, tmp_dir, pr_tmp, dh_tmp, sh_tmp, sc_tmp;
	msgId = al_dst_node(props, "msgId");
	tmp_dir = al_dst_node(props, "tempDir");
	pr_tmp = tmp_dir + "/" + msgId + "-Preamble";
	if (al_file_manip("does_exist", pr_tmp, null)) {
		al_file_manip("remove", pr_tmp, null);
	} else {
	}
	dh_tmp = tmp_dir + "/" + msgId + "-DeliveryHeader";
	if (al_file_manip("does_exist", dh_tmp, null)) {
		al_file_manip("remove", dh_tmp, null);
	} else {
	}
	sh_tmp = tmp_dir + "/" + msgId + "-ServiceHeader";
	if (al_file_manip("does_exist", sh_tmp, null)) {
		al_file_manip("remove", sh_tmp, null);
	} else {
	}
	sc_tmp = tmp_dir + "/" + msgId + "-ServiceContent";
	if (al_file_manip("does_exist", sc_tmp, null)) {
		al_file_manip("remove", sc_tmp, null);
	} else {
	}
	return ret;
}
end_body
member
public: list isTimeout(list props);
body
{
	var string start, check;
	var integer receipt, reply;
	var list time;
	start = al_dst_node(props, "startTime");
	receipt = getTime((string)al_dst_node(props, "receiptWaitTime"));
	reply = getTime((string)al_dst_node(props, "replyWaitTime"));
	time = al_misc("get_time", null, null);
	time = time - reply - receipt;
	time = al_misc("get_localtime", time, null);
	check = al_misc("format_time", time, "yyyyMMdd'-'HHmmss");
	return start < check;
}
end_body
end_class
class SampleBuyerServiceHandler
member
public: list invokeCreatePoRequest(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	// get properties
	var string buyer, supplier;
	var string product1, price1, quantity1, ship_date1;
	var string product2, price2, quantity2, ship_date2;
	buyer = al_dst_node(props, "buyer");
	supplier = al_dst_node(props, "supplier");
	product1 = al_dst_node(props, "product1");
	quantity1 = al_dst_node(props, "quantity1");
	price1 = al_dst_node(props, "price1");
	ship_date1 = al_dst_node(props, "shipDate1");
	product2 = al_dst_node(props, "product2");
	quantity2 = al_dst_node(props, "quantity2");
	price2 = al_dst_node(props, "price2");
	ship_date2 = al_dst_node(props, "shipDate2");
	// create db object
	var XmlDbObject obj, obj2, obj3;
	var string msgId, msgType, msgVersion, dtd_filename;
	msgType = "Pip3A4PurchaseOrderRequest";
	msgVersion = "1.1";
	dtd_filename = "rosetta/3A4PurchaseOrderRequestMessageGuideline_v1_1.dtd";
	obj = XmlUtility::createMsgData(msgId, msgType, msgVersion, dtd_filename, conn);
	msgId = obj.msgId;
	al_set_dst_node(ret, "msgId", msgId);
	// set csv data
	var Csv1DataItr csv_itr, csv_itr2, csv_itr3;
	csv_itr = new Csv1DataItr;
	csv_itr.loadCSV("./data/rosetta_sample/PORequest.csv");
	csv_itr.Reset();
	loop {
		if (csv_itr.nextRow()) {
		} else {
			break;
		}
		obj.putField(csv_itr.dst_path, csv_itr.value);
	}
	csv_itr.Reset();
	var integer line_number;
	line_number = 0;
	loop {
		if (csv_itr2 = csv_itr.nextChild("ProductLineItem")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
		// set input data
		obj2.putField("LineNumber", (string)(line_number = line_number + 1));
		if (line_number == 1) {
			obj2.putField("productUnit/ProductPackageDescription/ProductDescription/GlobalProductIdentifier", product1);
			obj2.putField("ProductQuantity", quantity1);
			obj2.putField("requestedPrice/FinancialAmount/MonetaryAmount", price1);
			obj2.putField("requestedShipDate/DateStamp", ship_date1);
		} else {
		}
		if (line_number == 2) {
			obj2.putField("productUnit/ProductPackageDescription/ProductDescription/GlobalProductIdentifier", product2);
			obj2.putField("ProductQuantity", quantity2);
			obj2.putField("requestedPrice/FinancialAmount/MonetaryAmount", price2);
			obj2.putField("requestedShipDate/DateStamp", ship_date2);
		} else {
		}
		csv_itr2.Reset();
		loop {
			if (csv_itr3 = csv_itr2.nextChild("shipFrom")) {
			} else {
				break;
			}
			obj3 = obj2.createChild(csv_itr3.base_dst_path);
			csv_itr3.Reset();
			loop {
				if (csv_itr3.nextRow()) {
				} else {
					break;
				}
				obj3.putField(csv_itr3.dst_path, csv_itr3.value);
			}
		}
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("PartnerDescription")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
	}
	var string my_id, my_role, partner_id, partner_role;
	var list partner_props, my_props;
	var XmlDbObject my_info_obj;
	var RNContext ctx;
	ctx = new RNContext;
	// partner info
	var integer idx;
	idx = al_search_str(supplier, 0, ": ");
	if (idx < 0) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "selected partner info is not valid.";
		throw ex;
	} else {
	}
	partner_id = al_substr(supplier, 0, idx);
	partner_role = al_tail_str(supplier, idx + 2);
	partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
	al_set_dst_node(ret, "partnerId", partner_id);
	al_set_dst_node(ret, "partnerRole", partner_role);
	obj.putField("Pip3A4PurchaseOrderRequest/toRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", (string)al_dst_node(partner_props, "Class"));
	obj.putField("Pip3A4PurchaseOrderRequest/toRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", partner_id);
	// my info
	my_info_obj = ctx.getMyInfoXmlDbObject(buyer, conn);
	my_id = my_info_obj.getField("MyInfo/BusinessId");
	my_role = buyer;
	my_props = ctx.getMyProperties(my_role, conn);
	al_set_dst_node(ret, "myId", my_id);
	al_set_dst_node(ret, "myRole", my_role);
	obj.putField("Pip3A4PurchaseOrderRequest/fromRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", (string)al_dst_node(my_props, "Class"));
	obj.putField("Pip3A4PurchaseOrderRequest/fromRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", my_id);
	// common info
	obj.putField("Pip3A4PurchaseOrderRequest/thisDocumentGenerationDateTime/DateTimeStamp", RNContext::currentDateTime());
	obj.putField("Pip3A4PurchaseOrderRequest/thisDocumentIdentifier/ProprietaryDocumentIdentifier", RNContext::genDocId());
	return ret;
}
end_body
member
public: list invokeSendPoRequest(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	// get send messge info
	var string msgId;
	var string my_id, my_role, partner_id, partner_role;
	var string app_pid;
	msgId = al_dst_node(props, "msgId");
	my_id = al_dst_node(props, "myId");
	my_role = al_dst_node(props, "myRole");
	partner_id = al_dst_node(props, "partnerId");
	partner_role = al_dst_node(props, "partnerRole");
	app_pid = al_dst_node(props, "*process.id");
	// send
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.set_app_pid(app_pid);
	tr.send(msgId, partner_id, partner_role, my_id, my_role, conn);
	return ret;
}
end_body
member
public: list invokeComplete(list props);
body
{
	var string msgId;
	msgId = al_dst_node(props, "msgId");
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string tracking_id, pid, workitem;
	acc = new XmlDbTableAccessor;
	acc.create("CommLog", "", conn);
	acc.setDTDfilename("CommLog.dtd");
	// get receive log and TrackingId
	ls = acc.get("CommLog/SendRecv", "recv", "CommLog/rawMsgId", msgId);
	itr = al_dst_itr(ls);
	obj = al_next(itr);
	tracking_id = obj.getField("CommLog/RefMsgId");
	// get send log and PoSendProcessId
	ls = acc.get("CommLog/SendRecv", "send", "CommLog/MsgId", tracking_id);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
		pid = obj.getField("CommLog/AppPid");
		// get workitem and complete
		var ProcMgr mgr;
		mgr = new ProcMgr;
		if (workitem = mgr.getWorkItem(pid, "WaitConfirm", conn)) {
			mgr.complete(pid, workitem, conn);
		} else {
		}
	} else {
	}
}
end_body
end_class
class SampleSupplierServiceHandler
member
public: list invokeCreatePoAcceptance(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	// get org db object
	var XmlDbObject org_obj, org_obj2, org_obj3;
	var string orgMsgId, orgMsgType, orgMsgVersion, org_dtd_filename;
	orgMsgId = al_dst_node(props, "msgId");
	orgMsgType = "Pip3A4PurchaseOrderRequest";
	orgMsgVersion = "1.1";
	org_dtd_filename = "rosetta/3A4PurchaseOrderRequestMessageGuideline_v1_1.dtd";
	org_obj = XmlUtility::getMsgData(orgMsgId, orgMsgType, orgMsgVersion, org_dtd_filename, conn);
	// create db object
	var XmlDbObject obj, obj2, obj3;
	var string msgId, msgType, msgVersion, dtd_filename;
	msgType = "Pip3A4PurchaseOrderAcceptance";
	msgVersion = "1.1";
	dtd_filename = "rosetta/3A4PurchaseOrderAcceptanceMessageGuideline_v1_1.dtd";
	obj = XmlUtility::createMsgData(msgId, msgType, msgVersion, dtd_filename, conn);
	msgId = obj.msgId;
	al_set_dst_node(ret, "sendMsgId", msgId);
	// set csv data
	var Csv1DataItr csv_itr, csv_itr2, csv_itr3;
	var list org_obj2_ls, org_obj2_itr;
	csv_itr = new Csv1DataItr;
	csv_itr.loadCSV("./data/rosetta_sample/POAccept.csv");
	csv_itr.Reset();
	loop {
		if (csv_itr.nextRow()) {
		} else {
			break;
		}
		if (csv_itr.src_path != "") {
			obj.putField(csv_itr.dst_path, org_obj.getField(csv_itr.src_path));
		} else {
			obj.putField(csv_itr.dst_path, csv_itr.value);
		}
	}
	org_obj2_ls = org_obj.getChildren("Pip3A4PurchaseOrderRequest/PurchaseOrder/ProductLineItem", (list)al_cons(null, null), "LineNumber", "", "0", "9999", "LineNumber", "integer", null);
	org_obj2_itr = al_dst_itr(org_obj2_ls);
	loop {
		if (org_obj2 = al_next(org_obj2_itr)) {
		} else {
			break;
		}
		csv_itr.Reset();
		csv_itr2 = csv_itr.nextChild("ProductLineItem");
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			if (csv_itr2.src_path != "") {
				obj2.putField(csv_itr2.dst_path, org_obj2.getField(csv_itr2.src_path));
			} else {
				obj2.putField(csv_itr2.dst_path, csv_itr2.value);
			}
		}
		csv_itr2.Reset();
		csv_itr3 = csv_itr2.nextChild("ProductQuantity");
		obj3 = obj2.createChild(csv_itr3.base_dst_path);
		obj3.putField("", org_obj2.getField("ProductQuantity"));
	}
	var string my_id, my_role, partner_id, partner_role;
	var list partner_props, my_props;
	var XmlDbObject my_info_obj;
	var RNContext ctx;
	ctx = new RNContext;
	// partner info
	partner_id = al_dst_node(props, "partnerId");
	partner_role = al_dst_node(props, "partnerRole");
	partner_props = ctx.getPartnerProperties(partner_id, partner_role, conn);
	obj.putField("Pip3A4PurchaseOrderAcceptance/toRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", (string)al_dst_node(partner_props, "Class"));
	obj.putField("Pip3A4PurchaseOrderAcceptance/toRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", partner_id);
	// my info
	my_id = al_dst_node(props, "myId");
	my_role = al_dst_node(props, "myRole");
	my_info_obj = ctx.getMyInfoXmlDbObject(my_role, conn);
	my_id = my_info_obj.getField("MyInfo/BusinessId");
	my_props = ctx.getMyProperties(my_role, conn);
	obj.putField("Pip3A4PurchaseOrderAcceptance/fromRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", (string)al_dst_node(my_props, "Class"));
	obj.putField("Pip3A4PurchaseOrderAcceptance/fromRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", my_id);
	// common info
	obj.putField("Pip3A4PurchaseOrderAcceptance/thisDocumentGenerationDateTime/DateTimeStamp", RNContext::currentDateTime());
	obj.putField("Pip3A4PurchaseOrderAcceptance/thisDocumentIdentifier/ProprietaryDocumentIdentifier", RNContext::genDocId());
	var string req_doc_gen_date_time, req_doc_id;
	req_doc_gen_date_time = org_obj.getField("Pip3A4PurchaseOrderRequest/thisDocumentGenerationDateTime/DateTimeStamp");
	req_doc_id = org_obj.getField("Pip3A4PurchaseOrderRequest/thisDocumentIdentifier/ProprietaryDocumentIdentifier");
	obj.putField("Pip3A4PurchaseOrderAcceptance/requestingDocumentDateTime/DateTimeStamp", req_doc_gen_date_time);
	obj.putField("Pip3A4PurchaseOrderAcceptance/requestingDocumentIdentifier/ProprietaryDocumentIdentifier", req_doc_id);
	// other
	obj.putField("Pip3A4PurchaseOrderAcceptance/PurchaseOrder/purchaseOrderDate/DateStamp", RNContext::currentDateStamp());
	return ret;
}
end_body
member
public: list invokeSendPoAcceptance(list props);
body
{
	return sendReply(props);
}
end_body
member
public: list invokeCreateAdvanceShipmentNotification(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	// get properties
	var string my_id, partner_id;
	my_id = al_dst_node(props, "myId");
	partner_id = al_dst_node(props, "partnerId");
	// create db object
	var XmlDbObject obj, obj2, obj3, obj4;
	var string msgId, msgType, msgVersion, dtd_filename;
	msgType = "Pip3B2AdvanceShipmentNotification";
	msgVersion = "R01.00";
	dtd_filename = "rosetta/3B2_MS_R01_00_AdvanceShipmentNotification.dtd";
	obj = XmlUtility::createMsgData(msgId, msgType, msgVersion, dtd_filename, conn);
	msgId = obj.msgId;
	al_set_dst_node(ret, "sendMsgId", msgId);
	// set csv data
	var Csv1DataItr csv_itr, csv_itr2, csv_itr3, csv_itr4;
	csv_itr = new Csv1DataItr;
	csv_itr.loadCSV("./data/rosetta_sample/AdvanceShipNotify.csv");
	csv_itr.Reset();
	loop {
		if (csv_itr.nextRow()) {
		} else {
			break;
		}
		obj.putField(csv_itr.dst_path, csv_itr.value);
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("confirmEvent")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("ScheduledEvent")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("Container")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
		csv_itr2.Reset();
		loop {
			if (csv_itr3 = csv_itr2.nextChild("ShipItem")) {
			} else {
				break;
			}
			obj3 = obj2.createChild(csv_itr3.base_dst_path);
			csv_itr3.Reset();
			loop {
				if (csv_itr3.nextRow()) {
				} else {
					break;
				}
				obj3.putField(csv_itr3.dst_path, csv_itr3.value);
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("Reference")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("Lincense")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("Description")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("LotProfile")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("Manifacturer")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("ProductId")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("TraceId")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("TrackRef")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
		}
	}
	// partner info
	obj.putField("Pip3B2AdvanceShipmentNotification/toRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", partner_id);
	// my info
	obj.putField("Pip3B2AdvanceShipmentNotification/fromRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", my_id);
	// common info
	obj.putField("Pip3B2AdvanceShipmentNotification/thisDocumentGenerationDateTime/DateTimeStamp", RNContext::currentDateTime());
	obj.putField("Pip3B2AdvanceShipmentNotification/thisDocumentIdentifier/ProprietaryDocumentIdentifier", RNContext::genDocId());
	return ret;
}
end_body
member
public: list invokeSendAdvanceShipmentNotification(list props);
body
{
	return sendReply(props);
}
end_body
member
public: list invokeCreateInvoiceNotification(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	// get properties
	var string my_id, partner_id;
	my_id = al_dst_node(props, "myId");
	partner_id = al_dst_node(props, "partnerId");
	// create db object
	var XmlDbObject obj, obj2, obj3, obj4;
	var string msgId, msgType, msgVersion, dtd_filename;
	msgType = "Pip3C3InvoiceNotification";
	msgVersion = "R01.00";
	dtd_filename = "rosetta/3C3_MS_R01_00_InvoiceNotification.dtd";
	obj = XmlUtility::createMsgData(msgId, msgType, msgVersion, dtd_filename, conn);
	msgId = obj.msgId;
	al_set_dst_node(ret, "sendMsgId", msgId);
	// set csv data
	var Csv1DataItr csv_itr, csv_itr2, csv_itr3, csv_itr4;
	csv_itr = new Csv1DataItr;
	csv_itr.loadCSV("./data/rosetta_sample/InvoiceNotify.csv");
	csv_itr.Reset();
	loop {
		if (csv_itr.nextRow()) {
		} else {
			break;
		}
		obj.putField(csv_itr.dst_path, csv_itr.value);
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("billToAcount")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("remitToAccout")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("InvoiceItem")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
		csv_itr2.Reset();
		loop {
			if (csv_itr3 = csv_itr2.nextChild("ProductItetm")) {
			} else {
				break;
			}
			obj3 = obj2.createChild(csv_itr3.base_dst_path);
			csv_itr3.Reset();
			loop {
				if (csv_itr3.nextRow()) {
				} else {
					break;
				}
				obj3.putField(csv_itr3.dst_path, csv_itr3.value);
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("ProcutId")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("shipDate")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("shipFrom")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
			csv_itr3.Reset();
			loop {
				if (csv_itr4 = csv_itr3.nextChild("Tax")) {
				} else {
					break;
				}
				obj4 = obj3.createChild(csv_itr4.base_dst_path);
				csv_itr4.Reset();
				loop {
					if (csv_itr4.nextRow()) {
					} else {
						break;
					}
					obj4.putField(csv_itr4.dst_path, csv_itr4.value);
				}
			}
		}
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("SalseOrderId")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("soldToAccount")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("transferToAccount")) {
		} else {
			break;
		}
		obj2 = obj.createChild(csv_itr2.base_dst_path);
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			obj2.putField(csv_itr2.dst_path, csv_itr2.value);
		}
	}
	// partner info
	obj.putField("Pip3C3InvoiceNotification/toRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", partner_id);
	// my info
	obj.putField("Pip3C3InvoiceNotification/fromRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", my_id);
	// common info
	obj.putField("Pip3C3InvoiceNotification/thisDocumentGenerationDateTime/DateTimeStamp", RNContext::currentDateTime());
	obj.putField("Pip3C3InvoiceNotification/thisDocumentIdentifier/ProprietaryDocumentIdentifier", RNContext::genDocId());
	return ret;
}
end_body
member
public: list invokeSendInvoiceNotification(list props);
body
{
	return sendReply(props);
}
end_body
member
public: list sendReply(list props);
body
{
	var list ret;
	ret = al_cons(null, null);
	// get send messge info
	var string msgId, org_msgId;
	var string my_id, my_role, partner_id, partner_role;
	var string app_pid;
	msgId = al_dst_node(props, "sendMsgId");
	org_msgId = al_dst_node(props, "msgId");
	my_id = al_dst_node(props, "myId");
	my_role = al_dst_node(props, "myRole");
	partner_id = al_dst_node(props, "partnerId");
	partner_role = al_dst_node(props, "partnerRole");
	app_pid = al_dst_node(props, "*process.id");
	// send
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.set_org_msg_info(org_msgId);
	tr.set_app_pid(app_pid);
	tr.send(msgId, partner_id, partner_role, my_id, my_role, conn);
	return ret;
}
end_body
end_class
end_class
end_class
class DbUtility
member
public: string convChar(string str);
body
{
	if (str) {
	} else {
		return "";
	}
	str = al_str_misc("to_single_quote_string", str, null);
	if (al_strlen(str) > XmlDbObject::MAX_VALUE_SIZE) {
		str = al_substr(str, 0, XmlDbObject::MAX_VALUE_SIZE);
	} else {
	}
	return str;
}
end_body
class DbConnection
member
public: void prepare(string sql);
body
{
	if (pool) {
		pool.sql_trace_log("prepare: sql = " + sql);
	} else {
	}
	var list err;
	statement = al_sql("statement", connection, null, null, null);
	if (al_is_type(statement, "string")) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: create statement error: " + statement;
		throw ex;
	} else {
	}
	if (err = al_sql("prepare", statement, sql, null, null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: prepare error: sql = " + sql + ": " + err;
		throw ex;
	} else {
	}
}
end_body
member
public: list executeQuery(integer num_cols, list values);
body
{
	if (pool) {
		pool.sql_trace_log("executeQuery:");
	} else {
	}
	var list err, result_set;
	var integer i;
	if (err = al_sql("execute", statement, null, values, null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: execute error: " + err;
		throw ex;
	} else {
	}
	types = al_cons(null, null);
	i = 0;
	loop {
		if (i < num_cols) {
		} else {
			break;
		}
		al_create_arc(types, "string", null);
		i = i + 1;
	}
	result_set = al_sql("result", statement, types, max_result_set, null);
	if (al_is_type(result_set, "string")) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: result error: " + result_set;
		throw ex;
	} else {
	}
	return result_set;
}
end_body
member
public: void executeUpdate(list values);
body
{
	in_transaction = 1;
	if (pool) {
		pool.sql_trace_log("executeUpdate:");
	} else {
	}
	var list err;
	var integer i;
	if (err = al_sql("execute", statement, null, values, null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: execute error: " + err;
		throw ex;
	} else {
	}
}
end_body
member
public: list executeQuery(integer num_cols, string sql);
body
{
	if (pool) {
		pool.sql_trace_log("executeQuery: sql = " + sql);
	} else {
	}
	var list err, result_set;
	var integer i;
	statement = al_sql("statement", connection, null, null, null);
	if (al_is_type(statement, "string")) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: create statement error: " + statement;
		throw ex;
	} else {
	}
	if (err = al_sql("execute", statement, sql, null, null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: execute error: " + err;
		throw ex;
	} else {
	}
	types = al_cons(null, null);
	i = 0;
	loop {
		if (i < num_cols) {
		} else {
			break;
		}
		al_create_arc(types, "string", null);
		i = i + 1;
	}
	result_set = al_sql("result", statement, types, max_result_set, null);
	if (al_is_type(result_set, "string")) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: result error: " + result_set;
		throw ex;
	} else {
	}
	return result_set;
}
end_body
member
public: void executeUpdate(string sql);
body
{
	in_transaction = 1;
	if (pool) {
		pool.sql_trace_log("executeUpdate: sql = " + sql);
	} else {
	}
	var list err;
	statement = al_sql("statement", connection, null, null, null);
	if (al_is_type(statement, "string")) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: create statement error: " + statement;
		throw ex;
	} else {
	}
	if (err = al_sql("execute", statement, sql, null, null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: execute error: " + err;
		throw ex;
	} else {
	}
}
end_body
member
public: list nextResultSet();
body
{
	var list result_set;
	result_set = al_sql("result", statement, types, max_result_set, null);
	if (al_is_type(result_set, "string")) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: result error: " + result_set;
		throw ex;
	} else {
	}
	if (al_dst_node(result_set, null)) {
	} else {
		result_set = null;
	}
	return result_set;
}
end_body
member
public: void setMaxResultSet(integer count);
body
{
	max_result_set = count;
}
end_body
member
public: void clearMaxResultSet();
body
{
	if (max_result_set) {
		max_result_set = null;
	} else {
	}
}
end_body
member
public: string getNextSeq(string sequenceName);
body
{
	var list value;
	value = al_misc("get_time", null, null);
	value = al_misc("get_localtime", value, null);
	value = al_misc("format_time", value, "yyyyMMddHHmmss");
	value = value + "-" + (string)al_misc("random", null, null);
	return value;
	// var string sql;
	// var list rs, rec, ok;
	// if (db_type == "oracle") {
	// sql = "select " + sequenceName + ".nextval from dual";
	// ok = 1;
	// } else {
	// }
	// if (db_type == "postgresql") {
	// sql = "select nextval(\'" + sequenceName + "\')";
	// ok = 1;
	// } else {
	// }
	// if (db_type == "mysql") {
	// sql = "update " + sequenceName + " set id=LAST_INSERT_ID(id+1)";
	// executeUpdate(sql);
	// sql = "select id from " + sequenceName;
	// ok = 1;
	// } else {
	// }
	// if (ok) {
	// rs = executeQuery(1, sql);
	// rec = al_dst_node(rs, null);
	// return al_dst_node(rec, 1);
	// } else {
	// }
	// var AlException ex;
	// ex = new AlException;
	// ex.msg = "sql: unsuported db type: " + (string)db_type;
	// throw ex;
}
end_body
member
public: void commit();
body
{
	if (in_transaction) {
	} else {
		return;
	}
	in_transaction = null;
	var list err;
	if (err = al_sql("commit", connection, null, null, null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: commit error: " + (string)err;
		throw ex;
	} else {
	}
}
end_body
member
public: void rollback();
body
{
	if (in_transaction) {
	} else {
		return;
	}
	var list err;
	if (err = al_sql("rollback", connection, null, null, null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: rollback error: " + (string)err;
		throw ex;
	} else {
	}
	in_transaction = null;
}
end_body
member
public: void close();
body
{
	statement = null;
	connection = null;
}
end_body
member
public: list connection;
member
public: list statement;
member
public: list types;
member
public: integer max_result_set;
member
public: string db_type;
member
public: DbConnectionPool pool;
member
public: list in_transaction;
class DbPoolConnection
member
public: void close();
body
{
	try {
		if (in_transaction) {
			rollback();
		} else {
		}
	} catch (AlException e) {
	}
	if (pool) {
		pool.sql_trace_log("close");
		statement = null;
		al_misc("para_lock", 1, null);
		al_remove_from(pool.used_connections, this, null);
		al_create_arc(pool.free_connections, this, null);
		al_misc("para_lock", null, null);
		pool = null;
	} else {
	}
	max_result_set = null;
}
end_body
end_class
end_class
class DbConnectionPool
member
public: AltairServer ap_server;
member
public: void start();
body
{
	var DbPoolConnection conn;
	var list ls, itr;
	ls = al_cons(null, null);
	free_connections = al_cons(null, null);
	used_connections = al_cons(null, null);
	num_connections = 0;
	loop {
		if (num_connections < initial_connections) {
		} else {
			break;
		}
		conn = getConnection();
		al_create_arc(ls, conn, null);
		num_connections = num_connections + 1;
	}
	itr = al_dst_itr(ls);
	loop {
		if (conn = al_next(itr)) {
		} else {
			break;
		}
		conn.close();
	}
}
end_body
member
public: void stop();
body
{
	max_connections = 0;
	var DbPoolConnection conn;
	var list itr;
	loop {
		if (conn = al_dst_node(used_connections, null)) {
		} else {
			break;
		}
		conn.close();
	}
	itr = al_dst_itr(free_connections);
	loop {
		if (conn = al_next(itr)) {
		} else {
			break;
		}
		conn.statement = null;
		conn.connection = null;
		al_remove(itr);
	}
	used_connections = null;
	free_connections = null;
}
end_body
member
public: string pool_name;
member
public: DbConnection getConnection();
body
{
	if (max_connections == 0) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: no more connection: shutdown now";
		throw ex;
	} else {
	}
	al_misc("para_lock", 1, null);
	var list itr, connection;
	var DbPoolConnection conn;
	itr = al_dst_itr(free_connections);
	if (conn = al_next(itr)) {
		al_remove(itr);
	} else {
		if (num_connections >= max_connections) {
			al_misc("para_lock", null, null);
			var AlException ex;
			ex = new AlException;
			ex.msg = "sql: no more connection: max_connections = " + (string)max_connections;
			throw ex;
		} else {
		}
		conn = DbManager::getConnection(db_type, host, port, db_name, user, pass);
		connection = conn.connection;
		conn = new DbPoolConnection;
		conn.connection = connection;
		num_connections = num_connections + 1;
	}
	al_create_arc(used_connections, conn, null);
	conn.pool = this;
	conn.db_type = db_type;
	sql_trace_log("getConnection");
	al_misc("para_lock", null, null);
	return conn;
}
end_body
member
public: string db_type;
member
public: string host;
member
public: string port;
member
public: string db_name;
member
public: string user;
member
public: string pass;
member
public: list free_connections;
member
public: list used_connections;
member
public: integer initial_connections;
member
public: integer max_connections;
member
public: integer num_connections;
member
public: void sql_trace_log(string str);
body
{
	if (sql_trace_log_filepath) {
		ap_server.log(sql_trace_log_filepath, str);
	} else {
	}
}
end_body
member
public: string sql_trace_log_filepath;
end_class
class DbManager
member
public: static list createPool(DbConnectionPool pool, string pool_name);
body
{
	if (pools) {
	} else {
		pools = al_cons(null, null);
	}
	if (pool_name == null) {
		return "pool_name is null.";
	} else {
	}
	if (al_dst_node(pools, pool_name)) {
		return "pool_name(" + pool_name + ") already used.";
	} else {
	}
	try {
		pool.start();
	} catch (AlException e) {
		pool.stop();
		return e.msg;
	}
	al_create_arc(pools, pool, pool_name);
	return null;
}
end_body
member
public: static void closeAllPools();
body
{
	if (pools) {
	} else {
		return;
	}
	var DbConnectionPool pool;
	var list itr;
	itr = al_dst_itr(pools);
	loop {
		if (pool = al_next(itr)) {
		} else {
			break;
		}
		pool.stop();
		al_remove(itr);
	}
	pool = null;
	al_sql("finalize", null, null, null, null);
}
end_body
member
public: static string getDbType(string pool_name);
body
{
	var DbConnectionPool pool;
	if (pools) {
		if (pool = al_dst_node(pools, pool_name)) {
			return pool.db_type;
		} else {
		}
	} else {
	}
	var AlException ex;
	ex = new AlException;
	ex.msg = "sql: pool not found: pool_name = " + (string)pool_name;
	throw ex;
}
end_body
member
public: static DbConnection getConnection(string pool_name);
body
{
	var DbConnectionPool pool;
	if (pools) {
		if (pool = al_dst_node(pools, pool_name)) {
			return pool.getConnection();
		} else {
		}
	} else {
	}
	var AlException ex;
	ex = new AlException;
	ex.msg = "sql: pool not found: pool_name = " + (string)pool_name;
	throw ex;
}
end_body
member
public: static list pools;
member
public: static DbConnection getConnection(string db_type, string host, string port, string db_name, string user, string pass);
body
{
	var list connection, conn_info;
	conn_info = al_list5(host, port, db_name, user, pass);
	connection = al_sql("connect", conn_info, db_type, null, null);
	if (al_is_type(connection, "string")) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "sql: connect error: " + connection;
		throw ex;
	} else {
	}
	var DbConnection conn;
	conn = new DbConnection;
	conn.connection = connection;
	conn.db_type = db_type;
	return conn;
}
end_body
end_class
end_class
class FileUtility
member
public: static string tempFile();
body
{
	var string platform, dir;
	platform = al_misc("platform", null, null);
	if (platform == "linux" || platform == "mac") {
		dir = "/tmp";
	} else {
	}
	if (platform == "windows") {
		dir = al_misc("get_env", "TEMP", null);
	} else {
	}
	return al_file_manip("tmp_file", dir, "al");
}
end_body
member
public: static list readBinary(string filename);
body
{
	var integer size;
	var file in;
	var list buffer;
	if (al_file_manip("does_exist", filename, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: '" + (string)filename + "' not found";
		throw ex;
	}
	if (filename && size = al_file_manip("get_size", filename, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: can't get file size of '" + (string)filename + "'";
		throw ex;
	}
	if (in = al_file_open(filename, "rb")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: can't open read file '" + (string)filename + "'";
		throw ex;
	}
	buffer = al_misc("binary", size, null);
	if (al_file_read(in, al_list3(buffer, 0, size))) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: fail to read '" + (string)filename + "'";
		throw ex;
	} else {
	}
	return buffer;
}
end_body
member
public: static string readString(string filename);
body
{
	var list buffer;
	var integer size;
	var string str;
	buffer = readBinary(filename);
	size = al_misc("binary_size", buffer, null);
	str = al_misc("binary_to_string", al_list3(buffer, 0, size), null);
	return str;
}
end_body
member
public: static void writeBinary(string filename, list bin);
body
{
	var integer size;
	size = al_misc("binary_size", bin, null);
	writeBinary(filename, bin, 0, size);
}
end_body
member
public: static void writeBinary(string filename, list bin, integer from, integer size);
body
{
	var file out;
	if (out = al_file_open(filename, "wb")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: can't open write file '" + (string)filename + "'";
		throw ex;
	}
	if (al_file_write(out, al_list3(bin, from, size), null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: fail to write '" + (string)filename + "'";
		throw ex;
	} else {
	}
}
end_body
member
public: static void writeBinary(string filename, string str);
body
{
	var integer size;
	var list bin;
	size = al_strlen(str);
	bin = al_misc("binary", size, null);
	al_misc("binary_copy", al_list2(bin, 0), str);
	writeBinary(filename, bin, 0, size);
}
end_body
member
public: static void appendBinary(string filename, list bin);
body
{
	var integer size;
	size = al_misc("binary_size", bin, null);
	appendBinary(filename, bin, 0, size);
}
end_body
member
public: static void appendBinary(string filename, list bin, integer from, integer size);
body
{
	var file out;
	if (out = al_file_open(filename, "ab")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: can't open write file '" + (string)filename + "'";
		throw ex;
	}
	if (al_file_write(out, al_list3(bin, from, size), null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: fail to write '" + (string)filename + "'";
		throw ex;
	} else {
	}
}
end_body
member
public: static void appendBinary(string filename, string str);
body
{
	var integer size;
	var list bin;
	size = al_strlen(str);
	bin = al_misc("binary", size, null);
	al_misc("binary_copy", al_list2(bin, 0), str);
	appendBinary(filename, bin, 0, size);
}
end_body
member
public: static void writeString(string filename, string str);
body
{
	var file out;
	if (out = al_file_open(filename, "w")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: can't open write file '" + (string)filename + "'";
		throw ex;
	}
	if (al_file_write(out, "string", str)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: fail to write '" + (string)filename + "'";
		throw ex;
	} else {
	}
}
end_body
member
public: static void appendString(string filename, string str);
body
{
	var file out;
	if (out = al_file_open(filename, "a")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: can't open write file '" + (string)filename + "'";
		throw ex;
	}
	if (al_file_write(out, "string", str)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: fail to write '" + (string)filename + "'";
		throw ex;
	} else {
	}
}
end_body
member
public: static list readGraphData(string filename);
body
{
	if (al_file_manip("does_exist", filename, null)) {
	} else {
		return null;
	}
	var list data;
	var file in;
	if (in = al_file_open(filename, "r")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: can't open read file '" + (string)filename + "'";
		throw ex;
	}
	if (data = al_file_read(in, "graph")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: fail to read graph data from '" + (string)filename + "'";
		throw ex;
	}
	return data;
}
end_body
member
public: static void writeGraphData(string filename, list data);
body
{
	var file out;
	if (out = al_file_open(filename, "w")) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: can't open write file '" + (string)filename + "'";
		throw ex;
	}
	if (al_file_write(out, "graph", data)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "file: fail to write graph data '" + (string)filename + "'";
		throw ex;
	} else {
	}
}
end_body
member
public: static void remove(string dir);
body
{
	var RevFileItr itr;
	itr = new RevFileItr;
	itr.Reset(dir);
	loop {
		if (itr.Next()) {
		} else {
			break;
		}
		al_file_manip("remove", itr.abs_path, null);
	}
}
end_body
member
public: static void makeReadOnly(string dir);
body
{
	var FileItr itr;
	itr = new FileItr;
	itr.Reset(dir);
	loop {
		if (itr.Next()) {
		} else {
			break;
		}
		al_file_manip("set_readonly", itr.abs_path, null);
	}
}
end_body
member
public: static void makeWritable(string dir);
body
{
	var FileItr itr;
	itr = new FileItr;
	itr.Reset(dir);
	loop {
		if (itr.Next()) {
		} else {
			break;
		}
		al_file_manip("set_readonly", itr.abs_path, 1);
	}
}
end_body
member
public: static void makeWritable();
body
{
	var list dir_name;
	var string dir;
	if (dir_name = al_get_read_filename("All Files (*.*)|*.*||", null)) {
	} else {
		return;
	}
	dir = dir_name.head;
	makeWritable(dir);
	al_print("end\n");
}
end_body
class FileItr
member
public: void Reset(string root);
body
{
	if (al_file_manip("does_exist", root, null) && al_file_manip("is_dir", root, null)) {
	} else {
		return;
	}
	var list node, itr;
	node = al_file_manip("find_file", root, null);
	itr = al_dst_itr(node);
	stack = al_cons(al_list2("", itr), stack);
	this.root = root;
	abs_path = null;
}
end_body
member
public: list Next();
body
{
	if (stack) {
	} else {
		return null;
	}
	var list itr, node;
	if (abs_path) {
	} else {
		path = "";
		name = "";
		abs_path = root;
		is_dir = al_file_manip("is_dir", abs_path, null);
		return abs_path;
	}
	path = stack.head.head;
	itr = stack.head.tail.head;
	if (is_dir && name != "") {
		node = al_file_manip("find_file", abs_path, null);
		itr = al_dst_itr(node);
		if (path == "") {
			path = name;
		} else {
			path = path + "/" + name;
		}
		stack = al_cons(al_list2(path, itr), stack);
	} else {
	}
	loop {
		if (name = al_next(itr)) {
		} else {
			stack = stack.tail;
			if (stack) {
			} else {
				return null;
			}
			path = stack.head.head;
			itr = stack.head.tail.head;
			continue;
		}
		if (name == "." || name == "..") {
			continue;
		} else {
		}
		if (path == "") {
			abs_path = root + "/" + name;
		} else {
			abs_path = root + "/" + path + "/" + name;
		}
		is_dir = al_file_manip("is_dir", abs_path, null);
		return abs_path;
	}
}
end_body
member
public: list stack;
member
public: string root;
member
public: string path;
member
public: string name;
member
public: string abs_path;
member
public: list is_dir;
end_class
class RevFileItr
member
public: void Reset(string root);
body
{
	if (al_file_manip("does_exist", root, null) && al_file_manip("is_dir", root, null)) {
	} else {
		return;
	}
	var list node, itr;
	node = al_file_manip("find_file", root, null);
	itr = al_dst_itr(node);
	stack = al_cons(al_list2("", itr), stack);
	this.root = root;
	abs_path = null;
}
end_body
member
public: list Next();
body
{
	if (is_dir) {
		stack = stack.tail;
	} else {
	}
	if (stack) {
	} else {
		return null;
	}
	var list itr, node;
	path = stack.head.head;
	itr = stack.head.tail.head;
	loop {
		if (name = al_next(itr)) {
		} else {
			path = stack.head.head;
			if (path == "") {
				abs_path = root;
			} else {
				abs_path = root + "/" + path;
			}
			is_dir = 1;
			return abs_path;
		}
		if (name == "." || name == "..") {
			continue;
		} else {
		}
		if (path == "") {
			abs_path = root + "/" + name;
		} else {
			abs_path = root + "/" + path + "/" + name;
		}
		is_dir = al_file_manip("is_dir", abs_path, null);
		if (is_dir) {
			node = al_file_manip("find_file", abs_path, null);
			itr = al_dst_itr(node);
			if (path == "") {
				path = name;
			} else {
				path = path + "/" + name;
			}
			stack = al_cons(al_list2(path, itr), stack);
		} else {
			return abs_path;
		}
	}
}
end_body
member
public: list stack;
member
public: string root;
member
public: string path;
member
public: string name;
member
public: string abs_path;
member
public: list is_dir;
end_class
end_class
class Context
member
public: string getPartnerRole(string target, string partner_id, string msg_type, DbConnection conn);
body
{
	if (pi_obj) {
	} else {
		getPartnerInfo(target, partner_id, msg_type, conn);
	}
	if (pi_role = pi_obj.getField("PartnerInfo/PartnerRole")) {
	} else {
		pi_role = "default";
	}
	return pi_role;
}
end_body
member
public: string getPartnerProperty(string target, string partner_id, string partner_role, string name, DbConnection conn);
body
{
	if (partner_role) {
	} else {
		partner_role = "default";
	}
	if (pi_acc && pi_role == partner_role) {
	} else {
		getPartnerInfoFromRole(target, partner_id, partner_role, conn);
		pi_role = partner_role;
	}
	var list ls, itr;
	var XmlDbObject obj;
	var string val;
	ls = pi_obj.getChildren("PartnerInfo/Properties", "Name", name);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
		if (val = obj.getField("Value")) {
			return val;
		} else {
			return "";
		}
	} else {
	}
	ls = pi_d_obj.getChildren("PartnerInfo/Properties", "Name", name);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
		if (val = obj.getField("Value")) {
			return val;
		} else {
			return "";
		}
	} else {
	}
	return null;
}
end_body
member
public: list getPartnerProperties(string target, string partner_id, string partner_role, DbConnection conn);
body
{
	if (partner_role) {
	} else {
		partner_role = "default";
	}
	if (pi_obj && pi_role == partner_role) {
	} else {
		getPartnerInfoFromRole(target, partner_id, partner_role, conn);
		pi_role = partner_role;
	}
	var list ls, itr, props, d_props;
	var XmlDbObject obj;
	var string name, val;
	ls = pi_obj.getChildren("PartnerInfo/Properties");
	itr = al_dst_itr(ls);
	props = al_cons(null, null);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		name = obj.getField("Name");
		if (val = obj.getField("Value")) {
		} else {
			val = "";
		}
		al_create_arc(props, val, name);
	}
	ls = pi_d_obj.getChildren("PartnerInfo/Properties");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		name = obj.getField("Name");
		if (al_dst_node(props, name)) {
			continue;
		} else {
		}
		if (val = obj.getField("Value")) {
		} else {
			val = "";
		}
		al_create_arc(props, val, name);
	}
	return props;
}
end_body
member
public: void putPartnerProperty(string target, string partner_id, string partner_role, string name, string value, DbConnection conn);
body
{
	if (partner_role) {
	} else {
		partner_role = "default";
	}
	if (pi_acc && pi_role == partner_role) {
	} else {
		getPartnerInfoFromRole(target, partner_id, partner_role, conn);
		pi_role = partner_role;
	}
	var list ls, itr;
	var XmlDbObject obj;
	ls = pi_obj.getChildren("PartnerInfo/Properties", "Name", name);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
		obj.putField("Value", value);
	} else {
		obj = pi_obj.createChild("PartnerInfo/Properties");
		obj.putField("Name", name);
		obj.putField("Value", value);
	}
}
end_body
member
public: void putPartnerProperties(string target, string partner_id, string partner_role, list props, DbConnection conn);
body
{
	if (partner_role) {
	} else {
		partner_role = "default";
	}
	if (pi_obj && pi_role == partner_role) {
	} else {
		getPartnerInfoFromRole(target, partner_id, partner_role, conn);
		pi_role = partner_role;
	}
	var list p_itr, ls, itr;
	var XmlDbObject obj;
	var string name, val;
	p_itr = al_dst_itr(props);
	loop {
		if (val = al_next(p_itr)) {
		} else {
			break;
		}
		name = al_arc_a(p_itr);
		ls = pi_obj.getChildren("PartnerInfo/Properties", "Name", name);
		itr = al_dst_itr(ls);
		if (obj = al_next(itr)) {
			obj.putField("Value", val);
		} else {
			obj = pi_obj.createChild("PartnerInfo/Properties");
			obj.putField("Name", name);
			obj.putField("Value", val);
		}
	}
}
end_body
member
public: string getMyRole(string target, string partner_id, string msg_type, DbConnection conn);
body
{
	if (pi_obj) {
	} else {
		getPartnerInfo(target, partner_id, msg_type, conn);
	}
	if (mi_role = pi_obj.getField("PartnerInfo/MyRole")) {
	} else {
		mi_role = "default";
	}
	if (mi_obj) {
	} else {
		getMyInfoFromRole(target, mi_role, conn);
	}
	return mi_role;
}
end_body
member
public: string getMyProperty(string target, string my_role, string name, DbConnection conn);
body
{
	if (my_role) {
	} else {
		my_role = "default";
	}
	if (mi_acc && mi_role == my_role) {
	} else {
		getMyInfoFromRole(target, my_role, conn);
		mi_role = my_role;
	}
	var list ls, itr;
	var XmlDbObject obj;
	var string val;
	ls = mi_obj.getChildren("MyInfo/Properties", "Name", name);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
		if (val = obj.getField("Value")) {
			return val;
		} else {
			return "";
		}
	} else {
	}
	ls = mi_d_obj.getChildren("MyInfo/Properties", "Name", name);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
		if (val = obj.getField("Value")) {
			return val;
		} else {
			return "";
		}
	} else {
	}
	return null;
}
end_body
member
public: list getMyProperties(string target, string my_role, DbConnection conn);
body
{
	if (my_role) {
	} else {
		my_role = "default";
	}
	if (mi_obj && mi_role == my_role) {
	} else {
		getMyInfoFromRole(target, my_role, conn);
		mi_role = my_role;
	}
	var list ls, itr, props, d_props;
	var XmlDbObject obj;
	var string name, val;
	ls = mi_obj.getChildren("MyInfo/Properties");
	itr = al_dst_itr(ls);
	props = al_cons(null, null);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		name = obj.getField("Name");
		if (val = obj.getField("Value")) {
		} else {
			val = "";
		}
		al_create_arc(props, val, name);
	}
	ls = mi_d_obj.getChildren("MyInfo/Properties");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		name = obj.getField("Name");
		if (al_dst_node(props, name)) {
			continue;
		} else {
		}
		if (val = obj.getField("Value")) {
		} else {
			val = "";
		}
		al_create_arc(props, val, name);
	}
	return props;
}
end_body
member
public: void putMyProperty(string target, string my_role, string name, string value, DbConnection conn);
body
{
	if (my_role) {
	} else {
		my_role = "default";
	}
	if (mi_acc && mi_role == my_role) {
	} else {
		getMyInfoFromRole(target, my_role, conn);
		mi_role = my_role;
	}
	var list ls, itr;
	var XmlDbObject obj;
	ls = mi_obj.getChildren("MyInfo/Properties", "Name", name);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
		obj.putField("Value", value);
	} else {
		obj = mi_obj.createChild("MyInfo/Properties");
		obj.putField("Name", name);
		obj.putField("Value", value);
	}
}
end_body
member
public: void putMyProperties(string target, string my_role, list props, DbConnection conn);
body
{
	if (my_role) {
	} else {
		my_role = "default";
	}
	if (mi_obj && mi_role == my_role) {
	} else {
		getMyInfoFromRole(target, my_role, conn);
		mi_role = my_role;
	}
	var list p_itr, ls, itr;
	var XmlDbObject obj;
	var string name, val;
	p_itr = al_dst_itr(props);
	loop {
		if (val = al_next(p_itr)) {
		} else {
			break;
		}
		name = al_arc_a(p_itr);
		ls = mi_obj.getChildren("MyInfo/Properties", "Name", name);
		itr = al_dst_itr(ls);
		if (obj = al_next(itr)) {
			obj.putField("Value", val);
		} else {
			obj = mi_obj.createChild("MyInfo/Properties");
			obj.putField("Name", name);
			obj.putField("Value", val);
		}
	}
}
end_body
member
public: void getPartnerInfo(string target, string partner_id, string msg_type, DbConnection conn);
body
{
	var list cond, ls, itr;
	pi_acc = new XmlDbAccessor;
	pi_acc.create("PartnerInfo", "", conn);
	pi_acc.setDTDfilename("PartnerInfo.dtd");
	cond = al_cons(null, null);
	al_create_arc(cond, target, "PartnerInfo/Target");
	al_create_arc(cond, partner_id, "PartnerInfo/BusinessId");
	al_create_arc(cond, msg_type, "PartnerInfo/MsgType");
	ls = pi_acc.get(cond);
	itr = al_dst_itr(ls);
	if (pi_obj = al_next(itr)) {
	} else {
		cond = al_cons(null, null);
		al_create_arc(cond, target, "PartnerInfo/Target");
		al_create_arc(cond, partner_id, "PartnerInfo/BusinessId");
		al_create_arc(cond, "*", "PartnerInfo/MsgType");
		ls = pi_acc.get(cond);
		itr = al_dst_itr(ls);
		if (pi_obj = al_next(itr)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "PartnerInfo not found: Target = " + (string)target + ", PartnerId = " + (string)partner_id + ", MsgType = " + (string)msg_type;
			throw ex;
		}
	}
	cond = al_cons(null, null);
	al_create_arc(cond, target, "PartnerInfo/Target");
	al_create_arc(cond, "-- default setting --", "PartnerInfo/PartnerRole");
	ls = pi_acc.get(cond);
	itr = al_dst_itr(ls);
	if (pi_d_obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "PartnerInfo -- default setting -- not found: Target = " + (string)target;
		throw ex;
	}
}
end_body
member
public: void getPartnerInfoFromRole(string target, string partner_id, string partner_role, DbConnection conn);
body
{
	var list cond, ls, itr;
	pi_acc = new XmlDbAccessor;
	pi_acc.create("PartnerInfo", "", conn);
	pi_acc.setDTDfilename("PartnerInfo.dtd");
	cond = al_cons(null, null);
	al_create_arc(cond, target, "PartnerInfo/Target");
	al_create_arc(cond, partner_id, "PartnerInfo/BusinessId");
	al_create_arc(cond, partner_role, "PartnerInfo/PartnerRole");
	ls = pi_acc.get(cond);
	itr = al_dst_itr(ls);
	if (pi_obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "PartnerInfo not found: Target = " + (string)target + ", PartnerId = " + (string)partner_id + ", PartnerRole = " + (string)partner_role;
		throw ex;
	}
	cond = al_cons(null, null);
	al_create_arc(cond, target, "PartnerInfo/Target");
	al_create_arc(cond, "-- default setting --", "PartnerInfo/PartnerRole");
	ls = pi_acc.get(cond);
	itr = al_dst_itr(ls);
	if (pi_d_obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "PartnerInfo -- default setting -- not found: Target = " + (string)target;
		throw ex;
	}
}
end_body
member
public: void getMyInfoFromRole(string target, string my_role, DbConnection conn);
body
{
	var list cond, ls, itr;
	mi_acc = new XmlDbAccessor;
	mi_acc.create("MyInfo", "", conn);
	mi_acc.setDTDfilename("MyInfo.dtd");
	cond = al_cons(null, null);
	al_create_arc(cond, target, "MyInfo/Target");
	al_create_arc(cond, my_role, "MyInfo/MyRole");
	ls = mi_acc.get(cond);
	itr = al_dst_itr(ls);
	if (mi_obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MyInfo not found: Target = " + (string)target + ", MyRole = " + (string)my_role;
		throw ex;
	}
	my_id = mi_obj.getField("MyInfo/BusinessId");
	cond = al_cons(null, null);
	al_create_arc(cond, target, "MyInfo/Target");
	al_create_arc(cond, "-- default setting --", "MyInfo/MyRole");
	ls = mi_acc.get(cond);
	itr = al_dst_itr(ls);
	if (mi_d_obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MyInfo -- default setting -- not found: Target = " + (string)target;
		throw ex;
	}
}
end_body
member
public: list getMyPropertiesFromId(string target, string my_id, DbConnection conn);
body
{
	getMyInfoFromId(target, my_id, conn);
	var list ls, itr, props, d_props;
	var XmlDbObject obj;
	var string name, val;
	ls = mi_obj.getChildren("MyInfo/Properties");
	itr = al_dst_itr(ls);
	props = al_cons(null, null);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		name = obj.getField("Name");
		val = obj.getField("Value");
		al_create_arc(props, val, name);
	}
	ls = mi_d_obj.getChildren("MyInfo/Properties");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		name = obj.getField("Name");
		if (al_dst_node(props, name)) {
			continue;
		} else {
		}
		val = obj.getField("Value");
		al_create_arc(props, val, name);
	}
	return props;
}
end_body
member
public: void getMyInfoFromId(string target, string my_id, DbConnection conn);
body
{
	var list cond, ls, itr;
	mi_acc = new XmlDbAccessor;
	mi_acc.create("MyInfo", "", conn);
	mi_acc.setDTDfilename("MyInfo.dtd");
	cond = al_cons(null, null);
	al_create_arc(cond, target, "MyInfo/Target");
	al_create_arc(cond, my_id, "MyInfo/BusinessId");
	ls = mi_acc.get(cond);
	itr = al_dst_itr(ls);
	if (mi_obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MyInfo not found: Target = " + (string)target + ", MyId = " + (string)my_id;
		throw ex;
	}
	this.my_id = my_id;
	mi_role = mi_obj.getField("MyInfo/MyRole");
	cond = al_cons(null, null);
	al_create_arc(cond, target, "MyInfo/Target");
	al_create_arc(cond, "-- default setting --", "MyInfo/MyRole");
	ls = mi_acc.get(cond);
	itr = al_dst_itr(ls);
	if (mi_d_obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MyInfo -- default setting -- not found: Target = " + (string)target;
		throw ex;
	}
}
end_body
member
public: XmlDbAccessor pi_acc;
member
public: XmlDbObject pi_obj;
member
public: XmlDbObject pi_d_obj;
member
public: string pi_role;
member
public: string mi_role;
member
public: XmlDbAccessor mi_acc;
member
public: XmlDbObject mi_obj;
member
public: XmlDbObject mi_d_obj;
member
public: string my_id;
member
public: static string genTimeStamp();
body
{
	return genTimeStamp(0);
}
end_body
member
public: static string genTimeStamp(integer diff);
body
{
	var list time;
	time = al_misc("get_time", null, null);
	time = time + diff;
	time = al_misc("get_localtime", time, null);
	time = al_misc("format_time", time, "yyyyMMdd'-'HHmmss");
	return time;
}
end_body
member
public: static string genTimeStamp2();
body
{
	var list time;
	time = al_misc("get_time", null, null);
	time = al_misc("get_localtime", time, null);
	time = al_misc("format_time", time, "yyyy'/'MM'/'dd'-'HH':'mm':'ss");
	return time;
}
end_body
member
public: static string genMsgId();
body
{
	var list time;
	time = genTimeStamp();
	al_misc("para_lock", 1, null);
	if (msg_seq) {
		msg_seq = msg_seq + 1;
	} else {
		msg_seq = 1;
	}
	al_misc("para_lock", null, null);
	return time + "-" + (string)msg_seq;
}
end_body
member
public: static integer msg_seq;
member
public: XmlDbObject getPartnerInfoXmlDbObject(string target, string partner_id, string partner_role, DbConnection conn);
body
{
	var list ls, itr;
	pi_acc = new XmlDbAccessor;
	pi_acc.create("PartnerInfo", "", conn);
	pi_acc.setDTDfilename("PartnerInfo.dtd");
	ls = pi_acc.get("PartnerInfo/Target", target, "PartnerInfo/BusinessId", partner_id, "PartnerInfo/PartnerRole", partner_role);
	itr = al_dst_itr(ls);
	if (pi_obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "PartnerInfo not found: target = " + (string)target + ", partner id = " + (string)partner_id + ", partner role = " + (string)partner_role;
		throw ex;
	}
	return pi_obj;
}
end_body
member
public: XmlDbObject getMyInfoXmlDbObject(string target, string my_role, DbConnection conn);
body
{
	var list ls, itr;
	mi_acc = new XmlDbAccessor;
	mi_acc.create("MyInfo", "", conn);
	mi_acc.setDTDfilename("MyInfo.dtd");
	ls = mi_acc.get("MyInfo/Target", target, "MyInfo/MyRole", my_role);
	itr = al_dst_itr(ls);
	if (mi_obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "MyInfo not found: target = " + (string)target + ", my role = " + (string)my_role;
		throw ex;
	}
	return mi_obj;
}
end_body
class RNContext
member
public: string getPartnerRole(string partner_id, string msg_type, DbConnection conn);
body
{
	return getPartnerRole("rosetta", partner_id, msg_type, conn);
}
end_body
member
public: string getMyRole(string partner_id, string msg_type, DbConnection conn);
body
{
	return getMyRole("rosetta", partner_id, msg_type, conn);
}
end_body
member
public: string getPartnerProperty(string partner_id, string partner_role, string name, DbConnection conn);
body
{
	return getPartnerProperty("rosetta", partner_id, partner_role, name, conn);
}
end_body
member
public: list getPartnerProperties(string partner_id, string partner_role, DbConnection conn);
body
{
	return getPartnerProperties("rosetta", partner_id, partner_role, conn);
}
end_body
member
public: void putPartnerProperty(string partner_id, string partner_role, string name, string value, DbConnection conn);
body
{
	putPartnerProperty("rosetta", partner_id, partner_role, name, value, conn);
}
end_body
member
public: void putPartnerProperties(string partner_id, string partner_role, list props, DbConnection conn);
body
{
	putPartnerProperties("rosetta", partner_id, partner_role, props, conn);
}
end_body
member
public: string getMyProperty(string my_role, string name, DbConnection conn);
body
{
	return getMyProperty("rosetta", my_role, name, conn);
}
end_body
member
public: list getMyProperties(string my_role, DbConnection conn);
body
{
	return getMyProperties("rosetta", my_role, conn);
}
end_body
member
public: void putMyProperty(string my_role, string name, string value, DbConnection conn);
body
{
	putMyProperty("rosetta", my_role, name, value, conn);
}
end_body
member
public: void putMyProperties(string my_role, list props, DbConnection conn);
body
{
	putMyProperties("rosetta", my_role, props, conn);
}
end_body
member
public: list getPipPropertiesFromMessageCode(string msg_code, string msg_version, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr, cond, ret;
	var string path, value;
	acc = new XmlDbAccessor;
	acc.create("PipInfo", "", conn);
	acc.setDTDfilename("rosetta/PipInfo.dtd");
	ls = acc.get("PipInfo/Target", "rosetta", "PipInfo/Id", "message type");
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "PipInfo not found.";
		throw ex;
	}
	cond = al_cons(null, null);
	al_create_arc(cond, msg_code, "MessageCode");
	al_create_arc(cond, msg_version, "MessageVersion");
	ls = obj.getChildren("PipInfo/Message", cond);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "PipInfo not found: MessageCode = " + (string)msg_code + ", MessageVersion = " + (string)msg_version;
		throw ex;
	}
	itr = al_dst_itr(obj.xpath_list);
	ret = al_cons(null, null);
	loop {
		if (path = al_next(itr)) {
		} else {
			break;
		}
		value = obj.getField(path);
		al_create_arc(ret, value, path);
	}
	return ret;
}
end_body
member
public: list getPipProperties(string msg_type, string msg_version, DbConnection conn);
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr, cond, ret;
	var string path, value;
	acc = new XmlDbAccessor;
	acc.create("PipInfo", "", conn);
	acc.setDTDfilename("rosetta/PipInfo.dtd");
	ls = acc.get("PipInfo/Target", "rosetta", "PipInfo/Id", "message type");
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "PipInfo not found.";
		throw ex;
	}
	cond = al_cons(null, null);
	al_create_arc(cond, msg_type, "MsgType");
	al_create_arc(cond, msg_version, "MessageVersion");
	ls = obj.getChildren("PipInfo/Message", cond);
	itr = al_dst_itr(ls);
	if (obj = al_next(itr)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "PipInfo not found: MsgType = " + (string)msg_type + ", MessageVersion = " + (string)msg_version;
		throw ex;
	}
	itr = al_dst_itr(obj.xpath_list);
	ret = al_cons(null, null);
	loop {
		if (path = al_next(itr)) {
		} else {
			break;
		}
		value = obj.getField(path);
		al_create_arc(ret, value, path);
	}
	return ret;
}
end_body
member
public: list getMyPropertiesFromId(string my_id, DbConnection conn);
body
{
	return getMyPropertiesFromId("rosetta", my_id, conn);
}
end_body
member
public: void getMyInfoFromId(string my_id, DbConnection conn);
body
{
	getMyInfoFromId("rosetta", my_id, conn);
}
end_body
member
public: static string currentDateTime();
body
{
	var list time;
	time = al_misc("get_time", null, null);
	time = al_misc("get_gmtime", time, null);
	time = al_misc("format_time", time, "yyyyMMdd'T'HHmmss'.000Z'");
	return time;
}
end_body
member
public: static string currentDateStamp();
body
{
	var list time;
	time = al_misc("get_time", null, null);
	time = al_misc("get_gmtime", time, null);
	time = al_misc("format_time", time, "yyyyMMdd'Z'");
	return time;
}
end_body
member
public: static string genDocId();
body
{
	var list time;
	time = al_misc("get_time", null, null);
	time = al_misc("get_localtime", time, null);
	time = al_misc("format_time", time, "'DOCID'yyyyMMddHHmmss'SEQ'");
	al_misc("para_lock", 1, null);
	if (doc_id_seq) {
		doc_id_seq = doc_id_seq + 1;
	} else {
		doc_id_seq = 1;
	}
	al_misc("para_lock", null, null);
	return time + (string)doc_id_seq;
}
end_body
member
public: static integer doc_id_seq;
member
public: static string genTrackingId();
body
{
	var list time;
	time = al_misc("get_time", null, null);
	time = al_misc("get_localtime", time, null);
	time = al_misc("format_time", time, "'TRCKID'yyyyMMddHHmmss'SEQ'");
	al_misc("para_lock", 1, null);
	if (tracking_id_seq) {
		tracking_id_seq = tracking_id_seq + 1;
	} else {
		tracking_id_seq = 1;
	}
	al_misc("para_lock", null, null);
	return time + (string)tracking_id_seq;
}
end_body
member
public: static integer tracking_id_seq;
member
public: static string genProcessId();
body
{
	var list time;
	time = al_misc("get_time", null, null);
	time = al_misc("get_localtime", time, null);
	time = al_misc("format_time", time, "'PROCID'yyyyMMddHHmmss'SEQ'");
	al_misc("para_lock", 1, null);
	if (process_id_seq) {
		process_id_seq = process_id_seq + 1;
	} else {
		process_id_seq = 1;
	}
	al_misc("para_lock", null, null);
	return time + (string)process_id_seq;
}
end_body
member
public: static integer process_id_seq;
member
public: XmlDbObject getPartnerInfoXmlDbObject(string partner_id, string partner_role, DbConnection conn);
body
{
	return getPartnerInfoXmlDbObject("rosetta", partner_id, partner_role, conn);
}
end_body
member
public: XmlDbObject getMyInfoXmlDbObject(string my_role, DbConnection conn);
body
{
	return getMyInfoXmlDbObject("rosetta", my_role, conn);
}
end_body
end_class
end_class
class DataMgr
member
public: static void addAttachment(string attach_dir, string msgId, list attachment, integer size, list props);
body
{
	var list attach_info, itr, info;
	var integer count;
	var string filename;
	if (attach_info = getAttachmentInfos(attach_dir, msgId)) {
	} else {
		attach_info = al_cons(null, null);
	}
	itr = al_dst_itr(attach_info);
	count = al_count(itr);
	filename = attach_dir + "/" + msgId + "-attach-" + (string)count + ".dat";
	FileUtility::writeBinary(filename, attachment, 0, size);
	al_create_arc(attach_info, info = al_copy(props), count);
	al_create_arc(info, filename, "$filename");
	updateAttachmentInfos(attach_dir, msgId, attach_info);
}
end_body
member
public: static list getAttachmentInfos(string attach_dir, string msgId);
body
{
	return FileUtility::readGraphData(attach_dir + "/" + msgId + "-attach-info.dat");
}
end_body
member
public: static void updateAttachmentInfos(string attach_dir, string msgId, list attach_info);
body
{
	FileUtility::writeGraphData(attach_dir + "/" + msgId + "-attach-info.dat", attach_info);
}
end_body
member
public: list start_backup_job(string target, string user, string op, string from, string to, list targets, string wwwroot, string restoreFile);
body
{
	var list job;
	if (jobs) {
		var list itr;
		var string status;
		itr = al_dst_itr(jobs);
		loop {
			if (job = al_next(itr)) {
			} else {
				break;
			}
			status = al_dst_node(job, "status");
			if (status == "processing") {
				return "backup job exists. multiple backup jobs can not be executed simultaniously.";
			} else {
			}
		}
	} else {
	}
	job = al_cons(null, null);
	al_create_arc(job, user, "user");
	al_create_arc(job, op, "op");
	al_create_arc(job, from, "from");
	al_create_arc(job, to, "to");
	al_create_arc(job, targets, "targets");
	al_create_arc(job, "processing", "status");
	al_create_arc(job, wwwroot, "wwwroot");
	al_create_arc(job, restoreFile, "restoreFile");
	var string cmd, cmd_file;
	var file out;
	if (cmd_file = FileUtility::tempFile()) {
	} else {
		return "can't get temp filename";
	}
	if (out = al_file_open(cmd_file, "w")) {
	} else {
		return "can't open temp filename";
	}
	if (al_file_write(out, "graph", job)) {
		out = null;
		al_file_manip("remove", cmd_file, null);
		return "write error to command temp file";
	} else {
	}
	out = null;
	cmd = "altair -h -d . -f server.apr -c DataMgr -m start " + cmd_file;
	if (al_exec(cmd, ".", 1, null)) {
	} else {
		al_file_manip("remove", cmd_file, null);
		return "can't execute backup process";
	}
	al_create_arc(job, cmd_file, "cmd_file");
	if (jobs) {
	} else {
		jobs = al_cons(null, null);
	}
	al_create_arc(jobs, job, null);
	return null;
}
end_body
member
public: void erace_backup_jobs();
body
{
	if (jobs) {
	} else {
		return;
	}
	var list itr, job;
	var string status;
	itr = al_dst_itr(jobs);
	loop {
		if (job = al_next(itr)) {
		} else {
			break;
		}
		status = al_dst_node(job, "status");
		if (status != "processing") {
			al_remove(itr);
		} else {
		}
	}
}
end_body
member
public: list refresh_backup_jobs();
body
{
	if (jobs) {
	} else {
		return null;
	}
	var list itr, job, results;
	var string status, cmd_file, result_file, result;
	var integer idx;
	var file in;
	itr = al_dst_itr(jobs);
	loop {
		if (job = al_next(itr)) {
		} else {
			break;
		}
		status = al_dst_node(job, "status");
		idx = al_search_str(status, 0, "done");
		if (idx >= 0) {
			continue;
		} else {
		}
		cmd_file = al_dst_node(job, "cmd_file");
		if (al_file_manip("does_exist", cmd_file, null)) {
			continue;
		} else {
		}
		result_file = cmd_file + "-result";
		try {
			if (in = al_file_open(result_file, "r")) {
			} else {
				var AlException ex;
				ex = new AlException;
				ex.msg = "can't open result file.";
				throw ex;
			}
			if (results = al_file_read(in, "graph")) {
			} else {
				in = null;
				al_file_manip("remove", result_file, null);
				var AlException ex;
				ex = new AlException;
				ex.msg = "result file read error.";
				throw ex;
			}
			in = null;
			al_file_manip("remove", result_file, null);
			result = results.head;
			al_misc("waitpid", results.tail.head, null);
		} catch (AlException e) {
			al_file_manip("remove", result_file, null);
			return e.msg;
		}
		al_set_dst_node(job, "status", result);
	}
}
end_body
member
public: static list jobs;
member
public: static string pool_name;
member
public: static void start();
body
{
	var string s, cmd_file, result, result_file;
	var file f, in, out;
	var list job, err, results;
	var DataMgr mgr;
	s = al_misc("get_cmd_line", null, null);
	f = al_file_open(s, "sr");
	cmd_file = (string)al_file_read(f, "string");
	result_file = cmd_file + "-result";
	try {
		if (in = al_file_open(cmd_file, "r")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open command file";
			throw ex;
		}
		if (job = al_file_read(in, "graph")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't read command file";
			throw ex;
		}
		in = null;
		mgr = new DataMgr;
		mgr.start(job);
		result = "done(OK)";
	} catch (AlException e) {
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		result = "done(error: " + e.msg + ")";
	}
	results = al_list2(result, al_misc("getpid", null, null));
	out = al_file_open(result_file, "w");
	al_file_write(out, "graph", results);
	out = null;
	al_file_manip("remove", cmd_file, null);
	al_misc("exit", 0, null);
}
end_body
member
public: void start(list job);
body
{
	var list err;
	try {
		if (err = startDbConnectionPool()) {
			var AlException ex;
			ex = new AlException;
			ex.msg = err;
			throw ex;
		} else {
		}
		conn = DbManager::getConnection(pool_name);
		op = al_dst_node(job, "op");
		from = al_dst_node(job, "from");
		to = al_dst_node(job, "to");
		from_timestamp = toTimeStamp(from);
		to_timestamp = toTimeStamp(to);
		targets = al_dst_node(job, "targets");
		wwwroot = al_dst_node(job, "wwwroot");
		restoreFile = al_dst_node(job, "restoreFile");
		var RNContext ctx;
		ctx = new RNContext;
		my_props = ctx.getMyProperties("-- default setting --", conn);
		if (send_dir = al_dst_node(my_props, "msg.send.dir")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "msg.send.dir is empty.";
			throw ex;
		}
		if (recv_dir = al_dst_node(my_props, "msg.recv.dir")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "msg.recv.dir is empty.";
			throw ex;
		}
		if (attach_dir = al_dst_node(my_props, "msg.attach.dir")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "msg.attach.dir is empty.";
			throw ex;
		}
		if (tmp_dir = al_dst_node(my_props, "msg.tmp.dir")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "msg.tmp.dir is empty.";
			throw ex;
		}
		if (al_file_manip("does_exist", tmp_dir + "/backup", null)) {
			FileUtility::remove(tmp_dir + "/backup");
		} else {
		}
		if (op == "backup" || op == "backup&delete") {
			backup();
		} else {
		}
		if (op == "backup&delete" || op == "delete") {
			delete();
		} else {
		}
		if (op == "doRestore") {
			restore();
		} else {
		}
		conn.close();
		endDbConnectionPool();
		FileUtility::remove(tmp_dir + "/backup");
	} catch (AlException e) {
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		endDbConnectionPool();
		if (tmp_dir) {
			FileUtility::remove(tmp_dir + "/backup");
		} else {
		}
		throw e;
	}
}
end_body
member
public: list startDbConnectionPool();
body
{
	var string err;
	var XmlDataRetriver root, itr, web_server_info, proxy_server_info;
	var XmlDataRetriver db_pool_info, pe_info, xml_info;
	// ---- load configuration
	if (err = load_config()) {
		return err;
	} else {
	}
	root = new XmlDataRetriver;
	root.create(config);
	// ---- initialize log file
	system_log_filepath = root.getValue("AltairServer/SystemLog");
	system_log_db = (root.getValue("AltairServer/SystemLogDb") == "true");
	// ---- create DB connection pool
	itr = root.getItr("AltairServer/DbConnectionPool");
	loop {
		if (db_pool_info = itr.getNext()) {
		} else {
			break;
		}
		var DbConnectionPool pool;
		pool = new DbConnectionPool;
		pool.ap_server = this;
		pool_name = pool.pool_name = db_pool_info.getValue("@name");
		pool.db_type = db_pool_info.getValue("DbType");
		pool.host = db_pool_info.getValue("Host");
		pool.port = (integer)db_pool_info.getValue("Port");
		pool.db_name = db_pool_info.getValue("DbName");
		pool.user = db_pool_info.getValue("DbUser");
		pool.pass = db_pool_info.getValue("DbPassword");
		pool.initial_connections = (integer)db_pool_info.getValue("InitialCapacity");
		pool.max_connections = (integer)db_pool_info.getValue("MaxCapacity");
		err = DbManager::createPool(pool, pool.pool_name);
		if (err) {
			system_log("error", "DB Connection Pool Creation falied: pool_name = " + (string)pool.pool_name + ": " + err);
			return err;
		} else {
		}
	}
	// ---- initialize XmlUtility
	XmlUtility::Initialize();
	itr = root.getItr("AltairServer/XmlUtility");
	loop {
		if (xml_info = itr.getNext()) {
		} else {
			break;
		}
		XmlUtility::dtd_base = xml_info.getValue("DtdBase");
	}
	// ---- proxy servers
	proxy_servers = al_cons(null, null);
	itr = root.getItr("AltairServer/ProxyServer");
	loop {
		if (proxy_server_info = itr.getNext()) {
		} else {
			break;
		}
		var ProxyServer proxy_server;
		proxy_server = new ProxyServer;
		proxy_server.ap_server = this;
		proxy_server.name = proxy_server_info.getValue("@name");
		proxy_server.port = (integer)proxy_server_info.getValue("Port");
		proxy_server.proxy_log_filepath = proxy_server_info.getValue("ProxyLog");
		proxy_server.proxy_log_db = (proxy_server_info.getValue("ProxyLogDb") == "true");
		proxy_server.connectionTimeout = (integer)proxy_server_info.getValue("ConnectionTimeout");
		if (proxy_server_info.getValue("ConnectTimeout")) {
			proxy_server.connect_timeout = (integer)proxy_server_info.getValue("ConnectTimeout");
		} else {
		}
		al_create_arc(proxy_servers, proxy_server, null);
	}
	// ---- process engine
	itr = root.getItr("AltairServer/ProcessEngine");
	loop {
		if (pe_info = itr.getNext()) {
		} else {
			break;
		}
		pe = new ProcessEngine;
		pe.ap_server = this;
		pe.process_log_filepath = pe_info.getValue("ProcessLog");
		pe.process_log_db = (pe_info.getValue("ProcessLogDb") == "true");
		pe.ticker_interval = (integer)pe_info.getValue("TickerInterval");
		pe.cleanup_time = pe_info.getValue("CleanupTime");
		if (al_is_type(pe.ticker_interval, "integer") == null || pe.ticker_interval < 1000) {
			pe.ticker_interval = 1000;
		} else {
		}
		pe.max_property_cache = (integer)pe_info.getValue("MaxPropertyCache");
		pe.debug_mode = (pe_info.getValue("DebugMode") == "true");
		pe.exception_detail = (pe_info.getValue("ExceptionDetail") == "true");
	}
	// ---- web servers
	web_servers = al_cons(null, null);
	itr = root.getItr("AltairServer/WebServer");
	loop {
		if (web_server_info = itr.getNext()) {
		} else {
			break;
		}
		var WebServer web_server;
		web_server = new WebServer;
		web_server.ap_server = this;
		web_server.name = web_server_info.getValue("@name");
		web_server.port = (integer)web_server_info.getValue("Port");
		web_server.documentRoot = web_server_info.getValue("DocumentRoot");
		web_server.access_log_filepath = web_server_info.getValue("AccessLog");
		web_server.access_log_db = (web_server_info.getValue("AccessLogDb") == "true");
		web_server.connectionTimeout = (integer)web_server_info.getValue("ConnectionTimeout");
		web_server.sessionTimeout = (integer)web_server_info.getValue("SessionTimeout");
		web_server.maxMsgSize = (integer)web_server_info.getValue("MaxMessageSize");
		al_create_arc(web_servers, web_server, null);
	}
	return null;
}
end_body
member
public: void endDbConnectionPool();
body
{
	DbManager::closeAllPools();
}
end_body
member
public: string toTimeStamp(string value);
body
{
	var integer idx;
	value = al_copy(value);
	idx = 0;
	loop {
		idx = al_search_str(value, idx, ":");
		if (idx < 0) {
			break;
		} else {
			al_delete_char(value, idx);
		}
	}
	idx = 0;
	loop {
		idx = al_search_str(value, idx, "/");
		if (idx < 0) {
			break;
		} else {
			al_delete_char(value, idx);
		}
	}
	return value;
}
end_body
member
public: void backup();
body
{
	var string sql, csv_filename, value;
	var file out;
	var list ls, rs, itr, rec, data;
	var integer i, n;
	if (al_file_manip("mk_dir", tmp_dir + "/backup", null)) {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't make temp directory.";
		throw ex;
	} else {
	}
	if (al_dst_node(targets, "RawMessage")) {
		if (al_file_manip("mk_dir", tmp_dir + "/backup/send", null)) {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't make temp directory.";
			throw ex;
		} else {
		}
		if (al_file_manip("mk_dir", tmp_dir + "/backup/recv", null)) {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't make temp directory.";
			throw ex;
		} else {
		}
		if (al_file_manip("mk_dir", tmp_dir + "/backup/attach", null)) {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't make temp directory.";
			throw ex;
		} else {
		}
		var string name1, name2, prefix, filename;
		var integer size1, size2, idx;
		size1 = al_strlen(from_timestamp);
		size2 = al_strlen(to_timestamp);
		idx = 1;
		loop {
			if (idx >= size1 || idx >= size2) {
				break;
			} else {
			}
			name1 = al_substr(from_timestamp, 0, idx);
			name2 = al_substr(to_timestamp, 0, idx);
			if (name1 != name2) {
				break;
			} else {
			}
			prefix = name1;
			idx = idx + 1;
		}
		ls = al_file_manip("find_file", send_dir, prefix);
		itr = al_dst_itr(ls);
		loop {
			if (filename = al_next(itr)) {
			} else {
				break;
			}
			if (al_file_manip("is_dir", send_dir + "/" + filename, null)) {
				continue;
			} else {
			}
			if (from_timestamp <= filename && filename <= to_timestamp) {
				al_file_manip("copy", send_dir + "/" + filename, tmp_dir + "/backup/send/" + filename);
			} else {
			}
		}
		ls = al_file_manip("find_file", recv_dir, prefix);
		itr = al_dst_itr(ls);
		loop {
			if (filename = al_next(itr)) {
			} else {
				break;
			}
			if (al_file_manip("is_dir", recv_dir + "/" + filename, null)) {
				continue;
			} else {
			}
			if (from_timestamp <= filename && filename <= to_timestamp) {
				al_file_manip("copy", recv_dir + "/" + filename, tmp_dir + "/backup/recv/" + filename);
			} else {
			}
		}
		ls = al_file_manip("find_file", attach_dir, prefix);
		itr = al_dst_itr(ls);
		loop {
			if (filename = al_next(itr)) {
			} else {
				break;
			}
			if (al_file_manip("is_dir", attach_dir + "/" + filename, null)) {
				continue;
			} else {
			}
			if (from_timestamp <= filename && filename <= to_timestamp) {
				al_file_manip("copy", attach_dir + "/" + filename, tmp_dir + "/backup/attach/" + filename);
			} else {
			}
		}
	} else {
	}
	if (al_dst_node(targets, "LogFiles")) {
		var AltairServer ap_server;
		var WebServer web_server;
		var ProxyServer proxy_server;
		var ProcessEngine process_engine;
		var string datetime, dir, prefix, name, filename, to_filename;
		var list ls, itr, dir_name, itr2;
		ap_server = this;
		datetime = Context::genTimeStamp();
		if (dir_name = get_dir_name(ap_server.system_log_filepath)) {
			dir = dir_name.head;
			prefix = dir_name.tail.head + ".";
			to_filename = prefix + datetime;
			ls = al_file_manip("find_file", dir, prefix);
			itr2 = al_dst_itr(ls);
			loop {
				if (name = al_next(itr2)) {
				} else {
					break;
				}
				filename = dir + "/" + name;
				if (al_file_manip("is_dir", filename, null)) {
					continue;
				} else {
				}
				if (prefix <= name && name <= to_filename) {
					al_file_manip("copy", filename, tmp_dir + "/backup/" + name);
				} else {
				}
			}
		} else {
		}
		itr = al_dst_itr(ap_server.web_servers);
		loop {
			if (web_server = al_next(itr)) {
			} else {
				break;
			}
			if (dir_name = get_dir_name(web_server.access_log_filepath)) {
				dir = dir_name.head;
				prefix = dir_name.tail.head + ".";
				to_filename = prefix + datetime;
				ls = al_file_manip("find_file", dir, prefix);
				itr2 = al_dst_itr(ls);
				loop {
					if (name = al_next(itr2)) {
					} else {
						break;
					}
					filename = dir + "/" + name;
					if (al_file_manip("is_dir", filename, null)) {
						continue;
					} else {
					}
					if (prefix <= name && name <= to_filename) {
						al_file_manip("copy", filename, tmp_dir + "/backup/" + name);
					} else {
					}
				}
			} else {
			}
		}
		itr = al_dst_itr(ap_server.proxy_servers);
		loop {
			if (proxy_server = al_next(itr)) {
			} else {
				break;
			}
			if (dir_name = get_dir_name(proxy_server.proxy_log_filepath)) {
				dir = dir_name.head;
				prefix = dir_name.tail.head + ".";
				to_filename = prefix + datetime;
				ls = al_file_manip("find_file", dir, prefix);
				itr2 = al_dst_itr(ls);
				loop {
					if (name = al_next(itr2)) {
					} else {
						break;
					}
					filename = dir + "/" + name;
					if (al_file_manip("is_dir", filename, null)) {
						continue;
					} else {
					}
					if (prefix <= name && name <= to_filename) {
						al_file_manip("copy", filename, tmp_dir + "/backup/" + name);
					} else {
					}
				}
			} else {
			}
		}
		if (process_engine = ap_server.pe && dir_name = get_dir_name(process_engine.process_log_filepath)) {
			dir = dir_name.head;
			prefix = dir_name.tail.head + ".";
			to_filename = prefix + datetime;
			ls = al_file_manip("find_file", dir, prefix);
			itr2 = al_dst_itr(ls);
			loop {
				if (name = al_next(itr2)) {
				} else {
					break;
				}
				filename = dir + "/" + name;
				if (al_file_manip("is_dir", filename, null)) {
					continue;
				} else {
				}
				if (prefix <= name && name <= to_filename) {
					al_file_manip("copy", filename, tmp_dir + "/backup/" + name);
				} else {
				}
			}
		} else {
		}
	} else {
	}
	conn.setMaxResultSet(100);
	if (al_dst_node(targets, "Message")) {
		csv_filename = tmp_dir + "/backup/Message-ParentRelation.csv";
		if (out = al_file_open(csv_filename, "w")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open temp file.";
			throw ex;
		}
		sql = "select dataId,msgId,msgType,msgVersion,dtdFile,parentId,tagId,childSeq,fieldSeq from ParentRelation where msgId>='" + from_timestamp + "' and msgId<='" + to_timestamp + "'";
		rs = conn.executeQuery(n = 9, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				if (rs = conn.nextResultSet()) {
					itr = al_dst_itr(rs);
					continue;
				} else {
				}
				break;
			}
			data = al_cons(null, null);
			i = 1;
			loop {
				if (value = al_dst_node(rec, i)) {
				} else {
					value = "";
				}
				al_create_arc(data, value, null);
				i = i + 1;
				if (i > n) {
					break;
				} else {
				}
			}
			if (al_file_write(out, "csv", data)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "write error to temp file.";
				throw ex;
			} else {
			}
		}
		out = null;
		csv_filename = tmp_dir + "/backup/Message-MsgData.csv";
		if (out = al_file_open(csv_filename, "w")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open temp file.";
			throw ex;
		}
		sql = "select dataId,msgId,parentId,tagId,value from MsgData where msgId>='" + from_timestamp + "' and msgId<='" + to_timestamp + "'";
		rs = conn.executeQuery(n = 5, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				if (rs = conn.nextResultSet()) {
					itr = al_dst_itr(rs);
					continue;
				} else {
				}
				break;
			}
			data = al_cons(null, null);
			i = 1;
			loop {
				if (value = al_dst_node(rec, i)) {
				} else {
					value = "";
				}
				al_create_arc(data, value, null);
				i = i + 1;
				if (i > n) {
					break;
				} else {
				}
			}
			if (al_file_write(out, "csv", data)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "write error to temp file.";
				throw ex;
			} else {
			}
		}
		out = null;
	} else {
	}
	if (al_dst_node(targets, "XPathId")) {
		csv_filename = tmp_dir + "/backup/XPathId.csv";
		if (out = al_file_open(csv_filename, "w")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open temp file.";
			throw ex;
		}
		sql = "select tagId,path,msgType,msgVersion from TagPathName";
		rs = conn.executeQuery(n = 4, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				if (rs = conn.nextResultSet()) {
					itr = al_dst_itr(rs);
					continue;
				} else {
				}
				break;
			}
			data = al_cons(null, null);
			i = 1;
			loop {
				if (value = al_dst_node(rec, i)) {
				} else {
					value = "";
				}
				al_create_arc(data, value, null);
				i = i + 1;
				if (i > n) {
					break;
				} else {
				}
			}
			if (al_file_write(out, "csv", data)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "write error to temp file.";
				throw ex;
			} else {
			}
		}
		out = null;
	} else {
	}
	if (al_dst_node(targets, "SystemLog")) {
		csv_filename = tmp_dir + "/backup/SystemLog.csv";
		if (out = al_file_open(csv_filename, "w")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open temp file.";
			throw ex;
		}
		sql = "select SystemLogId,Time,LogLevel,Message from SystemLog where Time>='" + from + "' and Time<='" + to + "'";
		rs = conn.executeQuery(n = 4, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				if (rs = conn.nextResultSet()) {
					itr = al_dst_itr(rs);
					continue;
				} else {
				}
				break;
			}
			data = al_cons(null, null);
			i = 1;
			loop {
				if (value = al_dst_node(rec, i)) {
				} else {
					value = "";
				}
				al_create_arc(data, value, null);
				i = i + 1;
				if (i > n) {
					break;
				} else {
				}
			}
			if (al_file_write(out, "csv", data)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "write error to temp file.";
				throw ex;
			} else {
			}
		}
		out = null;
	} else {
	}
	if (al_dst_node(targets, "CommLog")) {
		csv_filename = tmp_dir + "/backup/CommLog.csv";
		if (out = al_file_open(csv_filename, "w")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open temp file.";
			throw ex;
		}
		sql = "select CommLogId,Target,SendRecv,LogLevel,Time,MsgType,Reason,URLfromIP,MyId,PartnerId,rawMsgId,MsgId,RefMsgId,TransactionId,Pid,AppPid from CommLog where Time>='" + from + "' and Time<='" + to + "'";
		rs = conn.executeQuery(n = 16, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				if (rs = conn.nextResultSet()) {
					itr = al_dst_itr(rs);
					continue;
				} else {
				}
				break;
			}
			data = al_cons(null, null);
			i = 1;
			loop {
				if (value = al_dst_node(rec, i)) {
				} else {
					value = "";
				}
				al_create_arc(data, value, null);
				i = i + 1;
				if (i > n) {
					break;
				} else {
				}
			}
			if (al_file_write(out, "csv", data)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "write error to temp file.";
				throw ex;
			} else {
			}
		}
		out = null;
	} else {
	}
	if (al_dst_node(targets, "AccessLog")) {
		csv_filename = tmp_dir + "/backup/AccessLog.csv";
		if (out = al_file_open(csv_filename, "w")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open temp file.";
			throw ex;
		}
		sql = "select AccessLogId,Time,FromIP,Path,ResponseCode,ResponseSize from AccessLog where Time>='" + from + "' and Time<='" + to + "'";
		rs = conn.executeQuery(n = 6, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				if (rs = conn.nextResultSet()) {
					itr = al_dst_itr(rs);
					continue;
				} else {
				}
				break;
			}
			data = al_cons(null, null);
			i = 1;
			loop {
				if (value = al_dst_node(rec, i)) {
				} else {
					value = "";
				}
				al_create_arc(data, value, null);
				i = i + 1;
				if (i > n) {
					break;
				} else {
				}
			}
			if (al_file_write(out, "csv", data)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "write error to temp file.";
				throw ex;
			} else {
			}
		}
		out = null;
	} else {
	}
	if (al_dst_node(targets, "ProxyLog")) {
		csv_filename = tmp_dir + "/backup/ProxyLog.csv";
		if (out = al_file_open(csv_filename, "w")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open temp file.";
			throw ex;
		}
		sql = "select ProxyLogId,Time,FromIP,Path,Reason from ProxyLog where Time>='" + from + "' and Time<='" + to + "'";
		rs = conn.executeQuery(n = 5, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				if (rs = conn.nextResultSet()) {
					itr = al_dst_itr(rs);
					continue;
				} else {
				}
				break;
			}
			data = al_cons(null, null);
			i = 1;
			loop {
				if (value = al_dst_node(rec, i)) {
				} else {
					value = "";
				}
				al_create_arc(data, value, null);
				i = i + 1;
				if (i > n) {
					break;
				} else {
				}
			}
			if (al_file_write(out, "csv", data)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "write error to temp file.";
				throw ex;
			} else {
			}
		}
		out = null;
	} else {
	}
	if (al_dst_node(targets, "ProcessLog")) {
		csv_filename = tmp_dir + "/backup/ProcessLog.csv";
		if (out = al_file_open(csv_filename, "w")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open temp file.";
			throw ex;
		}
		sql = "select ProcessLogId,Action,Time,ProcessDefName,ActivityName,ActivityKind,ProcessId,ActivityId,Message from ProcessLog where Time>='" + from + "' and Time<='" + to + "'";
		rs = conn.executeQuery(n = 9, sql);
		itr = al_dst_itr(rs);
		loop {
			if (rec = al_next(itr)) {
			} else {
				if (rs = conn.nextResultSet()) {
					itr = al_dst_itr(rs);
					continue;
				} else {
				}
				break;
			}
			data = al_cons(null, null);
			i = 1;
			loop {
				if (value = al_dst_node(rec, i)) {
				} else {
					value = "";
				}
				al_create_arc(data, value, null);
				i = i + 1;
				if (i > n) {
					break;
				} else {
				}
			}
			if (al_file_write(out, "csv", data)) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "write error to temp file.";
				throw ex;
			} else {
			}
		}
		out = null;
		conn.clearMaxResultSet();
	} else {
	}
	var string cmd;
	var integer exit_code;
	cmd = "tar -c -f backup.tar backup";
	if (exit_code = al_exec(cmd, tmp_dir, null, 1)) {
		if (exit_code != 0) {
			var AlException ex;
			ex = new AlException;
			ex.msg = "tar exit code is " + (string)exit_code;
			throw ex;
		} else {
		}
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't execute tar command.";
		throw ex;
	}
	cmd = "gzip -f backup.tar";
	if (exit_code = al_exec(cmd, tmp_dir, null, 1)) {
		if (exit_code != 0) {
			var AlException ex;
			ex = new AlException;
			ex.msg = "gzip exit code is " + (string)exit_code;
			throw ex;
		} else {
		}
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't execute gzip command.";
		throw ex;
	}
	al_file_manip("copy", tmp_dir + "/backup.tar.gz", wwwroot + "/admin/backup/backup.tar.gz");
	al_file_manip("remove", tmp_dir + "/backup.tar.gz", null);
}
end_body
member
public: void delete();
body
{
	var string sql;
	if (al_dst_node(targets, "RawMessage")) {
		var string name1, name2, prefix, filename;
		var integer size1, size2, idx;
		var list ls, itr;
		size1 = al_strlen(from_timestamp);
		size2 = al_strlen(to_timestamp);
		idx = 1;
		loop {
			if (idx >= size1 || idx >= size2) {
				break;
			} else {
			}
			name1 = al_substr(from_timestamp, 0, idx);
			name2 = al_substr(to_timestamp, 0, idx);
			if (name1 != name2) {
				break;
			} else {
			}
			prefix = name1;
			idx = idx + 1;
		}
		ls = al_file_manip("find_file", send_dir, prefix);
		itr = al_dst_itr(ls);
		loop {
			if (filename = al_next(itr)) {
			} else {
				break;
			}
			if (al_file_manip("is_dir", send_dir + "/" + filename, null)) {
				continue;
			} else {
			}
			if (from_timestamp <= filename && filename <= to_timestamp) {
				al_file_manip("remove", send_dir + "/" + filename, null);
			} else {
			}
		}
		ls = al_file_manip("find_file", recv_dir, prefix);
		itr = al_dst_itr(ls);
		loop {
			if (filename = al_next(itr)) {
			} else {
				break;
			}
			if (al_file_manip("is_dir", recv_dir + "/" + filename, null)) {
				continue;
			} else {
			}
			if (from_timestamp <= filename && filename <= to_timestamp) {
				al_file_manip("remove", recv_dir + "/" + filename, null);
			} else {
			}
		}
		ls = al_file_manip("find_file", attach_dir, prefix);
		itr = al_dst_itr(ls);
		loop {
			if (filename = al_next(itr)) {
			} else {
				break;
			}
			if (al_file_manip("is_dir", attach_dir + "/" + filename, null)) {
				continue;
			} else {
			}
			if (from_timestamp <= filename && filename <= to_timestamp) {
				al_file_manip("remove", attach_dir + "/" + filename, null);
			} else {
			}
		}
	} else {
	}
	if (al_dst_node(targets, "Message")) {
		sql = "delete from ParentRelation where msgId>='" + from_timestamp + "' and msgId<='" + to_timestamp + "'";
		conn.executeUpdate(sql);
		sql = "delete from MsgData where msgId>='" + from_timestamp + "' and msgId<='" + to_timestamp + "'";
		conn.executeUpdate(sql);
	} else {
	}
	if (al_dst_node(targets, "SystemLog")) {
		sql = "delete from SystemLog where Time>='" + from + "' and Time<='" + to + "'";
		conn.executeUpdate(sql);
	} else {
	}
	if (al_dst_node(targets, "CommLog")) {
		sql = "delete from CommLog where Time>='" + from + "' and Time<='" + to + "'";
		conn.executeUpdate(sql);
	} else {
	}
	if (al_dst_node(targets, "AccessLog")) {
		sql = "delete from AccessLog where Time>='" + from + "' and Time<='" + to + "'";
		conn.executeUpdate(sql);
	} else {
	}
	if (al_dst_node(targets, "ProxyLog")) {
		sql = "delete from ProxyLog where Time>='" + from + "' and Time<='" + to + "'";
		conn.executeUpdate(sql);
	} else {
	}
	if (al_dst_node(targets, "ProcessLog")) {
		sql = "delete from ProcessLog where Time>='" + from + "' and Time<='" + to + "'";
		conn.executeUpdate(sql);
	} else {
	}
	conn.commit();
	if (al_dst_node(targets, "LogFiles")) {
		var AltairServer ap_server;
		var WebServer web_server;
		var ProxyServer proxy_server;
		var ProcessEngine process_engine;
		var string datetime, dir, prefix, name, filename, to_filename;
		var list ls, itr, dir_name, itr2;
		ap_server = this;
		datetime = Context::genTimeStamp();
		if (dir_name = get_dir_name(ap_server.system_log_filepath)) {
			dir = dir_name.head;
			prefix = dir_name.tail.head + ".";
			to_filename = prefix + datetime;
			ls = al_file_manip("find_file", dir, prefix);
			itr2 = al_dst_itr(ls);
			loop {
				if (name = al_next(itr2)) {
				} else {
					break;
				}
				filename = dir + "/" + name;
				if (al_file_manip("is_dir", filename, null)) {
					continue;
				} else {
				}
				if (prefix <= name && name <= to_filename) {
					al_file_manip("remove", filename, null);
				} else {
				}
			}
		} else {
		}
		itr = al_dst_itr(ap_server.web_servers);
		loop {
			if (web_server = al_next(itr)) {
			} else {
				break;
			}
			if (dir_name = get_dir_name(web_server.access_log_filepath)) {
				dir = dir_name.head;
				prefix = dir_name.tail.head + ".";
				to_filename = prefix + datetime;
				ls = al_file_manip("find_file", dir, prefix);
				itr2 = al_dst_itr(ls);
				loop {
					if (name = al_next(itr2)) {
					} else {
						break;
					}
					filename = dir + "/" + name;
					if (al_file_manip("is_dir", filename, null)) {
						continue;
					} else {
					}
					if (prefix <= name && name <= to_filename) {
						al_file_manip("remove", filename, null);
					} else {
					}
				}
			} else {
			}
		}
		itr = al_dst_itr(ap_server.proxy_servers);
		loop {
			if (proxy_server = al_next(itr)) {
			} else {
				break;
			}
			if (dir_name = get_dir_name(proxy_server.proxy_log_filepath)) {
				dir = dir_name.head;
				prefix = dir_name.tail.head + ".";
				to_filename = prefix + datetime;
				ls = al_file_manip("find_file", dir, prefix);
				itr2 = al_dst_itr(ls);
				loop {
					if (name = al_next(itr2)) {
					} else {
						break;
					}
					filename = dir + "/" + name;
					if (al_file_manip("is_dir", filename, null)) {
						continue;
					} else {
					}
					if (prefix <= name && name <= to_filename) {
						al_file_manip("remove", filename, null);
					} else {
					}
				}
			} else {
			}
		}
		if (process_engine = ap_server.pe && dir_name = get_dir_name(process_engine.process_log_filepath)) {
			dir = dir_name.head;
			prefix = dir_name.tail.head + ".";
			to_filename = prefix + datetime;
			ls = al_file_manip("find_file", dir, prefix);
			itr2 = al_dst_itr(ls);
			loop {
				if (name = al_next(itr2)) {
				} else {
					break;
				}
				filename = dir + "/" + name;
				if (al_file_manip("is_dir", filename, null)) {
					continue;
				} else {
				}
				if (prefix <= name && name <= to_filename) {
					al_file_manip("remove", filename, null);
				} else {
				}
			}
		} else {
		}
	} else {
	}
}
end_body
member
public: list get_dir_name(string filename);
body
{
	if (filename) {
	} else {
		return null;
	}
	var string dir, name, n;
	var list ls, itr;
	ls = al_str_misc("split", filename, '/');
	itr = al_dst_itr(ls);
	if (name = al_prev(itr)) {
	} else {
		return null;
	}
	loop {
		if (n = al_prev(itr)) {
		} else {
			break;
		}
		if (dir) {
			dir = n + "/" + dir;
		} else {
			dir = n;
		}
	}
	if (dir) {
		return al_list2(dir, name);
	} else {
		return null;
	}
}
end_body
member
public: void restore();
body
{
	try {
		var string cmd;
		var integer exit_code;
		MultipartSecureMessage::getBody(restoreFile, "restoreFile", tmp_dir + "/backup.tar.gz");
		cmd = "gzip -d -f backup.tar.gz";
		if (exit_code = al_exec(cmd, tmp_dir, null, 1)) {
			if (exit_code != 0) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "'gzip -d' exit code is " + (string)exit_code;
				throw ex;
			} else {
			}
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't execute 'gzip -d' command.";
			throw ex;
		}
		cmd = "tar -x -f backup.tar";
		if (exit_code = al_exec(cmd, tmp_dir, null, 1)) {
			if (exit_code != 0) {
				var AlException ex;
				ex = new AlException;
				ex.msg = "tar exit code is " + (string)exit_code;
				throw ex;
			} else {
			}
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't execute tar command.";
			throw ex;
		}
	} catch (AlException e) {
		al_file_manip("remove", restoreFile, null);
		if (al_file_manip("does_exist", tmp_dir + "/backup.tar.gz", null)) {
			al_file_manip("remove", tmp_dir + "/backup.tar.gz", null);
		} else {
		}
		if (al_file_manip("does_exist", tmp_dir + "/backup.tar", null)) {
			al_file_manip("remove", tmp_dir + "/backup.tar", null);
		} else {
		}
		FileUtility::remove(tmp_dir + "/backup");
		throw e;
	}
	al_file_manip("remove", restoreFile, null);
	al_file_manip("remove", tmp_dir + "/backup.tar", null);
	var list ls, itr, data;
	var string filename, sql, value;
	var file in;
	if (al_file_manip("does_exist", tmp_dir + "/backup/send", null)) {
		ls = al_file_manip("find_file", tmp_dir + "/backup/send", null);
		itr = al_dst_itr(ls);
		loop {
			if (filename = al_next(itr)) {
			} else {
				break;
			}
			if (al_file_manip("is_dir", tmp_dir + "/backup/send/" + filename, null)) {
				continue;
			} else {
			}
			al_file_manip("copy", tmp_dir + "/backup/send/" + filename, send_dir + "/" + filename);
		}
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/recv", null)) {
		ls = al_file_manip("find_file", tmp_dir + "/backup/recv", null);
		itr = al_dst_itr(ls);
		loop {
			if (filename = al_next(itr)) {
			} else {
				break;
			}
			if (al_file_manip("is_dir", tmp_dir + "/backup/recv/" + filename, null)) {
				continue;
			} else {
			}
			al_file_manip("copy", tmp_dir + "/backup/recv/" + filename, recv_dir + "/" + filename);
		}
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/attach", null)) {
		ls = al_file_manip("find_file", tmp_dir + "/backup/attach", null);
		itr = al_dst_itr(ls);
		loop {
			if (filename = al_next(itr)) {
			} else {
				break;
			}
			if (al_file_manip("is_dir", tmp_dir + "/backup/attach/" + filename, null)) {
				continue;
			} else {
			}
			al_file_manip("copy", tmp_dir + "/backup/attach/" + filename, attach_dir + "/" + filename);
		}
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/Message-ParentRelation.csv", null)) {
		if (in = al_file_open(tmp_dir + "/backup/Message-ParentRelation.csv", "r")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open file Message-ParentRelation.csv";
			throw ex;
		}
		loop {
			if (data = al_file_read(in, "csv") && data != 1) {
			} else {
				break;
			}
			sql = al_copy("insert into ParentRelation (dataId,msgId,msgType,msgVersion,dtdFile,parentId,tagId,childSeq,fieldSeq) values ('");
			value = al_dst_node(data, 1);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 2);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 3);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 4);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 5);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 6);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 7);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 8);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 9);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
			try {
				conn.executeUpdate(sql);
			} catch (AlException e) {
			}
		}
		conn.commit();
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/Message-MsgData.csv", null)) {
		if (in = al_file_open(tmp_dir + "/backup/Message-MsgData.csv", "r")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open file Message-MsgData.csv";
			throw ex;
		}
		loop {
			if (data = al_file_read(in, "csv") && data != 1) {
			} else {
				break;
			}
			sql = al_copy("insert into MsgData (dataId,msgId,parentId,tagId,value) values ('");
			value = al_dst_node(data, 1);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 2);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 3);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 4);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 5);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
			try {
				conn.executeUpdate(sql);
			} catch (AlException e) {
			}
		}
		conn.commit();
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/XPathId.csv", null)) {
		if (in = al_file_open(tmp_dir + "/backup/XPathId.csv", "r")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open file XPathId.csv";
			throw ex;
		}
		loop {
			if (data = al_file_read(in, "csv") && data != 1) {
			} else {
				break;
			}
			sql = al_copy("insert into XPathId (tagId,path,msgType,msgVersion) values ('");
			value = al_dst_node(data, 1);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 2);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 3);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 4);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
			try {
				conn.executeUpdate(sql);
			} catch (AlException e) {
			}
		}
		conn.commit();
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/SystemLog.csv", null)) {
		if (in = al_file_open(tmp_dir + "/backup/SystemLog.csv", "r")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open file SystemLog.csv";
			throw ex;
		}
		loop {
			if (data = al_file_read(in, "csv") && data != 1) {
			} else {
				break;
			}
			sql = al_copy("insert into SystemLog (SystemLogId,Time,LogLevel,Message) values ('");
			value = al_dst_node(data, 1);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 2);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 3);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 4);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
			try {
				conn.executeUpdate(sql);
			} catch (AlException e) {
			}
		}
		conn.commit();
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/CommLog.csv", null)) {
		if (in = al_file_open(tmp_dir + "/backup/CommLog.csv", "r")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open file CommLog.csv";
			throw ex;
		}
		loop {
			if (data = al_file_read(in, "csv") && data != 1) {
			} else {
				break;
			}
			sql = al_copy("insert into CommLog (CommLogId,Target,SendRecv,LogLevel,Time,MsgType,Reason,URLfromIP,MyId,PartnerId,rawMsgId,MsgId,RefMsgId,TransactionId,Pid,AppPid) values ('");
			value = al_dst_node(data, 1);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 2);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 3);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 4);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 5);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 6);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 7);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 8);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 9);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 10);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 11);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 12);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 13);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 14);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 15);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 16);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
			try {
				conn.executeUpdate(sql);
			} catch (AlException e) {
			}
		}
		conn.commit();
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/AccessLog.csv", null)) {
		if (in = al_file_open(tmp_dir + "/backup/AccessLog.csv", "r")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open file AccessLog.csv";
			throw ex;
		}
		loop {
			if (data = al_file_read(in, "csv") && data != 1) {
			} else {
				break;
			}
			sql = al_copy("insert into AccessLog (AccessLogId,Time,FromIP,Path,ResponseCode,ResponseSize) values ('");
			value = al_dst_node(data, 1);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 2);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 3);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 4);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 5);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 6);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
			try {
				conn.executeUpdate(sql);
			} catch (AlException e) {
			}
		}
		conn.commit();
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/ProxyLog.csv", null)) {
		if (in = al_file_open(tmp_dir + "/backup/ProxyLog.csv", "r")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open file ProxyLog.csv";
			throw ex;
		}
		loop {
			if (data = al_file_read(in, "csv") && data != 1) {
			} else {
				break;
			}
			sql = al_copy("insert into ProxyLog (ProxyLogId,Time,FromIP,Path,Reason) values ('");
			value = al_dst_node(data, 1);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 2);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 3);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 4);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 5);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
			try {
				conn.executeUpdate(sql);
			} catch (AlException e) {
			}
		}
		conn.commit();
	} else {
	}
	if (al_file_manip("does_exist", tmp_dir + "/backup/ProcessLog.csv", null)) {
		if (in = al_file_open(tmp_dir + "/backup/ProcessLog.csv", "r")) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "can't open file ProcessLog.csv";
			throw ex;
		}
		loop {
			if (data = al_file_read(in, "csv") && data != 1) {
			} else {
				break;
			}
			sql = al_copy("insert into ProcessLog (ProcessLogId,Action,Time,ProcessDefName,ActivityName,ActivityKind,ProcessId,ActivityId,Message) values ('");
			value = al_dst_node(data, 1);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 2);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 3);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 4);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 5);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 6);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 7);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 8);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "','");
			value = al_dst_node(data, 9);
			al_append_str(sql, DbUtility::convChar(value));
			al_append_str(sql, "')");
			try {
				conn.executeUpdate(sql);
			} catch (AlException e) {
			}
		}
		conn.commit();
	} else {
	}
}
end_body
member
public: string op;
member
public: string from;
member
public: string to;
member
public: string from_timestamp;
member
public: string to_timestamp;
member
public: list targets;
member
public: string wwwroot;
member
public: string restoreFile;
member
public: list my_props;
member
public: string send_dir;
member
public: string recv_dir;
member
public: string attach_dir;
member
public: string tmp_dir;
member
public: DbConnection conn;
member
public: static list getProperty(string name);
body
{
	if (static_props) {
	} else {
		return null;
	}
	return al_dst_node(static_props, name);
}
end_body
member
public: static void putProperty(string name, list obj);
body
{
	if (static_props) {
	} else {
		static_props = al_cons(null, null);
	}
	al_set_dst_node(static_props, name, obj);
}
end_body
member
public: static void removeProperty(string name);
body
{
	putProperty(name, null);
}
end_body
member
public: static list static_props;
class RNDataMgr
member
public: static void addAttachment(string msgId, string filename, string mime_type, string content_id, string description);
body
{
	if (filename == null || filename == "") {
		var AlException ex;
		ex = new AlException;
		ex.msg = "attachment filename is null.";
		throw ex;
	} else {
	}
	if (al_file_manip("does_exist", filename, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "attachment file does not exist: filename = '" + (string)filename + "'";
		throw ex;
	}
	if (mime_type == null || mime_type == "") {
		var AlException ex;
		ex = new AlException;
		ex.msg = "attachment Mime Type is null: filename = '" + (string)filename + "'";
		throw ex;
	} else {
	}
	if (content_id == null || content_id == "") {
		var AlException ex;
		ex = new AlException;
		ex.msg = "attachment Content-ID is null: filename = '" + (string)filename + "'";
		throw ex;
	} else {
	}
	var string attach_dir;
	attach_dir = getAttachDir();
	var list attachment, attach_props;
	var integer size;
	attachment = FileUtility::readBinary(filename);
	size = al_misc("binary_size", attachment, null);
	attach_props = al_cons(null, null);
	al_create_arc(attach_props, description, "description");
	al_create_arc(attach_props, mime_type, "mimeType");
	al_create_arc(attach_props, content_id, "contentId");
	addAttachment(attach_dir, msgId, attachment, size, attach_props);
}
end_body
member
public: static list getAttachmentInfos(string msgId);
body
{
	var string attach_dir;
	attach_dir = getAttachDir();
	return getAttachmentInfos(attach_dir, msgId);
}
end_body
member
public: static string getAttachDir();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var RNContext ctx;
		var string attach_dir;
		ctx = new RNContext;
		if (attach_dir = ctx.getMyProperty("-- default setting --", "msg.attach.dir", conn)) {
		} else {
			var AlException ex;
			ex = new AlException;
			ex.msg = "msg.attach.dir is null.";
			throw ex;
		}
		conn.close();
		return attach_dir;
	} catch (AlException e) {
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
		throw e;
	}
}
end_body
end_class
end_class
class InitWebServiceDB
member
public: static void init_all();
body
{
	al_print("start = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	var InitWebServiceDB inst;
	inst = new InitWebServiceDB;
	inst.init();
	al_print("end = " + (string)al_file_manip("current_datetime", null, null) + "\n");
}
end_body
member
public: void init();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		init_system();
		init_rosetta();
		init_rosetta_sample();
		conn.commit();
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: void init_system();
body
{
	init_system_user();
	init_system_webuidata();
}
end_body
member
public: void init_system_user();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register system user admin, webuiadmin
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	xml = FileUtility::readString("data/system/init_user_admin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/system/init_user_webuiadmin.xml");
	acc.putXML(xml);
	al_print("system user registered.\n");
}
end_body
member
public: void init_system_webuidata();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register system WebUiData
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	xml = FileUtility::readString("data/system/init_webuidata.xml");
	acc.putXML(xml);
	al_print("system webuidata registered.\n");
}
end_body
member
public: void init_rosetta();
body
{
	init_rosetta_user();
	init_rosetta_webuidata();
	init_rosetta_my_and_partner_info_default();
	init_rosetta_pip_default();
	init_rosetta_transport_process();
}
end_body
member
public: void init_rosetta_user();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register rosetta user admin, webuiadmin
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	xml = FileUtility::readString("data/rosetta/init_user_admin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/rosetta/init_user_webuiadmin.xml");
	acc.putXML(xml);
	al_print("rosetta user registered.\n");
}
end_body
member
public: void init_rosetta_webuidata();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register rosetta WebUiData
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	xml = FileUtility::readString("data/rosetta/init_webuidata.xml");
	acc.putXML(xml);
	al_print("rosetta webuidata registered.\n");
}
end_body
member
public: void init_rosetta_my_and_partner_info_default();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register rosetta default my info
	acc = new XmlDbAccessor;
	acc.create("MyInfo", "", conn);
	acc.setDTDfilename("MyInfo.dtd");
	xml = FileUtility::readString("data/rosetta/init_my_info_default.xml");
	acc.putXML(xml);
	// ---- register default partner info
	acc = new XmlDbAccessor;
	acc.create("PartnerInfo", "", conn);
	acc.setDTDfilename("PartnerInfo.dtd");
	xml = FileUtility::readString("data/rosetta/init_partner_info_default.xml");
	acc.putXML(xml);
	al_print("rosetta defaut my and partner properties registered.\n");
}
end_body
member
public: void init_rosetta_pip_default();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register default pip properties
	acc = new XmlDbAccessor;
	acc.create("PipInfo", "", conn);
	acc.setDTDfilename("rosetta/PipInfo.dtd");
	xml = FileUtility::readString("data/rosetta/init_pip_default.xml");
	acc.putXML(xml);
	al_print("rosetta pip properties registered.\n");
}
end_body
member
public: void init_rosetta_transport_process();
body
{
	var ProcMgr pm;
	var Process process;
	var list def;
	pm = new ProcMgr;
	// ---- register rosetta transport send process
	process = new RNIF20SendProcess;
	def = process.getDefinition();
	pm.register("RNIF20SendProcess", def, conn);
	// ---- register rosetta transport receive process
	process = new RNIF20ReceiveProcess;
	def = process.getDefinition();
	pm.register("RNIF20ReceiveProcess", def, conn);
	al_print("rosetta transport process registered.\n");
}
end_body
member
public: void init_rosetta_sample();
body
{
	init_rosetta_sample_user();
	init_rosetta_sample_my_info();
	init_rosetta_sample_partner_info();
	init_rosetta_sample_application_process();
	init_rosetta_sample_buyer_webuidata();
	init_rosetta_sample_supplier_webuidata();
	init_rosetta_sample_catalog();
}
end_body
member
public: void init_rosetta_sample_user();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register rosetta user buyer, supplier
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	xml = FileUtility::readString("data/rosetta_sample/init_user_buyer_webuiadmin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/rosetta_sample/init_user_buyer_admin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/rosetta_sample/init_user_buyer.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/rosetta_sample/init_user_supplier_webuiadmin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/rosetta_sample/init_user_supplier_admin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/rosetta_sample/init_user_supplier.xml");
	acc.putXML(xml);
	al_print("rosetta-sample user registered.\n");
}
end_body
member
public: void init_rosetta_sample_my_info();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register rosetta buyer, supplier my info
	acc = new XmlDbAccessor;
	acc.create("MyInfo", "", conn);
	acc.setDTDfilename("MyInfo.dtd");
	xml = FileUtility::readString("data/rosetta_sample/init_my_info_buyer.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/rosetta_sample/init_my_info_supplier.xml");
	acc.putXML(xml);
	al_print("rosetta-sample my properties registered.\n");
}
end_body
member
public: void init_rosetta_sample_partner_info();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register rosetta buyer, supplier partner info
	acc = new XmlDbAccessor;
	acc.create("PartnerInfo", "", conn);
	acc.setDTDfilename("PartnerInfo.dtd");
	xml = FileUtility::readString("data/rosetta_sample/init_partner_info_buyer.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/rosetta_sample/init_partner_info_supplier.xml");
	acc.putXML(xml);
	al_print("rosetta-sample partner properties registered.\n");
}
end_body
member
public: void init_rosetta_sample_application_process();
body
{
	var ProcMgr pm;
	var Process process;
	var list def;
	pm = new ProcMgr;
	// ---- register po send process
	process = new PoSendProcess;
	def = process.getDefinition();
	pm.register("PoSendProcess", def, conn);
	// ---- register po receive process
	process = new PoReceiveProcess;
	def = process.getDefinition();
	pm.register("PoReceiveProcess", def, conn);
	// ---- register po complete process
	process = new PoCompleteProcess;
	def = process.getDefinition();
	pm.register("PoCompleteProcess", def, conn);
	al_print("rosetta-sample application process registered.\n");
}
end_body
member
public: void init_rosetta_sample_buyer_webuidata();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register rosettaSampleBuyer WebUiData
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	xml = FileUtility::readString("data/rosetta_sample/init_buyer_webuidata.xml");
	acc.putXML(xml);
	al_print("rosetta-sample buyer webuidata registered.\n");
}
end_body
member
public: void init_rosetta_sample_supplier_webuidata();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register rosettaSampleSupplier WebUiData
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	xml = FileUtility::readString("data/rosetta_sample/init_supplier_webuidata.xml");
	acc.putXML(xml);
	al_print("rosetta-sample supplier webuidata registered.\n");
}
end_body
member
public: void init_rosetta_sample_catalog();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	// ---- register rosetta SampleCatalog
	acc = new XmlDbAccessor;
	acc.create("SampleCatalog", "", conn);
	acc.setDTDfilename("rosetta/SampleCatalog.dtd");
	xml = FileUtility::readString("data/rosetta_sample/init_catalog.xml");
	acc.putXML(xml);
	al_print("rosetta-sample catalog registered.\n");
}
end_body
member
public: DbConnection conn;
member
public: static void upate();
body
{
	al_print("start = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	var InitWebServiceDB inst;
	inst = new InitWebServiceDB;
	inst._update();
	al_print("end = " + (string)al_file_manip("current_datetime", null, null) + "\n");
}
end_body
member
public: void _update();
body
{
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		// init_system_user();
		// init_system_webuidata();
		// init_rosetta_user();
		// init_rosetta_webuidata();
		// init_rosetta_my_and_partner_info_default();
		// init_rosetta_pip_default();
		// init_rosetta_transport_process();
		// init_rosetta_sample_user();
		// init_rosetta_sample_my_info();
		// init_rosetta_sample_partner_info();
		// init_rosetta_sample_application_process();
		// init_rosetta_sample_buyer_webuidata();
		// init_rosetta_sample_supplier_webuidata();
		// init_rosetta_sample_catalog();
		conn.commit();
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
end_class
class InitBizsoftDB
member
public: static void init_all();
body
{
	al_print("start = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	var InitBizsoftDB inst;
	inst = new InitBizsoftDB;
	inst.init();
	al_print("end = " + (string)al_file_manip("current_datetime", null, null) + "\n");
}
end_body
member
public: void init();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		init_bizsoft();
		init_customer();
		init_sales();
		init_finance();
		conn.commit();
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: void init_bizsoft();
body
{
	init_bizsoft_user();
	init_bizsoft_webuidata();
}
end_body
member
public: void init_bizsoft_user();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	// --- unregister bizsoft users
	ls = acc.get("User/Target", "bizsoft");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register bizsoft user admin, webuiadmin
	xml = FileUtility::readString("data/bizsoft/init_user_admin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/bizsoft/init_user_webuiadmin.xml");
	acc.putXML(xml);
	al_print("bizsoft user registered.\n");
}
end_body
member
public: void init_bizsoft_webuidata();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	// --- unregister rosetta WebUiData
	ls = acc.get("WebUiData/Target", "bizsoft");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register rosetta WebUiData
	xml = FileUtility::readString("data/bizsoft/init_webuidata.xml");
	acc.putXML(xml);
	al_print("bizsoft webuidata registered.\n");
}
end_body
member
public: void init_customer();
body
{
	init_customer_user();
	init_customer_webuidata();
}
end_body
member
public: void init_customer_user();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	// --- unregister bizsoftSales user
	ls = acc.get("User/Target", "bizsoftSales", "User/UserId", "admin");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	ls = acc.get("User/Target", "bizsoftSales", "User/UserId", "webuiadmin");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register bizsoftSales user
	xml = FileUtility::readString("data/bizsoft/customer/init_user_webuiadmin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/bizsoft/customer/init_user_admin.xml");
	acc.putXML(xml);
	al_print("bizsoftSales user registered.\n");
}
end_body
member
public: void init_customer_webuidata();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	// --- unregister bizsoftCustomer WebUiData
	ls = acc.get("WebUiData/Target", "bizsoftCustomer");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register bizsoftCustomer WebUiData
	xml = FileUtility::readString("data/bizsoft/customer/init_webuidata.xml");
	acc.putXML(xml);
	al_print("bizsoftCustomer webuidata registered.\n");
}
end_body
member
public: void init_sales();
body
{
	init_sales_user();
	init_sales_webuidata();
	init_sales_products();
}
end_body
member
public: void init_sales_user();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	// --- unregister bizsoftSales user
	ls = acc.get("User/Target", "bizsoftSales");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register bizsoftSales user
	xml = FileUtility::readString("data/bizsoft/sales/init_user_webuiadmin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/bizsoft/sales/init_user_admin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/bizsoft/sales/init_user_sales.xml");
	acc.putXML(xml);
	al_print("bizsoftSales user registered.\n");
}
end_body
member
public: void init_sales_webuidata();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	// --- unregister bizsoftSales WebUiData
	ls = acc.get("WebUiData/Target", "bizsoftSales");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register bizsoftSales WebUiData
	xml = FileUtility::readString("data/bizsoft/sales/init_webuidata.xml");
	acc.putXML(xml);
	al_print("bizsoftSales webuidata registered.\n");
}
end_body
member
public: void init_sales_products();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("Products", "", conn);
	acc.setDTDfilename("bizsoft/stock/stock.dtd");
	// --- unregister all products stock
	ls = acc.getAll();
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register account headings
	xml = FileUtility::readString("data/bizsoft/stock/sample_stock.xml");
	acc.putXML(xml, "product_stock");
	al_print("products stock registered.\n");
}
end_body
member
public: void init_finance();
body
{
	init_finance_user();
	init_finance_webuidata();
	init_finance_acount_headings();
	init_finance_tax_rate();
}
end_body
member
public: void init_finance_user();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("User", "", conn);
	acc.setDTDfilename("User.dtd");
	// --- unregister bizsoftAccount user
	ls = acc.get("User/Target", "bizsoftAccount");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register bizsoftAccount user
	xml = FileUtility::readString("data/bizsoft/finance/init_user_webuiadmin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/bizsoft/finance/init_user_admin.xml");
	acc.putXML(xml);
	xml = FileUtility::readString("data/bizsoft/finance/init_user_account.xml");
	acc.putXML(xml);
	al_print("bizsoftAccount user registered.\n");
}
end_body
member
public: void init_finance_webuidata();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("WebUiData", "", conn);
	acc.setDTDfilename("WebUiData.dtd");
	// --- unregister bizsoftAccount WebUiData
	ls = acc.get("WebUiData/Target", "bizsoftAccount");
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register bizsoftAccount WebUiData
	xml = FileUtility::readString("data/bizsoft/finance/init_webuidata.xml");
	acc.putXML(xml);
	al_print("bizsoftAccount webuidata registered.\n");
}
end_body
member
public: void init_finance_acount_headings();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("AccountHeadings", "", conn);
	acc.setDTDfilename("bizsoft/finance/account_headings.dtd");
	// --- unregister all account headings
	ls = acc.getAll();
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register account headings
	xml = FileUtility::readString("data/bizsoft/finance/account_headings.xml");
	acc.putXML(xml, "account_headings");
	al_print("account headings registered.\n");
}
end_body
member
public: void init_finance_tax_rate();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("TaxRate", "", conn);
	acc.setDTDfilename("bizsoft/finance/tax_rate.dtd");
	// --- unregister all tax rate
	ls = acc.getAll();
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register tax rate
	xml = FileUtility::readString("data/bizsoft/finance/tax_rate.xml");
	acc.putXML(xml, "tax_rate");
	al_print("tax rate registered.\n");
}
end_body
member
public: void init_finance_sample_check_data();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var integer idx;
	var list ls, itr, xml_data, xml_data2;
	acc = new XmlDbAccessor;
	acc.create("Check", "", conn);
	acc.setDTDfilename("bizsoft/finance/check.dtd");
	// --- unregister sample check data
	ls = acc.get((list)al_cons(null, null), "`[/t", "string", "2002/04/01", "2002/09/21", "`[/t", "string", null);
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register sample check data
	xml_data = XmlUtility::parseXML("data/bizsoft/finance/sample_check_data.xml");
	xml_data = al_dst_node(xml_data, "`[}X^[");
	xml_data = al_dst_node(xml_data, "!body");
	itr = al_dst_itr(xml_data);
	idx = 0;
	loop {
		if (xml_data2 = al_next_a(itr, "`[")) {
		} else {
			break;
		}
		ls = al_cons(1, null);
		al_create_arc(ls, xml_data2, "`[");
		xml_data2 = ls;
		var string xml;
		var file f;
		xml = al_copy("");
		f = al_file_open(xml, "sw");
		al_xml("generate", f, xml_data2, null);
		acc.putXML(xml, "20020921-120000-" + (string)(idx = idx + 1));
	}
	al_print("sample check data registered.\n");
}
end_body
member
public: void init_finance_sample_stock_data();
body
{
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml;
	acc = new XmlDbAccessor;
	acc.create("Check", "", conn);
	acc.setDTDfilename("bizsoft/finance/check.dtd");
	acc = new XmlDbAccessor;
	acc.create("Stock", "", conn);
	acc.setDTDfilename("bizsoft/finance/stock.dtd");
	// --- unregister sample stock data
	ls = acc.get((list)al_cons(null, null), "XgbN/t", "string", "2002/03/31", "2002/03/31", "XgbN/t", "string", null);
	itr = al_dst_itr(ls);
	loop {
		if (obj = al_next(itr)) {
		} else {
			break;
		}
		obj.delete();
	}
	// ---- register sample stock data
	xml = FileUtility::readString("data/bizsoft/finance/sample_stock_data.xml");
	acc.putXML(xml, "20020921-130000-1");
	al_print("sample stock data registered.\n");
}
end_body
member
public: DbConnection conn;
member
public: static void update();
body
{
	al_print("start = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	var InitBizsoftDB inst;
	inst = new InitBizsoftDB;
	inst._update();
	al_print("end = " + (string)al_file_manip("current_datetime", null, null) + "\n");
}
end_body
member
public: void _update();
body
{
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		// init_bizsoft_user();
		// init_bizsoft_webuidata();
		// init_customer_webuidata();
		// init_sales_user();
		// init_sales_webuidata();
		// init_sales_products();
		// init_finance_user();
		// init_finance_webuidata();
		// init_finance_acount_headings();
		// init_finance_tax_rate();
		init_finance_sample_check_data();
		init_finance_sample_stock_data();
		conn.commit();
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
end_class
class Test_HttpClientConnection
member
public: static void test_parseURL();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	var string err;
	if (err = conn.create("http://www.nec.co.jp/")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("http://www.nec.co.jp")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("http://www.kt.rim.or.jp/~inamoto/")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("http://www.kt.rim.or.jp/~inamoto")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("http://www.kt.rim.or.jp/~inamoto/altair")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("http://www.kt.rim.or.jp/~inamoto/altair/")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("http://www.nec.co.jp:8080/")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("https://www.nec.co.jp:8080")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("http://www.nec.co.jp:8080/solusion")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("http://www.nec.co.jp:8080/solusion/")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
	if (err = conn.create("http://192.168.211.211:80/altair/")) {
		al_print(err + "\n");
	} else {
		al_print("ssl = " + (string)conn.ssl + "\n");
		al_print("host = " + conn.host + "\n");
		al_print("port = " + (string)conn.port + "\n");
		al_print("path = " + conn.path + "\n");
		al_print("OK\n");
	}
}
end_body
member
public: static void test_client_doGet1();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://www.kt.rim.or.jp/~inamoto/altair/index.html");
	var list err;
	if (err = conn.doGet()) {
		al_print(err + "\n");
		return;
	} else {
	}
	al_print("response code = " + (string)conn.response_code + "\n");
	var string str;
	var integer len;
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print(str);
}
end_body
member
public: static void test_client_doGet2();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://127.0.0.1/sample/");
	var list err;
	if (err = conn.doGet()) {
		al_print(err + "\n");
		return;
	} else {
	}
	var string str;
	var integer len;
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print(str);
}
end_body
member
public: static void test_client_doGet3();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://localhost:7001/ebiz?action=system_Home_j&WebLogicSession=PFvknlQ0x4vgomC2yCrm91jEvpdNaIS25zrYtuftfZS7cgzGP6pe|8888385647365025804/-1062677549/6/7001/7001/7002/7002/7001/-1");
	var list err;
	if (err = conn.doGet()) {
		al_print(err + "\n");
		return;
	} else {
	}
	var string str;
	var integer len;
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print(str);
	{
		var list hdr;
		var integer len;
		var string s;
		hdr = al_crypt("mime_headers_write", conn.headers, null, null);
		len = al_misc("binary_size", hdr, null);
		al_print("header_length = " + (string)len + "\n");
		s = al_misc("binary_to_string", al_list3(hdr, 0, len), null);
		al_print("header = " + s);
	}
}
end_body
member
public: static void test_client_doGet4();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://www.empower.jp/index.html");
	var list err;
	if (err = conn.doGet()) {
		al_print(err + "\n");
		return;
	} else {
	}
	var integer len;
	len = al_misc("binary_size", conn.contents, null);
	var file f;
	f = al_file_open("c:/alnxv027.zip", "wb");
	al_file_write(f, al_list3(conn.contents, 0, len), null);
	f = null;
	al_print("done\n");
}
end_body
member
public: static void test_client_doPost1();
body
{
	Test_Misc::set_output();
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://localhost/rosetta");
	var string filename, str;
	var integer len;
	var list buf;
	var file in;
	al_set_dst_node(conn.headers, "Content-Type", "multipart/related; boundary=\"----rn-http-boundary\"; type=\"multipart/related\"");
	al_set_dst_node(conn.headers, "x-RN-Version", "RosettaNet/V02.00");
	al_set_dst_node(conn.headers, "x-RN-Response-Type", "async");
	filename = "./data/test/PORequest.txt";
	len = al_file_manip("get_size", filename, null);
	buf = al_misc("binary", len, null);
	in = al_file_open(filename, "rb");
	al_file_read(in, al_list3(buf, 0, len));
	conn.out(buf);
	var list err;
	if (err = conn.doPost()) {
		al_print(err + "\n");
		return;
	} else {
	}
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print("response length = " + (string)len + "\n");
	al_print("response contents = " + str + "\n");
	al_print("response code = " + (string)conn.response_code + "\n");
}
end_body
member
public: static void test_client_ssl_doPost1();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("https://localhost/rosetta");
	var string filename, str;
	var integer len;
	var list buf;
	var file in;
	al_set_dst_node(conn.headers, "Content-Type", "multipart/related; boundary=\"----rn-http-boundary\"; type=\"multipart/related\"");
	al_set_dst_node(conn.headers, "x-RN-Version", "RosettaNet/V02.00");
	al_set_dst_node(conn.headers, "x-RN-Response-Type", "async");
	filename = "./data/test/PORequest.txt";
	len = al_file_manip("get_size", filename, null);
	buf = al_misc("binary", len, null);
	in = al_file_open(filename, "rb");
	al_file_read(in, al_list3(buf, 0, len));
	conn.out(buf);
	var list err;
	if (err = conn.doPost()) {
		al_print(err + "\n");
		return;
	} else {
	}
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print("response length = " + (string)len + "\n");
	al_print("response contents = " + str + "\n");
	al_print("response code = " + (string)conn.response_code + "\n");
}
end_body
member
public: static void test_client_doPost2();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://localhost/rosetta");
	var string filename, str;
	var integer len;
	var list buf;
	var file in;
	al_set_dst_node(conn.headers, "Content-Type", "multipart/related; boundary=\"----rn-http-boundary\"; type=\"multipart/related\"");
	al_set_dst_node(conn.headers, "x-RN-Version", "RosettaNet/V02.00");
	al_set_dst_node(conn.headers, "x-RN-Response-Type", "async");
	filename = "./data/test/PORequestWithAttach.txt";
	len = al_file_manip("get_size", filename, null);
	buf = al_misc("binary", len, null);
	in = al_file_open(filename, "rb");
	al_file_read(in, al_list3(buf, 0, len));
	conn.out(buf);
	var list err;
	if (err = conn.doPost()) {
		al_print(err + "\n");
		return;
	} else {
	}
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print("response length = " + (string)len + "\n");
	al_print("response contents = " + str + "\n");
	al_print("response code = " + (string)conn.response_code + "\n");
}
end_body
member
public: static void test_client_doPost3();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://localhost/rosetta");
	var string filename, str;
	var integer len;
	var list buf;
	var file in;
	al_set_dst_node(conn.headers, "Content-Type", "multipart/related; boundary=\"8SXVTUQE51SRI8I4J0Q068N05EO032OEL5G9LX3IE18J4QYO32ZQC9AWQHXLB3AU\"; type=\"multipart/related\"");
	al_set_dst_node(conn.headers, "x-RN-Version", "RosettaNet/V02.00");
	al_set_dst_node(conn.headers, "x-RN-Response-Type", "async");
	filename = "./data/test/PIN.txt";
	len = al_file_manip("get_size", filename, null);
	buf = al_misc("binary", len, null);
	in = al_file_open(filename, "rb");
	al_file_read(in, al_list3(buf, 0, len));
	conn.out(buf);
	var list err;
	if (err = conn.doPost()) {
		al_print(err + "\n");
		return;
	} else {
	}
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print("response length = " + (string)len + "\n");
	al_print("response contents = " + str + "\n");
	al_print("response code = " + (string)conn.response_code + "\n");
}
end_body
member
public: static void test_client_doPost_tmp();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://localhost:7001/ebiz?action=system_Login");
	var string str;
	var integer len;
	var list buf;
	var file in;
	str = "userid=Administrator&password=administrator";
	conn.out(str);
	var list err;
	if (err = conn.doPost()) {
		al_print(err + "\n");
		return;
	} else {
	}
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print("response length = " + (string)len + "\n");
	al_print("response contents = " + str + "\n");
	al_print("response code = " + (string)conn.response_code + "\n");
	{
		var list hdr;
		var integer len;
		var string s;
		hdr = al_crypt("mime_headers_write", conn.headers, null, null);
		len = al_misc("binary_size", hdr, null);
		al_print("header_length = " + (string)len + "\n");
		s = al_misc("binary_to_string", al_list3(hdr, 0, len), null);
		al_print("header = " + s);
	}
}
end_body
member
public: static void test_client_ssl_doGet();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	// conn.create("https://localhost/admin/");
	conn.create("https://localhost/");
	var list err;
	if (err = conn.doGet()) {
		al_print(err + "\n");
		return;
	} else {
	}
	var string str;
	var integer len;
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print(str);
}
end_body
member
public: static void test_client_proxy_doGet();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://localhost/");
	conn.proxy_server = "localhost";
	conn.proxy_port = 8080;
	var list err;
	if (err = conn.doGet()) {
		al_print(err + "\n");
		return;
	} else {
	}
	var string str;
	var integer len;
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print(str);
}
end_body
member
public: static void test_client_proxy_ssl_doGet();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("https://localhost/");
	conn.proxy_server = "localhost";
	conn.proxy_port = 8080;
	var list err;
	if (err = conn.doGet()) {
		al_print(err + "\n");
		return;
	} else {
	}
	var string str;
	var integer len;
	len = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, len), null);
	al_print(str);
}
end_body
member
public: static void test_client_doGet_dump();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	// conn.create("http://www.altair1984.com/index.html");
	// conn.create("http://www.kt.rim.or.jp/~inamoto/altair/index.html");
	// conn.create("http://ebiz.apgm.net:8080/admin/index.html");
	conn.create("http://localhost/admin/index.html");
	// conn.create("http://localhost:7001/system_Login.html");
	// conn.proxy_server = "gw3.isd.nec.co.jp";
	// conn.proxy_port = 8080;
	var list err;
	if (err = conn.doGet()) {
		al_print(err + "\n");
		return;
	} else {
	}
	al_print(conn.command + "\n");
	var list bin;
	var integer size;
	var string str;
	bin = al_crypt("mime_headers_write", conn.headers, null, null);
	size = al_misc("binary_size", bin, null);
	str = al_misc("binary_to_string", al_list3(bin, 0, size), null);
	al_print(str);
	size = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, size), null);
	al_print(str);
}
end_body
member
public: static void test_client_doPost_dump();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	// conn.create("http://localhost:7001/ebiz?action=system_Login");
	// conn.create("http://ebiz.apgm.net:8080/admin/ebiz?action=system_LiteLogin");
	conn.create("http://localhost/admin/ebiz?action=Login");
	// conn.proxy_server = "gw3.isd.nec.co.jp";
	// conn.proxy_port = 8080;
	var string str;
	// str = "organization=default&userid=Administrator&password=administrator";
	// str = "next=system_LiteLog";
	str = "target=rosetta&user=admin&pass=admin";
	var list err;
	conn.out(str);
	if (err = conn.doPost()) {
		al_print(err + "\n");
		return;
	} else {
	}
	al_print(conn.command + "\n");
	var list bin;
	var integer size;
	bin = al_crypt("mime_headers_write", conn.headers, null, null);
	size = al_misc("binary_size", bin, null);
	str = al_misc("binary_to_string", al_list3(bin, 0, size), null);
	al_print(str);
	size = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, size), null);
	al_print(str);
}
end_body
member
public: static void test_client_doGet2_dump();
body
{
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	// conn.create("http://ebiz.apgm.net:8080/admin/ebiz?action=system_LiteLogin&next=system_LiteLog");
	// conn.create("http://localhost/admin/ebiz?action=Login");
	conn.create("http://localhost:80/admin/ebiz?action=AdminHome");
	var string session_id, cookie;
	session_id = "1WRXYP7JB4I1B8UD75CJBXR4K7JL4YVGZ6YCABWUH58LDNCMGPGL0QOYJEE0ZK7Y";
	// al_set_dst_node(conn.headers, "Cookie", "JSESSIONID=" + session_id);
	al_set_dst_node(conn.headers, "Cookie", "AltairSession=" + session_id);
	// conn.proxy_server = "gw3.isd.nec.co.jp";
	// conn.proxy_port = 8080;
	var list err;
	if (err = conn.doGet()) {
		al_print(err + "\n");
		return;
	} else {
	}
	al_print(conn.command + "\n");
	var list bin;
	var integer size;
	var string str;
	bin = al_crypt("mime_headers_write", conn.headers, null, null);
	size = al_misc("binary_size", bin, null);
	str = al_misc("binary_to_string", al_list3(bin, 0, size), null);
	al_print(str);
	size = al_misc("binary_size", conn.contents, null);
	str = al_misc("binary_to_string", al_list3(conn.contents, 0, size), null);
	al_print(str);
}
end_body
member
public: static void test_timeout();
body
{
	al_print("start = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	// ---- create server socket
	var integer server_socket_id;
	server_socket_id = al_socket("socket", null, null, null);
	al_socket("bind", server_socket_id, al_list2(0, 9999), null);
	al_socket("listen", server_socket_id, null, null);
	// ---- exec doGet
	var string err;
	var HttpClientConnection conn;
	conn = new HttpClientConnection;
	conn.create("http://localhost:9999/");
	if (err = conn.doGet()) {
		al_print("error = " + (string)err + "\n");
	} else {
		al_print("no error\n");
	}
	// ---- close server socket
	al_socket("close", server_socket_id, null, null);
	al_print("end = " + (string)al_file_manip("current_datetime", null, null) + "\n");
}
end_body
member
public: static void test_download();
body
{
	var Sample_URL_Iterator itr;
	var string url;
	itr = new Sample_URL_Iterator;
	loop {
		if (itr.Next()) {
		} else {
			break;
		}
		al_print("url = " + itr.url + "\n");
		var HttpClientConnection conn;
		var list err;
		conn = new HttpClientConnection;
		if (err = conn.create(itr.url)) {
			al_print("URL parse error: " + (string)err + "\n");
			continue;
		} else {
		}
		if (err = conn.doGet()) {
			al_print("doGet error: " + (string)err + "\n");
			continue;
		} else {
		}
		var file f;
		var integer size;
		var list block;
		if (f = al_file_open(itr.filename, "wb")) {
		} else {
			al_print("file open error: filename = " + (string)itr.filename + "\n");
			continue;
		}
		size = al_misc("binary_size", conn.contents, null);
		block = al_list3(conn.contents, 0, size);
		if (al_file_write(f, block, null)) {
			al_print("file write error: filename = " + (string)itr.filename + "\n");
			continue;
		} else {
		}
		al_print("saved OK: filename = " + (string)itr.filename + "\n");
	}
}
end_body
class Sample_URL_Iterator
member
public: string Next();
body
{
	var string base, file_base;
	base = "http://www.kt.rim.or.jp/~inamoto/";
	file_base = "./tmp";
	if (phase == null) {
		url = base + "index.html";
		filename = file_base + "/top.html";
		phase = 1;
		return url;
	} else {
	}
	if (phase == 1) {
		url = base + "altair/index.html";
		filename = file_base + "/altair.html";
		phase = phase + 1;
		return url;
	} else {
	}
	if (phase == 2) {
		url = base + "essay/index.html";
		filename = file_base + "/essay.html";
		phase = phase + 1;
		return url;
	} else {
	}
	if (phase == 3) {
		return null;
	} else {
	}
}
end_body
member
public: string url;
member
public: string filename;
member
public: list phase;
end_class
end_class
class Test_XmlUtility
member
public: static void test_load_dtd_1();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var DtdLoader loader;
	loader = new ExtendedDtdLoader;
	loader.log_level = 30;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	loader.read_entities(in);
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	tmp_file = FileUtility::tempFile();
	if (out = al_file_open(tmp_file, "w")) {
	} else {
		return;
	}
	loader.apply_entities(in, out);
	in = null;
	out = null;
	var string platform;
	platform = al_misc("platform", null, null);
	if (platform == "windows") {
		al_exec("notepad " + tmp_file, ".", 1, 1);
	} else {
	}
	if (platform == "linux" || platform == "mac") {
		al_exec("xemacs " + tmp_file, ".", 1, 1);
	} else {
	}
	al_file_manip("remove", tmp_file, null);
	al_misc("output", null, null);
}
end_body
member
public: static void test_load_dtd_2();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var DtdLoader loader;
	loader = new ExtendedDtdLoader;
	loader.log_level = 30;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	loader.read_entities(in);
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	tmp_file = FileUtility::tempFile();
	if (out = al_file_open(tmp_file, "w")) {
	} else {
		return;
	}
	loader.apply_entities(in, out);
	in = null;
	out = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.read_element(in);
	in = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.elem_attr(in);
	in = null;
	al_file_manip("remove", tmp_file, null);
	al_misc("output", null, null);
}
end_body
member
public: static void test_load_dtd_all();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd||", null)) {
	} else {
		return;
	}
	var list ls, itr;
	var string name;
	ls = al_file_manip("find_file", dir_name.head, null);
	itr = al_dst_itr(ls);
	loop {
		if (name = al_next(itr)) {
		} else {
			break;
		}
		if (name == "." || name == "..") {
			continue;
		} else {
		}
		test_load_dtd_all_sub(dir_name.head + "/" + name);
	}
	al_misc("output", null, null);
}
end_body
member
public: static void test_load_dtd_all_sub(string filename);
body
{
	var string tmp_file;
	var DtdLoader loader;
	loader = new ExtendedDtdLoader;
	loader.log_level = 30;
	loader.info_log("======== start " + filename + "========\n");
	var file in, out;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	loader.read_entities(in);
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	tmp_file = FileUtility::tempFile();
	if (out = al_file_open(tmp_file, "w")) {
	} else {
		return;
	}
	loader.apply_entities(in, out);
	in = null;
	out = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.read_element(in);
	in = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.elem_attr(in);
	in = null;
	al_file_manip("remove", tmp_file, null);
}
end_body
member
public: static void test_dtd_itr0();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var DtdLoader loader;
	loader = new ExtendedDtdLoader;
	loader.log_level = 20;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	loader.read_entities(in);
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	tmp_file = FileUtility::tempFile();
	if (out = al_file_open(tmp_file, "w")) {
	} else {
		return;
	}
	loader.apply_entities(in, out);
	in = null;
	out = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.read_element(in);
	in = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	var list err;
	err = loader.elem_attr(in);
	in = null;
	if (err) {
		al_print(err + "\n");
		return;
	} else {
	}
	var integer expand_recursive_count;
	var list skip_flag;
	var DtdItr itr;
	var string type;
	itr = new DtdItr;
	itr.handler = new DtdHandler;
	itr.Reset(loader.root_elem);
	expand_recursive_count = 0;
	loop {
		type = itr.Next(skip_flag);
		if (itr.recursive_expanded) {
			expand_recursive_count = expand_recursive_count + 1;
			if (expand_recursive_count >= 1) {
				skip_flag = 1;
			} else {
			}
		} else {
		}
		// al_print("type = " + itr.type + ", xpath = " + (string)itr.rel_xpath + ", attr = " + (string)itr.attr + ", opt = " + (string)itr.opt + ", tag = " + (string)itr.tag + "\n");
		if (type == "end") {
			break;
		} else {
		}
	}
	al_print("==== Finished ====\n");
	al_file_manip("remove", tmp_file, null);
	al_misc("output", null, null);
}
end_body
member
public: static void test_dtd_itr1();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var DtdLoader loader;
	loader = new ExtendedDtdLoader;
	loader.log_level = 20;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	loader.read_entities(in);
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	tmp_file = FileUtility::tempFile();
	if (out = al_file_open(tmp_file, "w")) {
	} else {
		return;
	}
	loader.apply_entities(in, out);
	in = null;
	out = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.read_element(in);
	in = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	var list err;
	err = loader.elem_attr(in);
	in = null;
	if (err) {
		al_print(err + "\n");
		return;
	} else {
	}
	var integer expand_recursive_count;
	var list skip_flag;
	var DtdItr itr;
	var string type;
	itr = new DtdItr;
	itr.Reset(loader.root_elem);
	expand_recursive_count = 0;
	loop {
		type = itr.Next(skip_flag);
		if (itr.recursive_expanded) {
			expand_recursive_count = expand_recursive_count + 1;
			if (expand_recursive_count >= 1) {
				skip_flag = 1;
			} else {
			}
		} else {
		}
		al_print("type = " + itr.type + ", xpath = " + (string)itr.rel_xpath + ", attr = " + (string)itr.attr + ", opt = " + (string)itr.opt + ", tag = " + (string)itr.tag + "\n");
		if (type == "end") {
			break;
		} else {
		}
	}
	al_print("==== Finished ====\n");
	al_file_manip("remove", tmp_file, null);
	al_misc("output", null, null);
}
end_body
member
public: static void test_dtd_itr2();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var DtdLoader loader;
	loader = new ExtendedDtdLoader;
	loader.log_level = 20;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	loader.read_entities(in);
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	tmp_file = FileUtility::tempFile();
	if (out = al_file_open(tmp_file, "w")) {
	} else {
		return;
	}
	loader.apply_entities(in, out);
	in = null;
	out = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.read_element(in);
	in = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.elem_attr(in);
	in = null;
	var integer expand_recursive_count;
	var list skip_flag;
	var DtdItr itr;
	var string type;
	itr = new DtdItr;
	itr.handler = new DtdHandler;
	itr.Reset(loader.root_elem);
	expand_recursive_count = 0;
	loop {
		type = itr.Next(skip_flag);
		if (itr.recursive_expanded) {
			expand_recursive_count = expand_recursive_count + 1;
			if (expand_recursive_count >= 1) {
				skip_flag = 1;
			} else {
			}
		} else {
		}
		al_print("type = " + itr.type + ", xpath = " + (string)itr.rel_xpath + ", attr = " + (string)itr.attr + ", opt = " + (string)itr.opt + ", tag = " + (string)itr.tag + "\n");
		if (type == "end") {
			break;
		} else {
		}
	}
	al_print("==== Finished ====\n");
	al_file_manip("remove", tmp_file, null);
	al_misc("output", null, null);
}
end_body
member
public: static void test_dtd_itr3();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var DtdLoader loader;
	loader = new ExtendedDtdLoader;
	loader.log_level = 20;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	loader.read_entities(in);
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	tmp_file = FileUtility::tempFile();
	if (out = al_file_open(tmp_file, "w")) {
	} else {
		return;
	}
	loader.apply_entities(in, out);
	in = null;
	out = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.read_element(in);
	in = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	var list err;
	err = loader.elem_attr(in);
	in = null;
	if (err) {
		al_print(err + "\n");
		return;
	} else {
	}
	var integer expand_recursive_count;
	var list skip_flag;
	var DtdItr itr;
	var string type;
	itr = new DtdItr;
	itr.Reset(loader.root_elem);
	expand_recursive_count = 0;
	loop {
		type = itr.Next(skip_flag);
		if (itr.recursive_expanded) {
			expand_recursive_count = expand_recursive_count + 1;
			if (expand_recursive_count >= 2) {
				skip_flag = 1;
			} else {
			}
		} else {
		}
		al_print("type = " + itr.type + ", xpath = " + (string)itr.rel_xpath + ", attr = " + (string)itr.attr + ", opt = " + (string)itr.opt + ", tag = " + (string)itr.tag + "\n");
		if (type == "end") {
			break;
		} else {
		}
	}
	al_print("==== Finished ====\n");
	al_file_manip("remove", tmp_file, null);
	al_misc("output", null, null);
}
end_body
member
public: static void test_dtd_itr10();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var list dtd;
	XmlUtility::dtd_cache = null;
	dtd = XmlUtility::loadDTD(filename);
	var integer expand_recursive_count;
	var list skip_flag;
	var DtdItr itr;
	var string type;
	itr = new DtdItr;
	itr.Reset(dtd);
	expand_recursive_count = 0;
	loop {
		type = itr.Next(skip_flag);
		if (itr.recursive_expanded) {
			expand_recursive_count = expand_recursive_count + 1;
			if (expand_recursive_count >= 1) {
				skip_flag = 1;
			} else {
			}
		} else {
		}
		al_print("type = " + itr.type + ", xpath = " + itr.abs_xpath + "\n");
		if (type == "end") {
		} else {
			break;
		}
	}
	al_misc("output", null, null);
}
end_body
member
public: static void test_dtd_itr_all_tag();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var DtdLoader loader;
	loader = new ExtendedDtdLoader;
	loader.log_level = 20;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	loader.read_entities(in);
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	tmp_file = FileUtility::tempFile();
	if (out = al_file_open(tmp_file, "w")) {
	} else {
		return;
	}
	loader.apply_entities(in, out);
	in = null;
	out = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	loader.read_element(in);
	in = null;
	if (in = al_file_open(tmp_file, "r")) {
	} else {
		return;
	}
	var list err;
	err = loader.elem_attr(in);
	in = null;
	if (err) {
		al_print(err + "\n");
		return;
	} else {
	}
	var DtdItr itr;
	var string type;
	itr = new DtdItr;
	itr.Reset(loader.root_elem);
	itr.all_tag = 1;
	loop {
		type = itr.Next((list)2);
		if (itr.recursive_expanded) {
		} else {
		}
		al_print("type = " + itr.type + ", xpath = " + (string)itr.abs_xpath + ", attr = " + (string)itr.attr + ", opt = " + (string)itr.opt + ", tag = " + (string)itr.tag + "\n");
		if (type == "end") {
			break;
		} else {
		}
	}
	al_print("==== Finished ====\n");
	al_file_manip("remove", tmp_file, null);
	al_misc("output", null, null);
}
end_body
member
public: static void test_attach_content_validation_data();
body
{
	var list dtd;
	dtd = XmlUtility::loadDTD("./dtd/rosetta/3A4PurchaseOrderRequestMessageGuideline_v1_1.dtd");
	DtdLoader::attach_content_validation_data(dtd, "./validation/Pip3A4PurchaseOrderRequest-1.1.csv");
}
end_body
member
public: static void test_xml_itr_1();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	XmlUtility::Initialize();
	var list dir_name;
	var string filename;
	var file in;
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	var list parse_tree;
	parse_tree = XmlUtility::parseXML(in, null);
	var XmlItr xml_itr;
	xml_itr = new XmlItr;
	xml_itr.Reset(parse_tree);
	loop {
		if (xml_itr.Next()) {
		} else {
			break;
		}
		al_print("xpath = " + (string)xml_itr.xpath + "\n");
		al_print("value = " + (string)xml_itr.value + "\n");
	}
	al_print("==== Finished ====\n");
	al_misc("output", null, null);
}
end_body
member
public: static void test_xml_itr_2();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename;
	var file in;
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	if (in = al_file_open(filename, "r")) {
	} else {
		return;
	}
	var list parse_tree;
	parse_tree = XmlUtility::parseXML(in, null);
	var XmlItr xml_itr, xml_itr2;
	xml_itr = new XmlItr;
	xml_itr.Reset(parse_tree);
	loop {
		if (xml_itr.Next3()) {
		} else {
			break;
		}
		xml_itr2 = xml_itr.Copy();
		loop {
			if (xml_itr2.Next2()) {
			} else {
				break;
			}
			al_print("xpath = " + (string)xml_itr2.xpath + "\n");
			al_print("value = " + (string)xml_itr2.value + "\n");
			xml_itr.Copy(xml_itr2);
		}
	}
	al_print("==== Finished ====\n");
	al_misc("output", null, null);
}
end_body
member
public: static void test_validate();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	XmlUtility::Initialize();
	var list dir_name;
	var string filename;
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	al_print("file = " + filename + "\n");
	try {
		var string dtd_base, dtd_file;
		dtd_base = ".";
		var list parse_tree, dtd;
		var file in;
		in = al_file_open(filename, "r");
		parse_tree = XmlUtility::parseXML(in, null);
		dtd_file = dtd_base + "/" + XmlUtility::getDTDfile(parse_tree);
		al_print("dtd file = " + dtd_file + "\n");
		dtd = XmlUtility::loadDTD(dtd_file);
		XmlUtility::validateXML(dtd, parse_tree);
		al_print("  Validation Success\n");
	} catch (AlException e) {
		al_print("  Validation Error: " + (string)e.msg + "\n");
		var list frame, loc_base, loc_base2;
		var integer pos;
		frame = e.stack_frame;
		pos = e.pos;
		al_print("===========================\n");
		al_misc("stack_trace", frame, null);
		al_misc("error_source", al_list2(frame, pos), null);
		loop {
			pos = frame.head.tail.head;
			loc_base = frame.head.tail.tail.tail.head;
			frame = frame.tail;
			if (frame) {
			} else {
				break;
			}
			al_print("===========================\n");
			al_misc("stack_trace", frame, null);
			al_misc("error_source", al_list2(frame, pos), null);
			loop {
				if (loc_base) {
				} else {
					break;
				}
				loc_base2 = loc_base.head;
				loop {
					if (loc_base2) {
					} else {
						break;
					}
					al_print(loc_base2.head.head);
					al_print(" = ");
					al_print(loc_base2.head.tail.head);
					al_print("\n");
					loc_base2 = loc_base2.tail;
				}
				loc_base = loc_base.tail;
			}
		}
	}
	al_misc("output", null, null);
}
end_body
member
public: static void test_validate_all();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	al_print("start = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	XmlUtility::Initialize();
	var list dir_name;
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	var list ls, itr;
	var string name, ext;
	ls = al_file_manip("find_file", dir_name.head, null);
	itr = al_dst_itr(ls);
	loop {
		if (name = al_next(itr)) {
		} else {
			break;
		}
		if (name == "." || name == "..") {
			continue;
		} else {
		}
		ext = al_str_misc("file_ext", name, null);
		if (ext != ".xml") {
			continue;
		} else {
		}
		var integer time;
		time = al_misc("time_stamp", null, null);
		test_validate_all_sub(dir_name.head + "/" + name);
		time = al_misc("time_stamp", null, null) - time;
		al_print("time = " + (string)time + " msec\n");
	}
	al_print("end = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	al_misc("output", null, null);
}
end_body
member
public: static void test_validate_all_sub(string filename);
body
{
	al_print("file = " + filename + "\n");
	try {
		var string dtd_base, dtd_file;
		dtd_base = ".";
		var list parse_tree, dtd;
		var file in;
		in = al_file_open(filename, "r");
		parse_tree = XmlUtility::parseXML(in, null);
		dtd_file = dtd_base + "/" + XmlUtility::getDTDfile(parse_tree);
		dtd = XmlUtility::loadDTD(dtd_file);
		XmlUtility::validateXML(dtd, parse_tree);
		al_print("  Validation Success\n");
	} catch (AlException e) {
		al_print("  Validation Error: " + (string)e.msg + "\n");
	}
}
end_body
member
public: static void prof_validate();
body
{
	al_prof("set", "prof", null);
	al_prof("start", "prof", al_list2(1, null));
	test_validate();
	al_prof("stop", "prof", null);
	var list result, itr, rec;
	result = al_prof("result", "prof", 4);
	var file out;
	out = al_file_open("prof.txt", "w");
	al_file_write(out, "string", "count\ttotal\taverage\tclass\tfunc\n");
	al_file_write(out, "string", "\t(msec)\t(msec)\t\t\n");
	itr = al_dst_itr(result);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		al_file_write(out, "string", (string)rec.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.head + "\t");
		al_file_write(out, "string", (string)rec.tail.head + "\n");
	}
	al_prof("clear", "prof", null);
	al_print("end\n");
}
end_body
member
public: static void prof_validate_all();
body
{
	al_prof("set", "prof", null);
	al_prof("start", "prof", al_list2(1, null));
	test_validate_all();
	al_prof("stop", "prof", null);
	var list result, itr, rec;
	result = al_prof("result", "prof", 4);
	var file out;
	out = al_file_open("prof.txt", "w");
	al_file_write(out, "string", "count\ttotal\taverage\tclass\tfunc\n");
	al_file_write(out, "string", "\t(msec)\t(msec)\t\t\n");
	itr = al_dst_itr(result);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		al_file_write(out, "string", (string)rec.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.head + "\t");
		al_file_write(out, "string", (string)rec.tail.head + "\n");
	}
	al_prof("clear", "prof", null);
	al_print("end\n");
}
end_body
member
public: static void test_xml_to_csv();
body
{
	var list dir_name;
	var string filename;
	if (dir_name = al_get_write_filename("CSV Files (*.csv)|*.csv||", null)) {
	} else {
		return;
	}
	al_misc("output", dir_name.head + "/" + dir_name.tail.head, null);
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var integer time;
	time = al_misc("time_stamp", null, null);
	var string dtd_base, dtd_file;
	dtd_base = ".";
	var list parse_tree, dtd;
	var file in;
	in = al_file_open(filename, "r");
	parse_tree = XmlUtility::parseXML(in, null);
	dtd_file = dtd_base + "/" + XmlUtility::getDTDfile(parse_tree);
	dtd = XmlUtility::loadDTD(dtd_file);
	var XmlValidator validator;
	var list err;
	validator = new XmlValidator;
	validator.save = 1;
	if (err = validator.validate(dtd, parse_tree)) {
		al_misc("output", null, null);
		al_print("  Validation Error: " + (string)err + "\n");
	} else {
		al_misc("output", null, null);
		al_print("  Validation Success\n");
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("time = " + (string)time + " msec\n");
}
end_body
member
public: static void test_csv_to_csv();
body
{
	var list dir_name;
	var file in, out;
	if (dir_name = al_get_read_filename("CSV Files (*.csv)|*.csv||", null)) {
	} else {
		return;
	}
	if (in = al_file_open(dir_name.head + "/" + dir_name.tail.head, "r")) {
	} else {
		return;
	}
	if (dir_name = al_get_write_filename("CSV Files (*.csv)|*.csv||", null)) {
	} else {
		return;
	}
	if (out = al_file_open(dir_name.head + "/" + dir_name.tail.head, "w")) {
	} else {
		return;
	}
	var list values;
	loop {
		if (values = al_file_read(in, "csv")) {
		} else {
			break;
		}
		{
			var string s;
			var file f;
			s = al_copy("");
			f = al_file_open(s, "sw");
			al_file_write(f, "csv", values);
			f = null;
			al_print(s);
		}
		al_file_write(out, "csv", values);
	}
}
end_body
member
public: static void test_xml_to_db();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	XmlUtility::Initialize();
	var SimpleXml2Db xml2db;
	var list dir_name;
	var string filename;
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var integer time;
	time = al_misc("time_stamp", null, null);
	var string dtd_base, dtd_file, doc_type;
	dtd_base = ".";
	var list parse_tree, dtd;
	var file in;
	in = al_file_open(filename, "r");
	parse_tree = XmlUtility::parseXML(in, null);
	doc_type = XmlUtility::getDocType(parse_tree);
	dtd_file = dtd_base + "/" + XmlUtility::getDTDfile(parse_tree);
	dtd = XmlUtility::loadDTD(dtd_file);
	try {
		xml2db = new SimpleXml2Db;
		xml2db.save = 1;
		xml2db.db_type = DbManager::getDbType("ebizPool");
		xml2db.conn = DbManager::getConnection("ebizPool");
		var list err;
		if (err = xml2db.validate(dtd, parse_tree)) {
			xml2db.conn.rollback();
			xml2db.conn.close();
			al_print("  Save Error: " + (string)err + "\n");
		} else {
			xml2db.conn.commit();
			xml2db.conn.close();
			al_print("  Save Success\n");
		}
	} catch (AlException e) {
		if (xml2db.conn) {
			xml2db.conn.rollback();
			xml2db.conn.close();
		} else {
		}
		al_print("Exception: " + e.msg + "\n");
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("time = " + (string)time + " msec\n");
	al_print("msgId = " + (string)xml2db.msgId + "\n");
	al_misc("output", "", null);
}
end_body
member
public: static void test_db_to_xml();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	XmlUtility::Initialize();
	var SimpleDb2Xml db2xml;
	var list dir_name;
	var string filename, msgId;
	msgId = al_ask("msgId ?", "1");
	if (dir_name = al_get_read_filename("DTD Files (*.dtd)|*.dtd|", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var integer time;
	time = al_misc("time_stamp", null, null);
	var list dtd;
	dtd = XmlUtility::loadDTD(filename);
	try {
		db2xml = new SimpleDb2Xml;
		db2xml.msgId = msgId;
		db2xml.db_type = DbManager::getDbType("ebizPool");
		db2xml.conn = DbManager::getConnection("ebizPool");
		var list err;
		if (err = db2xml.compose(dtd)) {
			db2xml.conn.close();
			al_print("  Retrive Error: " + (string)err + "\n");
		} else {
			db2xml.conn.close();
			al_print("  Retrive Success\n");
		}
	} catch (AlException e) {
		if (db2xml.conn) {
			db2xml.conn.close();
		} else {
		}
		al_print("Exception: " + e.msg + "\n");
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("time = " + (string)time + " msec\n");
	al_misc("output", "", null);
	if (dir_name = al_get_write_filename("XML Files (*.xml)|*.xml|", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var file out;
	if (out = al_file_open(filename, "w")) {
	} else {
		return;
	}
	al_file_write(out, "string", db2xml.xml);
	out = null;
}
end_body
member
public: static void perform_save_load_20();
body
{
	XmlUtility::Initialize();
	var SimpleXml2Db xml2db;
	var SimpleDb2Xml db2xml;
	var list dir_name;
	var string filename, msgId;
	var integer time, i, total;
	var string dtd_base, doc_type, dtd_file;
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	dtd_base = ".";
	var list parse_tree, dtd;
	var file in;
	in = al_file_open(filename, "r");
	parse_tree = XmlUtility::parseXML(in, null);
	doc_type = XmlUtility::getDocType(parse_tree);
	dtd_file = dtd_base + "/" + XmlUtility::getDTDfile(parse_tree);
	dtd = XmlUtility::loadDTD(dtd_file);
	// ===========================
	total = i = 0;
	loop {
		if (i < 20) {
		} else {
			break;
		}
		i = i + 1;
		time = al_misc("time_stamp", null, null);
		try {
			in = al_file_open(filename, "r");
			parse_tree = XmlUtility::parseXML(in, null);
			xml2db = new SimpleXml2Db;
			xml2db.save = 1;
			xml2db.db_type = DbManager::getDbType("ebizPool");
			xml2db.conn = DbManager::getConnection("ebizPool");
			var list err;
			if (err = xml2db.validate(dtd, parse_tree)) {
				xml2db.conn.rollback();
				xml2db.conn.close();
				al_print("  Save Error: " + (string)err + "\n");
			} else {
				xml2db.conn.commit();
				xml2db.conn.close();
				msgId = xml2db.msgId;
				// al_print("  Save Success\n");
			}
		} catch (AlException e) {
			if (xml2db.conn) {
				xml2db.conn.rollback();
				xml2db.conn.close();
			} else {
			}
			al_print("Exception: " + e.msg + "\n");
		}
		time = al_misc("time_stamp", null, null) - time;
		al_print((string)i + "\t" + (string)time + " msec\n");
		total = total + time;
	}
	al_print("put average\t" + (string)(total / 20) + " msec\n");
	total = i = 0;
	loop {
		if (i < 20) {
		} else {
			break;
		}
		i = i + 1;
		time = al_misc("time_stamp", null, null);
		try {
			db2xml = new SimpleDb2Xml;
			db2xml.msgId = msgId;
			db2xml.db_type = DbManager::getDbType("ebizPool");
			db2xml.conn = DbManager::getConnection("ebizPool");
			var list err;
			if (err = db2xml.compose(dtd)) {
				db2xml.conn.close();
				al_print("  Retrive Error: " + (string)err + "\n");
			} else {
				db2xml.conn.close();
				// al_print("  Retrive Success\n");
			}
		} catch (AlException e) {
			if (db2xml.conn) {
				db2xml.conn.close();
			} else {
			}
			al_print("Exception: " + e.msg + "\n");
		}
		time = al_misc("time_stamp", null, null) - time;
		al_print((string)i + "\t" + (string)time + " msec\n");
		total = total + time;
	}
	al_print("get average\t" + (string)(total / 20) + " msec\n");
}
end_body
member
public: static void prof_save_load();
body
{
	XmlUtility::Initialize();
	var SimpleXml2Db xml2db;
	var SimpleDb2Xml db2xml;
	var list dir_name, stat, itr, parse_tree, dtd, result, rec;
	var string filename, dtd_base, doc_type, dtd_file, msgId;
	var integer time, i, total;
	var file in, out;
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	dtd_base = ".";
	in = al_file_open(filename, "r");
	parse_tree = XmlUtility::parseXML(in, null);
	doc_type = XmlUtility::getDocType(parse_tree);
	dtd_file = dtd_base + "/" + XmlUtility::getDTDfile(parse_tree);
	dtd = XmlUtility::loadDTD(dtd_file);
	// ===========================
	al_prof("set", "prof", null);
	al_prof("start", "prof", al_list2(1, null));
	time = al_misc("time_stamp", null, null);
	try {
		in = al_file_open(filename, "r");
		parse_tree = XmlUtility::parseXML(in, null);
		xml2db = new SimpleXml2Db;
		xml2db.save = 1;
		xml2db.db_type = DbManager::getDbType("ebizPool");
		xml2db.conn = DbManager::getConnection("ebizPool");
		var list err;
		if (err = xml2db.validate(dtd, parse_tree)) {
			xml2db.conn.rollback();
			xml2db.conn.close();
			al_print("  Save Error: " + (string)err + "\n");
		} else {
			xml2db.conn.commit();
			xml2db.conn.close();
			msgId = xml2db.msgId;
			al_print("  Save Success\n");
		}
	} catch (AlException e) {
		if (xml2db.conn) {
			xml2db.conn.rollback();
			xml2db.conn.close();
		} else {
		}
		al_print("Exception: " + e.msg + "\n");
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("save time = " + (string)time + "\n");
	al_prof("stop", "prof", null);
	result = al_prof("result", "prof", 4);
	out = al_file_open("save_prof.txt", "w");
	al_file_write(out, "string", "count\ttotal\taverage\tclass\tfunc\n");
	al_file_write(out, "string", "\t(msec)\t(msec)\t\t\n");
	itr = al_dst_itr(result);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		al_file_write(out, "string", (string)rec.tail.tail.head + "\t\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.head + "\t");
		al_file_write(out, "string", (string)rec.tail.head + "\n");
	}
	al_prof("clear", "prof", null);
	// ===========================
	al_prof("set", "prof", null);
	al_prof("start", "prof", al_list2(1, null));
	time = al_misc("time_stamp", null, null);
	try {
		db2xml = new SimpleDb2Xml;
		db2xml.msgId = msgId;
		db2xml.db_type = DbManager::getDbType("ebizPool");
		db2xml.conn = DbManager::getConnection("ebizPool");
		var list err;
		if (err = db2xml.compose(dtd)) {
			db2xml.conn.close();
			al_print("  Retrive Error: " + (string)err + "\n");
		} else {
			db2xml.conn.close();
			al_print("  Retrive Success\n");
		}
	} catch (AlException e) {
		if (db2xml.conn) {
			db2xml.conn.close();
		} else {
		}
		al_print("Exception: " + e.msg + "\n");
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("load time = " + (string)time + "\n");
	al_prof("stop", "prof", null);
	result = al_prof("result", "prof", 4);
	out = al_file_open("load_prof.txt", "w");
	al_file_write(out, "string", "count\ttotal\taverage\tclass\tfunc\n");
	al_file_write(out, "string", "\t(msec)\t(msec)\t\t\n");
	itr = al_dst_itr(result);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		al_file_write(out, "string", (string)rec.tail.tail.head + "\t\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.head + "\t");
		al_file_write(out, "string", (string)rec.tail.head + "\n");
	}
	al_prof("clear", "prof", null);
}
end_body
member
public: static void prof_xml_to_db();
body
{
	al_prof("set", "prof", null);
	al_prof("start", "prof", al_list2(1, null));
	// al_prof("start", "prof", al_list2(2, "d:/temp/trace.txt"));
	test_xml_to_db();
	al_prof("stop", "prof", null);
	var list result, itr, rec;
	result = al_prof("result", "prof", 4);
	var file out;
	out = al_file_open("prof.txt", "w");
	al_file_write(out, "string", "count\ttotal\taverage\tclass\tfunc\n");
	al_file_write(out, "string", "\t(msec)\t(msec)\t\t\n");
	itr = al_dst_itr(result);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		al_file_write(out, "string", (string)rec.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.head + "\t");
		al_file_write(out, "string", (string)rec.tail.head + "\n");
	}
	al_prof("clear", "prof", null);
	al_print("end\n");
}
end_body
member
public: static void prof_db_to_xml();
body
{
	al_prof("set", "prof", null);
	al_prof("start", "prof", al_list2(1, null));
	// al_prof("start", "prof", al_list2(2, "d:/temp/trace.txt"));
	test_db_to_xml();
	al_prof("stop", "prof", null);
	var list result, itr, rec;
	result = al_prof("result", "prof", 4);
	var file out;
	out = al_file_open("prof.txt", "w");
	al_file_write(out, "string", "count\ttotal\taverage\tclass\tfunc\n");
	al_file_write(out, "string", "\t(msec)\t(msec)\t\t\n");
	itr = al_dst_itr(result);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		al_file_write(out, "string", (string)rec.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.head + "\t");
		al_file_write(out, "string", (string)rec.tail.head + "\n");
	}
	al_prof("clear", "prof", null);
	al_print("end\n");
}
end_body
member
public: static void test_db_save_load_all();
body
{
	al_print("start = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	// al_misc("output", "d:/temp/out.txt", null);
	XmlUtility::Initialize();
	var list dir_name;
	var list ls, itr;
	var string in_dir, out_dir;
	var string name, ext;
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	ls = al_file_manip("find_file", in_dir = dir_name.head, null);
	itr = al_dst_itr(ls);
	if (dir_name = al_get_write_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	out_dir = dir_name.head;
	loop {
		if (name = al_next(itr)) {
		} else {
			break;
		}
		if (name == "." || name == "..") {
			continue;
		} else {
		}
		ext = al_str_misc("file_ext", name, null);
		if (ext != ".xml") {
			continue;
		} else {
		}
		var integer time;
		var file out;
		out = al_file_open(out_dir + "/" + name, "w");
		try {
			test_db_save_load_all_sub(in_dir, in_dir + "/" + name, out);
		} catch (AlException e) {
			al_print("Exception: msg = " + e.msg + "\n");
			al_misc("stack_trace", e.stack_frame, null);
		}
	}
	al_print("end = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	al_misc("output", null, null);
}
end_body
member
public: static void test_db_save_load_all_sub(string dtd_base, string filename, file out);
body
{
	XmlUtility::Initialize();
	var SimpleXml2Db xml2db;
	var SimpleDb2Xml db2xml;
	var string msgId;
	var integer time;
	var string doc_type, dtd_file;
	var list parse_tree, dtd;
	var file in;
	al_print("\n");
	al_print("filename = " + filename + "\n");
	in = al_file_open(filename, "r");
	parse_tree = XmlUtility::parseXML(in, null);
	doc_type = XmlUtility::getDocType(parse_tree);
	al_print("docType = " + doc_type + "\n");
	dtd_file = XmlUtility::getDTDfile(parse_tree);
	al_print("dtd_filename = " + dtd_base + "/" + dtd_file + "\n");
	dtd = XmlUtility::loadDTD(dtd_base + "/" + dtd_file);
	// ===========================
	al_print("current time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	time = al_misc("time_stamp", null, null);
	try {
		in = al_file_open(filename, "r");
		parse_tree = XmlUtility::parseXML(in, null);
		xml2db = new SimpleXml2Db;
		xml2db.save = 1;
		xml2db.msgType = doc_type;
		xml2db.msgVersion = "test";
		xml2db.db_type = DbManager::getDbType("ebizPool");
		xml2db.conn = DbManager::getConnection("ebizPool");
		var list err;
		if (err = xml2db.validate(dtd, parse_tree)) {
			xml2db.conn.rollback();
			xml2db.conn.close();
			al_print("  Save Error: " + (string)err + "\n");
		} else {
			xml2db.conn.commit();
			xml2db.conn.close();
			msgId = xml2db.msgId;
			al_print("  Save Success\n");
		}
	} catch (AlException e) {
		if (xml2db.conn) {
			xml2db.conn.rollback();
			xml2db.conn.close();
		} else {
		}
		al_print("Exception: " + e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("put time = " + (string)time + " msec\n");
	// ===========================
	al_print("current time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	time = al_misc("time_stamp", null, null);
	try {
		db2xml = new SimpleDb2Xml;
		db2xml.msgId = msgId;
		db2xml.msgType = doc_type;
		db2xml.msgVersion = "test";
		db2xml.db_type = DbManager::getDbType("ebizPool");
		db2xml.conn = DbManager::getConnection("ebizPool");
		db2xml.doctype = doc_type;
		db2xml.dtd_filename = dtd_file;
		var list err;
		if (err = db2xml.compose(dtd)) {
			db2xml.conn.close();
			al_print("  Retrive Error: " + (string)err + "\n");
		} else {
			db2xml.conn.close();
			try {
				XmlUtility::parseXML(db2xml.xml, null);
				al_print("  Retrive Success\n");
			} catch (AlException e) {
				al_print("  Retrive Error: retrive ok, buf can't parse retrived xml.\n");
			}
		}
	} catch (AlException e) {
		if (db2xml.conn) {
			db2xml.conn.close();
		} else {
		}
		al_print("Exception: " + e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("get time = " + (string)time + " msec\n");
	// ===========================
	al_file_write(out, "string", db2xml.xml);
}
end_body
member
public: static void test_file_save_load_all();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var list ls, itr;
	var string in_dir, out_dir;
	var string name, ext;
	if (dir_name = al_get_read_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	ls = al_file_manip("find_file", in_dir = dir_name.head, null);
	itr = al_dst_itr(ls);
	if (dir_name = al_get_write_filename("XML Files (*.xml)|*.xml||", null)) {
	} else {
		return;
	}
	out_dir = dir_name.head;
	loop {
		if (name = al_next(itr)) {
		} else {
			break;
		}
		if (name == "." || name == "..") {
			continue;
		} else {
		}
		ext = al_str_misc("file_ext", name, null);
		if (ext != ".xml") {
			continue;
		} else {
		}
		var integer time;
		var file out;
		out = al_file_open(out_dir + "/" + name, "w");
		try {
			test_file_save_load_all_sub(in_dir, in_dir + "/" + name, out);
		} catch (AlException e) {
			al_print("Exception: msg = " + e.msg + "\n");
		}
	}
	al_print("\nend\n");
	al_misc("output", null, null);
}
end_body
member
public: static void test_file_save_load_all_sub(string dtd_base, string filename, file out);
body
{
	XmlUtility::Initialize();
	var SimpleXml2Db xml2db;
	var SimpleDb2Xml db2xml;
	var string msgId;
	var integer time;
	var string doc_type, dtd_file, tmp_file;
	var list parse_tree, dtd;
	var file in, tmp_f;
	al_print("\n");
	al_print("filename = " + filename + "\n");
	in = al_file_open(filename, "r");
	parse_tree = XmlUtility::parseXML(in, null);
	doc_type = XmlUtility::getDocType(parse_tree);
	al_print("docType = " + doc_type + "\n");
	dtd_file = XmlUtility::getDTDfile(parse_tree);
	al_print("dtd_filename = " + dtd_file + "\n");
	dtd = XmlUtility::loadDTD(dtd_base + "/" + dtd_file);
	// ===========================
	time = al_misc("time_stamp", null, null);
	try {
		in = al_file_open(filename, "r");
		parse_tree = XmlUtility::parseXML(in, null);
		// xml2db = new SimpleXml2Db;
		// xml2db.save = 1;
		// xml2db.msgType = doc_type;
		// xml2db.db_type = DbManager::getDbType("ebizPool");
		// xml2db.conn = DbManager::getConnection("ebizPool");
		xml2db = new XmlValidator;
		var list err;
		if (err = xml2db.validate(dtd, parse_tree)) {
			// xml2db.conn.rollback();
			// xml2db.conn.close();
			al_print("  Validation Error: " + (string)err + "\n");
		} else {
			// xml2db.conn.commit();
			// xml2db.conn.close();
			// msgId = xml2db.msgId;
			al_print("  Validation Success\n");
		}
	} catch (AlException e) {
		if (xml2db.conn) {
			// xml2db.conn.rollback();
			// xml2db.conn.close();
		} else {
		}
		al_print("Exception: " + e.msg + "\n");
	}
	tmp_file = FileUtility::tempFile();
	tmp_f = al_file_open(tmp_file, "w");
	al_file_write(tmp_f, "graph", parse_tree);
	tmp_f = null;
	time = al_misc("time_stamp", null, null) - time;
	al_print("validation & save time = " + (string)time + " msec\n");
	// ===========================
	time = al_misc("time_stamp", null, null);
	tmp_f = al_file_open(tmp_file, "r");
	parse_tree = al_file_read(tmp_f, "graph");
	tmp_f = null;
	al_file_manip("remove", tmp_file, null);
	var string xml;
	xml = al_copy("");
	tmp_f = al_file_open(xml, "sw");
	al_xml("generate", tmp_f, parse_tree, al_cons(2, null));
	tmp_f = null;
	time = al_misc("time_stamp", null, null) - time;
	al_print("load time = " + (string)time + " msec\n");
	// ===========================
	al_file_write(out, "string", xml);
}
end_body
member
public: static void test_db_access_get();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var DbConnection conn;
	try {
		conn = DbManager::getConnection("ebizPool");
		var XmlDbAccessor acc;
		var XmlDbObject obj, obj2;
		acc = new XmlDbAccessor;
		acc.create("Pip3A4PurchaseOrderRequest", "", conn);
		acc.setDTDfilename("rosetta/3A4PurchaseOrderRequestMessageGuideline_v1_1.dtd");
		var string msgId;
		msgId = al_ask("msgId ?", "1");
		al_print("================ Root\n");
		obj = acc.get(msgId);
		var list itr, children, itr2;
		var string name;
		itr = al_dst_itr(obj.xpath_list);
		loop {
			if (name = al_next(itr)) {
			} else {
				break;
			}
			al_print(name + " = " + (string)obj.getField(name) + "\n");
		}
		al_print("================ Children\n");
		children = obj.getChildren("Pip3A4PurchaseOrderRequest/PurchaseOrder/ProductLineItem");
		itr = al_dst_itr(children);
		loop {
			if (obj2 = al_next(itr)) {
			} else {
				break;
			}
			al_print("================ Child\n");
			itr2 = al_dst_itr(obj2.xpath_list);
			loop {
				if (name = al_next(itr2)) {
				} else {
					break;
				}
				al_print(name + " = " + (string)obj2.getField(name) + "\n");
			}
		}
		conn.close();
		al_misc("output", null, null);
	} catch (AlException e) {
		al_print("Exception: " + e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		conn.close();
		al_misc("output", null, null);
	}
}
end_body
member
public: static void test_acc_input_range_orderby_xmls();
body
{
	start();
	var DbConnection conn;
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr;
	var string xml, msgId;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		acc = new XmlDbAccessor;
		acc.create("Test", "", conn);
		ls = acc.get("Test/Target", "system");
		itr = al_dst_itr(ls);
		loop {
			if (obj = al_next(itr)) {
			} else {
				break;
			}
			obj.delete();
		}
		xml = FileUtility::readString("xml/test/test1.xml");
		acc.putXML(xml);
		xml = FileUtility::readString("xml/test/test2.xml");
		acc.putXML(xml);
		xml = FileUtility::readString("xml/test/test3.xml");
		acc.putXML(xml);
		xml = FileUtility::readString("xml/test/test4.xml");
		acc.putXML(xml);
		xml = FileUtility::readString("xml/test/test5.xml");
		acc.putXML(xml);
		xml = FileUtility::readString("xml/test/test6.xml");
		acc.putXML(xml);
		xml = FileUtility::readString("xml/test/test7.xml");
		acc.putXML(xml);
		xml = FileUtility::readString("xml/test/test8.xml");
		acc.putXML(xml);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
	shutdown();
}
end_body
member
public: static void test_acc_select_range_orderby_xmls();
body
{
	start();
	var DbConnection conn;
	var XmlDbAccessor acc;
	var XmlDbObject obj;
	var list ls, itr, cond, itr2;
	var string xml, msgId, path, value;
	var integer i;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		acc = new XmlDbAccessor;
		acc.setDTDfilename("Test.dtd");
		acc.create("Test", "", conn);
		cond = al_cons(null, null);
		al_create_arc(cond, "system", "Test/Target");
		// ls = acc.getAll();
		// ls = acc.get(cond, "Test/LineNumber", "string", "3", "6", "Test/LineNumber", "string", null);
		ls = acc.get(cond, "Test/TestNumber", "integer", "6", "30", "Test/TestNumber", "integer", (list)1);
		itr = al_dst_itr(ls);
		i = 0;
		loop {
			if (obj = al_next(itr)) {
			} else {
				break;
			}
			al_print("obj " + (string)(i = i + 1) + "\n");
			itr2 = al_dst_itr(obj.xpath_list);
			loop {
				if (path = al_next(itr2)) {
				} else {
					break;
				}
				value = obj.getField(path);
				al_print(path + " = " + (string)value + "\n");
			}
		}
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
	shutdown();
}
end_body
member
public: static void test_obj_select_range_orderby_xmls();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection("ebizPool");
		var XmlDbAccessor acc;
		var XmlDbObject obj, obj2;
		acc = new XmlDbAccessor;
		acc.create("Pip3A4PurchaseOrderRequest", "", conn);
		acc.setDTDfilename("rosetta/3A4PurchaseOrderRequestMessageGuideline_v1_1.dtd");
		var string msgId;
		msgId = al_ask("msgId ?", "1");
		obj = acc.get(msgId);
		var list itr, children, itr2, cond;
		var string name;
		cond = al_cons(null, null);
		// al_create_arc(cond, "2", "LineNumber");
		// children = obj.getChildren("Pip3A4PurchaseOrderRequest/PurchaseOrder/ProductLineItem");
		// children = obj.getChildren("Pip3A4PurchaseOrderRequest/PurchaseOrder/ProductLineItem", cond);
		children = obj.getChildren("Pip3A4PurchaseOrderRequest/PurchaseOrder/ProductLineItem", cond, "LineNumber", "integer", "0", "10", "LineNumber", "integer", (list)1);
		itr = al_dst_itr(children);
		loop {
			if (obj2 = al_next(itr)) {
			} else {
				break;
			}
			itr2 = al_dst_itr(obj2.xpath_list);
			loop {
				if (name = al_next(itr2)) {
				} else {
					break;
				}
				al_print(name + " = " + (string)obj2.getField(name) + "\n");
			}
		}
		conn.close();
		al_misc("output", null, null);
	} catch (AlException e) {
		al_print("Exception: " + e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		conn.close();
		al_misc("output", null, null);
	}
}
end_body
member
public: static void clear_dtd_cache();
body
{
	XmlUtility::dtd_cache = null;
}
end_body
member
public: static void type_check1();
body
{
	var string value, type, min, max, rep;
	var list ret;
	value = "20020506T044308.000Z";
	min = 13;
	max = 20;
	rep = "9(8)X9(6)V9(3)X";
	ret = al_xml("type_check", value, al_list4("DateTime", min, max, rep), null);
	al_print("result = " + (string)ret + "\n");
}
end_body
member
public: static void type_check2();
body
{
	var string value, type, min, max, rep;
	var list ret;
	value = "abc";
	min = 1;
	max = "";
	rep = "";
	ret = al_xml("type_check", value, al_list4("String", min, max, rep), null);
	al_print("result = " + (string)ret + "\n");
}
end_body
member
public: static void type_check3();
body
{
	var string value, type, min, max, rep;
	var list ret;
	value = "000000000";
	min = 9;
	max = 9;
	rep = "9(9)";
	ret = al_xml("type_check", value, al_list4("Integer", min, max, rep), null);
	al_print("result = " + (string)ret + "\n");
}
end_body
member
public: static void type_check4();
body
{
	var string value, type, min, max, rep;
	var list ret;
	value = "1234567890123";
	min = 13;
	max = 13;
	rep = "9(13)";
	ret = al_xml("type_check", value, al_list4("Integer", min, max, rep), null);
	al_print("result = " + (string)ret + "\n");
}
end_body
member
public: static void type_check5();
body
{
	var string value, type, min, max, rep;
	var list ret;
	value = "30000";
	min = 1;
	max = 9;
	rep = "";
	ret = al_xml("type_check", value, al_list4("Integer", min, max, rep), null);
	al_print("result = " + (string)ret + "\n");
}
end_body
member
public: static void type_check6();
body
{
	var string value, type, min, max, rep;
	var list ret;
	value = "1";
	min = 1;
	max = "";
	rep = "";
	ret = al_xml("type_check", value, al_list4("Real", min, max, rep), null);
	al_print("result = " + (string)ret + "\n");
}
end_body
member
public: static void dic_check();
body
{
	var string value;
	var list dic, ret;
	dic = al_cons("JP", null);
	dic = al_cons("US", dic);
	ret = al_xml("dic_check", value, dic, null);
	al_print("result = " + (string)ret + "\n");
}
end_body
end_class
class Test_ProcessEngine
member
public: static void test1();
body
{
	var ProcMgr mgr;
	var TestProcess1 process;
	mgr = new ProcMgr;
	process = new TestProcess1;
	try {
		var list def;
		def = process.getDefinition();
		mgr.register("Retry", def);
		var string pid;
		pid = mgr.create("Retry");
		mgr.unregister("Retry");
		mgr.start(pid);
	} catch (AlException e) {
		al_print("Exception: msg = " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		mgr.unregister("Retry");
	}
}
end_body
member
public: static void test2();
body
{
	var ProcMgr mgr;
	var TestProcess1 process;
	mgr = new ProcMgr;
	process = new TestProcess1;
	try {
		var list def, props;
		def = process.getDefinition();
		mgr.register("Retry", def);
		var string pid;
		pid = mgr.create("Retry");
		props = al_cons(null, null);
		al_create_arc(props, "10", "countMax");
		mgr.putProperties(pid, props);
		mgr.unregister("Retry");
		mgr.start(pid);
	} catch (AlException e) {
		al_print("Exception: msg = " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		mgr.unregister("Retry");
	}
}
end_body
member
public: static void test3();
body
{
	var ProcMgr mgr;
	var TestProcess1 process;
	mgr = new ProcMgr;
	process = new TestProcess1;
	try {
		var list def, props, ps;
		var integer i;
		var string pid;
		def = process.getDefinition();
		mgr.register("Retry", def);
		i = 0;
		ps = al_cons(null, null);
		loop {
			if (i < 10) {
			} else {
				break;
			}
			pid = mgr.create("Retry");
			props = al_cons(null, null);
			al_create_arc(props, "10", "countMax");
			mgr.putProperties(pid, props);
			al_create_arc(ps, pid, i);
			i = i + 1;
		}
		i = 0;
		loop {
			if (i < 10) {
			} else {
				break;
			}
			pid = al_dst_node(ps, i);
			mgr.start(pid);
			i = i + 1;
		}
		mgr.unregister("Retry");
	} catch (AlException e) {
		al_print("Exception: msg = " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		mgr.unregister("Retry");
	}
}
end_body
member
public: static void test_large_loop();
body
{
	var ProcMgr mgr;
	var Process process;
	mgr = new ProcMgr;
	process = new TestProcess2;
	try {
		var list def;
		def = process.getDefinition();
		mgr.register("TestProcess2", def);
		var string pid;
		pid = mgr.create("TestProcess2");
		mgr.unregister("TestProcess2");
		mgr.start(pid);
	} catch (AlException e) {
		al_print("Exception: msg = " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		mgr.unregister("TestProcess2");
	}
}
end_body
end_class
class Test_MultipartSecureMessage
member
public: static void init();
body
{
	tmp_dir = "d:/temp";
}
end_body
member
public: static string tmp_dir;
member
public: static void dump_header(list header);
body
{
	var string str;
	var list header_bin;
	var integer header_len;
	if (header_bin = al_crypt("mime_headers_write", header, null, null)) {
	} else {
		var AlException ex;
		ex = new AlException;
		ex.msg = "can't generate mime message header.";
		throw ex;
	}
	header_len = al_misc("binary_size", header_bin, null);
	str = al_misc("binary_to_string", al_list3(header_bin, 0, header_len), null);
	al_print(str);
}
end_body
member
public: static void test_multipart();
body
{
	init();
	var MultipartSecureMessage msm;
	var string filename;
	var file out;
	filename = tmp_dir + "/out1.txt";
	msm = new MultipartSecureMessage;
	msm.addHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.addBodyText("<Header></Header>");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.addBodyText("<Content></Content>");
	msm.setBodyHeader("Content-Type", "text/html");
	msm.addBodyFile("./html/index.html");
	out = al_file_open(filename, "wb");
	msm.writeMultipartMessage(out);
	out = null;
	msm = new MultipartSecureMessage;
	msm.readMultipartMessage(filename);
	var integer i, n;
	n = msm.getCount();
	al_print("body count = " + (string)n + "\n");
	i = 0;
	loop {
		if (i < n) {
		} else {
			break;
		}
		al_print("======== body[ " + (string)i + " ] ========\n");
		var string str;
		str = msm.getBodyText(i);
		dump_header(msm.body_header);
		al_print(str + "\n");
		i = i + 1;
	}
}
end_body
member
public: static void test_multipart_base64();
body
{
	init();
	var MultipartSecureMessage msm;
	var string filename;
	var file out;
	filename = tmp_dir + "/out2.txt";
	msm = new MultipartSecureMessage;
	msm.addHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyText("<Header></Header>");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.addBodyText("<Content></Content>");
	msm.setBodyHeader("Content-Type", "text/html");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyFile("./html/index.html");
	out = al_file_open(filename, "wb");
	msm.writeMultipartMessage(out);
	out = null;
	msm = new MultipartSecureMessage;
	msm.readMultipartMessage(filename);
	var integer i, n;
	n = msm.getCount();
	al_print("body count = " + (string)n + "\n");
	i = 0;
	loop {
		if (i < n) {
		} else {
			break;
		}
		al_print("======== body[ " + (string)i + " ] ========\n");
		var string str;
		str = msm.getBodyText(i);
		dump_header(msm.body_header);
		al_print(str + "\n");
		i = i + 1;
	}
}
end_body
member
public: static void test_encrypt_and_decrypt();
body
{
	init();
	var MultipartSecureMessage msm;
	var string filename;
	var file out;
	filename = tmp_dir + "/out3.txt";
	msm = new MultipartSecureMessage;
	msm.addHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyText("<Header></Header>");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.addBodyText("<Content></Content>");
	msm.setBodyHeader("Content-Type", "text/html");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyFile("./html/index.html");
	out = al_file_open(filename, "wb");
	// encrypt
	msm.encrypt("rc2-128", "./keystore/supplier/cert.pem");
	msm.writeMultipartMessage(out);
	out = null;
	msm = new MultipartSecureMessage;
	msm.readMultipartMessage(filename);
	if (msm.isEncrypted(0)) {
		msm.decrypt(0, "./keystore/supplier/cert.pem", "./keystore/supplier/private/key.pem");
	} else {
		al_print("not recognized that message is encrypted.\n");
		return;
	}
	var integer i, n;
	n = msm.getCount();
	al_print("body count = " + (string)n + "\n");
	i = 0;
	loop {
		if (i < n) {
		} else {
			break;
		}
		al_print("======== body[ " + (string)i + " ] ========\n");
		var string str;
		str = msm.getBodyText(i);
		dump_header(msm.body_header);
		al_print(str + "\n");
		i = i + 1;
	}
}
end_body
member
public: static void test_sign_and_verify();
body
{
	init();
	var MultipartSecureMessage msm;
	var string filename;
	var file out;
	filename = tmp_dir + "/out4.txt";
	msm = new MultipartSecureMessage;
	msm.addHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyText("<Header></Header>");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.addBodyText("<Content></Content>");
	msm.setBodyHeader("Content-Type", "text/html");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyFile("./html/index.html");
	out = al_file_open(filename, "wb");
	msm.sign("./keystore/buyer/cert.pem", "./keystore/buyer/private/key.pem");
	msm.writeMultipartMessage(out);
	out = null;
	msm = new MultipartSecureMessage;
	msm.readMultipartMessage(filename);
	if (msm.isSigned()) {
		if (msm.verify("./keystore/buyer/cert.pem", "./keystore/ca/cert.pem")) {
			al_print("Verify OK\n");
		} else {
			al_print("Verify NG\n");
		}
	} else {
		al_print("not recognized that message is signed.\n");
		return;
	}
	var list header_bin, content_bin, bin;
	var integer header_len, content_len;
	content_bin = msm.getBodyBinary(0);
	content_len = al_misc("binary_size", content_bin, null);
	header_bin = msm.body_header_bin;
	header_len = al_misc("binary_size", header_bin, null);
	bin = al_misc("binary", header_len + content_len, null);
	al_misc("binary_copy", al_list2(bin, 0), al_list3(header_bin, 0, header_len));
	al_misc("binary_copy", al_list2(bin, header_len), al_list3(content_bin, 0, content_len));
	msm.readMultipartMessage(bin, header_len + content_len);
	var integer i, n;
	n = msm.getCount();
	al_print("body count = " + (string)n + "\n");
	i = 0;
	loop {
		if (i < n) {
		} else {
			break;
		}
		al_print("======== body[ " + (string)i + " ] ========\n");
		var string str;
		str = msm.getBodyText(i);
		dump_header(msm.body_header);
		al_print(str + "\n");
		i = i + 1;
	}
}
end_body
member
public: static void test_nest_multipart();
body
{
	init();
	var MultipartSecureMessage msm;
	var string filename;
	var file out;
	filename = tmp_dir + "/out5.txt";
	msm = new MultipartSecureMessage;
	msm.addHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyText("<Header></Header>");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.addBodyText("<Content></Content>");
	msm.setBodyHeader("Content-Type", "text/html");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyFile("./html/index.html");
	msm.multipartToOneBody();
	out = al_file_open(filename, "wb");
	msm.writeMultipartMessage(out);
	out = null;
	msm = new MultipartSecureMessage;
	msm.readMultipartMessage(filename);
	msm.oneBodyToMultipart(0);
	var integer i, n;
	n = msm.getCount();
	al_print("body count = " + (string)n + "\n");
	i = 0;
	loop {
		if (i < n) {
		} else {
			break;
		}
		al_print("======== body[ " + (string)i + " ] ========\n");
		var string str;
		str = msm.getBodyText(i);
		dump_header(msm.body_header);
		al_print(str + "\n");
		i = i + 1;
	}
}
end_body
member
public: static void test_nest_multipart2();
body
{
	init();
	var MultipartSecureMessage msm;
	var string filename;
	var file out;
	filename = tmp_dir + "/out6.txt";
	msm = new MultipartSecureMessage;
	msm.addHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyText("<Header></Header>");
	msm.setBodyHeader("Content-Type", "application/xml");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyHeaderSubType("Content-Type", "charset", "UTF-8");
	msm.addBodyText("<Content></Content>");
	msm.setBodyHeader("Content-Type", "text/html");
	msm.setBodyHeader("Content-Transfer-Encoding", "base64");
	msm.addBodyFile("./html/index.html");
	msm.multipartToOneBody();
	msm.setHeader("Content-Transfer-Encoding", "base64");
	out = al_file_open(filename, "wb");
	msm.writeMultipartMessage(out);
	out = null;
	msm = new MultipartSecureMessage;
	msm.readMultipartMessage(filename);
	msm.oneBodyToMultipart(0);
	var integer i, n;
	n = msm.getCount();
	al_print("body count = " + (string)n + "\n");
	i = 0;
	loop {
		if (i < n) {
		} else {
			break;
		}
		al_print("======== body[ " + (string)i + " ] ========\n");
		var string str;
		str = msm.getBodyText(i);
		dump_header(msm.body_header);
		al_print(str + "\n");
		i = i + 1;
	}
}
end_body
member
public: static void test_read_multipart_file();
body
{
	var string filename;
	var list dir_name;
	if (dir_name = al_get_read_filename("All Files(*.*)|*.*||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var list message;
	var integer size;
	message = FileUtility::readBinary(filename);
	size = al_misc("binary_size", message, null);
	var MultipartSecureMessage msm;
	msm = new MultipartSecureMessage;
	msm.readMultipartMessage(message, size);
	{
		var integer i, n;
		n = msm.getCount();
		al_print("body count = " + (string)n + "\n");
		i = 0;
		loop {
			if (i < n) {
			} else {
				break;
			}
			al_print("======== body[ " + (string)i + " ] ========\n");
			var string str;
			str = msm.getBodyText(i);
			dump_header(msm.body_header);
			al_print(str + "\n");
			i = i + 1;
		}
	}
}
end_body
end_class
class Test_Csv
member
public: static void test_load_csv();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("CSV Files (*.csv)|*.csv||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var Csv1Data csv2xmldb;
	csv2xmldb = new Csv1Data;
	csv2xmldb.loadCSV(filename);
	test_load_csv_sub(csv2xmldb.root_csv_data);
	al_misc("output", null, null);
}
end_body
member
public: static void test_load_csv_sub(list csv_data);
body
{
	var list itr, data, itr2, child, child_csv_data;
	var string value;
	itr = al_dst_itr(csv_data);
	loop {
		if (data = al_next(itr)) {
		} else {
			break;
		}
		itr2 = al_dst_itr(data);
		loop {
			if (value = al_next(itr2)) {
			} else {
				break;
			}
			child = al_arc_a(itr2);
			if (child == "$child") {
				continue;
			} else {
			}
			al_print(value + ", ");
		}
		al_print("\n");
	}
	itr = al_dst_itr(csv_data);
	loop {
		if (data = al_next(itr)) {
		} else {
			break;
		}
		itr2 = al_dst_itr(data);
		loop {
			if (child_csv_data = al_next(itr2)) {
			} else {
				break;
			}
			child = al_arc_a(itr2);
			if (child != "$child") {
				continue;
			} else {
			}
			test_load_csv_sub(child_csv_data);
		}
	}
}
end_body
member
public: static void test_load_po_request_csv();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var list dir_name;
	var string filename, tmp_file;
	var file in, out;
	if (dir_name = al_get_read_filename("CSV Files (*.csv)|*.csv||", null)) {
	} else {
		return;
	}
	filename = dir_name.head + "/" + dir_name.tail.head;
	var Csv1DataItr csv_itr, csv_itr2, csv_itr3;
	csv_itr = new Csv1DataItr;
	csv_itr.loadCSV(filename);
	csv_itr.Reset();
	loop {
		if (csv_itr.nextRow()) {
		} else {
			break;
		}
		al_print("[Root] " + csv_itr.dst_path + ", " + csv_itr.src_path + ", " + csv_itr.value + "\n");
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("ProductLineItem")) {
		} else {
			break;
		}
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			al_print("[ProdcutLineItem] " + csv_itr2.dst_path + ", " + csv_itr2.src_path + ", " + csv_itr2.value + "\n");
		}
		csv_itr2.Reset();
		loop {
			if (csv_itr3 = csv_itr2.nextChild("shipFrom")) {
			} else {
				break;
			}
			loop {
				if (csv_itr3.nextRow()) {
				} else {
					break;
				}
				al_print("[shipFrom] " + csv_itr3.dst_path + ", " + csv_itr3.src_path + ", " + csv_itr3.value + "\n");
			}
		}
	}
	csv_itr.Reset();
	loop {
		if (csv_itr2 = csv_itr.nextChild("PartnerDescription")) {
		} else {
			break;
		}
		csv_itr2.Reset();
		loop {
			if (csv_itr2.nextRow()) {
			} else {
				break;
			}
			al_print("[PartnerDescription] " + csv_itr2.dst_path + ", " + csv_itr2.src_path + ", " + csv_itr2.value + "\n");
		}
	}
	al_misc("output", null, null);
}
end_body
end_class
class Test_Misc
member
public: static void set_output();
body
{
	var string platform;
	platform = al_misc("platform", null, null);
	if (platform == "windows") {
		al_misc("output", "d:/temp/output.txt", null);
	} else {
	}
	if (platform == "linux" || platform == "mac") {
		al_misc("output", "/proj/altair/tmp/output.txt", null);
	} else {
	}
}
end_body
member
public: static void unset_output();
body
{
	al_misc("output", null, null);
}
end_body
member
public: static void set_trace();
body
{
	al_prof("set", "trace", null);
	var string platform;
	platform = al_misc("platform", null, null);
	if (platform == "windows") {
		al_prof("start", "trace", al_list2(2, "d:/temp/trace.txt"));
	} else {
	}
	if (platform == "linux" || platform == "mac") {
		al_prof("start", "trace", al_list2(2, "/proj/altair/tmp/trace.txt"));
	} else {
	}
}
end_body
member
public: static void unset_trace();
body
{
	al_prof("stop", "trace", null);
	al_prof("clear", "trace", null);
}
end_body
member
public: static void set_prof();
body
{
	al_prof("set", "test_prof", null);
	al_prof("start", "test_prof", al_list2(1, null));
}
end_body
member
public: static void unset_prof();
body
{
	var list result, itr, rec;
	var file out;
	al_prof("stop", "test_prof", null);
	result = al_prof("result", "test_prof", 4);
	out = al_file_open("test_prof.txt", "w");
	al_file_write(out, "string", "count\ttotal\taverage\tclass\tfunc\n");
	al_file_write(out, "string", "\t(msec)\t(msec)\t\t\n");
	itr = al_dst_itr(result);
	loop {
		if (rec = al_next(itr)) {
		} else {
			break;
		}
		al_file_write(out, "string", (string)rec.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.tail.tail.tail.tail.head + "\t");
		al_file_write(out, "string", (string)rec.head + "\t");
		al_file_write(out, "string", (string)rec.tail.head + "\n");
	}
	al_prof("clear", "test_prof", null);
}
end_body
member
public: static void dump_db_object(XmlDbObject obj);
body
{
	al_print("======== begin of dump XmlDbObject\n");
	var list itr;
	var string path, value;
	itr = al_dst_itr(obj.xpath_list);
	loop {
		if (path = al_next(itr)) {
		} else {
			break;
		}
		value = obj.getField(path);
		al_print(path + " = " + (string)value + "\n");
	}
	al_print("======== end of dump XmlDbObject\n");
}
end_body
member
public: static void test_get_rn_props();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var list props, itr;
		var string name, value;
		var RNContext ctx;
		al_print("==== MyInfo: buyer\n");
		ctx = new RNContext;
		props = ctx.getMyProperties("buyer", conn);
		itr = al_dst_itr(props);
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			al_print(name + " = " + value + "\n");
		}
		al_print("==== PartnerInfo: supplier\n");
		ctx = new RNContext;
		props = ctx.getPartnerProperties("000000000", "supplier", conn);
		itr = al_dst_itr(props);
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			al_print(name + " = " + value + "\n");
		}
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: static void test_get_pip_props_from_msg_code();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var RNContext ctx;
		var list props;
		ctx = new RNContext;
		props = ctx.getPipPropertiesFromMessageCode("Purchase Order Request Action", "R02.00.00", conn);
		var list itr;
		var string name, value;
		itr = al_dst_itr(props);
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			al_print(name + " = " + value + "\n");
		}
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: static void test_get_pip_props_from_msg_type();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var RNContext ctx;
		var list props;
		ctx = new RNContext;
		props = ctx.getPipProperties("Pip3A4PurchaseOrderRequest", "R02.00.00", conn);
		var list itr;
		var string name, value;
		itr = al_dst_itr(props);
		loop {
			if (value = al_next(itr)) {
			} else {
				break;
			}
			name = al_arc_a(itr);
			al_print(name + " = " + value + "\n");
		}
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: static void test_gen_msg_id();
body
{
	var integer i;
	i = 0;
	loop {
		if (i < 100) {
		} else {
			break;
		}
		i = i + 1;
		al_print(Context::genMsgId() + "\n");
	}
}
end_body
member
public: static void test_gen_datetime();
body
{
	var integer i;
	i = 0;
	loop {
		if (i < 100) {
		} else {
			break;
		}
		i = i + 1;
		al_print(RNContext::currentDateTime() + "\n");
	}
}
end_body
member
public: static void test_gen_doc_id();
body
{
	var integer i;
	i = 0;
	loop {
		if (i < 100) {
		} else {
			break;
		}
		i = i + 1;
		al_print(RNContext::genDocId() + "\n");
	}
}
end_body
member
public: static void test_read_binary_file();
body
{
	var file f;
	var list buf, block, first;
	var integer read_bytes;
	f = al_file_open("d:/temp/License.txt", "rb");
	buf = al_misc("binary", 128, null);
	block = al_list3(buf, 0, 128);
	first = 1;
	loop {
		if (read_bytes = al_file_read(f, block)) {
		} else {
			read_bytes = 128;
		}
		al_print("read_bytes = " + (string)read_bytes + "\n");
		if (read_bytes < 0) {
			break;
		} else {
		}
		if (read_bytes == 0) {
			if (first) {
				first = null;
			} else {
				break;
			}
		} else {
		}
	}
}
end_body
member
public: static void clear_backup_jobs();
body
{
	DataMgr::jobs = null;
}
end_body
member
public: static void test_char();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var string s, sql;
		var list rs, itr, rec;
		s = FileUtility::readString("d:/temp/1.txt");
		sql = "insert into test values('1', '" + s + "')";
		conn.executeUpdate(sql);
		sql = "select value from test where id='1'";
		rs = conn.executeQuery(1, sql);
		itr = al_dst_itr(rs);
		rec = al_next(itr);
		s = al_dst_node(rec, 1);
		FileUtility::writeString("d:/temp/1-out.txt", s);
		s = FileUtility::readString("d:/temp/2.txt");
		sql = "insert into test values('2', '" + s + "')";
		conn.executeUpdate(sql);
		sql = "select value from test where id='2'";
		rs = conn.executeQuery(1, sql);
		itr = al_dst_itr(rs);
		rec = al_next(itr);
		s = al_dst_node(rec, 1);
		FileUtility::writeString("d:/temp/2-out.txt", s);
		s = FileUtility::readString("d:/temp/3.txt");
		sql = "insert into test values('3', '" + s + "')";
		conn.executeUpdate(sql);
		sql = "select value from test where id='3'";
		rs = conn.executeQuery(1, sql);
		itr = al_dst_itr(rs);
		rec = al_next(itr);
		s = al_dst_node(rec, 1);
		FileUtility::writeString("d:/temp/3-out.txt", s);
	} catch (AlException e) {
		conn.rollback();
		conn.close();
	}
}
end_body
member
public: static void make_writable();
body
{
	FileUtility::makeWritable("c:/altair");
}
end_body
end_class
class Test_Rosetta
member
public: static void perform_test_pru_1();
body
{
	var Test_Rosetta inst;
	var string msgId;
	inst = new Test_Rosetta;
	msgId = inst.create_2A1ProductResourceUpdate(1);
	al_print("PRU with 1 repetion item. send start time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
}
end_body
member
public: static void perform_test_pru_100();
body
{
	var Test_Rosetta inst;
	var string msgId;
	inst = new Test_Rosetta;
	msgId = inst.create_2A1ProductResourceUpdate(100);
	al_print("PRU with 100 repetion items. send start time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
}
end_body
member
public: static void perform_test_pru_500();
body
{
	var Test_Rosetta inst;
	var string msgId;
	inst = new Test_Rosetta;
	msgId = inst.create_2A1ProductResourceUpdate(500);
	al_print("PRU with 500 repetion items. send start time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
}
end_body
member
public: static void perform_test_pru_1000();
body
{
	var Test_Rosetta inst;
	var string msgId;
	inst = new Test_Rosetta;
	msgId = inst.create_2A1ProductResourceUpdate(1000);
	al_print("PRU with 1000 repetion items. send start time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
}
end_body
member
public: string create_2A1ProductResourceUpdate(integer count);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		// create db object
		var XmlDbObject obj, obj2, obj3;
		var string msgId, msgType, msgVersion, dtd_filename;
		msgType = "Pip2A1ProductResourceUpdate";
		msgVersion = "1.0";
		dtd_filename = "rosetta/Pip2A1ProductResourceUpdateGuideline.dtd";
		obj = XmlUtility::createMsgData(msgId, msgType, msgVersion, dtd_filename, conn);
		msgId = obj.msgId;
		// set csv data
		var Csv1DataItr csv_itr, csv_itr2, csv_itr3;
		csv_itr = new Csv1DataItr;
		csv_itr.loadCSV("./data/rosetta_sample/ProductResourceUpdate.csv");
		csv_itr.Reset();
		loop {
			if (csv_itr.nextRow()) {
			} else {
				break;
			}
			obj.putField(csv_itr.dst_path, csv_itr.value);
		}
		var integer i;
		i = 0;
		loop {
			if (i < count) {
			} else {
				break;
			}
			csv_itr.Reset();
			loop {
				if (csv_itr2 = csv_itr.nextChild("ProductLineItem")) {
				} else {
					break;
				}
				obj2 = obj.createChild(csv_itr2.base_dst_path);
				csv_itr2.Reset();
				loop {
					if (csv_itr2.nextRow()) {
					} else {
						break;
					}
					obj2.putField(csv_itr2.dst_path, csv_itr2.value);
				}
				csv_itr2.Reset();
				loop {
					if (csv_itr3 = csv_itr2.nextChild("Country")) {
					} else {
						break;
					}
					obj3 = obj2.createChild(csv_itr3.base_dst_path);
					csv_itr3.Reset();
					loop {
						if (csv_itr3.nextRow()) {
						} else {
							break;
						}
						obj3.putField(csv_itr3.dst_path, csv_itr3.value);
					}
				}
			}
			i = i + 1;
		}
		// partner info
		obj.putField("Pip2A1ProductResourceUpdate/toRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", "End User");
		obj.putField("Pip2A1ProductResourceUpdate/toRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", "999999999");
		// my info
		obj.putField("Pip2A1ProductResourceUpdate/fromRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", "Manufacturer");
		obj.putField("Pip2A1ProductResourceUpdate/fromRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", "000000000");
		// common info
		obj.putField("Pip2A1ProductResourceUpdate/thisDocumentGenerationDateTime/DateTimeStamp", RNContext::currentDateTime());
		obj.putField("Pip2A1ProductResourceUpdate/thisDocumentIdentifier/ProprietaryDocumentIdentifier", RNContext::genDocId());
		obj.putField("Pip2A1ProductResourceUpdate/GlobalDocumentFunctionCode", "Request");
		conn.commit();
		conn.close();
		return msgId;
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: static void long_run_test_pin();
body
{
	var Test_Rosetta inst;
	inst = new Test_Rosetta;
	inst.timer_id = al_get_id();
	inst.period = 20000;
	inst.count_max = 1000;
	// inst.period = 3000;
	// inst.count_max = 100;
	var list cb;
	cb = al_list3(al_root_class(), inst, Test_Rosetta::send_2A1ProductInfoNotify);
	al_gui_misc("timer", al_list2(inst.timer_id, inst.period), cb);
}
end_body
member
public: string create_2A1ProductInfoNotify();
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		// create db object
		var XmlDbObject obj, obj2;
		var string msgId, msgType, msgVersion, dtd_filename;
		msgType = "Pip2A1ProductInformationNotification";
		msgVersion = "1.0";
		dtd_filename = "rosetta/Pip2A1ProductInformationNotificationGuideline.dtd";
		obj = XmlUtility::createMsgData(msgId, msgType, msgVersion, dtd_filename, conn);
		msgId = obj.msgId;
		// set csv data
		var Csv1DataItr csv_itr, csv_itr2, csv_itr3;
		csv_itr = new Csv1DataItr;
		csv_itr.loadCSV("./data/rosetta_sample/ProductInfoNotify.csv");
		csv_itr.Reset();
		loop {
			if (csv_itr.nextRow()) {
			} else {
				break;
			}
			obj.putField(csv_itr.dst_path, csv_itr.value);
		}
		csv_itr.Reset();
		loop {
			if (csv_itr2 = csv_itr.nextChild("ProductNotice")) {
			} else {
				break;
			}
			obj2 = obj.createChild(csv_itr2.base_dst_path);
			csv_itr2.Reset();
			loop {
				if (csv_itr2.nextRow()) {
				} else {
					break;
				}
				obj2.putField(csv_itr2.dst_path, csv_itr2.value);
			}
		}
		// partner info
		obj.putField("Pip2A1ProductInformationNotification/toRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", "End User");
		obj.putField("Pip2A1ProductInformationNotification/toRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", "999999999");
		// my info
		obj.putField("Pip2A1ProductInformationNotification/fromRole/PartnerRoleDescription/PartnerDescription/GlobalPartnerClassificationCode", "Manufacturer");
		obj.putField("Pip2A1ProductInformationNotification/fromRole/PartnerRoleDescription/PartnerDescription/BusinessDescription/GlobalBusinessIdentifier", "000000000");
		// common info
		obj.putField("Pip2A1ProductInformationNotification/thisDocumentGenerationDateTime/DateTimeStamp", RNContext::currentDateTime());
		obj.putField("Pip2A1ProductInformationNotification/thisDocumentIdentifier/ProprietaryDocumentIdentifier", RNContext::genDocId());
		conn.commit();
		conn.close();
		return msgId;
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: void send_2A1ProductInfoNotify();
body
{
	if (processing) {
		return;
	} else {
	}
	processing = 1;
	if (count) {
		count = count + 1;
	} else {
		count = 1;
	}
	if (count > count_max) {
		al_gui_misc("timer", al_list2(timer_id, period), null);
		al_release_id(timer_id);
		al_print("send completed\n");
		return;
	} else {
	}
	var string msgId;
	msgId = create_2A1ProductInfoNotify();
	al_print("send count = " + (string)count + ", time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
	processing = null;
}
end_body
member
public: list processing;
member
public: integer timer_id;
member
public: integer period;
member
public: integer count;
member
public: integer count_max;
member
public: static void retry_over();
body
{
	var Test_Rosetta inst;
	var string msgId;
	inst = new Test_Rosetta;
	inst.change_url("000000000", "supplier", "http://localhost:8888/rosetta");
	inst.change_error_retry_time("000000000", "supplier", "5s");
	inst.change_receipt_wait_time("000000000", "supplier", "5s");
	msgId = inst.create_2A1ProductInfoNotify();
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
}
end_body
member
public: static void retry_ok();
body
{
	var Test_Rosetta inst;
	var string msgId;
	inst = new Test_Rosetta;
	inst.change_url("000000000", "supplier", "http://localhost:8888/rosetta");
	inst.change_error_retry_time("000000000", "supplier", "5s");
	inst.change_receipt_wait_time("000000000", "supplier", "5s");
	msgId = inst.create_2A1ProductInfoNotify();
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
	inst.timer_id = al_get_id();
	inst.period = 15000;
	var list cb;
	cb = al_list3(al_root_class(), inst, Test_Rosetta::change_to_correct_url);
	al_gui_misc("timer", al_list2(inst.timer_id, inst.period), cb);
}
end_body
member
public: static void ack_retry_over();
body
{
	var Test_Rosetta inst;
	var string msgId;
	inst = new Test_Rosetta;
	inst.change_url("999999999", "buyer", "http://localhost:8888/rosetta");
	inst.change_error_retry_time("999999999", "buyer", "5s");
	inst.change_receipt_wait_time("000000000", "supplier", "5s");
	inst.change_receipt_wait_time("999999999", "buyer", "5s");
	msgId = inst.create_2A1ProductInfoNotify();
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
}
end_body
member
public: static void ack_retry_ok();
body
{
	var Test_Rosetta inst;
	var string msgId;
	inst = new Test_Rosetta;
	inst.change_url("999999999", "buyer", "http://localhost:8888/rosetta");
	inst.change_error_retry_time("999999999", "buyer", "5s");
	inst.change_receipt_wait_time("000000000", "supplier", "5s");
	inst.change_receipt_wait_time("999999999", "buyer", "5s");
	msgId = inst.create_2A1ProductInfoNotify();
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
	inst.timer_id = al_get_id();
	inst.period = 15000;
	var list cb;
	cb = al_list3(al_root_class(), inst, Test_Rosetta::change_to_correct_url);
	al_gui_misc("timer", al_list2(inst.timer_id, inst.period), cb);
}
end_body
member
public: void change_to_correct_url();
body
{
	change_url("000000000", "supplier", "http://localhost/rosetta");
	change_url("999999999", "buyer", "http://localhost/rosetta");
	al_gui_misc("timer", al_list2(timer_id, period), null);
	al_release_id(timer_id);
}
end_body
member
public: void change_url(string partner_id, string partner_role, string url);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var RNContext ctx;
		ctx = new RNContext;
		ctx.putPartnerProperty(partner_id, partner_role, "URL", url, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: void change_error_retry_time(string partner_id, string partner_role, string time);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var RNContext ctx;
		ctx = new RNContext;
		ctx.putPartnerProperty(partner_id, partner_role, "error.retry.time", time, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: void change_receipt_wait_time(string partner_id, string partner_role, string time);
body
{
	var DbConnection conn;
	try {
		conn = DbManager::getConnection(ProcessEngine::pool_name);
		var RNContext ctx;
		ctx = new RNContext;
		ctx.putPartnerProperty(partner_id, partner_role, "receipt.wait.time", time, conn);
		conn.commit();
		conn.close();
	} catch (AlException e) {
		al_print("Exception: " + (string)e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
		if (conn) {
			try {
				conn.rollback();
			} catch (AlException e) {
			}
		} else {
		}
		if (conn) {
			try {
				conn.close();
			} catch (AlException e) {
			}
		} else {
		}
	}
}
end_body
member
public: static void test_send_with_attach();
body
{
	var Test_Rosetta inst;
	var string msgId;
	inst = new Test_Rosetta;
	msgId = inst.create_2A1ProductInfoNotify();
	RNDataMgr::addAttachment(msgId, "./dtd/WebUiData.dtd", "text/plain", "1111.2222.3333@foo.jp", "this is one of the DTDs which determine Meta WebUI data structure.");
	RNDataMgr::addAttachment(msgId, "./data/rosetta_sample/PORequest.xls", "application/octet", "4444.5555.6666@foo.jp", "sample CSV data for creating XML message.");
	RNDataMgr::addAttachment(msgId, "./data/test/christmas.gif", "image/gif", "7777.8888.9999@foo.jp", "");
	var RNIF20Transmitter tr;
	tr = new RNIF20Transmitter;
	tr.send(msgId, "000000000");
}
end_body
member
public: static void test_send_with_attach_10();
body
{
	var integer count;
	count = 0;
	loop {
		if (count < 10) {
		} else {
			break;
		}
		test_send_with_attach();
		count = count + 1;
	}
}
end_body
member
public: static void test_get_attach_info();
body
{
	var string msgId;
	var list attach_info;
	msgId = al_ask("msgId?", "");
	if (attach_info = RNDataMgr::getAttachmentInfos(msgId)) {
	} else {
		al_print("no attachment info of msgId '" + (string)msgId + "'\n");
		return;
	}
	var list itr, info, itr2, name, value;
	var integer count;
	itr = al_dst_itr(attach_info);
	loop {
		if (info = al_next(itr)) {
		} else {
			break;
		}
		count = al_arc_a(itr);
		al_print("==== attachment " + (string)count + "\n");
		itr2 = al_dst_itr(info);
		loop {
			if (value = al_next(itr2)) {
			} else {
				break;
			}
			name = al_arc_a(itr2);
			al_print((string)name + " = " + (string)value + "\n");
		}
	}
	al_print("please check binary diff of files specified by '$filename'\n");
}
end_body
end_class
class Test_FileUtility
member
public: static void test_listup();
body
{
	var FileItr itr;
	itr = new FileItr;
	itr.Reset("d:/temp");
	loop {
		if (itr.Next()) {
		} else {
			break;
		}
		al_print(itr.abs_path + "\n");
	}
}
end_body
member
public: static void test_rev_listup();
body
{
	var RevFileItr itr;
	itr = new RevFileItr;
	itr.Reset("d:/temp");
	loop {
		if (itr.Next()) {
		} else {
			break;
		}
		al_print(itr.abs_path + "\n");
	}
}
end_body
end_class
class Test_ProxyServer
member
public: static void test_start_proxy_server();
body
{
	if (proxy_server) {
		al_print("already started\n");
		return;
	} else {
	}
	var ProxyServer server;
	proxy_server = server = new ProxyServer;
	server.port = 8080;
	server.start();
}
end_body
member
public: static void test_stop_proxy_server();
body
{
	if (proxy_server) {
	} else {
		al_print("not started.\n");
		return;
	}
	proxy_server.stop();
	proxy_server = null;
}
end_body
member
public: static ProxyServer proxy_server;
end_class
class Test_InetClient
member
public: static void test_smtp();
body
{
	var SmtpClient client;
	client = new SmtpClient;
	if (null) {
		client.create("mail.kt.rim.or.jp");
		client.from = "inamoto@kt.rim.or.jp";
		client.domain = "empower.jp";
	} else {
		client.create("muf.biglobe.ne.jp");
		client.from = "inamoto@muf.biglobe.ne.jp";
		client.domain = "empower.jp";
	}
	al_create_arc(client.rcpts, client.from, null);
	al_create_arc(client.to, client.from, null);
	client.subject = "test";
	client.text = "This is a test.";
	client.debug = 1;
	al_print("result = " + (string)client.start() + "\n");
}
end_body
member
public: static void test_pop();
body
{
	var PopClient client;
	client = new PopClient;
	if (null) {
		client.create("mail.kt.rim.or.jp");
		client.userid = "inamoto";
		client.password = "********";
	} else {
		client.create("muf.biglobe.ne.jp");
		client.userid = "inamoto";
		client.password = "********";
	}
	client.debug = 1;
	al_print("result = " + (string)client.start() + "\n");
	var list itr;
	var string text;
	itr = al_dst_itr(client.texts);
	loop {
		if (text = al_next(itr)) {
		} else {
			break;
		}
		al_print("===========================\n");
		al_print(text);
	}
}
end_body
end_class
class Test_SoapEbxml
member
public: static void test_sample_envelope_validate();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var string in_filename, dtd_filename, msgId;
	var file in;
	var XmlValidator validator;
	var integer time;
	var list parse_tree, dtd;
	XmlUtility::Initialize();
	XmlUtility::dtd_cache = null;
	in_filename = "./data/test/sample-soap-message.xml";
	// ===========================
	al_print("current time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	time = al_misc("time_stamp", null, null);
	try {
		in = al_file_open(in_filename, "r");
		parse_tree = XmlUtility::parseXML(in, null);
		dtd_filename = "./dtd/ebxml/ebxml_1_0.dtd";
		dtd = XmlUtility::loadDTD(dtd_filename);
		validator = new XmlValidator;
		validator.msgType = "ebxml";
		validator.msgVersion = "test";
		var list err;
		if (err = validator.validate(dtd, parse_tree)) {
			al_print("  Vdalidate Error: " + (string)err + "\n");
		} else {
			al_print("  Validate Success\n");
		}
	} catch (AlException e) {
		al_print("Exception: " + e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("validation time = " + (string)time + " msec\n");
	al_misc("output", null, null);
}
end_body
member
public: static void test_sample_envelope_save_load();
body
{
	// al_misc("output", "d:/temp/out.txt", null);
	var string in_filename, out_filename, dtd_filename, msgId;
	var file in, out;
	var SimpleXml2Db xml2db;
	var SimpleDb2Xml db2xml;
	var integer time;
	var list parse_tree, dtd;
	XmlUtility::Initialize();
	XmlUtility::dtd_cache = null;
	in_filename = "./data/test/sample-soap-message.xml";
	out_filename = "./data/test/sample-soap-message-tmp.xml";
	// ===========================
	al_print("current time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	time = al_misc("time_stamp", null, null);
	try {
		in = al_file_open(in_filename, "r");
		parse_tree = XmlUtility::parseXML(in, null);
		dtd_filename = "./dtd/ebxml/ebxml_1_0.dtd";
		dtd = XmlUtility::loadDTD(dtd_filename);
		xml2db = new SimpleXml2Db;
		xml2db.save = 1;
		xml2db.msgType = "ebxml_1_0";
		xml2db.msgVersion = "test";
		xml2db.db_type = DbManager::getDbType("ebizPool");
		xml2db.conn = DbManager::getConnection("ebizPool");
		var list err;
		if (err = xml2db.validate(dtd, parse_tree)) {
			xml2db.conn.rollback();
			xml2db.conn.close();
			al_print("  Save Error: " + (string)err + "\n");
		} else {
			xml2db.conn.commit();
			xml2db.conn.close();
			msgId = xml2db.msgId;
			al_print("  Save Success\n");
		}
	} catch (AlException e) {
		if (xml2db.conn) {
			xml2db.conn.rollback();
			xml2db.conn.close();
		} else {
		}
		al_print("Exception: " + e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("put time = " + (string)time + " msec\n");
	// ===========================
	al_print("current time = " + (string)al_file_manip("current_datetime", null, null) + "\n");
	time = al_misc("time_stamp", null, null);
	try {
		db2xml = new SimpleDb2Xml;
		db2xml.msgId = msgId;
		db2xml.msgType = "ebxml_1_0";
		db2xml.msgVersion = "test";
		db2xml.db_type = DbManager::getDbType("ebizPool");
		db2xml.conn = DbManager::getConnection("ebizPool");
		var list err;
		if (err = db2xml.compose(dtd)) {
			db2xml.conn.close();
			al_print("  Retrive Error: " + (string)err + "\n");
		} else {
			db2xml.conn.close();
			try {
				XmlUtility::parseXML(db2xml.xml, null);
				al_print("  Retrive Success\n");
			} catch (AlException e) {
				al_print("  Retrive Error: retrive ok, buf can't parse retrived xml.\n");
			}
		}
	} catch (AlException e) {
		if (db2xml.conn) {
			db2xml.conn.close();
		} else {
		}
		al_print("Exception: " + e.msg + "\n");
		al_misc("stack_trace", e.stack_frame, null);
		al_misc("error_source", al_list2(e.stack_frame, e.pos), null);
	}
	time = al_misc("time_stamp", null, null) - time;
	al_print("get time = " + (string)time + " msec\n");
	// ===========================
	out = al_file_open(out_filename, "w");
	al_file_write(out, "string", db2xml.xml);
	al_misc("output", null, null);
}
end_body
end_class
end_class
$END_BODY
